/**
 * @license
 * Copyright 2010-2025 Phy.js Authors
 * SPDX-License-Identifier: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three"),require("three/addons/utils/BufferGeometryUtils.js"),require("three/addons/loaders/SVGLoader.js"),require("three/addons/utils/SkeletonUtils.js"),require("three/addons/loaders/GLTFLoader.js"),require("three/addons/loaders/FBXLoader.js"),require("three/addons/loaders/OBJLoader.js"),require("three/addons/loaders/STLLoader.js"),require("three/addons/loaders/HDRLoader.js"),require("three/addons/loaders/EXRLoader.js"),require("three/addons/loaders/UltraHDRLoader.js"),require("three/addons/loaders/KTX2Loader.js")):"function"==typeof define&&define.amd?define(["exports","three","three/addons/utils/BufferGeometryUtils.js","three/addons/loaders/SVGLoader.js","three/addons/utils/SkeletonUtils.js","three/addons/loaders/GLTFLoader.js","three/addons/loaders/FBXLoader.js","three/addons/loaders/OBJLoader.js","three/addons/loaders/STLLoader.js","three/addons/loaders/HDRLoader.js","three/addons/loaders/EXRLoader.js","three/addons/loaders/UltraHDRLoader.js","three/addons/loaders/KTX2Loader.js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).PHY={},t.THREE,t.BufferGeometryUtils_js,t.SVGLoader_js,t.SkeletonUtils,t.GLTFLoader_js,t.FBXLoader_js,t.OBJLoader_js,t.STLLoader_js,t.HDRLoader_js,t.EXRLoader_js,t.UltraHDRLoader_js,t.KTX2Loader_js)}(this,(function(t,e,i,s,a,r,n,l,h,c,d,u,p){"use strict";var f="undefined"!=typeof document?document.currentScript:null;function b(t){var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var g=b(a);const y=Math.PI,x=y/180,v=180/y,w=Number.EPSILON,M=.5*y,k={luminousPowers:{"110000 lm (1000W)":11e4,"3500 lm (300W)":3500,"1700 lm (100W)":1700,"800 lm (60W)":800,"400 lm (40W)":400,"180 lm (25W)":180,"20 lm (4W)":20,Off:0},luminousIrradiances:{"0.0001 lx (Moonless Night)":1e-4,"0.002 lx (Night Airglow)":.002,"0.5 lx (Full Moon)":.5,"3.4 lx (City Twilight)":3.4,"50 lx (Living Room)":50,"100 lx (Very Overcast)":100,"350 lx (Office Room)":350,"400 lx (Sunrise/Sunset)":400,"1000 lx (Overcast)":1e3,"18000 lx (Daylight)":18e3,"50000 lx (Direct Sun)":5e4},exposure:t=>Math.pow(t,5),candelaToLumens:t=>4*t*Math.PI,lumensToCandela:t=>t/(4*Math.PI),average:t=>t?.reduce(((t,e)=>t+e),0)/t.length,atan2:(t,e)=>Math.fround(Math.atan2(t,e)),pow:(t,e)=>Math.fround(Math.pow(t,e)),sin:t=>Math.fround(Math.sin(t)),cos:t=>Math.fround(Math.cos(t)),sqrt:t=>Math.fround(Math.sqrt(t)),exp:t=>Math.fround(Math.exp(t)),todeg:v,torad:x,toFixed:(t,e=3)=>1*t.toFixed(e),toRound:(t,e=3)=>Math.trunc(t),clamp:(t,e=0,i=1)=>t=(t=t<e?e:t)>i?i:t,clampA:(t,e,i)=>Math.max(e,Math.min(i,t)),smoothstep:(t,e,i)=>t*(i=-2*(i=k.clamp(i))*i*i+3*i*i)+e*(1-i),remap:(t,e,i,s,a)=>s+(t-e)*(a-s)/(i-e),lerp:(t,e,i)=>(1-i)*t+i*e,damp:(t,e,i,s)=>k.lerp(t,e,1-Math.exp(-i*s)),nearAngle:(t,e,i=!1)=>e+Math.atan2(Math.sin(t-e),Math.cos(t-e))*(i?v:1),unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),nearEquals:(t,e,i=1e-4)=>Math.abs(t-e)<=i,autoSize:(t=[1,1,1],e="box")=>{1===t.length&&(t[1]=t[0]);let i=t[0],s=t[1];return"sphere"===e&&(t=[i,i,i]),"cylinder"!==e&&"wheel"!==e&&"capsule"!==e||(t=[i,s,i]),"cone"!==e&&"pyramid"!==e||(t=[i,s,i]),2===t.length&&(t[2]=t[0]),t},shuffle:t=>{let e=t.map((t=>({value:t,sort:Math.random()}))).sort(((t,e)=>t.sort-e.sort)).map((({value:t})=>t));return e},randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),randIntUnic:(t,e,i)=>{for(var s=[];s.length<i;){var a=k.randInt(t,e);-1===s.indexOf(a)&&s.push(a)}return s},fromTransform:(t,e,i,s=[0,0,0,1],a=!1)=>{let r=k.composeMatrixArray(t,e),o=k.composeMatrixArray(i,s);return a&&(r=k.invertMatrixArray(r)),r=k.multiplyMatrixArray(r,o),[r[12],r[13],r[14]]},fromTransformToQ:(t,e,i=!1)=>{let s=k.composeMatrixArray(t,e),a=k.decomposeFullMatrixArray(s).q;return i&&(a=k.quatInvert(a)),a},lerpTransform:(t,e,i)=>{let s=t[0],a=t[1],r=e[0],o=e[1];return r=k.lerpArray(s,r,i),o=k.slerpQuatArray(a,o,i),[r,o]},composeMatrixArray:(t,e,i=[1,1,1])=>{const s=e[0],a=e[1],r=e[2],o=e[3],n=s+s,l=a+a,h=r+r,c=s*n,d=s*l,u=s*h,p=a*l,m=a*h,f=r*h,b=o*n,g=o*l,y=o*h,x=i[0],v=i[1],w=i[2];return[(1-(p+f))*x,(d+y)*x,(u-g)*x,0,(d-y)*v,(1-(c+f))*v,(m+b)*v,0,(u+g)*w,(m-b)*w,(1-(c+p))*w,0,t[0],t[1],t[2],1]},multiplyMatrixArray:(t,e)=>{const i=t,s=e,a=[],r=i[0],o=i[4],n=i[8],l=i[12],h=i[1],c=i[5],d=i[9],u=i[13],p=i[2],m=i[6],f=i[10],b=i[14],g=i[3],y=i[7],x=i[11],v=i[15],w=s[0],M=s[4],k=s[8],A=s[12],S=s[1],T=s[5],P=s[9],z=s[13],R=s[2],E=s[6],F=s[10],B=s[14],C=s[3],L=s[7],_=s[11],D=s[15];return a[0]=r*w+o*S+n*R+l*C,a[4]=r*M+o*T+n*E+l*L,a[8]=r*k+o*P+n*F+l*_,a[12]=r*A+o*z+n*B+l*D,a[1]=h*w+c*S+d*R+u*C,a[5]=h*M+c*T+d*E+u*L,a[9]=h*k+c*P+d*F+u*_,a[13]=h*A+c*z+d*B+u*D,a[2]=p*w+m*S+f*R+b*C,a[6]=p*M+m*T+f*E+b*L,a[10]=p*k+m*P+f*F+b*_,a[14]=p*A+m*z+f*B+b*D,a[3]=g*w+y*S+x*R+v*C,a[7]=g*M+y*T+x*E+v*L,a[11]=g*k+y*P+x*F+v*_,a[15]=g*A+y*z+x*B+v*D,a},invertMatrixArray:t=>{const e=t,i=e[0],s=e[1],a=e[2],r=e[3],o=e[4],n=e[5],l=e[6],h=e[7],c=e[8],d=e[9],u=e[10],p=e[11],m=e[12],f=e[13],b=e[14],g=e[15],y=d*b*h-f*u*h+f*l*p-n*b*p-d*l*g+n*u*g,x=m*u*h-c*b*h-m*l*p+o*b*p+c*l*g-o*u*g,v=c*f*h-m*d*h+m*n*p-o*f*p-c*n*g+o*d*g,w=m*d*l-c*f*l-m*n*u+o*f*u+c*n*b-o*d*b,M=i*y+s*x+a*v+r*w;if(0===M)return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const k=1/M;return e[0]=y*k,e[1]=(f*u*r-d*b*r-f*a*p+s*b*p+d*a*g-s*u*g)*k,e[2]=(n*b*r-f*l*r+f*a*h-s*b*h-n*a*g+s*l*g)*k,e[3]=(d*l*r-n*u*r-d*a*h+s*u*h+n*a*p-s*l*p)*k,e[4]=x*k,e[5]=(c*b*r-m*u*r+m*a*p-i*b*p-c*a*g+i*u*g)*k,e[6]=(m*l*r-o*b*r-m*a*h+i*b*h+o*a*g-i*l*g)*k,e[7]=(o*u*r-c*l*r+c*a*h-i*u*h-o*a*p+i*l*p)*k,e[8]=v*k,e[9]=(m*d*r-c*f*r-m*s*p+i*f*p+c*s*g-i*d*g)*k,e[10]=(o*f*r-m*n*r+m*s*h-i*f*h-o*s*g+i*n*g)*k,e[11]=(c*n*r-o*d*r-c*s*h+i*d*h+o*s*p-i*n*p)*k,e[12]=w*k,e[13]=(c*f*a-m*d*a+m*s*u-i*f*u-c*s*b+i*d*b)*k,e[14]=(m*n*a-o*f*a-m*s*l+i*f*l+o*s*b-i*n*b)*k,e[15]=(o*d*a-c*n*a+c*s*l-i*d*l-o*s*u+i*n*u)*k,e},matrixArrayDeterminant:t=>{const e=t,i=e[0],s=e[4],a=e[8],r=e[12],o=e[1],n=e[5],l=e[9],h=e[13],c=e[2],d=e[6],u=e[10],p=e[14];return e[3]*(+r*l*d-a*h*d-r*n*u+s*h*u+a*n*p-s*l*p)+e[7]*(+i*l*p-i*h*u+r*o*u-a*o*p+a*h*c-r*l*c)+e[11]*(+i*h*d-i*n*p-r*o*d+s*o*p+r*n*c-s*h*c)+e[15]*(-a*n*c-i*l*d+i*n*u+a*o*d-s*o*u+s*l*c)},decomposeMatrixArray:t=>[t[12],t[13],t[14]],decomposeFullMatrixArray:t=>{const e=t;let i=k.lengthArray([e[0],e[1],e[2]]);const s=k.lengthArray([e[4],e[5],e[6]]),a=k.lengthArray([e[8],e[9],e[10]]);k.matrixArrayDeterminant(t)<0&&(i=-i);let r=[...t];const o=1/i,n=1/s,l=1/a;r[0]*=o,r[1]*=o,r[2]*=o,r[4]*=n,r[5]*=n,r[6]*=n,r[8]*=l,r[9]*=l,r[10]*=l;let h=k.quatFromRotationMatrix(r);return{p:[t[12],t[13],t[14]],q:h,s:[i,s,a]}},applyTransformArray:(t,e,i,s=[1,1,1])=>{const a=k.composeMatrixArray(e,i,s),r=t[0],o=t[1],n=t[2],l=1/(a[3]*r+a[7]*o+a[11]*n+a[15]);return[(a[0]*r+a[4]*o+a[8]*n+a[12])*l,(a[1]*r+a[5]*o+a[9]*n+a[13])*l,(a[2]*r+a[6]*o+a[10]*n+a[14])*l]},slerpQuatArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=[...t];const a=t[0],r=t[1],o=t[2],n=t[3],l=e[0],h=e[1],c=e[2],d=e[3];let u=n*d+a*l+r*h+o*c;if(u<0?(s=[-l,-h,-c,-d],u=-u):s=[...e],u>=1)return t;const p=1-u*u;if(p<=w){const t=1-i;return s[3]=t*n+i*s[3],s[0]=t*a+i*s[0],s[1]=t*r+i*s[1],s[2]=t*o+i*s[2],k.quatNomalize(s)}const m=Math.sqrt(p),f=Math.atan2(m,u),b=Math.sin((1-i)*f)/m,g=Math.sin(i*f)/m;return s[3]=n*b+s[3]*g,s[0]=a*b+s[0]*g,s[1]=r*b+s[1]*g,s[2]=o*b+s[2]*g,s},toLocalQuatArray:(t=[0,0,0],e)=>{let i=k.quatFromEuler(t),s=k.quatInvert(e.quaternion.toArray());return k.quatMultiply(s,i)},quatFromRotationMatrix:t=>{let e=[0,0,0,1];const i=t,s=i[0],a=i[4],r=i[8],o=i[1],n=i[5],l=i[9],h=i[2],c=i[6],d=i[10],u=s+n+d;if(u>0){const t=.5/Math.sqrt(u+1);e[3]=.25/t,e[0]=(c-l)*t,e[1]=(r-h)*t,e[2]=(o-a)*t}else if(s>n&&s>d){const t=2*Math.sqrt(1+s-n-d);e[3]=(c-l)/t,e[0]=.25*t,e[1]=(a+o)/t,e[2]=(r+h)/t}else if(n>d){const t=2*Math.sqrt(1+n-s-d);e[3]=(r-h)/t,e[0]=(a+o)/t,e[1]=.25*t,e[2]=(l+c)/t}else{const t=2*Math.sqrt(1+d-s-n);e[3]=(o-a)/t,e[0]=(r+h)/t,e[1]=(l+c)/t,e[2]=.25*t}return e},quatFromEuler:(t=[0,0,0],e=!0)=>{const i=Math.cos,s=Math.sin,a=e?x:1,r=t[0]*a*.5,o=t[1]*a*.5,n=t[2]*a*.5,l=i(r),h=i(o),c=i(n),d=s(r),u=s(o),p=s(n);return[d*h*c+l*u*p,l*u*c-d*h*p,l*h*p+d*u*c,l*h*c-d*u*p]},quatFromAxis:(t=[0,0,0],e,i=!0)=>{const s=.5*e*(i?x:1),a=Math.sin(s);return[t[0]*a,t[1]*a,t[2]*a,Math.cos(s)]},quatNomalize:t=>{let e=k.lengthArray(t);return 0===e?[0,0,0,1]:(e=1/e,k.scaleArray(t,e,4))},quatInvert:t=>[-t[0],-t[1],-t[2],t[3]],quatMultiply:(t,e)=>{const i=t[0],s=t[1],a=t[2],r=t[3],o=e[0],n=e[1],l=e[2],h=e[3];return[i*h+r*o+s*l-a*n,s*h+r*n+a*o-i*l,a*h+r*l+i*n-s*o,r*h-i*o-s*n-a*l]},quatToAxis:t=>{let e=2*Math.acos(t[3]);const i=Math.sqrt(1-t[3]*t[3]);return i<1e-4?[1,0,0]:[t[0]/i,t[1]/i,t[2]/i,e]},eulerFromMatrix:t=>{const e=t[0],i=t[4],s=t[8];t[1];const a=t[5],r=t[9];t[2];const o=t[6],n=t[10];let l=[0,0,0];return l[1]=Math.asin(k.clamp(s,-1,1)),Math.abs(s)<.9999999?(l[0]=Math.atan2(-r,n),l[2]=Math.atan2(-i,e)):(l[0]=Math.atan2(o,a),l[2]=0),l},angleTo:(t,e)=>2*Math.acos(Math.abs(k.clamp(k.dotArray(t,e),-1,1))),fixedArray:(t,e)=>{let i=t.length,s=[];for(;i--;)s[i]=k.toFixed(t[i],e);return s},getSize:t=>.001*t.byteLength+"kb",perpendicularArray:t=>{const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);let i=Math.acos(t[1]/e);const s=Math.atan2(t[2],t[0]);i>M?i-=M:i+=M;return[e*Math.sin(i)*Math.cos(s),e*Math.cos(i),e*Math.sin(i)*Math.sin(s)]},crossArray:(t,e)=>{const i=t[0],s=t[1],a=t[2],r=e[0],o=e[1],n=e[2];return[s*n-a*o,a*r-i*n,i*o-s*r]},applyQuaternion:(t,e)=>{const i=t[0],s=t[1],a=t[2],r=e[0],o=e[1],n=e[2],l=e[3],h=2*(o*a-n*s),c=2*(n*i-r*a),d=2*(r*s-o*i);return[i+l*h+o*d-n*c,s+l*c+n*h-r*d,a+l*d+r*c-o*h]},nullArray:(t,e,i)=>{let s=0;for(;i--;)s+=t[e+i];return s},equalArray:(t,e)=>{let i=t.length;for(;i--;)if(t[i]!==e[i])return!1;return!0},lerpArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=t.length,a=[];for(;s--;)a[s]=t[s],a[s]+=(e[s]-a[s])*i;return a},zeroArray:(t,e=0,i)=>{for(i=i??t.length;i--;)t[e+i]=0;return t},lengthArray:t=>{let e=t.length,i=0;for(;e--;)i+=t[e]*t[e];return Math.sqrt(i)},dotArray:(t,e)=>{let i=t.length,s=0;for(;i--;)s+=t[i]*e[i];return s},addArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]+e[i];return s},subArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]-e[i];return s},mulArray:(t,e,i)=>{if(e instanceof Array){let s=[];for(i=i??t.length;i--;)s[i]=t[i]*e[i];return s}return t.map((t=>t*e))},worldscale:(t,e)=>t.map((t=>t*e)),divArray:(t,e,i)=>k.mulArray(t,1/e,i),scaleArray:(t,e,i)=>k.mulArray(t,e,i),fillArray:(t,e,i=0,s)=>{for(s=s??t.length;s--;)e[i+s]=t[s]},copyArray:(t,e)=>{},cloneArray:t=>[...t],distanceArray:(t,e=[0,0,0])=>k.lengthArray(k.subArray(t,e)),normalizeArray:t=>k.divArray(t,k.lengthArray(t)||1),normalArray:(t,e=[0,0,0])=>k.normalizeArray(k.subArray(e,t)),getCenter:(t,e)=>(t.computeBoundingBox(),t.boundingBox.getCenter(e)),getVolume:(t,e,i=null)=>{let s=1,a=e;switch(t){case"sphere":s=4*Math.PI*a[0]*a[0]*a[0]/3;break;case"cone":s=Math.PI*a[0]*(.5*a[1])*2;break;case"box":s=.5*a[0]*8*(.5*a[1])*(.5*a[2]);break;case"cylinder":s=Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"capsule":s=4*Math.PI*a[0]*a[0]*a[0]/3+Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"convex":case"mesh":s=k.getConvexVolume(i)}return s},getConvexVolume:t=>{let e,i=t.length/3,s=[0,0,0],a=[0,0,0];for(;i--;)e=3*i,t[e]<s[0]?s[0]=t[e]:t[e]>a[0]&&(a[0]=t[e]),t[e+1]<s[1]?s[1]=t[e+1]:t[e+1]>a[1]&&(a[1]=t[e+1]),t[e+2]<s[2]?s[2]=t[e+2]:t[e+2]>a[2]&&(a[2]=t[e+2]);let r=[a[0]-s[0],a[1]-s[1],a[2]-s[2]];return.5*r[0]*8*(.5*r[1])*(.5*r[2])},massFromDensity:(t,e)=>t*e,densityFromMass:(t,e)=>t/e,toNonIndexed:t=>t.index?t.clone().toNonIndexed():t,getIndex:(t,e)=>!t.index||e?null:t.index.array||null,getSameVertex:t=>{const e=t.getAttribute("position"),i=e.array,s=[],a=[],r={};new THREE.Vector3;let o,n=0;k.getHash(t);let l,h,c=!1,d=0;for(let t=0;t<e.count;t++){n=3*t,l={x:i[n],y:i[n+1],z:i[n+2],id:t},c=!1,o=s.length;for(let e=0;e<o;e++)h=s[e],l.x===h.x&&l.y===h.y&&l.z===h.z&&(c=!0,r[t]=h.id);c||(l.id=d++,s.push(l),a.push([l.x,l.y,l.z]))}return[a,r]},getVertex:(t,e)=>{let i=t.attributes.position.array;return e&&t.index&&(i=(t=t.clone().toNonIndexed()).attributes.position.array),i},getNormal:t=>t.attributes.normal.array,getFaces:t=>{let e=[];if(t.index){let i=t.getIndex();for(let t=0;t<i.count;t+=3)e.push([i.getX(t),i.getX(t+1),i.getX(t+2)])}else{let i=t.getAttribute("position").count;for(let t=0;t<i;t+=3)e.push([t,t+1,t+2])}return e},getConnectedFaces:t=>{const e=[];let i,s,a,r,o,n,l,h=t.length,c=h;for(;c--;)for(s=t[c],i=h;i--;)i!==c&&(a=t[i],r=s.filter((t=>a.includes(t))),r.length>1&&(l=[],o=[...s],n=o.indexOf(r[0]),o.splice(n,1),n=o.indexOf(r[1]),o.splice(n,1),l.push(o[0]),o=[...a],n=o.indexOf(r[0]),o.splice(n,1),n=o.indexOf(r[1]),o.splice(n,1),l.push(o[0]),e.push(l)));return e},reduce:t=>{},barycentric:(t,e)=>{},solve:(t,e)=>{},getHash:(t,e=1e-4)=>{e=Math.max(e,Number.EPSILON);const i={},s={},a=t.getAttribute("position"),r=a.count,o=a.array,n=.5*e,l=Math.log10(1/e),h=Math.pow(10,l),c=n*h;let d;for(let t=0;t<r;t++){d=3*t;let e=`${~~(o[d]*h+c)},${~~(o[d+1]*h+c)},${~~(o[d+2]*h+c)}`;i[e]?i[e].push(t):i[e]=[t]}let u=0;for(let t in i)s[u++]=i[t];return s}},A=k,S=["PHYSX","HAVOK"],T=4e3,P=1e3,z=4e3,R=100,E=100,F=50,B=20,C={bodyFull:14,body:8,joint:16,contact:1,ray:11,character:16,vehicle:72,solver:128},L=function(t,e=!1){const i={};let s={body:T*(e?C.bodyFull:C.body),joint:P*C.joint,ray:R*C.ray,contact:z*C.contact,character:E*C.character};"PHYSX"!==t&&"AMMO"!==t||(s.vehicle=F*C.vehicle),"PHYSX"===t&&(s.solver=B*C.solver),"HAVOK"!==t&&"RAPIER"!==t&&"JOLT"!==t||(C.joint=0);let a=0;for(let t in s)i[t]=a,a+=s[t];return i.total=a,i};class _ extends e.LineSegments{constructor(t,i=16776960){const s=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),a=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],r=new e.BufferGeometry;r.setIndex(new e.BufferAttribute(s,1)),r.setAttribute("position",new e.Float32BufferAttribute(a,3)),r.setAttribute("color",new e.Float32BufferAttribute([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(r,new e.LineBasicMaterial({color:i,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=t,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(t){const e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(t))}dispose(){this.geometry.dispose(),this.material.dispose()}}function D(t,i=!1){const s=null!==t[0].index,a=new Set(Object.keys(t[0].attributes)),r=new Set(Object.keys(t[0].morphAttributes)),o={},n={},l=t[0].morphTargetsRelative,h=new e.BufferGeometry;let c=0;for(let e=0;e<t.length;++e){const d=t[e];let u=0;if(s!==(null!==d.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const t in d.attributes){if(!a.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+'. All geometries must have compatible attributes; make sure "'+t+'" attribute exists among all geometries, or in none of them.'),null;void 0===o[t]&&(o[t]=[]),o[t].push(d.attributes[t]),u++}if(u!==a.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". Make sure all geometries have the same number of attributes."),null;if(l!==d.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const t in d.morphAttributes){if(!r.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===n[t]&&(n[t]=[]),n[t].push(d.morphAttributes[t])}if(i){let t;if(s)t=d.index.count;else{if(void 0===d.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". The geometry must have either an index or a position attribute"),null;t=d.attributes.position.count}h.addGroup(c,t,e),c+=t}}if(s){let e=0;const i=[];for(let s=0;s<t.length;++s){const a=t[s].index;for(let t=0;t<a.count;++t)i.push(a.getX(t)+e);e+=t[s].attributes.position.count}h.setIndex(i)}for(const t in o){const e=V(o[t]);if(!e)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" attribute."),null;h.setAttribute(t,e)}for(const t in n){const e=n[t][0].length;if(0===e)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[t]=[];for(let i=0;i<e;++i){const e=[];for(let s=0;s<n[t].length;++s)e.push(n[t][s][i]);const s=V(e);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" morphAttribute."),null;h.morphAttributes[t].push(s)}}return h}function V(t){let i,s,a,r=-1,o=0;for(let e=0;e<t.length;++e){const n=t[e];if(void 0===i&&(i=n.array.constructor),i!==n.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===s&&(s=n.itemSize),s!==n.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===a&&(a=n.normalized),a!==n.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===r&&(r=n.gpuType),r!==n.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;o+=n.count*s}const n=new i(o),l=new e.BufferAttribute(n,s,a);let h=0;for(let e=0;e<t.length;++e){const i=t[e];if(i.isInterleavedBufferAttribute){const t=h/s;for(let e=0,a=i.count;e<a;e++)for(let a=0;a<s;a++){const s=i.getComponent(e,a);l.setComponent(e+t,a,s)}}else n.set(i.array,h);h+=i.count*s}return void 0!==r&&(l.gpuType=r),l}function j(t,e=1e-4){e=Math.max(e,Number.EPSILON);const i={},s=t.getIndex(),a=t.getAttribute("position"),r=s?s.count:a.count;let o=0;const n=Object.keys(t.attributes),l={},h={},c=[],d=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"];for(let e=0,i=n.length;e<i;e++){const i=n[e],s=t.attributes[i];l[i]=new s.constructor(new s.array.constructor(s.count*s.itemSize),s.itemSize,s.normalized);const a=t.morphAttributes[i];a&&(h[i]||(h[i]=[]),a.forEach(((t,e)=>{const s=new t.array.constructor(t.count*t.itemSize);h[i][e]=new t.constructor(s,t.itemSize,t.normalized)})))}const p=.5*e,m=Math.log10(1/e),f=Math.pow(10,m),b=p*f;for(let e=0;e<r;e++){const a=s?s.getX(e):e;let r="";for(let e=0,i=n.length;e<i;e++){const i=n[e],s=t.getAttribute(i),o=s.itemSize;for(let t=0;t<o;t++)r+=~~(s[d[t]](a)*f+b)+","}if(r in i)c.push(i[r]);else{for(let e=0,i=n.length;e<i;e++){const i=n[e],s=t.getAttribute(i),r=t.morphAttributes[i],c=s.itemSize,p=l[i],m=h[i];for(let t=0;t<c;t++){const e=d[t],i=u[t];if(p[i](o,s[e](a)),r)for(let t=0,s=r.length;t<s;t++)m[t][i](o,r[t][e](a))}}i[r]=o,c.push(o),o++}}const g=t.clone();for(const e in t.attributes){const t=l[e];if(g.setAttribute(e,new t.constructor(t.array.slice(0,o*t.itemSize),t.itemSize,t.normalized)),e in h)for(let t=0;t<h[e].length;t++){const i=h[e][t];g.morphAttributes[e][t]=new i.constructor(i.array.slice(0,o*i.itemSize),i.itemSize,i.normalized)}}return g.setIndex(c),g}class q extends e.BufferGeometry{constructor(t=1,i=16,s=16,a=16,r=1){super(),this.type="SphereBox",this.name="SphereBox_"+t+"_"+i+"_"+s+"_"+a+"_"+r,t=t||1,i=Math.floor(i),s=Math.floor(s),a=Math.floor(a);let o,n,l,h=new e.BoxGeometry(1,1,1,i,s,a),c=new e.Vector3,d=new e.Vector3,u=h.attributes.position.count,p=h.attributes.position.array,m=h.attributes.normal.array,f=h.attributes.uv.array,b=h.attributes.uv.count,g=b/6,y=1/3,x=0,v=0;for(let t=0;t<b;t++){switch(l=Math.floor(t/g),l){case 0:x=0,v=.5;break;case 5:x=y,v=.5;break;case 1:x=2*y,v=.5;break;case 4:x=0,v=1;break;case 3:x=y,v=1;break;case 2:x=2*y,v=1}n=2*t,f[n]*=y,f[n]+=x,f[n+1]*=-.5,f[n+1]+=v,f[n]>1&&(f[n]=1),f[n]<0&&(f[n]=0),f[n+1]>1&&(f[n+1]=1),f[n+1]<0&&(f[n+1]=0)}for(let e=0;e<u;e++)o=3*e,c.set(p[o],p[o+1],p[o+2]),d.copy(c).normalize(),c.lerp(d,r).multiplyScalar(t),p[o]=c.x,p[o+1]=c.y,p[o+2]=c.z,c.normalize(),m[o]=c.x,m[o+1]=c.y,m[o+2]=c.z;h.computeTangents(),this.copy(h)}}class O extends e.BufferGeometry{constructor(t=1,i=1,s=12,a=1){super(),this.type="CapsuleGeometry";let r=Math.PI,o=t/(2*t+i),n=1-2*o;s=Math.floor(s),a=Math.floor(a);let l=Math.floor(.5*s),h=2*Math.PI,c=.5*Math.PI,d=new e.CylinderGeometry(t,t,i,s,a,!0);W(d,0,o,1,n);let u=new e.SphereGeometry(t,s,l,0,h,0,c);W(u,0,1-o,1,o);let p=new e.SphereGeometry(t,s,l,0,h,c,c);W(p,0,0,1,o);let m=(new e.Matrix4).makeRotationY(.5*-r),f=(new e.Matrix4).makeTranslation(0,.5*i,0),b=(new e.Matrix4).makeTranslation(0,.5*-i,0);d.applyMatrix4(m),u.applyMatrix4(f),p.applyMatrix4(b);let g=j(D([d,u,p]));this.copy(g)}}class I extends e.BufferGeometry{constructor(t=1,i=.4,s=8,a=6,r=2*Math.PI,o=0,n=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:t,tube:i,radialSegments:s,tubularSegments:a,arc:r},s=Math.floor(s),a=Math.floor(a);const l=[],h=[],c=[],d=[],u=new e.Vector3,p=new e.Vector3,m=new e.Vector3;let f,b;for(f=0;f<=s;f++)for(b=0;b<=a;b++){const e=b/a*r,l=f/s*n+o;p.x=(t+i*Math.cos(l))*Math.cos(e),p.y=(t+i*Math.cos(l))*Math.sin(e),p.z=i*Math.sin(l),h.push(p.x,p.y,p.z),u.x=t*Math.cos(e),u.y=t*Math.sin(e),m.subVectors(p,u).normalize(),c.push(m.x,m.y,m.z),d.push(b/a),d.push(f/s)}for(f=1;f<=s;f++)for(b=1;b<=a;b++){const t=(a+1)*f+b-1,e=(a+1)*(f-1)+b-1,i=(a+1)*(f-1)+b,s=(a+1)*f+b;l.push(t,e,s),l.push(e,i,s)}this.setIndex(l),this.setAttribute("position",new e.Float32BufferAttribute(h,3)),this.setAttribute("normal",new e.Float32BufferAttribute(c,3)),this.setAttribute("uv",new e.Float32BufferAttribute(d,2))}}class G extends e.BufferGeometry{constructor(t=1,i=1,s=1,a=.01,r=12,o=1,n=2){super(),this.type="ChamferCyl",r=Math.floor(r),o=Math.floor(o),n=Math.floor(n);let l=new e.Matrix4,h=new e.Matrix4,c=Math.PI,d=.5*c,u=2*c,p=a/s,m=1-2*p,f=new e.CylinderGeometry(t,i,s-2*a,r,o,!0,0);l.makeRotationY(d),f.applyMatrix4(l),W(f,0,p,1,m);let b=new I(t-a,a,n,r,u,0,d),g=new e.CircleGeometry(t-a,r);h.makeTranslation(0,0,a),g.applyMatrix4(h),W(b,0,1-p,1,p);let y=D([b,g]);l.makeTranslation(0,0,.5*s-a),h.makeRotationX(-d),y.applyMatrix4(h.multiply(l)),b=new I(i-a,a,n,r,u,0,d),g=new e.CircleGeometry(i-a,r),h.makeTranslation(0,0,a),g.applyMatrix4(h),W(b,0,1-p,1,p,!0);let x=D([b,g]);l.makeTranslation(0,0,.5*s-a),h.makeRotationX(d),x.applyMatrix4(h.multiply(l));let v=j(D([y,f,x]));this.copy(v)}}let U=class extends e.BufferGeometry{constructor(t=1,i=1,s=1,a=.01,r=1,o=1,n=1,l=2){super(),this.type="ChamferBox",r=Math.floor(r),o=Math.floor(o),n=Math.floor(n),l=Math.floor(l);let h=Math.PI,c=.5*h,d=2*a,u=.5*t,p=.5*i,m=.5*s,f=new e.Matrix4,b=new e.Matrix4,g=new e.Matrix4,y=a/t,x=1-2*y,v=a/i,w=1-2*y,M=a/s,k=1-2*M,A=new e.PlaneGeometry(t-d,i-d,r,o),S=new e.CylinderGeometry(a,a,t-d,l,r,!0,0,c),T=new e.CylinderGeometry(a,a,i-d,l,o,!0,0,c),P=new N(a,l,l,0,c,0,-c),z=new N(a,l,l,0,c,0,-c);W(A,-y,v,x,w),W(S,0,y,v,x),b.makeTranslation(0,p-a,0),f.makeRotationX(c),P.applyMatrix4(b.multiply(f)),b.makeTranslation(0,-p+a,0),f.makeRotationX(c),g.makeRotationY(-c),z.applyMatrix4(b.multiply(f).multiply(g));let R=D([T,P,z]),E=R.clone();b.makeTranslation(u-a,0,-a),R.applyMatrix4(b),b.makeTranslation(-u+a,0,-a),f.makeRotationZ(h),E.applyMatrix4(b.multiply(f));let F=S.clone();f.makeRotationZ(c),b.makeTranslation(0,p-a,-a),S.applyMatrix4(b.multiply(f)),b.makeTranslation(0,-p+a,-a),f.makeRotationZ(-c),F.applyMatrix4(b.multiply(f));let B=D([S,F,A,R,E]),C=B.clone();b.makeTranslation(0,0,m),B.applyMatrix4(b),b.makeTranslation(0,0,-m),f.makeRotationY(h),C.applyMatrix4(b.multiply(f)),A=new e.PlaneGeometry(s-d,i-d,n,o),S=new e.CylinderGeometry(a,a,s-d,l,n,!0,0,c),F=S.clone(),W(A,-M,v,k,w),b.makeTranslation(0,-(p-a),-a,0),f.makeRotationZ(-c),S.applyMatrix4(b.multiply(f)),b.makeTranslation(0,p-a,-a,0),f.makeRotationZ(c),F.applyMatrix4(b.multiply(f));let L=D([S,F,A]),_=L.clone();b.makeTranslation(-u,0,0),f.makeRotationY(-c),L.applyMatrix4(b.multiply(f)),b.makeTranslation(u,0,0),f.makeRotationY(c),_.applyMatrix4(b.multiply(f)),A=new e.PlaneGeometry(t-d,s-d,r,n),W(A,-y,M,x,k);let V=A.clone();b.makeTranslation(0,p,0),f.makeRotationX(-c),A.applyMatrix4(b.multiply(f)),b.makeTranslation(0,-p,0),f.makeRotationX(c),V.applyMatrix4(b.multiply(f));let q=j(D([B,C,L,_,A,V]));H(q,"box"),this.copy(q)}},N=class extends e.BufferGeometry{constructor(t=1,i=8,s=6,a=0,r=2*Math.PI,o=0,n=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:t,widthSegments:i,heightSegments:s,phiStart:a,phiLength:r,thetaStart:o,thetaLength:n},i=Math.floor(i),s=Math.floor(s);const l=Math.min(o+n,Math.PI);let h=0;const c=[],d=new e.Vector3,u=new e.Vector3,p=[],m=[],f=[],b=[];for(let e=0;e<=s;e++){const p=[],g=e/s;let y=0;0==e&&0==o?y=.5/i:e==s&&l==Math.PI&&(y=-.5/i);for(let e=0;e<=i;e++){const s=e/i;d.x=-t*Math.cos(a+s*r)*Math.sin(o+g*n),d.y=t*Math.cos(o+g*n),d.z=t*Math.sin(a+s*r)*Math.sin(o+g*n),m.push(d.x,d.y,d.z),u.copy(d).normalize(),f.push(u.x,u.y,u.z),b.push(s+y,1-g),p.push(h++)}c.push(p)}for(let t=0;t<s;t++)for(let e=0;e<i;e++){const i=c[t][e+1],a=c[t][e],r=c[t+1][e],n=c[t+1][e+1];(0!==t||o>0)&&p.push(i,a,n),(t!==s-1||l<Math.PI)&&p.push(a,r,n)}this.setIndex(p),this.setAttribute("position",new e.Float32BufferAttribute(m,3)),this.setAttribute("normal",new e.Float32BufferAttribute(f,3)),this.setAttribute("uv",new e.Float32BufferAttribute(b,2))}};function W(t,e=0,i=0,s=1,a=1,r){let o=t.attributes.uv,n=o.array,l=o.count,h=0;for(;l--;)h=2*l,n[h]=n[h]*s-e,n[h+1]=n[h+1]*a+i,r&&(n[h]=1-n[h],n[h+1]=1-n[h+1])}function H(t,i="sphere",s,a=[0,0,0],r=[0,0,0,1],o){if(void 0===o&&(o=new e.Matrix4),o.compose({x:a[0],y:a[1],z:a[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===s){t.boundingBox||t.computeBoundingBox();let e=t.boundingBox;s=Math.max(e.max.x-e.min.x,e.max.y-e.min.y,e.max.z-e.min.z)}let n=new e.Box3(new e.Vector3(-s/2,-s/2,-s/2),new e.Vector3(s/2,s/2,s/2)),l=[];l.length=2*t.attributes.position.count,void 0===t.attributes.uv&&t.setAttribute("uv",new e.Float32BufferAttribute(l,2));let h,c,d,u,p,m=function(t,i,s){t.applyMatrix4(o),i.applyMatrix4(o),s.applyMatrix4(o);let a=1/(2*Math.PI),r=1/Math.PI;return t.normalize(),i.normalize(),s.normalize(),{uv0:new e.Vector2(.5-Math.atan(t.z,-t.x)*a,.5-Math.asin(t.y)*r),uv1:new e.Vector2(.5-Math.atan(i.z,-i.x)*a,.5-Math.asin(i.y)*r),uv2:new e.Vector2(.5-Math.atan(s.z,-s.x)*a,.5-Math.asin(s.y)*r)}},f=function(t,i,a){t.applyMatrix4(o),i.applyMatrix4(o),a.applyMatrix4(o);let r=new e.Vector3;r.crossVectors(i.clone().sub(t),i.clone().sub(a)).normalize(),r.x<0||r.y<0||r.z,r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z);let l=new e.Vector2,h=new e.Vector2,c=new e.Vector2,d=1/s;return r.y>r.x&&r.y>r.z?(l.set(t.x-n.min.x,n.max.z-t.z).multiplyScalar(d),h.set(i.x-n.min.x,n.max.z-i.z).multiplyScalar(d),c.set(a.x-n.min.x,n.max.z-a.z).multiplyScalar(d)):r.x>r.y&&r.x>r.z?(l.set(t.z-n.min.z,t.y-n.min.y).multiplyScalar(d),h.set(i.z-n.min.z,i.y-n.min.y).multiplyScalar(d),c.set(a.z-n.min.z,a.y-n.min.y).multiplyScalar(d)):r.z>r.y&&r.z>r.x&&(l.set(t.x-n.min.x,t.y-n.min.y).multiplyScalar(d),h.set(i.x-n.min.x,i.y-n.min.y).multiplyScalar(d),c.set(a.x-n.min.x,a.y-n.min.y).multiplyScalar(d)),{uv0:l,uv1:h,uv2:c}},b=new e.Vector3,g=new e.Vector3,y=new e.Vector3;new e.Vector3,new e.Vector3,new e.Vector3;const x=t.getAttribute("position");if(t.getAttribute("normal"),t.index)for(h=0;h<t.index.count;h+=3)c=t.index.getX(h+0),d=t.index.getX(h+1),u=t.index.getX(h+2),b.fromBufferAttribute(x,c),g.fromBufferAttribute(x,d),y.fromBufferAttribute(x,u),p="sphere"===i?m(b,g,y):f(b,g,y),l[2*c]=p.uv0.x,l[2*c+1]=p.uv0.y,l[2*d]=p.uv1.x,l[2*d+1]=p.uv1.y,l[2*u]=p.uv2.x,l[2*u+1]=p.uv2.y;else for(h=0;h<x.count;h+=3){b.fromBufferAttribute(x,h+0),g.fromBufferAttribute(x,h+1),y.fromBufferAttribute(x,h+2),p="sphere"===i?m(b,g,y):f(b,g,y);let t=h,e=h+1,s=h+2;l[2*t]=p.uv0.x,l[2*t+1]=p.uv0.y,l[2*e]=p.uv1.x,l[2*e+1]=p.uv1.y,l[2*s]=p.uv2.x,l[2*s+1]=p.uv2.y}t.attributes.uv.array=new Float32Array(l),t.attributes.uv.needsUpdate=!0}let K=class{constructor(){this.geoN=0,this.geo={}}unic(t){this.geo["geo"+this.geoN++]=t}set(t){this.geo[t.name]=t}get(t,i={}){if(!this.geo[t]){let i;switch(t){case"plane":i=new e.PlaneGeometry(1,1),i.rotateX(.5*-Math.PI);break;case"box":i=new e.BoxGeometry(1,1,1);break;case"sphere":i=new e.SphereGeometry(1,16,12);break;case"highSphere":i=new q(1);break;case"cylinder":i=new e.CylinderGeometry(1,1,1,16);break;case"cone":i=new e.CylinderGeometry(.001,1,1,16);break;case"particle":i=new e.SphereGeometry(1,6,4);break;case"joint":i=(new _).geometry;break;default:return null}this.geo[t]=i}return this.geo[t]}dispose(){for(let t in this.geo)this.geo[t].isBufferGeometry?this.geo[t].dispose():console.log(this.geo[t]);this.geo={},this.geoN=0}};class X{constructor(t,i="rgb(69,69,69)",s="rgb(39,39,39)"){const a=document.createElement("canvas");a.width=a.height=128;const r=a.getContext("2d");if(r.fillStyle=i,r.fillRect(0,0,128,128),t){let e,a,o,n,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=t?"rgb(128,128,255)":i,d=t?"rgb(160,100,255)":s,u=t?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(r.strokeStyle=u,r.lineWidth=1,e=0;e<5;e++){n=r.createLinearGradient(0,h[e][0],0,h[e][1]),n.addColorStop(0,d),n.addColorStop(1,c),r.beginPath(),r.fillStyle=n,r.rect(l[e][0],l[e][1],32,64),r.fill();for(let t=0;t<8;t++)o=2*(Math.random()-.5),r.beginPath(),r.moveTo(l[e][0]+o+2+4*t,l[e][1]),r.lineTo(l[e][0]+o+2+4*t,l[e][1]+64),r.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],e=0;e<5;e++)for(n=r.createLinearGradient(h[e][0],0,h[e][1],0),n.addColorStop(0,c),n.addColorStop(1,d),r.beginPath(),r.fillStyle=n,r.rect(l[e][0],l[e][1],64,32),r.fill(),a=0;a<8;a++)o=2*(Math.random()-.5),r.beginPath(),r.moveTo(l[e][0],l[e][1]+o+2+4*a),r.lineTo(l[e][0]+64,l[e][1]+o+2+4*a),r.stroke()}else r.beginPath(),r.fillStyle=s,r.rect(0,0,32,64),r.rect(32,32,32,64),r.rect(64,64,32,64),r.rect(96,96,32,64),r.rect(96,-32,32,64),r.fill();const o=new e.CanvasTexture(a);return o.wrapS=o.wrapT=e.RepeatWrapping,o.repeat.x=o.repeat.y=60,t||(o.colorSpace=e.SRGBColorSpace),o}}class J extends e.MeshPhysicalMaterial{constructor(t){super(),this.defines={STANDARD:"",PHYSICAL:"",SUBSURFACE:"",USE_UV:""},this.extra={},this.addParametre("sssMap",null),this.addParametre("sssColor",new e.Color(0,0,0)),this.addParametre("sssAmbient",.5),this.addParametre("sssDistortion",.6),this.addParametre("sssAttenuation",.1),this.addParametre("sssPower",1),this.addParametre("sssScale",6),this.setValues(t);let i=this;i.onBeforeCompile=function(t){for(let e in i.extra)t.uniforms[e]={value:i.extra[e]};t.fragmentShader=t.fragmentShader.replace("#include <common>",Q.common),t.fragmentShader=t.fragmentShader.replace("#include <lights_fragment_begin>",i.replaceAll(Y,"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );",Q.light)),i.userData.shader=t}}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.userData.shader&&(this.userData.shader.uniforms[t].value=this.extra[t])}})}replaceAll(t,e,i){return t.split(e).join(i)}}const Q={common:"\n\t#include <common>\n\tuniform sampler2D sssMap;\n\tuniform float sssPower;\n\tuniform float sssScale;\n\tuniform float sssDistortion;\n\tuniform float sssAmbient;\n\tuniform float sssAttenuation;\n\tuniform vec3 sssColor;\n\n\tvoid RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n\t\tvec3 thickness = sssColor * texture2D(sssMap, uv).r;\n\t\tvec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * sssDistortion));\n\t\tfloat scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), sssPower) * sssScale;\n\t\tvec3 scatteringIllu = (scatteringDot + sssAmbient) * thickness;\n\t\treflectedLight.directDiffuse += scatteringIllu * sssAttenuation * directLight.color;\n\t}\n\t",light:"\n\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t#if defined( SUBSURFACE ) && defined( USE_UV )\n\t\tRE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n\t#endif\n\t"},Y="\n\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n\n#ifdef USE_CLEARCOAT\n\n\tgeometryClearcoatNormal = clearcoatNormal;\n\n#endif\n\n#ifdef USE_IRIDESCENCE\n\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\n\tif ( material.iridescenceThickness == 0.0 ) {\n\n\t\tmaterial.iridescence = 0.0;\n\n\t} else {\n\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\n\t}\n\n\tif ( material.iridescence > 0.0 ) {\n\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\n\t\t// Iridescence F0 approximation\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\n\t}\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\n\t\t// spot lights are ordered [shadows with maps, shadows without maps, maps without shadows, none]\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t#if defined( USE_LIGHT_PROBES )\n\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\n\t#endif\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",Z={metalness:.1,roughness:.9},$={grey:new e.Color(.18,.18,.18),black:new e.Color(.039,.039,.039),body:new e.Color(13289155),sleep:new e.Color("hsl(33, 15%, 54%)"),solid:new e.Color(7105128),base:new e.Color(13224135),brick:new e.Color(.262,.095,.061),sand:new e.Color(.44,.386,.231),gold:new e.Color(.944,.776,.373),gold2:new e.Color(.998,.981,.751),titanium:new e.Color(.633,.578,.503),titaniumSpec:new e.Color(.728,.68,.55),chrome:new e.Color(.653,.65,.615),chromeSpec:new e.Color(.675,.72,.711),copper:new e.Color(.988,.688,.448),carPaint:new e.Color(.1037792,.59212029,.85064936),clay:new e.Color("hsl(12, 30%, 40%)"),clayWhite:new e.Color(11119017),concrete:new e.Color(.51,.51,.51),Raw_Fire:new e.Color("hsl(40, 18%, 54%)"),Raw_Buff:new e.Color("hsl(33, 15%, 54%)"),Raw_Terracotta:new e.Color("hsl(12, 30%, 40%)"),Raw_Porcelain:new e.Color("hsl(45, 15%, 90%)")},tt={No:e.NoBlending,Normal:e.NormalBlending,Additive:e.AdditiveBlending,Subtractive:e.SubtractiveBlending,Multiply:e.MultiplyBlending,Eadd:e.AddEquation,Esub:e.SubtractEquation,Erev:e.ReverseSubtractEquation,Emin:e.MinEquation,Emaw:e.MaxEquation,Fzero:e.ZeroFactor,Fone:e.OneFactor,Fcolor:e.SrcColorFactor,Fcolorm:e.OneMinusSrcColorFactor,Falpha:e.SrcAlphaFactor,Falpham:e.OneMinusSrcAlphaFactor,Fdstalpha:e.DstAlphaFactor,Fdstalpham:e.OneMinusDstAlphaFactor,Fdstcolor:e.DstColorFactor,Fdstcolorm:e.OneMinusDstColorFactor,Falphasaturate:e.SrcAlphaSaturateFactor,Front:e.FrontSide,Back:e.BackSide,Double:e.DoubleSide};let et=class{constructor(){this.renderMode={value:0},this.depthPacking={value:0},this.extendMat=!1,this.isRealism=!1,this.realismOption={},this.envMapIntensity=1,this.mat={},this.TmpMat=[]}changeRenderMode(t){this.renderMode.value=t}initExtandShader(){}useRealLight(t){}setColor(t){}set(t,e,i=null){i||(i=t.onBeforeCompile),this.mat[t.name]=t}extendShader(t,e=null){}addToTmp(t){this.TmpMat.push(t)}create(t){let i,s=null;if(t.isMaterial)i=t;else{let a=void 0!==t.type?t.type:"Standard";switch(t.type&&delete t.type,s=t.beforeCompile||null,t.beforeCompile&&delete t.beforeCompile,(t.thickness||t.sheen||t.clearcoat||t.transmission||t.specularColor)&&(a="Physical"),t.normalScale&&(t.normalScale.isVector2||(t.normalScale=(new e.Vector2).fromArray(t.normalScale))),t.side&&(t.side=this.findValue(t.side)),t.shadowSide&&(t.shadowSide=this.findValue(t.shadowSide)),t.blending&&(t.blending=this.findValue(t.blending)),t.blendEquation&&(t.blendEquation=this.findValue(t.blendEquation)),t.blendEquationAlpha&&(t.blendEquationAlpha=this.findValue(t.blendEquationAlpha)),t.blendSrc&&(t.blendSrc=this.findValue(t.blendSrc)),t.blendDst&&(t.blendDst=this.findValue(t.blendDst)),t.blendDstAlpha&&(t.blendDstAlpha=this.findValue(t.blendDstAlpha)),t.blendSrcAlpha&&(t.blendSrcAlpha=this.findValue(t.blendSrcAlpha)),t.clearcoatNormalScale&&(t.clearcoatNormalScale.isVector2||(t.clearcoatNormalScale=(new e.Vector2).fromArray(t.clearcoatNormalScale))),a=a.toLowerCase(),a){case"physical":i=new e.MeshPhysicalMaterial(t);break;case"phong":i=new e.MeshPhongMaterial(t);break;case"lambert":i=new e.MeshLambertMaterial(t);break;case"basic":i=new e.MeshBasicMaterial(t);break;case"line":i=new e.LineBasicMaterial(t);break;case"toon":i=new e.MeshToonMaterial(t);break;case"shadow":i=new e.ShadowMaterial(t);break;case"sss":i=new J(t);break;default:i=new e.MeshStandardMaterial(t)}}return this.mat[i.name]?null:(this.set(i,!1,s),i)}findValue(t){return"string"===t?tt[t.charAt(0).toUpperCase()+t.slice(1)]:t}addToMat(t){if(this.isRealism)for(let e in t)t[e].onBeforeCompile=function(i){EnhanceLighting(i,this.realismOption),t[e].userData.isRealism=!0,t[e].userData.shader=i};this.mat={...this.mat,...t}}changeType(){}directIntensity(t){for(let t in this.mat);}getList(){let t={...this.mat};const e=["line","debug","hide","svg"];let i=e.length;for(;i--;)delete t[e[i]];return t}get(t){if(!this.mat[t])switch(t){case"grey":this.create({name:"grey",color:$.grey,metalness:0,roughness:.5});break;case"black":this.create({name:"black",color:$.black,metalness:0,roughness:.5});break;case"body":this.create({name:"body",color:$.body,...Z});break;case"sleep":this.create({name:"sleep",color:$.sleep,...Z});break;case"solid":this.create({name:"solid",color:$.solid,...Z});break;case"base":this.create({name:"base",color:$.base,...Z});break;case"clay":this.create({name:"clay",color:$.clay,metalness:.1,roughness:.7});break;case"clayWhite":this.create({name:"clayWhite",color:$.clayWhite,metalness:.1,roughness:.7});break;case"concrete":this.create({name:"concrete",color:$.concrete,metalness:0,roughness:.9});break;case"brick":this.create({name:"brick",color:$.brick,metalness:0,roughness:.6});break;case"sand":this.create({name:"sand",color:$.sand,metalness:0,roughness:.9});break;case"chrome":this.create({name:"chrome",color:$.chrome,specularColor:$.chromeSpec,metalness:1,roughness:.075});break;case"silver":this.create({name:"silver",color:11184810,metalness:.8,roughness:.22});break;case"gold":this.create({name:"gold",color:$.gold,specularColor:$.gold2,metalness:1,roughness:.02});break;case"copper":this.create({name:"copper",color:$.copper,metalness:1,roughness:.05});break;case"titanium":this.create({name:"titanium",color:$.titanium,metalness:1,roughness:0,specularColor:$.titaniumSpec});break;case"carPaint":this.create({name:"carPaint",color:$.carPaint,metalness:0,anisotropy:new e.Vector2(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":this.create({name:"carbon",map:new X,normalMap:new X(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":this.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":this.create({name:"skinny",color:14724201,...Z});break;case"glass":this.create({name:"glass",color:16777215,transparent:!0,roughness:.02,metalness:0,side:e.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.01});break;case"glassX":this.create({name:"glassX",color:16777215,alphaToCoverage:!0,transparent:!0,opacity:1,roughness:0,metalness:0,side:e.DoubleSide,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.05,ior:1.52,shadowSide:1,reflectivity:.5,iridescence:0,specularIntensity:1,specularColor:16777215});break;case"plexi":this.create({name:"plexi",blending:e.AdditiveBlending,color:65793,transparent:!0,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:e.DoubleSide,alphaToCoverage:!0,premultipliedAlpha:!0});break;case"plexi2":this.create({name:"plexi2",blending:e.AdditiveBlending,color:65793,transparent:!1,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:e.DoubleSide,alphaToCoverage:!1,premultipliedAlpha:!0});break;case"glass2":this.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":this.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":this.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":this.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":this.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":this.create({name:"outline",color:16777215,type:"Basic",side:e.BackSide,toneMapped:!1,wireframe:!0,transparent:!0,opacity:.25});break;case"debug":this.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":this.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":this.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":this.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":this.create({name:"button",color:16728139,...Z});break;case"line":this.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"liner":this.create({name:"liner",type:"line",vertexColors:!0,toneMapped:!1,depthTest:!0,depthWrite:!0,alphaToCoverage:!0});break;case"hide":this.create({name:"hide",type:"basic",visible:!1});break;case"particle":this.create({name:"particle",type:"basic",toneMapped:!1,color:16776960,transparent:!0,opacity:.2});break;case"svg":this.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:e.DoubleSide})}return this.mat[t]}dispose(){this.isRealism=!1;for(let t in this.mat)this.mat[t].dispose(),delete this.mat[t];let t=this.TmpMat.length;for(;t--;)this.TmpMat[t].dispose();this.TmpMat=[]}upShader(){let t=this.realismOption;for(let e in this.mat){const i=this.mat[e],s=i.userData.shader;for(let e in t)s&&void 0!==s.uniforms[e]&&(s.uniforms[e].value=t[e]),i[e]&&(i[e]=t[e])}}};class it{constructor(t=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(t),this.force=!1}up(t){let e=this.time;return this.unlimited&&(this.force=!0),e.now=void 0!==t?t:this.now(),e.delta=e.now-e.then,this.force&&(e.delta=e.interval,this.force=!1),!!(e.delta>=e.interval||this.unlimited)&&(e.then=this.unlimited?e.now:e.now-e.delta%e.interval,this.delta=.001*e.interval,this.elapsedTime+=this.delta,!0)}setFramerate(t){this.elapsedTime=0,this.framerate=t,this.unlimited=this.framerate<0,this.time.interval=1e3/t,60===t&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(t){return t>1e3?t/1e3+" sec":t+" ms"}}class st{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new at(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(t){this.keyDown(t)}.bind(this),!1),document.addEventListener("keyup",function(t){this.keyUp(t)}.bind(this),!1)}setKey(t,e){this.key[t]=e}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=-1,i[0]=1;break;case 68:case 39:e[0]=1,i[1]=1;break;case 87:case 90:case 38:e[1]=-1;break;case 83:case 40:e[1]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}else switch(t.which){case 65:case 81:e[0]=-1,i[0]=1;break;case 68:e[0]=1,i[1]=1;break;case 87:case 90:e[1]=-1;break;case 83:e[1]=1;break;case 37:e[2]=-1,i[0]=1;break;case 39:e[2]=1,i[1]=1;break;case 38:e[3]=-1;break;case 40:e[3]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}this.gamepad.reset()}keyUp(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:case 39:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:case 38:e[1]=e[1]<0?0:e[1];break;case 83:case 40:e[1]=e[1]>0?0:e[1];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}else switch(t.which){case 65:case 81:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:e[1]=e[1]<0?0:e[1];break;case 83:e[1]=e[1]>0?0:e[1];break;case 37:e[2]=e[2]<0?0:e[2],i[0]=0;break;case 39:e[2]=e[2]>0?0:e[2],i[1]=0;break;case 38:e[3]=e[3]<0?0:e[3];break;case 40:e[3]=e[3]>0?0:e[3];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}}}class at{constructor(t){this.values=[],this.ready=0,this.key=t}update(){var t,e,i,s,a,r,o=this.fix,n=navigator.getGamepads();for(t=0;t<n.length;t++)if(r=n[t])if(i=r.axes.length,s=r.buttons.length){for(this.values[t]||(this.values[t]=[]),e=0;e<i;e++)a=o(r.axes[e],.08),0==this.ready&&0!==a&&(this.ready=1),this.values[t][e]=a;for(e=0;e<s;e++)a=o(r.buttons[e].value),0==this.ready&&0!==a&&(this.ready=1),this.values[t][i+e]=a}else this.values[t]&&(this.values[t]=null)}getValue(t){for(var e,i=19;i--;)e=this.values[t][i],0==this.ready&&0!==e&&(this.ready=1),this.key[i]=e}reset(){this.ready=0}fix(t,e){let i=Number(t.toString().substring(0,5));return e&&i<e&&i>-e&&(i=0),i}}class rt{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let t=this.list.length;for(;t--;)this.dispose(this.list[t]);this.list=[],this.id=0}byName(t){return this.Utils.byName(t)}setName(t={}){let e=void 0!==t.name?t.name:this.type+this.id++;return t.id=this.remove(e,!0),t.name=e,e}addToWorld(t,e=-1){this.Utils.add(t),-1!==e?this.list[e]=t:this.list.push(t)}remove(t,e){let i=this.byName(t);return i?this.clear(i,e):-1}clear(t,e){let i=this.list.indexOf(t);return-1===i||e?this.list[i]=null:this.list.splice(i,1),this.dispose(t),i}dispose(t){null!==t&&this.Utils.remove(t)}add(t={}){}set(t={}){}step(t,e){}}class ot extends rt{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="ray",this.iType="ray"}step(t,e){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=e+a*C.ray,i.update(t,s,this.motor.reflow.ray[a]||null)}add(t={}){this.setName(t);let e=new nt(t,this.motor);return e.visible=void 0===t.visible||t.visible,this.addToWorld(e,t.id),t.parent&&"string"!=typeof t.parent&&(t.parent=t.parent.name),t.callback&&delete t.callback,this.motor.post({m:"add",o:t}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.setRay(t)}}class nt extends e.Line{constructor(t={},i){super(new e.BufferGeometry,i.getMat("line")),this.motor=i,this.Utils=this.motor.utils,this.isRay=!0,this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=t.name,this.parentMesh=null,t.parent&&(this.parentMesh="string"==typeof t.parent?this.Utils.byName(t.parent):t.parent,this.data.parent=this.parentMesh),this.callback=t.callback||null,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new e.Vector3,this.end=new e.Vector3(0,1,0),this.tmp=new e.Vector3,this.vnormal=new e.Vector3,this.vv1=new e.Vector3,this.vv2=new e.Vector3,this.fullDistance=0,this.setRay(t);this.geometry.setAttribute("position",new e.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new e.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.noRotation=t.noRotation||!1,this.fakeMatrix=new e.Matrix4,this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(t){t.begin&&this.begin.fromArray(t.begin),t.end&&this.end.fromArray(t.end),this.fullDistance=this.begin.distanceTo(this.end)}update(t,e=0,i=null){if(this.data.hit=0!==t[e],this.data.body=i||"",this.data.distance=t[e+1],this.data.hit)this.local[0]=t[e+2],this.local[1]=t[e+3],this.local[2]=t[e+4],this.tmp.fromArray(t,e+5),this.vnormal.fromArray(t,e+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(A.angleTo(this.vv1.toArray(),this.data.normal)*v);else if(this.parentMesh){let t;t=this.noRotation?this.fakeMatrix.setPosition(this.parentMesh.position.x,this.parentMesh.position.y,this.parentMesh.position.z):this.parentMesh.matrixWorld,this.tmp.copy(this.begin).applyMatrix4(t).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(t),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback&&this.callback(this.data)}dispose(){this.callback=null,this.parentMesh=null,this.data={},this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let t=this.vertices.array,e=this.colors.array,i=this.local,s=this.data.hit,a=s?this.c2:this.c1,r=s?this.c3:this.c1;e[3]=a[0],e[4]=a[1],e[5]=a[2],e[6]=r[0],e[7]=r[1],e[8]=r[2],t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}class lt extends e.InstancedMesh{constructor(t,i,s=0){super(t,i,s),this.matrixAutoUpdate=!1,this.tmpMatrix=new e.Matrix4,this.tmpQuat=new e.Quaternion,this.instanceUv=null,this.instanceColor=null,this.needSphereUp=!1,this.isRay=!0,this.overMaterial=null,this.currentOver=-1,this.isOver=!1,this.outline=null,this.tmpElement=[]}clearOutLine(){this.overMaterial&&this.outline&&(this.parent.remove(this.outline),this.outline=null,this.currentOver=-1)}addOutLine(t){this.overMaterial&&(this.outline||(this.outline=new e.Mesh(this.geometry,this.overMaterial)),this.outline.matrixAutoUpdate=!1,this.tmpMatrix.fromArray(this.instanceMatrix.array,16*t.idx),this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0,this.parent.add(this.outline),this.currentOver=t.idx)}over(t){t&&!this.instance.isOver&&(this.instance.isOver=!0,this.instance.addOutLine(this)),!t&&this.instance.isOver&&(this.instance.isOver=!1,this.instance.clearOutLine())}setColorAt(t,i){null===this.instanceColor&&(this.instanceColor=new e.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3)),i.isColor&&(i=i.toArray());let s=3*t;this.instanceColor.array[s]=i[0],this.instanceColor.array[s+1]=i[1],this.instanceColor.array[s+2]=i[2]}add(t,i=[0,0,0],s=[0,0,0,1],a=[1,1,1],r=null,o=null){3===s.length&&(s=this.tmpQuat.setFromEuler({_x:s[0],_y:s[1],_z:s[2],_order:"XYZ"},!1).toArray()),r&&(r.isColor&&(r=r.toArray()),null===this.instanceColor&&(this.instanceColor=new e.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(i,s,a,r,o),this.tmpElement.push(t)}slice(t,e,i){let s=new Float32Array(i-e);for(let a=0;a<e+i;++a)s[a]=t[e+a];return s}remove(t){if(!this.count)return;this.tmpElement.splice(t,1);let i=[...this.instanceMatrix.array];i.splice(16*t,16),this.instanceMatrix=new e.InstancedBufferAttribute(new Float32Array(i),16),null!==this.instanceColor&&(i=[...this.instanceColor.array],i.splice(3*t,3),this.instanceColor=new e.InstancedBufferAttribute(new Float32Array(i),3)),null!==this.instanceUv&&(i=[...this.instanceUv.array],i.splice(2*t,2),this.instanceUv=new e.InstancedBufferAttribute(new Float32Array(i),2)),this.count--,this.reDistribute()}reDistribute(){let t=this.count;for(;t--;)this.tmpElement[t].idx=t}getIDName(t){return this.tmpElement[t].name}getBodyList(){let t=[],e=this.count;for(;e--;)t.push(this.tmpElement[e].name);return t}expand(t,i,s,a=[1,1,1],r){let o=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:i[0],_y:i[1],_z:i[2],_w:i[3]},{x:s[0],y:s[1],z:s[2]}),this.instanceMatrix=new e.InstancedBufferAttribute(new Float32Array([...o,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(o=this.instanceColor.array,this.instanceColor=new e.InstancedBufferAttribute(new Float32Array([...o,...a]),3)),this.count++}setTransformAt(t,e,i,s){this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:i[0],_y:i[1],_z:i[2],_w:i[3]},{x:s[0],y:s[1],z:s[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*t),this.needSphereUp=!0,this.outline&&this.currentOver===t&&(this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0)}dispose(){this.clearOutLine(),this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.tmpElement=[],this.dispatchEvent({type:"dispose"})}setRaycast(t){void 0!==t&&(this.isRay=t)}raycast(t,e){this.isRay&&(this.instanceMatrix.needsUpdate=!0,super.raycast(t,e))}update(){this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp&&this.computeBoundingSphere(),this.needSphereUp=!1,this.updateMatrix()}}class ht{constructor(t=0,e=0,i=0,s=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=s}set(t,e,i,s){return this._x=t,this._y=e,this._z=i,this._w=s,this}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}}class ct extends e.Object3D{constructor(t,i,s,a,r=[0,1,0],o=[0,.5,0],n=!1){if(super(),!t)return;if(!i)return;const l=new e.BufferGeometry;let h=.5*i-t,c=12,d=.2*t,u=[];const p=[t,h,0,t,-h,0,-t,h,0,-t,-h,0,0,h,t-d,0,h,t+d];u.push(...r,...o,...r,...o,...o,...o),n&&(p.push(0,h,t,0,-h,t,0,h,-t,0,-h,-t),u.push(...r,...o,...r,...o));for(let e=0,i=1;e<c;e++,i++){const s=e/c*Math.PI*2,a=i/c*Math.PI*2;p.push(t*Math.cos(s),h,t*Math.sin(s),t*Math.cos(a),h,t*Math.sin(a),t*Math.cos(s),-h,t*Math.sin(s),t*Math.cos(a),-h,t*Math.sin(a)),u.push(...r,...r,...o,...o)}for(let e=0,i=1;e<c;e++,i++){const s=e/c*Math.PI*2,a=i/c*Math.PI*2;let l=i<=6?1:-1;p.push(t*Math.cos(s),h*l+t*Math.sin(s),0,t*Math.cos(a),h*l+t*Math.sin(a),0),1===l?u.push(...r,...r):u.push(...o,...o),n&&(p.push(0,h*l+t*Math.sin(s),t*Math.cos(s),0,h*l+t*Math.sin(a),t*Math.cos(a)),1===l?u.push(...r,...r):u.push(...o,...o))}if(l.setAttribute("position",new e.Float32BufferAttribute(p,3)),l.setAttribute("color",new e.Float32BufferAttribute(u,3)),l.computeBoundingSphere(),this.colors=l.attributes.color.array,this.colorsbase=[...this.colors],this.geometry=l,this.cone=new e.LineSegments(l,a),this.cone.raycast=function(){return!1},this.cone.updateMorphTargets=()=>{},this.cone.name="cone",this.add(this.cone),this.isOver=!1,this.matrixAutoUpdate=!1,this.type="CapsuleHelper",!s)return;const m=new e.BufferGeometry,f=[.5*d,-h,t-d,.5*d,-h,t+d,.5*-d,-h,t-d,.5*-d,-h,t+d,.5*d,-h,t-d,.5*-d,-h,t-d,.5*-d,-h,t+d,-d,-h,t+d,.5*d,-h,t+d,d,-h,t+d,-d,-h,t+d,0,-h,t+2*d,d,-h,t+d,0,-h,t+2*d];u=[];let b=f.length/3;for(;b--;)u.push(1,0,0);m.setAttribute("position",new e.Float32BufferAttribute(f,3)),m.setAttribute("color",new e.Float32BufferAttribute(u,3)),this.direction=new e.LineSegments(m,a),this.direction.raycast=function(){return!1},this.add(this.direction)}over(t){t?this.isOver||(this.isOver=!0,this.changeColor(this.isOver)):this.isOver&&(this.isOver=!1,this.changeColor(this.isOver))}changeColor(t){let e=this.colors.length;for(;e--;)this.colors[e]=t?1:this.colorsbase[e];this.geometry&&(this.geometry.attributes.color.needsUpdate=!0)}setDirection(t){this.direction&&(this.direction.rotation.y=t)}dispose(){this.geometry.dispose(),this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){return!1}update(){}}const dt=new e.Vector3,ut=new e.Line3,pt=new e.Plane,mt=new e.Vector3,ft=new e.Triangle;class bt{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new vt,this.unassigned=new vt,this.vertices=[]}setFromPoints(t){if(t.length>=4){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.vertices.push(new xt(t[e]));this._compute()}return this}setFromObject(t){const i=[];return t.updateMatrixWorld(!0),t.traverse((function(t){const s=t.geometry;if(void 0!==s){const a=s.attributes.position;if(void 0!==a)for(let s=0,r=a.count;s<r;s++){const r=new e.Vector3;r.fromBufferAttribute(a,s).applyMatrix4(t.matrixWorld),i.push(r)}}})),this.setFromPoints(i)}containsPoint(t){const e=this.faces;for(let i=0,s=e.length;i<s;i++){if(e[i].distanceToPoint(t)>this.tolerance)return!1}return!0}intersectRay(t,e){const i=this.faces;let s=-1/0,a=1/0;for(let e=0,r=i.length;e<r;e++){const r=i[e],o=r.distanceToPoint(t.origin),n=r.normal.dot(t.direction);if(o>0&&n>=0)return null;const l=0!==n?-o/n:0;if(!(l<=0)&&(n>0?a=Math.min(l,a):s=Math.max(l,s),s>a))return null}return s!==-1/0?t.at(s,e):t.at(a,e),e}intersectsRay(t){return null!==this.intersectRay(t,dt)}makeEmpty(){return this.faces=[],this.vertices=[],this}_addVertexToFace(t,e){return t.face=e,null===e.outside?this.assigned.append(t):this.assigned.insertBefore(e.outside,t),e.outside=t,this}_removeVertexFromFace(t,e){return t===e.outside&&(null!==t.next&&t.next.face===e?e.outside=t.next:e.outside=null),this.assigned.remove(t),this}_removeAllVerticesFromFace(t){if(null!==t.outside){const e=t.outside;let i=t.outside;for(;null!==i.next&&i.next.face===t;)i=i.next;return this.assigned.removeSubList(e,i),e.prev=i.next=null,t.outside=null,e}}_deleteFaceVertices(t,e){const i=this._removeAllVerticesFromFace(t);if(void 0!==i)if(void 0===e)this.unassigned.appendChain(i);else{let t=i;do{const i=t.next;e.distanceToPoint(t.point)>this.tolerance?this._addVertexToFace(t,e):this.unassigned.append(t),t=i}while(null!==t)}return this}_resolveUnassignedPoints(t){if(!1===this.unassigned.isEmpty()){let e=this.unassigned.first();do{const i=e.next;let s=this.tolerance,a=null;for(let i=0;i<t.length;i++){const r=t[i];if(0===r.mark){const t=r.distanceToPoint(e.point);if(t>s&&(s=t,a=r),s>1e3*this.tolerance)break}}null!==a&&this._addVertexToFace(e,a),e=i}while(null!==e)}return this}_computeExtremes(){const t=new e.Vector3,i=new e.Vector3,s=[],a=[];for(let t=0;t<3;t++)s[t]=a[t]=this.vertices[0];t.copy(this.vertices[0].point),i.copy(this.vertices[0].point);for(let e=0,r=this.vertices.length;e<r;e++){const r=this.vertices[e],o=r.point;for(let e=0;e<3;e++)o.getComponent(e)<t.getComponent(e)&&(t.setComponent(e,o.getComponent(e)),s[e]=r);for(let t=0;t<3;t++)o.getComponent(t)>i.getComponent(t)&&(i.setComponent(t,o.getComponent(t)),a[t]=r)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(t.x),Math.abs(i.x))+Math.max(Math.abs(t.y),Math.abs(i.y))+Math.max(Math.abs(t.z),Math.abs(i.z))),{min:s,max:a}}_computeInitialHull(){const t=this.vertices,e=this._computeExtremes(),i=e.min,s=e.max;let a=0,r=0;for(let t=0;t<3;t++){const e=s[t].point.getComponent(t)-i[t].point.getComponent(t);e>a&&(a=e,r=t)}const o=i[r],n=s[r];let l,h;a=0,ut.set(o.point,n.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==o&&i!==n){ut.closestPointToPoint(i.point,!0,mt);const t=mt.distanceToSquared(i.point);t>a&&(a=t,l=i)}}a=-1,pt.setFromCoplanarPoints(o.point,n.point,l.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==o&&i!==n&&i!==l){const t=Math.abs(pt.distanceToPoint(i.point));t>a&&(a=t,h=i)}}const c=[];if(pt.distanceToPoint(h.point)<0){c.push(gt.create(o,n,l),gt.create(h,n,o),gt.create(h,l,n),gt.create(h,o,l));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge(e)),c[t+1].getEdge(1).setTwin(c[e+1].getEdge(0))}}else{c.push(gt.create(o,l,n),gt.create(h,o,n),gt.create(h,n,l),gt.create(h,l,o));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge((3-t)%3)),c[t+1].getEdge(0).setTwin(c[e+1].getEdge(1))}}for(let t=0;t<4;t++)this.faces.push(c[t]);for(let e=0,i=t.length;e<i;e++){const i=t[e];if(i!==o&&i!==n&&i!==l&&i!==h){a=this.tolerance;let t=null;for(let e=0;e<4;e++){const s=this.faces[e].distanceToPoint(i.point);s>a&&(a=s,t=this.faces[e])}null!==t&&this._addVertexToFace(i,t)}}return this}_reindexFaces(){const t=[];for(let e=0;e<this.faces.length;e++){const i=this.faces[e];0===i.mark&&t.push(i)}return this.faces=t,this}_nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let t,e=0;const i=this.assigned.first().face;let s=i.outside;do{const a=i.distanceToPoint(s.point);a>e&&(e=a,t=s),s=s.next}while(null!==s&&s.face===i);return t}}_computeHorizon(t,e,i,s){let a;this._deleteFaceVertices(i),i.mark=1,a=null===e?e=i.getEdge(0):e.next;do{const e=a.twin,i=e.face;0===i.mark&&(i.distanceToPoint(t)>this.tolerance?this._computeHorizon(t,e,i,s):s.push(a)),a=a.next}while(a!==e);return this}_addAdjoiningFace(t,e){const i=gt.create(t,e.tail(),e.head());return this.faces.push(i),i.getEdge(-1).setTwin(e.twin),i.getEdge(0)}_addNewFaces(t,e){this.newFaces=[];let i=null,s=null;for(let a=0;a<e.length;a++){const r=e[a],o=this._addAdjoiningFace(t,r);null===i?i=o:o.next.setTwin(s),this.newFaces.push(o.face),s=o}return i.next.setTwin(s),this}_addVertexToHull(t){const e=[];return this.unassigned.clear(),this._removeVertexFromFace(t,t.face),this._computeHorizon(t.point,null,t.face,e),this._addNewFaces(t,e),this._resolveUnassignedPoints(this.newFaces),this}_cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}_compute(){let t;for(this._computeInitialHull();void 0!==(t=this._nextVertexToAdd());)this._addVertexToHull(t);return this._reindexFaces(),this._cleanup(),this}}class gt{constructor(){this.normal=new e.Vector3,this.midpoint=new e.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(t,e,i){const s=new gt,a=new yt(t,s),r=new yt(e,s),o=new yt(i,s);return a.next=o.prev=r,r.next=a.prev=o,o.next=r.prev=a,s.edge=a,s.compute()}getEdge(t){let e=this.edge;for(;t>0;)e=e.next,t--;for(;t<0;)e=e.prev,t++;return e}compute(){const t=this.edge.tail(),e=this.edge.head(),i=this.edge.next.head();return ft.set(t.point,e.point,i.point),ft.getNormal(this.normal),ft.getMidpoint(this.midpoint),this.area=ft.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(t){return this.normal.dot(t)-this.constant}}class yt{constructor(t,e){this.vertex=t,this.prev=null,this.next=null,this.twin=null,this.face=e}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceTo(t.point):-1}lengthSquared(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(t.point):-1}setTwin(t){return this.twin=t,t.twin=this,this}}class xt{constructor(t){this.point=t,this.prev=null,this.next=null,this.face=null}}class vt{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(t,e){return e.prev=t.prev,e.next=t,null===e.prev?this.head=e:e.prev.next=e,t.prev=e,this}insertAfter(t,e){return e.prev=t,e.next=t.next,null===e.next?this.tail=e:e.next.prev=e,t.next=e,this}append(t){return null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail,t.next=null,this.tail=t,this}appendChain(t){for(null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail;null!==t.next;)t=t.next;return this.tail=t,this}remove(t){return null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,this}removeSubList(t,e){return null===t.prev?this.head=e.next:t.prev.next=e.next,null===e.next?this.tail=t.prev:e.next.prev=t.prev,this}isEmpty(){return null===this.head}}class wt extends e.BufferGeometry{constructor(t=[]){super();const i=[],s=[],a=(new bt).setFromPoints(t).faces;for(let t=0;t<a.length;t++){const e=a[t];let r=e.edge;do{const t=r.head().point;i.push(t.x,t.y,t.z),s.push(e.normal.x,e.normal.y,e.normal.z),r=r.next}while(r!==e.edge)}this.setAttribute("position",new e.Float32BufferAttribute(i,3)),this.setAttribute("normal",new e.Float32BufferAttribute(s,3))}}let Mt=null,kt=null;const At=new e.Vector3(0,1,0),St=new e.Vector3(1,0,0),Tt=new e.Vector3(0,0,1);class Pt extends rt{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,Mt=this.motor.geo,kt=this.motor.mat,this.type="body",this.num=C[this.type],this.full=!1,this.needMatrix="RAPIER"===this.engine||"HAVOK"===this.engine}setFull(t){this.num=C[t?"bodyFull":"body"],this.full=t}step(t,e){const i=this.list;let s,a,r,o=i.length;for(;o--;)if(s=i[o],null!==s)if(a=e+o*this.num,s.actif){if(s.sleep=!(t[a]>0),s.defMat&&(s.isInstance?s.instance.setColorAt(s.idx,s.sleep?$.sleep:$.body):(s.sleep||"sleep"!==s.material.name||(s.material=kt.get("body")),s.sleep&&"body"===s.material.name&&(s.material=kt.get("sleep")))),!s.sleep||s.isKinematic)if(s.position.fromArray(t,a+1),s.quaternion.fromArray(t,a+4),1!==this.motor.ws&&s.position.multiplyScalar(this.motor.uws),this.full?(s.velocity.fromArray(t,a+8),s.angular.fromArray(t,a+11)):s.getVelocity&&(r=this.motor.reflow.velocity[s.name],r&&(s.velocity.fromArray(r,0),s.angular.fromArray(r,3))),s.isInstance){if(s.speedMat){let e=.01*t[a];s.instance.setColorAt(s.idx,[e,e,e])}s.instance.setTransformAt(s.idx,s.position.toArray(),s.quaternion.toArray(),s.noScale?[1,1,1]:s.size),this.needMatrix&&s.matrixWorld.compose(s.position,s.quaternion,{x:1,y:1,z:1})}else s.auto||s.updateMatrix()}else s.actif=!0}geometry(t={},i=null,s=null){let a,r,o,n=t.size,l="",h=t.type,c=!1,d=!1,u=t.seg||16;const p="OIMO"===this.engine||"JOLT"===this.engine||"AMMO"===this.engine||"CANNON"===this.engine;if(t.instance&&"compound"===h&&(h=t.shapes[0].type,n=t.shapes[0].size,t.translate=t.shapes[0].pos),"mesh"!==h&&"convex"!==h||(t.shape?t.shape.isMesh&&(t.shape=t.shape.geometry):t.mesh&&!t.v&&(t.shape=t.mesh.geometry)),t.radius&&("box"===h&&(h="ChamferBox"),"cylinder"===h&&(h="ChamferCyl")),t.geometry&&("convex"===h?t.shape=t.geometry:h="direct"),"PHYSX"===this.engine&&"cylinder"===t.type){let i=new e.CylinderGeometry(t.size[0],t.size[0],t.size[1],u,1);t.isWheel&&i.rotateZ(-M),t.v=A.getVertex(i),t.type="convex"}if(("PHYSX"===this.engine||"HAVOK"===this.engine||"JOLT"===this.engine)&&"cone"===t.type){let i=new e.CylinderGeometry(0,t.size[0],t.size[1],u,1);t.v=A.getVertex(i),t.type="convex"}switch("stair"===t.type&&(t.type="box",h="box"),h){case"direct":a=t.geometry.clone(),t.size&&a.scale(t.size[0],t.size[1],t.size[2]),d=!0,c=!0;break;case"convex":if(t.v){if(t.nogeo)a=new e.BufferGeometry;else{let i=[];for(r=Math.floor(t.v.length/3);r--;)o=3*r,i.push(new e.Vector3(t.v[o],t.v[o+1],t.v[o+2]));a=new wt(i)}d=!0,c=!0}if(t.shape){a=t.shape.clone(),t.size&&a.scale(t.size[0],t.size[0],t.size[0]),t.shapeScale&&a.scale(t.shapeScale[0],t.shapeScale[1],t.shapeScale[2]);let e=p?A.toNonIndexed(a):null;t.v=A.getVertex(e||a,p),t.index=A.getIndex(e||a,p),this.engine,d=!0,c=!0}a.boundingBox||a.computeBoundingBox();let i=a.boundingBox;t.boxSize=[-i.min.x+i.max.x,-i.min.y+i.max.y,-i.min.z+i.max.z];break;case"mesh":if(a=t.shape.clone(),t.size&&a.scale(t.size[0],t.size[0],t.size[0]),t.v=A.getVertex(a,p),t.index=A.getIndex(a,p),"PHYSX"===this.engine){let i=new e.Vector3;A.getCenter(a,i),t.massCenter||(t.massCenter=i.toArray())}d=!0,c=!0;break;case"customSphere":l="customSphere_"+n[0],a=Mt.get(l),a?l="":(a=new e.SphereGeometry(n[0],t.seg1||32,t.seg2||16),a.name=l),c=!0,t.type="sphere";break;case"capsule":l="capsule_"+n[0]+"_"+n[1]+"_"+u,a=Mt.get(l),a?l="":(a=new O(n[0],n[1],u),a.name=l),c=!0;break;case"ChamferBox":l="ChamferBox_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+t.radius,a=Mt.get(l),a?l="":(a=new U(n[0],n[1],n[2],t.radius),a.name=l),c=!0;break;case"ChamferCyl":l="ChamferCyl_"+n[0]+"_"+n[1]+"_"+n[2]+"_"+t.radius+"_"+u,a=Mt.get(l),a?l="":(a=new G(n[0],n[0],n[1],t.radius,u),a.name=l),c=!0;break;default:t.breakable?(a=Mt.get(h).clone(),a.scale(n[0],n[1],n[2]),d=!0,c=!0):a=Mt.get(h),"highSphere"===h&&(t.type="sphere")}if(t.translate&&a.translate(t.translate[0],t.translate[1],t.translate[2]),t.shape&&delete t.shape,t.geometry&&delete t.geometry,(void 0===a.attributes.uv||t.autoUV)&&H(a,"box",5,t.pos,t.quat),""!==l&&Mt.set(a),t.isWheel&&(a=a.clone(),a.rotateZ(-M),d=!0),d&&Mt.unic(a),null===i&&null===s)return a.noScale=c,a;t.meshRemplace&&t.debug&&(s=kt.get("debug"));let m=new e.Mesh(a,s);if(t.button&&(m.isButton=!0),t.helper){let e=t.hcolor||[.3,.1,0],i=t.hcolor2||[.8,.2,0],s=new ct(n[0],n[1]+2*n[0],!1,kt.get("liner"),e,i,!0);m.add(s),m.userData.helper=s}t.localRot&&(t.localQuat=A.quatFromEuler(t.localRot)),t.localPos&&m.position.fromArray(t.localPos),t.localQuat&&m.quaternion.fromArray(t.localQuat),c||m.scale.fromArray(t.size),void 0!==t.ray&&(t.ray||(m.raycast=()=>{})),t.meshRemplace&&!t.debug||(i.add(m),m.userData.helper&&(i.over=t=>{m.userData.helper.over(t)}))}add(t={}){t.worldScale&&delete(t=this.scaler(t,t.worldScale)).worldScale;let i,s,a,r=0;if(t.instance||(a=this.setName(t)),t.type=void 0===t.type?"box":t.type,"plane"!==t.type||t.visible||(t.visible=!1),"stair"===t.type){let i=new e.Vector3(0,0,t.size[2]),s=new e.Vector3(0,.5*t.size[1],.5*t.size[2]),a=i.angleTo(s),r=i.distanceTo(s);t.rot=[a*v,0,0],t.size[1]*=t.div||.2,t.size[2]=2*r;let o=new e.Vector3(0,.5*-t.size[1],0);o.applyAxisAngle({x:1,y:0,z:0},a),t.pos[1]+=o.y,t.pos[2]+=o.z}if(t.massCenter&&-1===S.indexOf(this.engine))if("compound"!==t.type)t.shapes=[{type:t.type,pos:t.massCenter,size:t.size}],t.seg&&(t.shapes[0].seg=t.seg),t.radius&&(t.shapes[0].radius=t.radius),delete t.size,t.type="compound";else for(i=0;i<t.shapes.length;i++)s=t.shapes[i],s.pos?s.pos=A.addArray(s.pos,t.massCenter):s.pos=t.massCenter;void 0!==t.collision&&!1===t.collision&&("PHYSX"===this.engine&&(t.flags=0),"OIMO"===this.engine&&(t.mask=0)),t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=A.quatFromEuler(t.rot)),void 0!==t.meshRot&&(t.meshQuat=A.quatFromEuler(t.meshRot)),t.size=A.autoSize(t.size,t.type),t.meshScale&&(t.meshScale=A.autoSize(t.meshScale));let o,n=!1;!1===t.visible&&(t.material="hide"),void 0!==t.material?o=t.material.constructor===String?kt.get(t.material):t.material:(n=!0,o=kt.get(this.type),t.instance&&"solid"!==this.type&&(o=kt.get("base"))),t.unicMat&&(o=o.clone(),kt.addToTmp(o));let l=t.instance?{}:new e.Object3D;if(t.mesh&&!t.instance){"terrain"===t.mesh.type&&(t.noClone=!0);let e=t.noClone?t.mesh:t.mesh.clone();if(e.position.fromArray(t.meshPos||[0,0,0]),t.meshQuat&&e.quaternion.fromArray(t.meshQuat),t.meshSize&&e.scale.set(1,1,1).multiplyScalar(t.meshSize),t.meshScale&&e.scale.fromArray(t.meshScale),!n&&(e.material=o,e.children&&!t.nofullmat))for(let t in e.children)e.children[t].material=o;this.motor.tmpMesh.push(e),t.meshRemplace=!0,l.add(e)}switch(t.type){case"null":break;case"compound":for(i=0;i<t.shapes.length;i++)s=t.shapes[i],s.type=void 0===s.type?"box":s.type,s.size=A.autoSize(s.size,s.type),s.pos&&(s.localPos=s.pos),void 0!==s.rot&&(s.quat=A.quatFromEuler(s.rot)),s.quat&&(s.localQuat=s.quat),s.debug=t.debug,s.meshRemplace=t.meshRemplace||!1,t.instance?"convex"===s.type&&(s.v=A.getVertex(s.shape,!1)):this.geometry(s,l,o),r+=A.getVolume(s.type,s.size,s.v);break;default:t.instance?"convex"===t.type&&(t.v=A.getVertex(t.shape,!1)):this.geometry(t,l,o),r=A.getVolume(t.type,t.size,t.v)}if(l.type=this.type,l.size=t.size,l.shapetype=t.type,l.isKinematic=t.kinematic||!1,l.link=0,l.meshSize=t.meshSize?t.meshSize:1,l.velocity=new e.Vector3,l.angular=new e.Vector3,l.sleep=t.sleep||!1,l.defMat=!1,t.button&&(l.isButton=!0),l.isRay=void 0===t.ray||t.ray,l.material&&n&&(l.defMat="body"===l.material.name),t.instance){l.isInstance=!0,l.instance=this.getInstance(t,o),l.instance.isRay=l.isRay,l.over=l.instance.over,l.isRay=!1,l.isOver=!1,l.speedMat=t.speedMat||!1,l.defMat="base"===l.instance.material.name,l.idx=l.instance.count,l.name=t.name?t.name:l.instance.name+l.idx,t.name=l.name,l.noScale=l.instance.noScale,t.sizeByInstance&&(l.noScale=!1);let i=t.color;l.defMat&&(i=t.sleep?$.sleep:$.body),l.instance.add(l,t.pos,t.quat,l.noScale?[1,1,1]:l.size,i),l.position=(new e.Vector3).fromArray(t.pos),l.quaternion=(new ht).fromArray(t.quat),this.needMatrix&&(l.matrixWorld=new e.Matrix4),l.instance.v&&(t.v=l.instance.v),l.instance.index&&(t.index=l.instance.index),t.type=l.instance.type,l.actif=!1}else l.name=a,l.isRay||l.traverse((function(t){t.isObject3D&&(t.raycast=()=>{})})),t.renderOrder&&(l.renderOrder=t.renderOrder),void 0===t.visible&&(t.visible=!0),void 0===t.shadow&&(t.shadow=t.visible),l.dispose=function(){this.clearOutLine&&this.clearOutLine(),this.traverse((function(t){t.isMesh&&t.unic&&t.geometry.dispose()})),this.children=[]}.bind(l),l.visible=void 0===t.visible||t.visible,Object.defineProperty(l,"material",{get(){return this.children[0]?this.children[0].material:null},set(t){this.traverse((function(e){e.isMesh&&"outline"!==e.name&&(e.material=t)}))}}),Object.defineProperty(l,"castShadow",{get(){return!!this.children[0]&&this.children[0].castShadow},set(t){this.traverse((function(e){e.isMesh&&(e.castShadow=t)}))}}),Object.defineProperty(l,"receiveShadow",{get(){return!!this.children[0]&&this.children[0].receiveShadow},set(t){this.traverse((function(e){e.isMesh&&(e.receiveShadow=t)}))}}),l.receiveShadow=t.shadow,l.castShadow=t.shadow,this.motor.mouseActive&&(l.overMaterial=kt.get("outline"),l.isOver=!1,l.addOutLine=function(){this.children[0].isMesh&&(this.outline=(new e.Mesh).copy(this.children[0]),this.outline.name="outline",this.outline.material=this.overMaterial,this.outline.matrixAutoUpdate=!1,this.outline.receiveShadow=!1,this.outline.castShadow=!1,this.outline.raycast=()=>!1,this.add(this.outline))}.bind(l),l.clearOutLine=function(){this.outline&&(this.remove(this.outline),this.outline=null)}.bind(l),l.over=function(t){t&&!this.isOver&&this.addOutLine(),!t&&this.isOver&&this.clearOutLine(),this.isOver=t}.bind(l),l.select=function(t){}.bind(l)),this.set(t,l);if(t.breakable){let i=l,s=i.children[0];i.remove(s),l=s,l.position.copy(i.position),l.quaternion.copy(i.quaternion),l.name=a,l.type=this.type,l.breakable=!0,l.breakOption=void 0!==t.breakOption?t.breakOption:[250,1,2,1],l.ignore=t.ignore||[],l.size=t.size,l.shapetype=t.type,l.isKinematic=t.kinematic||!1,l.link=0,l.meshSize=t.meshSize?t.meshSize:1,l.velocity=new e.Vector3,l.angular=new e.Vector3,l.sleep=t.sleep||!1,l.defMat=!1,l.auto=t.auto||!1,l.auto?l.matrixAutoUpdate=!0:(l.matrixAutoUpdate=!1,l.updateMatrix())}if(l.mass=t.mass||0,l.density=t.density||0,l.density&&!l.mass?l.mass=A.massFromDensity(l.density,r):l.mass&&!l.density&&(l.density=A.densityFromMass(l.mass,r),"RAPIER"!==this.engine&&"OIMO"!==this.engine&&"PHYSX"!==this.engine||(t.density=l.density)),t.massInfo&&console.log("%c"+l.name+" %cdensity:"+l.density+" mass:"+l.mass,"font-size:16px","font-size:12px"),t.getVelocity&&(l.getVelocity=!0),this.addToWorld(l,t.id),t.onlyMakeMesh)return l;if(t.phySize&&(t.size=t.phySize),t.phyPos&&(t.pos=t.phyPos),t.rot&&delete t.rot,t.mesh&&delete t.mesh,t.meshRot&&delete t.meshRot,t.instance&&delete t.instance,t.material&&delete t.material,t.parent&&delete t.parent,t.solver&&"PHYSX"===this.engine){t.mass=l.mass;this.byName(t.solver).addBone(t.name)}if(t.sleep&&this.set(t,l),this.motor.post({m:"add",o:t}),t.breakable){this.motor.getBreaker().add(l)}return l}dispatchEvent(t,e,i){this.byName(t).dispatchEvent({type:e,data:i})}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(void 0!==t.getVelocity&&(e.getVelocity=t.getVelocity),e.isInstance?(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),(t.pos||t.quat)&&e.instance.setTransformAt(e.idx,e.position.toArray(),e.quaternion.toArray(),e.noScale?[1,1,1]:e.size)):(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),e.auto=t.auto||!1,e.auto?e.matrixAutoUpdate=!0:(e.matrixAutoUpdate=!1,e.updateMatrix())))}getTransform(t){if("string"==typeof t&&(t=this.byName(o.name)),null===t)return;t.updateWorldMatrix(!0,!1);const e=t.matrixWorld.elements;return{position:t.position.clone(),up:At.clone().set(e[4],e[5],e[6]).normalize(),right:St.clone().set(e[0],e[1],e[2]).normalize(),forward:Tt.clone().set(e[8],e[9],e[10]).normalize()}}clearInstance(t){let e=this.motor.instanceMesh[t],i=e.getBodyList();this.motor.remove(i),e.dispose(),delete this.motor.instanceMesh[t]}getInstance(t,e){if(this.motor.instanceMesh[t.instance])return this.motor.instanceMesh[t.instance];(t={...t}).sizeByInstance&&(t.size=[1,1,1]);let i=this.geometry(t);t.mesh&&(!t.material&&t.mesh.material&&(e=t.mesh.material),i=t.mesh.isObject3D?t.mesh.geometry.clone():t.mesh.clone(),t.meshSize&&i.scale(t.meshSize,t.meshSize,t.meshSize),t.meshScale&&i.scale(t.meshScale[0],t.meshScale[1],t.meshScale[2]),i.noScale=!0);let s=new lt(i,e,0);return s.type=t.type,s.noScale=i.noScale,"convex"===s.type&&(s.v=t.v),t.index&&(s.index=t.index),s.receiveShadow=void 0===t.shadow||t.shadow,s.castShadow=void 0===t.shadow||t.shadow,this.motor.mouseActive&&(s.overMaterial=kt.get("outline")),s.name=t.instance,this.motor.scene.add(s),this.motor.instanceMesh[t.instance]=s,s}scaler(t,e){if(t.size&&(t.size=math.worldscale(t.size,e)),t.pos&&(t.pos=math.worldscale(t.pos,e)),"convex"===t.type&&(t.shapeScale=[e,e,e]),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(i.size=math.scaleArray(i.size,e)),i.pos&&(i.pos=math.scaleArray(i.pos,e)),"convex"===i.type&&(i.shapeScale=[e,e,e])}return t.mesh&&(t.meshScale=[e,e,e]),t}}class zt extends e.Mesh{constructor(t,i={},a=null){if(super(),this.model=t,this.material=a,this.outMaterial=!!a,this.XML=new XMLSerializer,this.color=new e.Color,this.opacity=1,this.svgLoader=new s.SVGLoader,this.base="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.base,"svg"),this.layerUp=1e-4,this.fill=!0,this.stroke=!0,this.size=i.size||1,this.scaler=1/this.size,!this.model)return;let r={radius:5,min:90,max:90,strokeSize:.25,...i};switch(this.model){case"angle":this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke;let t=Math.abs(r.min);this.add("path",{d:this.circle(0,0,r.radius,180,180+r.max,!0),stroke:"none",fill:"#FF0000","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,r.radius,180,180+r.max,!1,!1,.3),stroke:"#FF0000","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"round"}),this.add("path",{d:this.circle(0,0,r.radius,180-t,180,!0),stroke:"none",fill:"#0050FF","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,r.radius,180-t,180,!1,!1,.3,!0),stroke:"#0050FF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"round"});break;case"liner":let e=.5*r.radius,i=r.max*this.scaler,s=r.min*this.scaler;this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke,this.add("path",{d:this.segment({x:-e,y:0},{x:e,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:i},{x:e,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:s},{x:e,y:s}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:s}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"});break;case"needle":this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:4.4}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"round"});break;case"middle":let a=.5*r.radius;this.fill=void 0===r.fill||r.fill,this.stroke=void 0===r.stroke||r.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:-a},{x:0,y:a}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-a,y:0},{x:a,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":r.strokeSize,fill:"none","stroke-linecap":"butt"})}this.toMesh()}raycast(){return!1}update(t={}){let e={};if("angle"===this.model){e={radius:5,min:-90,max:90,...t};let i=Math.abs(e.min);this.change("d",this.circle(0,0,e.radius,180,180+e.max,!0),0),this.change("d",this.circle(0,0,e.radius,180,180+e.max,!1,!1,.3),1),this.change("d",this.circle(0,0,e.radius,180-i,180,!0),2),this.change("d",this.circle(0,0,e.radius,180-i,180,!1,!1,.3,!0),3)}void 0!==t.wireframe&&(this.material.wireframe=t.wireframe),this.fill=void 0===e.fill||e.fill,this.stroke=void 0===e.stroke||e.stroke,this.toMesh()}set(t={},e){for(let i in t)e?e.setAttributeNS(null,i,t[i]):this.svg.setAttributeNS(null,i,t[i])}add(t,e={}){let i=document.createElementNS(this.base,t);this.set(e,i),this.svg.appendChild(i)}change(t,e,i){this.svg.childNodes[i].setAttributeNS(null,t,e)}getString(){return this.XML.serializeToString(this.svg)}polarToCartesian(t,e,i,s){var a=(s-90)*Math.PI/180;return{x:t+i*Math.cos(a),y:e+i*Math.sin(a)}}circle(t,e,i,s=0,a=360,r=!1,o=!1,n=0,l=!1){0===s&&360===a&&(s=1e-4,o=!0);let h=this.polarToCartesian(t,e,i,a),c=this.polarToCartesian(t,e,i,s),d=a-s<=180?"0":"1",u=["M",h.x,h.y,"A",i,i,0,d,0,c.x,c.y];if(r&&u.push("L",t,e,"L",h.x,h.y),o&&u.push("Z"),0!==n){let r=this.polarToCartesian(t,e,i-n,l?s:a),o=this.polarToCartesian(t,e,i+n,l?s:a);u.push("M",r.x,r.y,"L",o.x,o.y)}return u.join(" ")}segment(t,e){return["M",t.x,t.y,"L",e.x,e.y].join(" ")}geomColor(t,i,s=1){let a=t.attributes.position.count,r=[];for(;a--;)r.push(i.r,i.g,i.b,s);t.setAttribute("color",new e.Float32BufferAttribute(r,4))}toGeometry(){if(!this.fill&&!this.stroke)return null;let t=[],i=0,a=1,r=this.svgLoader.parse(this.getString());for(const o of r.paths){const r=o.userData.style.fill;if(this.fill&&void 0!==r&&"none"!==r){this.color.setStyle(r),a=o.userData.style.fillOpacity,a<this.opacity&&(this.opacity=a);const n=s.SVGLoader.createShapes(o);for(const s of n){const r=new e.ShapeGeometry(s);if(r){this.geomColor(r,this.color,a);let s=(new e.BufferGeometry).copy(r).toNonIndexed();s.translate(0,0,-i*this.layerUp),t.push(s),i++}}}const n=o.userData.style.stroke;if(this.stroke&&void 0!==n&&"none"!==n){this.color.setStyle(n),a=o.userData.style.strokeOpacity,a<this.opacity&&(this.opacity=a);for(const e of o.subPaths){const r=s.SVGLoader.pointsToStroke(e.getPoints(),o.userData.style,6);r&&(this.geomColor(r,this.color,a),r.translate(0,0,-i*this.layerUp),t.push(r),i++)}}}return t}toMesh(){let t=this.size;this.geometry&&this.geometry.dispose();let s=this.toGeometry();s?(this.geometry=i.mergeGeometries(s),this.geometry.scale(t,-t,t),this.geometry.rotateY(Math.PI),this.geometry.rotateZ(.5*-Math.PI),this.geometry.rotateY(.5*Math.PI),this.geometry.computeBoundingSphere()):this.geometry=new e.BufferGeometry,null===this.material&&(this.material=new e.MeshBasicMaterial({vertexColors:!0,transparent:1!==this.opacity,side:e.DoubleSide}),this.material.defines={USE_COLOR_ALPHA:""})}dispose(){this.material&&!this.outMaterial&&this.material.dispose(),this.geometry&&this.geometry.dispose()}}class Rt extends e.Object3D{constructor(t={},i){super(),this.motor=i,this.isJoint=!0,this.type="joint",this.mode=t.mode||"hinge",this.visible=void 0!==t.visible&&t.visible,this.mtx=new e.Matrix4,this.size=t.helperSize||.1,this.matrixAutoUpdate=!1;let s,a,r=this.motor.mat.get("line");switch(this.mode){case"prismatic":s=this.motor.mat.get("svg"),a={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},t.lm&&(a.min=t.lm[0],a.max=t.lm[1]),this.m1=new zt("liner",a,s),this.m2=new zt("middle",a,s),this.m1.geometry.rotateY(90*A.torad),this.add(this.m1),this.add(this.m2);break;case"hinge":case"cylindrical":s=this.motor.mat.get("svg"),a={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},t.lm&&(a.min=t.lm[0],a.max=t.lm[1]),t.lmr&&(a.min=t.lmr[0],a.max=t.lmr[1]),this.m1=new zt("angle",a,s),this.m2=new zt("needle",a,s),this.add(this.m1),this.add(this.m2);break;default:const i=this.motor.geo.get("joint");let o=i.clone();o.scale(this.size,this.size,this.size),this.m1=new e.LineSegments(o,r),this.add(this.m1),o=i.clone(),o.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new e.LineSegments(o,r),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new e.Matrix4,this.mat2=new e.Matrix4,this.end=new e.Vector3;let o=new e.Quaternion;t.quat1&&this.mat1.makeRotationFromQuaternion(o.fromArray(t.quat1)),t.quat2&&this.mat2.makeRotationFromQuaternion(o.fromArray(t.quat2)),this.mat1.setPosition(t.pos1[0],t.pos1[1],t.pos1[2]),this.mat2.setPosition(t.pos2[0],t.pos2[1],t.pos2[2]);const n=new e.BufferGeometry;n.setAttribute("position",new e.Float32BufferAttribute([0,0,0,0,0,0],3)),n.setAttribute("color",new e.Float32BufferAttribute([1,0,0,1,0,0],3)),n.computeBoundingSphere(),this.m3=new e.LineSegments(n,r),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()))}updateFromPhy(t,e=0){this.visible&&(this.position.fromArray(t,e),this.quaternion.fromArray(t,e+3),this.updateMatrix(),this.m2.position.fromArray(t,e+7),this.m2.quaternion.fromArray(t,e+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class Et extends rt{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="joint",this.v1=new e.Vector3,this.v2=new e.Vector3}step(t,e){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=e+a*C.joint,16===C.joint?i.updateFromPhy(t,s):i.update()}add(t={}){let i,s=this.setName(t),a=null,r=null,o=!1;if(t.axis1||(t.axis1=[1,0,0]),t.axis2||(t.axis2=[1,0,0]),t.pos1||(t.pos1=[0,0,0]),t.pos2||(t.pos2=[0,0,0]),t.limit?t.lm=t.limit:t.lm&&(t.limit=t.lm),"universal"!==t.mode&&"dof"!==t.mode&&"d6"!==t.mode||(t.mode="generic"),"revolute"===t.mode&&(t.mode="hinge"),"slider"===t.mode&&(t.mode="cylindrical"),t.b1&&(i="string"==typeof t.b1,a=i?this.Utils.byName(t.b1):t.b1,i||(t.b1=t.b1.name),a&&a.link++),t.b2&&(i="string"==typeof t.b2,r=i?this.Utils.byName(t.b2):t.b2,i||(t.b2=t.b2.name),r&&r.link++),t.worldPos&&(t.worldAnchor=t.worldPos),t.worldAnchor&&(t.pos1=a?this.Utils.toLocal(this.v1.fromArray(t.worldAnchor),a).toArray():t.worldAnchor,t.pos2=r?this.Utils.toLocal(this.v2.fromArray(t.worldAnchor),r).toArray():t.worldAnchor,delete t.worldAnchor),t.worldAxis&&(t.axis1=a?this.Utils.toLocal(this.v1.fromArray(t.worldAxis),a,!0).toArray():t.worldAxis,t.axis2=r?this.Utils.toLocal(this.v2.fromArray(t.worldAxis),r,!0).toArray():t.worldAxis,o=!0,delete t.worldAxis),t.worldQuat&&(t.quat1=this.Utils.quatLocal(t.worldQuat,a),t.quat2=this.Utils.quatLocal(t.worldQuat,r),"OIMO"!==this.engine&&"HAVOK"!==this.engine&&"JOLT"!==this.engine||(t.axis1=this.Utils.axisLocal(A.quatToAxis(t.worldQuat),a),t.axis2=this.Utils.axisLocal(A.quatToAxis(t.worldQuat),r)),delete t.worldQuat),void 0!==t.rot1&&(t.quat1=A.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=A.quatFromEuler(t.rot2),delete t.rot2),t.quat1||(t.quat1=(new e.Quaternion).setFromUnitVectors(new e.Vector3(1,0,0),(new e.Vector3).fromArray(t.axis1).normalize()).toArray()),t.quat2||(t.quat2=(new e.Quaternion).setFromUnitVectors(new e.Vector3(1,0,0),(new e.Vector3).fromArray(t.axis2).normalize()).toArray()),"AMMO"===this.engine&&o&&"hinge"===t.mode){let i=new e.Euler(0,-90*x,0),s=(new e.Quaternion).setFromEuler(i).toArray();t.quatX=s}t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=A.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot);let n=new Rt(t,this.motor);return n.name=s,n.body1=a,n.body2=r,void 0===t.visible&&(t.visible=this.motor.jointVisible||!1),this.set(t,n),this.addToWorld(n,t.id),this.motor.post({m:"add",o:t}),n}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&void 0!==t.visible&&(e.visible=t.visible)}}class Ft extends rt{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="contact"}step(t,e){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=e+a*C.contact,i.update(t,s)}add(t={}){this.setName(t);let e=new Bt(t);return t.callback&&delete t.callback,this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}}class Bt{constructor(t={}){this.type="contact",this.name=t.name,this.callback=t.callback||function(){},this.b1=t.b1||null,this.b2=t.b2||null,this.ignore=t.ignore||[],this.always=void 0===t.always||t.always,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}detectBody(){}update(t,e=0){this.data.hit=t[e]>0,this.simple||(this.data.point=[t[e+1],t[e+2],t[e+3]],this.data.normal=[t[e+4],t[e+5],t[e+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}let Ct=null;class Lt extends rt{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.motor.geo,Ct=this.motor.mat,this.type="vehicle",this.num=C[this.type]}step(t,e){let i,s,a=this.list.length;for(;a--;)s=this.list[a],i=e+a*this.num,s.step(t,i)}add(t={}){this.setName(t);const e=new _t(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:e.o}),e}set(t={},e=null){null===e&&(e=this.byName(t.name))}}class _t extends e.Object3D{constructor(t,i){super(),this.motor=i,this.Utils=this.motor.utils,this.velocity=new e.Vector3,this.angular=new e.Vector3,t.extra&&(this.extra=t.extra,delete t.extra),this.type="vehicle",this.name=t.name||"car",this.isRay=t.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(t)}drive(){}raycast(){}init(t){this.mass=t.mass||2e3,this.model=null,this.size=t.size||[1.7,1,5],this.massCenter=t.massCenter||[0,.55,1.594],this.chassisPos=t.chassisPos||[0,.83,0],this.maxSteering=t.maxSteering||24,this.incSteering=t.incSteering||2,this.s_travel=t.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===this.engine?.5*this.s_travel:0,this.numWheel=t.numWheel||4,this.radius=t.radius||.35,this.radiusBack=t.radiusBack||this.radius,this.deep=t.deep||.3,this.deepBack=t.deepBack||this.deep;let e=this.numWheel<4?1:2;if(t.wPos||(t.wPos=[.8,.1,1.4]),t.wPos){this.wPos=t.wPos;var i,s,a,r,o,n,l=t.wPos,h=[],c=1,d=0;l.length,l.length;for(let t=0;t<this.numWheel;t++)c=t%2==0?-1:1,s=Math.floor(.5*t),d=t>=e,0===(a=l[1])&&(a=d?this.radiusBack:this.radius),(r=l[0])instanceof Array&&(r=l[0][s]),o=d?-l[2]:l[2],l[2]instanceof Array&&(o=l[2][s]),i=[r*c,a,o],h.push(i);this.wheelsPosition=h,delete t.wPos}t.wheelsPosition&&(this.wheelsPosition=t.wheelsPosition);const u=t.meshScale||1,p=[];t.chassisShape?p.push({type:"convex",shape:t.chassisShape,size:[u],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):p.push({type:"box",size:this.size,pos:this.chassisPos});for(let i=0;i<this.numWheel;i++)i<e?p.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1}):p.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1});var m=Ct.get(t.debug?"debug":void 0===t.chassisMesh?"body":"hide");let f,b;for(let t=0;t<p.length;t++)f=p[t],f.pos&&(f.localPos=f.pos),f.size=A.autoSize(f.size,f.type),this.motor.getGeometryRef(f,this,m);if(t.chassisMesh&&(b=t.noClone?t.chassisMesh:t.chassisMesh.clone(),b.position.set(0,0,0),this.Utils.noRay(b),b.scale.set(u,u,u),this.children[0].add(b),this.model=b,delete t.chassisMesh),t.wheelMesh){for(let i=1;i<this.numWheel+1;i++)d=i>=e+1,b=t.wheelMeshBack&&d?t.wheelMeshBack.clone():t.wheelMesh.clone(),this.Utils.noRay(b),b.position.set(0,0,0),2==i||4==i?b.scale.set(-u,u,u):b.scale.set(u,u,u),this.children[i].add(b);delete t.wheelMesh}if(t.suspensionMesh){this.suspensionMesh=[];for(let e=1;e<this.numWheel+1;e++)b=t.suspensionMesh.clone(),this.Utils.noRay(b),b.position.set(0,0,0),b.position.fromArray(this.wheelsPosition[e-1]),b.position.x=0,2==e||4==e?b.scale.set(u,u,u):b.scale.set(-u,u,u),this.children[0].add(b),this.suspensionMesh.push(b);delete t.suspensionMesh}if(t.brakeMesh){this.brake=[];for(let e=1;e<this.numWheel+1;e++)d=e>2,b=t.brakeMeshBack&&d?t.brakeMeshBack.clone():t.brakeMesh.clone(),this.Utils.noRay(b),b.position.set(0,0,0),b.position.fromArray(this.wheelsPosition[e-1]),n=t.brakeMeshBack||d?u:-u,2==e||4==e?b.scale.set(-u,u,n):b.scale.set(u,u,n),this.children[0].add(b),this.brake.push(b);delete t.brakeMesh}t.mass=this.mass,t.size=t.chassisShape?p[0].boxSize:this.size,t.numWheel=this.numWheel,t.wheelsPosition=this.wheelsPosition,t.radius=this.radius,t.radiusBack=this.radiusBack,t.deep=this.deep,t.deepBack=this.deepBack,t.chassisShape=p[0],t.maxSteering=this.maxSteering,t.incSteering=this.incSteering,t.s_travel=this.s_travel,t.massCenter=this.massCenter,t.chassisPos=this.chassisPos,this.o=t}set(t){t.name=this.name,this.motor.change(t)}respawn(t){(t=t||{}).respawn=!0,t.name=this.name,t.keepRotation&&(t.quat=this.quaternion.toArray()),this.motor.change(t)}move(){}dispose(){}step(t,e){if(!this.actif){if(0===t[e+0]+t[e+1]+t[e+2]+t[e+3]+t[e+4]+t[e+5]+t[e+6]+t[e+7])return;this.actif=!0}this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.updateMatrix();let i,s=this.numWheel+1,a=0,r=0,o=[],n=0;for(let l=0;l<s;l++)n=8*l+e,0===l&&(t[n],this.circum),1===l&&(a=t[n]),2===l&&(r=t[n]),i=this.children[l],i&&l>0&&(o[l-1]=this.wheelsPosition[l-1][1]-this.decaly-t[n+2],i.position.fromArray(t,n+1),i.quaternion.fromArray(t,n+4),this.rolling[l-1]=i.rotation.x,this.brake&&(this.brake[l-1].position.copy(i.position),1!=l&&2!=l||(this.brake[l-1].rotation.y=t[n])));for(n=4;n--;)this.suspension[n]=A.clamp(o[n]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[n]>0?(this.Utils.morph(this.suspensionMesh[n].children[0],"low",this.suspension[n]),this.Utils.morph(this.suspensionMesh[n].children[0],"top",0)):(this.Utils.morph(this.suspensionMesh[n].children[0],"low",0),this.Utils.morph(this.suspensionMesh[n].children[0],"top",-this.suspension[n])));this.steering=Math.round(.5*(a+r)*v)/this.maxSteering}}const Dt=new e.Matrix4,Vt=new e.Vector3,jt=new e.Quaternion,qt=new e.Vector3,Ot=new e.Matrix4,It=new e.Matrix4,Gt=["hip","abdomen","chest","neck","head","rCollar","lCollar","lShldr","rShldr","lThigh","rThigh","rBreast","lBreast"];class Ut extends e.Object3D{constructor(t,e,i,s,a=null,r={}){super(),this.motor=t,this.prefix=e||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=s,this.model=i,this.scaler=this.model.scale.x,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==this.motor.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.matrixAutoUpdate=!1,this.mass=a,this.friction=.5,this.restitution=0,this.option=r,this.useDrive=void 0===r.useDrive||r.useDrive,this.showJoint=void 0!==r.showJoint&&r.showJoint,this.init()}setMass(t){if(t===this.mass)return;this.mass=t;const e=[];let i=this.nodes.length,s=this.mass/i;for(;i--;)e.push({name:this.nodes[i].name,mass:s});this.motor.change(e)}setMode(t){if(t===this.mode)return;this.mode=t;const e=[];let i,s="follow"===this.mode,a=this.nodes.length;for(;a--;)i=this.nodes[a],e.push({name:i.name,kinematic:s}),i.kinematic=s,i.bone.isPhysics=!s;this.motor.change(e)}freeBone(t){t.kinematic&&(t.cc++,20===t.cc&&(t.cc=0,t.kinematic=!1,t.bone.isPhysics=!0,this.motor.change({name:t.name,kinematic:!1})))}isVisible(t){let e=this.nameList.length;for(;e--;)this.motor.byName(this.nameList[e]).visible=t}init(){this.useSolver&&(this.solver=this.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0})),this.useAggregate="PHYSX"===this.motor.engine;const t=[];let i=(new e.Matrix4).makeScale(this.scaler,this.scaler,this.scaler),s=new e.Vector3,a=new e.Vector3,r=new e.Quaternion,o=new e.Euler,n=new e.Matrix4,l=new e.Matrix4,h=new e.Matrix4;Ot.copy(this.model.matrixWorld).invert();let c=new e.Vector3,d=new e.Vector3,u=[1,1,1,1,1,1,1];this.option.sizer&&(u=this.option.sizer);let p,m,f,b,g,y,v,w,M,k,S,T,P,z=this.bones.length,R=0;for(this.mass&&(R=this.mass/z),p=0;p<z;p++)if(M=null,b=this.bones[p],m=b.name,g=b.parent,g){f=g.name,It.multiplyMatrices(Ot,b.matrixWorld),c.setFromMatrixPosition(It),It.multiplyMatrices(Ot,g.matrixWorld),d.setFromMatrixPosition(It),v=c.distanceTo(d),S=[0,0,.5*v],y=[v,1,1],w=null,k=!0,P=!1,"hip"===f&&"abdomen"===m&&(M="capsule",y=[v*u[0],.08],S=[0,0,-v*u[0]],w=[0,0,90]),"abdomen"===f&&"chest"===m&&(M="capsule",y=[.7*v*u[1],.08],S=[0,0,.5*-v-.06],w=[90,0,0]),"chest"===f&&"neck"===m&&(M="capsule",y=[.4*v*u[2],.04],S=[0,0,.5*-v-.02],w=[0,0,90]),"neck"===f&&"head"===m&&(M="capsule",y=[.06*u[3],v],S=[0,0,.5*-v],w=[90,0,0]),"head"===f&&"End_head"===m&&(M="capsule",y=[.1*u[4],v-.17],S=[0,.02,.5*-v+.02],w=[90,0,0]),"chest"===f&&"rBreast"===m&&"HAVOK"!==this.motor.engine&&(f="rBreast",g=b,M="sphere",y=[.065],S=[.065,0,0],this.breast=!0,P=!0),"chest"===f&&"lBreast"===m&&"HAVOK"!==this.motor.engine&&(f="lBreast",g=b,M="sphere",y=[.065],S=[.065,0,0],this.breast=!0,P=!0);let e=.04*u[5],p=v-e;if("lCollar"===f&&"lShldr"===m&&(M="capsule",y=[e,.3*v],S=[.6*v,0,0],w=[0,0,90]),"lShldr"===f&&"lForeArm"===m&&(M="capsule",y=[e,p],S=[.5*p,0,0],w=[0,0,90]),"lForeArm"===f&&"lHand"===m&&(M="capsule",y=[e,p],S=[.5*p,0,0],w=[0,0,90]),"lHand"===f&&"lMid1"===m&&(M="box",y=[2*v,.09,.05],S=[v,0,0]),"rCollar"===f&&"rShldr"===m&&(M="capsule",y=[e,.3*v],S=[.6*-v,0,0],w=[0,0,90]),"rShldr"===f&&"rForeArm"===m&&(M="capsule",y=[e,p],S=[.5*-p,0,0],w=[0,0,90]),"rForeArm"===f&&"rHand"===m&&(M="capsule",y=[e,p],S=[.5*-p,0,0],w=[0,0,90]),"rHand"===f&&"rMid1"===m&&(M="box",y=[2*v,.09,.05],S=[-v,0,0]),e=.06*u[6],p=v-e,"lThigh"===f&&(M="capsule",y=[e,v],w=[90,0,0],S=[0,0,.5*p]),"lShin"===f&&(M="capsule",y=[e,v],w=[90,0,0],S=[0,0,.5*p]),"lFoot"===f&&(M="capsule",y=[.05,v],S=[0,.5*v-.025,.04]),"rThigh"===f&&(M="capsule",y=[e,v],w=[90,0,0],S=[0,0,.5*p]),"rShin"===f&&(M="capsule",y=[e,v],w=[90,0,0],S=[0,0,.5*p]),"rFoot"===f&&(M="capsule",y=[.05,v],S=[0,.5*v-.025,.04]),e=.04,p=v-e,"rEar_0"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0],Gt.push("rEar_0")),"rEar_1"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0],Gt.push("rEar_1")),"rEar_2"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0],Gt.push("rEar_2")),"rEar_3"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0]),"lEar_0"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0],Gt.push("lEar_0")),"lEar_1"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0],Gt.push("lEar_1")),"lEar_2"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0],Gt.push("lEar_2")),"lEar_3"===f&&(M="capsule",y=[e,v],w=[0,0,90],S=[.5*p,0,0]),this.withFinger&&("lHand"===f&&"lMid1"===m&&(M="box",y=[v,.09,.05],S=[.5*v,0,0]),"rHand"===f&&"rMid1"===m&&(M="box",y=[v,.09,.05],S=[.5*-v,0,0]),"rThumb1"===f&&"rThumb2"===m&&(M="capsule",y=[.02,v],w=[0,0,90]),"rThumb2"===f&&"rThumb3"===m&&(M="capsule",y=[.02,v],w=[0,0,90]),"rHand"===f&&"rMid1"===m&&(M="capsule",y=[.02,v],w=[0,0,90],S=[.6*-v,0,0]),"rMid1"===f&&"rMid2"===m&&(M="capsule",y=[.02,v],w=[0,0,90],S=[.6*-v,0,0]),"rMid2"===f&&"rMid3"===m&&(M="capsule",y=[.02,v],w=[0,0,90],S=[.6*-v,0,0])),null!==M){T=this.prefix+"_bone_"+f,l.makeTranslation(S[0],S[1],S[2]),w&&(h.makeRotationFromEuler(o.set(w[0]*x,w[1]*x,w[2]*x)),l.multiply(h)),g.updateWorldMatrix(!0,!1),It.multiplyMatrices(Ot,g.matrixWorld),n.copy(It),n.decompose(s,r,a),this.posRef[T]=s.toArray(),"lForeArm"!==f&&"rForeArm"!==f||(jt.setFromAxisAngle({x:0,y:1,z:0},-90*x),r.multiply(jt)),this.quatRef[T]=r.toArray(),n.multiplyMatrices(It,l),n.decompose(s,r,a),this.nameList.push(T);let e={name:T,friction:this.friction,restitution:this.restitution,type:M,size:A.scaleArray(y,this.scaler,3),pos:s.toArray(),quat:r.toArray(),kinematic:k,material:"hide",shadow:!1,neverSleep:!0,helper:!0,hcolor:[0,.5,1],hcolor2:[0,.2,1],penetrationVelocity:3,stabilization:.1,damping:[.25,.5],...this.option};if(this.useAggregate)-1!==Gt.indexOf(f)&&(e.aggregate=this.prefix+"__Group",e.aggregateMax=21),e.mask=3;else{let t=3;"lForeArm"!==f&&"rForeArm"!==f&&"lShin"!==f&&"rShin"!==f||(t=35),"rEar_1"!==f&&"rEar_2"!==f&&"rEar_3"!==f&&"lEar_1"!==f&&"lEar_2"!==f&&"lEar_3"!==f||(t=35),"rEar_0"!==f&&"rEar_0"!==f||(t=0),e.group=32,e.mask=t}null!==this.mass?e.mass=R:e.density=1,t.push(e);let c=l.clone().invert().premultiply(i);this.nodes.push({name:T,kinematic:k,motion:P,bone:g,decal:l.clone(),decalinv:c,quat:r.toArray(),pos:s.toArray(),cc:0})}}this.motor.add(t),this.addLink(),this.dispatchEvent({type:"start",message:"go !"}),this.ready=!0}existe(t){return-1!==this.nameList.indexOf(t)}addLink(){let t=[.05,1,0];"PHYSX"===this.motor.engine&&(t=[50,10,0,.5]);let e=2,i=.1,s=1e7,a=!1,r=this.prefix+"_bone_",o=[],n={type:"joint",mode:"d6",lm:[["ry",-180,180,...t],["rz",-180,180,...t]],collision:!1,helperSize:.05,visible:this.showJoint};this.useDrive&&(n.drives=[["rx",e,i,s,a],["ry",e,i,s,a],["rz",e,i,s,a]]);let l=[-.001,.001,100,.2,.5];o.push({...n,b1:r+"hip",b2:r+"abdomen",worldPos:this.posRef[r+"abdomen"],worldQuat:this.quatRef[r+"hip"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),o.push({...n,b1:r+"abdomen",b2:r+"chest",worldPos:this.posRef[r+"chest"],worldQuat:this.quatRef[r+"chest"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),o.push({...n,b1:r+"chest",b2:r+"neck",worldPos:this.posRef[r+"neck"],worldQuat:this.quatRef[r+"neck"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),o.push({...n,b1:r+"neck",b2:r+"head",worldPos:this.posRef[r+"head"],worldQuat:this.quatRef[r+"head"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),o.push({...n,b1:r+"chest",b2:r+"rCollar",worldPos:this.posRef[r+"rCollar"],worldQuat:this.quatRef[r+"rCollar"],mode:"fixe"}),o.push({...n,b1:r+"chest",b2:r+"lCollar",worldPos:this.posRef[r+"lCollar"],worldQuat:this.quatRef[r+"lCollar"],mode:"fixe"}),o.push({...n,b1:r+"rCollar",b2:r+"rShldr",worldPos:this.posRef[r+"rShldr"],worldQuat:this.quatRef[r+"rShldr"]}),o.push({...n,b1:r+"lCollar",b2:r+"lShldr",worldPos:this.posRef[r+"lShldr"],worldQuat:this.quatRef[r+"lShldr"]}),this.existe(r+"rForeArm")&&o.push({...n,b1:r+"rShldr",b2:r+"rForeArm",worldPos:this.posRef[r+"rForeArm"],worldQuat:this.quatRef[r+"rForeArm"],lm:[["rx",0,160,...t]]}),this.existe(r+"lForeArm")&&o.push({...n,b1:r+"lShldr",b2:r+"lForeArm",worldPos:this.posRef[r+"lForeArm"],worldQuat:this.quatRef[r+"lForeArm"],lm:[["rx",0,160,...t]]}),this.existe(r+"rHand")&&o.push({...n,b1:r+"rForeArm",b2:r+"rHand",worldPos:this.posRef[r+"rHand"],worldQuat:this.quatRef[r+"rHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),this.existe(r+"lHand")&&o.push({...n,b1:r+"lForeArm",b2:r+"lHand",worldPos:this.posRef[r+"lHand"],worldQuat:this.quatRef[r+"lHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),o.push({...n,b1:r+"hip",b2:r+"rThigh",worldPos:this.posRef[r+"rThigh"],worldQuat:this.quatRef[r+"rThigh"]}),o.push({...n,b1:r+"hip",b2:r+"lThigh",worldPos:this.posRef[r+"lThigh"],worldQuat:this.quatRef[r+"lThigh"]}),this.existe(r+"rShin")&&o.push({...n,b1:r+"rThigh",b2:r+"rShin",worldPos:this.posRef[r+"rShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[r+"rShin"]}),this.existe(r+"lShin")&&o.push({...n,b1:r+"lThigh",b2:r+"lShin",worldPos:this.posRef[r+"lShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[r+"lShin"]}),this.existe(r+"rFoot")&&o.push({...n,b1:r+"rShin",b2:r+"rFoot",worldPos:this.posRef[r+"rFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[r+"rFoot"]}),this.existe(r+"lFoot")&&o.push({...n,b1:r+"lShin",b2:r+"lFoot",worldPos:this.posRef[r+"lFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[r+"lFoot"]}),this.breast&&(this.existe(r+"rBreast")&&o.push({...n,b1:r+"chest",b2:r+"rBreast",worldPos:this.posRef[r+"rBreast"],worldQuat:this.quatRef[r+"rBreast"],lm:[["x",...l],["y",...l],["z",...l]]}),this.existe(r+"lBreast")&&o.push({...n,b1:r+"chest",b2:r+"lBreast",worldPos:this.posRef[r+"lBreast"],worldQuat:this.quatRef[r+"lBreast"],lm:[["x",...l],["y",...l],["z",...l]]})),this.existe(r+"lEar_0")&&o.push({...n,b1:r+"head",b2:r+"lEar_0",worldPos:this.posRef[r+"lEar_0"],worldQuat:this.quatRef[r+"lEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"lEar_1")&&o.push({...n,b1:r+"lEar_0",b2:r+"lEar_1",worldPos:this.posRef[r+"lEar_1"],worldQuat:this.quatRef[r+"lEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"lEar_2")&&o.push({...n,b1:r+"lEar_1",b2:r+"lEar_2",worldPos:this.posRef[r+"lEar_2"],worldQuat:this.quatRef[r+"lEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"lEar_3")&&o.push({...n,b1:r+"lEar_2",b2:r+"lEar_3",worldPos:this.posRef[r+"lEar_3"],worldQuat:this.quatRef[r+"lEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_0")&&o.push({...n,b1:r+"head",b2:r+"rEar_0",worldPos:this.posRef[r+"rEar_0"],worldQuat:this.quatRef[r+"rEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_1")&&o.push({...n,b1:r+"rEar_0",b2:r+"rEar_1",worldPos:this.posRef[r+"rEar_1"],worldQuat:this.quatRef[r+"rEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_2")&&o.push({...n,b1:r+"rEar_1",b2:r+"rEar_2",worldPos:this.posRef[r+"rEar_2"],worldQuat:this.quatRef[r+"rEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_3")&&o.push({...n,b1:r+"rEar_2",b2:r+"rEar_3",worldPos:this.posRef[r+"rEar_3"],worldQuat:this.quatRef[r+"rEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]});let h=0;for(let t in o)o[t].name=this.prefix+"_joint_"+h,this.jointList.push(o[t].name),h++;this.motor.add(o)}updateMatrixWorld(t){if(!this.ready)return;let e=[];const i=this.nodes;let s,a,r,o=i.length,n=0;for(;o--;)s=i[n],a=s.bone,n++,s.kinematic?(Dt.multiplyMatrices(a.matrixWorld,s.decal),Dt.decompose(Vt,jt,qt),s.pos=Vt.toArray(),s.quat=jt.toArray(),e.push({name:s.name,pos:s.pos,quat:s.quat}),s.motion&&this.freeBone(s)):(r=this.motor.byName(s.name),r&&(Dt.copy(r.matrixWorld).multiply(s.decalinv),a.phyMtx.copy(Dt),a.isPhysics=!0));0!==e.length&&this.motor.change(e,!0)}dispose(){this.motor.remove(this.jointList),this.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}var Nt=function(){var t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),e=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var i,s=WebAssembly.validate(t)?r("b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q:6dkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;G9Mqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk:183lYud97dur978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnalTmbcuhoaiRbbgrc;WeGc:Ge9hmbarcsGgwce0mbc9:hoalcufadcd4cbawEgDadfgrcKcaawEgqaraq0Egk6mbaicefhxavaialfgmar9Rgoad;8qbbcj;abad9Uc;WFbGcjdadca0EhPdndndnadTmbaoadfhscbhzinaeaz9nmdamax9RaD6miabazad2fhHaxaDfhOaPaeaz9RazaPfae6EgAcsfgocl4cifcd4hCavcj;cbfaoc9WGgXcetfhQavcj;cbfaXci2fhLavcj;cbfaXfhKcbhYaoc;ab6h8AincbhodnawTmbaxaYcd4fRbbhokaocFeGhEcbh3avcj;cbfh5indndndndnaEa3cet4ciGgoc9:fPdebdkamaO9RaX6mwavcj;cbfa3aX2faOaX;8qbbaOaAfhOxdkavcj;cbfa3aX2fcbaX;8kbxekamaO9RaC6moaoclVcbawEhraOaCfhocbhidna8Ambamao9Rc;Gb6mbcbhlina5alfhidndndndndndnaOalco4fRbbgqciGarfPDbedibledibkaipxbbbbbbbbbbbbbbbbpklbxlkaiaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaiaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaiaopbbbpklbaoczfhoxekaiaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqcd4ciGarfPDbedibledibkaiczfpxbbbbbbbbbbbbbbbbpklbxlkaiczfaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaiczfaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaiczfaopbbbpklbaoczfhoxekaiczfaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqcl4ciGarfPDbedibledibkaicafpxbbbbbbbbbbbbbbbbpklbxlkaicafaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaicafaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaicafaopbbbpklbaoczfhoxekaicafaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqco4arfPDbedibledibkaic8Wfpxbbbbbbbbbbbbbbbbpklbxlkaic8Wfaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngicitc:q1jjbfpbibaic:q:yjjbfRbbgipsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Ngqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaiaoclffaqc:q:yjjbfRbbfhoxikaic8Wfaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngicitc:q1jjbfpbibaic:q:yjjbfRbbgipsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Ngqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaiaocwffaqc:q:yjjbfRbbfhoxdkaic8Wfaopbbbpklbaoczfhoxekaic8WfaopbbdaoRbbgicitc:q1jjbfpbibaic:q:yjjbfRbbgipsaoRbegqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaiaocdffaqc:q:yjjbfRbbfhokalc;abfhialcjefaX0meaihlamao9Rc;Fb0mbkkdnaiaX9pmbaici4hlinamao9RcK6mwa5aifhqdndndndndndnaOaico4fRbbalcoG4ciGarfPDbedibledibkaqpxbbbbbbbbbbbbbbbbpkbbxlkaqaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spkbbaaaoclffahc:q:yjjbfRbbfhoxikaqaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spkbbaaaocwffahc:q:yjjbfRbbfhoxdkaqaopbbbpkbbaoczfhoxekaqaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpkbbaaaocdffahc:q:yjjbfRbbfhokalcdfhlaiczfgiaX6mbkkaohOaoTmoka5aXfh5a3cefg3cl9hmbkdndndndnawTmbasaYcd4fRbbglciGPlbedwbkaXTmdavcjdfaYfhlavaYfpbdbhgcbhoinalavcj;cbfaofpblbg8JaKaofpblbg8KpmbzeHdOiAlCvXoQrLg8LaQaofpblbg8MaLaofpblbg8NpmbzeHdOiAlCvXoQrLgypmbezHdiOAlvCXorQLg8Ecep9Ta8Epxeeeeeeeeeeeeeeeeg8Fp9op9Hp9rg8Eagp9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8LaypmwDKYqk8AExm35Ps8E8Fg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8Ja8KpmwKDYq8AkEx3m5P8Es8Fg8Ja8Ma8NpmwKDYq8AkEx3m5P8Es8Fg8KpmbezHdiOAlvCXorQLg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8Ja8KpmwDKYqk8AExm35Ps8E8Fg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Ug8Fp9Abbbaladfgla8Fa8Ea8Epmlvorlvorlvorlvorp9Ug8Fp9Abbbaladfgla8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9Ug8Fp9Abbbaladfgla8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9AbbbaladfhlaoczfgoaX6mbxikkaXTmeavcjdfaYfhlavaYfpbdbhgcbhoinalavcj;cbfaofpblbg8JaKaofpblbg8KpmbzeHdOiAlCvXoQrLg8LaQaofpblbg8MaLaofpblbg8NpmbzeHdOiAlCvXoQrLgypmbezHdiOAlvCXorQLg8Ecep:nea8Epxebebebebebebebebg8Fp9op:bep9rg8Eagp:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8LaypmwDKYqk8AExm35Ps8E8Fg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8Ja8KpmwKDYq8AkEx3m5P8Es8Fg8Ja8Ma8NpmwKDYq8AkEx3m5P8Es8Fg8KpmbezHdiOAlvCXorQLg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8Ja8KpmwDKYqk8AExm35Ps8E8Fg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeg8Fp9Abbbaladfgla8Fa8Ea8Epmlvorlvorlvorlvorp:oeg8Fp9Abbbaladfgla8Fa8Ea8EpmwDqkwDqkwDqkwDqkp:oeg8Fp9Abbbaladfgla8Fa8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9AbbbaladfhlaoczfgoaX6mbxdkkaXTmbcbhocbalcl4gl9Rc8FGhiavcjdfaYfhravaYfpbdbh8Finaravcj;cbfaofpblbggaKaofpblbg8JpmbzeHdOiAlCvXoQrLg8KaQaofpblbg8LaLaofpblbg8MpmbzeHdOiAlCvXoQrLg8NpmbezHdiOAlvCXorQLg8Eaip:Rea8Ealp:Sep9qg8Ea8Fp9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Fa8Ka8NpmwDKYqk8AExm35Ps8E8Fg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Faga8JpmwKDYq8AkEx3m5P8Es8Fgga8La8MpmwKDYq8AkEx3m5P8Es8Fg8JpmbezHdiOAlvCXorQLg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Faga8JpmwDKYqk8AExm35Ps8E8Fg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9AbbbaradfhraoczfgoaX6mbkkaYclfgYad6mbkaHavcjdfaAad2;8qbbavavcjdfaAcufad2fad;8qbbaAazfhzc9:hoaOhxaOmbxlkkaeTmbaDalfhrcbhocuhlinaralaD9RglfaD6mdaPaeao9RaoaPfae6Eaofgoae6mbkaial9Rhxkcbc99amax9RakSEhoxekc9:hokavcj;kbf8Kjjjjbaokwbz:bjjjbk:TseHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhldnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhoindnalaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfaoaDcu7gPcl4fcsGcitfgsydlhzasydbhHdndnaDcsGgsak9pmbavaiaPfcsGcdtfydbaxasEhDaxasTgOfhxxekdndnascsSmbcehOasc987asamffcefhDxekalcefhDal8SbbgscFeGhPdndnascu9mmbaDhlxekalcvfhlaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhlkcehOaPce4cbaPceG9R7amfhDkaDhmkavc;abfaocitfgsaDBdbasazBdlavaicdtfaDBdbavc;abfaocefcsGcitfgsaHBdbasaDBdlaocdfhoaOaifhidnadcd9hmbabarcetfgsaH87ebasclfaD87ebascdfaz87ebxdkabarcdtfgsaHBdbascwfaDBdbasclfazBdbxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHclfas87ebaHcdfaD87ebxekabarcdtfgHaxBdbaHcwfasBdbaHclfaDBdbkavaicdtfaxBdbavc;abfaocitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfaocefcsGcitfgHasBdbaHaDBdlavaiaPfgicsGcdtfasBdbavc;abfaocdfcsGcitfgDaxBdbaDasBdlaocifhoaiaOfhiazaOfhxxekaxcbalRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbalcefhDxekalcdfhDal8SbegPcFeGhsdnaPcu9kmbalcofhAascFbGhscrhldninaD8SbbgPcFbGaltasVhsaPcu9kmeaDcefhDalcrfglc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbglcFeGhPdnalcu9kmbaDcvfhzaPcFbGhPcrhldninas8SbbgDcFbGaltaPVhPaDcu9kmeascefhsalcrfglc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashlxekascefhlas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninal8SbbgscFbGaDtaPVhPascu9kmealcefhlaDcrfgDc8J9hmbkaOhlxekalcefhlkaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDclfaO87ebaDcdfaz87ebxekabarcdtfgDaABdbaDcwfaOBdbaDclfazBdbkavc;abfaocitfgDazBdbaDaABdlavaicdtfaABdbavc;abfaocefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfaocdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhiaocifhokawcefhwaocsGhoaicsGhiarcifgrae6mbkkcbc99alaqSEhokavc;aef8Kjjjjbaok:clevu8Jjjjjbcz9Rhvdnaecvfal9nmbc9:skdnaiRbbc;:eGc;qeSmbcuskav9cb83iwaicefhoaialfc98fhrdnaeTmbdnadcdSmbcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcdtfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgiBdbalaiBdbawcefgwae9hmbxdkkcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcetfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgi87ebalaiBdbawcefgwae9hmbkkcbc99aoarSEk:SPliuo97eue978Jjjjjbca9Rhiaec98Ghldndnadcl9hmbdnalTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalaeSmeaipxbbbbbbbbbbbbbbbbgqpklbaiabalcdtfgdaeciGglcdtgv;8qbbdnalTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDaqp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkadaiav;8qbbskdnalTmbcbhvabhdinadczfgxaxpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;7eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oaoarpmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgval6mbkkalaeSmbaiczfpxbbbbbbbbbbbbbbbbgopklbaiaopklbaiabalcitfgdaeciGglcitgv;8qbbdnalTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;7eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oaoarpmbezHdiOAlvCXorQLp9qpklbkadaiav;8qbbkk:oDllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalaeSmbaiczfpxbbbbbbbbbbbbbbbbgkpklbaiakpklbaiabalcitfgoaeciGgvcitgw;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkaoaiaw;8qbbkk;uddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbheabhdinadadpbbbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepkbbadczfhdaeclfgeav6mbkkdnavalSmbaic8WfpxbbbbbbbbbbbbbbbbgopklbaicafaopklbaiczfaopklbaiaopklbaiabavcdtfgdalciGgecdtgv;8qbbdnaeTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepklbkadaiav;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz:Dbb"):r("b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:W:Odkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:S86qdbk;jYi5ud9:du8Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnalTmbcuhoaiRbbgrc;WeGc:Ge9hmbarcsGgwce0mbc9:hoalcufadcd4cbawEgDadfgrcKcaawEgqaraq0Egk6mbaicefhxcj;abad9Uc;WFbGcjdadca0EhmaialfgPar9Rgoadfhsavaoadz1jjjbgzceVhHcbhOdndninaeaO9nmeaPax9RaD6mdamaeaO9RaOamfgoae6EgAcsfglc9WGhCabaOad2fhXaAcethQaxaDfhiaOaeaoaeao6E9RhLalcl4cifcd4hKazcj;cbfaAfhYcbh8AazcjdfhEaHh3incbhodnawTmbaxa8Acd4fRbbhokaocFeGh5cbh8Eazcj;cbfhqinaih8Fdndndndna5a8Ecet4ciGgoc9:fPdebdkaPa8F9RaA6mrazcj;cbfa8EaA2fa8FaAz1jjjb8Aa8FaAfhixdkazcj;cbfa8EaA2fcbaAz:jjjjb8Aa8FhixekaPa8F9RaK6mva8FaKfhidnaCTmbaPai9RcK6mbaocdtc:q1jjbfcj1jjbawEhaczhrcbhlinargoc9Wfghaqfhrdndndndndndnaaa8Fahco4fRbbalcoG4ciGcdtfydbPDbedvivvvlvkar9cb83bbarcwf9cb83bbxlkarcbaiRbdai8Xbb9c:c:qj:bw9:9c:q;c1:I1e:d9c:b:c:e1z9:gg9cjjjjjz:dg8J9qE86bbaqaofgrcGfag9c8F1:NghcKtc8F91aicdfa8J9c8N1:Nfg8KRbbG86bbarcVfcba8KahcjeGcr4fghRbbag9cjjjjjl:dg8J9qE86bbarc7fcbaha8J9c8L1:NfghRbbag9cjjjjjd:dg8J9qE86bbarctfcbaha8J9c8K1:NfghRbbag9cjjjjje:dg8J9qE86bbarc91fcbaha8J9c8J1:NfghRbbag9cjjjj;ab:dg8J9qE86bbarc4fcbaha8J9cg1:NfghRbbag9cjjjja:dg8J9qE86bbarc93fcbaha8J9ch1:NfghRbbag9cjjjjz:dgg9qE86bbarc94fcbahag9ca1:NfghRbbai8Xbe9c:c:qj:bw9:9c:q;c1:I1e:d9c:b:c:e1z9:gg9cjjjjjz:dg8J9qE86bbarc95fag9c8F1:NgicKtc8F91aha8J9c8N1:NfghRbbG86bbarc96fcbahaicjeGcr4fgiRbbag9cjjjjjl:dg8J9qE86bbarc97fcbaia8J9c8L1:NfgiRbbag9cjjjjjd:dg8J9qE86bbarc98fcbaia8J9c8K1:NfgiRbbag9cjjjjje:dg8J9qE86bbarc99fcbaia8J9c8J1:NfgiRbbag9cjjjj;ab:dg8J9qE86bbarc9:fcbaia8J9cg1:NfgiRbbag9cjjjja:dg8J9qE86bbarcufcbaia8J9ch1:NfgiRbbag9cjjjjz:dgg9qE86bbaiag9ca1:NfhixikaraiRblaiRbbghco4g8Ka8KciSg8KE86bbaqaofgrcGfaiclfa8Kfg8KRbbahcl4ciGg8La8LciSg8LE86bbarcVfa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc7fa8Ka8Lfg8KRbbahciGghahciSghE86bbarctfa8Kahfg8KRbbaiRbeghco4g8La8LciSg8LE86bbarc91fa8Ka8Lfg8KRbbahcl4ciGg8La8LciSg8LE86bbarc4fa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc93fa8Ka8Lfg8KRbbahciGghahciSghE86bbarc94fa8Kahfg8KRbbaiRbdghco4g8La8LciSg8LE86bbarc95fa8Ka8Lfg8KRbbahcl4ciGg8La8LciSg8LE86bbarc96fa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc97fa8Ka8Lfg8KRbbahciGghahciSghE86bbarc98fa8KahfghRbbaiRbigico4g8Ka8KciSg8KE86bbarc99faha8KfghRbbaicl4ciGg8Ka8KciSg8KE86bbarc9:faha8KfghRbbaicd4ciGg8Ka8KciSg8KE86bbarcufaha8KfgrRbbaiciGgiaiciSgiE86bbaraifhixdkaraiRbwaiRbbghcl4g8Ka8KcsSg8KE86bbaqaofgrcGfaicwfa8Kfg8KRbbahcsGghahcsSghE86bbarcVfa8KahfghRbbaiRbeg8Kcl4g8La8LcsSg8LE86bbarc7faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarctfaha8KfghRbbaiRbdg8Kcl4g8La8LcsSg8LE86bbarc91faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc4faha8KfghRbbaiRbig8Kcl4g8La8LcsSg8LE86bbarc93faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc94faha8KfghRbbaiRblg8Kcl4g8La8LcsSg8LE86bbarc95faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc96faha8KfghRbbaiRbvg8Kcl4g8La8LcsSg8LE86bbarc97faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc98faha8KfghRbbaiRbog8Kcl4g8La8LcsSg8LE86bbarc99faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc9:faha8KfghRbbaiRbrgicl4g8Ka8KcsSg8KE86bbarcufaha8KfgrRbbaicsGgiaicsSgiE86bbaraifhixekarai8Pbb83bbarcwfaicwf8Pbb83bbaiczfhikdnaoaC9pmbalcdfhlaoczfhraPai9RcL0mekkaoaC6moaimexokaCmva8FTmvkaqaAfhqa8Ecefg8Ecl9hmbkdndndndnawTmbasa8Acd4fRbbgociGPlbedrbkaATmdaza8Afh8Fazcj;cbfhhcbh8EaEhaina8FRbbhraahocbhlinaoahalfRbbgqce4cbaqceG9R7arfgr86bbaoadfhoaAalcefgl9hmbkaacefhaa8Fcefh8FahaAfhha8Ecefg8Ecl9hmbxikkaATmeaza8Afhaazcj;cbfhhcbhoceh8EaYh8FinaEaofhlaa8Vbbhrcbhoinala8FaofRbbcwtahaofRbbgqVc;:FiGce4cbaqceG9R7arfgr87bbaladfhlaLaocefgofmbka8FaQfh8FcdhoaacdfhaahaQfhha8EceGhlcbh8EalmbxdkkaATmbcbaocl49Rh8Eaza8AfRbbhqcwhoa3hlinalRbbaotaqVhqalcefhlaocwfgoca9hmbkcbhhaEh8FaYhainazcj;cbfahfRbbhrcwhoaahlinalRbbaotarVhralaAfhlaocwfgoca9hmbkara8E93aq7hqcbhoa8Fhlinalaqao486bbalcefhlaocwfgoca9hmbka8Fadfh8FaacefhaahcefghaA9hmbkkaEclfhEa3clfh3a8Aclfg8Aad6mbkaXazcjdfaAad2z1jjjb8AazazcjdfaAcufad2fadz1jjjb8AaAaOfhOaihxaimbkc9:hoxdkcbc99aPax9RakSEhoxekc9:hokavcj;kbf8Kjjjjbaok:XseHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhldnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhoindnalaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfaoaDcu7gPcl4fcsGcitfgsydlhzasydbhHdndnaDcsGgsak9pmbavaiaPfcsGcdtfydbaxasEhDaxasTgOfhxxekdndnascsSmbcehOasc987asamffcefhDxekalcefhDal8SbbgscFeGhPdndnascu9mmbaDhlxekalcvfhlaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhlkcehOaPce4cbaPceG9R7amfhDkaDhmkavc;abfaocitfgsaDBdbasazBdlavaicdtfaDBdbavc;abfaocefcsGcitfgsaHBdbasaDBdlaocdfhoaOaifhidnadcd9hmbabarcetfgsaH87ebasclfaD87ebascdfaz87ebxdkabarcdtfgsaHBdbascwfaDBdbasclfazBdbxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHclfas87ebaHcdfaD87ebxekabarcdtfgHaxBdbaHcwfasBdbaHclfaDBdbkavaicdtfaxBdbavc;abfaocitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfaocefcsGcitfgHasBdbaHaDBdlavaiaPfgicsGcdtfasBdbavc;abfaocdfcsGcitfgDaxBdbaDasBdlaocifhoaiaOfhiazaOfhxxekaxcbalRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbalcefhDxekalcdfhDal8SbegPcFeGhsdnaPcu9kmbalcofhAascFbGhscrhldninaD8SbbgPcFbGaltasVhsaPcu9kmeaDcefhDalcrfglc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbglcFeGhPdnalcu9kmbaDcvfhzaPcFbGhPcrhldninas8SbbgDcFbGaltaPVhPaDcu9kmeascefhsalcrfglc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashlxekascefhlas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninal8SbbgscFbGaDtaPVhPascu9kmealcefhlaDcrfgDc8J9hmbkaOhlxekalcefhlkaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDclfaO87ebaDcdfaz87ebxekabarcdtfgDaABdbaDcwfaOBdbaDclfazBdbkavc;abfaocitfgDazBdbaDaABdlavaicdtfaABdbavc;abfaocefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfaocdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhiaocifhokawcefhwaocsGhoaicsGhiarcifgrae6mbkkcbc99alaqSEhokavc;aef8Kjjjjbaok:clevu8Jjjjjbcz9Rhvdnaecvfal9nmbc9:skdnaiRbbc;:eGc;qeSmbcuskav9cb83iwaicefhoaialfc98fhrdnaeTmbdnadcdSmbcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcdtfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgiBdbalaiBdbawcefgwae9hmbxdkkcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcetfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgi87ebalaiBdbawcefgwae9hmbkkcbc99aoarSEk:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;oiliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabaiavcefciGfcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavciGfgkcd7cetfaD87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavcufciGfcetfaD87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohvxekcjjjj94hvkabakcetfav87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2gdTmbinababydbgecwtcw91:Yaece91cjjj98Gcjjj;8if::NUdbabclfhbadcufgdmbkkk9teiucbcbyd:K1jjbgeabcifc98GfgbBd:K1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;teeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiaeydlBdlaiaeydwBdwaiaeydxBdxaeczfheaiczfhiadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk:3eedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdxaialBdwaialBdlaialBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkk81dbcjwk8Kbbbbdbbblbbbwbbbbbbbebbbdbbblbbbwbbbbc:Kwkl8WNbb"),a=WebAssembly.instantiate(s,{}).then((function(t){(i=t.instance).exports.__wasm_call_ctors()}));function r(t){for(var i=new Uint8Array(t.length),s=0;s<t.length;++s){var a=t.charCodeAt(s);i[s]=a>96?a-97:a>64?a-39:a+4}var r=0;for(s=0;s<t.length;++s)i[r++]=i[s]<60?e[i[s]]:64*(i[s]-60)+i[++s];return i.buffer.slice(0,r)}function o(t,e,i,s,a,r,o){var n=t.exports.sbrk,l=s+3&-4,h=n(l*a),c=n(r.length),d=new Uint8Array(t.exports.memory.buffer);d.set(r,c);var u=e(h,s,a,c,r.length);if(0==u&&o&&o(h,l,a),i.set(d.subarray(h,h+s*a)),n(h-n(0)),0!=u)throw new Error("Malformed buffer data: "+u)}var n={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function d(t){var e={object:new Worker(t),pending:0,requests:{}};return e.object.onmessage=function(t){var i=t.data;e.pending-=i.count,e.requests[i.id][i.action](i.value),delete e.requests[i.id]},e}function u(t){var e=t.data;if(!e.id)return self.close();self.ready.then((function(t){try{var i=new Uint8Array(e.count*e.size);o(t,t.exports[e.mode],i,e.count,e.size,e.source,t.exports[e.filter]),self.postMessage({id:e.id,count:e.count,action:"resolve",value:i},[i.buffer])}catch(t){self.postMessage({id:e.id,count:e.count,action:"reject",value:t})}}))}return{ready:a,supported:!0,useWorkers:function(t){!function(t){for(var e="self.ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(s)+"]), {}).then(function(result) { result.instance.exports.__wasm_call_ctors(); return result.instance; });self.onmessage = "+u.name+";"+o.toString()+u.toString(),i=new Blob([e],{type:"text/javascript"}),a=URL.createObjectURL(i),r=h.length;r<t;++r)h[r]=d(a);for(r=t;r<h.length;++r)h[r].object.postMessage({});h.length=t,URL.revokeObjectURL(a)}(t)},decodeVertexBuffer:function(t,e,s,a,r){o(i,i.exports.meshopt_decodeVertexBuffer,t,e,s,a,i.exports[n[r]])},decodeIndexBuffer:function(t,e,s,a){o(i,i.exports.meshopt_decodeIndexBuffer,t,e,s,a)},decodeIndexSequence:function(t,e,s,a){o(i,i.exports.meshopt_decodeIndexSequence,t,e,s,a)},decodeGltfBuffer:function(t,e,s,a,r,h){o(i,i.exports[l[r]],t,e,s,a,i.exports[n[h]])},decodeGltfBufferAsync:function(t,e,s,r,d){return h.length>0?function(t,e,i,s,a){for(var r=h[0],o=1;o<h.length;++o)h[o].pending<r.pending&&(r=h[o]);return new Promise((function(o,n){var l=new Uint8Array(i),h=++c;r.pending+=t,r.requests[h]={resolve:o,reject:n},r.object.postMessage({id:h,count:t,size:e,source:l,mode:s,filter:a},[l.buffer])}))}(t,e,s,l[r],n[d]):a.then((function(){var a=new Uint8Array(t*e);return o(i,i.exports[l[r]],a,t,e,s,i.exports[n[d]]),a}))}}}();const Wt=new WeakMap;class Ht extends e.Loader{constructor(t){super(t),this.useLocal=!1,this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setUseLocal(t){return this.useLocal=t,this}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,i,s,a){const r=new e.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),console.log(this.withCredentials,this.requestHeader,this.path),r.load(t,(t=>{this.parse(t,i,a)}),s,a)}parse(t,i,s){this.decodeDracoFile(t,i,null,null,e.SRGBColorSpace).catch(s)}decodeDracoFile(t,i,s,a,r=e.LinearSRGBColorSpace){const o={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:a||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:r};return this.decodeGeometry(t,o).then(i)}decodeGeometry(t,e){const i=JSON.stringify(e);if(Wt.has(t)){const e=Wt.get(t);if(e.key===i)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const a=this.workerNextTaskID++,r=t.byteLength,o=this._getWorker(a,r).then((i=>(s=i,new Promise(((i,r)=>{s._callbacks[a]={resolve:i,reject:r},s.postMessage({type:"decode",id:a,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return o.catch((()=>!0)).then((()=>{s&&a&&this._releaseTask(s,a)})),Wt.set(t,{key:i,promise:o}),o}_createGeometry(t){const i=new e.BufferGeometry;t.index&&i.setIndex(new e.BufferAttribute(t.index.array,1));for(let s=0;s<t.attributes.length;s++){const a=t.attributes[s],r=a.name,o=a.array,n=a.itemSize,l=new e.BufferAttribute(o,n);"color"===r&&(this._assignVertexColorSpace(l,a.vertexColorSpace),l.normalized=o instanceof Float32Array==!1),i.setAttribute(r,l)}return i}_assignVertexColorSpace(t,i){if(i!==e.SRGBColorSpace)return;const s=new e.Color;for(let e=0,i=t.count;e<i;e++)s.fromBufferAttribute(t,e).convertSRGBToLinear(),t.setXYZ(e,s.r,s.g,s.b)}_loadLibrary(t,i){const s=new e.FileLoader(this.manager);return s.setPath(this.decoderPath),s.setResponseType(i),s.setWithCredentials(this.withCredentials),new Promise(((e,i)=>{s.load(t,e,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t=[];return"object"!=typeof WebAssembly||"js"===this.decoderConfig.type?this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_decoder.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href),"text"))):t.push(this._loadLibrary("draco_decoder.js","text")):this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_wasm_wrapper.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href),"text"))):t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),this.decoderPending=Promise.all(t).then((t=>{const e=t[0],i=Kt.toString(),s=["/* draco decoder */",e,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const i=e.data;switch(i.type){case"decode":t._callbacks[i.id].resolve(i);break;case"error":t._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[t]=e,i._taskLoad+=e,i}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function Kt(){let t,e;function i(t,e,i,s,a,r){const o=r.num_components(),n=i.num_points()*o,l=n*a.BYTES_PER_ELEMENT,h=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,a),c=t._malloc(l);e.GetAttributeDataArrayForAllPoints(i,r,h,l,c);const d=new a(t.HEAPF32.buffer,c,n).slice();return t._free(c),{name:s,array:d,itemSize:o}}onmessage=function(s){const a=s.data;switch(a.type){case"init":t=a.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const s=a.buffer,r=a.taskConfig;e.then((t=>{const e=t.draco,o=new e.Decoder;try{const t=function(t,e,s,a){const r=a.attributeIDs,o=a.attributeTypes;let n,l;const h=e.GetEncodedGeometryType(s);if(h===t.TRIANGULAR_MESH)n=new t.Mesh,l=e.DecodeArrayToMesh(s,s.byteLength,n);else{if(h!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");n=new t.PointCloud,l=e.DecodeArrayToPointCloud(s,s.byteLength,n)}if(!l.ok()||0===n.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const s in r){const l=self[o[s]];let h,d;if(a.useUniqueIDs)d=r[s],h=e.GetAttributeByUniqueId(n,d);else{if(d=e.GetAttributeId(n,t[r[s]]),-1===d)continue;h=e.GetAttribute(n,d)}const u=i(t,e,n,s,l,h);"color"===s&&(u.vertexColorSpace=a.vertexColorSpace),c.attributes.push(u)}h===t.TRIANGULAR_MESH&&(c.index=function(t,e,i){const s=i.num_faces(),a=3*s,r=4*a,o=t._malloc(r);e.GetTrianglesUInt32Array(i,r,o);const n=new Uint32Array(t.HEAPF32.buffer,o,a).slice();return t._free(o),{array:n,itemSize:1}}(t,e,n));return t.destroy(n),c}(e,o,new Int8Array(s),r),n=t.attributes.map((t=>t.array.buffer));t.index&&n.push(t.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:t},n)}catch(t){console.error(t),self.postMessage({type:"error",id:a.id,error:t.message})}finally{e.destroy(o)}}))}}}let Xt=0;class Jt extends p.KTX2Loader{constructor(t){super(t),this.useLocal=!1}setUseLocal(t){return this.useLocal=t,this}_loadLibrary(t,i){const s=new e.FileLoader(this.manager);return s.setPath(this.transcoderPath),s.setResponseType(i),s.setWithCredentials(this.withCredentials),new Promise(((e,i)=>{s.load(t,e,void 0,i)}))}init(){if(!this.transcoderPending){let t,e;this.useLocal?(this.transcoderPath="",t=this._loadLibrary(new URL("../build/basis/basis_transcoder.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href),"text"),e=this._loadLibrary(new URL("../build/basis/basis_transcoder.wasm","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href),"arraybuffer")):(t=this._loadLibrary("basis_transcoder.js","text"),e=this._loadLibrary("basis_transcoder.wasm","arraybuffer")),this.transcoderPending=Promise.all([t,e]).then((([t,e])=>{const i=Jt.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify(Jt.EngineFormat),"let _EngineType = "+JSON.stringify(Jt.EngineType),"let _TranscoderFormat = "+JSON.stringify(Jt.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Jt.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s])),this.transcoderBinary=e,this.workerPool.setWorkerCreator((()=>{const t=new Worker(this.workerSourceURL),e=this.transcoderBinary.slice(0);return t.postMessage({type:"init",config:this.workerConfig,transcoderBinary:e},[e]),t}))})),Xt>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Xt++}return this.transcoderPending}}var Qt=function(){var t,e=0x10000000000000000,i=4294967295,s=2147483647;function a(t){var e=[];return e[t-1]=void 0,e}function r(t,e){return n(t[0]+e[0],t[1]+e[1])}function o(t,e){var i,s;return t[0]==e[0]&&t[1]==e[1]?0:(i=0>t[1],s=0>e[1],i&&!s?-1:!i&&s?1:function(t,e){return n(t[0]-e[0],t[1]-e[1])}(t,e)[1]<0?-1:1)}function n(t,s){var a,r;for(t%=e,s=(s%=e)-(a=s%D)+(r=Math.floor(t/D)*D),t=t-r+a;0>t;)t+=D,s-=D;for(;t>i;)t-=D,s+=D;for(s%=e;s>0x7fffffff00000000;)s-=e;for(;-0x10000000000000000>s;)s+=e;return[t,s]}function l(t){return t>=0?[t,0]:[t+D,-4294967296]}function h(t){return t[0]>=2147483648?~~Math.max(Math.min(t[0]-D,s),-2147483648):~~Math.max(Math.min(t[0],s),-2147483648)}function c(t){return t.cb>=t.O?-1:255&t.ab[t.cb++]}function d(t){var e=t.ab;return e.length=t.O,e}function u(t,e,s){var a,r,o,n,h="",d=[];for(r=0;5>r;++r){if(-1==(o=c(e)))throw Error("truncated input");d[r]=o<<24>>24}if(!function(t,e){var i,s,a,r,o,n,l;if(5>e.length)return 0;for(l=255&e[0],a=l%9,r=(n=~~(l/9))%5,o=~~(n/5),i=0,s=0;4>s;++s)i+=(255&e[1+s])<<8*s;return i>99999999||!function(t,e,i,s){if(e>8||i>4||s>4)return 0;A(t.k,i,e);var a=1<<s;return v(t.C,a),v(t.o,a),t.P=a-1,1}(t,a,r,o)?0:function(t,e){return 0>e?0:(t.z!=e&&(t.z=e,t.m=Math.max(t.z,1),m(t.b,Math.max(t.m,4096))),1)}(t,i)}(a=x({}),d))throw Error("corrupted input");for(r=0;64>r;r+=8){if(-1==(o=c(e)))throw Error("truncated input");1==(o=o.toString(16)).length&&(o="0"+o),h=o+""+h}/^0+$|^f+$/i.test(h)?t.N=V:(n=parseInt(h,16),t.N=n>i?V:l(n)),t.Q=function(t,e,i,s){return t.a.K=e,g(t.b),t.b.V=i,function(t){t.b.w=0,t.b.D=0,E(t.q),E(t.n),E(t.E),E(t.s),E(t.u),E(t.r),E(t.J),function(t){var e,i;for(i=1<<t.g+t.y,e=0;i>e;++e)E(t.F[e].v)}(t.k);for(var e=0;4>e;++e)E(t.j[e].B);k(t.C),k(t.o),E(t.t.B),function(t){t.p=0,t.i=-1;for(var e=0;5>e;++e)t.p=t.p<<8|c(t.K)}(t.a)}(t),t.f=0,t.l=0,t.T=0,t.R=0,t._=0,t.U=s,t.d=j,t.I=0,function(t,e){return t.h=e,t.bb=null,t.X=1,t}({},t)}(a,e,s,t.N)}function p(t,e){return t.S=function(t){return t.ab=a(32),t.O=0,t}({}),u(t,function(t,e){return t.ab=e,t.cb=0,t.O=e.length,t}({},e),t.S),t}function m(t,e){(null==t.x||t.c!=e)&&(t.x=a(e)),t.c=e,t.D=0,t.w=0}function f(t){var e=t.D-t.w;e&&(function(t,e,i,s){(function(t,e,i,s,a){for(var r=0;a>r;++r)i[s+r]=t[e+r]})(e,i,t.ab,t.O,s),t.O+=s}(t.V,t.x,t.w,e),t.D>=t.c&&(t.D=0),t.w=t.D)}function b(t,e){var i=t.D-e-1;return 0>i&&(i+=t.c),t.x[i]}function g(t){f(t),t.V=null}function y(t){if(!t.X)throw Error("bad state");if(t.bb)throw Error("No encoding");return function(t){var e=function(t){var e,i,s,a,n,c;if(c=h(t.d)&t.P,z(t.a,t.q,(t.f<<4)+c)){if(z(t.a,t.E,t.f))s=0,z(t.a,t.s,t.f)?(z(t.a,t.u,t.f)?(z(t.a,t.r,t.f)?(i=t._,t._=t.R):i=t.R,t.R=t.T):i=t.T,t.T=t.l,t.l=i):z(t.a,t.n,(t.f<<4)+c)||(t.f=7>t.f?9:11,s=1),s||(s=w(t.o,t.a,c)+2,t.f=7>t.f?8:11);else if(t._=t.R,t.R=t.T,t.T=t.l,s=2+w(t.C,t.a,c),t.f=7>t.f?7:10,n=P(t.j[function(t){return 4>(t-=2)?t:3}(s)],t.a),n>=4){if(a=(n>>1)-1,t.l=(2|1&n)<<a,14>n)t.l+=function(t,e,i,s){var a,r,o=1,n=0;for(r=0;s>r;++r)a=z(i,t,e+o),o<<=1,o+=a,n|=a<<r;return n}(t.J,t.l-n-1,t.a,a);else if(t.l+=R(t.a,a-4)<<4,t.l+=function(t,e){var i,s,a=1,r=0;for(s=0;t.A>s;++s)i=z(e,t.B,a),a<<=1,a+=i,r|=i<<s;return r}(t.t,t.a),0>t.l)return-1==t.l?1:-1}else t.l=n;if(o(l(t.l),t.d)>=0||t.l>=t.m)return-1;(function(t,e,i){var s=t.D-e-1;for(0>s&&(s+=t.c);0!=i;--i)s>=t.c&&(s=0),t.x[t.D++]=t.x[s++],t.D>=t.c&&f(t)})(t.b,t.l,s),t.d=r(t.d,l(s)),t.I=b(t.b,0)}else e=function(t,e,i){return t.F[((e&t.Y)<<t.g)+((255&i)>>>8-t.g)]}(t.k,h(t.d),t.I),t.I=7>t.f?function(t,e){var i=1;do{i=i<<1|z(e,t.v,i)}while(256>i);return i<<24>>24}(e,t.a):function(t,e,i){var s,a,r=1;do{if(a=i>>7&1,i<<=1,s=z(e,t.v,(1+a<<8)+r),r=r<<1|s,a!=s){for(;256>r;)r=r<<1|z(e,t.v,r);break}}while(256>r);return r<<24>>24}(e,t.a,b(t.b,t.l)),function(t,e){t.x[t.D++]=e,t.D>=t.c&&f(t)}(t.b,t.I),t.f=function(t){return 4>t?0:10>t?t-3:t-6}(t.f),t.d=r(t.d,q);return 0}(t.h);if(-1==e)throw Error("corrupted input");t.$=V,t.Z=t.h.d,(e||o(t.h.U,j)>=0&&o(t.h.d,t.h.U)>=0)&&(f(t.h.b),g(t.h.b),t.h.a.K=null,t.X=0)}(t),t.X}function x(t){t.b={},t.a={},t.q=a(192),t.E=a(12),t.s=a(12),t.u=a(12),t.r=a(12),t.n=a(192),t.j=a(4),t.J=a(114),t.t=T({},4),t.C=M({}),t.o=M({}),t.k={};for(var e=0;4>e;++e)t.j[e]=T({},6);return t}function v(t,e){for(;e>t.e;++t.e)t.G[t.e]=T({},3),t.H[t.e]=T({},3)}function w(t,e,i){return z(e,t.M,0)?8+(z(e,t.M,1)?8+P(t.L,e):P(t.H[i],e)):P(t.G[i],e)}function M(t){return t.M=a(2),t.G=a(16),t.H=a(16),t.L=T({},8),t.e=0,t}function k(t){E(t.M);for(var e=0;t.e>e;++e)E(t.G[e].B),E(t.H[e].B);E(t.L.B)}function A(t,e,i){var s,r;if(null==t.F||t.g!=i||t.y!=e)for(t.y=e,t.Y=(1<<e)-1,t.g=i,r=1<<t.g+t.y,t.F=a(r),s=0;r>s;++s)t.F[s]=S({})}function S(t){return t.v=a(768),t}function T(t,e){return t.A=e,t.B=a(1<<e),t}function P(t,e){var i,s=1;for(i=t.A;0!=i;--i)s=(s<<1)+z(e,t.B,s);return s-(1<<t.A)}function z(t,e,i){var s,a=e[i];return(-2147483648^(s=(t.i>>>11)*a))>(-2147483648^t.p)?(t.i=s,e[i]=a+(2048-a>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),0):(t.i-=s,t.p-=s,e[i]=a-(a>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),1)}function R(t,e){var i,s,a=0;for(i=e;0!=i;--i)t.i>>>=1,s=t.p-t.i>>>31,t.p-=t.i&s-1,a=a<<1|1-s,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8);return a}function E(t){for(var e=t.length-1;e>=0;--e)t[e]=1024}function F(t){for(var e,i,s,a=0,r=0,o=t.length,n=[],l=[];o>a;++a,++r){if(128&(e=255&t[a]))if(192==(224&e)){if(a+1>=o)return t;if(128!=(192&(i=255&t[++a])))return t;l[r]=(31&e)<<6|63&i}else{if(224!=(240&e))return t;if(a+2>=o)return t;if(128!=(192&(i=255&t[++a])))return t;if(128!=(192&(s=255&t[++a])))return t;l[r]=(15&e)<<12|(63&i)<<6|63&s}else{if(!e)return t;l[r]=e}16383==r&&(n.push(String.fromCharCode.apply(String,l)),r=-1)}return r>0&&(l.length=r,n.push(String.fromCharCode.apply(String,l))),n.join("")}function B(t){return t[1]+t[0]}var C=2,L=3,_="function"==typeof setImmediate?setImmediate:setTimeout,D=4294967296,V=[i,-4294967296],j=[0,0],q=[1,0];return{decompress:function(e,i,s){var a,r,o,n,l={},h=void 0===i&&void 0===s;if("function"!=typeof i&&(r=i,i=s=0),s=s||function(e){return void 0!==r?function(e,i){t({action:L,cbn:i,result:e})}(o?e:-1,r):void 0},i=i||function(e,i){return void 0!==r?t({action:C,cbn:r,result:e,error:i}):void 0},h){for(l.d=p({},e);y(l.d.Q););return F(d(l.d.S))}try{l.d=p({},e),n=B(l.d.N),o=n>-1,s(0)}catch(t){return i(null,t)}_((function t(){try{for(var e,r=0,h=(new Date).getTime();y(l.d.Q);)if(++r%1e3==0&&(new Date).getTime()-h>200)return o&&(a=B(l.d.Q.h.d)/n,s(a)),_(t,0),0;s(1),e=F(d(l.d.S)),_(i.bind(null,e),0)}catch(t){i(null,t)}}),0)}}}();const Yt={decompress:(t,e)=>{Qt.decompress(new Uint8Array(t),e)}},Zt={getMesh:(t,e)=>{let i={};if(e){const e={},i={};let s;t.traverse((t=>{if(t.isGroup){let s=Zt.groupToMesh(t);s&&(s.applyMatrix4(t.matrix),e[t.name]=t,i[t.name]=s)}}));for(let t in e)s=e[t].parent,s.remove(e[t]),s.add(i[t])}return t.traverse((t=>{t.isMesh&&(i[t.name]=t)})),i},getGroup:(t,e,i)=>{const s={};return t.traverse((t=>{t.isGroup&&(s[t.name]=e?Zt.groupToMesh(t):t)})),s},getMaterial:t=>{const e={};let i,s=[];return t.traverse((t=>{t.isMesh&&(i=t.material,-1===s.indexOf(i.name)&&(s.push(i.name),e[i.name]=i))})),e},groupToMesh:t=>{if(t.children[0].name!==t.name+"_1")return!1;if(!t.children[0].isMesh)return!1;let s=[],a=[],r=t.children.length;for(;r--;)a[r]=t.children[r].material,s[r]=t.children[r].geometry,s[r].group=r;let o=new e.Mesh(new i.mergeGeometries(s,!0),a);return o.name=t.name,o},symetric:t=>{t.isMesh&&(t=t.geometry);let e=t.attributes.uv.array,i=.5*e.length;for(;i--;)e[2*i]<0&&(e[2*i]*=-1);t.attributes.uv.needsUpdate=!0},uv2:t=>{t.isMesh&&(t=t.geometry),t.setAttribute("uv2",t.attributes.uv)},autoMorph:(t,i,s=!0,a=!1)=>{let r,o,n,l,h,c,d,u,p,m,f,b={},g=[];t.traverse((t=>{t.isMesh&&-1!==t.name.search("__M__")&&(b[t.name]=t.geometry,g.push(t))}));for(let t in b)if(r=t.substring(0,t.indexOf("__")),o=t.substring(t.lastIndexOf("__")+2),n=i[r],n)if(h=n.geometry,c=b[t],h.morphTargetsRelative=a,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],s&&(h.morphAttributes.normal=[]),n.morphTargetInfluences=[],n.morphTargetDictionary={}),l=h.morphAttributes.position.length,a){for(d=c.attributes.position.array.length,m=[];d--;)m[d]=c.attributes.position.array[d]-h.attributes.position.array[d];u=new e.Float32BufferAttribute(m,3)}else u=new e.Float32BufferAttribute(c.attributes.position.array,3);h.morphAttributes.position.push(u),s&&(p=new e.Float32BufferAttribute(c.attributes.normal.array,3),h.morphAttributes.normal.push(p)),n.morphTargetInfluences.push(0),n.morphTargetDictionary[o]=l}else console.warn("Morph "+o+" target is no good on "+n.name);for(b={},d=g.length;d--;)f=g[d],f.parent&&f.parent.remove(f),f.material&&f.material.dispose(),f.geometry&&f.geometry.dispose()}},$t={manager:new e.LoadingManager,renderer:null,msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],lzma:null,dracoLoader:null,dracoPath:"./build/draco/",basisPath:"./build/basis/",useLocal:!1,formatGltf:{draco:!0,ktx2:!1,meshop:!1},setSupport:t=>{for(let e in t)$t.formatGltf[e]&&($t.formatGltf[e]=t[e])},maxAnisotropy:1,onLoad:()=>{},onEnd:()=>{},log:t=>{},materialRoot:t=>{console.log(t)},setLoadEvent:(t,e)=>{$t.onLoad=t,$t.onEnd=e},prefix:t=>{let e="";switch(t){case"S":case"sound":case"mp3":case"wav":case"ogg":e="S_";break;case"I":case"image":case"jpg":case"png":e="I_";break;case"E":case"hdr":case"env":case"T":case"texture":e="T_";break;case"J":case"json":e="J_";break;case"JS":case"js":e="JS_";break;case"H":case"bin":case"hex":e="H_";break;case"O":case"object3d":e="O_";break;case"M":case"material":e="M_"}return e},dispose:()=>{$t.data.forEach((function(t,e){(t.isMaterial||t.isTexture)&&(t.dispose(),$t.data.delete(e)),t.isObject3D&&(t.traverse((function(t){t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose&&t.material.dispose())})),$t.data.delete(e))}))},createElementNS:t=>document.createElementNS("http://www.w3.org/1999/xhtml",t),exist:(t,e="")=>!!$t.get(t,e),delete:(t,e="")=>$t.data.delete($t.prefix(e)+t),get:(t,e="")=>$t.data.get($t.prefix(e)+t),set:(t,e,i="",s)=>{e?(e.isMaterial&&(i="material",e.name=t,$t.materialRoot(e,s)),e.isTexture&&(i="texture"),e.isObject3D&&(i="object3d"),$t.get(t,i)||$t.data.set($t.prefix(i)+t,e)):console.log("Loading error on "+t)},getScript:t=>$t.data.get($t.prefix("js")+t),getMaterials:t=>("string"==typeof t&&(t=$t.get(t,"O")),Zt.getMaterial(t)),getGLB:(t,e)=>("string"==typeof t&&(t=$t.get(t,"O")),t?(e&&Zt.getMesh(t,e),t):console.error("Not find Model ?")),getMesh:(t,e)=>("string"==typeof t&&(t=$t.get(t,"O")),t?Zt.getMesh(t,e):console.error("Not find Model ?")),getGroup:(t,e,i)=>("string"==typeof t&&(t=$t.get(t,"O")),Zt.getGroup(t,e,i)),applyMorph(t,e=null,i=!0,s=!0){let a;a=t.isObject3D?t:$t.get(t,"O"),e||(e=$t.getMesh(t)),a&&e&&Zt.autoMorph(a,e,i,s)},uv2(t){Zt.uv2(t)},symetric(t){Zt.symetric(t)},objectSpaceNormal(t){t.material.normalMapType=e.ObjectSpaceNormalMap},add:(t,e,i)=>{$t.set(t,e,i),$t.next()},getMaterial:t=>$t.data.get("M_"+t),texture:(t={})=>{$t.loaderMap||($t.loaderMap=new e.TextureLoader);let i=t.name||"",s=t.format||"";if(t.url&&(-1!==t.url.lastIndexOf(".")?(i=t.url.substring(t.url.lastIndexOf("/")+1,t.url.lastIndexOf(".")),s=t.url.substring(t.url.lastIndexOf(".")+1).toLowerCase()):i=t.url.substring(t.url.lastIndexOf("/")+1)),-1===i.search("_c")&&-1===i.search("_l")&&-1===i.search("_u")&&-1===i.search("_d")||(t.srgb=!0),$t.exist(i,"texture"))return $t.get(i,"texture");if($t.exist(i,"image"))return $t.getTexture(i,t);if("ktx2"===s){const s=new e.CompressedTexture;return $t.data.set("T_"+i,s),$t.loaderKTX2().load(t.url,(function(e){$t.setTextureOption(e,t),s.copy(e),e.dispose(),t.callback&&t.callback()})),s}return $t.loaderMap.load(t.url,(function(e){return $t.setTextureOption(e,t),$t.data.set("T_"+i,e),t.callback&&t.callback(),e}))},getTexture:(t,i={})=>{t=(i.quality?i.quality+"k_":"")+t;let s=$t.get(t,"texture");if(!s){let a=$t.get(t,"image");if(!a)return null;s=new e.Texture(a),-1===t.search("_c")&&-1===t.search("_d")&&-1===t.search("_l")&&-1===t.search("_u")||(i.srgb=!0),$t.setTextureOption(s,i),$t.data.set("T_"+t,s)}return s},setTextureOption:(t,i={})=>{t.colorSpace=i.encoding||i.srgb?e.SRGBColorSpace:e.NoColorSpace,t.flipY=(void 0!==i.flipY||void 0!==i.flip)&&i.flipY,i.anisotropy&&(t.anisotropy="max"===i.anisotropy?$t.maxAnisotropy:i.anisotropy),void 0!==i.generateMipmaps&&(t.generateMipmaps=i.generateMipmaps),i.repeat&&(t.repeat.fromArray(i.repeat),t.wrapS=t.wrapT=e.RepeatWrapping),i.center&&t.center.fromArray(i.center),i.offset&&t.offset.fromArray(i.offset),i.filter&&"near"===i.filter&&(t.minFilter=e.NearestFilter,t.magFilter=e.NearestFilter),i.channel&&(t.channel=i.channel),t.needsUpdate=!0},loadAsync:(t,e="",i="")=>new Promise(((s,a)=>{$t.waiting=!0,$t.load(t,(()=>{$t.waiting=!1}),e,i)})),load:(t,e,i="",s="",a=0)=>{$t.msg=s;let r=[],o=e||function(){},n=("undefined"==typeof performance?Date:performance).now();"string"==typeof t||t instanceof String?r.push(t):r=r.concat(t),$t.tmp.push({urls:r,path:i,callback:o,start:n,quality:a}),$t.inLoad||$t.loadOne()},loadOne:()=>{$t.inLoad=!0,$t.onLoad();let t=$t.tmp[0].path+$t.tmp[0].urls[0],e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),i=t.substring(t.lastIndexOf(".")+1).toLowerCase();"jpg"!==i&&"png"!==i||(e=($t.tmp[0].quality?$t.tmp[0].quality+"k_":"")+e),$t.exist(e,i)?$t.next():$t.loading(t,e,i)},next:()=>{$t.tmp[0].urls.shift(),0===$t.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-$t.tmp[0].start),$t.tmp[0].callback(),$t.tmp.shift(),$t.tmp.length>0?$t.loadOne():($t.inLoad=!1,$t.clearDRACO(),$t.clearKTX2(),$t.onEnd())):$t.loadOne()},loading:(t,e,i)=>{switch($t.log($t.msg),i){case"glb":case"gltf":$t.load_GLTF(t,e);break;case"fbx":case"FBX":$t.load_FBX(t,e);break;case"obj":$t.load_OBJ(t,e);break;case"stl":$t.load_STL(t,e);break;case"ktx2":$t.load_KTX2(t,e);break;case"hdr":$t.load_RGBE(t,e);break;case"exr":$t.load_EXR(t,e);break;default:$t.extand(t,e,i)}},extand:(t,e,i)=>{$t.XHTTP||($t.XHTTP=new XMLHttpRequest);const s=$t.XHTTP;switch(s.open("GET",t,!0),"json"===i&&s.overrideMimeType("application/json"),i){case"bin":case"hex":case"wasm":case"mp3":case"wav":case"ogg":s.responseType="arraybuffer";break;case"jpg":case"png":s.responseType="blob";break;case"bvh":case"glsl":case"js":case"json":s.responseType="text"}s.onreadystatechange=function(){4===s.readyState&&(s.status>=300?console.log("Error, status code = "+s.status):$t.direct(s.response,e,i))},"onprogress"in s&&(s.onprogress=function(t){}),s.send(null)},direct:(t,e,i)=>{switch(i){case"jpg":case"png":let s=$t.createElementNS("img");s.onload=function(t){window.URL.revokeObjectURL(s.src),$t.add(e,s,"image")},s.src=window.URL.createObjectURL(t);break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(t.slice(0),(function(t){$t.add(e,t,"sound")}),(function(t){console.error("decodeAudioData error",t)}));break;case"hex":case"bin":Yt.decompress(t,(t=>{$t.add(e,t,i)}));break;case"wasm":$t.add(e,new Uint8Array(t),i);break;case"json":$t.add(e,JSON.parse(t),i);break;default:$t.add(e,t,i)}},clearKTX2:()=>{$t.KTX2&&($t.KTX2.dispose(),$t.KTX2=null)},clearDRACO:()=>{$t.dracoLoader&&($t.dracoLoader.dispose(),$t.dracoLoader=null),$t.GLTF&&($t.GLTF=null)},loaderFILE:()=>($t.FILE||($t.FILE=new e.FileLoader($t.manager)),$t.FILE),loaderDRACO:()=>{if($t.dracoLoader)return $t.dracoLoader;if(!$t.dracoLoaderType)if(navigator.userAgentData)$t.dracoLoaderType="wasm";else{let t=navigator.userAgent.toLowerCase();$t.dracoLoaderType=-1!==t.indexOf("safari")&&-1===t.indexOf("chrome")?"js":"wasm"}return $t.dracoLoader=(new Ht).setDecoderConfig({type:$t.dracoLoaderType}).setDecoderPath($t.dracoPath).setUseLocal($t.useLocal),$t.dracoLoader},loaderKTX2:()=>($t.KTX2||($t.KTX2=new Jt($t.manager).setTranscoderPath($t.basisPath).detectSupport($t.renderer).setUseLocal($t.useLocal)),$t.KTX2),loaderGLTF:()=>($t.GLTF||($t.GLTF=new r.GLTFLoader($t.manager).setCrossOrigin("anonymous"),$t.formatGltf.draco&&$t.GLTF.setDRACOLoader($t.loaderDRACO()),$t.formatGltf.ktx2&&$t.GLTF.setKTX2Loader($t.loaderKTX2()),$t.formatGltf.meshop&&$t.GLTF.setMeshoptDecoder(Nt)),$t.GLTF),loaderFBX:()=>($t.FBX||($t.FBX=new n.FBXLoader($t.manager)),$t.FBX),loaderSTL:()=>($t.STL||($t.STL=new h.STLLoader($t.manager)),$t.STL),loaderOBJ:()=>($t.OBJ||($t.OBJ=new l.OBJLoader($t.manager)),$t.OBJ),loaderRGBE:()=>($t.RGBE||($t.RGBE=new c.HDRLoader($t.manager)),$t.RGBE),loaderEXR:()=>($t.EXR||($t.EXR=new d.EXRLoader($t.manager)),$t.EXR),loaderUltra:()=>($t.ULTRA||($t.ULTRA=new u.UltraHDRLoader($t.manager).setDataType(THREE.HalfFloatType)),$t.ULTRA),load_GLTF:(t,i)=>{$t.loaderGLTF().load(t,(function(t){const s=t.scene;if(t.animations){const i=t.animations,a=new e.AnimationMixer(t.scene);s.mixer=a,s.actions={};for(let t=0;t<i.length;t++){let e=i[t];s.actions[e.name]=a.clipAction(e)}s.play=t=>{s.actions[t]&&(s.actions[t].paused=!1,s.actions[t].time=0,s.actions[t].play())},s.pause=(t,e=!0)=>{s.actions[t]&&(s.actions[t].paused=e)}}$t.add(i,s)}))},load_FBX:(t,e)=>{$t.loaderFBX().load(t,(function(t){$t.add(e,t)}))},load_OBJ:(t,e)=>{$t.loaderOBJ().load(t,(function(t){$t.add(e,t)}))},load_STL:(t,i)=>{$t.loaderSTL().load(t,(function(t){let s=new e.Mesh(t);$t.add(i,s)}))},load_KTX2:(t,e,i)=>{$t.loaderKTX2().load(t,(function(t){return $t.add(e,t),t}))},load_RGBE:(t,i)=>{$t.loaderRGBE().load(t,(function(t){t.mapping=e.EquirectangularReflectionMapping,$t.add(i,t)}))},load_EXR:(t,e,i)=>{$t.loaderEXR().load(t,(function(t){return i&&i(t),t}))},direct_EXR:(t,e)=>{$t.loaderEXR().parse(url,(function(t){return $t.add(e,t),t}))}};class te{constructor(t,i){this.target=i||t,this.baseGeometry=t.geometry,this.geometry=this.target.geometry,this.V=[new e.Vector3,new e.Vector3,new e.Vector3],this.X=[new e.Vector4,new e.Vector4,new e.Matrix4],this.M=[new e.Vector3,new e.Vector3,new e.Vector3],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const t=this.geometry;let i=t.attributes.position.array.length;t.setAttribute("color",new e.Float32BufferAttribute(new Array(i).fill(0),3))}resetEdge(t){let e=t.length;for(;e--;)t[e]=0}getEdge(t,e,i=!1,s=!1){let a=t.attributes.position.array;const r=t.index.array;let o,n,l,h,c,d,u,p=this.V[0],m=this.V[1],f=this.V[2],b=0;for(s&&(a=this.getMorph()),i&&(a=this.getSkinned(a)),(i||s)&&this.resetEdge(e),o=this.indexLength;o--;)n=r[b],l=r[b+1],h=r[b+2],p.fromArray(a,3*n),m.fromArray(a,3*l),f.fromArray(a,3*h),c=p.distanceTo(m),d=p.distanceTo(f),u=m.distanceTo(f),e[n]+=.5*(c+d),e[l]+=.5*(c+u),e[h]+=.5*(d+u),b+=3}isZero(t){return 0===t.x&&0===t.y&&0===t.z}getMorph(){const t=this.target.morphTargetInfluences,e=this.geometry.morphAttributes.position,i=t.length,s=this.geometry.attributes.position.array;let a,r,o,n,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],d=this.M[2],u=this.geometry.morphTargetsRelative;for(r=l;r--;){for(a=3*r,c.fromArray(s,a),h.set(0,0,0),o=i;o--;)0!=t[o]&&(n=e[o].data?e[o].data.array:e[o].array,u?h.addScaledVector(d.fromArray(n,a),t[o]):h.addScaledVector(d.fromArray(n,a).sub(c),t[o]));c.add(h),c.toArray(this.back,a)}return this.back}getSkinned(t){const e=this.target.skeleton;e.boneMatrices;const i=this.geometry,s=i.attributes.skinIndex.array,a=i.attributes.skinWeight.array,r=this.target.bindMatrix,o=this.target.bindMatrixInverse;let n,l,h,c,d,u=this.V[0],p=this.V[1],m=this.V[2],f=this.X[0],b=this.X[1],g=this.X[2];for(n=i.attributes.position.count;n--;){for(d=3*n,f.fromArray(s,4*n),b.fromArray(a,4*n),u.fromArray(t,d).applyMatrix4(r),p.set(0,0,0),l=4;l--;)c=b.getComponent(l),c>0&&(h=f.getComponent(l),g.multiplyMatrices(e.bones[h].matrixWorld,e.boneInverses[h]),p.addScaledVector(m.copy(u).applyMatrix4(g),c));p.applyMatrix4(o),p.toArray(this.back,d)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const t=this.geometry.attributes.color.array;let e,i,s,a=this.length;for(;a--;)e=this.originEdges[a],i=(e-this.targetEdges[a])/e+.5,s=3*a,t[s]=i>.5?2*(i-.5):0,t[s+1]=0,t[s+2]=i<.5?1-2*i:0;this.geometry.attributes.color.needsUpdate=!0}}class ee extends e.Object3D{constructor(t,i){super(),this.isReady=!1,this.skeleton=i,this.bones=this.skeleton.bones,this.root=t,this.box=new e.BoxGeometry,this.mtxr=new e.Matrix4,this.mtx0=new e.Matrix4,this.mtx1=new e.Matrix4,this.mtx=new e.Matrix4,this.mtx2=new e.Matrix4,this.p=new e.Vector3,this.s=new e.Vector3,this.q=new e.Quaternion,this.e=new e.Euler,this.mat=new e.MeshBasicMaterial({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(t){if(!this.isReady)return;let e,i,s=this.children,a=s.length;for(this.mtxr.copy(this.root.matrixWorld).invert();a--;)e=s[a],i=e.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,i.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,e.userData.decal),this.mtx.decompose(this.p,this.q,this.s),e.position.copy(this.p),e.quaternion.copy(this.q),e.updateMatrix();super.updateMatrixWorld(t)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const t=this.bones;let i,s,a,r,o,n,l,h,c,d,u,p=new e.Vector3,m=new e.Vector3,f=t.length;for(i=0;i<f;i++)h=null,r=t[i],s=r.name,o=r.parent,o&&(a=o.name,p.setFromMatrixPosition(o.matrixWorld),m.setFromMatrixPosition(r.matrixWorld),l=p.distanceTo(m),c=[0,0,.5*l],n=[l,1,1],d=[0,0,0],u="_C","head"===a&&"End_head"===s&&(h="box",n=[.16,.2,l],c=[0,.025,.5*-l]),"chest"===a&&"neck"===s&&(h="box",n=[.3,.28,l],c=[0,0,.5*-l]),"abdomen"===a&&(h="box",n=[.28,.24,l+.14],d[2]=0,c=[0,0,.5*-l],c[2]+=.07),"rThigh"===a&&(h="box",n=[.15,.15,l]),"lThigh"===a&&(h="box",n=[.15,.15,l]),"rShin"===a&&(h="box",n=[.12,.12,l+.1],c[2]+=.05),"lShin"===a&&(h="box",n=[.12,.12,l+.1],c[2]+=.05),"rShldr"===a&&(h="box",n=[l+.06,.12,.12],c[0]=.03-c[2],c[2]=0),"lShldr"===a&&(h="box",n=[l+.06,.12,.12],c[0]=c[2]-.03,c[2]=0),"rForeArm"===a&&(h="box",n=[l+.1,.1,.1],c[0]=-c[2]-.05,c[2]=0),"lForeArm"===a&&(h="box",n=[l+.1,.1,.1],c[0]=c[2]+.05,c[2]=0),null!==h&&this.addMesh(o,h,n,c,d,"_C"));this.isReady=!0}addMesh(t,i,s,a,r,o){this.mtx.makeTranslation(a[0],a[1],a[2]);var n=new e.Mesh(this.box,this.mat);n.scale.fromArray(s),n.userData.decal=this.mtx.clone(),n.userData.bone=t,n.userData.size=s,this.add(n)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const ie={mixRatio:0,threshold:.1,normal:.25,hair:7675906,bow:1049602,sheen:1,sheenRoughness:.6,metalness:.6,roughness:.4,vertexColors:!1,alphaTest:.1,h_metal:0,h_rough:.5,clearcoat:1,wireframe:!1,transparent:!1,opacity:1},se={refSize:1.81,isBreath:!1,isEyeMove:!1,haveHair:!0,haveBlink:!0,haveMorph:!0,morphNormal:!1,morphRelative:!1,haveLOD:!0,levelHigh:["body","Head","crane","eyelash","eyebrow","tear","eye_l","eye_r","eye_l_s","eye_r_s"],levelHair:["hair","hair_man"],levelLow:["body_low"],skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureQuality:2,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_t.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg","avatar_ao.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:ie,materialRef:"skin",materials:{skin:{type:"Sss",map:"avatar_c",normalMap:"avatar_n",reflectivity:.2,roughness:.54,metalness:.14,normalScale:new e.Vector2(ie.normal,-ie.normal),sheenColor:6291456,sheen:ie.sheen,sheenRoughness:ie.sheenRoughness,wireframe:ie.wireframe,aoMap:"avatar_ao",aoMapIntensity:1,vertexColors:!1,sssMap:"avatar_t",sssColor:new e.Color(15606563),sssAmbient:.5,sssDistortion:.6,sssAttenuation:.1,sssScale:6},mouth:{type:"Standard",map:"mouth_c",roughness:.02,metalness:0,vertexColors:!1,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n",normalScale:new e.Vector2(.5,-.5)},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:.1,clearcoat:1,transparent:!0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new e.Vector2(2,-2),clearcoat:.25},hair:{type:"Standard",color:ie.hair,aoMap:"hair",metalnessMap:"hair",roughness:.6,metalness:1,alphaMap:"hair_a",side:e.DoubleSide,shadowSide:e.DoubleSide,emissive:ie.hair,emissiveIntensity:.5,transparent:!0,blending:e.CustomBlending,blendDst:e.ZeroFactor,blendDstAlpha:e.SrcAlphaFactor,alphaToCoverage:!0},hair_man:{type:"Standard",color:ie.hair,aoMap:"hair_man",metalnessMap:"hair_man",roughness:.6,metalness:1,alphaMap:"hair_man_a",side:e.DoubleSide,transparent:!0,blending:e.CustomBlending,blendDst:e.ZeroFactor,blendDstAlpha:e.SrcAlphaFactor,forceSinglePass:!0,alphaToCoverage:!0},eyelash:{type:"Standard",color:ie.hair,map:"eyelash_c",alphaMap:"eyelash_a",transparent:!0,opacity:1,side:e.DoubleSide,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Standard",map:"eyelash_c",roughness:0,metalness:1,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic"}},changeMaterial:(t={},e=!1)=>{if(!$t.getMaterial(se.materialRef))return;const i=se.setting,s=se.materials;let a,r=!1;for(let e in t)void 0!==i[e]&&i[e]!==t[e]&&(i[e]=t[e],r=!0);if(r)for(let i in s){a=$t.getMaterial(i);for(let r in t)void 0!==a[r]&&(e&&s[i][r]?a[r]=s[i][r]:a[r]=t[r])}},applyMaterial:(t,e)=>{const i=!0,s=$t.getMaterial("skin");//!Human.haveLOD;
t.traverse((t=>{if(t.isMesh)switch(t.name){case"body":case"Head":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=i;break;case"body_low":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=!1;break;case"crane":t.material=s,t.receiveShadow=!0,t.castShadow=!1,t.visible=!se.haveHair;break;case"mouth":t.material=$t.getMaterial("mouth")||s,t.receiveShadow=!0,t.castShadow=!1,t.visible=i,t.geometry.computeVertexNormals();break;case"eyelash":case"eyebrow":t.material=$t.getMaterial("eyelash")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"tear":t.material=$t.getMaterial("tear")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"eye_l":case"eye_r":t.material=$t.getMaterial("eye")||s,t.receiveShadow=!1,t.castShadow=!1;break;case"eye_l_s":case"eye_r_s":t.material=$t.getMaterial("sub_eye")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"hair":t.material=$t.getMaterial("hair")||s,t.receiveShadow=!1,t.castShadow=!0,t.visible=!!se.haveHair&&i;break;case"hair_man":t.material=$t.getMaterial("hair_man")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=!!se.haveHair&&i}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,5]},{name:"rShldr",values:[-20,-2,-5]},{name:"lForeArm",values:[0,0,10]},{name:"rForeArm",values:[0,0,-10]},{name:"lHand",values:[0,15,10]},{name:"rHand",values:[0,-15,-10]},{name:"lThumb2",values:[0,25,10]},{name:"rThumb2",values:[0,-25,-10]}]},ae={wireframe:!1,normal:.25,hair:2433041},re={isBreath:!1,isEyeMove:!1,haveMorph:!0,skeletonRef:"body_low",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureRef:"avatar_c_0k",texturePath:"assets/textures/avatar/",textures:["avatar_c_0k.jpg","avatar_n_0k.jpg","avatar_ao_0k.jpg","hair_man_a_0k.jpg","Hair_01_c.png","Hair_01_n.png"],modelPath:"assets/models/avatar/",forceModel:null,setting:ae,materialRef:"skin_low",materials:{skin_low:{type:"Standard",map:"avatar_c_0k",aoMap:"avatar_ao_0k",normalMap:"avatar_n_0k",normalScale:new e.Vector2(ae.normal,-ae.normal),envMapIntensity:.3,roughness:.22,metalness:0,vertexColors:!1},hair_low:{type:"Standard",color:ae.hair,alphaMap:"hair_man_a_0k",transparent:!0},hair_low_2:{type:"Standard",color:ae.hair,map:"Hair_01_c",normalMap:"Hair_01_n"}},changeMaterial:(t={},e=!1)=>{if(!$t.getMaterial(re.materialRef))return;const i=Lee.materials;let s;for(let a in i){s=$t.getMaterial(a);for(let r in t)void 0!==s[r]&&(e&&i[a][r]?s[r]=i[a][r]:s[r]=t[r])}},applyMaterial:(t,e)=>{const i=$t.getMaterial(re.materialRef);t.traverse((t=>{if(t.isMesh)switch(t.name){case"body_low":t.material=i,t.receiveShadow=!0,t.castShadow=!0;break;case"hair_low":t.material=$t.getMaterial("hair_low")||i,t.receiveShadow=!1,t.castShadow=!1;break;case"hair_low_2":t.material=$t.getMaterial("hair_low_2")||i,t.receiveShadow=!1,t.castShadow=!1}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,0]},{name:"rShldr",values:[-20,-2,0]}]},oe={metalness:.33,roughness:.11,clearcoat:0,wireframe:!1},ne={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg","eva_ao.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:oe,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:oe.roughness,metalness:oe.metalness,wireframe:oe.wireframe,clearcoat:oe.clearcoat,aoMap:"eva_ao"},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:oe.roughness,metalness:oe.metalness,wireframe:oe.wireframe,clearcoat:oe.clearcoat,aoMap:"eva_ao"},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:oe.roughness,metalness:oe.metalness,wireframe:oe.wireframe,clearcoat:oe.clearcoat,aoMap:"eva_ao"}},changeMaterial:(t,e=!1)=>{if(!$t.getMaterial(ne.materialRef))return;const i=ne.materials;let s;for(let a in i){s=$t.getMaterial(a);for(let r in t)void 0!==s[r]&&(e&&i[a][r]?s[r]=i[a][r]:s[r]=t[r]);s.needsUpdate=!0}},applyMaterial:(t,e)=>{const i=$t.getMaterial(e);t.traverse((t=>{if(t.isMesh)switch(t.material=i,t.receiveShadow=!0,t.castShadow=!0,t.name){case"eva_2_head":case"eva_2_mach":t.visible="eva02"===e;break;case"eva_L_COLLAR":case"eva_R_COLLAR":t.visible="eva00"!==e;break;case"eva_HEAD":case"eva_MACHOIR":t.visible="eva01"===e;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":t.visible="eva00"===e;break;case"eva_0_CHEST2":t.visible="eva01"!==e}}))}},le={metalness:.2,roughness:.8,wireframe:!1},he={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:le,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:le.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{if(!$t.getMaterial(he.materialRef))return;const i=he.materials;let s;for(let a in i){s=$t.getMaterial(a);for(let r in t)void 0!==s[r]&&(e&&i[a][r]?s[r]=i[a][r]:s[r]=t[r])}},applyMaterial:(t,e)=>{const i=$t.getMaterial("lee_material");t.traverse((t=>{t.isMesh&&(t.material=i,t.receiveShadow=!0,t.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},ce={metalness:.2,roughness:.8,wireframe:!1},de={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"barbados",multyMaterial:!0,fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:[],modelPath:"assets/models/",forceModel:"barbados",setting:ce,materialRef:"bb",materials:{bb:{type:"Physical",roughness:.3,metalness:.08,wireframe:ce.wireframe,sheen:2.2,sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{},applyMaterial:(t,e)=>{},adjustment:()=>[]},ue=1/30,pe=Math.PI/180,me=180/Math.PI,fe=new e.Vector3,be={tmp:[],model:[],avatar:null,callback:()=>{},add:(t,e)=>{be.tmp=[...t],be.callback=e,be.tmp.length&&be.loadOne()},loadOne:()=>{let t=be.tmp[0];be.avatar=new ge({type:t,callback:be.next,morph:!0,isPreload:!0})},next:t=>{be.avatar.dispose(),be.tmp.shift(),0===be.tmp.length?be.callback():be.loadOne()}};class ge extends e.Group{constructor(t={}){switch(super(),this.isPreload=t.isPreload||!1,this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.rootPath=t.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",this.callback=t.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.randomMorph=t.randomMorph||!1,this.randomSize=t.randomSize||!1,this.actionPose=null,this.model=t.type||"man",this.startAnimation=t.anim||"idle",this.bodyMorph=[0,0],this.faceMorph=[0,0],this.ref=null,this.model){case"barbados":this.ref=de;break;case"lee":this.ref=he;break;case"man":case"woman":this.ref=se;break;case"man_low":case"woman_low":this.ref=re;break;case"eva00":case"eva01":case"eva02":this.ref=ne}this.compact=void 0===t.compact||t.compact,this.haveMorph=void 0!==t.morph&&t.morph,this.fullMaterial=void 0===t.material||t.material,this.size=t.size||1,this.realSize=0,this.baseSize=0,this.fullMorph=this.ref.fullMorph||[],this.randomMorph&&this.fullMorph.length&&(this.haveMorph=!0),this.textureQuality=this.ref.textureQuality||0,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.haveBlink=this.ref.haveBlink||!1,this.haveLOD=this.ref.haveLOD||!1,t.noLOD&&(this.ref.haveLOD=!1,this.haveLOD=!1),this.lod=-1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new e.Quaternion).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new e.Vector3,this.eyeTarget=new e.Group,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new e.Matrix4,this.tmpQ=new e.Quaternion,this.setting={},this.root=$t.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=g.clone(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}rand(t=0,e=1){return t+Math.random()*(e-t)}load(){if(this.ref.textures&&this.ref.textures.length)if(this.skin=$t.getTexture(this.ref.textureRef,{quality:this.textureQuality}),this.skin)this.loadModels();else{const t=this.rootPath+this.ref.texturePath+(this.textureQuality?this.textureQuality+"k/":"");$t.load(this.ref.textures,this.loadModels.bind(this),t,"loading images...",this.textureQuality)}else this.loadModels()}loadModels(){const t=this.ref.forceModel?this.ref.forceModel:this.model,e=[t+".glb"],i=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&e.push(t+"_morph.glb"),$t.load(e,this.init.bind(this),i,"loading models...")}update(t){this.done&&this.mixer&&(this.mixer.update(t),this.haveBlink&&this.eyeBlink(),this.isClone||(this.look(10*t),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),this.actionPose&&this.actionPose.setEffectiveWeight(this.getAction("idle")._effectiveWeight),window.gui&&window.gui.updateTimeBarre&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax))}eyeBlink(){const t=this.n++;let e=0;t<=10&&(e=.1*t),t>10&&t<=20&&(e=1-.1*(t-10)),this.n>500&&(this.n=0),this.setMorph("EyeBlink",e)}look(t){if(!this.isEyeMove)return;if(this.isPause)return;const e=window.mouse||{x:0,y:0};t>1&&(t=1),this.headBoneLook.lerp({x:-20*e.y*pe,y:0,z:-20*e.x*pe},t),this.eyeTarget.position.lerp({x:.5*e.x,y:1,z:.25*-e.y},t);let i=this.headBoneLook;this.tmpQ.setFromEuler({_x:i.x,_y:i.y,_z:i.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let s=this.bones.ER,a=this.bones.EL,r={x:0,y:0,z:1};this.tmpMtx.lookAt(a.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),r),a.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(s.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),r),s.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let t=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,t),this.lerp(1,1.04,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,t),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,t),this.lerp(1.04,1,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,t),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(t,e,i){this.position.set(t,e,i),this.updateMatrix()}setRotation(t,e,i,s){let a=this.lerp(this.rotation.y,e,s);this.rotation.set(t,a,i),this.updateMatrix()}lerp(t,e,i){return(1-i)*t+i*e}onReady(){}initMaterial(){if($t.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void $t.set(this.ref.materialRef,new e.MeshStandardMaterial);let t,i,s;for(const a in this.ref.materials){s={...this.ref.materials[a]},i=s.type,delete s.type;for(const t in s)"envMapIntensity"!==t&&"normalMapType"!==t&&"aoMapIntensity"!==t&&"aoMapIntensity"!==t&&("map"!==t&&-1===t.search("Map")||(s[t]=$t.getTexture(s[t],{quality:this.textureQuality})));"Basic"===i?t=new e.MeshBasicMaterial(s):"Standard"===i?t=new e.MeshStandardMaterial(s):"Physical"===i?t=new e.MeshPhysicalMaterial(s):"Sss"===i&&(t=new J(s)),t.name=a,$t.set(a,t)}this.setting=this.ref.setting}setMaterial(t,e){let i=$t.getMaterial(this.ref.materialRef);if(i)for(let e in t)void 0!==i[e]&&(i[e]=t[e])}setMaterialNormal(t){let e=$t.getMaterial("skin");e&&(t<0&&(t=0),e.normalScale.set(t,-t))}getMaterial(t){return $t.getMaterial(t)}init(){if(this.initMaterial(),!this.isClone){let t=this.ref.forceModel?this.ref.forceModel:this.model;this.ref.multyMaterial&&$t.getMesh(t,!0),this.root=$t.get(t,"O"),this.ref.applyMaterial(this.root,this.model)}this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.realSize=0,this.root.traverse(function(t){t.raycast=function(){},t.isMesh&&(t.name===this.ref.skeletonRef&&(t.matrixAutoUpdate=!1,this.skeleton=t.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling(),this.realSize=t.geometry.boundingBox.max.y),"Head"===t.name&&(this.realSize=t.geometry.boundingBox.max.y),this.mesh[t.name]=t),t.isBone&&(this.bones[t.name]=t)}.bind(this)),this.realSizeRatio=1/this.realSize,this.baseSize=this.realSize,this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let t in this.mesh)this.mesh[t].isSkinnedMesh&&t!==this.ref.skeletonRef&&(this.mesh[t].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&$t.applyMorph(this.model+"_morph",this.mesh,this.ref.morphNormal,this.ref.morphRelative),$t.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new e.AnimationMixer(this),0===$t.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let t=$t.clip.length;for(;t--;)this.addAction($t.clip[t]);this.start()}}setRealSize(t){this.realSize=t;let e=.5+this.baseSize/this.realSize*.5;this.setSize(this.realSize*this.realSizeRatio),this.setHeadSize(e)}setSize(t){this.size=t,this.root.scale.set(1,1,1).multiplyScalar(this.size)}setHeadSize(t){this.bones.head.scale.set(1,1,1).multiplyScalar(t)}addTensionMap(){this.tension1=new te(this.mesh.body),this.tension2=new te(this.mesh.Head)}setBounding(t){for(let e in this.mesh)this.mesh[e].isMesh&&(this.mesh[e].geometry.boundingSphere.radius=t)}setLevel(t){this.haveLOD&&this.lod!==t&&(this.lod=t,this.hideAll(),0===this.lod?this.setVisible(this.ref.levelLow,!0):(this.setVisible(this.ref.levelHigh,!0),this.ref.haveHair&&this.setVisible(this.ref.levelHair,!0)))}hideAll(){for(let t in this.mesh)this.mesh[t].visible=!1}setVisible(t,e){"string"==typeof t&&(t=[t]);let i,s=t.length;for(;s--;)i=t[s],this.mesh[i]&&(this.mesh[i].visible=e)}setMorph(t,e){e=e<0?0:e,this.haveMorph&&(this.morpher("eyelash",t,e),this.morpher("eyebrow",t,e),this.morpher("tear",t,e),this.morpher("mouth",t,e),this.morpher("body",t,e),this.morpher("Head",t,e),this.morpher("body_low",t,e))}morpher(t,e,i){this.mesh[t]&&this.mesh[t].morphTargetInfluences&&void 0!==this.mesh[t].morphTargetDictionary[e]&&(this.mesh[t].morphTargetInfluences[this.mesh[t].morphTargetDictionary[e]]=i)}lerp(t,e,i){return(1-i)*t+i*e}clone(t){return new this.constructor({type:t.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent&&this.parent.remove(this),this.isClone}start(){this.isPreload?this.callback():this.done||(this.done=!0,this.onReady(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment(),!0),this.randomMorph&&this.setBodyMorph([this.rand(-1,1),this.rand(-1,1)]),this.randomSize&&this.setRealSize(this.rand(1,2)),setTimeout(function(){this.add(this.root),this.callback()}.bind(this),100))}setBodyMorph(t){if(!this.haveMorph)return;t&&(this.bodyMorph=t);let e=Number(this.bodyMorph[0]),i=Number(this.bodyMorph[1]);this.setMorph("MUSCLE",i<0?-i:0),this.setMorph("LOW",i>=0?i:0),this.setMorph("BIG",e<0?-e:0),this.setMorph("MONSTER",e>=0?e:0);let s=.5*(e+1),a=1-.5*(i+1);this.setMaterialNormal(.5*(a+s))}setFaceMorph(t){if(!this.haveMorph)return;t&&(this.faceMorph=t);let e=Number(this.faceMorph[0]),i=Number(this.faceMorph[1]);this.setMorph("Shock",i<0?-i:0),this.setMorph("Frown",i>=0?i:0),this.setMorph("SmileOpen",e<0?-e:0),this.setMorph("Angry",e>=0?e:0)}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new e.SkeletonHelper(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new ee(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(t,e){t.matrix=e.matrixWorld,t.matrixAutoUpdate=!1}loadAnimationJson(t,e){const i=new XMLHttpRequest;i.open("GET",t,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){let t=JSON.parse(i.responseText);this.urls=[];for(let e in t)"main"===e?this.urls.push(...t[e]):this.urls.push(...t[e].map((t=>e+"/"+t)));this.endCallback=e||function(){},this.loadOne()}}.bind(this),i.send()}loadOne(){let t=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+t+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(t="./assets/models/animations.bin"){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer";const s={animations:[]},a=this;i.onload=function(){Yt.decompress(i.response,(t=>{const i=JSON.parse(t);for(let t in i)s.animations.push(e.AnimationClip.parse(i[t]));a.applydAnimation(s),a.start()}))},i.send()}loadAnimationGlb(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));$t.loaderGLTF().load(t,function(t){this.applydAnimation(t,i),e&&e()}.bind(this),null,e)}directGlb(t,e){$t.loaderGLTF().parse(t,"",function(t){this.stop(),this.applydAnimation(t,e)}.bind(this))}loadAnimationFbx(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));$t.loaderFBX().load(t,function(t){this.convertFbx(i,t.animations[0]),e&&e()}.bind(this),null,e)}directFbx(t,e){try{let i=$t.loaderFBX().parse(t,"");this.convertFbx(e,i.animations[0],!0)}catch(t){console.error("bug",t)}}applydAnimation(t,e){let i=t.animations.length,s=!1;for(1===i&&(e&&(t.animations[0].name=e),s=!0);i--;)this.addClip(t.animations[i]),this.addAction(t.animations[i],s)}addClip(t,i=!1){i&&e.AnimationUtils.makeClipAdditive(t);let s=$t.clip.length,a=-1;for(;s--;)$t.clip[s].name===t.name&&(a=s);-1!==a&&$t.clip.slice(a,1),$t.clip.push(t)}addAction(t,e){const i=this.mixer.clipAction(t);i.frameMax=Math.round(30*t.duration),i.play(),i.enabled=!0,-1!==t.name.search("idle")&&(i.enabled=!0),"Jumping Up"===t.name&&(i.loop=LoopPingPong),this.actions.set(t.name,i),window.gui&&window.gui.getAnimation&&window.gui.getAnimation()}getAnimation(t=!1,e=!1){let i=[],s=0;if(e){let e=$t.clip.length;for(;e--;)i[s]=t?$t.clip[s].toJSON():$t.clip[s],s++}else this.actions.forEach((function(e,a){i[s]=t?e._clip.toJSON():e._clip,s++}));return i}exportAnimationLzma(t){this.lzma||(this.lzma=new Yt(this.lzmaPath));const e=this.getAnimation(!0);this.lzma.compress(JSON.stringify(e),2,(function(e){if(t)t({name:"animations",data:new Uint8Array(e),type:"bin"});else{let t=document.createElement("a");t.style.display="none",document.body.appendChild(t),t.href=URL.createObjectURL(new Blob([new Uint8Array(e)],{type:"application/octet-stream"})),t.download="animations.bin",t.click()}}))}armAngle(){}autoToes(){if(!this.fixToe)return;let t=this.getRot("rFoot"),e=this.getRot("lFoot"),i=this.getWorldPos("hip"),s=this.getWorldPos("rToes"),a=this.getWorldPos("lToes");t[0]>0&&s.z-i.z<0?this.setRot("rToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("rToes",0,0,0),e[0]>0&&a.z-i.z<0?this.setRot("lToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(t,i,s){const a=Math.PI/180;let r=new e.Vector3,o=new e.Quaternion,n=(new e.Quaternion).setFromAxisAngle({x:1,y:0,z:0},90*a);const l=i.tracks,h=[];let c,d,u,p,m=l.length,f=0;for(;m--;){if(u=l[f],p=u.name.substring(0,u.name.lastIndexOf(".")),"hip.position"===u.name){let t=[];for(c=u.values.length/3;c--;)d=3*c,r.set(u.values[d],u.values[d+1],0).multiplyScalar(.01),r.toArray(t,d);h.push(new e.VectorKeyframeTrack(u.name,u.times,t))}else{let t=[];for(c=u.values.length/4;c--;)d=4*c,"hip"===p?o.set(u.values[d],u.values[d+1],u.values[d+2],u.values[d+3]).multiply(n):o.set(u.values[d],u.values[d+2],-u.values[d+1],u.values[d+3]),o.toArray(t,d);h.push(new e.QuaternionKeyframeTrack(u.name,u.times,t))}f++}let b=new e.AnimationClip(t,-1,h);b.duration=i.duration,this.stop(),this.addClip(b),this.addAction(b,s)}makePoseTrack(t,i,s=!1){const a=Math.PI/180;let r=new e.Quaternion;const o=i,n=[];let l,h,c,d,u=o.length,p=0;for(;u--;){d=o[u],d.name;let t=[],i=[];for(p=0,l=3;l--;)h=0,c=4*p,i.push(.03333333507180214*p),r.setFromEuler({_x:d.values[0]*a,_y:d.values[1]*a,_z:d.values[2]*a,_order:"XYZ"}),r.toArray(t,c),p++;n.push(new e.QuaternionKeyframeTrack(d.name+".quaternion",i,t))}let m=s?e.AdditiveAnimationBlendMode:e.NormalAnimationBlendMode,f=new e.AnimationClip(t,-1,n,m);f.duration=.10000000521540642;const b=this.mixer.clipAction(f);b.enabled=!0,b.setEffectiveTimeScale(1),b.setEffectiveWeight(1),b.play(),this.actionPose=b}prepareCrossFade(t,e,i){this.isPause=!1,this.unPause(),"idle"!==e._clip.name?this.executeCrossFade(t,e,i):this.synchronizeCrossFade(t,e,i)}synchronizeCrossFade(t,e,i){this.mixer.addEventListener("loop",(function a(r){r.action===t&&(s.mixer.removeEventListener("loop",a),s.executeCrossFade(t,e,i))}));const s=this}executeCrossFade(t,e,i,s=!0){this.setWeight(e,1),e.time=0,t.crossFadeTo(e,i,!0)}pause(){this.actions.forEach((function(t){t.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(t){t.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(t){t.play()}))}setTimescale(t){this.actions.forEach((function(e){e.setEffectiveTimeScale(t)}))}syncro(t){let e=this.getAction(t);if(!e)return;let i=e.time;this.actions.forEach((function(t){t.time=i}))}setWeight(t,e){t.enabled=!0,e<0&&(e=0),e>1&&(e=1),t.setEffectiveWeight(e)}getAnimInfo(t){let e=this.getAction(t);if(e)return{name:t,time:e.time,frame:Math.round(30*e.time),frameMax:e.frameMax,timeScale:e.timeScale}}getAction(t){return this.actions.get(t)}play(t,e=.5){let i=this.getAction(t);if(!i)return!1;if(this.current){if(this.current!==i){this.old=this.current,this.current=i;let s="idle"===this.current.getClip().name;s="idle"===this.old.getClip().name,-1!==this.clipsToesFix.indexOf(t)?this.fixToe=!0:this.resetToes();let a=this.old.getEffectiveWeight(),r=this.current.getEffectiveWeight(),o=this.current.time;if(!s){let t=this.current.getClip().duration/this.old.getClip().duration;o=this.old.time*t}this.current.reset(),this.current.time=o,this.fixWeight?(this.current.weight=1,this.current.stopFading(),this.old.stopFading(),this.old._scheduleFading(e,a,0),this.current._scheduleFading(e,r,1)):this.executeCrossFade(this.old,this.current,e)}}else this.stop(),this.current=i,i.setEffectiveWeight(1);return this.isPause=!1,!0}playFrame(t,e,i=1){let s=this.getAction(t);s&&(s.time=e*ue,s.setEffectiveWeight(i),s.play(),s.paused=!0,this.isPause=!0)}playOne(t,e=1){this.current&&(this.current.time=t*ue,this.current.setEffectiveWeight(e),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(t){t.setEffectiveWeight(0)}))}setRot(t,e,i,s){let a=this.bones[t];a&&(a.rotation.set(e*pe,i*pe,s*pe,"XYZ"),a.updateMatrix())}setRot2(t,i,s,a){let r=this.bones[t];if(!r)return;let o=(new e.Quaternion).setFromEuler({_x:i*me,_y:s*me,_z:a*me,_order:"XYZ"}).invert();r.quaternion.premultiply(o),r.updateMatrix()}getRot(t){let e=this.bones[t];if(!e)return;let i=e.rotation.toArray();return[Math.round(i[0]*me),Math.round(i[1]*me),Math.round(i[2]*me)]}getWorldPos(t){let e=this.bones[t];if(e)return fe.set(0,0,0),e.localToWorld(fe),{x:fe.x,y:fe.y,z:fe.z}}bodyMask(t={arm:!0,leg:!0,foot:!0,chest:!0}){let i=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const s=this.canvas.getContext("2d");s.fillStyle="#FFFFFF",s.fillRect(0,0,256,256),s.fillStyle="black",t.arm&&s.fillRect(196,112,59,46.5),t.leg&&s.fillRect(128,183.5,71.75,72.5),t.foot&&s.fillRect(817*i,205.5,51.5,50),t.chest&&(s.fillRect(120,144,75,40),s.fillRect(553*i,116.5,57,27.5),s.fillRect(533*i,531*i,5,45*i));let a=new Image;a.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new e.Texture(a),this.mask.flipY=!1,this.mask.needsUpdate=!0;const r=$t.getMaterial("skin");r.alphaTest=.9,r.alphaMap=this.mask}zeroColor(t){t.isMesh&&(t=t.geometry);let i=t.attributes.position.array.length;t.setAttribute("color",new e.Float32BufferAttribute(new Array(i).fill(0),3))}}class ye extends e.Object3D{constructor(t={},i){super(),this.motor=i,this.utils=this.motor.utils,this.isCharacter=!0,this.isPlayer=!1,this.enable=!1,this.useImpulse=t.useImpulse||!1,this.useFloating=t.floating||!1,this.waitRotation=!1;let s=.3,a=t.radius||.3,r=t.height||1.8;this.realHeight=r,this.useFloating&&(r-=s),this.option={debug:!1,capsuleHalfHeight:.5*r,capsuleRadius:a,floatHeight:s,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-r,z:0},rayHitForgiveness:.1,rayLength:a+2,rayDir:{x:0,y:-1,z:0},floatingDis:a+s+.08,springK:2,dampingC:.2,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:a-.03,slopeRayLength:a+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:1.2,autoBalanceDampingC:.04,autoBalanceSpringOnY:.7,autoBalanceDampingOnY:.05,animated:!1,mode:null},this.v={movingObjectVelocityInCharacterDir:new e.Vector3,movingObjectVelocity:new e.Vector3,standingForcePoint:new e.Vector3,pivotPosition:new e.Vector3,modelQuat:new e.Quaternion,moveImpulse:new e.Vector3,impulseCenter:new e.Vector3,movingDirection:new e.Vector3,moveAccNeeded:new e.Vector3,jumpVelocityVec:new e.Vector3,jumpDirection:new e.Vector3,currentVel:new e.Vector3,currentPos:new e.Vector3,dragForce:new e.Vector3,dragAngForce:new e.Vector3,wantToMoveVel:new e.Vector3,rejectVel:new e.Vector3,floatingForce:null,springDirVec:new e.Vector3,rayOrigin:new e.Vector3,characterMassForce:new e.Vector3,slopeAngle:null,actualSlopeNormal:new e.Vector3,actualSlopeAngle:null,actualSlopeNormalVec:new e.Vector3,floorNormal:new e.Vector3(0,1,0),slopeRayOriginRef:new e.Vector3,slopeRayorigin:new e.Vector3,canJump:!1,isFalling:!1,isOnMovingObject:!1},this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.type="character",this.name=t.name||"hero",t.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.running=!1,this.wantJump=!1,this.radius=a,this.height=r,this.mass=t.mass||.84,delete t.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-1.2,this.maxRayDistance=this.height,this.contact=!1,this.velocity=new e.Vector3,this.angular=new e.Vector3,this.tmpV1=new e.Vector3,this.tmpV2=new e.Vector3,this.ease=new e.Vector3,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(t.angle||0)*x,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=t.ray||!1,this.callback=t.callback||function(){},t.callback&&delete t.callback,this.initPhysic(t)}setHeight(t){this.model&&this.model.setRealSize(t)}reSizePhysics(t){if(t===this.realHeight)return;this.realHeight=t,this.height=this.realHeight-(this.useFloating?this.option.floatHeight:0);let e=this.position.toArray();e[1]+=.5*this.height+(this.useFloating?this.option.floatHeight:0);let i=[this.radius,this.height-2*this.radius];this.phyData.pos=e,this.phyData.size=i,this.motor.post({m:"add",o:this.phyData})}initPhysic(t){t.size||(t.size=[this.radius,this.height-2*this.radius]),t.pos||(t.pos=[0,0,0]),t.pos[1]+=.5*this.height,this.useFloating&&(t.pos[1]+=this.option.floatHeight),this.globalRay&&this.motor.getGeometryRef({...t,type:"capsule",ray:!0},this,this.motor.mat.get("hide")),this.phyData={name:this.name,size:t.size,pos:t.pos,type:"character",shapeType:t.shapeType||"capsule",density:1,mass:this.mass,friction:void 0!==t.friction?t.friction:.5,angularFactor:[0,0,0],group:16,regular:!0,massInfo:t.massInfo},"HAVOK"===this.motor.engine&&(this.phyData.inertia=[0,0,0]),t.mask&&(this.phyData.mask=t.mask),this.motor.getCharacterRef().addToWorld(this,t.id),this.motor.post({m:"add",o:this.phyData}),this.useFloating&&(this.ray=this.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name})),t.gender?this.addModel(t):this.showHelper(!0),this.enable=!0}extraRemove(){this.ray&&this.motor.remove(this.name+"_ray")}selfRay(t){t.hit?(this.distance=t.distance,this.rayAngle=t.angle):(this.distance=this.option.rayLength,this.rayAngle=0)}hit(t){this.contact=t}showHelper(t){t?this.helper||(this.helper=new ct(this.radius,this.height,!0,this.motor.mat.get("line"),[1,.6,0],[.6,.2,0]),this.helper.setDirection(this.angle),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=t)}addSkeleton(){this.skeletonBody||this.model&&(this.skeletonBody=new Ut(this.motor,this.name,this.model.root,this.model.skeleton.bones),this.motor.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(t=!1){this.skeletonBody&&this.skeletonBody.isVisible(t),this.model&&this.skeletonBody&&this.model.setMaterial({transparent:t,opacity:t?.8:1},!t),this.showHelper(t)}setMode(t){this.skeletonBody&&this.skeletonBody.setMode(t)}addModel(t){this.model=new ge({type:t.gender,anim:void 0!==t.anim?t.anim:"idle",compact:!0,material:!t.noMat,morph:t.morph||!1,randomMorph:t.randomMorph||!1,randomSize:t.randomSize||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:t.noLOD||!1}),this.add(this.model);let e=-.5*this.height;this.useFloating&&(e-=this.option.floatHeight),this.model.setPosition(0,this.model.decalY+e,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(t,e){this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.velocity.fromArray(t,e+8),this.angular.fromArray(t,e+11),this.fall=this.position.y<this.oy,this.floor=A.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.model&&(this.model.update(this.motor.delta),this.getDistanceToCamera()),this.useFloating&&!this.isPlayer&&(this.stopMoving(),this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()})),this.updateMatrix()}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const t=this.motor.getCamera();this.tmpV1.copy(this.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let e=this.tmpV1.distanceTo(this.tmpV2)/t.zoom>3?0:1;this.model.setLevel(e)}set(t){t.morph&&this.model&&this.model.setMorph(t.morph,t.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper()}onFrame(t,e){this.v,this.option}autoBalance(){const t=this.v,e=this.option,i=this.rotation;t.dragAngForce.set(-e.autoBalanceSpringK*i.x-this.angular.x*e.autoBalanceDampingC,-e.autoBalanceSpringK*i.y-this.angular.y*e.autoBalanceDampingOnY,-e.autoBalanceSpringK*i.z-this.angular.z*e.autoBalanceDampingC)}moveCharacter(t,e=0){const i=this.v,s=this.option,a=this.motor.getKey();this.motor.getAzimut(),i.currentPos.copy(this.position),i.slopeAngle=0,i.actualSlopeAngle<s.slopeMaxAngle&&Math.abs(i.slopeAngle)>.2&&Math.abs(i.slopeAngle)<s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle),Math.cos(i.slopeAngle)):i.actualSlopeAngle>=s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle)>0?0:Math.sin(i.slopeAngle),Math.sin(i.slopeAngle)>0?.1:1):i.movingDirection.set(0,0,1),i.movingDirection.applyAxisAngle({x:0,y:1,z:0},e),i.movingObjectVelocityInCharacterDir.copy(i.movingObjectVelocity).projectOnVector(i.movingDirection).multiply(i.movingDirection);const r=i.movingObjectVelocity.angleTo(i.movingDirection),o=i.currentVel.dot(i.movingDirection);i.wantToMoveVel.set(i.movingDirection.x*o,0,i.movingDirection.z*o),i.rejectVel.copy(i.currentVel).sub(i.wantToMoveVel),i.moveAccNeeded.set((i.movingDirection.x*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.x)-(i.currentVel.x-i.movingObjectVelocity.x*Math.sin(r)+i.rejectVel.x*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime,0,(i.movingDirection.z*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.z)-(i.currentVel.z-i.movingObjectVelocity.z*Math.sin(r)+i.rejectVel.z*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime);const n=i.moveAccNeeded.multiplyScalar(this.mass);let l=!0;this.waitRotation&&(l=Math.sin(e).toFixed(3)==Math.sin(this.rotation.y).toFixed(3)),l?i.moveImpulse.set(n.x*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),n.z*(i.canJump?1:s.airDragMultiplier)):i.moveImpulse.set(n.x*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*s.turnVelMultiplier*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),n.z*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier)),i.impulseCenter.set(i.currentPos.x,i.currentPos.y+s.moveImpulsePointY,i.currentPos.z),i.currentVel.copy(this.velocity),a[4]&&i.canJump&&(i.jumpVelocityVec.set(i.currentVel.x,this.running?s.sprintJumpMult*s.jumpVel:s.jumpVel,i.currentVel.z),i.moveImpulse.y=i.jumpVelocityVec.y)}getFloating(){const t=this.v,e=this.option,i=e.springK*(e.floatingDis-this.distance)-this.velocity.y*e.dampingC;t.moveImpulse.y=i*this.mass}stopMoving(){this.v,this.option,this.v.moveImpulse.set(0,0,0),this.tmpV1.copy(this.velocity),this.tmpV1.x*=.9,this.tmpV1.z*=.9,this.tmpV1.x+this.tmpV1.z!==0&&this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!1})}move(){this.v;const t=this.motor.getKey(),e=this.motor.getAzimut(),i=this.motor.delta;let s=0!==t[7]?"run":"walk";0===t[0]&&0===t[1]&&(s="idle");let a=0!==t[0]&&0!==t[1]?this.diagonal:1;t[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===t[5]&&(this.toggle=!0),"walk"!==s&&"run"!==s||!this.crouch||(s="crouch"),1===t[6]&&(s="fight"),!this.jump&&t[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let r="idle";switch(s){case"idle":r=this.crouch?"Crouch Idle":"idle";break;case"walk":r="Jog Forward";break;case"run":r="Standard Run";break;case"crouch":r="Crouch Walk";break;case"fight":r="Attack"}this.moving=0!==t[0]||0!==t[1],this.running=0!==t[7],this.wantJump=0!==t[4];let o=A.unwrapRad(Math.atan2(t[0],t[1])+e);if(this.useImpulse)this.moving?this.moveCharacter(i,o):this.stopMoving(),this.useFloating&&this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()});else{this.tmpAcc+=4*i;const r=1;let o=this.speed[s]*r;this.moving&&(this.rs=t[0]*o,this.ts=t[1]*o),0===t[0]&&0===t[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*a),this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let n=this.vy-9.81;this.ease.y=n,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},e),this.tmpV2.set(0,0,0),this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()})}if(this.helper&&(this.helper.updateMatrix(),this.helper.cone.rotation.y=e,"idle"!==s&&this.helper.setDirection(o)),this.model&&(this.jump?this.model.play("Jump",.5):this.model.play(r,.75),"idle"!==s)){let t=A.unwrapRad(this.model.rotation.y),i=A.nearAngle(o,t),a=Math.abs(Math.floor((t-i)*math.todeg)/180);this.model.rotation.y="fight"===s?e+Math.PI:A.lerp(t,i,.2-.1*a),this.model.updateMatrix()}}}class xe extends rt{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="character",this.num=C[this.type]}step(t,e){let i,s,a=this.list.length;for(;a--;)s=this.list[a],i=e+a*this.num,s&&s.step(t,i)}add(t={}){this.setName(t);return new ye(t,this.motor)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const ve={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),toFixed:(t,e=3)=>1*t.toFixed(e),int:t=>Math.floor(t),lerp:(t,e,i)=>(1-i)*t+i*e,clamp:(t,e,i)=>Math.max(e,Math.min(i,t)),nearEquals:(t,e,i)=>Math.abs(t-e)<=i,lerpAr:(t,e,i,s)=>{let a=t.length;for(;a--;)t[a]=ve.lerp(e[a],i[a],s)},unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),scaleArray:(t,e)=>{for(var i=t.length;i--;)t[i]*=e;return t},addArray:(t,e)=>{for(var i=[],s=t.length;s--;)i[s]=t[s]+e[s];return i},angleDistance:(t,e)=>{var i=(t-e+180)%360-180;return i<-180?i+360:i},tmpE:new e.Euler,tmpM:new e.Matrix4,tmpM2:new e.Matrix4,tmpV:new e.Vector3,tmpQ:new e.Quaternion,fromTransformToQ:(t,e,i)=>(i=i||!1,ve.tmpM.compose(ve.tmpV.fromArray(t),ve.tmpQ.fromArray(e),{x:1,y:1,z:1}),ve.tmpM.decompose(ve.tmpV,ve.tmpQ,{x:1,y:1,z:1}),i&&ve.tmpQ.invert(),ve.tmpQ.toArray()),fromTransform:(t,e,i,s,a)=>(a=a||!1,s=s||[0,0,0,1],ve.tmpM.compose(ve.tmpV.fromArray(t),ve.tmpQ.fromArray(e),{x:1,y:1,z:1}),ve.tmpM2.compose(ve.tmpV.fromArray(i),ve.tmpQ.fromArray(s),{x:1,y:1,z:1}),a?(ve.tmpM.invert(),ve.tmpM.multiply(ve.tmpM2)):ve.tmpM.multiply(ve.tmpM2),ve.tmpM.decompose(ve.tmpV,ve.tmpQ,{x:1,y:1,z:1}),ve.tmpV.toArray()),arCopy:(t,e)=>{},axisToQuatArray:(t,e)=>(e=e||!1,ve.tmpQ.setFromAxisAngle(ve.tmpV.fromArray(t,1),e?t[0]*ve.torad:t[0]).normalize().toArray()),toQuatArray:t=>ve.tmpQ.setFromEuler(ve.tmpE.fromArray(ve.vectorad(t))).toArray(),vectorad:t=>{let e=3,i=[];for(;e--;)i[e]=t[e]*ve.torad;return i[3]=t[3],i},rgbToHex:t=>"0x"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),hexToRgb:t=>[((t=Math.floor(t))>>16&255)/255,(t>>8&255)/255,(255&t)/255],htmlToHex:t=>t.toUpperCase().replace("#","0x"),hexToHtml:t=>"#"+("000000"+(t=void 0===t?0:t).toString(16)).substr(-6),rgbToHtml:t=>"#"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==ve.perlin&&(ve.perlin=null)},noise:(t,e)=>{null===ve.perlin&&(ve.perlin=new we);let i,s,a=(e=e||{}).level||[1,.2,.05],r=e.frequency||[.016,.05,.2],o=0,n=0;for(i=0;i<a.length;i++)s=r[i],o+=a[i]*(.5+.5*ve.perlin.noise3d(t.x*s,t.y*s,t.z*s)),n+=a[i];return o/=n,o}};class we{constructor(t){null==t&&(t=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var e=0;e<256;e++)this.p[e]=Math.floor(256*t.random());this.perm=[];for(e=0;e<512;e++)this.perm[e]=this.p[255&e];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(t,e,i){return t[0]*e+t[1]*i}dot3(t,e,i,s){return t[0]*e+t[1]*i+t[2]*s}dot4(t,e,i,s,a){return t[0]*e+t[1]*i+t[2]*s+t[3]*a}noise(t,e){var i,s,a=(t+e)*(.5*(Math.sqrt(3)-1)),r=Math.floor(t+a),o=Math.floor(e+a),n=(3-Math.sqrt(3))/6,l=(r+o)*n,h=t-(r-l),c=e-(o-l);h>c?(i=1,s=0):(i=0,s=1);var d=h-i+n,u=c-s+n,p=h-1+2*n,m=c-1+2*n,f=255&r,b=255&o,g=this.perm[f+this.perm[b]]%12,y=this.perm[f+i+this.perm[b+s]]%12,x=this.perm[f+1+this.perm[b+1]]%12,v=.5-h*h-c*c,w=.5-d*d-u*u,M=.5-p*p-m*m;return 70*((v<0?0:(v*=v)*v*this.dot(this.grad3[g],h,c))+(w<0?0:(w*=w)*w*this.dot(this.grad3[y],d,u))+(M<0?0:(M*=M)*M*this.dot(this.grad3[x],p,m)))}noise3d(t,e,i){var s,a,r,o,n,l,h=(t+e+i)*(1/3),c=Math.floor(t+h),d=Math.floor(e+h),u=Math.floor(i+h),p=1/6,m=(c+d+u)*p,f=t-(c-m),b=e-(d-m),g=i-(u-m);f>=b?b>=g?(s=1,a=0,r=0,o=1,n=1,l=0):f>=g?(s=1,a=0,r=0,o=1,n=0,l=1):(s=0,a=0,r=1,o=1,n=0,l=1):b<g?(s=0,a=0,r=1,o=0,n=1,l=1):f<g?(s=0,a=1,r=0,o=0,n=1,l=1):(s=0,a=1,r=0,o=1,n=1,l=0);var y=f-s+p,x=b-a+p,v=g-r+p,w=f-o+2*p,M=b-n+2*p,k=g-l+2*p,A=f-1+.5,S=b-1+.5,T=g-1+.5,P=255&c,z=255&d,R=255&u,E=this.perm[P+this.perm[z+this.perm[R]]]%12,F=this.perm[P+s+this.perm[z+a+this.perm[R+r]]]%12,B=this.perm[P+o+this.perm[z+n+this.perm[R+l]]]%12,C=this.perm[P+1+this.perm[z+1+this.perm[R+1]]]%12,L=.6-f*f-b*b-g*g,_=.6-y*y-x*x-v*v,D=.6-w*w-M*M-k*k,V=.6-A*A-S*S-T*T;return 32*((L<0?0:(L*=L)*L*this.dot3(this.grad3[E],f,b,g))+(_<0?0:(_*=_)*_*this.dot3(this.grad3[F],y,x,v))+(D<0?0:(D*=D)*D*this.dot3(this.grad3[B],w,M,k))+(V<0?0:(V*=V)*V*this.dot3(this.grad3[C],A,S,T)))}noise4d(t,e,i,s){var a,r,o,n,l,h,c,d,u,p,m,f,b=this.grad4,g=this.simplex,y=this.perm,x=(Math.sqrt(5)-1)/4,v=(5-Math.sqrt(5))/20,w=(t+e+i+s)*x,M=Math.floor(t+w),k=Math.floor(e+w),A=Math.floor(i+w),S=Math.floor(s+w),T=(M+k+A+S)*v,P=t-(M-T),z=e-(k-T),R=i-(A-T),E=s-(S-T),F=(P>z?32:0)+(P>R?16:0)+(z>R?8:0)+(P>E?4:0)+(z>E?2:0)+(R>E?1:0),B=P-(a=g[F][0]>=3?1:0)+v,C=z-(r=g[F][1]>=3?1:0)+v,L=R-(o=g[F][2]>=3?1:0)+v,_=E-(n=g[F][3]>=3?1:0)+v,D=P-(l=g[F][0]>=2?1:0)+2*v,V=z-(h=g[F][1]>=2?1:0)+2*v,j=R-(c=g[F][2]>=2?1:0)+2*v,q=E-(d=g[F][3]>=2?1:0)+2*v,O=P-(u=g[F][0]>=1?1:0)+3*v,I=z-(p=g[F][1]>=1?1:0)+3*v,G=R-(m=g[F][2]>=1?1:0)+3*v,U=E-(f=g[F][3]>=1?1:0)+3*v,N=P-1+4*v,W=z-1+4*v,H=R-1+4*v,K=E-1+4*v,X=255&M,J=255&k,Q=255&A,Y=255&S,Z=y[X+y[J+y[Q+y[Y]]]]%32,$=y[X+a+y[J+r+y[Q+o+y[Y+n]]]]%32,tt=y[X+l+y[J+h+y[Q+c+y[Y+d]]]]%32,et=y[X+u+y[J+p+y[Q+m+y[Y+f]]]]%32,it=y[X+1+y[J+1+y[Q+1+y[Y+1]]]]%32,st=.6-P*P-z*z-R*R-E*E,at=.6-B*B-C*C-L*L-_*_,rt=.6-D*D-V*V-j*j-q*q,ot=.6-O*O-I*I-G*G-U*U,nt=.6-N*N-W*W-H*H-K*K;return 27*((st<0?0:(st*=st)*st*this.dot4(b[Z],P,z,R,E))+(at<0?0:(at*=at)*at*this.dot4(b[$],B,C,L,_))+(rt<0?0:(rt*=rt)*rt*this.dot4(b[tt],D,V,j,q))+(ot<0?0:(ot*=ot)*ot*this.dot4(b[et],O,I,G,U))+(nt<0?0:(nt*=nt)*nt*this.dot4(b[it],N,W,H,K)))}}class Me extends e.Mesh{constructor(t={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=t.name,this.folder=t.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=t.terrainType||"terrain",this.callback=t.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[t.uv||18,t.uv||18],this.sample=null==t.sample?[128,128]:t.sample,this.size=void 0===t.size?[100,30,100]:t.size;let i=this.sample[0]-1,s=this.sample[1]-1;this.rx=i/this.size[0],this.rz=s/this.size[2],this.zone=t.zone||1;let a=[this.size[0]/i,this.size[2]/s];this.sampleZ=[t.sample[0]*this.zone,t.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*a[0],t.size[1],(this.sampleZ[1]-1)*a[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:t.level||[1,.2,.05],frequency:t.frequency||[.016,.05,.2],expo:t.expo||1},this.isWater=t.water||!1,this.isIsland=t.island||!1,this.isBorder=!1,this.wantBorder=t.border||!1,this.isBottom=!1,this.wantBottom=t.bottom||!1,this.wantBorder=t.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=t.maxSpeed||.1,this.acc=null==t.acc?.01:t.acc,this.dec=null==t.dec?.01:t.dec,this.deep=null==t.deep?0:t.deep,this.ease=new e.Vector2,this.complexity=null==t.complexity?30:t.complexity,this.complexity2=null==t.complexity2?null:t.complexity2,this.local=new e.Vector3,t.local&&this.local.fromArray(t.local),this.pp=new e.Vector3,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=t.is64||!1,this.isTurn=t.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=t.isAbsolute||!1,this.isTurned=t.isTurned||!1,this.isReverse=t.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new e.PlaneGeometry(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-ve.PI90),this.geometry.setAttribute("color",new e.BufferAttribute(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var r=new e.Quaternion(.5,.5,.1,.2);t.maplevels&&r.fromArray(t.maplevels);var o,n=ke,l=t.maps||["sand","grass3","rock"],h={};this.isWater&&(l=["water"]);for(let e in l)o=l[e],h[o+"_c"]=$t.texture({url:this.folder+o+"_c.jpg",flip:!1,repeat:this.uvx,encoding:t.encoding||!0,callback:this.mapcallback.bind(this)}),h[o+"_n"]=$t.texture({url:this.folder+o+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});h.noise=$t.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=h,this.material=new e.MeshPhysicalMaterial({name:"terrain",vertexColors:!0,color:16777215,map:h[l[0]+"_c"],normalMap:h[l[0]+"_n"]}),void 0!==t.envmap&&(this.material.envMap=t.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=t.opacity||.4,this.material.side=e.DoubleSide,this.material.alphaMap=h[l[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=0,this.material.metalness=t.metalness||0,this.material.roughness=t.roughness||.3);var c=t.nScale||.5;if(this.material.normalScale.set(c,-c),this.isWater)this.material.onBeforeCompile=function(t){var e=t.fragmentShader;e=e.replace("#include <alphamap_fragment>",n.alphamap),t.fragmentShader=e};else{let t=this;this.material.onBeforeCompile=function(e){let i=e.uniforms;i.clevels={value:r},i.map1={value:h[l[1]+"_c"]},i.map2={value:h[l[2]+"_c"]},i.randomUv={value:1},i.normalMap1={value:h[l[1]+"_n"]},i.normalMap2={value:h[l[2]+"_n"]},i.noiseMap={value:h.noise},i.useNoiseMap={value:1},e.uniforms=i;let s=e.fragmentShader;s=s.replace("#include <clipping_planes_pars_fragment>","#include <clipping_planes_pars_fragment>"+Ae+n.fragmentAdd),s=s.replace("#include <map_fragment>",n.map),s=s.replace("#include <normal_fragment_maps>",n.normal),s=s.replace("#include <color_fragment>",""),e.fragmentShader=s,t.material.userData.shader=e},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(t){this.userData.shader.uniforms.randomUv.value=t?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(t){this.userData.shader.uniforms.map1.value=t}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(t){this.userData.shader.uniforms.map2.value=t}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(t){this.userData.shader.uniforms.normalMap1.value=t}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(t){this.userData.shader.uniforms.normalMap2.value=t}})}t.debug&&this.debugZone(t),this.wantBorder&&this.addBorder(t),this.wantBottom&&this.addBottom(t),t.pos&&this.position.fromArray(t.pos),t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=ve.toQuatArray(t.rot),delete t.rot),this.quaternion.fromArray(t.quat),t.decal&&(this.position.y+=t.decal),this.castShadow=!0,this.receiveShadow=!0,$t.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let t=.5*(this.sample[0]-this.sampleZ[0]),e=.5*(this.sample[1]-this.sampleZ[1]),i=this.sample[0]*e+t,s=0;for(let e=0;e<this.lngZ;e++)s=Math.floor(e/this.sampleZ[0]),this.zid[i+e+s*(2*t)]=e}debugZone(t){this.geometryZ=new e.PlaneGeometry(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-ve.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const i=new e.Mesh(this.geometryZ,new e.MeshBasicMaterial({color:0,wireframe:!0,transparent:!0,opacity:.1}));this.add(i)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(t){var i=new e.PlaneGeometry(this.size[0],this.size[2],1,1);i.rotateX(ve.PI90),this.bottomMesh=new e.Mesh(i,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(t){this.borderMaterial=new e.MeshStandardMaterial({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?t.opacity||.8:1,envMap:t.envmap||null});var s=new e.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),a=new e.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),r=new e.PlaneGeometry(this.size[2],2,this.sample[1]-1,1),o=new e.PlaneGeometry(this.size[2],2,this.sample[1]-1,1);s.translate(0,1,.5*this.size[2]),a.rotateY(-ve.Pi),a.translate(0,1,.5*-this.size[2]),r.rotateY(-ve.PI90),r.translate(.5*-this.size[0],1,0),o.rotateY(ve.PI90),o.translate(.5*this.size[0],1,0),this.borderGeometry=i.mergeVertices(i.mergeGeometries([s,a,r,o])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new e.BufferAttribute(this.borderColors,3)),this.borderMesh=new e.Mesh(this.borderGeometry,this.borderMaterial);for(var n,l,h=this.lng2;h--;)n=3*h,l=this.borderVertices[n+1]>0?this.findPoint(this.borderVertices[n],this.borderVertices[n+2]):-1,this.list[h]=l;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let t in this.txt)this.txt[t].dispose()}easing(t,e,i){if(0!==t[0]||0!==t[1]){var s=e||0;t[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=t[1]*this.acc,this.ease.x+=t[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,t[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),t[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(s)*this.ease.x+Math.cos(s)*this.ease.y,this.local.x+=Math.cos(s)*this.ease.x-Math.sin(s)*this.ease.y,this.update(i))}}getTri(){return this.geometry}getHeight(t,e){return t*=this.rx,e*=this.rz,t+=.5*this.sample[0],e+=.5*this.sample[1],t=Math.floor(t),e=Math.floor(e),(this.isTurn?this.height[this.findId2(t,e)]:this.height[this.findId(t,e)])*this.size[1]+this.position.y}findIdZ(t,e){return t+e*this.sampleZ[1]}findId(t,e){return t+e*this.sample[1]}findId2(t,e){return e+-t*this.sample[0]||1}findPoint(t,e){for(var i,s=this.lng;s--;)if(i=3*s,this.vertices[i]===t&&this.vertices[i+2]===e)return s;return-1}getReverseID(){this.invId=[];let t,e,i=this.lngZ;const s=this.sampleZ[1]-1;for(this.sampleZ[0];i--;)t=i%this.sampleZ[0],e=Math.floor(i*this.ratioZ),this.isReverse&&(e=s-e),this.invId[i]=this.isTurned?this.lngZ-1-this.findIdZ(e,t):this.findIdZ(t,e)}set(t){t.ease&&this.easing(t.key,t.azimut),t.decal&&this.decal(t.decal,!0)}decal(t,e){this.local.x+=t[0],this.local.y+=t[1],this.local.z+=t[2],this.update(e)}updateUv(){if(this.isWater)this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001;else{let t={x:this.local.x*this.ruvx,y:this.local.z*this.ruvy};this.material.map&&this.material.map.offset.copy(t),this.material.normalMap&&this.material.normalMap.offset.copy(t)}}distance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}clamp(t,e=0,i=1){return t=(t=t<e?e:t)>i?i:t}update(t){let e,i,s,a,r,o,n,l,h,c,d,u=this.pp,p=[1,1,1],m=this.lng;for(;m--;){if(e=3*m,i=m%this.sample[0],s=Math.floor(m*this.ratio),u.set(i+this.local.x*this.rx,this.local.y,s+this.local.z*this.rz),a=ve.noise(u,this.data),this.isIsland){let t=1-this.distance({x:i,y:s},{x:.5*(this.sample[0]-1),y:.5*(this.sample[1]-1)})/(.5*(this.sample[0]-1));t*=4,t=this.clamp(t),a*=t}a=Math.pow(a,this.data.expo),a=this.clamp(a),"road"===this.ttype&&(l===s?a=1===i||2===i||29===i||30===i?h+.1:h:(l=s,h=a)),this.height[m]=a,c=a*this.size[1]+this.deep,this.vertices[e+1]=c,o=this.isAbsolute?a:a*this.size[1],void 0!==this.zid[m]&&(n=this.zid[m],r=this.changeId?this.invId[n]:n,this.heightData[r]=o,this.verticesZ&&(this.verticesZ[3*n+1]=c)),p=this.isWater?[a*this.colorBase.r,a*this.colorBase.g,a*this.colorBase.b]:[a,0,0],d=p[0],this.colors[e]=d,this.colors[e+1]=d,this.colors[e+2]=d}if(this.isBorder){let t,i=this.lng2;for(;i--;)e=3*i,-1!==this.list[i]?(t=this.height[this.list[i]],this.borderVertices[e+1]=t*this.size[1]+this.deep,d=ve.clamp(t+.25,.25,1),this.borderColors[e]=d,this.borderColors[e+1]=d,this.borderColors[e+2]=d):(this.borderColors[e]=this.colorBase.r,this.borderColors[e+1]=this.colorBase.g,this.borderColors[e+2]=this.colorBase.b)}t?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(t){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const ke={fragmentAdd:"\n        uniform vec4 clevels;\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.x) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (slope == 0.0 ) cc = sands;\n            //if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            //if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n\n            float d = level.y;\n            float rx = 1.0/level.y;\n\n            if (( slope < level.x + d ) && (slope > level.x)) cc = mix( grasss , rocks, ( slope - (level.x) ) * rx );\n\n            d = level.w;\n            rx = 1.0/level.w;\n            if (( slope < level.z + d ) && (slope > level.z )) cc = mix( sands , grasss, ( slope - (level.z) ) * rx );\n\n            //cc = mix( grasss, cc, smoothstep(0.0,1.0, slope)*20.0 );\n            return cc;\n        }\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 sampledDiffuseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n\n            diffuseColor *= sampledDiffuseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "},Ae="\n\nuniform sampler2D noiseMap;\nuniform float useNoiseMap;\n\nfloat directNoise(vec2 p){\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u*u*(3.0-2.0*u);\n    \n    float res = mix(\n        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),\n        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);\n    return res*res;\n}\n\nfloat sum( vec4 v ) { return v.x+v.y+v.z; }\n\nvec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n    // sample variation pattern\n    float k = 0.0;\n    if( useNoiseMap == 1.0 ) k = texture2D( noiseMap, 0.005*uv ).x;\n    else k = directNoise( uv );\n    \n    // compute index    \n    float index = k*8.0;\n    float f = fract( index );\n\n    float ia = floor( index );\n    float ib = ia + 1.0;\n    // or\n    //float ia = floor(index+0.5); // suslik's method (see comments)\n    //float ib = floor(index);\n    //f = min(f, 1.0-f)*2.0;\n\n    // offsets for the different virtual patterns    \n    vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n    vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n    // compute derivatives for mip-mapping    \n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n    \n    // sample the two closest virtual patterns    \n    vec4 cola = textureGrad( mapper, uv + offa, dx, dy );\n    vec4 colb = textureGrad( mapper, uv + offb, dx, dy );\n\n    // interpolate between the two virtual patterns    \n    return mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) );\n\n}\n";let Se=null;class Te extends rt{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,Se=this.motor.mat,this.type="terrain",this.num=C[this.type]}step(t,e){let i,s=this.list.length;for(;s--;)i=this.list[s],i.step()}add(t={}){this.setName(t),"JOLT"===this.engine&&(t.isAbsolute=!0,t.isTurned=!1),"PHYSX"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"HAVOK"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"OIMO"!==this.engine&&(t.zone=t.zone||.25);const e=new Me(t);return Se.extendShader(e.material,e.material.onBeforeCompile),e.physicsUpdate=(t,e)=>{this.motor.flow.tmp.push({name:t,heightData:e})},this.addToWorld(e,t.id),this.motor.post({m:"add",o:Pe(e,this.engine)}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const Pe=function(t,e){const i={name:t.name,type:t.type,pos:t.position.toArray(),quat:"PHYSX"===e?[0,0,0,1]:t.quaternion.toArray()};return"PHYSX"===e||"AMMO"===e||"HAVOK"===e||"JOLT"===e?(i.type="terrain",i.size=t.sizeZ,i.sample=t.sampleZ,i.zone=t.zone,i.heightData=t.heightData):(i.type="mesh",i.v=A.getVertex(t.geometry,"OIMO"===e),i.index="OIMO"===e?null:A.getIndex(t.geometry)),i};class ze extends rt{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="solver"}step(t,e){let i,s=this.list.length;for(;s--;)i=e+s*C[this.type],this.list[s].update(t,i)}add(t={}){this.setName(t);let e=new Re(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}set(t={}){}}class Re{constructor(t,e){this.motor=e,this.name=t.name,this.type="solver",this.needData=t.needData||!1,this.bones=[],this.joints=[],this.jid=0,this.speed=1}addBone(t){this.bones.push(t)}dispose(){this.motor.remove(this.bones,!0)}update(t,e){if(!this.needData)return;let i,s,a=this.joints.length;for(;a--;)s=e+7*a,i=this.joints[a],i.data.target.x=t[s+0],i.data.target.y=t[s+1],i.data.target.z=t[s+2],i.data.target.rx=t[s+3],i.data.target.ry=t[s+4],i.data.target.rz=t[s+5],i.data.target.count=t[s+6]}start(){this.motor.post({m:"startArticulation",o:{name:this.name}})}stop(){this.motor.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){this.motor.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(t){this.jid=this.joints.length,t.name=t.name||this.name+"_Joint_"+this.jid,t.solver=this.name,void 0!==t.rot1&&(t.quat1=A.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=A.quatFromEuler(t.rot2),delete t.rot2),"fixe"!==t.type&&this.joints.push(new Ee(t,this)),this.motor.post({m:"addSolverJoint",o:t})}driveJoints(t){let e,i,s=!1,a=this.joints.length,r=[];for(;a--;)e=this.joints[a],e.update(t),i=e.isDrive,e.nup&&r.push(e.nup),s=!!i||s;s?this.motor.change(r):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(t,e){if(!t)return;let i=this.joints.length;for(;i--;)this.joints[i].pose(void 0!==t[i]?t[i]:0,void 0!==e?e:this.speed);return new Promise((t=>this.resolve=t))}}class Ee{constructor(t,e){if(this.name=t.name,this.solver=e,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},t.limits&&(this.driveType=t.limits[0][0],this.min=t.limits[0][1],this.max=t.limits[0][2]),t.position&&(t.target=t.position),t.target){let e,i=t.target.length;for(;i--;)e=t.target[i],this.data.target[e[0]]=e[1]}}start(){}pose(t,e){this.target=A.clamp(t,this.min,this.max),this.current=A.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=e,this.isDrive=!0)}update(t){if(this.isDrive){this.tmp+=t*this.time;let e=this.tmp;e=e>1?1:e;let i=this.target;this.nup={name:this.name,drivesTarget:[[this.driveType,i]]},1===e&&(this.isDrive=!1)}else this.nup=null}}class Fe{constructor(t){this.map=new Map,this.motor=t,this.enginReady=["PHYSX","HAVOK","OIMO"],this.rc=this.refresh.bind(this)}reset(){this.map=new Map}step(){this.map.forEach(this.rc)}refresh(t,e){let i=this.motor.reflow.contact[e];if(void 0!==i)for(let e=0,s=i.length;e<s;e++)t.userData.collisionCallback?t.userData.collisionCallback(i[e]):t.dispatchEvent({type:"collision",data:i[e]})}isReady(){return-1!==this.enginReady.indexOf(this.motor.engine)}remove(t){this.isReady()&&this.map.has(t)&&(this.map.delete(t),this.motor.post({m:"removeCollision",o:{name:t}}))}add(t){if(!this.isReady())return;let e=t.name,i=this.motor.byName(e);null!==i&&(t.vs&&t.vs.constructor!==Array&&(t.vs=[t.vs]),t.ignore&&t.ignore.constructor!==Array&&(t.ignore=[t.ignore]),t.callback&&(i.userData.collisionCallback=t.callback,delete t.callback),this.map.set(e,i),this.motor.post({m:"addCollision",o:t}))}}const Be=t=>t?.reduce(((t,e)=>t+e),0)/t.length;class Ce{constructor(){this.chartLen=60,this.frame=0,this.frameG=0,this.gpuAccums=[],this.activeAccums=[],this.queryCreated=!1,this.queryHasResult=!1,this.withGpu=!0,this.reset()}reset(){this.msChart=new Array(this.chartLen).fill(0),this.fpsChart=new Array(this.chartLen).fill(0),this.gpuChart=new Array(this.chartLen).fill(0)}up(t){this.msChart[this.frame]=t.ms,this.fpsChart[this.frame]=t.fps,this.frame++,this.frame===this.chartLen&&(this.frame=0)}setRenderer(t){this.withGpu&&(this.gl=t.getContext(),this.extension=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),null!==this.extension&&this.startGpu())}upGpu(){let t=this.startGpu(this.frameG);t&&(this.gpuChart[this.frameG]=t,this.frameG++,this.frameG===this.chartLen&&(this.frameG=0)),this.endGpu()}startGpu(){const t=this.gl,e=this.extension;if(!t||!e)return;let i,s,a=!1,r=null;if(this.query){this.queryHasResult=!1;let o=this.query;if(a=t.getQueryParameter(o,t.QUERY_RESULT_AVAILABLE),i=t.getParameter(e.GPU_DISJOINT_EXT),a&&!i){s=t.getQueryParameter(this.query,t.QUERY_RESULT);const e=1e-6*s;this.gpuAccums[0]=e,(a||i)&&(t.deleteQuery(this.query),o=null),a&&e>0&&(i||(r=e))}}return!a&&this.query||(this.queryCreated=!0,this.query=t.createQuery(),t.beginQuery(e.TIME_ELAPSED_EXT,this.query)),r}endGpu(){const t=this.extension,e=this.gl;this.queryCreated&&e.getQuery(t.TIME_ELAPSED_EXT,e.CURRENT_QUERY)&&e.endQuery(t.TIME_ELAPSED_EXT)}get ms(){return Be(this.msChart)}get fps(){return Be(this.fpsChart)}get gpu(){return Be(this.gpuChart)}}class Le extends e.Mesh{constructor(t={}){super(new e.PlaneGeometry,new e.MeshBasicMaterial({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=t.nam||"text",this.canvas=null,this.w=t.w||0,this.h=t.h||0,this.weight=t.weight??700,this.font=t.font??"'Mulish', sans-serif",this.fontSize=t.fontSize??32,this.backgroundColor=t.backgroundColor??"#00000000",this.fontColor=t.color??"#FFFFFF",this.material.alphaTest=.5,this.set(t.text),t.pos&&this.position.fromArray(t.pos),t.rot&&this.quaternion.fromArray(A.quatFromEuler(t.rot))}set(t){this.canvas||(this.canvas=document.createElement("canvas"));let i,s,a,r=this.canvas.getContext("2d");r.font=this.weight+" "+this.fontSize+"px "+this.font;let o=r.measureText(t);i=2**Math.ceil(Math.log2(o.width)),s=2**Math.ceil(Math.log2(r.measureText("M").width)),this.canvas.width=i,this.canvas.height=s,r.fillStyle=this.backgroundColor,r.fillRect(0,0,i,s),r.fillStyle=this.fontColor,r.font=this.weight+" "+this.fontSize+"px "+this.font,r.textAlign="center",r.textBaseline="middle",r.fillText(t,.5*i,.5*s),this.material.map=new e.CanvasTexture(this.canvas),0!==this.h?(a=this.h/s,this.scale.set(i*a,this.h,0)):0!==this.w?(a=this.w/s,this.scale.set(this.w,s*a,0)):this.scale.set(.025*i,.025*s,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let _e=0;class De{constructor(t={},e){this.motor=e,this.down=!1,this.time=t.time||250,this.p=t.pos||[0,0,0],this.type=t.type||"box",this.name=t.name||"button"+_e++,this.pos=t.pos||[0,0,0],this.size=t.size||[1,1,1],this.radius=t.radius||0,this.axe=void 0!==t.axe?t.axe:1,this.fontSize=t.fontSize||.8,this.fontScale=t.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let i=this.size[this.axe]-2*this.radius;this.range=[this.origin-i,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},t.callback&&(this.callback=t.callback,delete t.callback),t.button=!0,t.pos=this.pos,t.material||(t.material="button"),t.kinematic=!0,t.mask=1,this.timeout=null,this.b=this.motor.add(t),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),t.text&&this.addText(t.text)}addText(t,e){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let i={text:t,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(i={text:t,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new Le(i),this.b.add(this.txt)}action(t){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&this.motor.explosion(t||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&this.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=A.lerp(this.value,this.target,this.speed),A.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,this.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}class Ve{constructor(t,i="drag",s){this.motor=s,this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=i,this.option={},this.overObj=null,this.controler=t,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new e.Vector3,this.tmpPos=new e.Vector3,this.tmpD=new e.Vector3,this.mouse=new e.Vector2,this.oldMouse=new e.Vector2,this.raycast=new e.Raycaster,this.raycast.far=1e3,this.button=0,this.pos=new e.Vector3,this.velocity=new e.Vector3,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.floorDrag=2===this.button,this.helper=new je(this.motor),this.dragPlane=new e.Mesh(new e.PlaneGeometry(1,1),this.motor.mat.get("hide")),this.floorDrag&&this.dragPlane.geometry.rotateX(.5*-Math.PI),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),this.motor.scenePlus.add(this.helper),this.motor.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(this.motor.scenePlus.remove(this.dragPlane),this.motor.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(t,e={}){t!==this.mode&&(this.mode=t,this.option=e,"blast"===this.mode&&this.option.visible&&this.motor.initParticle())}activeDragMouse(t){t?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("start",this.controleStart.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("start",this.controleStart.bind(this),!1),this.isActive=!1)}controleEnd(t){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleStart(t){this.raycastTest=!1}controleChange(t){}getMouse(t){this.motor.viewSize?(this.mouse.x=t.offsetX/this.motor.viewSize.w*2-1,this.mouse.y=-t.offsetY/this.motor.viewSize.h*2+1):(this.mouse.x=t.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-t.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==t.pointerType?t.button:0}contextmenu(t){}mousedown(t){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(t),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(t){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(t){if("drag"===this.mode)this.getMouse(t),this.needRay=!0}castray(){let t,e,i,s,a,r="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObject(this.dragPlane),t.length&&this.mouseDown&&this.moveSelect(t[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObjects(this.motor.scene.children,!0),this.tmpSelected=null,t.length>0?(i=t[0].object,i.isInstancedMesh?(a=t[0].instanceId,e=this.motor.byName(i.getIDName(a))):i.parent!==this.motor.scene?(s=i.parent,e=s.parent!==this.motor.scene?s.parent:s):e=i,this.mouseDown2&&e.extra&&e.extra(e.name),r=e&&!e.isButton?this.select(e,t[0].point):this.actionButton(e,t[0])):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,r="auto",this.resetOver()),document.body.style.cursor=r}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,this.needRay=!0}blast(){let t=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let e=this.raycast.intersectObjects(this.motor.scene.children,!0);e.length>0?e[0].object.isButton?e[0].object.parent.userData.direct():t=e[0]:(e=this.raycast.intersectObjects(this.motor.scenePlus.children,!0),e.length>0&&(t=e[0]));const i=this.option;t&&(this.motor.explosion(t.point,i.radius||3,i.power||.1),i.visible&&this.motor.addParticle({name:"blast",type:"cube",position:t.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){const t=this.option;this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(t.velocity||60),this.motor.add({name:"bullet_"+this.numBullet,type:"sphere",mass:t.mass||10,size:[t.size||.2],material:t.mat||"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(t,e){if(this.buttonRef?this.buttonRef.name!==t.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=t):this.mouseDown&&(this.buttonRef=t),this.mouseDown&&this.buttonRef.userData.action){let t=e.point;this.buttonRef.userData.action(t)}return"pointer"}setOver(t){t&&(this.overObj&&t.name!==this.overObj.name&&this.resetOver(),this.overObj=t,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(t,e){if(this.mouseDown||this.setOver(t),!this.mouseDown||this.selected===t)return"grab";this.pz=0;let i=e,s=[0,0,0,1];this.selected=t,this.decal.copy(i).sub(this.selected.position),this.tmpPos.copy(i).sub(this.decal),this.angle=this.controler.getAzimuthalAngle(),s=this.selected.quaternion.toArray(),this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(i),this.helper.position.copy(i);let a=i.toArray(),r=!1;this.motor.change({name:this.selected.name,neverSleep:!0,wake:!0});const o=this.motor.engine;if(this.moveDirect)this.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let t=[-.1,.1,600,1],e=[-.1,.1,600,1],i="OIMO"===o||"RAPIER"===o||"JOLT"===o,n=0===this.selected.link?"fixe":"d6";"JOLT"===o&&(n="fixe");let l=[["x",...t],["y",...t],["z",...t],["rx",...e],["ry",...e],["rz",...e]];"HAVOK"===o&&(l=[["x",...t],["y",...t],["z",...t]]),"OIMO"===o&&(r=!0,n=0===this.selected.link?"fixe":"spherical",l=[["x",...t],["y",...t],["z",...t]]),"HAVOK"===o&&(n=0===this.selected.link?"fixe":"spherical",l=[-180,180,.1,.1]),this.motor.add([{name:"mouse",type:"null",pos:a,quat:s,kinematic:!i},{name:"mouseJoint",type:"joint",mode:n,lm:l,sd:[4,1],autoDrive:!0,b1:r?this.selected.name:"mouse",b2:r?"mouse":this.selected.name,worldAnchor:a,visible:!1}])}return"grabbing"}moveSelect(t){if(null===this.selected)return;if(t&&this.tmpPos.copy(t).sub(this.decal),this.moveDeep){let t=this.selected.position.y,e=t-this.tmpPos.y;this.tmpPos.y=t,this.tmpD.set(0,0,e).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let e=this.tmpPos.toArray();this.moveDirect?this.motor.change({name:this.selected.name,pos:e,reset:!0}):this.motor.change({name:"mouse",pos:t.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?this.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(this.motor.remove(["mouseJoint","mouse"]),this.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let t=this.motor.flow.key;if(0!==t[1]){let e=.1*t[1];this.dragPlane.translateZ(e),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class je extends e.Line{constructor(t){super(new e.BufferGeometry,t.mat.get("line"));let i=.75;const s=[i,i,i,0,0,0];this.geometry.setAttribute("position",new e.Float32BufferAttribute([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new e.Float32BufferAttribute(s,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}const qe=new e.Vector3;new e.Vector3;const Oe=new e.Vector3,Ie=new e.Vector3,Ge=new e.Vector3,Ue=new e.Vector3,Ne=new e.Vector3;class We{constructor(t={},i){this.first=!0,this.debug=t.debug||!1,this.motor=i,this.name=t.name||"ppp",this.pMass=t.pMass||.01,this.vSize=t.vSize||.16,this.pSize=t.pSize||.02,this.particles=[],this.density=t.density||.01,this.smoothMulty=t.smoothMulty||1,this.smoothing=t.smoothing||.2,this.smoothing*=this.smoothMulty,this.speed=t.speed||.1,this.viscosity=t.viscosity||.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.maxDist=0,this.tv=new e.Vector3,this.tv2=new e.Vector3,t.mesh&&this.setMesh(t.mesh,t.crossEdge)}setMesh(t,e=!1){const i=[],s=[];this.mesh=t,this.geometry=t.geometry,this.geometry.getIndex();const a=this.geometry.getAttribute("position").array,r=A.getHash(this.geometry),o=A.getFaces(this.geometry),n=e?A.getConnectedFaces(o):null;let l,h,c,d,u,p;for(let t in r)l=r[t][0],h=3*l,qe.set(a[h],a[h+1],a[h+2]),this.mesh.localToWorld(qe),this.add(qe.toArray());for(let t=0;t<o.length;t++)c=o[t],d=this.getKey(r,c[0]),u=this.getKey(r,c[1]),p=this.getKey(r,c[2]),this.sameLink(i,d,u)||i.push([d,u]),this.sameLink(i,u,p)||i.push([u,p]),this.sameLink(i,p,d)||i.push([p,d]);if(this.connect(i),n){for(let t=0;t<n.length;t++)c=n[t],d=this.getKey(r,c[0]),u=this.getKey(r,c[1]),this.sameLink(i,d,u)||this.sameLink(s,d,u)||s.push([d,u]);this.connect(s,!0)}this.hash=r,this.mesh.position.set(0,0,0),this.mesh.quaternion.set(0,0,0,1),this.mesh.receiveShadow=!0,this.mesh.castShadow=!0,phy.addDirect(this.mesh)}updateMesh(){if(!this.geometry)return;let t,e,i,s=this.hash,a=this.geometry.attributes.position.array,r=this.particles.length;for(;r--;)for(e=this.particles[r],i=s[r].length;i--;)t=3*s[r][i],a[t]=e.position.x,a[t+1]=e.position.y,a[t+2]=e.position.z;this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeVertexNormals(),this.geometry.computeBoundingSphere()}add(t){let i=this.motor.add({instance:this.name,type:"particle",size:[this.vSize],pSize:this.pSize,pos:t,inertia:[0,0,0],mass:this.pMass,restitution:0,friction:.5,damping:[.2,.1],material:this.debug?"particle":"hide",shadow:!1,getVelocity:!0});this.first=!1,i.force=new e.Vector3,this.particles.push(i),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(t,e){let i,s,a,r=t.length,o=[],n=0;for(;r--;){if(i=t[r],this.name,i[0],this.name,i[1],s=this.particles[i[0]].position,a=this.particles[i[1]].position,n=this.tv.copy(s).distanceTo(a),e){if(n>this.maxDist)continue}else n>this.maxDist&&(this.maxDist=n);this.tv.copy(a).sub(s),o.push({type:"distance",helperSize:.03,b1:this.name+i[0],b2:this.name+i[1],limit:[.5*n,n],spring:[20,1],collision:!0,noPreProcess:!0,alway:!0})}this.motor.add(o)}getPosition(){let t,e,i=[],s=this.particles.length;for(;s--;)e=3*s,t=this.particles[s],i[e]=t.position.x,i[e+1]=t.position.y,i[e+2]=t.position.z;return i}getNeighbors(t,e){const i=this.particles.length,s=t.idx,a=this.smoothing*this.smoothing;let r=0;for(let o=0;o!==i;o++){const i=this.particles[o];r=this.distanceSq(i,t),s!==i.idx&&r<a&&e.push(i)}}distance(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,a=t.position.z-e.position.z;return Math.sqrt(i*i+s*s+a*a)}distanceSq(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,a=t.position.z-e.position.z;return i*i+s*s+a*a}w(t){const e=this.smoothing;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)}gradw(t,e){const i=t.length(),s=this.smoothing,a=945/(32*Math.PI*Math.pow(s,9))*Math.pow(s*s-i*i,2);e.copy(t).multiplyScalar(a)}nablaw(t){const e=this.smoothing;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}getKey(t,e){let i;for(let s in t)if(i=t[s],-1!==i.indexOf(e))return s}sameLink(t,e,i){let s,a=t.length,r=!1;for(;a--;)s=t[a],e===i&&(r=!0),e===s[0]&&i===s[1]&&(r=!0),e===s[1]&&i===s[0]&&(r=!0);return r}update(){const t=[],e=this.particles.length,i=this.speed,s=this.eps;let a;for(let t=0;t!==e;t++){const e=this.particles[t];e.force.set(0,0,0);const s=this.neighbors[t];s.length=0,this.getNeighbors(e,s),s.push(this.particles[t]);let r=0;for(a=s.length;a--;){const t=this.w(this.distance(e,s[a]));r+=s[a].mass*t}this.densities[t]=r,this.pressures[t]=i*i*(this.densities[t]-this.density)}const r=Oe,o=Ie,n=Ge,l=Ue,h=Ne;let c,d;for(let i=0;i!==e;i++){const e=this.particles[i];let a,u;r.set(0,0,0),o.set(0,0,0);const p=this.neighbors[i],m=p.length;for(let t=0;t!==m;t++)c=p[t],l.copy(e.position).sub(c.position),d=l.length(),a=-c.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+s)+this.pressures[t]/(this.densities[t]*this.densities[t]+s)),this.gradw(l,n),n.multiplyScalar(a),r.add(n),h.copy(c.velocity).sub(e.velocity),h.multiplyScalar(1/(1e-4+this.densities[i]*this.densities[t])*this.viscosity*c.mass),u=this.nablaw(d),h.multiplyScalar(u),o.add(h);o.multiplyScalar(e.mass),r.multiplyScalar(e.mass),e.force.add(o),e.force.add(r),t.push({name:e.name,force:e.force.toArray()})}this.motor.change(t),this.updateMesh()}}const He=Math.max(1e-9,Number.EPSILON),Ke=.5*He,Xe=Math.log10(1/He),Je=Math.pow(10,Xe),Qe=Ke*Je;function Ye(t,e,i,s){return function(t,e,i,s,a){let r=e.x-t.x,o=e.y-t.y,n=s.x-i.x,l=s.y-i.y;const h=ii(t),c=ii(i);if(h===c)return a;const d=ii(e);if(d===c)return a;const u=ii(s);if(h===u)return a;if(d===u)return a;let p=(t.x-i.x)*l-(t.y-i.y)*n,m=(e.x-i.x)*l-(e.y-i.y)*n,f=(i.x-t.x)*o-(i.y-t.y)*r,b=(s.x-t.x)*o-(s.y-t.y)*r;return(p>=0&&m<=0||p<=0&&m>=0)&&(f>=0&&b<=0||f<=0&&b>=0)}(t,e,i,s,!1)}function Ze(t,i,s,a){let r=0,o=new e.Vector3;return si(t)===si(i)||0===s.x&&0===s.y&&0===s.z?null:(r=((a.x-t.x)*s.x+(a.y-t.y)*s.y+(a.z-t.z)*s.z)/((i.x-t.x)*s.x+(i.y-t.y)*s.y+(i.z-t.z)*s.z),r>=0&&r<=1?(o=new e.Vector3(t.x+(i.x-t.x)*r,t.y+(i.y-t.y)*r,t.z+(i.z-t.z)*r),{x:o,s:r}):null)}function $e(t,e,i){return(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)<=0}function ti(t){return~~(t*Je+Qe)}function ei(t,e){return Math.round((t+e)*(t+e+1)*.5+e)}function ii(t){return ei(ti(t.x),ti(t.y))}function si(t){return function(t,e,i){const s=(t+e)*(t+e+1)*.5+e;return(s+i)*(s+i+1)*.5+i}(ti(t.x),ti(t.y),ti(t.z))}function ai(t,e,i){return e.x*(t.x-i.x)+e.y*(t.y-i.y)+e.z*(t.z-i.z)>=0}let ri=class t{constructor(t=new e.Vector3,i=new e.Vector3,s=new e.Vector2){this.position=t,this.normal=i,this.uv=s}clone(e){return new t(this.position.clone(),this.normal.clone(),this.uv.clone())}equals(t){return si(this.position)===si(t.position)}toString(){return`Position = ${this.position.x}, ${this.position.y}, ${this.position.z}, Normal = ${this.normal.x}, ${this.normal.y}, ${this.normal.z}, UV = ${this.uv.x}, ${this.uv.y}`}};let oi=class{constructor(t=null){this.isFragment=!0,this.vertices=[],this.cutVertices=[],this.triangles=[[],[]],this.constraints=[],this.indexMap=[],this.bounds=new e.Box3,this.vertexAdjacency=[],this.convextested=!1,this.minSize=.005,this.good=!0,null!==t&&this.fromArgs(t)}fromArgs(t){const{positions:i,normals:s,uvs:a,indices:r}=t;for(let t=0;t<i.length/3;t++){const r=new e.Vector3(i[3*t],i[3*t+1],i[3*t+2]),o=new e.Vector3(s[3*t],s[3*t+1],s[3*t+2]),n=a?new e.Vector2(a[2*t],a[2*t+1]):new e.Vector2(0,0);this.vertices.push(new ri(r,o,n))}if(r)this.triangles=[Array.from(r),[]];else{const t=i.length/3;this.triangles=[Array.from({length:t},((t,e)=>e)),[]]}this.calculateBounds()}get valid(){let t=this.triangleCount>6&&this.vertexCount>14;return this.volume()<this.minSize&&(t=!1),t}get size(){this.bounds||this.calculateBounds();let t=new e.Vector3;return this.bounds.getSize(t)}get convex(){return this.convextested||(this.cc=this.isConvex()),this.cc}get triangleCount(){return(this.triangles[0].length+this.triangles[1].length)/3}get vertexCount(){return this.vertices.length+this.cutVertices.length}addCutFaceVertex(t,e,i){const s=new ri(t,e,i);this.vertices.push(s),this.cutVertices.push(s),this.vertexAdjacency.push(this.vertices.length-1)}addMappedVertex(t,e){this.vertices.push(t),this.indexMap[e]=this.vertices.length-1}addTriangle(t,e,i,s){this.triangles[s].push(t,e,i)}addMappedTriangle(t,e,i,s){this.triangles[s].push(this.indexMap[t],this.indexMap[e],this.indexMap[i])}weldCutFaceVertices(){const t=[],e=[],i=new Array(this.cutVertices.length);let s=0;const a=new Map;this.cutVertices.forEach(((r,o)=>{const n=si(r.position),l=a.get(n);a.has(n)?i[o]=l:(i[o]=s,a.set(n,s),t.push(this.cutVertices[o]),e.push(this.vertexAdjacency[o]),s++)}));const r=[];for(let t=0;t<this.constraints.length;t++){const e=this.constraints[t];e.v1=i[e.v1],e.v2=i[e.v2],Math.abs(e.v1-e.v2)<1e-9||r.push(e)}this.constraints=r,this.cutVertices=t,this.vertexAdjacency=e}volume(){let t=[];this.vertices.forEach((e=>{t.push(e.position.x,e.position.y,e.position.z)})),this.cutVertices.forEach((e=>{t.push(e.position.x,e.position.y,e.position.z)}));let e,i=t.length/3,s=[0,0,0],a=[0,0,0];for(;i--;)e=3*i,t[e]<s[0]?s[0]=t[e]:t[e]>a[0]&&(a[0]=t[e]),t[e+1]<s[1]?s[1]=t[e+1]:t[e+1]>a[1]&&(a[1]=t[e+1]),t[e+2]<s[2]?s[2]=t[e+2]:t[e+2]>a[2]&&(a[2]=t[e+2]);let r=[a[0]-s[0],a[1]-s[1],a[2]-s[2]];return.5*r[0]*8*(.5*r[1])*(.5*r[2])}calculateBounds(){if(!this.vertices.length)return;let t=this.vertices[0].position.clone(),i=t.clone();this.vertices.forEach((e=>{t.x=Math.min(t.x,e.position.x),t.y=Math.min(t.y,e.position.y),t.z=Math.min(t.z,e.position.z),i.x=Math.max(i.x,e.position.x),i.y=Math.max(i.y,e.position.y),i.z=Math.max(i.z,e.position.z)})),this.bounds=new e.Box3(t,i)}toMesh(t,i=null,s=!0,a=0){const r=new e.Vector3,o=new e.Vector3;let n=this.toGeometry(s,a);n.boundingBox.getCenter(r),n.boundingBox.getSize(o),n.translate(-r.x,-r.y,-r.z),n.boundingSphere=new e.Sphere(new e.Vector3,.5*o.length());let l=t.material;i&&l.isMaterial&&(l=[t.material,i]);const h=new e.Mesh(n,l);return h.receiveShadow=t.receiveShadow,h.castShadow=t.castShadow,h.matrixAutoUpdate=t.matrixAutoUpdate,h.frustumCulled=t.frustumCulled,h.renderOrder=t.renderOrder,h.sizer=o.length(),r.applyQuaternion(t.quaternion),h.position.copy(t.position).add(r),h.quaternion.copy(t.quaternion),h.userData={origin:h.position.clone(),direction:r.normalize(),size:o},h}makeTrickness(t,e,i,s,a){let r,o=1-a,n=[...t],l=[...e],h=[...i],c=t.length/3,d=c;for(;d--;)r=3*d,n[r]*=o,n[r+1]*=o,n[r+2]*=o;let u=[];for(d=s.length;d--;)u[d]=s[d]+c;return[n,l,h,u]}toGeometry(t,i){let s;const a=new e.BufferGeometry;let r=[],o=[],n=[];if(this.vertices.forEach((t=>{r.push(t.position.x,t.position.y,t.position.z),o.push(t.normal.x,t.normal.y,t.normal.z),n.push(t.uv.x,t.uv.y)})),0!==i){let t=this.makeTrickness(r,o,n,this.triangles[0],i);r=r.concat(t[0]),o=o.concat(t[1]),n=n.concat(t[2]),s=t[3]}return t&&this.cutVertices.forEach((t=>{r.push(t.position.x,t.position.y,t.position.z),o.push(t.normal.x,t.normal.y,t.normal.z),n.push(t.uv.x,t.uv.y)})),a.addGroup(0,this.triangles[0].length,0),0!==i&&(a.addGroup(this.triangles[0].length,s.length,1),this.triangles[0]=this.triangles[0].concat(s)),t&&a.addGroup(this.triangles[0].length,this.triangles[1].length,1),a.setAttribute("position",new e.BufferAttribute(new Float32Array(r),3)),a.setAttribute("normal",new e.BufferAttribute(new Float32Array(o),3)),a.setAttribute("uv",new e.BufferAttribute(new Float32Array(n),2)),a.setIndex(new e.BufferAttribute(new Uint32Array(this.triangles.flat()),1)),a.computeBoundingBox(),a}isConvex(t=.001){this.convextested=!0;let i=0;const s=this.triangleCount,a=[...this.triangles[0],...this.triangles[1]],r=[...this.vertices,...this.cutVertices],o=r.length;if(0===s||0===o)return!1;const n=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new e.Vector3;let u,p;for(let e=0;e<s;e++){i=3*e,d.copy(r[0].position),n.copy(r[a[i]].position),l.copy(r[a[i+1]].position),h.copy(r[a[i+2]].position),l.sub(n),h.sub(n),c.copy(l).cross(h).normalize(),u=d.sub(n).dot(c);for(let e=0;e<o;e++)if(p=d.copy(r[e].position).sub(n).dot(c),Math.abs(u)>t&&Math.abs(p)>t&&u*p<0)return!1}return!0}},ni=class t{constructor(t,e,i=-1,s=-1,a=0){this.v1=t,this.v2=e,this.t1=i,this.t2=s,this.t1Edge=a}clone(){return new t(this.v1,this.v2,this.t1,this.t2,this.t1Edge)}equals(t){return this.v1===t.v1&&this.v2===t.v2||this.v1===t.v2&&this.v2===t.v1}toString(){return`Edge: T${this.t1}->T${this.t2} (V${this.v1}->V${this.v2})`}},li=class{static getBinNumber(t,e,i){return t%2==0?t*i+e:(t+1)*i-e-1}static sort(t,e,i){if(i<=1)return t;e>t.length&&(e=t.length);const s=new Array(i).fill(0),a=new Array(t.length);for(let i=0;i<e;i++)s[t[i].bin]++;for(let t=1;t<i;t++)s[t]+=s[t-1];for(let i=e-1;i>=0;i--){const e=t[i].bin;s[e]--,a[s[e]]=t[i]}for(let i=e;i<a.length;i++)a[i]=t[i];return a}},hi=class{constructor(t,e){this.index=t,this.coords=e,this.bin=0}toString(){return`${this.coords} -> ${this.bin}`}};const ci=-1;let di=class{constructor(t,i){if(this.normalizationScaleFactor=1,this.N=t.length,this.N>=3){this.triangleCount=2*this.N+1,this.triangulation=Array.from({length:this.triangleCount},(()=>new Array(6).fill(0))),this.skipTriangle=new Array(this.triangleCount).fill(!1),this.points=new Array(this.N+3),this.normal=i.clone().normalize();let r=t[0].position.clone().sub(t[1].position).normalize(),o=this.normal.clone(),n=new e.Vector3;n.crossVectors(r,o).normalize();for(let i=0;i<this.N;i++){var s=t[i].position,a=new e.Vector2(s.dot(r),s.dot(n));this.points[i]=new hi(i,a)}}else this.triangleCount=0,this.triangulation=[],this.skipTriangle=[],this.points=[],this.normal=new e.Vector3}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.discardTrianglesWithSuperTriangleVertices();const t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||t.push(this.triangulation[e][0],this.triangulation[e][1],this.triangulation[e][2]);return t}normalizeCoordinates(){let t=Number.MAX_VALUE,i=Number.MIN_VALUE,s=Number.MAX_VALUE,a=Number.MIN_VALUE;for(let e=0;e<this.N;e++)t=Math.min(t,this.points[e].coords.x),i=Math.max(i,this.points[e].coords.x),s=Math.min(s,this.points[e].coords.y),a=Math.max(a,this.points[e].coords.y);const r=Math.max(i-t,a-s);for(let i=0;i<this.N;i++){var o=this.points[i],n=new e.Vector2((o.coords.x-t)/r,(o.coords.y-s)/r);this.points[i].coords=n}}sortPointsIntoBins(){const t=Math.round(Math.pow(this.N,.25)),e=t*t;for(let e=0;e<this.N;e++){var i=this.points[e];const s=Math.floor(.99*t*i.coords.y),a=Math.floor(.99*t*i.coords.x);i.bin=li.getBinNumber(s,a,t)}return li.sort(this.points,this.N,e)}computeTriangulation(){let t=0,e=0,i=this.sortPointsIntoBins();for(let s=0;s<this.N;s++){let a=i[s];if(!a)break;let r=0,o=!1;for(;!o&&!(r++>e||t===ci);){let i=this.points[this.triangulation[t][0]].coords,s=this.points[this.triangulation[t][1]].coords,r=this.points[this.triangulation[t][2]].coords;$e(i,s,a.coords)?$e(s,r,a.coords)?$e(r,i,a.coords)?(this.insertPointIntoTriangle(a,t,e),e+=2,t=e,o=!0):t=this.triangulation[t][5]:t=this.triangulation[t][4]:t=this.triangulation[t][3]}}}addSuperTriangle(){this.points[this.N]=new hi(this.N,new e.Vector2(-100,-100)),this.points[this.N+1]=new hi(this.N+1,new e.Vector2(0,100)),this.points[this.N+2]=new hi(this.N+2,new e.Vector2(100,-100)),this.triangulation[0][0]=this.N,this.triangulation[0][1]=this.N+1,this.triangulation[0][2]=this.N+2,this.triangulation[0][3]=ci,this.triangulation[0][4]=ci,this.triangulation[0][5]=ci}insertPointIntoTriangle(t,e,i){const s=e,a=i+1,r=i+2;this.triangulation[a][0]=t.index,this.triangulation[a][1]=this.triangulation[e][1],this.triangulation[a][2]=this.triangulation[e][2],this.triangulation[a][3]=r,this.triangulation[a][4]=this.triangulation[e][4],this.triangulation[a][5]=s,this.triangulation[r][0]=t.index,this.triangulation[r][1]=this.triangulation[e][0],this.triangulation[r][2]=this.triangulation[e][1],this.triangulation[r][3]=s,this.triangulation[r][4]=this.triangulation[e][3],this.triangulation[r][5]=a,this.updateAdjacency(this.triangulation[e][3],e,r),this.updateAdjacency(this.triangulation[e][4],e,a),this.triangulation[s][1]=this.triangulation[e][2],this.triangulation[s][2]=this.triangulation[e][0],this.triangulation[s][0]=t.index,this.triangulation[s][4]=this.triangulation[e][5],this.triangulation[s][3]=a,this.triangulation[s][5]=r,this.restoreDelauneyTriangulation(t,s,a,r)}restoreDelauneyTriangulation(t,e,i,s){const a=[];for(a.push([e,this.triangulation[e][4]]),a.push([i,this.triangulation[i][4]]),a.push([s,this.triangulation[s][4]]);a.length>0;)if([e,i]=a.pop()??[ci,ci],i!==ci){const s=this.swapQuadDiagonalIfNeeded(t.index,e,i);null!==s&&(a.push([e,s.t3]),a.push([i,s.t4]))}}swapQuadDiagonalIfNeeded(t,e,i){let s=0,a=0,r=0,o=t,n=0,l=0;return this.triangulation[i][3]===e?(s=this.triangulation[i][1],a=this.triangulation[i][0],r=this.triangulation[i][2],n=this.triangulation[i][4],l=this.triangulation[i][5]):this.triangulation[i][4]===e?(s=this.triangulation[i][2],a=this.triangulation[i][1],r=this.triangulation[i][0],n=this.triangulation[i][5],l=this.triangulation[i][3]):(s=this.triangulation[i][0],a=this.triangulation[i][2],r=this.triangulation[i][1],n=this.triangulation[i][3],l=this.triangulation[i][4]),this.swapTest(this.points[s].coords,this.points[a].coords,this.points[r].coords,this.points[o].coords)?(this.updateAdjacency(n,i,e),this.updateAdjacency(this.triangulation[e][5],e,i),this.triangulation[e][0]=o,this.triangulation[e][1]=s,this.triangulation[e][2]=r,this.triangulation[i][0]=o,this.triangulation[i][1]=r,this.triangulation[i][2]=a,this.triangulation[i][3]=e,this.triangulation[i][4]=l,this.triangulation[i][5]=this.triangulation[e][5],this.triangulation[e][4]=n,this.triangulation[e][5]=i,{t3:n,t4:l}):null}discardTrianglesWithSuperTriangleVertices(){for(let t=0;t<this.triangleCount;t++)(this.triangleContainsVertex(t,this.N)||this.triangleContainsVertex(t,this.N+1)||this.triangleContainsVertex(t,this.N+2))&&(this.skipTriangle[t]=!0)}swapTest(t,e,i,s){const a=t.x-i.x,r=e.x-i.x,o=t.y-i.y,n=e.y-i.y,l=t.x-s.x,h=e.x-s.x,c=t.y-s.y,d=e.y-s.y,u=a*r+o*n,p=h*l+d*c;return!(u>=0&&p>=0)&&(u<0&&p<0||(a*n-r*o)*p+(h*c-l*d)*u<0)}triangleContainsVertex(t,e){return this.triangulation[t][0]===e||this.triangulation[t][1]===e||this.triangulation[t][2]===e}updateAdjacency(t,e,i){if(t===ci)return;const s=this.findSharedEdge(t,e);s&&(this.triangulation[t][s]=i)}findSharedEdge(t,e){return t===ci?null:this.triangulation[t][3]===e?3:this.triangulation[t][4]===e?4:this.triangulation[t][5]===e?5:null}},ui=class{constructor(t,e,i,s,a,r,o,n,l,h){this.q1=t,this.q2=e,this.q3=i,this.q4=s,this.t1=a,this.t2=r,this.t1L=o,this.t1R=n,this.t2L=l,this.t2R=h}toString(){return`T${this.t1}/T${this.t2} (V${this.q1},V${this.q2},V${this.q3},V${this.q4})`}},pi=class extends di{edgeVertex1=[0,0,0,0,1,2];edgeVertex2=[0,0,0,1,2,0];oppositePoint=[0,0,0,2,0,1];nextEdge=[0,0,0,4,5,3];previousEdge=[0,0,0,5,3,4];constructor(t,e,i){super(t,i),this.constraints=e,this.vertexTriangles=[]}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.constraints.length>0&&(this.applyConstraints(),this.discardTrianglesViolatingConstraints()),this.discardTrianglesWithSuperTriangleVertices();let t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||(t.push(this.triangulation[e][0]),t.push(this.triangulation[e][1]),t.push(this.triangulation[e][2]));return t}applyConstraints(){const t=this.triangulation.length;this.vertexTriangles=new Array(this.N+3).fill(0);for(let e=0;e<t;e++)this.vertexTriangles[this.triangulation[e][0]]=e,this.vertexTriangles[this.triangulation[e][1]]=e,this.vertexTriangles[this.triangulation[e][2]]=e;for(let t of this.constraints){if(t.v1===t.v2)continue;const e=this.findIntersectingEdges(t,this.vertexTriangles);this.removeIntersectingEdges(t,e)}}findIntersectingEdges(t,e){const i=[],s=this.findStartingEdge(e,t);if(null===s)return i;i.push(s);let a=s.t1,r=s.t1Edge,o=a,n=!1;for(;!n;){o=a,a=this.triangulation[a][r];const e=this.points[t.v1].coords,s=this.points[t.v2].coords,l=this.points[this.triangulation[a][0]].coords,h=this.points[this.triangulation[a][1]].coords,c=this.points[this.triangulation[a][2]].coords;if(this.triangleContainsVertex(a,t.v2))n=!0;else if(this.triangulation[a][3]!==o&&Ye(e,s,l,h)){r=3;const t=new ni(this.triangulation[a][0],this.triangulation[a][1],a,this.triangulation[a][3],r);i.push(t)}else if(this.triangulation[a][4]!==o&&Ye(e,s,h,c)){r=4;const t=new ni(this.triangulation[a][1],this.triangulation[a][2],a,this.triangulation[a][4],r);i.push(t)}else{if(this.triangulation[a][5]===o||!Ye(e,s,c,l)){console.warn("Failed to find final triangle, exiting early.");break}{r=5;const t=new ni(this.triangulation[a][2],this.triangulation[a][0],a,this.triangulation[a][5],r);i.push(t)}}}return i}findStartingEdge(t,e){let i,s,a,r=new ni(-1,-1),o=e.v1,n=t[o],l=!1,h=null;const c=new Array(this.triangulation.length);for(;!h&&!l;){if(c[n]=!0,this.triangleContainsConstraint(n,e))return null;if(h=this.edgeConstraintIntersectsTriangle(n,e),h)break;if(i=this.triangulation[n][3],s=this.triangulation[n][4],a=this.triangulation[n][5],-1!==i&&!c[i]&&this.triangleContainsVertex(i,o))n=i;else if(-1!==s&&!c[s]&&this.triangleContainsVertex(s,o))n=s;else{if(-1===a||c[a]||!this.triangleContainsVertex(a,o)){l=!0;break}n=a}}if(h){const t=this.triangulation[n][this.edgeVertex1[h]],e=this.triangulation[n][this.edgeVertex2[h]],i=this.triangulation[n][h];return r=new ni(t,e,n,i,h),r}return null}removeIntersectingEdges(t,e){let i,s=[],a=0;for(;e.length>0&&a<=e.length;){i=e.shift(),null==i&&console.log("no edge !!");let r=this.findQuadFromSharedEdge(i.t1,i.t1Edge);if(r)if(Ye(this.points[r.q4].coords,this.points[r.q3].coords,this.points[r.q1].coords,this.points[r.q2].coords)){this.swapQuadDiagonal(r,e,s,this.constraints);let i=new ni(r.q3,r.q4,r.t1,r.t2,5);Ye(this.points[t.v1].coords,this.points[t.v2].coords,this.points[r.q3].coords,this.points[r.q4].coords)?e.push(i):(a=0,s.push(i))}else e.push(i);a++}s.length>0&&this.restoreConstrainedDelauneyTriangulation(t,s)}restoreConstrainedDelauneyTriangulation(t,e){let i=!0;for(;i;){i=!1;for(let s=0;s<e.length;s++){const a=e[s];if(a.equals(t))continue;let r=this.findQuadFromSharedEdge(a.t1,a.t1Edge);if(r&&this.swapTest(this.points[r.q1].coords,this.points[r.q2].coords,this.points[r.q3].coords,this.points[r.q4].coords)){this.swapQuadDiagonal(r,e,this.constraints,null);const t=r.q3,a=r.q4;e[s]=new ni(t,a,r.t1,r.t2,5),i=!0}}}}discardTrianglesViolatingConstraints(){this.skipTriangle.fill(!0);let t=new Set;for(let e=0;e<this.constraints.length;e++){const i=this.constraints[e];t.add(ei(i.v1,i.v2))}let e,i,s,a,r,o,n,l,h,c=[];const d=new Array(this.triangulation.length);for(let u=0;u<this.triangleCount;u++)if(!d[u]&&(e=this.triangulation[u][0],i=this.triangulation[u][1],s=this.triangulation[u][2],a=t.has(ei(e,i)),r=t.has(ei(i,s)),o=t.has(ei(s,e)),n=t.has(ei(i,e)),l=t.has(ei(s,i)),h=t.has(ei(e,s)),!(n||l||h)&&(a||r||o)))for(this.skipTriangle[u]=!1,c=[],a||c.push(this.triangulation[u][3]),r||c.push(this.triangulation[u][4]),o||c.push(this.triangulation[u][5]);c.length>0;){const a=c.shift();void 0===a||-1===a||d[a]||(e=this.triangulation[a][0],i=this.triangulation[a][1],s=this.triangulation[a][2],n=t.has(ei(i,e)),l=t.has(ei(s,i)),h=t.has(ei(e,s)),n||l||h?d[a]=!0:(this.skipTriangle[a]=!1,d[a]=!0,t.has(ei(e,i))||c.push(this.triangulation[a][3]),t.has(ei(i,s))||c.push(this.triangulation[a][4]),t.has(ei(s,e))||c.push(this.triangulation[a][5])))}}triangleContainsConstraint(t,e){return!(t>=this.triangulation.length||this.triangulation[t][0]!==e.v1&&this.triangulation[t][1]!==e.v1&&this.triangulation[t][2]!==e.v1||this.triangulation[t][0]!==e.v2&&this.triangulation[t][1]!==e.v2&&this.triangulation[t][2]!==e.v2)}edgeConstraintIntersectsTriangle(t,e){const i=this.points[e.v1].coords,s=this.points[e.v2].coords,a=this.points[this.triangulation[t][0]].coords,r=this.points[this.triangulation[t][1]].coords,o=this.points[this.triangulation[t][2]].coords;return Ye(i,s,a,r)?3:Ye(i,s,r,o)?4:Ye(i,s,o,a)?5:null}findQuadFromSharedEdge(t,e){let i,s,a,r,o,n,l,h,c=this.triangulation[t][e],d=this.findSharedEdge(c,t);return d?(3===d?(s=this.triangulation[c][0],i=this.triangulation[c][1],a=this.triangulation[c][2]):4===d?(s=this.triangulation[c][1],i=this.triangulation[c][2],a=this.triangulation[c][0]):(s=this.triangulation[c][2],i=this.triangulation[c][0],a=this.triangulation[c][1]),r=this.triangulation[t][this.oppositePoint[e]],o=this.triangulation[t][this.previousEdge[e]],n=this.triangulation[t][this.nextEdge[e]],l=this.triangulation[c][this.nextEdge[d]],h=this.triangulation[c][this.previousEdge[d]],new ui(i,s,a,r,t,c,o,n,l,h)):null}swapQuadDiagonal(t,e,i,s){const a=t.t1,r=t.t2,o=t.t1R,n=t.t1L,l=t.t2R,h=t.t2L;this.triangulation[a][0]=t.q4,this.triangulation[a][1]=t.q1,this.triangulation[a][2]=t.q3,this.triangulation[r][0]=t.q4,this.triangulation[r][1]=t.q3,this.triangulation[r][2]=t.q2,this.triangulation[a][3]=n,this.triangulation[a][4]=h,this.triangulation[a][5]=r,this.triangulation[r][3]=a,this.triangulation[r][4]=l,this.triangulation[r][5]=o,this.updateAdjacency(h,r,a),this.updateAdjacency(o,a,r),this.updateEdgesAfterSwap(e,a,r,n,o,h,l),this.updateEdgesAfterSwap(i,a,r,n,o,h,l),this.updateEdgesAfterSwap(s,a,r,n,o,h,l),this.vertexTriangles[t.q1]=a,this.vertexTriangles[t.q2]=r}updateEdgesAfterSwap(t,e,i,s,a,r,o){if(t)for(let n of t)n.t1===e&&n.t2===a?(n.t1=i,n.t2=a,n.t1Edge=5):n.t1===e&&n.t2===s?n.t1Edge=3:n.t1===a&&n.t2===e?n.t2=i:n.t1===s&&n.t2===e||(n.t1===i&&n.t2===o?n.t1Edge=4:n.t1===i&&n.t2===r?(n.t1=e,n.t2=r,n.t1Edge=4):n.t1===o&&n.t2===i||n.t1===r&&n.t2===i&&(n.t2=e))}};function mi(t,e,i,s,a,r,o){const n=t.triangles[o];let l,h,c;for(let d=0;d<n.length;d+=3)l=n[d],h=n[d+1],c=n[d+2],r[l]&&r[h]&&r[c]?e.addMappedTriangle(l,h,c,o):r[l]||r[h]||r[c]?r[h]&&r[c]&&!r[l]?fi(h,c,l,s,a,t,e,i,o,!0):r[c]&&r[l]&&!r[h]?fi(c,l,h,s,a,t,e,i,o,!0):r[l]&&r[h]&&!r[c]?fi(l,h,c,s,a,t,e,i,o,!0):r[h]||r[c]||!r[l]?r[c]||r[l]||!r[h]?r[l]||r[h]||!r[c]||fi(l,h,c,s,a,t,e,i,o,!1):fi(c,l,h,s,a,t,e,i,o,!1):fi(h,c,l,s,a,t,e,i,o,!1):i.addMappedTriangle(l,h,c,o)}function fi(t,i,s,a,r,o,n,l,h,c){const d=o.vertices.length;let u=t<d?o.vertices[t]:o.cutVertices[t-d],p=i<d?o.vertices[i]:o.cutVertices[i-d],m=s<d?o.vertices[s]:o.cutVertices[s-d];const f=Ze(u.position,m.position,a,r),b=Ze(p.position,m.position,a,r);if(f&&b){const a=new e.Vector3(u.normal.x+f.s*(m.normal.x-u.normal.x),u.normal.y+f.s*(m.normal.y-u.normal.y),u.normal.z+f.s*(m.normal.z-u.normal.z)).normalize(),r=new e.Vector3(p.normal.x+b.s*(m.normal.x-p.normal.x),p.normal.y+b.s*(m.normal.y-p.normal.y),p.normal.z+b.s*(m.normal.z-p.normal.z)).normalize(),o=new e.Vector2(u.uv.x+f.s*(m.uv.x-u.uv.x),u.uv.y+f.s*(m.uv.y-u.uv.y)),d=new e.Vector2(p.uv.x+b.s*(m.uv.x-p.uv.x),p.uv.y+b.s*(m.uv.y-p.uv.y));n.addCutFaceVertex(f.x,a,o),n.addCutFaceVertex(b.x,r,d),l.addCutFaceVertex(f.x,a,o),l.addCutFaceVertex(b.x,r,d);const g=n.vertices.length,y=l.vertices.length,x=n.cutVertices.length,v=l.cutVertices.length,w=g-2,M=g-1,k=y-2,A=y-1;c?(n.addTriangle(M,w,n.indexMap[i],h),n.addTriangle(w,n.indexMap[t],n.indexMap[i],h),l.addTriangle(l.indexMap[s],k,A,h),n.constraints.push(new ni(x-2,x-1)),l.constraints.push(new ni(v-1,v-2))):(n.addTriangle(w,M,n.indexMap[s],h),l.addTriangle(l.indexMap[t],l.indexMap[i],k,h),l.addTriangle(l.indexMap[i],A,k,h),n.constraints.push(new ni(x-1,x-2)),l.constraints.push(new ni(v-2,v-1)))}}let bi=class{constructor(t){this.parent=[],this.rank=[];for(let e=0;e<t;e++)this.parent[e]=e,this.rank[e]=1}find(t){return this.parent[t]!==t&&(this.parent[t]=this.find(this.parent[t])),this.parent[t]}union(t,e){const i=this.find(t),s=this.find(e);i!==s&&(this.rank[i]>this.rank[s]?this.parent[s]=i:this.rank[i]<this.rank[s]?this.parent[i]=s:(this.parent[s]=i,this.rank[i]+=1))}};function gi(t){const e=new bi(t.vertexCount),i={},s=t.vertices.length,a=t.cutVertices.length,r=new Map;t.vertices.forEach(((t,i)=>{const s=si(t.position),a=r.get(s);void 0===a?r.set(s,i):e.union(a,i)}));for(let i=0;i<a;i++)e.union(t.vertexAdjacency[i],i+s);const o=t.triangles;for(let t=0;t<o.length;t++)for(let s=0;s<o[t].length;s+=3){const a=o[t][s],r=o[t][s+1],n=o[t][s+2];e.union(a,r),e.union(r,n);const l=e.find(a);i[l]||(i[l]=[[],[]]),i[l][t].push(a,r,n)}const n={},l=Array(t.vertexCount);for(let i=0;i<s;i++){const s=e.find(i);n[s]||(n[s]=new oi),n[s].vertices.push(t.vertices[i]),l[i]=n[s].vertices.length-1}for(let i=0;i<a;i++){const a=e.find(i+s);n[a].cutVertices.push(t.cutVertices[i]),l[i+s]=n[a].vertices.length+n[a].cutVertices.length-1}for(const s of Object.keys(i)){let a=Number(s),r=e.parent[a];for(let e=0;e<t.triangles.length;e++)for(const t of i[a][e]){const i=l[t];n[r].triangles[e].push(i)}}return Object.values(n)}const yi={textureScale:new e.Vector2(1,1),textureOffset:new e.Vector2},xi=new e.Vector3,vi=new e.Vector3,wi=new e.Vector3,Mi=new e.Plane,ki=new e.Plane;function Ai(t,i,s,a,r,o){const n=[],l=t.matrixWorld.clone().invert(),h=t.position;i.applyMatrix4(l);const c=function(t){const i=t.attributes.position.array,s=t.attributes.normal.array,a=t.attributes.uv?.array,r=new oi,o=t.attributes.position.count;let n,l,h;for(let t=0;t<o;t++){n=3*t,l=2*t;const o=new e.Vector3(i[n],i[n+1],i[n+2]),h=new e.Vector3(s[n],s[n+1],s[n+2]),c=a?new e.Vector2(a[l],a[l+1]):new e.Vector2(0,0);r.vertices.push(new ri(o,h,c))}if(t.index)h=Array.from(t.index.array);else{const t=i.length/3;h=Array.from({length:t},((t,e)=>e))}if(t.groups&&2===t.groups.length){const e=[],i=[];for(const s of t.groups){const t=0===s.materialIndex?e:i,a=s.start,r=a+s.count;for(let e=a;e<r;e++)t.push(h[e])}r.triangles=[e,i]}else r.triangles=[h,[]];return r.calculateBounds(),r}(t.geometry);let d=c.convex,u=.03*c.volume();xi.addVectors(i,s),Mi.setFromCoplanarPoints(i,h,xi);const p=r+a;return function t(r,c,m,f){if(!r)return;if(Math.random()<.05*f||f>p)return void(r.valid&&n.push(r));let b=Math.PI,g=new e.Vector3;r.calculateBounds(),r.bounds.getCenter(g);let y=d;if(0===f)ki.normal.copy(Mi.normal),ki.constant=Mi.constant;else if(f<=a)b=(m-c)*(.2+.6*Math.random())+c,vi.copy(h).sub(i).applyAxisAngle(s,b).add(i),ki.setFromCoplanarPoints(i,xi,vi);else{let t=g.clone().applyMatrix4(l);b=(.5*(1&f)+.2*(2-Math.random()))*Math.PI,vi.copy(i).sub(t).applyAxisAngle(s,b).add(t),wi.copy(s).add(t),ki.setFromCoplanarPoints(t,wi,vi)}const{topSlice:x,bottomSlice:v}=function(t,i,s,a,r,o=!1,n=!0){const l=new oi,h=new oi,c=new Array(t.vertexCount).fill(!1);for(let e=0;e<t.vertices.length;e++){const a=t.vertices[e];c[e]=ai(a.position,i,s),(c[e]?l:h).addMappedVertex(a,e)}const d=t.vertices.length;for(let e=0;e<t.cutVertices.length;e++){const a=t.cutVertices[e];c[e+d]=ai(a.position,i,s),(c[e+d]?l:h).addMappedVertex(a,e+d)}return mi(t,l,h,i,s,c,0),n&&mi(t,l,h,i,s,c,1),n&&function(t,i,s,a,r,o){if(t.weldCutFaceVertices(),i.weldCutFaceVertices(),t.cutVertices.length<3)return;const n=o?new di(t.cutVertices,s):new pi(t.cutVertices,t.constraints,s),l=n.triangulate();for(let o=0;o<t.cutVertices.length;o++){var h=t.cutVertices[o],c=n.points[o];const l=new e.Vector2(n.normalizationScaleFactor*c.coords.x*a.x+r.x,n.normalizationScaleFactor*c.coords.y*a.y+r.y),d=new ri(h.position.clone(),s.clone(),l.clone()),u=new ri(h.position.clone(),s.clone().negate(),l.clone());t.cutVertices[o]=d,i.cutVertices[o]=u}let d=t.vertices.length,u=i.vertices.length;for(let e=0;e<l.length;e+=3)t.addTriangle(d+l[e],d+l[e+1],d+l[e+2],1),i.addTriangle(u+l[e],u+l[e+2],u+l[e+1],1)}(l,h,i.clone().negate(),a,r,o),{topSlice:l,bottomSlice:h}}(r,ki.normal,vi,yi.textureScale,yi.textureOffset,y,o);let w=x,M=v;w=gi(x),M=gi(v),w&&(w.isFragment&&(w=[w]),w=Si(w,u),w.length>0&&w.forEach(((e,i)=>{0===i?t(e,b,m,f+1):n.push(e)}))),M&&(M.isFragment&&(M=[M]),M=Si(M,u),M.length>0&&M.forEach(((e,i)=>{0===i?t(e,b,m,f+1):n.push(e)})))}(c,0,2*Math.PI,0),n}function Si(t,e){if(0===t.length)return[];let i=0,s=-1,a=[];return t.forEach(((t,a)=>{t.minSize=e,t.bounds=null;let r=.5*t.size.length();t.valid&&r>0?r>i&&(i=r,s=a):t.good=!1})),-1!==s&&a.push(t[s]),t.forEach(((t,e)=>{t.good&&e!==s&&a.push(t)})),a}class Ti{constructor(t){this.motor=t,this.tpos=new e.Vector3,this.tnormal=new e.Vector3,this.nDebris=0,this.maxDebris=1500,this.interneMat=this.motor.getMat("chrome"),this.tt=null}add(t,e=[]){let i=this,s=0;-1!==t.name.search("_debris_")&&(s=1e3),setTimeout((()=>{i.motor.addCollision({name:t.name,ignore:t.ignore}),t.addEventListener("collision",(t=>{let e=t.data;1===e.hit&&i.makeBreak(e.from,e.point,e.normal,e.impulse,e.v1)}))}),s)}makeBreak(t,i,s,a,r){let o=this.motor.byName(t);if(!o)return;if(!o.breakable)return;let n=o.breakOption;const l=void 0===n[4]||n[4];if(a<n[0])return;this.motor.removeCollision(t),this.motor.remove(t);const h=new e.Vector3;o.geometry.boundingBox.getSize(h);const c=h.length();let d=function(t,e,i,s=!0,a=0){const r=[];return t.map(((t,o)=>{r.push(t.toMesh(e,i,s,a))})),r}(Ai(o,this.tpos.fromArray(i),this.tnormal.fromArray(s),n[1],n[2],l),o,this.interneMat,l,0);if(d.length<1)return;let u,p,m,f,b,g=[],y=d.length,x=0,v=[...o.ignore];for(;y--;)u=d[x],p=u.geometry.attributes.position.count,m=u.sizer/c,f={},b=[...n],b[3]=b[3]-1,m<.2&&(b[3]=0),u.sizer>.02&&p>6&&(this.nDebris++,f.name=t+"_debris_"+x,f.mass=o.mass*m,g.push(this.addDebris(u,b,f)),v.push(f.name)),x++;for(y=g.length;y--;)g[y].ignore=v;this.motor.add(g)}addDebris(t,e,i){let s=e[3]>0;return{...i,type:"convex",shape:t.geometry,material:t.material,pos:t.position.toArray(),quat:t.quaternion.toArray(),breakable:s,breakOption:e}}}class Pi{constructor(t={},e){this.motor=e,this.utils=this.motor.utils,this.id=0,this.type="autoRagdoll",this.name=t.name||this.type+this.id++;let i=this.utils.byName(this.name);i&&this.utils.remove(i),this._mode=t.mode||"follow",this._size=t.size||1,this._debug=t.debug||!1;const s=g.clone(t.model);let a;s.scale.set(1,1,1).multiplyScalar(this._size),t.pos&&s.position.fromArray(t.pos),s.raycast=function(){},s.name=this.name,s.traverse((e=>{e.isMesh&&(e.frustumCulled=!1),e.isSkinnedMesh&&(e.raycast=function(){},e.frustumCulled=!1,e.matrixAutoUpdate=!1,e.receiveShadow=!0,e.castShadow=!0,t.material&&(e.material=t.material),e.skeleton.resetScalling(),a=e.skeleton.bones)}));let r=t.mass||null;return this.skeletonBody=new Ut(this.motor,s.name,s,a,r,t.option),this.debug=this._debug,this.mode=this._mode,s.add(this.skeletonBody),this.model=s,this.utils.add(this),this}getRealPosition(){return this.utils.byName(this.skeletonBody.nodes[0].name).position}dispose(){this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.parent.remove(this.model)}get position(){return model.position}get size(){return this._size}set size(t){this._size=t,this.model.scale.set(1,1,1).multiplyScalar(this._size)}get debug(){return this._debug}set debug(t){this._debug=t,this.skeletonBody.isVisible(this._debug)}get mode(){return this._mode}set mode(t){this._mode=t,this.skeletonBody.setMode(this._mode)}}class zi extends e.LineSegments{constructor(t){super(),this.rayCount=0,this.ray=[],this.motor=t,this.maxVertices=1e4,this.currentVertex=0,this.geometry=new e.BufferGeometry,this.geometry.setAttribute("position",new e.Float32BufferAttribute(3*this.maxVertices,3)),this.geometry.setAttribute("color",new e.Float32BufferAttribute(3*this.maxVertices,3)),this.positions=this.geometry.attributes.position.array,this.colors=this.geometry.attributes.color.array,this.material=new e.LineBasicMaterial({vertexColors:!0,toneMapped:!1,depthTest:!1,depthWrite:!1}),this.material.transparent=!0,this.renderOrder=3e4,this.frustumCulled=!1}DrawRay(t,i,s){s=new e.Color(s);let a=this.currentVertex,r=3*a;this.positions[r]=t.x,this.positions[r+1]=t.y,this.positions[r+2]=t.z,this.colors[r]=s.r,this.colors[r+1]=s.g,this.colors[r+2]=s.b,a++,r=3*a,this.positions[r]=t.x+i.x,this.positions[r+1]=t.y+i.y,this.positions[r+2]=t.z+i.z,this.colors[r]=s.r,this.colors[r+1]=s.g,this.colors[r+2]=s.b,this.currentVertex+=2}collapseBuffer(){let t=this.maxVertices,e=this.currentVertex,i=0;for(;t>=e;)i=3*t,this.positions[i]=0,this.positions[i+1]=0,this.positions[i+2]=0,this.colors[i]=0,this.colors[i+1]=0,this.colors[i+2]=0,t--}insertLine(t,e,i){let s=this.currentVertex,a=3*s;this.positions[a]=t.x,this.positions[a+1]=t.y,this.positions[a+2]=t.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,s++,a=3*s,this.positions[a]=e.x,this.positions[a+1]=e.y,this.positions[a+2]=e.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,this.currentVertex+=2}draw(){this.collapseBuffer(),this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.currentVertex=0}dispose(){this.parent.remove(this),this.material.dispose(),this.geometry.dispose()}}const Ri={sunPosition:new e.Vector3(.27,1,.5),sunTop:new e.Vector3(0,.99,0),saturation:1,noiseMap:null,nightLuminosity:.03,cloud_size:.29,cloud_covr:.1,cloud_dens:.4,cloud_dist:.64,haze:.1,mixRatio:.76,SAMPLE:64,STEP:4,cloudColor:new e.Color(16777209).multiplyScalar(1),skyColor:new e.Color(4348022),fogColor:new e.Color(11253184),groundColor:new e.Color(8421504),sunColor:new e.Color(16777215).multiplyScalar(3)},Ei={defines:{USE_NOISE_MAP:!1},uniforms:{lightdir:{value:Ri.sunPosition},sunTop:{value:Ri.sunTop},noiseMap:{value:Ri.noiseMap},mixRatio:{value:Ri.mixRatio},cloud_size:{value:Ri.cloud_size},cloud_covr:{value:Ri.cloud_covr},cloud_dens:{value:Ri.cloud_dens},cloud_dist:{value:Ri.cloud_dist},nightLuminosity:{value:Ri.nightLuminosity},haze:{value:Ri.haze},saturation:{value:Ri.saturation},SAMPLE:{value:Ri.SAMPLE},STEP:{value:Ri.STEP},fogy:{value:Ri.fogy},t:{value:1},fogColor:{value:Ri.fogColor},groundColor:{value:Ri.groundColor},cloudColor:{value:Ri.cloudColor},skyColor:{value:Ri.skyColor},sunColor:{value:Ri.sunColor}},vertexShader:"\nvarying vec3 worldPosition;\nvoid main()\t{\n\tworldPosition = ( modelMatrix * vec4( position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n//precision highp float;\nvarying vec3 worldPosition;\n\nuniform vec3 fogColor;\nuniform vec3 groundColor;\nuniform vec3 cloudColor;\nuniform vec3 skyColor;\nuniform vec3 sunColor;\n\nuniform float saturation;\n\nuniform float hue;\nuniform float mixRatio;\nuniform float fogy;\n\nuniform vec3 sunTop;\n\nuniform sampler2D noiseMap;\nuniform vec3 lightdir;\n\nuniform float cloud_size;\nuniform float cloud_covr;\nuniform float cloud_dens;\nuniform float cloud_dist;\n\nuniform float nightLuminosity;\nuniform float haze;\nuniform float t;\n\nuniform int SAMPLE;\nuniform int STEP;\n\n//const float c = 6.36e6;\n//const float d = 6.38e6;\nconst float c = 6.407e6;\nconst float d = 6.416e6;\n\n//const float g = 0.76; // mix ratio\n//const float h = g*g;\nconst float icc = 1.0/8e3;\nconst float jcc = 1.0/1200.0;\nconst float pi = 3.141592653589793;\n\nconst vec3 vm = vec3( 0,-c,0 );\n//const vec3 vn = vec3( 2.1e-5 );\n//const vec3 vo = vec3( 5.8e-6, 1.35e-5, 3.31e-5 );\n\n//const vec3 vn = vec3( 0.000021 );\n//const vec3 vo = vec3( 0.0000058, 0.0000135, 0.0000331 );// sky base color\n\n//const vec3 vo = vec3( 0.000021 );// sky base color\n\n\n#ifdef USE_NOISE_MAP\n\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;\n    vec2 rg = texture2D( noiseMap, (uv+0.5)/256.0, -16.0 ).yx;\n    return mix( rg.x, rg.y, f.z );\n}\n\n#else\n\nfloat hash( float n ) { return fract(sin(n)*753.5453123); }\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    float n = p.x + p.y*157.0 + 113.0*p.z;\n    return mix(mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n                   mix( hash(n+157.0), hash(n+158.0),f.x),f.y),\n               mix(mix( hash(n+113.0), hash(n+114.0),f.x),\n                   mix( hash(n+270.0), hash(n+271.0),f.x),f.y),f.z);\n}\n\n#endif\n\nfloat NOISE( vec3 r )\n{\n\tr.xz += t;\n\tr *= 0.5;\n\tfloat s;\n\ts = 0.5 * noise(r);\n\tr = r * 2.52;\n\ts += 0.25 * noise(r);\n\tr = r * 2.53;\n\ts += 0.125 * noise(r);\n\tr = r * 2.51;\n\ts += 0.0625 * noise(r);\n\tr = r * 2.53;\n\ts += 0.03125 * noise(r);\n\tr = r * 2.52;\n\ts += 0.015625 * noise(r);\n\treturn s;\n}\n\nfloat MakeNoise( vec3 r )\n{\n\tfloat s,tt;\n\ts = NOISE( r * 2e-4 * ( 1.0 - cloud_size ) );\n\ttt = ( 1.0 - cloud_covr ) * 0.5 + 0.2;\n\ts = smoothstep( tt, tt+.2 , s );\n\ts *= 0.5*(cloud_dens*100.0);\n\treturn s;\n}\n\nvoid clouds( in vec3 r, out vec3 u )\n{\n\tfloat v,w;\n\tv = length( r-vm ) - c;\n\tw = 0.0;\n\tif( 5e3 < v && v < 1e4 ) w = MakeNoise( r ) * (sin( pi*(v-5e3)/5e3 ));\n\tu = vec3( exp(-v*icc), exp(-v*jcc), w );\n}\n\nfloat ca( in vec3 r, in vec3 s, in float t )\n{\n\tvec3 u = r - vm;\n\tfloat v,w,x,y,z,A;\n\tv = dot(u,s);\n\tw = dot(u,u)-t*t;\n\tx = v*v-w;\n\tif( x < 0.0 ) return -1.0;\n\ty = sqrt(x);\n\tz = -v-y;\n\tA = -v+y;\n\treturn z >= 0.0 ? z : A;\n}\n\nvec3 czm_saturation(vec3 rgb, float adjustment)\n{\n    vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(rgb, W));\n    return mix(intensity, rgb, adjustment);\n}\n\n\nvec3 makeSky( in vec3 lightpos, in vec3 r, in vec3 world, out float mask )\n{\n\n\tvec3 vn = vec3( 0.000021 );\n\tvec3 vo = skyColor;\n\tvo *= 0.00005;\n\n\tfloat u,v,w,x,y,z,m, M, N, S, H, F;\n\tvec3 p = lightpos;\n\tu = ca(r,world,d);\n\tv = dot(world,p);\n\tw = 1.0+v*v;\n\n\tfloat gg = mixRatio;\n\tfloat hh = gg*gg;\n\n\tx = 0.0596831*w;\n\ty = 0.0253662*(1.0-hh)*w/((2.0+hh)*pow(abs(1.0+hh-2.0*gg*v),1.5));\n\tz = 50.*pow(abs(1.+dot(world,-p)),2.0)*dot(vec3(0.,1.,0.),p)*(1.0-cloud_covr)*(1.0-min(fogy,1.0));\n\n\tm = 0.0;\n\tvec3 D,E, CB, CM, BB, BM, SX;\n\n\tF = u / float( SAMPLE );\n\n\tBB = vec3(0.0);\n\tBM = vec3(0.0);\n\n\tfloat count = 0.0;\n\n\tfor( int G=0; G<SAMPLE; ++G ){\n\n\t\tH = float(G)*F;\n\t\tvec3 I = r + world * H;\n\t\t//CB = vec3(1.0);\n\t\t//BB = vec3(0.0);\n\t\tclouds( I, CB );\n\t\tCB += fogy;// add fog\n\t\tCB.y += CB.z;// add clound\n\t\tCB.xy *= F;\n\t\tBB += CB;\n\n\t\tM = ca(I,p,d);\n\n\t\tif( M > 0.0 ){\n\n\t\t\tN = M/float(STEP);\n\t\t\tBM = vec3(0.0);\n\n\t\t\tfor( int R=0; R<STEP; ++R ){\n\n\t\t\t\tS = float(R)*N;\n\t\t\t\tvec3 T=I+p*S;\n\t\t\t\tclouds( T, CM );\n\t\t\t\tCM += fogy;// add fog\n\t\t\t\tCM.y += CM.z;// add clound\n\t\t\t\tBM += CM * N;\n\n\t\t\t}\n\n\t\t\tSX = exp(-(vo*(BM.x+BB.x)+vn*(BM.y+BB.y)* cloud_dist));\n\n\t\t\tm += CB.z;\n\t\t\tcount += 1.0;\n\t\t\tD += SX*CB.x;\n\t\t\tE += (SX*CB.y)+z*m;\n\t\t}\n\t\telse return vec3(0.0);\n\t}\n\t//mask = m * 0.0125;\n\t//mask = m / count;\n\tmask = m / float( SAMPLE );\n\n\treturn ((D * vo * x ) + (E * vn * y * sunColor)) * 15.0;\n}\n\n\nvoid main()\n{\n\tvec3 light = normalize( lightdir );\n\tvec3 world = normalize( worldPosition.xyz );\n\n\tfloat uvy = acos( world.y ) / pi;\n\n\t//float luma = smoothstep(0.0, 4.0,  1.0-(abs(world.y)/0.8) );\n    //float mid = smoothstep(0.0, 1.0,  abs(world.y) < haze ? 1.0-(abs(world.y)/(haze*1.0)) : 0.0 );\n    //mid *= nightLuminosity;//pow(  mid, 1.0 );\n\n    // ground reapeat sky\n\t//if( world.y < -0.15) world.y = -0.15+((-world.y-0.15)*0.1);\n\tif( world.y < 0.0) world.y = -world.y;\n\n\tfloat high = smoothstep(1.0, 0.0, (uvy)*10000.0);\n\tfloat top =  smoothstep(1.0, 0.0, (uvy-0.5)*50.0);\n\tfloat middle = uvy > 0.5 ? high : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tfloat middle2 = uvy > 0.5 ? smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0)) : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tvec3 s = sunTop;\n\tfloat lm = dot( s, light );\n\tfloat day = clamp((lm*4.0), 0.0, (1.0-nightLuminosity) )+nightLuminosity;\n\n\tif(lm <= 0.0) light *= -1.0;\n\tlight.y = abs(light.y);\n\n\t//if(light.y < 0.1) light.y = 0.1;\n\tlight.y = clamp(light.y, 0.1, 1.0 );\n\t//light.y += 0.5;\n\n\tfloat mask = 0.0;\n\n\tvec3 sky = makeSky( light, s, world, mask );\n\tmask = clamp(mask, 0.0, 1.0 );\n\tsky = mix( sky, cloudColor, mask ); //apply cloud color\n\t\n\n\t//sky = mix( sky, groundColor, 1.0-middle ); // apply ground color\n\tsky = mix( sky, fogColor, 1.0-middle2 ); // apply fog color\n\t\n    //float dd = clamp(day+(nightLuminosity*0.5), 0.0, 1.0);\n\t//luma *= 1.0-dd;\n\t//clear = mix( clear, clear+skyColor, luma ); // extra luminosity on night\n\n\tsky *= day;\n\t//sky = czm_saturation(sky, saturation);\n    //sky = clamp(sky, 0.0, 1.0 );\n\n\n \tgl_FragColor = vec4( sky, 1.0 );\n\n}\n",depthWrite:!1,depthTest:!1,side:1,toneMapped:!1,fog:!1},Fi=Math.PI/180;class Bi{constructor(t={}){this.mainScene=t.scene,this.renderer=t.renderer,this.usePrem=void 0!==t.usePmrem&&t.usePmrem,this.useBackground=void 0===t.useBackground||t.useBackground,this.envBlur=void 0!==t.envBlur?t.envBlur:0,this.callback=t.callback||null,this.isSky=!1,this.usePrem&&(this.pmremGenerator=new e.PMREMGenerator(this.renderer),this.pmremGenerator.compileEquirectangularShader()),t.cube&&this.initCubeEnv(t),t.url&&this.load(t.url)}initCubeEnv(t={}){this.isCubeEnv=!0,this._quality=t.quality||1,this.scene=new e.Scene,t.color&&(this.scene.background=new e.Color(t.color)),this.target=new e.WebGLCubeRenderTarget(256*this._quality,{minFilter:e.LinearFilter,type:e.HalfFloatType,colorSpace:e.SRGBColorSpace,anisotropy:1}),this.camera=new e.CubeCamera(t.near||.1,t.far||100,this.target),this.mainScene.environment=this.target.texture,this.useBackground&&(this.mainScene.background=this.target.texture)}addSky(){let t=new e.IcosahedronGeometry(20,1);const i=new e.ShaderMaterial(Ei);this.sky=new e.Mesh(t,i),this.scene.add(this.sky),this.render(),this.isSky=!0}getSkyOtion(){if(this.isSky)return Ri}setSkyOtion(t){if(!this.isSky)return;let e=this.sky.material.uniforms;for(let i in t)e[i]&&(e[i].value=t[i]);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.render.bind(this),0)}render(){if(!this.isCubeEnv)return;const t=this.renderer,i=t.toneMapping;t.toneMapping=e.NoToneMapping,this.camera.update(t,this.scene),t.toneMapping=i}load(t){switch(this.name=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),this.type=t.substring(t.lastIndexOf(".")+1).toLowerCase(),this.loader=null,this.type){case"hdr":this.loader=(new c.HDRLoader).load(t,this.end.bind(this),null,this.bug.bind(this));break;case"exr":this.loader=(new d.EXRLoader).load(t,this.end.bind(this),null,this.bug.bind(this))}}bug(){console.log("Envmap is not find :",this.name),this.callback&&this.callback()}end(){let t;switch(this.type){case"hdr":case"exr":t=this.loader,t.mapping=e.EquirectangularReflectionMapping;break;case"jpg":t=this.loader.renderTarget.texture,t.mapping=e.EquirectangularReflectionMapping}this.usePrem&&(t=this.pmremGenerator.fromEquirectangular(t).texture,this.pmremGenerator.dispose()),t.needsUpdate=!0;const i=this.isCubeEnv?this.scene:this.mainScene;(this.isCubeEnv||this.useBackground)&&(i.background=t),this.envBlur&&(i.backgroundBlurriness=this.envBlur),i.environment=t,this.loader.dispose(),this.callback&&this.callback()}get intensity(){return this.mainScene.environmentIntensity}set intensity(t){this.mainScene.environmentIntensity=t}get bgIntensity(){return this.mainScene.backgroundIntensity}set bgIntensity(t){this.mainScene.backgroundIntensity=t}get blur(){return this.mainScene.backgroundBlurriness}set blur(t){this.mainScene.backgroundBlurriness=t}rotate(t=0,e=0,i=0){0!==t&&(t*=Fi),0!==e&&(e*=Fi),0!==i&&(i*=Fi),this.mainScene.environmentRotation.set(t,e,i),this.mainScene.backgroundRotation.set(t,e,i)}}class Ci extends e.BufferGeometry{constructor(t=1,s=1,a=1,r=.01,o=1,n=1,l=1,h=2){super(),this.type="ChamferBox",o=Math.floor(o),n=Math.floor(n),l=Math.floor(l),h=Math.floor(h);let c=Math.PI,d=.5*c,u=2*r,p=.5*t,m=.5*s,f=.5*a,b=new e.Matrix4,g=new e.Matrix4,y=new e.Matrix4,x=r/t,v=1-2*x,w=r/s,M=1-2*x,k=r/a,A=1-2*k,S=new e.PlaneGeometry(t-u,s-u,o,n),T=new e.CylinderGeometry(r,r,t-u,h,o,!0,0,d),P=new e.CylinderGeometry(r,r,s-u,h,n,!0,0,d),z=new Li(r,h,h,0,d,0,-d),R=new Li(r,h,h,0,d,0,-d);_i(S,-x,w,v,M),_i(T,0,x,w,v),g.makeTranslation(0,m-r,0),b.makeRotationX(d),z.applyMatrix4(g.multiply(b)),g.makeTranslation(0,-m+r,0),b.makeRotationX(d),y.makeRotationY(-d),R.applyMatrix4(g.multiply(b).multiply(y));let E=i.mergeGeometries([P,z,R]),F=E.clone();g.makeTranslation(p-r,0,-r),E.applyMatrix4(g),g.makeTranslation(-p+r,0,-r),b.makeRotationZ(c),F.applyMatrix4(g.multiply(b));let B=T.clone();b.makeRotationZ(d),g.makeTranslation(0,m-r,-r),T.applyMatrix4(g.multiply(b)),g.makeTranslation(0,-m+r,-r),b.makeRotationZ(-d),B.applyMatrix4(g.multiply(b));let C=i.mergeGeometries([T,B,S,E,F]),L=C.clone();g.makeTranslation(0,0,f),C.applyMatrix4(g),g.makeTranslation(0,0,-f),b.makeRotationY(c),L.applyMatrix4(g.multiply(b)),S=new e.PlaneGeometry(a-u,s-u,l,n),T=new e.CylinderGeometry(r,r,a-u,h,l,!0,0,d),B=T.clone(),_i(S,-k,w,A,M),g.makeTranslation(0,-(m-r),-r,0),b.makeRotationZ(-d),T.applyMatrix4(g.multiply(b)),g.makeTranslation(0,m-r,-r,0),b.makeRotationZ(d),B.applyMatrix4(g.multiply(b));let _=i.mergeGeometries([T,B,S]),D=_.clone();g.makeTranslation(-p,0,0),b.makeRotationY(-d),_.applyMatrix4(g.multiply(b)),g.makeTranslation(p,0,0),b.makeRotationY(d),D.applyMatrix4(g.multiply(b)),S=new e.PlaneGeometry(t-u,a-u,o,l),_i(S,-x,k,v,A);let V=S.clone();g.makeTranslation(0,m,0),b.makeRotationX(-d),S.applyMatrix4(g.multiply(b)),g.makeTranslation(0,-m,0),b.makeRotationX(d),V.applyMatrix4(g.multiply(b));let j=i.mergeVertices(i.mergeGeometries([C,L,_,D,S,V]));!function(t,i="sphere",s,a=[0,0,0],r=[0,0,0,1],o){void 0===o&&(o=new e.Matrix4);if(o.compose({x:a[0],y:a[1],z:a[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===s){t.boundingBox||t.computeBoundingBox();let e=t.boundingBox;s=Math.max(e.max.x-e.min.x,e.max.y-e.min.y,e.max.z-e.min.z)}let n=new e.Box3(new e.Vector3(-s/2,-s/2,-s/2),new e.Vector3(s/2,s/2,s/2)),l=[];l.length=2*t.attributes.position.count,void 0===t.attributes.uv&&t.setAttribute("uv",new e.Float32BufferAttribute(l,2));let h,c,d,u,p,m=function(t,i,s){t.applyMatrix4(o),i.applyMatrix4(o),s.applyMatrix4(o);let a=1/(2*Math.PI),r=1/Math.PI;return t.normalize(),i.normalize(),s.normalize(),{uv0:new e.Vector2(.5-Math.atan(t.z,-t.x)*a,.5-Math.asin(t.y)*r),uv1:new e.Vector2(.5-Math.atan(i.z,-i.x)*a,.5-Math.asin(i.y)*r),uv2:new e.Vector2(.5-Math.atan(s.z,-s.x)*a,.5-Math.asin(s.y)*r)}},f=function(t,i,a){t.applyMatrix4(o),i.applyMatrix4(o),a.applyMatrix4(o);let r=new e.Vector3;r.crossVectors(i.clone().sub(t),i.clone().sub(a)).normalize(),r.x<0||r.y<0||r.z,r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z);let l=new e.Vector2,h=new e.Vector2,c=new e.Vector2,d=1/s;return r.y>r.x&&r.y>r.z?(l.set(t.x-n.min.x,n.max.z-t.z).multiplyScalar(d),h.set(i.x-n.min.x,n.max.z-i.z).multiplyScalar(d),c.set(a.x-n.min.x,n.max.z-a.z).multiplyScalar(d)):r.x>r.y&&r.x>r.z?(l.set(t.z-n.min.z,t.y-n.min.y).multiplyScalar(d),h.set(i.z-n.min.z,i.y-n.min.y).multiplyScalar(d),c.set(a.z-n.min.z,a.y-n.min.y).multiplyScalar(d)):r.z>r.y&&r.z>r.x&&(l.set(t.x-n.min.x,t.y-n.min.y).multiplyScalar(d),h.set(i.x-n.min.x,i.y-n.min.y).multiplyScalar(d),c.set(a.x-n.min.x,a.y-n.min.y).multiplyScalar(d)),{uv0:l,uv1:h,uv2:c}},b=new e.Vector3,g=new e.Vector3,y=new e.Vector3;new e.Vector3,new e.Vector3,new e.Vector3;const x=t.getAttribute("position");if(t.getAttribute("normal"),t.index)for(h=0;h<t.index.count;h+=3)c=t.index.getX(h+0),d=t.index.getX(h+1),u=t.index.getX(h+2),b.fromBufferAttribute(x,c),g.fromBufferAttribute(x,d),y.fromBufferAttribute(x,u),p="sphere"===i?m(b,g,y):f(b,g,y),l[2*c]=p.uv0.x,l[2*c+1]=p.uv0.y,l[2*d]=p.uv1.x,l[2*d+1]=p.uv1.y,l[2*u]=p.uv2.x,l[2*u+1]=p.uv2.y;else for(h=0;h<x.count;h+=3){b.fromBufferAttribute(x,h+0),g.fromBufferAttribute(x,h+1),y.fromBufferAttribute(x,h+2),p="sphere"===i?m(b,g,y):f(b,g,y);let t=h,e=h+1,s=h+2;l[2*t]=p.uv0.x,l[2*t+1]=p.uv0.y,l[2*e]=p.uv1.x,l[2*e+1]=p.uv1.y,l[2*s]=p.uv2.x,l[2*s+1]=p.uv2.y}t.attributes.uv.array=new Float32Array(l),t.attributes.uv.needsUpdate=!0}(j,"box"),this.copy(j)}}class Li extends e.BufferGeometry{constructor(t=1,i=8,s=6,a=0,r=2*Math.PI,o=0,n=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:t,widthSegments:i,heightSegments:s,phiStart:a,phiLength:r,thetaStart:o,thetaLength:n},i=Math.floor(i),s=Math.floor(s);const l=Math.min(o+n,Math.PI);let h=0;const c=[],d=new e.Vector3,u=new e.Vector3,p=[],m=[],f=[],b=[];for(let e=0;e<=s;e++){const p=[],g=e/s;let y=0;0==e&&0==o?y=.5/i:e==s&&l==Math.PI&&(y=-.5/i);for(let e=0;e<=i;e++){const s=e/i;d.x=-t*Math.cos(a+s*r)*Math.sin(o+g*n),d.y=t*Math.cos(o+g*n),d.z=t*Math.sin(a+s*r)*Math.sin(o+g*n),m.push(d.x,d.y,d.z),u.copy(d).normalize(),f.push(u.x,u.y,u.z),b.push(s+y,1-g),p.push(h++)}c.push(p)}for(let t=0;t<s;t++)for(let e=0;e<i;e++){const i=c[t][e+1],a=c[t][e],r=c[t+1][e],n=c[t+1][e+1];(0!==t||o>0)&&p.push(i,a,n),(t!==s-1||l<Math.PI)&&p.push(a,r,n)}this.setIndex(p),this.setAttribute("position",new e.Float32BufferAttribute(m,3)),this.setAttribute("normal",new e.Float32BufferAttribute(f,3)),this.setAttribute("uv",new e.Float32BufferAttribute(b,2))}}function _i(t,e=0,i=0,s=1,a=1,r){let o=t.attributes.uv,n=o.array,l=o.count,h=0;for(;l--;)h=2*l,n[h]=n[h]*s-e,n[h+1]=n[h+1]*a+i}const Di=new e.Box3;class Vi extends e.LineSegments{constructor(t,i=16776960){const s=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),a=new Float32Array(24);let r=new e.Color(i),o=[],n=8;for(;n--;)o.push(r.r,r.g,r.b);const l=new Float32Array(o),h=new e.BufferGeometry;h.setIndex(new e.BufferAttribute(s,1)),h.setAttribute("position",new e.BufferAttribute(a,3)),h.setAttribute("color",new e.BufferAttribute(l,3)),super(h,new e.LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&Di.setFromObject(this.object),Di.isEmpty())return;const e=Di.min,i=Di.max,s=this.geometry.attributes.position,a=s.array;a[0]=i.x,a[1]=i.y,a[2]=i.z,a[3]=e.x,a[4]=i.y,a[5]=i.z,a[6]=e.x,a[7]=e.y,a[8]=i.z,a[9]=i.x,a[10]=e.y,a[11]=i.z,a[12]=i.x,a[13]=i.y,a[14]=e.z,a[15]=e.x,a[16]=i.y,a[17]=e.z,a[18]=e.x,a[19]=e.y,a[20]=e.z,a[21]=i.x,a[22]=e.y,a[23]=e.z,s.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(t){return this.object=t,this.update(),this}copy(t,e){return super.copy(t,e),this.object=t.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class ji{constructor(t={},e){this.motor=e,this.isCompound=!0,this.remplace=t.remplace||!1,this.init(t)}init(t={}){const i=t.intern||!1;let s=t.size||[5,3,8],a=t.pos||[0,2,0],r=t.wall||.1;void 0!==t.size[3]&&(r=t.size[3]),r<=0&&(r=.01);let o=.5*r,n=2*r;t.face||(t.face={});let l={up:1,down:1,left:1,right:1,front:1,back:1,...t.face};delete t.face;const h=[];i?(1===l.up&&h.push({pos:[0,.5*s[1]+o,0],size:[s[0]+n,r,s[2]+n]}),1===l.down&&h.push({pos:[0,-o-.5*s[1],0],size:[s[0]+n,r,s[2]+n]}),1===l.left&&h.push({pos:[-o-.5*s[0],0,0],size:[r,s[1],s[2]]}),1===l.right&&h.push({pos:[.5*s[0]+o,0,0],size:[r,s[1],s[2]]}),1===l.back&&h.push({pos:[0,0,-o-.5*s[2]],size:[s[0]+n,s[1],r]}),1===l.front&&h.push({pos:[0,0,.5*s[2]+o],size:[s[0]+n,s[1],r]})):(1===l.up&&h.push({pos:[0,.5*s[1]-o,0],size:[s[0],r,s[2]]}),1===l.down&&h.push({pos:[0,o-.5*s[1],0],size:[s[0],r,s[2]]}),1===l.left&&h.push({pos:[o-.5*s[0],0,0],size:[r,s[1]-n,s[2]]}),1===l.right&&h.push({pos:[.5*s[0]-o,0,0],size:[r,s[1]-n,s[2]]}),1===l.back&&h.push({pos:[0,0,o-.5*s[2]],size:[s[0]-n,s[1]-n,r]}),1===l.front&&h.push({pos:[0,0,.5*s[2]-o],size:[s[0]-n,s[1]-n,r]}));const c=[];let d,u,p=h.length,m=0;for(;p--;)u=h[m],d=this.isCompound?u.pos:A.addArray(a,u.pos),c.push({type:"box",size:u.size,pos:d,material:t.material}),m++;if(this.isCompound){let i=null;this.remplace&&(i=0===t.radius?new e.Mesh(new e.BoxGeometry(s[0],s[1],s[2])):new e.Mesh(new Ci(s[0],s[1],s[2],t.radius||o)),t.material&&"debug"===t.material&&(i=new Vi(i,t.color),t.material="line"),i.raycast=()=>{}),this.motor.add({...t,mesh:i,shapes:c,type:"compound",ray:!1})}else this.motor.add(c)}}const qi=Math.PI/180,Oi=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1)],Ii=new e.Vector3,Gi=new e.Vector3,Ui=new e.Vector3,Ni=new e.Vector3,Wi=[],Hi=[],Ki=new e.Vector3,Xi=new e.Vector3,Ji=new e.Vector3;new e.Matrix4;class Qi{constructor(t={},i){this.motor=i,this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=t.name||"car",this.mass=t.mass||1e3,this.size=t.size||[1.5,.7,3.8],this.pos=t.pos||[0,4,0],this.rot=t.rot||[0,0,0],this.friction=t.friction||.2,this.restitution=t.restitution||.3,this.massCenter=t.massCenter||[0,0,0],this.driveWheel=t.driveWheel||null;let s=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];t.shapeMesh&&(s=[{type:"convex",shape:t.shapeMesh.geometry,pos:t.shapePos||[0,0,0]}]),this.body=this.motor.add({type:"compound",shapes:s,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:t.bodyMesh||null,meshPos:t.meshPos||[0,-1.1,0],material:t.material,damping:[.05,.05],debug:!1}),this.body.inertia=new e.Vector3(1.416666865348816,1.666666865348816,.416666716337204),this.vehicle=new Yi({chassis:this.body},this.motor);let a=t.wheelPosition||[.61,0,1.2];const r=[new e.Vector3(-a[0],a[1],-a[2]),new e.Vector3(a[0],a[1],-a[2]),new e.Vector3(-a[0],a[1],a[2]),new e.Vector3(a[0],a[1],a[2])],o={radius:t.wheelRadius||.31,directionLocal:new e.Vector3(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new e.Vector3(1,0,0),chassisConnectionPointLocal:new e.Vector3(1,1,0)};let n,l,h;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),r.forEach((t=>{o.chassisConnectionPointLocal.copy(t),this.vehicle.addWheel(o)}));let c=this.motor.getMat("debug");if(t.wheelMesh?(l=t.wheelMesh,h=t.wheelMesh2?t.wheelMesh2:null,t.material&&(c=t.material||c,l.material=c,h&&(h.material=c))):(n=new e.CylinderGeometry(o.radius,o.radius,t.wheelDepth||.2),n.rotateZ(.5*Math.PI),l=new e.Mesh(n,c),h=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[h||l.clone(),l,h?h.clone():l.clone(),l.clone()];let t=this.vehicle.wheelMeshes.length,e=0;for(;t--;)this.body.add(this.vehicle.wheelMeshes[e++])}else m.matrixAutoUpdate=!1,h&&(h.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[this.motor.add(h||m.clone()),this.motor.add(m),this.motor.add(h?h.clone():m.clone()),this.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let t=this.motor.getDelta();this.motor.getAzimut();let e=this.motor.getKey();this.tmp.forwardForce=e[1],this.tmp.steerDirection=-1*e[0],this.tmp.brakeForce=1===e[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let i=Math.abs(this.vehicle.currentVehicleSpeedKmHour);i=Math.min(i,this.maxSpeed),this.maxSpeed;const s=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(s,0),this.vehicle.applyEngineForce(s,1),this.vehicle.applyEngineForce(s,2),this.vehicle.applyEngineForce(s,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(t),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*qi)}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.vehicle&&this.vehicle.setWheels(t,this.extra[t])}})}}class Yi{constructor(t,e){this.motor=e,this.chassisBody=t.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:0,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:2,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(t={}){let e=new ts(t,this.motor),i=this.wheelInfos.length-1;e.chassisBody=this.chassisBody;let s=e.suspensionRestLength+e.radius;return e.ray=this.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+i,begin:e.chassisConnectionPointLocal.toArray(),end:[e.chassisConnectionPointLocal.x,-s,e.chassisConnectionPointLocal.z],callback:function(t){e.castRay(t)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(e),i}setWheels(t,e){let i,s=this.wheelInfos.length;for(;s--;)i=this.wheelInfos[s],i[t]&&(i[t]=e)}setSteeringValue(t,e){this.wheelInfos[e].steering=t}applyEngineForce(t,e){this.wheelInfos[e].engineForce=t}setBrake(t,e){this.wheelInfos[e].brake=t}getVehicleAxisWorld(t,i){return i.set(0===t?1:0,1===t?1:0,2===t?1:0),ps(i,os(this.chassisBody,new e.Matrix4),i),i}updateVehicle(t){let i=this.wheelInfos,s=i.length,a=this.chassisBody,r=s;for(;r--;)this.updateWheelTransform(r);const o=rs(a,new e.Vector3),n=ms(o,os(a,new e.Matrix4).invert(),new e.Vector3);this.currentVehicleSpeedKmHour=n.z;let l=new e.Vector3;this.getVehicleAxisWorld(this.indexForwardAxis,l),l.dot(a.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(t);let h=new e.Vector3;for(new e.Vector3,r=0;r<s;r++){let e=i[r],s=e.suspensionForce;s>e.maxSuspensionForce&&(s=e.maxSuspensionForce),h.copy(e.raycastResult.hitNormalWorld).multiplyScalar(s*t),ls(this.motor,a,h,e.raycastResult.hitPointWorld)}this.updateFriction(t);let c=new e.Vector3,d=new e.Vector3,u=new e.Vector3;for(r=0;r<s;r++){let e=i[r];hs(a,e.chassisConnectionPointWorld,u);let s=1;if(1===this.indexUpAxis)s=-1;if(e.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,d);let i=ds(d,e.raycastResult.hitNormalWorld);c.copy(e.raycastResult.hitNormalWorld).multiplyScalar(i),d.sub(c);let a=ds(d,u);e.deltaRotation=s*a*t/e.radius}!e.sliding&&e.isInContact||0===e.engineForce||!e.useCustomSlidingRotationalSpeed||(e.deltaRotation=(e.engineForce>0?1:-1)*e.customSlidingRotationalSpeed*t),Math.abs(e.brake)>Math.abs(e.engineForce)&&(e.deltaRotation=0),e.rotation-=e.deltaRotation,e.deltaRotation*=.99}}updateSuspension(t){let e=this.chassisBody,i=is(e),s=this.wheelInfos,a=s.length;for(let t=0;t<a;t++){let e=s[t];if(e.isInContact){let t,s=e.suspensionRestLength-e.suspensionLength;t=e.suspensionStiffness*s*e.clippedInvContactDotSuspension;let a,r=e.suspensionRelativeVelocity;a=r<0?e.dampingCompression:e.dampingRelaxation,t-=a*r,e.suspensionForce=t*i,e.suspensionForce<0&&(e.suspensionForce=0)}else e.suspensionForce=0}}updateFriction(t){let i,s,a,r=Ni,o=this.wheelInfos,n=o.length,l=this.chassisBody,h=Wi,c=Hi;for(i=0;i<n;i++)if(s=o[i],a=s.raycastResult.body,s.sideImpulse=0,s.forwardImpulse=0,h[i]||(h[i]=new e.Vector3),c[i]||(c[i]=new e.Vector3),a){let t=c[i],e=this.getWheelTransformWorld(i);ms(Oi[this.indexRightAxis],e,t);let o=s.raycastResult.hitNormalWorld,n=ds(t,o);r.copy(o).multiplyScalar(n),t.sub(r).normalize(),us(o,t,h[i]),h[i].normalize(),s.sideImpulse=Ss(l,s.raycastResult.hitPointWorld,a,s.raycastResult.hitPointWorld,t),s.sideImpulse*=1}for(this.sliding=!1,i=0;i<n;i++){s=o[i],a=s.raycastResult.body;let e=0;if(s.slipInfo=1,a){let r=0,o=s.brake?s.brake:r;e=bs(l,a,s.raycastResult.hitPointWorld,h[i],o),e+=s.engineForce*t;let n=o/e;s.slipInfo*=n}if(s.forwardImpulse=0,s.skidInfo=1,a){s.skidInfo=1;let i=s.suspensionForce*t*s.frictionSlip,a=i*i;s.forwardImpulse=e;let r=.5*s.forwardImpulse/s.forwardAcceleration,o=1*s.sideImpulse/s.sideAcceleration,n=r*r+o*o;if(s.sliding=!1,n>a){this.sliding=!0,s.sliding=!0;let t=i/Math.sqrt(n);s.skidInfo*=t}}}if(this.sliding)for(let t=0;t<n;t++)s=o[t],0!==s.sideImpulse&&s.skidInfo<1&&(s.forwardImpulse*=s.skidInfo,s.sideImpulse*=s.skidInfo);for(i=0;i<n;i++){s=o[i];let t=new e.Vector3;if(t.copy(s.raycastResult.hitPointWorld).sub(as(l,new e.Vector3)),0!==s.forwardImpulse){let t=new e.Vector3;t.copy(h[i]).multiplyScalar(s.forwardImpulse),ls(this.motor,l,t,s.raycastResult.hitPointWorld)}if(0!==s.sideImpulse){a=s.raycastResult.body,(new e.Vector3).copy(s.raycastResult.hitPointWorld).sub(as(a,new e.Vector3));let r=new e.Vector3;r.copy(c[i]).multiplyScalar(s.sideImpulse),ms(t,os(l,new e.Matrix4).invert(),t),t["xyz"[this.indexUpAxis]]*=s.rollInfluence,ms(t,os(l,new e.Matrix4),t),ls(this.motor,l,r,as(l,new e.Vector3).add(t)),r.multiplyScalar(-1),ls(this.motor,a,r,s.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(t){const e=this.chassisBody.matrixWorld;ps(t.chassisConnectionPointLocal,e,t.chassisConnectionPointWorld),ms(t.directionLocal,e,t.directionWorld)}updateWheelTransform(t){let i=Ki,s=Xi,a=Ji,r=this.wheelInfos[t];this.updateWheelTransformWorld(r),i.copy(r.directionLocal).multiplyScalar(-1),s.copy(r.axleLocal),us(i,s,a),a.normalize(),s.normalize();let o=r.steering,n=new e.Quaternion;fs(i,o,n);let l=new e.Quaternion;fs(s,r.rotation,l);let h=r.quaternion;ns(this.chassisBody,h),h.multiply(n).multiply(l).normalize();let c=r.position;c.copy(r.directionWorld),c.multiplyScalar(r.suspensionLength);let d=c.clone();c.add(r.chassisConnectionPointWorld),r.matrix.compose(r.position,r.quaternion,{x:1,y:1,z:1}),this.localWheel?(d.add(r.chassisConnectionPointLocal),this.wheelMeshes[t].quaternion.copy(n).multiply(l).normalize(),this.wheelMeshes[t].position.copy(d),this.brakeMeshs&&(2!==t&&3!==t||this.brakeMeshs[t].quaternion.copy(n).normalize(),this.brakeMeshs[t].position.copy(d),this.brakeMeshs[t].updateMatrix())):(this.wheelMeshes[t].position.copy(r.position),this.wheelMeshes[t].quaternion.copy(r.quaternion),this.wheelMeshes[t].updateMatrix())}getWheelTransformWorld(t){return this.wheelInfos[t].matrix}}var Zi=new e.Vector3,$i=new e.Vector3;class ts{constructor(t,i){this.motor=i,t=((t,e)=>{for(var i in t=t||{},e)i in t||(t[i]=e[i]);return t})(t,{chassisConnectionPointLocal:new e.Vector3,chassisConnectionPointWorld:new e.Vector3,directionLocal:new e.Vector3,directionWorld:new e.Vector3,axleLocal:new e.Vector3,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointLocal.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionLocal.clone(),this.axleLocal=t.axleLocal.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.forwardAcceleration=t.forwardAcceleration,this.sideAcceleration=t.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new es,this.position=(new e.Vector3).copy(this.chassisConnectionPointLocal),this.quaternion=new e.Quaternion,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new e.Matrix4}castRay(t){if(t.hit){this.isInContact=!0;let i=t.distance;this.raycastResult.hitPointWorld.fromArray(t.point),this.raycastResult.hitNormalWorld.fromArray(t.normal),this.raycastResult.body=this.motor.byName(t.body),this.suspensionLength=i-this.radius;let s=this.suspensionRestLength-this.maxSuspensionTravel,a=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<s&&(this.suspensionLength=s),this.suspensionLength>a&&(this.suspensionLength=a,this.raycastResult.reset());let r=ds(this.raycastResult.hitNormalWorld,this.directionWorld);hs(this.chassisBody,this.raycastResult.hitPointWorld,Zi);var e=ds(this.raycastResult.hitNormalWorld,Zi);if(r>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/r;this.suspensionRelativeVelocity=e*t,this.clippedInvContactDotSuspension=t}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(t){let e=this.raycastResult;if(this.isInContact){let i=e.hitNormalWorld.dot(e.directionWorld);$i.copy(e.hitPointWorld).sub(t.position),hs(t,$i,Zi);let s=e.hitNormalWorld.dot(Zi);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/i;this.suspensionRelativeVelocity=s*t,this.clippedInvContactDotSuspension=t}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.hitNormalWorld.copy(e.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}}class es{constructor(){this.body=null,this.hitPointWorld=new e.Vector3,this.hitNormalWorld=new e.Vector3,this.directionWorld=new e.Vector3}reset(){this.body=null,this.hitPointWorld=new e.Vector3,this.hitNormalWorld=new e.Vector3,this.directionWorld=new e.Vector3}}const is=t=>t.mass,ss=t=>t.mass>0?1/t.mass:0,as=(t,e)=>e.copy(t.position),rs=(t,e)=>e.copy(t.velocity),os=(t,e)=>e.copy(t.matrixWorld),ns=(t,e)=>e.copy(t.quaternion),ls=(t,e,i,s)=>{t.change({name:e.name,impulse:i.toArray(),impulseCenter:s.toArray()})},hs=(t,e,i)=>(i.copy(e).sub(t.position),i.crossVectors(t.angular,i),i.add(t.velocity),i),cs=(t,e)=>(t.inertia&&e.copy(t.inertia),ms(e,t.matrixWorld,e),e.x=e.x>0?1/e.x:0,e.y=e.y>0?1/e.y:0,e.z=e.z>0?1/e.z:0,e),ds=(t,e)=>t.x*e.x+t.y*e.y+t.z*e.z,us=(t,e,i)=>{const s=t.y*e.z-t.z*e.y,a=t.z*e.x-t.x*e.z,r=t.x*e.y-t.y*e.x;return i.set(s,a,r),i},ps=(t,e,i)=>{const s=t.x,a=t.y,r=t.z,o=e.elements,n=s*o[0]+a*o[4]+r*o[8]+o[12],l=s*o[1]+a*o[5]+r*o[9]+o[13],h=s*o[2]+a*o[6]+r*o[10]+o[14],c=1/(s*o[3]+a*o[7]+r*o[11]+o[15]);return i.x=n*c,i.y=l*c,i.z=h*c,i},ms=(t,e,i)=>{const s=t.x,a=t.y,r=t.z,o=e.elements;return i.x=s*o[0]+a*o[4]+r*o[8],i.y=s*o[1]+a*o[5]+r*o[9],i.z=s*o[2]+a*o[6]+r*o[10],i},fs=(t,e,i)=>{const s=Math.sin(e/2);return t.normalize(),i.w=Math.cos(e/2),i.x=t.x*s,i.y=t.y*s,i.z=t.z*s,i};function bs(t,e,i,s,a){var r=0,o=i,n=Ii,l=Gi,h=Ui;hs(t,o,n),hs(e,o,l),h.copy(n).sub(l);return a<(r=-ds(s,h)*(1/(ws(t,i,s)+ws(e,i,s))))&&(r=a),r<-a&&(r=-a),r}var gs=new e.Vector3,ys=new e.Vector3,xs=new e.Vector3,vs=new e.Vector3;function ws(t,i,s){var a=gs,r=ys,o=xs,n=vs;return a.copy(i).sub(as(t,new e.Vector3)),us(a,s,r),n.copy(cs(t,new e.Vector3)).multiply(r),us(n,a,o),ss(t)+ds(s,o)}var Ms=new e.Vector3,ks=new e.Vector3,As=new e.Vector3;function Ss(t,e,i,s,a){if(a.lengthSq()>1.1)return 0;let r=Ms,o=ks,n=As;return hs(t,e,r),hs(i,s,o),n.copy(r).sub(o),-.1*ds(a,n)*(1/(ss(t)+ss(i)))}class Ts{constructor(t={},i){this.MoveSpeed=50,this.MaxSpeed=15,this.Drag=.98,this.SteerAngle=20,this.Traction=10,this.MoveForce=new e.Vector3(0,0,0),this.tt=new e.Vector3(0,0,0),this.v1=new e.Vector3(0,0,0),this.v2=new e.Vector3(0,0,0),this.motor=i,this.debug=this.motor.addDebuger(),this._reponsivness=500,this._throttleAmt=25,this._thottle=0,this._roll=0,this._pitch=0,this._yaw=0,this.init(t)}init(){this.car=new e.Mesh(new e.BoxGeometry(2,1,3),new e.MeshBasicMaterial({wireframe:!0})),this.car.position.y=.5,this.motor.add(this.car);let t=new e.AxesHelper;this.car.add(t)}update(t){this.updateCar(t)}updateCar(t){const e=this.motor.getKey(),i=this.motor.getTransform(this.car);this.tt.copy(i.forward).multiplyScalar(this.MoveSpeed*-e[1]*t),this.MoveForce.add(this.tt),this.car.position.add(this.MoveForce.clone().multiplyScalar(t));let s=-e[0],a=this.MoveForce.length();i.up.multiplyScalar(s*a*this.SteerAngle*t),this.car.rotation.y+=i.up.y*this.motor.math.torad,this.MoveForce.multiplyScalar(this.Drag),this.MoveForce.clampLength(0,this.MaxSpeed),a=this.MoveForce.length(),this.v1.copy(this.MoveForce).normalize().multiplyScalar(3),this.v2.copy(i.forward).multiplyScalar(3),this.debug.DrawRay(i.position,this.v1,"white"),this.debug.DrawRay(i.position,this.v2,"blue"),this.debug.DrawRay(i.position,i.right,"red"),this.v1.copy(this.MoveForce).normalize().lerp(i.forward,this.Traction*t),this.MoveForce.copy(this.v1).multiplyScalar(a)}fixedUpdate(t){const e=this.motor.getTransform(this.body);e.position.copy(this.body.position),e.forward.copy(this.forward).applyQuaternion(this.body.quaternion),e.right.copy(this.right).applyQuaternion(this.body.quaternion),e.up.copy(this.up).applyQuaternion(this.body.quaternion),e.thottle.copy(e.up),this.motor.change({name:this.body.name,impulse:e.thottle.multiplyScalar(this._thottle).toArray()}),this.debug.DrawRay(e.position,e.thottle,"red"),this.debug.DrawRay(e.position,e.forward,"yellow"),this.debug.DrawRay(e.position,e.right,"cyan"),this.debug.DrawRay(e.position,e.up,"green")}handleInputs(t){const e=this.motor.getKey();this._roll=e[0],this._pitch=e[1],e[4]?this._thottle+=t*this._throttleAmt:e[5]&&(this._thottle-=t*this._throttleAmt),this._thottle=this.motor.math.clamp(this._thottle,0,100)}}class Ps{constructor(t={},i){this.startPosition=t.pos||[0,0,0],this.model=t.model||null,this.debug=t.debug||!1,this.angle=0,this.speed=50,this.maxSpeed=20,this.drag=.98,this.steerAngle=5,this.traction=3,this.moveForce=new e.Vector3(0,0,0),this.side=0,this.onAir=!1,this.tt=new e.Vector3(0,0,0),this.v1=new e.Vector3(0,0,0),this.v2=new e.Vector3(0,0,0),this.floorNormal=new e.Vector3(0,0,0),this.up=new e.Vector3(0,1,0),this.decal=new e.Vector3(0,-.5,0),this.tmpQ1=new e.Quaternion,this.tmpQ2=new e.Quaternion,this.tmpQ3=new e.Quaternion,this.motor=i,this.angleS=0,this.debug&&(this.debuger=this.motor.addDebuger()),this.phyMove=!0,this.init(t)}setDebug(t){t&&(this.debug=t),this.sphere.visible=this.debug,this.ray.visible=this.debug}init(){this.radius=1,this.decal.y=-.5,this.radius=1.7,this.decal.y=-1.2;const t=this.motor.math;this.sphere=this.motor.add({type:"sphere",name:"baser",mass:1,size:[this.radius],pos:t.addArray(this.startPosition,[0,this.radius,0]),friction:.5,material:"debug",getVelocity:!0,visible:this.debug,shadow:!1,ray:!1});let i=this.rayHit.bind(this);if(this.ray=this.motor.add({name:"raySphere",type:"ray",begin:[0,0,0],end:[0,-(this.radius+1),0],visible:this.debug,parent:this.sphere,noRotation:!0,callback:i}),this.model){for(let t in this.model)this.model[t].receiveShadow=!0,this.model[t].castShadow=!0;this.car=this.model.body,this.w=[this.model.wheel_0,this.model.wheel_1,this.model.wheel_2,this.model.wheel_3,this.model.d_wheel]}else this.car=new e.Mesh(new e.BoxGeometry(1,.4,2),new e.MeshBasicMaterial({wireframe:!0})),this.addWheels();this.motor.add(this.car)}addWheels(){let t=new e.CylinderGeometry(.3,.3,.3,16);t.rotateZ(Math.PI/2);let i,s=new e.MeshBasicMaterial({wireframe:!0}),a=4,r=[.7,-.2,.7],o=[];for(;a--;)o[a]=new e.Mesh(t,s),i=[0===a||3===a?r[0]:-.7,r[1],a<2?r[2]:-.7],o[a].position.fromArray(i),this.car.add(o[a]);this.w=o}updateWheels(){this.motor.math;let t,e=4;this.tmpQ3.setFromAxisAngle({x:0,y:1,z:0},3*this.angleS);let i=this.sphere.velocity.length()*this.side,s={x:1,y:0,z:0};for(;e--;)t=this.w[e],e<2?t.quaternion.setFromAxisAngle(s,i).premultiply(this.tmpQ3):t.quaternion.setFromAxisAngle(s,i);this.w[4]&&(this.w[4].rotation.y=10*this.angleS)}rayHit(t){t.hit?this.floorNormal.fromArray(t.normal).normalize():this.floorNormal.set(0,0,0),this.onAir=!t.hit}update(t){const e=this.motor.getKey(),i=this.motor.math;this.phyMove&&this.car.position.copy(this.sphere.position).add(this.decal);const s=this.motor.getTransform(this.car);let a=-e[1]*this.speed*t;this.onAir&&(a=0),this.tt.copy(s.forward).multiplyScalar(a),this.moveForce.add(this.tt),this.phyMove||this.car.position.add(this.moveForce.clone().multiplyScalar(t)),this.tmpQ1.setFromUnitVectors(this.up,this.floorNormal),this.tmpQ2.slerp(this.tmpQ1,4*t);let r=this.moveForce.toArray();this.motor.change({name:this.sphere.name,linear:r,velocityOperation:"xz"}),this.chassis&&this.motor.change({name:this.chassis.name,quat:this.car.quaternion.toArray(),pos:this.car.position.toArray()});let o=-e[0],n=this.moveForce.length();this.angleS=o*this.steerAngle*i.torad,this.angle+=this.angleS*n*t,this.car.quaternion.setFromAxisAngle(this.up,this.angle).premultiply(this.tmpQ2),this.moveForce.multiplyScalar(this.drag),this.moveForce.clampLength(0,this.maxSpeed),n=this.moveForce.length(),this.v1.copy(this.moveForce).normalize().multiplyScalar(1),this.v2.copy(s.forward).multiplyScalar(1),this.debug&&(this.debuger.DrawRay(s.position,this.v1,"white"),this.debuger.DrawRay(s.position,this.v2,"blue")),this.v1.copy(this.moveForce).normalize().lerp(s.forward,this.traction*t),this.moveForce.copy(this.v1).multiplyScalar(n),this.side=this.moveForce.dot(s.forward)>0?-1:1,this.updateWheels()}}const zs=new e.Matrix4,Rs=new e.Matrix4;new e.Vector3;let Es=e.Skeleton.prototype;Es.byName=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return this.bones[e];return null},Es.getId=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return e;return null},Es.setExtraRotation=function(t,i,s,a){(t.isBone?t:this.byName(t))&&e.MathUtils.DEG2RAD},Es.setScalling=function(t,i,s,a){let r=t.isBone?t:this.byName(t);r&&(r.scalling=new e.Vector3(i,s,a))},Es.resetScalling=function(t){this.pose(),this.scalled=!0;for(let t=0,i=this.bones.length;t<i;t++)this.bones[t].isPhysics=!1,this.bones[t].phyMtx=new e.Matrix4;t||this.applyScalling()},Es.childScale=function(t,e){if(!this.scalled)return;t.scalling&&e.scale(t.scalling);let i,s=t.children.length,a=0;for(;s--;)i=t.children[a],a++,i.isBone,i.matrixWorld.multiplyMatrices(e,i.matrix)},Es.applyScalling=function(t){let e,i,s,a=this.bones.length;for(i=0;i<a;i++)e=this.bones[i],s=e.parent||null,null!==s&&s.scalling&&"root"!==e.name&&(e.position.multiply(s.scalling),e.updateMatrixWorld(!0));this.calculateInverses()},Es.update=function(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,s=this.boneTexture;let a,r=t.length,o=0;for(;r--;){a=t[o];const s=a?a.isPhysics?a.phyMtx:a.matrixWorld:Rs;this.childScale(a,s),zs.multiplyMatrices(s,e[o]),zs.toArray(i,16*o),o++}null!==s&&(s.needsUpdate=!0)};const Fs={getColor(t){let e=t.toString();e=e.substring(e.lastIndexOf(".")+1);let i,s=[255,255,255];switch(e){case"grass":s=[.223,.827,.325],i=[.741,.498,.258];break;case"dirt":s=[.741,.498,.258];break;case"leaves":s=[.152,.682,.376];break;case"sand":s=[.878,.819,.686];break;case"ice":s=[.65,.882,.96];break;case"stone":s=[.537,.64,.65];break;case"cobblestone":s=[.666,.647,.588];break;case"wood":s=[.603,.321,.152];break;case"snow":s=[.905,.976,1]}return i?[s[0],s[1],s[2],i[0],i[1],i[2]]:[s[0],s[1],s[2]]},fire:{type:"star",numParticles:20,position:[0,0,0],colors:[1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,.5,0,0,0,0],lifeTime:2,timeRange:2,startSize:.3,endSize:.9,velocity:[0,.8,0],velocityRange:[.15,.15,.15],gravity:[0,-.2,0],spinSpeedRange:4},smoke:{position:[-2,-.2,0],colors:[0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],numParticles:20,lifeTime:2,timeRange:2,startSize:.5,endSize:2,velocity:[0,1.6,0],velocityRange:[.2,0,.2],gravity:[0,-.25,0],spinSpeedRange:4,blending:"normal"},addBlock:{type:"cube",numParticles:30,lifeTime:1.5,endTime:1.5,startTime:0,startSize:.25,endSize:.5,sizeRange:.25,spinSpeedRange:2,radius:.25,velocity:[1,0,1],velocityRange:[.25,0,.25],acceleration:[1,0,1],accelerationRange:[.25,0,.25],gravity:[0,.05,0],tween:"outQuad",blending:"normal",alphaTest:.1},removeBlock:{type:"cube",lifeTime:1.5,endTime:1.5,startTime:0,startSize:.5,sizeRange:.25,endSize:.1,spinSpeedRange:2,accelerationRange:[.5,.5,.5],gravity:[0,-.1,0],tween:"outQuad",blending:"normal",alphaTest:.1},explosion:{colors:[1,0,0,0,1,0,0,1,1,0,0,1,1,1,0,1,1,1,1,.5,1,1,1,0],type:"cloud",radius:.5,radiusRange:.5,numParticles:400,positionRange:[2,1,2],lifeTime:3,endTime:4,lifeTimeRange:1,startTime:0,startSize:.1,endSize:2,sizeRange:1,accelerationRange:[1,.3,1],acceleration:[.8,.8,.8],gravity:[0,-.5,0],spinSpeedRange:2,luma:!1},playerMove:{trail:!0,colors:[1,1,1,1,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:1e3,positionRange:[.2,0,.2],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.1,0]},vehicleMove:{trail:!0,colors:[.5,.5,.5,.25,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:2e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.2,0]},vehicleTrack:{trail:!0,colors:[.2,.2,.2,.1,.2,.2,.2,0],type:"round2",blending:"normal",startSize:.3,endSize:.3,numParticles:4,maxParticles:2e3,position:[0,-.1,0],lifeTime:6,oriented:!0},underWater:{trail:!0,colors:[1,1,1,1,.5,.5,1,0],type:"bubble",blending:"normal",numParticles:1,maxParticles:1e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.1,endSize:.5,sizeRange:.05,velocity:[0,1,0],velocityRange:[1,0,1],acceleration:[.2,0,.2],gravity:[0,1,0]},bazookaFire:{trail:!0,colors:[1,0,0,1,1,1,0,.5,1,1,1,0],type:"round",numParticles:2,maxParticles:600,positionRange:[.1,.1,.1],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.1,velocityRange:[.6,.6,.6],gravity:[0,.1,0],luma:!1}},Bs=["pixel","basic","cube","cloud","round","round2","donut","bubble","smoke","circle","field","star","octo"];function Cs(){this.parent=null,this.position=[0,0,0],this.rotation=[0,0,0],this.name="default",this.type="round",this.tween="linear",this.trail=!1,this.model="",this.numParticles=1,this.maxParticles=0,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.endTime=-1,this.lifeTimeRange=0,this.sizeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.pposition=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.gravity=[0,0,0],this.oriented=!1,this.orientation=[0,0,0,1],this.colors=[1,1,1,1],this.blending="additive",this.radius=0,this.radiusPosition=!1,this.axis="Y",this.radiusRange=0,this.tmpRotation=null,this.alphaTest=0,this.renderOrder=0,this.luma=!0,this.depthWrite=!1,this.transparent=!0}const Ls={torad:Math.PI/180,todeg:180/Math.PI,random:()=>Math.random(),rand:(t,e)=>t+Ls.random()*(e-t),randInt:(t,e)=>t+Math.floor(Ls.random()*(e-t+1)),plusMinus:t=>(Ls.random()-.5)*t*2,plusMinusVector:t=>{const e=[];let i=t.length;for(;i--;)e.push(Ls.plusMinus(t[i]));return e},toTexture:t=>{let i=new e.Texture(t);return i.minFilter=e.LinearFilter,i.magFilter=e.LinearFilter,i.flipY=!1,i.colorSpace=e.SRGBColorSpace,i.needsUpdate=!0,i},createTextureFromFloats:(t,i,s,a)=>{let r=null;if(null==a){const a=new Uint8Array(s.length);let o;for(let t=0;t<s.length;t++)o=255*s[t],a[t]=o;return r=new e.DataTexture(a,t,i,e.RGBAFormat),r.minFilter=e.LinearFilter,r.magFilter=e.LinearFilter,r.needsUpdate=!0,r}return r=a,r}},_s=function(t){let e;switch(t){case"linear":e="float tween( float k ) { return k; }";break;case"inQuad":e="float tween( float k ) { return k * k; }";break;case"outQuad":e="float tween( float k ) { return k * ( 2.0 - k ); }";break;case"inOutQuad":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k;\n            return - 0.5 * ( --k * ( k - 2.0 ) - 1.0 ); \n        }";break;case"inCubic":e="float tween( float k ) { return k * k * k; }";break;case"outCubic":e="float tween( float k ) { return --k * k * k + 1.0; }";break;case"inOutCubic":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k + 2.0 ); \n        }";break;case"inQuart":e="float tween( float k ) { return k * k * k * k; }";break;case"outQuart":e="float tween( float k ) { return 1.0 - ( --k * k * k * k ); }";break;case"inOutQuart":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return 0.5 * k * k * k * k;\n\t\t\treturn - 0.5 * ( ( k -= 2.0 ) * k * k * k - 2.0 ); \n        }";break;case"inQuint":e="float tween( float k ) { return k * k * k * k * k; }";break;case"outQuint":e="float tween( float k ) { return --k * k * k * k * k + 1.0; }";break;case"inOutQuint":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k * k * k + 2.0 );\n        }";break;case"inSine":e="#define PI_90 1.570796326794896\n        float tween( float k ) { float j = k * PI_90; return 1.0 - cos( j ); }";break;case"outSine":e="#define PI_90 1.570796326794896\n\t\tfloat tween( float k ) { float j = k * PI_90; return sin( j ); }";break;case"inOutSine":e="#define M_PI 3.14159265358979323846\n\t\tfloat tween( float k ) { \n\t\t\tfloat j = k * M_PI; return 0.5 * (1.0-cos(j));\n        }";break;case"inExpo":e="float tween( float k ) { return k == 0.0 ? 0.0 : pow( 1024.0, k - 1.0 ); }";break;case"outExpo":e="float tween( float k ) { return k == 1.0 ? 1.0 : 1.0 - pow( 2.0, - 10.0 * k ); }";break;case"inOutExpo":e="float tween( float k ) { \n\t\t\tif ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * pow( 1024.0, k - 1.0 );\n\t\t    return 0.5 * ( - pow( 2.0, - 10.0 * ( k - 1.0 ) ) + 2.0 );\n        }";break;case"inCirc":e="float tween( float k ) { return 1.0 - sqrt( 1.0 - k * k ); }";break;case"outCirc":e="float tween( float k ) { return sqrt( 1.0 - ( --k * k ) ); }";break;case"inOutCirc":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return - 0.5 * ( sqrt( 1.0 - k * k ) - 1.0 );\n\t\t\treturn 0.5 * ( sqrt( 1.0 - ( k -= 2.0 ) * k ) + 1.0 ); \n        }";break;case"inElastic":e="#define TWO_PI 6.28318530717958647692\n        float tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return - ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t}";break;case"outElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1; \n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return ( a * pow( 2.0, - 10.0 * k) * sin( ( k - s ) * TWO_PI / p ) + 1.0 );\n\t\t}";break;case"inOutElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return - 0.5 * ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t    return a * pow( 2.0, -10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) * 0.5 + 1.0;\n\t\t}";break;case"inBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return k * k * ( ( s + 1.0 ) * k - s );\n\t\t}";break;case"outBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return --k * k * ( ( s + 1.0 ) * k + s ) + 1.0;\n\t\t}";break;case"inOutBack":e="float tween(float k) {\n\t\t    float s = 1.70158 * 1.525;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * ( k * k * ( ( s + 1.0 ) * k - s ) );\n\t\t    return 0.5 * ( ( k -= 2.0 ) * k * ( ( s + 1.0 ) * k + s ) + 2.0 );\n\t\t}";break;case"inBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat tween(float k) { return 1.0 - outBounce( 1.0 - k ); }";break;case"outBounce":e="float tween(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}";break;case"inOutBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat inBounce(float k) { return 1.0 - outBounce( 1.0 - k ); }\n\t\tfloat tween(float k) {\n\t\t    if ( k < 0.5 ) return inBounce( k * 2.0 ) * 0.5;\n\t\t    return outBounce( k * 2.0 - 1.0 ) * 0.5 + 0.5;\n\t\t}"}return e},Ds=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]],Vs=new Float32Array(28);let js=class extends e.Points{constructor(t,e){super(),this.pe=t,this.count=0,this.color=null,this.texture=null,this.localTime=0,this.time=0,this.endTime=-1,this.num=0,this.matrixAutoUpdate=!1,this.frustumCulled=e.frustum||!1,this.receiveShadow=!1,this.castShadow=!1,this.birthIndex=0,this.luma=!0,e&&this.setParameters(e)}setParameters(t){this.validateParameters(t),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.name=t.name,this.isTrail=t.trail||!1,this.parameters=t;const e=this.isTrail?t.maxParticles:t.numParticles;this.allocateParticles_(e,t),this.isTrail||this.createParticles_(0,e,t),t.parent?t.parent.add(this):this.pe.scene?this.pe.scene.add(this):this.pe.add(this)}makeGeometry(t){this.geometry=t.oriented?new e.InstancedBufferGeometry:new e.BufferGeometry,this.isMesh=t.oriented}setColorRamp(t){const e=t.length/4;if(e%1!=0)throw"colorRamp must have multiple of 4 entries";this.color=Ls.createTextureFromFloats(e,1,t)}validateParameters(t){var e=new Cs;for(let i in t)if(void 0===e[i])throw'unknown particle parameter "'+i+'"';for(let i in e)void 0===t[i]&&(t[i]=e[i])}perParticle(t,e){}birthParticles(t,e){var i=this.parameters.numParticles;this.parameters.pposition=t,this.parameters.startTime=this.time,this.endTime=this.time+this.parameters.lifeTime,e&&this.setColorRamp(e),this.createParticles_(this.birthIndex,i,this.parameters),this.birthIndex+=i,this.birthIndex+i>=this.parameters.maxParticles&&(this.birthIndex=0)}createParticles_(t,i,s){const a=Ls.plusMinus,r=Ls.plusMinusVector,o=this.interleavedBuffer.array;let n,l=i;for(;l--;){this.perParticle(l,s);let h=s.lifeTime+a(s.lifeTimeRange),c=null===s.startTime?l*s.lifeTime/i:s.startTime,d=s.frameStart+a(s.frameStartRange),u=(new e.Vector3).addVectors((new e.Vector3).fromArray(s.pposition),(new e.Vector3).fromArray(r(s.positionRange))),p=(new e.Vector3).addVectors((new e.Vector3).fromArray(s.velocity),(new e.Vector3).fromArray(r(s.velocityRange))),m=(new e.Vector3).addVectors((new e.Vector3).fromArray(s.acceleration),(new e.Vector3).fromArray(r(s.accelerationRange))),f=(new e.Vector4).addVectors((new e.Vector4).fromArray(s.colorMult),(new e.Vector4).fromArray(r(s.colorMultRange))),b=s.spinStart+a(s.spinStartRange),g=s.spinSpeed+a(s.spinSpeedRange),y=s.startSize+a(s.sizeRange||s.startSizeRange),x=s.endSize+a(s.sizeRange||s.endSizeRange),v=(new e.Vector4).fromArray(s.orientation);if(s.positionRange[0],s.positionRange[1],s.positionRange[2],s.radius){let t=s.axis||"Y",i=Ls.rand(0,2*Math.PI);s.tmpRotation=[90,-i*Ls.todeg,90,"YXZ"];let r=s.radius+a(s.radiusRange),o=Math.cos(i),n=Math.sin(i),l=new e.Vector3;switch(t){case"X":l.y=o,l.z=n;break;case"Y":l.x=o,l.z=n;break;case"Z":l.x=o,l.y=n}switch(l.multiplyScalar(r),s.radiusPosition&&u.add(l),t){case"X":l.x=1;break;case"Y":l.y=1;break;case"Z":l.z=1}m.multiply(l),p.multiply(l)}s.tmpRotation&&(v=(new e.Quaternion).setFromEuler(new e.Euler(s.tmpRotation[0]*Ls.torad,s.tmpRotation[1]*Ls.torad,s.tmpRotation[2]*Ls.torad,s.tmpRotation[3]))),n=0+28*l*4+28*t*4,o[0+n]=u.x,o[0+n+1]=u.y,o[0+n+2]=u.z,o[0+n+3]=c,o[4+n]=Ds[0][0],o[4+n+1]=Ds[0][1],o[4+n+2]=h,o[4+n+3]=d,o[8+n]=p.x,o[8+n+1]=p.y,o[8+n+2]=p.z,o[8+n+3]=y,o[12+n]=m.x,o[12+n+1]=m.y,o[12+n+2]=m.z,o[12+n+3]=x,o[16+n]=b,o[16+n+1]=g,o[16+n+2]=0,o[16+n+3]=0,o[20+n]=v.x,o[20+n+1]=v.y,o[20+n+2]=v.z,o[20+n+3]=v.w,o[24+n]=f.x,o[24+n+1]=f.y,o[24+n+2]=f.z,o[24+n+3]=f.w}this.interleavedBuffer.needsUpdate=!0,this.material.uniforms.worldVelocity.value.fromArray(s.worldVelocity),this.material.uniforms.gravity.value.fromArray(s.gravity),this.material.uniforms.timeRange.value=s.timeRange,this.material.uniforms.frameDuration.value=s.frameDuration,this.material.uniforms.numFrames.value=s.numFrames,this.material.uniforms.rampSampler.value=this.color,this.material.uniforms.colorSampler.value=this.texture,this.material.blending="normal"===s.blending?e.NormalBlending:e.AdditiveBlending,this.updateMatrix()}allocateParticles_(t,i){if(this.count!==t){if(i.oriented||(i.oriented=!1),i.position&&this.position.fromArray(i.position),i.rotation&&this.quaternion.setFromEuler(new e.Euler(i.rotation[0]*Ls.torad,i.rotation[1]*Ls.torad,i.rotation[2]*Ls.torad)),this.setColorRamp(i.colors),this.pe.textures.has(i.type)||-1!==Bs.indexOf(i.type)&&this.pe.textures.make(i.type),this.texture=this.pe.textures.get(i.type),this.texture||console.log("this texture is undefined !!"),this.endTime=i.endTime||-1,this.luma=i.luma,this.makeGeometry(i),this.count=t,i.oriented){var s=new e.InterleavedBuffer(new Float32Array([0,0,0,0,-.5,-.5,0,0,0,0,0,0,.5,-.5,0,0,0,0,0,0,.5,.5,0,0,0,0,0,0,-.5,.5,0,0]),8);this.geometry.setAttribute("position",new e.InterleavedBufferAttribute(s,3,0)),this.geometry.setAttribute("uv",new e.InterleavedBufferAttribute(s,2,4)),this.geometry.setIndex(new e.BufferAttribute(new Uint16Array([0,1,2,0,2,3]),1)),this.interleavedBuffer=new e.InstancedInterleavedBuffer(new Float32Array(t*Vs.byteLength),28,1).setUsage(e.DynamicDrawUsage)}else this.interleavedBuffer=new e.InterleavedBuffer(new Float32Array(t*Vs.byteLength),28).setUsage(e.DynamicDrawUsage);this.geometry.setAttribute("position",new e.InterleavedBufferAttribute(this.interleavedBuffer,3,0)),this.geometry.setAttribute("startTime",new e.InterleavedBufferAttribute(this.interleavedBuffer,1,3)),this.geometry.setAttribute("uvLifeTimeFrameStart",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,4)),this.geometry.setAttribute("velocityStartSize",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,8)),this.geometry.setAttribute("accelerationEndSize",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,12)),this.geometry.setAttribute("spinStartSpinSpeed",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,16)),this.geometry.setAttribute("orientation",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,20)),this.geometry.setAttribute("colorMult",new e.InterleavedBufferAttribute(this.interleavedBuffer,4,24)),this.geometry.boundingSphere=new e.Sphere,this.geometry.boundingSphere.radius=3;let r=e.AdditiveBlending;switch(i.blending){case"sub":case"subtractive":r=e.SubtractiveBlending;break;case"multi":case"multiply":r=e.MultiplyBlending;break;case"normal":r=e.NormalBlending;break;default:r=e.AdditiveBlending}var a={worldVelocity:{value:new e.Vector3},gravity:{value:new e.Vector3},timeRange:{value:0},time:{value:0},timeOffset:{value:0},frameDuration:{value:0},numFrames:{value:0},rampSampler:{value:null},colorSampler:{value:null},scale:{value:.5*window.innerHeight},luma:{value:this.luma?this.pe.luminosity:1},alphaTest:{value:i.alphaTest}};this.material=new e.ShaderMaterial({defines:{USE_ORIENTATION:i.oriented},uniforms:a,vertexShader:_s(i.tween||"linear")+"\nprecision mediump float;\nprecision mediump int;\n\n#ifdef USE_ORIENTATION\n\t//uniform mat4 worldViewProjection;\n\t//uniform mat4 world;\n\tattribute vec3 offset;\n\tattribute vec4 orientation;\n#else\n    uniform float scale;\n#endif\n\nuniform vec3 worldVelocity;\nuniform vec3 gravity;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart;\nattribute float startTime;\nattribute vec4 velocityStartSize;\nattribute vec4 accelerationEndSize;\nattribute vec4 spinStartSpinSpeed;\nattribute vec4 colorMult;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n//#include <clipping_planes_pars_vertex>\n\nvec3 lerp( vec3 a, vec3 b, float p ){ return a + (b - a) * p; }\n\nvoid main() \n{\n    float lifeTime = uvLifeTimeFrameStart.z;\n    float frameStart = uvLifeTimeFrameStart.w;\n    float startSize = velocityStartSize.w;\n\n    //vec3 velocity = (modelMatrix * vec4(velocityStartSize.xyz, 0.0)).xyz + worldVelocity;\n\t//vec3 acceleration = (modelMatrix * vec4(accelerationEndSize.xyz, 0.0)).xyz + gravity;\n\n    //vec3 velocity = velocityStartSize.xyz + worldVelocity;\n\t//vec3 acceleration = accelerationEndSize.xyz + gravity;\n\n\tvec3 velocity = velocityStartSize.xyz + (inverse(modelMatrix) * vec4(worldVelocity, 0.0)).xyz;\n\tvec3 acceleration = accelerationEndSize.xyz + (inverse(modelMatrix) * vec4(gravity, 0.0)).xyz;\n\n    float endSize = accelerationEndSize.w;\n    float spinStart = spinStartSpinSpeed.x;\n    float spinSpeed = spinStartSpinSpeed.y;\n\n    float localTime = mod((time - timeOffset - startTime), timeRange);\n    //localTime = tween( localTime );\n    float percentLife = localTime / lifeTime;\n    percentLife = tween( percentLife );\n\n    vec3 posEnd = velocity * lifeTime + acceleration * lifeTime * lifeTime;\n\n    float frame = mod(floor(localTime / frameDuration + frameStart), numFrames);\n    float uOffset = frame / numFrames;\n    float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n    outputTexcoord = vec2(u, uv.y + 0.5);\n    outputColorMult = colorMult;\n\n    float size = mix(startSize, endSize, percentLife);\n\tsize = (percentLife < 0. || percentLife > 1.0) ? 0.0 : size;\n\n\tfloat s = sin(spinStart + spinSpeed * localTime);\n\tfloat c = cos(spinStart + spinSpeed * localTime);\n\n    #ifdef USE_ORIENTATION\n\t\t\n\t\tvec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0., (uv.x * s - uv.y * c) * size, 1.);\n\t\t//vec3 center = velocity * localTime + acceleration * localTime * localTime + position + offset;\n\t\tvec3 center = (posEnd * percentLife) + position + offset;\n\n\t\tvec4 q2 = orientation + orientation;\n\t\tvec4 qx = orientation.xxxw * q2.xyzx;\n\t\tvec4 qy = orientation.xyyw * q2.xyzy;\n\t\tvec4 qz = orientation.xxzw * q2.xxzz;\n\n\t\tmat4 localMatrix = mat4(\n\t\t    (1.0 - qy.y) - qz.z,  qx.y + qz.w,  qx.z - qy.w, 0,\n\t\t    qx.y - qz.w, (1.0 - qx.x) - qz.z, qy.z + qx.w, 0,\n\t\t    qx.z + qy.w, qy.z - qx.w, (1.0 - qx.x) - qy.y, 0,\n\t\t    center.x, center.y, center.z, 1\n\t\t);\n\t\trotatedPoint = localMatrix * rotatedPoint;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n\n\t#else\n\n\t    //vec3 pos = position + velocity * localTime + acceleration * localTime * localTime;\n\n\t    vec3 pos = (posEnd * percentLife) + position;\n\t    \n\t    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );\n        //gl_PointSize = size * 1.5 * ( scale / length( mvPosition.xyz ) );\n        gl_PointSize = size * 1.5 * ( scale / - mvPosition.z );\n\n        mat2 r = mat2( c, -s, s, c);\n        r *= 0.5; r += 0.5;  r = r * 2.0 - 1.0;\n        rotationMtx = r;\n\n        gl_Position = projectionMatrix * mvPosition;\n\n\t#endif\n\n\toutputPercentLife = percentLife;\n\n\t#include <logdepthbuf_vertex>\n\t//#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",fragmentShader:"\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\nuniform float luma;\nuniform float alphaTest;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n//#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t//#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\n\tvec4 diffuseColor = texture2D( rampSampler, vec2(outputPercentLife, 0.5) ) * outputColorMult;\n\n    vec2 uv = vec2(0.0);\n    #ifdef USE_ORIENTATION\n        uv = outputTexcoord;\n\t#else\n\t    uv = gl_PointCoord;\n\t    uv -= 0.5; uv = uv * rotationMtx; uv += 0.5;\n\t#endif\n\n\t// texture\n\tdiffuseColor *= texture2D( colorSampler, uv );\n\n\tif ( diffuseColor.a < alphaTest ) discard;\n\n\tdiffuseColor.rgb *= luma;\n\n\tgl_FragColor = diffuseColor; \n\t#include <fog_fragment>\n\n}\n",side:i.oriented?e.DoubleSide:e.FrontSide,blending:r,depthTest:!0,depthWrite:i.depthWrite,transparent:i.transparent,forceSinglePass:i.single||!1,fog:i.fog||!1}),this.renderOrder=i.renderOrder||0}}draw(t=0){if(!this.material.uniforms)return;const e=this.material.uniforms;this.time+=this.pe.delta,e.time.value=this.time,e.timeOffset.value=t,e.scale.value=this.pe.hscale,e.luma.value=this.luma?this.pe.luminosity:1,-1!==this.endTime&&this.time>=this.endTime&&this.pe.remove(this.name)}dispose(){this.parent.remove(this),this.geometry.dispose(),this.material.dispose(),this.color.dispose()}raycast(){}clone(t){return void 0===t&&(t=this.pe.createEmitter(this.texture)),t.time=0,t.endTime=this.endTime,t.geometry=this.geometry,t.material=this.material.clone(),t.material.uniforms.rampSampler.value=this.color,t.material.uniforms.colorSampler.value=this.texture,super.copy(t),this.num++,t.name=this.name+this.num,t}},qs=class extends Map{constructor(){super()}dispose(){this.forEach((t=>{t.dispose()})),this.clear()}add(t,e){this.has(t)||this.set(t,e)}make(t){if(!this.has(t)){let e=this["make"+t[0].toUpperCase()+t.substring(1)]();this.set(t,e)}}makePixel(){const t=[];for(let e=0;e<2;++e)for(let e=0;e<2;++e)t.push(1,1,1,1);return Ls.createTextureFromFloats(2,2,t)}makeBasic(){const t=[0,.2,.7,1,.7,.2,0,0],e=[];for(let i=0;i<8;++i)for(let s=0;s<8;++s){let a=t[s]*t[i];e.push(a,a,a,1)}return Ls.createTextureFromFloats(8,8,e)}makeCube(){let t=document.createElement("canvas");t.width=t.height=8;const e=t.getContext("2d");return e.fillStyle="rgba(255,255,255,1.0)",e.fillRect(2,2,4,4),Ls.toTexture(t)}makeCloud(){let t=16,e=document.createElement("canvas");e.width=e.height=t;const i=e.getContext("2d");let s="rgba(255,255,255,1)",a="rgba(255,255,255,0)",r=i.createRadialGradient(8,6.4,0,8,6.4,6.4);return r.addColorStop(.3,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),r=i.createRadialGradient(6.4,9.92,0,6.4,9.92,5.6),r.addColorStop(.3,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),r=i.createRadialGradient(4.32,6.4,0,4.32,6.4,4.16),r.addColorStop(.2,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),r=i.createRadialGradient(12.16,9.6,0,12.16,9.6,3.68),r.addColorStop(.2,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),Ls.toTexture(e)}makeRound(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.3,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),Ls.toTexture(t)}makeRound2(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),Ls.toTexture(t)}makeDonut(){let t=document.createElement("canvas");t.width=t.height=32;const e=t.getContext("2d"),i=e.createRadialGradient(16,16,0,16,16,16);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,0.1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.beginPath(),e.arc(16,16,16,0,2*Math.PI,!1),e.arc(16,16,8,0,2*Math.PI,!0),e.fill(),Ls.toTexture(t)}makeBubble(){let t=document.createElement("canvas");t.width=t.height=64;let e="rgba(0,255,255,0)";const i=t.getContext("2d"),s=i.createRadialGradient(25.6,25.6,0,32,32,32);return s.addColorStop(.4,e),s.addColorStop(.9,"rgba(0,255,255,0.6)"),s.addColorStop(.99,"rgba(0,255,255,1)"),s.addColorStop(1,e),i.fillStyle=s,i.fillRect(0,0,64,64),i.fillStyle="rgba(255,255,255,1)",i.beginPath(),i.arc(44.8,25.6,8.96,0,2*Math.PI,!1),i.fill(),i.beginPath(),i.arc(12.8,41.6,3.2,0,2*Math.PI,!1),i.fill(),Ls.toTexture(t)}makeSmoke(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");let i=new Image;i.src=Os;let s=Ls.toTexture(t);return i.onload=function(){e.drawImage(i,0,0),s.needsUpdate=!0},s}makeCircle(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");return e.strokeStyle="white",e.lineWidth=4,e.beginPath(),e.arc(32,32,30,0,2*Math.PI),e.stroke(),Ls.toTexture(t)}makeField(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,0,64);return i.addColorStop(0,"rgba(255,255,255,0)"),i.addColorStop(.8,"rgba(255,255,255,0.4)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(24,0,16,64),Ls.toTexture(t)}makeStar(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255,255,255,0.5)"),i.addColorStop(.5,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),e.fillStyle=i,this.star(e,32,6.4,32,32,3),this.star(e,32,25.6,32,32,3),Ls.toTexture(t)}makeOcto(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(.4,"rgba(255,255,255,0.2)"),i.addColorStop(1,"rgba(255,255,255,0.4)"),e.fillStyle=i,this.star(e,25.6,22.4,32,32,6),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=6,e.stroke(),Ls.toTexture(t)}star(t,e,i,s,a,r){let o,n,l;t.beginPath(),t.moveTo(s+e,a);for(var h=1;h<=2*r;h++)h%2==0?(l=h*(2*Math.PI)/(2*r),o=s+e*Math.cos(l),n=a+e*Math.sin(l)):(l=h*(2*Math.PI)/(2*r),o=s+i*Math.cos(l),n=a+i*Math.sin(l)),t.lineTo(o,n);t.closePath(),t.fill()}};const Os="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAPOklEQVR42rWb224dRRaGq\n7r30Tu2Y5MhmYsZRZqbeahBiCvgPnCBOCeAEEjcI/E2vAfiYqJJgIHE2/Y+Vk2tzf9Ji2XZDsmkpeXu3V1dXf9f61Sr2316wa3Wmj/++GO\nTrkkvSTo3aDKUdB999JHJoMlEYud72tk13ce53kmmX5PWNr///vvpgw8+yPfv30+llPzee+917Xd68ODBM4+/f1HwbYd04XhgouNqx3re0\nF3rc85DtUntmK6zk7G11XHh0fZns9nk1WqVjYR23J2ennZtn7788sv6UgkA/Hq97mzwbevbbwMzEMBJGPj290HnDrC2qe3IzrV7N2oXSR2\nZ2PN4dNbW972JjSOfnJx0o9EoDwaD+sUXX7w8Ah4+fJgbw7nWCphRztnkDzMr0Wwx8ISWVNvTXrNv14xI7u+4LmLpE82xbcd+A50nk0kdj\n8fJCHnzzTfTN998U18KAW+88UY+OjoypjsNdtTGMLQJYXYBDUjTjqC+nYD1XtVbu7Ht23lIsfPW936TiZ0HOP3YRLTNNKG2LW2aVp6dnqZ\n/vfZa/fbbb//vBJiDMcbtgTv71aDs2IMvkl4AbKDJ9tZW94w0k0nmcsOO7bp+j0TErO1nOgeRmIqZQ3UkNlOYp58eP0qL5bJ+99139YUJ+\nP77702l8ttvv51ff/31bjab5f39/a7h3wFv7GP7nfMPqC8qW5htAd8ToKTr+9pXAZ+atH72pCkFMtVmg48Ag55Rt9tt3pRSbx4epPv3H+T\nPP/+8mrP89NNPn48AA95sKw+Hw7xcLvPh4WG3t7eXmhb0+AER4L3/UOKdYFbbPQOs6xknh1MUMfQ71bkiDaO/KvFRZrsD1Hf1xmy2PTy8m\nc0pWli07cMPP4SEP0fAu+++m9ssAz5Pp1MzAXuone+c+mcAAEr9V+0xh5ns3druOe0ZVbv++zERoUdbpOreufZ6Bu1LbVsjoLTxFXtuKaV\nmF1v/NAE//PCDObtk4J8+fZru3LnTNfXPTc0MuBExMBNgxph5+YbeacN0Z+8pT2qqaIYBu6H7JtYmy/tLcJY7LfBaBpkci6zN76aSa3DC6\nbkJuHfvns18Oj8/z/P5PN29e7c3AizWNsmEJ0DrgcwMmnBDx5yHgJGAkzNwL2qfaEN/zvvzLHwBJlDYk1hJc5KN+Zl9wOPHj/Nbb72VF4t\nFMqfSJN26das7Pj7uBDzLAe5mzhwbaqvBzQAmQBBVNPO3mhziH3R96tp2uncm4N6nmPbZPWvA4hjdcRZwSLDUOX3yySfPRsBXX31l6tKSi\n3GaTmfN9g924Jsz9NmeATcbTnr4K03+0eS2AwEJaEMS+L/p2mmTousHTY5s77z/EBIEHFNgNrdEADcBbBXnye9nIoDts88+a1502Lz/yLx\n+3zIt4rl1aLO/51TxZpN/Nvm7wJ+LfYvtM9vL8++3xsf2WwNeYCYCuqd8YExYM6J1viOlJqSi8oRT38Y0BALIqdCCawkwtd85+G4X5bu+R\nX2lqR2q6LzrRMDvaqbO9PChG3wvMzlq+4NUKzNETnCg/ZA0mO51Du1Z2vBEAODxA7TBNOgju8VWtRUlJFxKQGtkM52hAG+q2TQQE2K+4vq\nrTf5CMqP9mFlxWeG+zW7F4THrzjG6sBjziixwC5PWbi3wtIWMVZOiBZT1h6ZU7a8mwICLva4dDGgjsH9tcstASI2P5KTMBI6lytPWybQaM\nFskaXZqO6e21nfVnri+lmrPlBsAyGSsxVYncGcysRVpsPcBkmrgyTad06xXEQD4rIXHrB0NmzCbNpA7Lvk4tt8Cf2gDx4sbcFP1LIIEaso\nCiDiv2L0SiIna9HZeA06ocq311EzA5RhbgTtX25Eky/aL4WlixxtpzPZSAnTB1H/MzMrmqmb9WECxa0LdDQjQAAa0IaZr1WbgR5yzKZKNk\nvtjCpgb8R1Vt/b4lTFaAilyxGM0Aa2wRZj8BqZxrQbsCViV0Pmr2ncCfSwSpiQ72DGgdT+eewx4BxBCmHnsH8FubdYP3RpiWWs9MVDSwCM\nIwDnqEUVttiKhxHDYB/CEExzPvpzbEbMPYInXhJ4Bh7oAMvAAQ2aIWbB1FD1Ybvt1hsBh0zM3tuzMp9CuyVIkFJMLBAC+2kSlDAl7YvUVN\n8PTkOWh5iP6Ql19Dc9XiaKHD+cK99LepcUrSYdPCmk096+UYJ0T1Ru+FVHjAgEsFSlJ5STV1AMkexJ+Q8bEgc8BTGJgYZZzJILjIPSJhi7\nl+akTohFDgV4TCgV+ASHyE7oeCCilsKQdNfDYsLdjzmGnFD1nzM4ldT7AebBe2OL5DgE7lR9MwfVXQypcHQlryZmZAATJB3Bf2tXbvXfFk\nzuwPmxBCFrRexAcR3XHriPweG/Yxy0z44B3oFJIhM4VwRYco/4mfyCg5ceoPwMO+zBoPDkq6BxbsN84o33s6wrANYIPYwF8hQyBXDkS5k1\nOjASIwkmTDnsC6DiWtHyUsGMywL1QAq9h9qNtR9WOYCIZRJN4Lap4If/HSZIuC/wTaQAEEA53aYiREDVggODdA7CZZXgu6ekYBGEngI4zG\nDeARo2IfiX5NNcdF8BpjwN8auC1xxkWHwW8BpD7Q0DvvHzPAJWCjmuq45zyGPWP6oq6M2gGGK6zlUsIyvE8M49msAc4CRAE1Fqf5Jznvk5\nwqQ/ggVRecTaAQTt8FMiJWj0DdKrvPLPi8JaiZvDg0TzYIhGAAwzgVxYeqf6wWML+2/kzTxraEwnABdgegIPg8SeszRvwvSb7So6IGBlwJ\ngK9Id3lAdFEop+4wkQAsXZkFmxeE7cR+FMtnObtvHOA9HExDCZMAEAhvFGYzJSuAE97rwXMmDAPfJv4yuwa71/DbBdWeZw3Mpg5A0rI08J\nnIQJ8kkQekDwBdnN0gjGx6STEf9oQCuNM9aFymzwBPO8a8EiJ4RIwqikMCH0ihcRpHULjBkyEQQiICYm30S4scGKGiCNMHrykwjj9egn91\n0tUv9qmWS/BZIonR9qw1OJnFRKgKnJKLIr0qgF4Aipg48tIVn+sA3CWGsAaH8IAQRM0KZKcaQRoSKgURoPTJLp4AjTjC6W+Oz8gItZMhpb\nHjgCpobSADVUfQgDnRcC+r+UxKzg8SQ5ZYQxxSNyKN4EMQHfORwQJx+da+xdMgCTIRw9INudv0sMGzpAECNaoBKtcFatBgMtBa6JfAVy0/\nwg67itLdaq6zt6XIc9Y6Fqv945FYZC2tKd/+7iiMhBIGJHrMzAqv8w8xRDqf0HVAZwlHPs4nJ2UeC2S4AlWZCHZWVzTZ5YJzBUeF/5ZBn4\n34FgOJw9A3GupiSovN0XGOFaBorML4FNMlIJEP1QFIprLhvhOe2npxNoqAXqiPs0kfm3X5+3KihenmL1JJCChyiEhwr4PAR8iBGSi/hFIu\nSZFjibC7EftoJK8dZ4dM4QYy/9/bccmv7XrLIm3XrtUbquxKlwbCdF2s3/1Hew8xvUcB891hOtIyPUJo7H/qBXYvG0DJT0PDbgRq7XATyy\nHCYUCbR0U8EJA1AJf0CgskTnHbwZ+hbevkflos5yL/dA+fB5nUlj+4tQE/D/SgCxCfpPtky1Gjaq75XD44tNXbgEQzSIukhJZWIjTyautB\nx8JiWbCfQKdEPry1R/z9E2eKuxx75oQKNL88hlJEADLvQMY1Tb7zC/k6RsHehVUGm3iOM58zBTZs3kNKgrLBXtX9Zd8vwJOoTApDK5jvRB\nt8olQVD1fDI3LYcBWsXzC93p6TcXD1hKWwcEfsOFf4nlAx3UGROeleXa3Cly68hd+jklZ+fsBHwngZFT5HgEYbXR8oj2VJexzKYJKzBdi3\nVHiNSQ60Q0AciYRspw/VcX5X/S8gZ4/17qAfs/1bsC/GYoEsF0sZjIb0aGFslTiCzBXmKiE05jxcR67DoAhwKktYZM3PQkT+K9kqDCdjBA\n5wY1ejvpMMPsPJXwqnAP4dEkeTgaI7fGd0MS9UCnGOKRAABJtPPgTzKtwLhCNZhnAx9qva7U6RZ3hH3SPOce5osJWDlFZoNOAK7Qggu/8C\nlBveW8oC6vKyLZ8RNUEMr3jZPMLGsBCRqWqJEDVacpCBc9fZX4qe9WO+3DoAv4katgFEwgLouioiMdJlTMADUO1J5KWib2Q6olgJgHgica\nBatY8YWu1/012fyo175y/8vn/mUUCCiWMg3+8cHlAICFUZtbrddJXoYWZ452/V2m7jr36d3GQo2tLvvKgYhPMASe6DuaysEovs45NKzWfE\nqIF/t9NfpYjJOwl7XdcXFgMeVOIBJydnSX77lY328CQWAcE4EbHzCzhaIEAIBQsmf1YzFyR4wsgaj4LobrIPB5ZUcSFQsBnbwYNF4uhK7T\nAenv0KLUvRJWKJr684CMEPl4sOL743Q7FCcJjfI3Fbw8Y4VU3ak07/JEnEfWXFLROmkl9IZVS7DtI+xTw0q/EsoGFiB9//DG1DyVT3/fVv\nSgZmWgg5Og4RpPs1G/DQH3CErw64NAA2s0hA63w4ZE+Q4EEKe5bwYrqG/jgBC9qgTeH27dvJ3VQmtqU4XDYt474jLWYkHqhjuTvfBjFmgF\nNCCqPFgAe/xBJAnwN959KqGgV/c5kmTjya78TjERgEsbccrWqv/z8c9o/OBjq32SSr7pCArNuh/xGRRXa8DPk9ZjAGWCYccwgRIu42oTA5\nN8UY4oQR0SxRMjVBNmuJ8Js5uuvv+7MFHwMj6s5acWaNl6FfbE01PgXCm9zpyVr7B+zCNEBcMUVY88k29A+VqbytRpwlXmEjxJZb7Px1ma\ntGUaVS9Zmx4EcoodpyRqtQGhLP8Gn4PBYB5yiBY6guNXnIgCTkJOsLv4jqOaaj5NM9LuSHOWUlyEk4jCLTMXab3B8OFIvgPR+QhKrwHGro\nSr8fFoAGd4HsF7Hthk49opG4OVjfZ/j0rZt2+y4DbSgVSEZox/fnzO9izMPcDAEAp6LDDSBZMMGvml+gvjrFzokS+uUk2lHVOfdrJO2bjY\n6NFEmJxIgwAvA/TMrYL2wQcALb1ETmDGfpDDzDPaSLLAivMtbrVZpcX6+y0G6JlnpbAAaS14cAzhsgYCXQAL7uK4v7C8T8gpy9fl8npeNh\nJZ71L7ryUYhwUsKx+T7L5WASAJSEUjBWfK7bQCOIGi/S1lLazadTtPBwUF955179r+A9g9QXq13MV2qXtvxM4Fn+x+D0fC1BkndygAAAAB\nJRU5ErkJggg==";let Is=class extends e.Group{constructor(t){super(),this.scene=t||null,this.isGl2=!0,this.emitters=new Map,this.textures=new qs,this.loader=null,this.now=0,this.last=0,this.delta=0,this.elapsed=0,this.num=0,this.hscale=.5*window.innerHeight,this.luminosity=1,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}updateMatrixWorld(t){super.updateMatrixWorld(t),null===this.scene&&this.update()}get(t){return this.emitters.has(t)?this.emitters.get(t):null}add(t,e){if(t.isPoints)return void super.add(t);t.name||(t.name="PP"+this.num++),this.remove(t.name),t.model&&Fs[t.model]&&(t={...Fs[t.model],...t});let i=new js(this,t);return this.emitters.set(t.name,i),i}remove(t){if("string"==typeof t||t instanceof String){if(!this.emitters.has(t))return;this.emitters.get(t).dispose(),this.emitters.delete(t)}else if(t.isPoints)return void super.remove(t)}addTexture(t,i,s=!0){this.textures.has(t)?console.log("this name of texture is already take !"):"string"==typeof i?(this.loader||(this.loader=new e.TextureLoader),this.loader.load(i,(i=>{i.flipY=!1,s&&(i.colorSpace=e.SRGBColorSpace),this.textures.add(t,i)}))):i.isTexture&&(i.flipY=!1,this.textures.add(t,i))}load(t){const e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));var i=new XMLHttpRequest;i.open("GET",t),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let t=JSON.parse(i.responseText);for(let e in t)this.add(t[e])}else console.error("Couldn't load ["+e+"] ["+i.status+"]")}.bind(this),i.send()}resize(t){this.hscale=.5*t}onresize(t){this.hscale=.5*t}loop(t){this.delta=t,this.emitters.forEach((t=>{t.draw()}))}update(t){this.now=void 0!==t?t:Date.now(),this.delta=.001*(this.now-this.last),this.elapsed+=this.delta,this.last=this.now,this.emitters.forEach((t=>{t.draw()}))}dispose(t=!0){this.emitters.forEach((t=>{t.dispose()})),this.emitters.clear(),t&&this.textures.dispose(),this.num=0}addBlock(t,e){let i=t[1]<=4?-2:0,s=Fs.getColor(e),a=s[0],r=s[1],o=s[2];s.length>3&&(a=s[3],r=s[4],o=s[5]),t[0]+=.5,t[2]+=.5,this.add({position:t,colors:[a,r,o,1,a,r,o,0],renderOrder:i,...Fs.addBlock})}delBlock(t,e){let i=t[1]<=4?-2:0,s=Fs.getColor(e),a=s[0],r=s[1],o=s[2];t[0]+=.5,t[2]+=.5,t[1]+=.5;let n=30;s.length>3&&(n=20,this.add({position:[t[0],t[1]+.375,t[2]],positionRange:[.5,.25,.5],colors:[a,r,o,.5,a,r,o,0],numParticles:10,renderOrder:i,...Fs.removeBlock}),a=s[3],r=s[4],o=s[5]),this.add({position:t,positionRange:[.5,.5,.5],colors:[a,r,o,.5,a,r,o,0],numParticles:n,renderOrder:i,...Fs.removeBlock})}removePlayerTrail(t){this.remove("PlayerTrail_"+t)}onPlayerWalk(t,e,i){let s=this.get("PlayerTrail_"+e);null===s&&(s=this.addTrail({name:"PlayerTrail_"+e,...Fs.playerMove}));let a=t.toArray();a[1]+=.2;let r=Fs.getColor(i),o=[r[0],r[1],r[2],.75,r[0],r[1],r[2],0];r.length>3&&(o=[r[0],r[1],r[2],.75,r[3],r[4],r[5],0]),s.birthParticles(a,o)}onVehicleDrive(t,e){let i=this.get("VehicleTrail_"+e);null===i&&(i=this.addTrail({name:"VehicleTrail_"+e,...Fs.vehicleMove})),i.birthParticles(t.toArray())}onBazookaFire(t,e){let i=this.get("BazookaTrail_"+e);null===i&&(i=this.addTrail({name:"BazookaTrail_"+e,...Fs.bazookaFire})),i.birthParticles(t.toArray())}onExplosion(t){this.add({position:t.toArray(),...Fs.explosion})}};new e.Vector3,new e.Vector3,new e.Mesh(new e.SphereGeometry(.03),new e.MeshBasicMaterial({transparent:!0})),new e.Vector3,new e.Vector3,new e.Mesh(new e.SphereGeometry(.03),new e.MeshBasicMaterial({transparent:!0})),new e.PlaneGeometry;new e.CylinderGeometry(1,1,1).rotateX(Math.PI/2),new e.Object3D,new e.Vector3,new e.Vector3,new e.Color("red");const Gs=1.25,Us=65535,Ns=Math.pow(2,-24),Ws=Symbol("SKIP_GENERATION");function Hs(t){return function(t){return t.index?t.index.count:t.attributes.position.count}(t)/3}function Ks(t,e){const i=Hs(t),s=e||t.drawRange,a=s.start/3,r=(s.start+s.count)/3,o=Math.max(0,a),n=Math.min(i,r)-o;return[{offset:Math.floor(o),count:Math.floor(n)}]}function Xs(t,e){if(!t.groups||!t.groups.length)return Ks(t,e);const i=[],s=new Set,a=e||t.drawRange,r=a.start/3,o=(a.start+a.count)/3;for(const e of t.groups){const t=e.start/3,i=(e.start+e.count)/3;s.add(Math.max(r,t)),s.add(Math.min(o,i))}const n=Array.from(s.values()).sort(((t,e)=>t-e));for(let t=0;t<n.length-1;t++){const e=n[t],s=n[t+1];i.push({offset:Math.floor(e),count:Math.floor(s-e)})}return i}function Js(t,e,i,s,a){let r=1/0,o=1/0,n=1/0,l=-1/0,h=-1/0,c=-1/0,d=1/0,u=1/0,p=1/0,m=-1/0,f=-1/0,b=-1/0;for(let s=6*e,a=6*(e+i);s<a;s+=6){const e=t[s+0],i=t[s+1],a=e-i,g=e+i;a<r&&(r=a),g>l&&(l=g),e<d&&(d=e),e>m&&(m=e);const y=t[s+2],x=t[s+3],v=y-x,w=y+x;v<o&&(o=v),w>h&&(h=w),y<u&&(u=y),y>f&&(f=y);const M=t[s+4],k=t[s+5],A=M-k,S=M+k;A<n&&(n=A),S>c&&(c=S),M<p&&(p=M),M>b&&(b=M)}s[0]=r,s[1]=o,s[2]=n,s[3]=l,s[4]=h,s[5]=c,a[0]=d,a[1]=u,a[2]=p,a[3]=m,a[4]=f,a[5]=b}function Qs(t,e,i){return i.min.x=e[t],i.min.y=e[t+1],i.min.z=e[t+2],i.max.x=e[t+3],i.max.y=e[t+4],i.max.z=e[t+5],i}function Ys(t){let e=-1,i=-1/0;for(let s=0;s<3;s++){const a=t[s+3]-t[s];a>i&&(i=a,e=s)}return e}function Zs(t,e){e.set(t)}function $s(t,e,i){let s,a;for(let r=0;r<3;r++){const o=r+3;s=t[r],a=e[r],i[r]=s<a?s:a,s=t[o],a=e[o],i[o]=s>a?s:a}}function ta(t,e,i){for(let s=0;s<3;s++){const a=e[t+2*s],r=e[t+2*s+1],o=a-r,n=a+r;o<i[s]&&(i[s]=o),n>i[s+3]&&(i[s+3]=n)}}function ea(t){const e=t[3]-t[0],i=t[4]-t[1],s=t[5]-t[2];return 2*(e*i+i*s+s*e)}const ia=(t,e)=>t.candidate-e.candidate,sa=new Array(32).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),aa=new Float32Array(6);class ra{constructor(){this.boundingData=new Float32Array(6)}}function oa(t,e,i,s,a,r){let o=s,n=s+a-1;const l=r.pos,h=2*r.axis;for(;;){for(;o<=n&&i[6*o+h]<l;)o++;for(;o<=n&&i[6*n+h]>=l;)n--;if(!(o<n))return o;for(let t=0;t<3;t++){let i=e[3*o+t];e[3*o+t]=e[3*n+t],e[3*n+t]=i}for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*n+t],i[6*n+t]=e}o++,n--}}function na(t,e,i,s,a,r){let o=s,n=s+a-1;const l=r.pos,h=2*r.axis;for(;;){for(;o<=n&&i[6*o+h]<l;)o++;for(;o<=n&&i[6*n+h]>=l;)n--;if(!(o<n))return o;{let e=t[o];t[o]=t[n],t[n]=e;for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*n+t],i[6*n+t]=e}o++,n--}}}function la(t,e){return 65535===e[t+15]}function ha(t,e){return e[t+6]}function ca(t,e){return e[t+14]}function da(t){return t+8}function ua(t,e){return e[t+6]}function pa(t,e){return e[t+7]}let ma,fa,ba,ga;const ya=Math.pow(2,32);function xa(t){return"count"in t?1:1+xa(t.left)+xa(t.right)}function va(t,e,i){return ma=new Float32Array(i),fa=new Uint32Array(i),ba=new Uint16Array(i),ga=new Uint8Array(i),wa(t,e)}function wa(t,e){const i=t/4,s=t/2,a="count"in e,r=e.boundingData;for(let t=0;t<6;t++)ma[i+t]=r[t];if(a){if(e.buffer){const s=e.buffer;ga.set(new Uint8Array(s),t);for(let e=t,a=t+s.byteLength;e<a;e+=32)la(e/2,ba)||(fa[e/4+6]+=i);return t+s.byteLength}{const a=e.offset,r=e.count;return fa[i+6]=a,ba[s+14]=r,ba[s+15]=Us,t+32}}{const s=e.left,a=e.right,r=e.splitAxis;let o;if(o=wa(t+32,s),o/4>ya)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return fa[i+6]=o/4,o=wa(o,a),fa[i+7]=r,o}}function Ma(t,i){const s=t.geometry;i.indirect&&(t._indirectBuffer=function(t,e){const i=(t.index?t.index.count:t.attributes.position.count)/3,s=i>65536,a=s?4:2,r=e?new SharedArrayBuffer(i*a):new ArrayBuffer(i*a),o=s?new Uint32Array(r):new Uint16Array(r);for(let t=0,e=o.length;t<e;t++)o[t]=t;return o}(s,i.useSharedArrayBuffer),function(t,e){const i=Hs(t),s=Xs(t,e).sort(((t,e)=>t.offset-e.offset)),a=s[s.length-1];a.count=Math.min(i-a.offset,a.count);let r=0;return s.forEach((({count:t})=>r+=t)),i!==r}(s,i.range)&&!i.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),t._indirectBuffer||function(t,i){if(!t.index){const s=t.attributes.position.count,a=function(t,e=ArrayBuffer){return t>65535?new Uint32Array(new e(4*t)):new Uint16Array(new e(2*t))}(s,i.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);t.setIndex(new e.BufferAttribute(a,1));for(let t=0;t<s;t++)a[t]=t}}(s,i);const a=i.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,r=function(t,e=null,i=null,s=null){const a=t.attributes.position,r=t.index?t.index.array:null,o=Hs(t),n=a.normalized;let l;null===e?(l=new Float32Array(6*o),i=0,s=o):(l=e,i=i||0,s=s||o);const h=a.array,c=a.offset||0;let d=3;a.isInterleavedBufferAttribute&&(d=a.data.stride);const u=["getX","getY","getZ"];for(let t=i;t<i+s;t++){const e=3*t,i=6*t;let s=e+0,o=e+1,p=e+2;r&&(s=r[s],o=r[o],p=r[p]),n||(s=s*d+c,o=o*d+c,p=p*d+c);for(let t=0;t<3;t++){let e,r,c;n?(e=a[u[t]](s),r=a[u[t]](o),c=a[u[t]](p)):(e=h[s+t],r=h[o+t],c=h[p+t]);let d=e;r<d&&(d=r),c<d&&(d=c);let m=e;r>m&&(m=r),c>m&&(m=c);const f=(m-d)/2,b=2*t;l[i+b+0]=d+f,l[i+b+1]=f+(Math.abs(d)+f)*Ns}}return l}(s),o=i.indirect?Ks(s,i.range):Xs(s,i.range);t._roots=o.map((e=>{const s=function(t,e,i,s,a){const{maxDepth:r,verbose:o,maxLeafTris:n,strategy:l,onProgress:h,indirect:c}=a,d=t._indirectBuffer,u=t.geometry,p=u.index?u.index.array:null,m=c?na:oa,f=Hs(u),b=new Float32Array(6);let g=!1;const y=new ra;return Js(e,i,s,y.boundingData,b),function t(i,s,a,h=null,c=0){if(!g&&c>=r&&(g=!0,o&&(console.warn(`MeshBVH: Max depth of ${r} reached when generating BVH. Consider increasing maxDepth.`),console.warn(u))),a<=n||c>=r)return x(s+a),i.offset=s,i.count=a,i;const f=function(t,e,i,s,a,r){let o=-1,n=0;if(0===r)o=Ys(e),-1!==o&&(n=(e[o]+e[o+3])/2);else if(1===r)o=Ys(t),-1!==o&&(n=function(t,e,i,s){let a=0;for(let r=e,o=e+i;r<o;r++)a+=t[6*r+2*s];return a/i}(i,s,a,o));else if(2===r){const r=ea(t);let l=Gs*a;const h=6*s,c=6*(s+a);for(let t=0;t<3;t++){const s=e[t],d=(e[t+3]-s)/32;if(a<8){const e=[...sa];e.length=a;let s=0;for(let a=h;a<c;a+=6,s++){const r=e[s];r.candidate=i[a+2*t],r.count=0;const{bounds:o,leftCacheBounds:n,rightCacheBounds:l}=r;for(let t=0;t<3;t++)l[t]=1/0,l[t+3]=-1/0,n[t]=1/0,n[t+3]=-1/0,o[t]=1/0,o[t+3]=-1/0;ta(a,i,o)}e.sort(ia);let d=a;for(let t=0;t<d;t++){const i=e[t];for(;t+1<d&&e[t+1].candidate===i.candidate;)e.splice(t+1,1),d--}for(let s=h;s<c;s+=6){const a=i[s+2*t];for(let t=0;t<d;t++){const r=e[t];a>=r.candidate?ta(s,i,r.rightCacheBounds):(ta(s,i,r.leftCacheBounds),r.count++)}}for(let i=0;i<d;i++){const s=e[i],h=s.count,c=a-s.count,d=s.leftCacheBounds,u=s.rightCacheBounds;let p=0;0!==h&&(p=ea(d)/r);let m=0;0!==c&&(m=ea(u)/r);const f=1+Gs*(p*h+m*c);f<l&&(o=t,l=f,n=s.candidate)}}else{for(let t=0;t<32;t++){const e=sa[t];e.count=0,e.candidate=s+d+t*d;const i=e.bounds;for(let t=0;t<3;t++)i[t]=1/0,i[t+3]=-1/0}for(let e=h;e<c;e+=6){let a=~~((i[e+2*t]-s)/d);a>=32&&(a=31);const r=sa[a];r.count++,ta(e,i,r.bounds)}const e=sa[31];Zs(e.bounds,e.rightCacheBounds);for(let t=30;t>=0;t--){const e=sa[t],i=sa[t+1];$s(e.bounds,i.rightCacheBounds,e.rightCacheBounds)}let u=0;for(let e=0;e<31;e++){const i=sa[e],s=i.count,h=i.bounds,c=sa[e+1].rightCacheBounds;0!==s&&(0===u?Zs(h,aa):$s(h,aa,aa)),u+=s;let d=0,p=0;0!==u&&(d=ea(aa)/r);const m=a-u;0!==m&&(p=ea(c)/r);const f=1+Gs*(d*u+p*m);f<l&&(o=t,l=f,n=i.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:n}}(i.boundingData,h,e,s,a,l);if(-1===f.axis)return x(s+a),i.offset=s,i.count=a,i;const y=m(d,p,e,s,a,f);if(y===s||y===s+a)x(s+a),i.offset=s,i.count=a;else{i.splitAxis=f.axis;const r=new ra,o=s,n=y-s;i.left=r,Js(e,o,n,r.boundingData,b),t(r,o,n,b,c+1);const l=new ra,h=y,d=a-n;i.right=l,Js(e,h,d,l.boundingData,b),t(l,h,d,b,c+1)}return i}(y,i,s,b),y;function x(t){h&&h(t/f)}}(t,r,e.offset,e.count,i),o=xa(s),n=new a(32*o);return va(0,s,n),n}))}class ka{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let i=1/0,s=-1/0;for(let a=0,r=t.length;a<r;a++){const r=t[a][e];i=r<i?r:i,s=r>s?r:s}this.min=i,this.max=s}setFromPoints(t,e){let i=1/0,s=-1/0;for(let a=0,r=e.length;a<r;a++){const r=e[a],o=t.dot(r);i=o<i?o:i,s=o>s?o:s}this.min=i,this.max=s}isSeparated(t){return this.min>t.max||t.min>this.max}}ka.prototype.setFromBox=function(){const t=new e.Vector3;return function(e,i){const s=i.min,a=i.max;let r=1/0,o=-1/0;for(let i=0;i<=1;i++)for(let n=0;n<=1;n++)for(let l=0;l<=1;l++){t.x=s.x*i+a.x*(1-i),t.y=s.y*n+a.y*(1-n),t.z=s.z*l+a.z*(1-l);const h=e.dot(t);r=Math.min(h,r),o=Math.max(h,o)}this.min=r,this.max=o}}();const Aa=function(){const t=new e.Vector3,i=new e.Vector3,s=new e.Vector3;return function(e,a,r){const o=e.start,n=t,l=a.start,h=i;s.subVectors(o,l),t.subVectors(e.end,e.start),i.subVectors(a.end,a.start);const c=s.dot(h),d=h.dot(n),u=h.dot(h),p=s.dot(n),m=n.dot(n)*u-d*d;let f,b;f=0!==m?(c*d-p*u)/m:0,b=(c+f*d)/u,r.x=f,r.y=b}}(),Sa=function(){const t=new e.Vector2,i=new e.Vector3,s=new e.Vector3;return function(e,a,r,o){Aa(e,a,t);let n=t.x,l=t.y;if(n>=0&&n<=1&&l>=0&&l<=1)return e.at(n,r),void a.at(l,o);if(n>=0&&n<=1)return l<0?a.at(0,o):a.at(1,o),void e.closestPointToPoint(o,!0,r);if(l>=0&&l<=1)return n<0?e.at(0,r):e.at(1,r),void a.closestPointToPoint(r,!0,o);{let t,h;t=n<0?e.start:e.end,h=l<0?a.start:a.end;const c=i,d=s;return e.closestPointToPoint(h,!0,i),a.closestPointToPoint(t,!0,s),c.distanceToSquared(h)<=d.distanceToSquared(t)?(r.copy(c),void o.copy(h)):(r.copy(t),void o.copy(d))}}}(),Ta=function(){const t=new e.Vector3,i=new e.Vector3,s=new e.Plane,a=new e.Line3;return function(e,r){const{radius:o,center:n}=e,{a:l,b:h,c:c}=r;if(a.start=l,a.end=h,a.closestPointToPoint(n,!0,t).distanceTo(n)<=o)return!0;if(a.start=l,a.end=c,a.closestPointToPoint(n,!0,t).distanceTo(n)<=o)return!0;if(a.start=h,a.end=c,a.closestPointToPoint(n,!0,t).distanceTo(n)<=o)return!0;const d=r.getPlane(s);if(Math.abs(d.distanceToPoint(n))<=o){const t=d.projectPoint(n,i);if(r.containsPoint(t))return!0}return!1}}();function Pa(t){return Math.abs(t)<1e-15}class za extends e.Triangle{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new e.Vector3)),this.satBounds=new Array(4).fill().map((()=>new ka)),this.points=[this.a,this.b,this.c],this.sphere=new e.Sphere,this.plane=new e.Plane,this.needsUpdate=!0}intersectsSphere(t){return Ta(t,this)}update(){const t=this.a,e=this.b,i=this.c,s=this.points,a=this.satAxes,r=this.satBounds,o=a[0],n=r[0];this.getNormal(o),n.setFromPoints(o,s);const l=a[1],h=r[1];l.subVectors(t,e),h.setFromPoints(l,s);const c=a[2],d=r[2];c.subVectors(e,i),d.setFromPoints(c,s);const u=a[3],p=r[3];u.subVectors(i,t),p.setFromPoints(u,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,t),this.needsUpdate=!1}}za.prototype.closestPointToSegment=function(){const t=new e.Vector3,i=new e.Vector3,s=new e.Line3;return function(e,a=null,r=null){const{start:o,end:n}=e,l=this.points;let h,c=1/0;for(let o=0;o<3;o++){const n=(o+1)%3;s.start.copy(l[o]),s.end.copy(l[n]),Sa(s,e,t,i),h=t.distanceToSquared(i),h<c&&(c=h,a&&a.copy(t),r&&r.copy(i))}return this.closestPointToPoint(o,t),h=o.distanceToSquared(t),h<c&&(c=h,a&&a.copy(t),r&&r.copy(o)),this.closestPointToPoint(n,t),h=n.distanceToSquared(t),h<c&&(c=h,a&&a.copy(t),r&&r.copy(n)),Math.sqrt(c)}}(),za.prototype.intersectsTriangle=function(){const t=new za,i=new Array(3),s=new Array(3),a=new ka,r=new ka,o=new e.Vector3,n=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new e.Line3,u=new e.Line3,p=new e.Line3,m=new e.Vector3;function f(t,e,i){const s=t.points;let a=0,r=-1;for(let t=0;t<3;t++){const{start:o,end:l}=d;o.copy(s[t]),l.copy(s[(t+1)%3]),d.delta(n);const h=Pa(e.distanceToPoint(o));if(Pa(e.normal.dot(n))&&h){i.copy(d),a=2;break}const c=e.intersectLine(d,m);if(!c&&h&&m.copy(o),(c||h)&&!Pa(m.distanceTo(l))){if(a<=1)(1===a?i.start:i.end).copy(m),h&&(r=a);else if(a>=2){(1===r?i.start:i.end).copy(m),a=2;break}if(a++,2===a&&-1===r)break}}return a}return function(e,n=null,d=!1){this.needsUpdate&&this.update(),e.isExtendedTriangle?e.needsUpdate&&e.update():(t.copy(e),t.update(),e=t);const m=this.plane,b=e.plane;if(Math.abs(m.normal.dot(b.normal))>1-1e-10){const t=this.satBounds,l=this.satAxes;s[0]=e.a,s[1]=e.b,s[2]=e.c;for(let e=0;e<4;e++){const i=t[e],r=l[e];if(a.setFromPoints(r,s),i.isSeparated(a))return!1}const h=e.satBounds,c=e.satAxes;i[0]=this.a,i[1]=this.b,i[2]=this.c;for(let t=0;t<4;t++){const e=h[t],s=c[t];if(a.setFromPoints(s,i),e.isSeparated(a))return!1}for(let t=0;t<4;t++){const e=l[t];for(let t=0;t<4;t++){const n=c[t];if(o.crossVectors(e,n),a.setFromPoints(o,i),r.setFromPoints(o,s),a.isSeparated(r))return!1}}return n&&(d||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),n.start.set(0,0,0),n.end.set(0,0,0)),!0}{const t=f(this,b,u);if(1===t&&e.containsPoint(u.end))return n&&(n.start.copy(u.end),n.end.copy(u.end)),!0;if(2!==t)return!1;const i=f(e,m,p);if(1===i&&this.containsPoint(p.end))return n&&(n.start.copy(p.end),n.end.copy(p.end)),!0;if(2!==i)return!1;if(u.delta(l),p.delta(h),l.dot(h)<0){let t=p.start;p.start=p.end,p.end=t}const s=u.start.dot(l),a=u.end.dot(l),r=p.start.dot(l),o=p.end.dot(l);return(s===o||r===a||a<r!=s<o)&&(n&&(c.subVectors(u.start,p.start),c.dot(l)>0?n.start.copy(u.start):n.start.copy(p.start),c.subVectors(u.end,p.end),c.dot(l)<0?n.end.copy(u.end):n.end.copy(p.end)),!0)}}}(),za.prototype.distanceToPoint=function(){const t=new e.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),za.prototype.distanceToTriangle=function(){const t=new e.Vector3,i=new e.Vector3,s=["a","b","c"],a=new e.Line3,r=new e.Line3;return function(e,o=null,n=null){const l=o||n?a:null;if(this.intersectsTriangle(e,l))return(o||n)&&(o&&l.getCenter(o),n&&l.getCenter(n)),0;let h=1/0;for(let i=0;i<3;i++){let a;const r=s[i],l=e[r];this.closestPointToPoint(l,t),a=l.distanceToSquared(t),a<h&&(h=a,o&&o.copy(t),n&&n.copy(l));const c=this[r];e.closestPointToPoint(c,t),a=c.distanceToSquared(t),a<h&&(h=a,o&&o.copy(c),n&&n.copy(t))}for(let l=0;l<3;l++){const c=s[l],d=s[(l+1)%3];a.set(this[c],this[d]);for(let l=0;l<3;l++){const c=s[l],d=s[(l+1)%3];r.set(e[c],e[d]),Sa(a,r,t,i);const u=t.distanceToSquared(i);u<h&&(h=u,o&&o.copy(t),n&&n.copy(i))}}return Math.sqrt(h)}}();class Ra{constructor(t,i,s){this.isOrientedBox=!0,this.min=new e.Vector3,this.max=new e.Vector3,this.matrix=new e.Matrix4,this.invMatrix=new e.Matrix4,this.points=new Array(8).fill().map((()=>new e.Vector3)),this.satAxes=new Array(3).fill().map((()=>new e.Vector3)),this.satBounds=new Array(3).fill().map((()=>new ka)),this.alignedSatBounds=new Array(3).fill().map((()=>new ka)),this.needsUpdate=!1,t&&this.min.copy(t),i&&this.max.copy(i),s&&this.matrix.copy(s)}set(t,e,i){this.min.copy(t),this.max.copy(e),this.matrix.copy(i),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Ra.prototype.update=function(){const t=this.matrix,e=this.min,i=this.max,s=this.points;for(let a=0;a<=1;a++)for(let r=0;r<=1;r++)for(let o=0;o<=1;o++){const n=s[1*a|2*r|4*o];n.x=a?i.x:e.x,n.y=r?i.y:e.y,n.z=o?i.z:e.z,n.applyMatrix4(t)}const a=this.satBounds,r=this.satAxes,o=s[0];for(let t=0;t<3;t++){const e=r[t],i=a[t],n=s[1<<t];e.subVectors(o,n),i.setFromPoints(e,s)}const n=this.alignedSatBounds;n[0].setFromPointsField(s,"x"),n[1].setFromPointsField(s,"y"),n[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},Ra.prototype.intersectsBox=function(){const t=new ka;return function(e){this.needsUpdate&&this.update();const i=e.min,s=e.max,a=this.satBounds,r=this.satAxes,o=this.alignedSatBounds;if(t.min=i.x,t.max=s.x,o[0].isSeparated(t))return!1;if(t.min=i.y,t.max=s.y,o[1].isSeparated(t))return!1;if(t.min=i.z,t.max=s.z,o[2].isSeparated(t))return!1;for(let i=0;i<3;i++){const s=r[i],o=a[i];if(t.setFromBox(s,e),o.isSeparated(t))return!1}return!0}}(),Ra.prototype.intersectsTriangle=function(){const t=new za,i=new Array(3),s=new ka,a=new ka,r=new e.Vector3;return function(e){this.needsUpdate&&this.update(),e.isExtendedTriangle?e.needsUpdate&&e.update():(t.copy(e),t.update(),e=t);const o=this.satBounds,n=this.satAxes;i[0]=e.a,i[1]=e.b,i[2]=e.c;for(let t=0;t<3;t++){const e=o[t],a=n[t];if(s.setFromPoints(a,i),e.isSeparated(s))return!1}const l=e.satBounds,h=e.satAxes,c=this.points;for(let t=0;t<3;t++){const e=l[t],i=h[t];if(s.setFromPoints(i,c),e.isSeparated(s))return!1}for(let t=0;t<3;t++){const e=n[t];for(let t=0;t<4;t++){const o=h[t];if(r.crossVectors(e,o),s.setFromPoints(r,i),a.setFromPoints(r,c),s.isSeparated(a))return!1}}return!0}}(),Ra.prototype.closestPointToPoint=function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e},Ra.prototype.distanceToPoint=function(){const t=new e.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),Ra.prototype.distanceToBox=function(){const t=["x","y","z"],i=new Array(12).fill().map((()=>new e.Line3)),s=new Array(12).fill().map((()=>new e.Line3)),a=new e.Vector3,r=new e.Vector3;return function(e,o=0,n=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(e))return(n||l)&&(e.getCenter(r),this.closestPointToPoint(r,a),e.closestPointToPoint(a,r),n&&n.copy(a),l&&l.copy(r)),0;const h=o*o,c=e.min,d=e.max,u=this.points;let p=1/0;for(let t=0;t<8;t++){const e=u[t];r.copy(e).clamp(c,d);const i=e.distanceToSquared(r);if(i<p&&(p=i,n&&n.copy(e),l&&l.copy(r),i<h))return Math.sqrt(i)}let m=0;for(let e=0;e<3;e++)for(let a=0;a<=1;a++)for(let r=0;r<=1;r++){const o=(e+1)%3,n=(e+2)%3,l=1<<e|a<<o|r<<n,h=u[a<<o|r<<n],p=u[l];i[m].set(h,p);const f=t[e],b=t[o],g=t[n],y=s[m],x=y.start,v=y.end;x[f]=c[f],x[b]=a?c[b]:d[b],x[g]=r?c[g]:d[b],v[f]=d[f],v[b]=a?c[b]:d[b],v[g]=r?c[g]:d[b],m++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let i=0;i<=1;i++){r.x=t?d.x:c.x,r.y=e?d.y:c.y,r.z=i?d.z:c.z,this.closestPointToPoint(r,a);const s=r.distanceToSquared(a);if(s<p&&(p=s,n&&n.copy(a),l&&l.copy(r),s<h))return Math.sqrt(s)}for(let t=0;t<12;t++){const e=i[t];for(let t=0;t<12;t++){const i=s[t];Sa(e,i,a,r);const o=a.distanceToSquared(r);if(o<p&&(p=o,n&&n.copy(a),l&&l.copy(r),o<h))return Math.sqrt(o)}}return Math.sqrt(p)}}();class Ea{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}const Fa=new class extends Ea{constructor(){super((()=>new za))}},Ba=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=i=>{e&&t.push(e),e=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==t.length&&this.setBuffer(t.pop())}}};let Ca,La;const _a=[],Da=new Ea((()=>new e.Box3));function Va(t,e,i,s,a,r){Ca=Da.getPrimitive(),La=Da.getPrimitive(),_a.push(Ca,La),Ba.setBuffer(t._roots[e]);const o=ja(0,t.geometry,i,s,a,r);Ba.clearBuffer(),Da.releasePrimitive(Ca),Da.releasePrimitive(La),_a.pop(),_a.pop();const n=_a.length;return n>0&&(La=_a[n-1],Ca=_a[n-2]),o}function ja(t,e,i,s,a=null,r=0,o=0){const{float32Array:n,uint16Array:l,uint32Array:h}=Ba;let c=2*t;if(la(c,l)){const d=ha(t,h),u=ca(c,l);return Qs(t,n,Ca),s(d,u,!1,o,r+t,Ca)}{const p=da(t),m=ua(t,h);let f,b,g,y,x=p,v=m;if(a&&(g=Ca,y=La,Qs(x,n,g),Qs(v,n,y),f=a(g),b=a(y),b<f)){x=m,v=p;const P=f;f=b,b=P,g=y}g||(g=Ca,Qs(x,n,g));const w=i(g,la(2*x,l),f,o+1,r+x);let M;if(2===w){const z=S(x);M=s(z,T(x)-z,!0,o+1,r+x,g)}else M=w&&ja(x,e,i,s,a,r,o+1);if(M)return!0;y=La,Qs(v,n,y);const k=i(y,la(2*v,l),b,o+1,r+v);let A;if(2===k){const R=S(v);A=s(R,T(v)-R,!0,o+1,r+v,y)}else A=k&&ja(v,e,i,s,a,r,o+1);return!!A;function S(t){const{uint16Array:e,uint32Array:i}=Ba;let s=2*t;for(;!la(s,e);)s=2*(t=da(t));return ha(t,i)}function T(t){const{uint16Array:e,uint32Array:i}=Ba;let s=2*t;for(;!la(s,e);)s=2*(t=ua(t,i));return ha(t,i)+ca(s,e)}}}const qa=new e.Vector3,Oa=new e.Vector3,Ia=parseInt(e.REVISION)>=169,Ga=new e.Vector3,Ua=new e.Vector3,Na=new e.Vector3,Wa=new e.Vector2,Ha=new e.Vector2,Ka=new e.Vector2,Xa=new e.Vector3,Ja=new e.Vector3,Qa=new e.Vector3,Ya=new e.Vector3;function Za(t,i,s,a,r,o,n){const l=3*a;let h=l+0,c=l+1,d=l+2;const u=t.index;t.index&&(h=u.getX(h),c=u.getX(c),d=u.getX(d));const{position:p,normal:m,uv:f,uv1:b}=t.attributes,g=function(t,i,s,a,r,o,n,l,h,c,d){Ga.fromBufferAttribute(i,o),Ua.fromBufferAttribute(i,n),Na.fromBufferAttribute(i,l);const u=function(t,i,s,a,r,o,n,l){let h;if(h=o===e.BackSide?t.intersectTriangle(a,s,i,!0,r):t.intersectTriangle(i,s,a,o!==e.DoubleSide,r),null===h)return null;const c=t.origin.distanceTo(r);return c<n||c>l?null:{distance:c,point:r.clone()}}(t,Ga,Ua,Na,Ya,h,c,d);if(u){const i=new e.Vector3;e.Triangle.getBarycoord(Ya,Ga,Ua,Na,i),a&&(Wa.fromBufferAttribute(a,o),Ha.fromBufferAttribute(a,n),Ka.fromBufferAttribute(a,l),u.uv=e.Triangle.getInterpolation(Ya,Ga,Ua,Na,Wa,Ha,Ka,new e.Vector2)),r&&(Wa.fromBufferAttribute(r,o),Ha.fromBufferAttribute(r,n),Ka.fromBufferAttribute(r,l),u.uv1=e.Triangle.getInterpolation(Ya,Ga,Ua,Na,Wa,Ha,Ka,new e.Vector2)),s&&(Xa.fromBufferAttribute(s,o),Ja.fromBufferAttribute(s,n),Qa.fromBufferAttribute(s,l),u.normal=e.Triangle.getInterpolation(Ya,Ga,Ua,Na,Xa,Ja,Qa,new e.Vector3),u.normal.dot(t.direction)>0&&u.normal.multiplyScalar(-1));const h={a:o,b:n,c:l,normal:new e.Vector3,materialIndex:0};e.Triangle.getNormal(Ga,Ua,Na,h.normal),u.face=h,u.faceIndex=o,Ia&&(u.barycoord=i)}return u}(s,p,m,f,b,h,c,d,i,o,n);return g?(g.faceIndex=a,r&&r.push(g),g):null}function $a(t,e,i,s){const a=t.a,r=t.b,o=t.c;let n=e,l=e+1,h=e+2;i&&(n=i.getX(n),l=i.getX(l),h=i.getX(h)),a.x=s.getX(n),a.y=s.getY(n),a.z=s.getZ(n),r.x=s.getX(l),r.y=s.getY(l),r.z=s.getZ(l),o.x=s.getX(h),o.y=s.getY(h),o.z=s.getZ(h)}function tr(t,e,i,s,a,r,o){const{geometry:n}=i,{index:l}=n,h=n.attributes.position;for(let i=t,n=e+t;i<n;i++){let t;if(t=i,$a(o,3*t,l,h),o.needsUpdate=!0,s(o,t,a,r))return!0}return!1}function er(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,a=i.attributes.position;let r,o,n,l,h=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),n=new Uint16Array(r),l=new Float32Array(r),d(0,h),h+=r.byteLength;function d(t,i,r=!1){const h=2*t;if(n[h+15]===Us){const e=o[t+6];let i=1/0,r=1/0,c=1/0,d=-1/0,u=-1/0,p=-1/0;for(let t=3*e,o=3*(e+n[h+14]);t<o;t++){let e=s[t];const o=a.getX(e),n=a.getY(e),l=a.getZ(e);o<i&&(i=o),o>d&&(d=o),n<r&&(r=n),n>u&&(u=n),l<c&&(c=l),l>p&&(p=l)}return(l[t+0]!==i||l[t+1]!==r||l[t+2]!==c||l[t+3]!==d||l[t+4]!==u||l[t+5]!==p)&&(l[t+0]=i,l[t+1]=r,l[t+2]=c,l[t+3]=d,l[t+4]=u,l[t+5]=p,!0)}{const s=t+8,a=o[t+6],n=s+i,h=a+i;let c=r,u=!1,p=!1;e?c||(u=e.has(n),p=e.has(h),c=!u&&!p):(u=!0,p=!0);const m=c||p;let f=!1;(c||u)&&(f=d(s,i,c));let b=!1;m&&(b=d(a,i,c));const g=f||b;if(g)for(let e=0;e<3;e++){const i=s+e,r=a+e,o=l[i],n=l[i+3],h=l[r],c=l[r+3];l[t+e]=o<h?o:h,l[t+e+3]=n>c?n:c}return g}}}function ir(t,e,i,s,a){let r,o,n,l,h,c;const d=1/i.direction.x,u=1/i.direction.y,p=1/i.direction.z,m=i.origin.x,f=i.origin.y,b=i.origin.z;let g=e[t],y=e[t+3],x=e[t+1],v=e[t+3+1],w=e[t+2],M=e[t+3+2];return d>=0?(r=(g-m)*d,o=(y-m)*d):(r=(y-m)*d,o=(g-m)*d),u>=0?(n=(x-f)*u,l=(v-f)*u):(n=(v-f)*u,l=(x-f)*u),!(r>l||n>o)&&((n>r||isNaN(r))&&(r=n),(l<o||isNaN(o))&&(o=l),p>=0?(h=(w-b)*p,c=(M-b)*p):(h=(M-b)*p,c=(w-b)*p),!(r>c||h>o)&&((h>r||r!=r)&&(r=h),(c<o||o!=o)&&(o=c),r<=a&&o>=s))}function sr(t,e,i,s,a,r,o){const{geometry:n}=i,{index:l}=n,h=n.attributes.position;for(let n=t,c=e+t;n<c;n++){let t;if(t=i.resolveTriangleIndex(n),$a(o,3*t,l,h),o.needsUpdate=!0,s(o,t,a,r))return!0}return!1}function ar(t,e,i,s,a,r,o){Ba.setBuffer(t._roots[e]),rr(0,t,i,s,a,r,o),Ba.clearBuffer()}function rr(t,e,i,s,a,r,o){const{float32Array:n,uint16Array:l,uint32Array:h}=Ba,c=2*t;if(la(c,l))!function(t,e,i,s,a,r,o,n){const{geometry:l,_indirectBuffer:h}=t;for(let t=s,h=s+a;t<h;t++)Za(l,e,i,t,r,o,n)}(e,i,s,ha(t,h),ca(c,l),a,r,o);else{const l=da(t);ir(l,n,s,r,o)&&rr(l,e,i,s,a,r,o);const c=ua(t,h);ir(c,n,s,r,o)&&rr(c,e,i,s,a,r,o)}}const or=["x","y","z"];function nr(t,e,i,s,a,r){Ba.setBuffer(t._roots[e]);const o=lr(0,t,i,s,a,r);return Ba.clearBuffer(),o}function lr(t,e,i,s,a,r){const{float32Array:o,uint16Array:n,uint32Array:l}=Ba;let h=2*t;if(la(h,n))return function(t,e,i,s,a,r,o){const{geometry:n,_indirectBuffer:l}=t;let h=1/0,c=null;for(let t=s,l=s+a;t<l;t++){let s;s=Za(n,e,i,t,null,r,o),s&&s.distance<h&&(c=s,h=s.distance)}return c}(e,i,s,ha(t,l),ca(h,n),a,r);{const n=pa(t,l),h=or[n],c=s.direction[h]>=0;let d,u;c?(d=da(t),u=ua(t,l)):(d=ua(t,l),u=da(t));const p=ir(d,o,s,a,r)?lr(d,e,i,s,a,r):null;if(p){const t=p.point[h];if(c?t<=o[u+n]:t>=o[u+n+3])return p}const m=ir(u,o,s,a,r)?lr(u,e,i,s,a,r):null;return p&&m?p.distance<=m.distance?p:m:p||m||null}}const hr=new e.Box3,cr=new za,dr=new za,ur=new e.Matrix4,pr=new Ra,mr=new Ra;function fr(t,e,i,s){Ba.setBuffer(t._roots[e]);const a=br(0,t,i,s);return Ba.clearBuffer(),a}function br(t,e,i,s,a=null){const{float32Array:r,uint16Array:o,uint32Array:n}=Ba;let l=2*t;if(null===a&&(i.boundingBox||i.computeBoundingBox(),pr.set(i.boundingBox.min,i.boundingBox.max,s),a=pr),!la(l,o)){const o=t+8,l=n[t+6];return Qs(o,r,hr),a.intersectsBox(hr)&&br(o,e,i,s,a)?!0:(Qs(l,r,hr),!(!a.intersectsBox(hr)||!br(l,e,i,s,a)))}{const a=e.geometry,h=a.index,c=a.attributes.position,d=i.index,u=i.attributes.position,p=ha(t,n),m=ca(l,o);if(ur.copy(s).invert(),i.boundsTree)return Qs(t,r,mr),mr.matrix.copy(ur),mr.needsUpdate=!0,i.boundsTree.shapecast({intersectsBounds:t=>mr.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let e=3*p,i=3*(m+p);e<i;e+=3)if($a(dr,e,h,c),dr.needsUpdate=!0,t.intersectsTriangle(dr))return!0;return!1}});for(let t=3*p,e=3*(m+p);t<e;t+=3){$a(cr,t,h,c),cr.a.applyMatrix4(ur),cr.b.applyMatrix4(ur),cr.c.applyMatrix4(ur),cr.needsUpdate=!0;for(let t=0,e=d.count;t<e;t+=3)if($a(dr,t,d,u),dr.needsUpdate=!0,cr.intersectsTriangle(dr))return!0}}}const gr=new e.Matrix4,yr=new Ra,xr=new Ra,vr=new e.Vector3,wr=new e.Vector3,Mr=new e.Vector3,kr=new e.Vector3;function Ar(t,e,i,s={},a={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),yr.set(e.boundingBox.min,e.boundingBox.max,i),yr.needsUpdate=!0;const n=t.geometry,l=n.attributes.position,h=n.index,c=e.attributes.position,d=e.index,u=Fa.getPrimitive(),p=Fa.getPrimitive();let m=vr,f=wr,b=null,g=null;a&&(b=Mr,g=kr);let y=1/0,x=null,v=null;return gr.copy(i).invert(),xr.matrix.copy(gr),t.shapecast({boundsTraverseOrder:t=>yr.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o&&(e&&(xr.min.copy(t.min),xr.max.copy(t.max),xr.needsUpdate=!0),!0),intersectsRange:(t,s)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:t=>xr.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o,intersectsRange:(e,a)=>{for(let o=e,n=e+a;o<n;o++){$a(p,3*o,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){$a(u,3*e,h,l),u.needsUpdate=!0;const t=u.distanceToTriangle(p,m,b);if(t<y&&(f.copy(m),g&&g.copy(b),y=t,x=e,v=o),t<r)return!0}}}});for(let a=0,o=Hs(e);a<o;a++){$a(p,3*a,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){$a(u,3*e,h,l),u.needsUpdate=!0;const t=u.distanceToTriangle(p,m,b);if(t<y&&(f.copy(m),g&&g.copy(b),y=t,x=e,v=a),t<r)return!0}}}}),Fa.releasePrimitive(u),Fa.releasePrimitive(p),y===1/0?null:(s.point?s.point.copy(f):s.point=f.clone(),s.distance=y,s.faceIndex=x,a&&(a.point?a.point.copy(g):a.point=g.clone(),a.point.applyMatrix4(gr),f.applyMatrix4(gr),a.distance=f.sub(a.point).length(),a.faceIndex=v),s)}function Sr(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,a=i.attributes.position;let r,o,n,l,h=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),n=new Uint16Array(r),l=new Float32Array(r),d(0,h),h+=r.byteLength;function d(i,r,h=!1){const c=2*i;if(n[c+15]===Us){const e=o[i+6];let r=1/0,h=1/0,d=1/0,u=-1/0,p=-1/0,m=-1/0;for(let i=e,o=e+n[c+14];i<o;i++){const e=3*t.resolveTriangleIndex(i);for(let t=0;t<3;t++){let i=e+t;i=s?s[i]:i;const o=a.getX(i),n=a.getY(i),l=a.getZ(i);o<r&&(r=o),o>u&&(u=o),n<h&&(h=n),n>p&&(p=n),l<d&&(d=l),l>m&&(m=l)}}return(l[i+0]!==r||l[i+1]!==h||l[i+2]!==d||l[i+3]!==u||l[i+4]!==p||l[i+5]!==m)&&(l[i+0]=r,l[i+1]=h,l[i+2]=d,l[i+3]=u,l[i+4]=p,l[i+5]=m,!0)}{const t=i+8,s=o[i+6],a=t+r,n=s+r;let c=h,u=!1,p=!1;e?c||(u=e.has(a),p=e.has(n),c=!u&&!p):(u=!0,p=!0);const m=c||p;let f=!1;(c||u)&&(f=d(t,r,c));let b=!1;m&&(b=d(s,r,c));const g=f||b;if(g)for(let e=0;e<3;e++){const a=t+e,r=s+e,o=l[a],n=l[a+3],h=l[r],c=l[r+3];l[i+e]=o<h?o:h,l[i+e+3]=n>c?n:c}return g}}}function Tr(t,e,i,s,a,r,o){Ba.setBuffer(t._roots[e]),Pr(0,t,i,s,a,r,o),Ba.clearBuffer()}function Pr(t,e,i,s,a,r,o){const{float32Array:n,uint16Array:l,uint32Array:h}=Ba,c=2*t;if(la(c,l))!function(t,e,i,s,a,r,o,n){const{geometry:l,_indirectBuffer:h}=t;for(let t=s,c=s+a;t<c;t++)Za(l,e,i,h?h[t]:t,r,o,n)}(e,i,s,ha(t,h),ca(c,l),a,r,o);else{const l=da(t);ir(l,n,s,r,o)&&Pr(l,e,i,s,a,r,o);const c=ua(t,h);ir(c,n,s,r,o)&&Pr(c,e,i,s,a,r,o)}}const zr=["x","y","z"];function Rr(t,e,i,s,a,r){Ba.setBuffer(t._roots[e]);const o=Er(0,t,i,s,a,r);return Ba.clearBuffer(),o}function Er(t,e,i,s,a,r){const{float32Array:o,uint16Array:n,uint32Array:l}=Ba;let h=2*t;if(la(h,n))return function(t,e,i,s,a,r,o){const{geometry:n,_indirectBuffer:l}=t;let h=1/0,c=null;for(let t=s,d=s+a;t<d;t++){let s;s=Za(n,e,i,l?l[t]:t,null,r,o),s&&s.distance<h&&(c=s,h=s.distance)}return c}(e,i,s,ha(t,l),ca(h,n),a,r);{const n=pa(t,l),h=zr[n],c=s.direction[h]>=0;let d,u;c?(d=da(t),u=ua(t,l)):(d=ua(t,l),u=da(t));const p=ir(d,o,s,a,r)?Er(d,e,i,s,a,r):null;if(p){const t=p.point[h];if(c?t<=o[u+n]:t>=o[u+n+3])return p}const m=ir(u,o,s,a,r)?Er(u,e,i,s,a,r):null;return p&&m?p.distance<=m.distance?p:m:p||m||null}}const Fr=new e.Box3,Br=new za,Cr=new za,Lr=new e.Matrix4,_r=new Ra,Dr=new Ra;function Vr(t,e,i,s){Ba.setBuffer(t._roots[e]);const a=jr(0,t,i,s);return Ba.clearBuffer(),a}function jr(t,e,i,s,a=null){const{float32Array:r,uint16Array:o,uint32Array:n}=Ba;let l=2*t;if(null===a&&(i.boundingBox||i.computeBoundingBox(),_r.set(i.boundingBox.min,i.boundingBox.max,s),a=_r),!la(l,o)){const o=t+8,l=n[t+6];return Qs(o,r,Fr),a.intersectsBox(Fr)&&jr(o,e,i,s,a)?!0:(Qs(l,r,Fr),!(!a.intersectsBox(Fr)||!jr(l,e,i,s,a)))}{const a=e.geometry,h=a.index,c=a.attributes.position,d=i.index,u=i.attributes.position,p=ha(t,n),m=ca(l,o);if(Lr.copy(s).invert(),i.boundsTree)return Qs(t,r,Dr),Dr.matrix.copy(Lr),Dr.needsUpdate=!0,i.boundsTree.shapecast({intersectsBounds:t=>Dr.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let i=p,s=m+p;i<s;i++)if($a(Cr,3*e.resolveTriangleIndex(i),h,c),Cr.needsUpdate=!0,t.intersectsTriangle(Cr))return!0;return!1}});for(let t=p,i=m+p;t<i;t++){const i=e.resolveTriangleIndex(t);$a(Br,3*i,h,c),Br.a.applyMatrix4(Lr),Br.b.applyMatrix4(Lr),Br.c.applyMatrix4(Lr),Br.needsUpdate=!0;for(let t=0,e=d.count;t<e;t+=3)if($a(Cr,t,d,u),Cr.needsUpdate=!0,Br.intersectsTriangle(Cr))return!0}}}const qr=new e.Matrix4,Or=new Ra,Ir=new Ra,Gr=new e.Vector3,Ur=new e.Vector3,Nr=new e.Vector3,Wr=new e.Vector3;function Hr(t,e,i,s={},a={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Or.set(e.boundingBox.min,e.boundingBox.max,i),Or.needsUpdate=!0;const n=t.geometry,l=n.attributes.position,h=n.index,c=e.attributes.position,d=e.index,u=Fa.getPrimitive(),p=Fa.getPrimitive();let m=Gr,f=Ur,b=null,g=null;a&&(b=Nr,g=Wr);let y=1/0,x=null,v=null;return qr.copy(i).invert(),Ir.matrix.copy(qr),t.shapecast({boundsTraverseOrder:t=>Or.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o&&(e&&(Ir.min.copy(t.min),Ir.max.copy(t.max),Ir.needsUpdate=!0),!0),intersectsRange:(s,a)=>{if(e.boundsTree){const n=e.boundsTree;return n.shapecast({boundsTraverseOrder:t=>Ir.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o,intersectsRange:(e,o)=>{for(let w=e,M=e+o;w<M;w++){const e=n.resolveTriangleIndex(w);$a(p,3*e,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+a;e<i;e++){const i=t.resolveTriangleIndex(e);$a(u,3*i,h,l),u.needsUpdate=!0;const s=u.distanceToTriangle(p,m,b);if(s<y&&(f.copy(m),g&&g.copy(b),y=s,x=e,v=w),s<r)return!0}}}})}for(let o=0,n=Hs(e);o<n;o++){$a(p,3*o,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+a;e<i;e++){const i=t.resolveTriangleIndex(e);$a(u,3*i,h,l),u.needsUpdate=!0;const s=u.distanceToTriangle(p,m,b);if(s<y&&(f.copy(m),g&&g.copy(b),y=s,x=e,v=o),s<r)return!0}}}}),Fa.releasePrimitive(u),Fa.releasePrimitive(p),y===1/0?null:(s.point?s.point.copy(f):s.point=f.clone(),s.distance=y,s.faceIndex=x,a&&(a.point?a.point.copy(g):a.point=g.clone(),a.point.applyMatrix4(qr),f.applyMatrix4(qr),a.distance=f.sub(a.point).length(),a.faceIndex=v),s)}const Kr=new Ba.constructor,Xr=new Ba.constructor,Jr=new Ea((()=>new e.Box3)),Qr=new e.Box3,Yr=new e.Box3,Zr=new e.Box3,$r=new e.Box3;let to=!1;function eo(t,e,i,s,a,r=0,o=0,n=0,l=0,h=null,c=!1){let d,u;c?(d=Xr,u=Kr):(d=Kr,u=Xr);const p=d.float32Array,m=d.uint32Array,f=d.uint16Array,b=u.float32Array,g=u.uint32Array,y=u.uint16Array,x=2*e,v=la(2*t,f),w=la(x,y);let M=!1;if(w&&v)M=c?a(ha(e,g),ca(2*e,y),ha(t,m),ca(2*t,f),l,o+e,n,r+t):a(ha(t,m),ca(2*t,f),ha(e,g),ca(2*e,y),n,r+t,l,o+e);else if(w){const h=Jr.getPrimitive();Qs(e,b,h),h.applyMatrix4(i);const d=da(t),u=ua(t,m);Qs(d,p,Qr),Qs(u,p,Yr);const f=h.intersectsBox(Qr),g=h.intersectsBox(Yr);M=f&&eo(e,d,s,i,a,o,r,l,n+1,h,!c)||g&&eo(e,u,s,i,a,o,r,l,n+1,h,!c),Jr.releasePrimitive(h)}else{const d=da(e),u=ua(e,g);Qs(d,b,Zr),Qs(u,b,$r);const f=h.intersectsBox(Zr),y=h.intersectsBox($r);if(f&&y)M=eo(t,d,i,s,a,r,o,n,l+1,h,c)||eo(t,u,i,s,a,r,o,n,l+1,h,c);else if(f)if(v)M=eo(t,d,i,s,a,r,o,n,l+1,h,c);else{const e=Jr.getPrimitive();e.copy(Zr).applyMatrix4(i);const h=da(t),u=ua(t,m);Qs(h,p,Qr),Qs(u,p,Yr);const f=e.intersectsBox(Qr),b=e.intersectsBox(Yr);M=f&&eo(d,h,s,i,a,o,r,l,n+1,e,!c)||b&&eo(d,u,s,i,a,o,r,l,n+1,e,!c),Jr.releasePrimitive(e)}else if(y)if(v)M=eo(t,u,i,s,a,r,o,n,l+1,h,c);else{const e=Jr.getPrimitive();e.copy($r).applyMatrix4(i);const h=da(t),d=ua(t,m);Qs(h,p,Qr),Qs(d,p,Yr);const f=e.intersectsBox(Qr),b=e.intersectsBox(Yr);M=f&&eo(u,h,s,i,a,o,r,l,n+1,e,!c)||b&&eo(u,d,s,i,a,o,r,l,n+1,e,!c),Jr.releasePrimitive(e)}}return M}const io=new Ra,so=new e.Box3,ao={strategy:0,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class ro{static serialize(t,e={}){e={cloneBuffers:!0,...e};const i=t.geometry,s=t._roots,a=t._indirectBuffer,r=i.getIndex();let o;return o=e.cloneBuffers?{roots:s.map((t=>t.slice())),index:r?r.array.slice():null,indirectBuffer:a?a.slice():null}:{roots:s,index:r?r.array:null,indirectBuffer:a},o}static deserialize(t,i,s={}){s={setIndex:!0,indirect:Boolean(t.indirectBuffer),...s};const{index:a,roots:r,indirectBuffer:o}=t,n=new ro(i,{...s,[Ws]:!0});if(n._roots=r,n._indirectBuffer=o||null,s.setIndex){const s=i.getIndex();if(null===s){const s=new e.BufferAttribute(t.index,1,!1);i.setIndex(s)}else s.array!==a&&(s.array.set(a),s.needsUpdate=!0)}return n}get indirect(){return!!this._indirectBuffer}constructor(t,i={}){if(!t.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((i=Object.assign({...ao,[Ws]:!1},i)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,i[Ws]||(Ma(this,i),!t.boundingBox&&i.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new e.Box3))),this.resolveTriangleIndex=i.indirect?t=>this._indirectBuffer[t]:t=>t}refit(t=null){return(this.indirect?Sr:er)(this,t)}traverse(t,e=0){const i=this._roots[e],s=new Uint32Array(i),a=new Uint16Array(i);!function e(r,o=0){const n=2*r,l=a[n+15]===Us;if(l){const e=s[r+6],h=a[n+14];t(o,l,new Float32Array(i,4*r,6),e,h)}else{const a=r+8,n=s[r+6],h=s[r+7];t(o,l,new Float32Array(i,4*r,6),h)||(e(a,o+1),e(n,o+1))}}(0)}raycast(t,i=e.FrontSide,s=0,a=1/0){const r=this._roots,o=this.geometry,n=[],l=i.isMaterial,h=Array.isArray(i),c=o.groups,d=l?i.side:i,u=this.indirect?Tr:ar;for(let e=0,o=r.length;e<o;e++){const r=h?i[c[e].materialIndex].side:d,o=n.length;if(u(this,e,r,t,n,s,a),h){const t=c[e].materialIndex;for(let e=o,i=n.length;e<i;e++)n[e].face.materialIndex=t}}return n}raycastFirst(t,i=e.FrontSide,s=0,a=1/0){const r=this._roots,o=this.geometry,n=i.isMaterial,l=Array.isArray(i);let h=null;const c=o.groups,d=n?i.side:i,u=this.indirect?Rr:nr;for(let e=0,o=r.length;e<o;e++){const r=u(this,e,l?i[c[e].materialIndex].side:d,t,s,a);null!=r&&(null==h||r.distance<h.distance)&&(h=r,l&&(r.face.materialIndex=c[e].materialIndex))}return h}intersectsGeometry(t,e){let i=!1;const s=this._roots,a=this.indirect?Vr:fr;for(let r=0,o=s.length;r<o&&(i=a(this,r,t,e),!i);r++);return i}shapecast(t){const e=Fa.getPrimitive(),i=this.indirect?sr:tr;let{boundsTraverseOrder:s,intersectsBounds:a,intersectsRange:r,intersectsTriangle:o}=t;if(r&&o){const t=r;r=(s,a,r,n,l)=>!!t(s,a,r,n,l)||i(s,a,this,o,r,n,e)}else r||(r=o?(t,s,a,r)=>i(t,s,this,o,a,r,e):(t,e,i)=>i);let n=!1,l=0;const h=this._roots;for(let t=0,e=h.length;t<e;t++){const e=h[t];if(n=Va(this,t,a,r,s,l),n)break;l+=e.byteLength}return Fa.releasePrimitive(e),n}bvhcast(t,i,s){let{intersectsRanges:a,intersectsTriangles:r}=s;const o=Fa.getPrimitive(),n=this.geometry.index,l=this.geometry.attributes.position,h=this.indirect?t=>{const e=this.resolveTriangleIndex(t);$a(o,3*e,n,l)}:t=>{$a(o,3*t,n,l)},c=Fa.getPrimitive(),d=t.geometry.index,u=t.geometry.attributes.position,p=t.indirect?e=>{const i=t.resolveTriangleIndex(e);$a(c,3*i,d,u)}:t=>{$a(c,3*t,d,u)};if(r){const t=(t,e,s,a,n,l,d,u)=>{for(let m=s,f=s+a;m<f;m++){p(m),c.a.applyMatrix4(i),c.b.applyMatrix4(i),c.c.applyMatrix4(i),c.needsUpdate=!0;for(let i=t,s=t+e;i<s;i++)if(h(i),o.needsUpdate=!0,r(o,c,i,m,n,l,d,u))return!0}return!1};if(a){const e=a;a=function(i,s,a,r,o,n,l,h){return!!e(i,s,a,r,o,n,l,h)||t(i,s,a,r,o,n,l,h)}}else a=t}return function(t,i,s,a){if(to)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");to=!0;const r=t._roots,o=i._roots;let n,l=0,h=0;const c=(new e.Matrix4).copy(s).invert();for(let t=0,e=r.length;t<e;t++){Kr.setBuffer(r[t]),h=0;const e=Jr.getPrimitive();Qs(0,Kr.float32Array,e),e.applyMatrix4(c);for(let t=0,i=o.length;t<i&&(Xr.setBuffer(o[t]),n=eo(0,0,s,c,a,l,h,0,0,e),Xr.clearBuffer(),h+=o[t].length,!n);t++);if(Jr.releasePrimitive(e),Kr.clearBuffer(),l+=r[t].length,n)break}return to=!1,n}(this,t,i,a)}intersectsBox(t,e){return io.set(t.min,t.max,e),io.needsUpdate=!0,this.shapecast({intersectsBounds:t=>io.intersectsBox(t),intersectsTriangle:t=>io.intersectsTriangle(t)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,i={},s={},a=0,r=1/0){return(this.indirect?Hr:Ar)(this,t,e,i,s,a,r)}closestPointToPoint(t,e={},i=0,s=1/0){return function(t,e,i={},s=0,a=1/0){const r=s*s,o=a*a;let n=1/0,l=null;if(t.shapecast({boundsTraverseOrder:t=>(qa.copy(e).clamp(t.min,t.max),qa.distanceToSquared(e)),intersectsBounds:(t,e,i)=>i<n&&i<o,intersectsTriangle:(t,i)=>{t.closestPointToPoint(e,qa);const s=e.distanceToSquared(qa);return s<n&&(Oa.copy(qa),n=s,l=i),s<r}}),n===1/0)return null;const h=Math.sqrt(n);return i.point?i.point.copy(Oa):i.point=Oa.clone(),i.distance=h,i.faceIndex=l,i}(this,t,e,i,s)}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach((e=>{Qs(0,new Float32Array(e),so),t.union(so)})),t}}function oo(t,e,i){return null===t?null:(t.point.applyMatrix4(e.matrixWorld),t.distance=t.point.distanceTo(i.ray.origin),t.object=e,t)}const no=parseInt(e.REVISION)>=166,lo=new e.Ray,ho=new e.Vector3,co=new e.Matrix4,uo=e.Mesh.prototype.raycast,po=e.BatchedMesh.prototype.raycast,mo=new e.Vector3,fo=new e.Mesh,bo=[];function go(t,i){if(this.boundsTrees){const s=this.boundsTrees,a=this._drawInfo||this._instanceInfo,r=this._drawRanges||this._geometryInfo,o=this.matrixWorld;fo.material=this.material,fo.geometry=this.geometry;const n=fo.geometry.boundsTree,l=fo.geometry.drawRange;null===fo.geometry.boundingSphere&&(fo.geometry.boundingSphere=new e.Sphere);for(let e=0,n=a.length;e<n;e++){if(!this.getVisibleAt(e))continue;const n=a[e].geometryIndex;if(fo.geometry.boundsTree=s[n],this.getMatrixAt(e,fo.matrixWorld).premultiply(o),!fo.geometry.boundsTree){this.getBoundingBoxAt(n,fo.geometry.boundingBox),this.getBoundingSphereAt(n,fo.geometry.boundingSphere);const t=r[n];fo.geometry.setDrawRange(t.start,t.count)}fo.raycast(t,bo);for(let t=0,s=bo.length;t<s;t++){const s=bo[t];s.object=this,s.batchId=e,i.push(s)}bo.length=0}fo.geometry.boundsTree=n,fo.geometry.drawRange=l,fo.material=null,fo.geometry=null}else po.call(this,t,i)}function yo(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;co.copy(this.matrixWorld).invert(),lo.copy(t.ray).applyMatrix4(co),mo.setFromMatrixScale(this.matrixWorld),ho.copy(lo.direction).multiply(mo);const i=ho.length(),s=t.near/i,a=t.far/i,r=this.geometry.boundsTree;if(!0===t.firstHitOnly){const i=oo(r.raycastFirst(lo,this.material,s,a),this,t);i&&e.push(i)}else{const i=r.raycast(lo,this.material,s,a);for(let s=0,a=i.length;s<a;s++){const a=oo(i[s],this,t);a&&e.push(a)}}}else uo.call(this,t,e)}e.Mesh.prototype.raycast=function(t,e){this.isBatchedMesh?go.call(this,t,e):yo.call(this,t,e)},e.BatchedMesh.prototype.computeBoundsTree=function(t=-1,e={}){if(!no)throw new Error("BatchedMesh: Three r166+ is required to compute bounds trees.");e.indirect&&console.warn('"Indirect" is set to false because it is not supported for BatchedMesh.'),e={...e,indirect:!1,range:null};const i=this._drawRanges||this._geometryInfo,s=this._geometryCount;this.boundsTrees||(this.boundsTrees=new Array(s).fill(null));const a=this.boundsTrees;for(;a.length<s;)a.push(null);if(t<0){for(let t=0;t<s;t++)e.range=i[t],a[t]=new ro(this.geometry,e);return a}return t<i.length&&(e.range=i[t],a[t]=new ro(this.geometry,e)),a[t]||null};const xo={PHY:"0.5.0",PHYSX:"5.06.10",HAVOK:"1.2.1",JOLT:"0.39.0",RAPIER:"0.20.0",OIMO:"1.2.4",AMMO:"3.2.6"};class vo{constructor(t={}){this.noBuffer=!0,this.stats=new Ce,this.geo=new K,this.mat=new et,this.math=A,this.pool=$t,this.version=xo.PHY,this.Version=xo,this.engine="",this.jointVisible=!1,this.utils=new Mo(this),this.collision=new Fe(this),this.viewSize=null,this.debug=!1,this.delta=0,this.debuger=null,this.mouseActive=!1;const i=this;let s=null,a=!1,r=!1,o=!1,n=null,l=null,h=null,c=!1,d=!1,u=!1,p=!0,m=!1,b=null,g=!1,y={t1:0,t2:0,t3:0,t4:0},x=null,v=null,w=null,M=!1,k=!0,S=null,T=null,P=0,z=0,R="",E=null,F=null,B=null;const C=new st,_=new it(60),D={start:0,end:0,startTime:""};let V=()=>0,j=()=>{},q=()=>{},O=()=>{},I=[],G=[],U=[],N=null;const W={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};let H=null,X={};this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},this.reflow={ray:[],stat:{fps:0,delta:0,ms:0},point:{},contact:{},velocity:{}};const J={};this.scene=null,this.scenePlus=null,this.ws=1,this.uws=1,this.garbage=[],this.tmpMesh=[],this.instanceMesh={},this.tmpTex=[],this.disposeTmp=()=>{let t,e,i;for(t in this.tmpMesh){if(i=this.tmpMesh[t],i.children)for(e in i.children)this.disposeMesh(i.children[e]);this.disposeMesh(i),i.parent&&i.parent.remove(i)}for(t in this.tmpMesh=[],this.tmpTex)this.tmpTex[t].dispose();this.tmpTex=[]},this.disposeMesh=t=>{t.geometry&&t.geometry.dispose(),t.dispose&&t.dispose()},this.setStep=t=>{q=t},this.debugMode=t=>{this.setDebugMode(t)},this.setDebugMode=t=>{this.debug=t},this.useRealLight=t=>{this.mat.useRealLight(t)},this.getSetting=()=>W,this.setGravity=t=>{t&&(W.gravity=t),this.post({m:"setGravity",o:{gravity:W.gravity}})},this.set=(t={})=>{W.fixe=void 0===t.fixe||t.fixe,W.full=void 0!==t.full&&t.full,W.gravity=t.gravity?t.gravity:[0,-9.81,0],W.substep=t.substep?t.substep:1,W.fps=t.fps?t.fps:60,this.ws=void 0!==t.worldScale?t.worldScale:1,this.uws=1/this.ws,t.key&&O(),J.body.setFull(W.full),this.initArray(W.full),z=0,u=c,p=!u,this.jointVisible=t.jointVisible||!1,p&&_.setFramerate(W.fps);const e={...t,...W,ArPos:X,isTimeout:u,outsideStep:p};this.post({m:"set",o:e})},this.activeMouse=(t,e)=>{x||(x=new Ve(t,e,this)),this.mouseActive=!0},this.mouseMode=(t,e)=>{x&&x.setMode(t,e)},this.getTime=()=>it.now(),this.readTime=t=>it.format_time(t),this.startTime=()=>D.startTime,this.getTimeTest=()=>y,this.setMaxFps=t=>{},this.getMouse=()=>x?x.mouse:null,this.setMaxAnisotropy=t=>{$t.maxAnisotropy=t},this.setAddControl=t=>{O=t},this.setPrevUpdate=t=>{},this.setPostUpdate=t=>{q=null!==t?t:()=>{}},this.setAzimut=t=>{V=t},this.setRenderer=t=>{F=t,$t.renderer=F},this.setKey=(t,e)=>C.setKey(t,e),this.getKey=()=>C.key,this.getKey2=()=>C.key2,this.getAzimut=()=>V(),this.setContent=t=>{g||(B=t,B.add(this.scene),B.add(this.scenePlus),g=!0)},this.message=t=>{let e=t.data;e.Ar&&(H=e.Ar),e.reflow&&(this.reflow=e.reflow,this.reflow.stat.delta&&(this.stats.up(this.reflow.stat),z+=this.reflow.stat.delta)),i[e.m](e.o)},this.worldScaler=t=>{const e=this.ws;if(t.pos&&(t.pos=A.worldscale(t.pos,e)),t.localPos&&(t.localPos=A.worldscale(t.localPos,e)),t.massCenter&&(t.massCenter=A.worldscale(t.massCenter,e)),t.pos1&&(t.pos1=A.worldscale(t.pos1,e)),t.pos2&&(t.pos2=A.worldscale(t.pos2,e)),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(t.shapes[s].size=A.worldscale(i.size,e)),i.pos&&(t.shapes[s].pos=A.worldscale(i.pos,e)),i.v&&(t.shapes[s].v=A.worldscale(i.v,e))}else t.size&&(t.size=A.worldscale(t.size,e)),t.v&&(t.v=A.worldscale(t.v,e))},this.post=(t,e=null,i=!1)=>{1!==this.ws&&("add"!==t.m&&"change"!==t.m||this.worldScaler(t.o)),c?(t.o&&("solver"===t.o.type&&(i=!0),void 0!==t.o.solver&&(i=!0)),i?h.postMessage(t,e):"add"===t.m?this.flow.add.push(t.o):"remove"===t.m?this.flow.remove.push(t.o):h.postMessage(t,e)):v({data:t})},this.addDebuger=()=>{if(null===this.debuger)return this.debuger=new zi(this),this.scenePlus.add(this.debuger),this.debuger},this.removeDebuger=()=>{null!==this.debuger&&(this.debuger.dispose(),this.debuger=null)},this.vehicle=t=>{let e;switch(t.type){case"raycar":e=new Qi(t,this);break;case"kart":e=new Ps(t,this);break;case"helico":e=new Ts(t,this)}return e},this.autoRagdoll=t=>{const e=new Pi(t,this);return this.scene.add(e.model),e},this.byName=t=>this.utils.byName(t),this.getScene=()=>this.scene,this.makeView=()=>{},this.resize=t=>{this.viewSize=t,s&&s.resize(this.viewSize.h)},this.init=(t={})=>{"undefined"!=typeof document&&document.currentScript&&document.currentScript.src,D.start=it.now();const s=t.compact||!1;let o=document.location.href.replace(/\/[^/]*$/,"/"),n=o.split("/");o=n[0]+"//"+n[2]+"/","https://lo-th.github.io/"===o&&(o="https://lo-th.github.io/phy/");let u=t.path||"";u+=s?"compact/":"build/";let p=t.type||"PHYSX",m=p.toLowerCase(),b=m.charAt(0).toUpperCase()+m.slice(1);if(this.engine=p.toUpperCase(),this.initItems(),$t.materialRoot=this.mat.set.bind(this.mat),t.callback&&(l=t.callback,delete t.callback),c=t.worker||!1,this.scene=new e.Group,this.scene.name="phy_scene",this.scenePlus=new e.Group,this.scenePlus.name="phy_scenePlus",t.scene&&(this.setContent(t.scene),delete t.scene),t.renderer&&(this.setRenderer(t.renderer),delete t.renderer),R=t.envmap||"",r=!!t.useModule&&this.supportModuleWorker(),a=t.useLocal||!1,t.useDecal,$t.useLocal=a,s)a?r?$t.load(new URL("../"+u+b+".module.hex","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href),(function(){i.onCompactDone(t)})):$t.load(new URL("../"+u+b+".hex","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href),(function(){i.onCompactDone(t)})):r?$t.load(o+u+b+".module.hex",(function(){i.onCompactDone(t)})):$t.load(o+u+b+".hex",(function(){i.onCompactDone(t)}));else if(c){let e,i=r?b+".module.js":b+".min.js";if(e=a?new URL(`./${i}`,"undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href):o+u+i,h=new Worker(e,{type:r?"module":"classic"}),h.postMessage=h.webkitPostMessage||h.postMessage,h.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);h.postMessage({m:"test",ab:e},[e]),d=!e.byteLength,t.isBuffer=d}this.initPhysics(t)}else t.devMode?this.preLoad(b,t,o):this.preLoadMin(b,t,o,a)},this.supportModuleWorker=()=>{let t=!1;const e={get type(){t=!0}};try{new Worker("data:,",e).terminate()}finally{return t}},this.onCompactDone=t=>{let e=this.engine.toLowerCase(),i=e.charAt(0).toUpperCase()+e.slice(1),s=r?$t.get(i+".module","H"):$t.get(i,"H");if(c){let e;try{e=new Blob([s],{type:"application/javascript"})}catch(t){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,e=new BlobBuilder,e.append(s),e=e.getBlob()}if(h=r?new Worker(URL.createObjectURL(e),{type:"module"}):new Worker(URL.createObjectURL(e)),h.postMessage=h.webkitPostMessage||h.postMessage,h.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);h.postMessage({m:"test",ab:e},[e]),d=!e.byteLength,t.isBuffer=d}this.initPhysics(t)}else{let i=e.toUpperCase(),a=document.createElement("script");a.language="javascript",a.type="text/javascript",a.charset="utf-8",a.async=!0,a.innerHTML=s,document.getElementsByTagName("head")[0].appendChild(a),v=window[i].engine.message,t.message=this.message,this.initPhysics(t)}},this.loadWasmDirect=(t,e,i,s)=>{let a=document.createElement("script");a.src=s+t,document.body.appendChild(a),a.onload=()=>{this.preLoad(i,e,s)}},this.preLoadMin=(t,e,i,s=!1)=>{let a=i+"build/"+t+".min.js";s&&(a=new URL("./"+t+".min.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:f&&"SCRIPT"===f.tagName.toUpperCase()&&f.src||new URL("Phy.min.js",document.baseURI).href));let r=t.toUpperCase();var o=new XMLHttpRequest;o.open("GET",a),o.overrideMimeType("text/javascript"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status){let t=document.createElement("script");t.language="javascript",t.type="text/javascript",t.charset="utf-8",t.async=!0,t.innerHTML=o.responseText,console.log(o.responseText),document.getElementsByTagName("head")[0].appendChild(t),v=window[r].engine.message,e.message=this.message,this.initPhysics(e)}else console.error("Couldn't load ["+t+"] ["+o.status+"]")}.bind(this),o.send(null)},this.preLoad=async(t,e,i)=>{let s=i+"build/"+t+".module.js";e.devMode&&(s=i+"src/"+t+".js");let a=await import(s);v=a.engine.message,e.message=this.message,this.initPhysics(e)},this.initPhysics=t=>{""===R?(this.post({m:"init",o:t}),m=!0):this.preloadEnvmap(t)},this.addEnvmap=t=>(E||(E=new Bi({renderer:F,scene:B,...t})),E),this.preloadEnvmap=t=>{E=new Bi({url:R,renderer:F,scene:B,usePmrem:t.usePmrem,useBackground:void 0===t.useBackground||t.useBackground,envBlur:void 0!==t.envBlur?t.envBlur:0,callback:()=>{R="",this.initPhysics(t)}})},this.getPause=()=>M,this.pause=t=>{t!==M&&(M=t,M?this.pausetimout():this.playtimout(),this.post({m:"pause",o:{value:M}}))},this.flowReset=()=>{this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}},this.reset=t=>{if(k)return k=!1,void t();I=[],n=null,o=!1,w&&w.resetAll(),x&&x.unSelect(),s&&(s.dispose(),s=null),j=t,q=function(){},this.collision.reset(),this.clearText(),this.clearSoftSolver(),this.cleartimout(),this.flowReset(),this.clearInstance(),this.resetItems(),this.geo.dispose(),this.mat.dispose(),this.disposeTmp(),this.stats.reset(),this.garbage=[],N=null,null!==b&&(b=null),null!==this.debuger&&this.removeDebuger(),this.scenePlus.children=[],this.scene.children=[],this.post({m:"reset",o:{}})},this.clearGarbage=()=>{this.remove(this.garbage),this.clearInstance(),this.garbage=[]},this.clear=t=>{this.reset(t)},this.resetCallback=()=>{j()},this.dispose=()=>{this.reset((()=>{h&&(h.terminate(),h=null),g&&(i.scene.parent.remove(i.scene),i.scenePlus.parent.remove(i.scenePlus),g=!1)}))},this.ready=()=>{D.end=it.now(),D.startTime=it.format_time(D.end-D.start),console.log("%c"+this.engine+" %c"+xo[this.engine]+"%c | "+(r?"Module ":"")+(c?"Worker":"Direct")+" "+D.startTime,"font-size:16px","font-size:12px","font-size:12px"),l&&l()},this.start=(t={})=>{this.post({m:"start",o:t})},this.morph=(t,e,i)=>{this.utils.morph(t,e,i)},this.getFps=()=>this.stats.fps.toFixed(0),this.getMs=()=>this.stats.ms.toFixed(1),this.getGpu=()=>this.stats.gpu.toFixed(1),this.getDelta2=()=>this.delta,this.getElapsedTime2=()=>z,this.setDelta=t=>{_.delta=t},this.getDelta=()=>_.delta,this.getElapsedTime=()=>_.elapsedTime,this.doStep=t=>{m&&p&&_.up(t)&&this.post({m:"step",o:t})},this.step=()=>{this.delta=this.reflow.stat.delta,this.flow.key=C.update(),this.flow.current=null!==n?n.name:"",this.stepItems(),this.collision.step(),x&&x.step(),null!==n&&n.move(),null!==this.debuger&&this.debuger.draw();let t=p?_.delta:this.delta;q(t),this.changes(this.flow.tmp),d?this.post({m:"poststep",flow:this.flow,Ar:H},[H.buffer]):this.post({m:"poststep",flow:this.flow}),this.flowReset()},this.initArray=(t=!1)=>{X={...L(this.engine,t)}},this.takeControl=(t=null)=>{this.control(t)},this.control=(t=null)=>{null!==n?null===t?(n.isPlayer&&(n.isPlayer=!1),n=null):t!==n.name&&(n=this.byName(t),n&&(n.isPlayer=!0)):null!==t&&(n=this.byName(t),n&&(n.isPlayer=!0))},this.getAllBody=t=>J.body.list,this.activeContact=()=>{o||(o=!0,this.post({m:"activeContact",o:{}}))},this.addCollision=t=>{this.collision.add(t)},this.removeCollision=t=>{this.collision.remove(t)},this.initItems=()=>{J.body=new Pt(i),J.ray=new ot(i),J.joint=new Et(i),J.solid=new wo(i),J.contact=new Ft(i),J.terrain=new Te(i),J.character=new xe(i),"PHYSX"!==this.engine&&"AMMO"!==this.engine||(J.vehicle=new Lt(i)),"PHYSX"===this.engine&&(J.solver=new ze(i))},this.getBodyRef=()=>J.body,this.getCharacterRef=()=>J.character,this.getGeometryRef=(t,e,i)=>{J.body.geometry(t,e,i)},this.clearBody=()=>{J.body.reset()},this.resetItems=()=>{Object.values(J).forEach((t=>t.reset()))},this.stepItems=()=>{Object.values(J).forEach((t=>t.step(H,X[t.type]))),this.upInstance(),this.upButton()},this.getTransform=t=>J.body.getTransform(t),this.upInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.update()))},this.clearInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.dispose())),this.instanceMesh={}},this.adds=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.add(t[s++],e)},this.add=(t={},e=!1)=>{if(t.isObject3D)return this.addDirect(t);if(t.constructor===Array)return this.adds(t,e);if("container"===t.type)return new ji(t,this);void 0!==t.bounce&&(t.restitution=t.bounce),void 0===t.type&&(t.type="box"),void 0!==t.mode&&(t.type="joint");let i=function(t){switch(t.type){case"plane":case"box":case"sphere":case"highSphere":case"customSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return t.mass||t.density||t.kinematic?"body":"solid";case"fixe":case"generic":case"universal":case"dof":case"d6":case"hinge":case"revolute":case"prismatic":case"cylindrical":case"slider":case"spherical":case"ragdoll":case"distance":return"joint";default:return t.type}}(t);"joint"===i&&void 0===t.mode&&(t.mode=t.type,t.type="joint");let s=J[i].add(t);return this.garbage.push(s.name),s},this.addDirect=t=>(this.scenePlus.add(t),this.tmpMesh.push(t),t),this.removes=(t=[],e)=>{let i=t.length,s=0;for(;i--;)this.remove(t[s++],e)},this.remove=(t,e=!1)=>{if(t.constructor===Array)return this.removes(t,e);let i=this.byName(t);null!==i?(this.removeCollision(t),"autoRagdoll"!==i.type?(i.extraRemove&&i.extraRemove(),J[i.type].clear(i),this.post({m:"remove",o:{name:t,type:i.type}},null,e)):this.utils.remove(i)):this.instanceMesh[t]&&J.body.clearInstance(t)},this.changes=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.changeOne(t[s++],e)},this.change=(t,e=!1)=>{e?t instanceof Array?this.changes(t,!0):this.changeOne(t,!0):t instanceof Array?this.flow.tmp.push(...t):this.flow.tmp.push(t)},this.changeOne=(t={},e=!1)=>{if(t.heightData)return;let i=this.byName(t.name);if(null===i)return null;let s=i.type;switch(t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=A.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot),void 0!==t.rot&&(t.quat=A.quatFromEuler(t.rot),delete t.rot),void 0!==t.localRot&&(t.quat=A.toLocalQuatArray(t.localRot,i),delete t.localRot),s){case"terrain":i=J.terrain.set(t,i),e=!1;break;case"ray":i=J.ray.set(t,i),e=!1;break;case"character":i=J.character.set(t,i);break;case"solid":i=J.solid.set(t,i);break;case"joint":i=J.joint.set(t,i);break;case"body":i.isKinematic||(i.actif&&!i.sleep||J.body.set(t,i),t.sleep&&J.body.set(t,i))}e&&this.post({m:"change",o:t},null,e)},this.setControl=t=>{w=t,V=()=>w.getAzimuthalAngle()},this.getControl=()=>w,this.getCurrentCharacterPosition=()=>w.followGroup.position,this.getCamera=(t={})=>w.object,this.setCamera=(t={})=>{w.moveCam(t)},this.follow=(t="",e={})=>{let i=null;"string"==typeof t||t instanceof String?i=""===t?null:this.byName(t):t.isObject3D&&(i=t),null===i?w.resetFollow():w.startFollow(i,e)},this.setTimeout=(t,e=0,i=!1)=>{i?S=setTimeout(t,e):(T=t,P=e,S=setTimeout(T,P))},this.playtimout=()=>{null!==T&&(S=setTimeout(T,P))},this.pausetimout=()=>{null!==S&&clearTimeout(S)},this.cleartimout=(t,e)=>{null!==S&&(T=null,P=0,clearTimeout(S),S=null)},this.texture=(t={})=>$t.texture(t),this.getTexture=(t,e={})=>$t.getTexture(t,e),this.setExtendShader=t=>{this.mat.extendShader=t},this.addMaterial=(t,e)=>{this.mat.set(t,e)},this.directIntensity=t=>{},this.setEnvmapIntensity=t=>{},this.getMatRef=()=>this.mat,this.getMat=t=>this.mat.get(t),this.getMaterial=t=>this.mat.get(t),this.getMaterialList=()=>this.mat.getList(),this.material=(t={})=>this.mat.create(t),this.changeRenderMode=t=>this.mat.changeRenderMode(t),this.load=$t.load,this.get=$t.get,this.getGroup=$t.getGroup,this.getScript=$t.getScript,this.preload=(t,e)=>{be.add(t,e)},this.applyMorph=(t,e=null,i=!0,s=!0)=>{$t.applyMorph(t,null,!0,!0)},this.getMesh=(t,e,i)=>{if(e){let e=$t.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return $t.getMesh(t,i)},this.getGlb=(t,e,i)=>{if(e){let e=$t.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return $t.getGLB(t,i)},this.getGlbMaterial=t=>{let e=$t.getMaterials(t);return this.mat.addToMat(e),e},this.poolDispose=()=>{},this.setDracoPath=t=>$t.dracoPath=t,this.initParticle=()=>{},this.addParticle=()=>{},this.getParticle=()=>{},this.addSoftSolver=t=>{let e=new We(t,this);return U.push(e),e},this.updateSoftSolver=()=>{let t=U.length;for(;t--;)U[t].update()},this.clearSoftSolver=()=>{U.length,U=[]},this.addButton=t=>{let e=new De(t,this);return I.push(e),e},this.upButton=t=>{for(const t in I)I[t].update()},this.addText=t=>{let e=new Le(t);return t.parent?t.parent.add(e):this.scenePlus.add(e),G.push(e),e},this.clearText=()=>{let t=G.length;for(;t--;)G[t].dispose();G=[]},this.screenshot=()=>{var t=window.open("","");t.document.title="Screenshot",t.document.body.style.cssText="margin:0; padding:0; overflow:hidden;";var e=new Image;F.render(B,this.getCamera()),e.src=F.domElement.toDataURL(),t.document.body.appendChild(e)},this.getBreaker=()=>(null!==b||(b=new Ti(this)),b),this.setColorChecker=t=>{N=t},this.getColorChecker=()=>N,this.addWiggle=(t={})=>{},this.initParticleEngine=()=>{s||(s=new Is,this.scene.add(s))},this.addParticle=(t={})=>(null===s&&this.initParticleEngine(),s.add(t)),this.getParticle=t=>null===s?null:s.get(t),this.explosion=(t=[0,0,0],i=10,s=1)=>{let a=[],r=new e.Vector3;t&&(t.isVector3?r.copy(t):r.fromArray(t));let o,n,l=new e.Vector3,h=J.body.list.length;for(;h--;)o=J.body.list[h],l.copy(o.position).sub(r),n=1-l.length()/i,o.isKinematic||n<0||(l.setLength(n),l.multiplyScalar(s),a.push({name:o.name,impulse:l.toArray(),wake:!0}));this.change(a)}}set onStep(t){this.setStep(t)}}class wo extends Pt{constructor(t){super(t),this.type="solid"}step(){}}class Mo{constructor(t){this.map=new Map,this.motor=t}byName(t){return this.map.has(t)?this.map.get(t):null}add(t,e){if("contact"!==t.type&&!t.isInstance&&t.isObject3D)if(e)e.add(t);else if(t.isButton)this.motor.scene.add(t);else switch(t.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":this.motor.scenePlus.add(t);break;default:this.motor.scene.add(t)}t.isInstance&&t.refName!==t.name&&this.map.set(t.refName,t),this.map.set(t.name,t)}remove(t){t.dispose&&t.dispose(),t.parent&&t.parent.remove(t),t.isInstance&&(t.refName!==t.name&&this.map.delete(t.refName),t.instance.remove(t.idx)),this.map.delete(t.name)}noRay(t){t.isObject3D&&(t.raycast=()=>{},t.traverse((t=>{t.isObject3D&&(t.raycast=()=>{})})))}morph(t,e,i){t.morphTargetInfluences&&void 0!==t.morphTargetDictionary[e]&&(t.morphTargetInfluences[t.morphTargetDictionary[e]]=i)}toLocal(t,e,i=!1){i||t.sub(e.position);let s=e.quaternion;return t.applyQuaternion({x:-s._x,y:-s._y,z:-s._z,w:s._w}),t}quatLocal(t,i){i.isObject3D&&i.updateWorldMatrix(!0,!1);let s=(new e.Quaternion).fromArray(t),a=i.quaternion.clone().invert();return s.premultiply(a),s.normalize().toArray()}axisLocal(t,i){i.isObject3D&&i.updateWorldMatrix(!0,!1);let s=(new e.Matrix3).setFromMatrix4(i.matrixWorld);return(new e.Vector3).fromArray(t).applyMatrix3(s).toArray()}quatToAngular(t,i){i[0]*=-1,i[1]*=-1,i[2]*=-1;let s,a=i[0]*t[3]+i[3]*t[0]+i[1]*t[2]-i[2]*t[1],r=i[1]*t[3]+i[3]*t[1]+i[2]*t[0]-i[0]*t[2],o=i[2]*t[3]+i[3]*t[2]+i[0]*t[1]-i[1]*t[0],n=i[3]*t[3]-i[0]*t[0]-i[1]*t[1]-i[2]*t[2],l=2*Math.acos(n),h=Math.sqrt(1-n*n);s=h<.001?[0,0,0]:[a/h,r/h,o/h];(new e.Vector3).fromArray(s).multiplyScalar(l/1)}refAxis(t,i){let s=(new e.Vector3).fromArray(i),a=new e.Vector3(1,0,0),r=new e.Vector3(0,1,0);Math.abs(i[1])>.9999||a.copy(s).cross(r).normalize(),r.copy(a).cross(s).normalize(),t.makeBasis(a,r,s)}}const ko=new vo,Ao=vo,So=A,To=$t;t.math=So,t.phy=ko,t.phy2=Ao,t.pool=To}));
