/**
 * @license
 * Copyright 2010-2025 Phy.js Authors
 * SPDX-License-Identifier: MIT
 */
import{LineSegments as t,BufferGeometry as e,BufferAttribute as i,Float32BufferAttribute as s,LineBasicMaterial as a,BoxGeometry as r,Vector3 as n,Matrix4 as l,CylinderGeometry as h,CircleGeometry as c,PlaneGeometry as d,SphereGeometry as p,Box3 as u,Vector2 as b,CanvasTexture as g,RepeatWrapping as f,SRGBColorSpace as y,MeshPhysicalMaterial as v,Color as x,MeshStandardMaterial as w,ShadowMaterial as k,MeshToonMaterial as M,MeshBasicMaterial as S,MeshLambertMaterial as A,MeshPhongMaterial as z,DoubleSide as E,BackSide as P,FrontSide as R,SrcAlphaSaturateFactor as T,OneMinusDstColorFactor as F,DstColorFactor as D,OneMinusDstAlphaFactor as _,DstAlphaFactor as C,OneMinusSrcAlphaFactor as j,SrcAlphaFactor as L,OneMinusSrcColorFactor as q,SrcColorFactor as O,OneFactor as B,ZeroFactor as I,MaxEquation as G,MinEquation as N,ReverseSubtractEquation as V,SubtractEquation as U,AddEquation as W,MultiplyBlending as H,SubtractiveBlending as K,AdditiveBlending as J,NormalBlending as X,NoBlending as Q,Line as Y,InstancedMesh as Z,Quaternion as $,Mesh as tt,InstancedBufferAttribute as et,Object3D as it,Line3 as st,Plane as at,Triangle as rt,ShapeGeometry as ot,Euler as nt,Loader as lt,FileLoader as ht,LinearSRGBColorSpace as ct,LoadingManager as dt,EquirectangularReflectionMapping as pt,AnimationMixer as ut,NoColorSpace as mt,NearestFilter as bt,Texture as gt,TextureLoader as ft,CompressedTexture as yt,ObjectSpaceNormalMap as vt,Vector4 as xt,CustomBlending as wt,Group as kt,SkeletonHelper as Mt,AnimationClip as St,AnimationUtils as At,VectorKeyframeTrack as zt,QuaternionKeyframeTrack as Et,AdditiveAnimationBlendMode as Pt,NormalAnimationBlendMode as Rt,Raycaster as Tt,Sphere as Ft,PMREMGenerator as Dt,Scene as _t,WebGLCubeRenderTarget as Ct,HalfFloatType as jt,LinearFilter as Lt,CubeCamera as qt,IcosahedronGeometry as Ot,ShaderMaterial as Bt,NoToneMapping as It,AxesHelper as Gt,Skeleton as Nt,MathUtils as Vt,Points as Ut,InstancedBufferGeometry as Wt,InterleavedBuffer as Ht,InterleavedBufferAttribute as Kt,InstancedInterleavedBuffer as Jt,DynamicDrawUsage as Xt,DataTexture as Qt,RGBAFormat as Yt,Matrix3 as Zt}from"three";import{mergeGeometries as $t,mergeVertices as te}from"three/addons/utils/BufferGeometryUtils.js";import{SVGLoader as ee}from"three/addons/loaders/SVGLoader.js";import*as ie from"three/addons/utils/SkeletonUtils.js";import{GLTFLoader as se}from"three/addons/loaders/GLTFLoader.js";import{FBXLoader as ae}from"three/addons/loaders/FBXLoader.js";import{OBJLoader as re}from"three/addons/loaders/OBJLoader.js";import{STLLoader as oe}from"three/addons/loaders/STLLoader.js";import{HDRLoader as ne}from"three/addons/loaders/HDRLoader.js";import{EXRLoader as le}from"three/addons/loaders/EXRLoader.js";import{UltraHDRLoader as he}from"three/addons/loaders/UltraHDRLoader.js";import{KTX2Loader as ce}from"three/addons/loaders/KTX2Loader.js";const de=Math.PI,pe=de/180,ue=180/de,me=Number.EPSILON,be=.5*de,ge={luminousPowers:{"110000 lm (1000W)":11e4,"3500 lm (300W)":3500,"1700 lm (100W)":1700,"800 lm (60W)":800,"400 lm (40W)":400,"180 lm (25W)":180,"20 lm (4W)":20,Off:0},luminousIrradiances:{"0.0001 lx (Moonless Night)":1e-4,"0.002 lx (Night Airglow)":.002,"0.5 lx (Full Moon)":.5,"3.4 lx (City Twilight)":3.4,"50 lx (Living Room)":50,"100 lx (Very Overcast)":100,"350 lx (Office Room)":350,"400 lx (Sunrise/Sunset)":400,"1000 lx (Overcast)":1e3,"18000 lx (Daylight)":18e3,"50000 lx (Direct Sun)":5e4},exposure:t=>Math.pow(t,5),candelaToLumens:t=>4*t*Math.PI,lumensToCandela:t=>t/(4*Math.PI),average:t=>t?.reduce(((t,e)=>t+e),0)/t.length,atan2:(t,e)=>Math.fround(Math.atan2(t,e)),pow:(t,e)=>Math.fround(Math.pow(t,e)),sin:t=>Math.fround(Math.sin(t)),cos:t=>Math.fround(Math.cos(t)),sqrt:t=>Math.fround(Math.sqrt(t)),exp:t=>Math.fround(Math.exp(t)),todeg:ue,torad:pe,toFixed:(t,e=3)=>1*t.toFixed(e),toRound:(t,e=3)=>Math.trunc(t),clamp:(t,e=0,i=1)=>t=(t=t<e?e:t)>i?i:t,clampA:(t,e,i)=>Math.max(e,Math.min(i,t)),smoothstep:(t,e,i)=>t*(i=-2*(i=ge.clamp(i))*i*i+3*i*i)+e*(1-i),remap:(t,e,i,s,a)=>s+(t-e)*(a-s)/(i-e),lerp:(t,e,i)=>(1-i)*t+i*e,damp:(t,e,i,s)=>ge.lerp(t,e,1-Math.exp(-i*s)),nearAngle:(t,e,i=!1)=>e+Math.atan2(Math.sin(t-e),Math.cos(t-e))*(i?ue:1),unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),nearEquals:(t,e,i=1e-4)=>Math.abs(t-e)<=i,autoSize:(t=[1,1,1],e="box")=>{1===t.length&&(t[1]=t[0]);let i=t[0],s=t[1];return"sphere"===e&&(t=[i,i,i]),"cylinder"!==e&&"wheel"!==e&&"capsule"!==e||(t=[i,s,i]),"cone"!==e&&"pyramid"!==e||(t=[i,s,i]),2===t.length&&(t[2]=t[0]),t},shuffle:t=>{let e=t.map((t=>({value:t,sort:Math.random()}))).sort(((t,e)=>t.sort-e.sort)).map((({value:t})=>t));return e},randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),randIntUnic:(t,e,i)=>{for(var s=[];s.length<i;){var a=ge.randInt(t,e);-1===s.indexOf(a)&&s.push(a)}return s},fromTransform:(t,e,i,s=[0,0,0,1],a=!1)=>{let r=ge.composeMatrixArray(t,e),o=ge.composeMatrixArray(i,s);return a&&(r=ge.invertMatrixArray(r)),r=ge.multiplyMatrixArray(r,o),[r[12],r[13],r[14]]},fromTransformToQ:(t,e,i=!1)=>{let s=ge.composeMatrixArray(t,e),a=ge.decomposeFullMatrixArray(s).q;return i&&(a=ge.quatInvert(a)),a},lerpTransform:(t,e,i)=>{let s=t[0],a=t[1],r=e[0],o=e[1];return r=ge.lerpArray(s,r,i),o=ge.slerpQuatArray(a,o,i),[r,o]},composeMatrixArray:(t,e,i=[1,1,1])=>{const s=e[0],a=e[1],r=e[2],o=e[3],n=s+s,l=a+a,h=r+r,c=s*n,d=s*l,p=s*h,u=a*l,m=a*h,b=r*h,g=o*n,f=o*l,y=o*h,v=i[0],x=i[1],w=i[2];return[(1-(u+b))*v,(d+y)*v,(p-f)*v,0,(d-y)*x,(1-(c+b))*x,(m+g)*x,0,(p+f)*w,(m-g)*w,(1-(c+u))*w,0,t[0],t[1],t[2],1]},multiplyMatrixArray:(t,e)=>{const i=t,s=e,a=[],r=i[0],o=i[4],n=i[8],l=i[12],h=i[1],c=i[5],d=i[9],p=i[13],u=i[2],m=i[6],b=i[10],g=i[14],f=i[3],y=i[7],v=i[11],x=i[15],w=s[0],k=s[4],M=s[8],S=s[12],A=s[1],z=s[5],E=s[9],P=s[13],R=s[2],T=s[6],F=s[10],D=s[14],_=s[3],C=s[7],j=s[11],L=s[15];return a[0]=r*w+o*A+n*R+l*_,a[4]=r*k+o*z+n*T+l*C,a[8]=r*M+o*E+n*F+l*j,a[12]=r*S+o*P+n*D+l*L,a[1]=h*w+c*A+d*R+p*_,a[5]=h*k+c*z+d*T+p*C,a[9]=h*M+c*E+d*F+p*j,a[13]=h*S+c*P+d*D+p*L,a[2]=u*w+m*A+b*R+g*_,a[6]=u*k+m*z+b*T+g*C,a[10]=u*M+m*E+b*F+g*j,a[14]=u*S+m*P+b*D+g*L,a[3]=f*w+y*A+v*R+x*_,a[7]=f*k+y*z+v*T+x*C,a[11]=f*M+y*E+v*F+x*j,a[15]=f*S+y*P+v*D+x*L,a},invertMatrixArray:t=>{const e=t,i=e[0],s=e[1],a=e[2],r=e[3],o=e[4],n=e[5],l=e[6],h=e[7],c=e[8],d=e[9],p=e[10],u=e[11],m=e[12],b=e[13],g=e[14],f=e[15],y=d*g*h-b*p*h+b*l*u-n*g*u-d*l*f+n*p*f,v=m*p*h-c*g*h-m*l*u+o*g*u+c*l*f-o*p*f,x=c*b*h-m*d*h+m*n*u-o*b*u-c*n*f+o*d*f,w=m*d*l-c*b*l-m*n*p+o*b*p+c*n*g-o*d*g,k=i*y+s*v+a*x+r*w;if(0===k)return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const M=1/k;return e[0]=y*M,e[1]=(b*p*r-d*g*r-b*a*u+s*g*u+d*a*f-s*p*f)*M,e[2]=(n*g*r-b*l*r+b*a*h-s*g*h-n*a*f+s*l*f)*M,e[3]=(d*l*r-n*p*r-d*a*h+s*p*h+n*a*u-s*l*u)*M,e[4]=v*M,e[5]=(c*g*r-m*p*r+m*a*u-i*g*u-c*a*f+i*p*f)*M,e[6]=(m*l*r-o*g*r-m*a*h+i*g*h+o*a*f-i*l*f)*M,e[7]=(o*p*r-c*l*r+c*a*h-i*p*h-o*a*u+i*l*u)*M,e[8]=x*M,e[9]=(m*d*r-c*b*r-m*s*u+i*b*u+c*s*f-i*d*f)*M,e[10]=(o*b*r-m*n*r+m*s*h-i*b*h-o*s*f+i*n*f)*M,e[11]=(c*n*r-o*d*r-c*s*h+i*d*h+o*s*u-i*n*u)*M,e[12]=w*M,e[13]=(c*b*a-m*d*a+m*s*p-i*b*p-c*s*g+i*d*g)*M,e[14]=(m*n*a-o*b*a-m*s*l+i*b*l+o*s*g-i*n*g)*M,e[15]=(o*d*a-c*n*a+c*s*l-i*d*l-o*s*p+i*n*p)*M,e},matrixArrayDeterminant:t=>{const e=t,i=e[0],s=e[4],a=e[8],r=e[12],o=e[1],n=e[5],l=e[9],h=e[13],c=e[2],d=e[6],p=e[10],u=e[14];return e[3]*(+r*l*d-a*h*d-r*n*p+s*h*p+a*n*u-s*l*u)+e[7]*(+i*l*u-i*h*p+r*o*p-a*o*u+a*h*c-r*l*c)+e[11]*(+i*h*d-i*n*u-r*o*d+s*o*u+r*n*c-s*h*c)+e[15]*(-a*n*c-i*l*d+i*n*p+a*o*d-s*o*p+s*l*c)},decomposeMatrixArray:t=>[t[12],t[13],t[14]],decomposeFullMatrixArray:t=>{const e=t;let i=ge.lengthArray([e[0],e[1],e[2]]);const s=ge.lengthArray([e[4],e[5],e[6]]),a=ge.lengthArray([e[8],e[9],e[10]]);ge.matrixArrayDeterminant(t)<0&&(i=-i);let r=[...t];const o=1/i,n=1/s,l=1/a;r[0]*=o,r[1]*=o,r[2]*=o,r[4]*=n,r[5]*=n,r[6]*=n,r[8]*=l,r[9]*=l,r[10]*=l;let h=ge.quatFromRotationMatrix(r);return{p:[t[12],t[13],t[14]],q:h,s:[i,s,a]}},applyTransformArray:(t,e,i,s=[1,1,1])=>{const a=ge.composeMatrixArray(e,i,s),r=t[0],o=t[1],n=t[2],l=1/(a[3]*r+a[7]*o+a[11]*n+a[15]);return[(a[0]*r+a[4]*o+a[8]*n+a[12])*l,(a[1]*r+a[5]*o+a[9]*n+a[13])*l,(a[2]*r+a[6]*o+a[10]*n+a[14])*l]},slerpQuatArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=[...t];const a=t[0],r=t[1],o=t[2],n=t[3],l=e[0],h=e[1],c=e[2],d=e[3];let p=n*d+a*l+r*h+o*c;if(p<0?(s=[-l,-h,-c,-d],p=-p):s=[...e],p>=1)return t;const u=1-p*p;if(u<=me){const t=1-i;return s[3]=t*n+i*s[3],s[0]=t*a+i*s[0],s[1]=t*r+i*s[1],s[2]=t*o+i*s[2],ge.quatNomalize(s)}const m=Math.sqrt(u),b=Math.atan2(m,p),g=Math.sin((1-i)*b)/m,f=Math.sin(i*b)/m;return s[3]=n*g+s[3]*f,s[0]=a*g+s[0]*f,s[1]=r*g+s[1]*f,s[2]=o*g+s[2]*f,s},toLocalQuatArray:(t=[0,0,0],e)=>{let i=ge.quatFromEuler(t),s=ge.quatInvert(e.quaternion.toArray());return ge.quatMultiply(s,i)},quatFromRotationMatrix:t=>{let e=[0,0,0,1];const i=t,s=i[0],a=i[4],r=i[8],o=i[1],n=i[5],l=i[9],h=i[2],c=i[6],d=i[10],p=s+n+d;if(p>0){const t=.5/Math.sqrt(p+1);e[3]=.25/t,e[0]=(c-l)*t,e[1]=(r-h)*t,e[2]=(o-a)*t}else if(s>n&&s>d){const t=2*Math.sqrt(1+s-n-d);e[3]=(c-l)/t,e[0]=.25*t,e[1]=(a+o)/t,e[2]=(r+h)/t}else if(n>d){const t=2*Math.sqrt(1+n-s-d);e[3]=(r-h)/t,e[0]=(a+o)/t,e[1]=.25*t,e[2]=(l+c)/t}else{const t=2*Math.sqrt(1+d-s-n);e[3]=(o-a)/t,e[0]=(r+h)/t,e[1]=(l+c)/t,e[2]=.25*t}return e},quatFromEuler:(t=[0,0,0],e=!0)=>{const i=Math.cos,s=Math.sin,a=e?pe:1,r=t[0]*a*.5,o=t[1]*a*.5,n=t[2]*a*.5,l=i(r),h=i(o),c=i(n),d=s(r),p=s(o),u=s(n);return[d*h*c+l*p*u,l*p*c-d*h*u,l*h*u+d*p*c,l*h*c-d*p*u]},quatFromAxis:(t=[0,0,0],e,i=!0)=>{const s=.5*e*(i?pe:1),a=Math.sin(s);return[t[0]*a,t[1]*a,t[2]*a,Math.cos(s)]},quatNomalize:t=>{let e=ge.lengthArray(t);return 0===e?[0,0,0,1]:(e=1/e,ge.scaleArray(t,e,4))},quatInvert:t=>[-t[0],-t[1],-t[2],t[3]],quatMultiply:(t,e)=>{const i=t[0],s=t[1],a=t[2],r=t[3],o=e[0],n=e[1],l=e[2],h=e[3];return[i*h+r*o+s*l-a*n,s*h+r*n+a*o-i*l,a*h+r*l+i*n-s*o,r*h-i*o-s*n-a*l]},quatToAxis:t=>{let e=2*Math.acos(t[3]);const i=Math.sqrt(1-t[3]*t[3]);return i<1e-4?[1,0,0]:[t[0]/i,t[1]/i,t[2]/i,e]},eulerFromMatrix:t=>{const e=t[0],i=t[4],s=t[8];t[1];const a=t[5],r=t[9];t[2];const o=t[6],n=t[10];let l=[0,0,0];return l[1]=Math.asin(ge.clamp(s,-1,1)),Math.abs(s)<.9999999?(l[0]=Math.atan2(-r,n),l[2]=Math.atan2(-i,e)):(l[0]=Math.atan2(o,a),l[2]=0),l},angleTo:(t,e)=>2*Math.acos(Math.abs(ge.clamp(ge.dotArray(t,e),-1,1))),fixedArray:(t,e)=>{let i=t.length,s=[];for(;i--;)s[i]=ge.toFixed(t[i],e);return s},getSize:t=>.001*t.byteLength+"kb",perpendicularArray:t=>{const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);let i=Math.acos(t[1]/e);const s=Math.atan2(t[2],t[0]);i>be?i-=be:i+=be;return[e*Math.sin(i)*Math.cos(s),e*Math.cos(i),e*Math.sin(i)*Math.sin(s)]},crossArray:(t,e)=>{const i=t[0],s=t[1],a=t[2],r=e[0],o=e[1],n=e[2];return[s*n-a*o,a*r-i*n,i*o-s*r]},applyQuaternion:(t,e)=>{const i=t[0],s=t[1],a=t[2],r=e[0],o=e[1],n=e[2],l=e[3],h=2*(o*a-n*s),c=2*(n*i-r*a),d=2*(r*s-o*i);return[i+l*h+o*d-n*c,s+l*c+n*h-r*d,a+l*d+r*c-o*h]},nullArray:(t,e,i)=>{let s=0;for(;i--;)s+=t[e+i];return s},equalArray:(t,e)=>{let i=t.length;for(;i--;)if(t[i]!==e[i])return!1;return!0},lerpArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let s=t.length,a=[];for(;s--;)a[s]=t[s],a[s]+=(e[s]-a[s])*i;return a},zeroArray:(t,e=0,i)=>{for(i=i??t.length;i--;)t[e+i]=0;return t},lengthArray:t=>{let e=t.length,i=0;for(;e--;)i+=t[e]*t[e];return Math.sqrt(i)},dotArray:(t,e)=>{let i=t.length,s=0;for(;i--;)s+=t[i]*e[i];return s},addArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]+e[i];return s},subArray:(t,e,i)=>{i=i??t.length;let s=[];for(;i--;)s[i]=t[i]-e[i];return s},mulArray:(t,e,i)=>{if(e instanceof Array){let s=[];for(i=i??t.length;i--;)s[i]=t[i]*e[i];return s}return t.map((t=>t*e))},worldscale:(t,e)=>t.map((t=>t*e)),divArray:(t,e,i)=>ge.mulArray(t,1/e,i),scaleArray:(t,e,i)=>ge.mulArray(t,e,i),fillArray:(t,e,i=0,s)=>{for(s=s??t.length;s--;)e[i+s]=t[s]},copyArray:(t,e)=>{},cloneArray:t=>[...t],distanceArray:(t,e=[0,0,0])=>ge.lengthArray(ge.subArray(t,e)),normalizeArray:t=>ge.divArray(t,ge.lengthArray(t)||1),normalArray:(t,e=[0,0,0])=>ge.normalizeArray(ge.subArray(e,t)),getCenter:(t,e)=>(t.computeBoundingBox(),t.boundingBox.getCenter(e)),getVolume:(t,e,i=null)=>{let s=1,a=e;switch(t){case"sphere":s=4*Math.PI*a[0]*a[0]*a[0]/3;break;case"cone":s=Math.PI*a[0]*(.5*a[1])*2;break;case"box":s=.5*a[0]*8*(.5*a[1])*(.5*a[2]);break;case"cylinder":s=Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"capsule":s=4*Math.PI*a[0]*a[0]*a[0]/3+Math.PI*a[0]*a[0]*(.5*a[1])*2;break;case"convex":case"mesh":s=ge.getConvexVolume(i)}return s},getConvexVolume:t=>{let e,i=t.length/3,s=[0,0,0],a=[0,0,0];for(;i--;)e=3*i,t[e]<s[0]?s[0]=t[e]:t[e]>a[0]&&(a[0]=t[e]),t[e+1]<s[1]?s[1]=t[e+1]:t[e+1]>a[1]&&(a[1]=t[e+1]),t[e+2]<s[2]?s[2]=t[e+2]:t[e+2]>a[2]&&(a[2]=t[e+2]);let r=[a[0]-s[0],a[1]-s[1],a[2]-s[2]];return.5*r[0]*8*(.5*r[1])*(.5*r[2])},massFromDensity:(t,e)=>t*e,densityFromMass:(t,e)=>t/e,toNonIndexed:t=>t.index?t.clone().toNonIndexed():t,getIndex:(t,e)=>!t.index||e?null:t.index.array||null,getSameVertex:t=>{const e=t.getAttribute("position"),i=e.array,s=[],a=[],r={};new THREE.Vector3;let o,n=0;ge.getHash(t);let l,h,c=!1,d=0;for(let t=0;t<e.count;t++){n=3*t,l={x:i[n],y:i[n+1],z:i[n+2],id:t},c=!1,o=s.length;for(let e=0;e<o;e++)h=s[e],l.x===h.x&&l.y===h.y&&l.z===h.z&&(c=!0,r[t]=h.id);c||(l.id=d++,s.push(l),a.push([l.x,l.y,l.z]))}return[a,r]},getVertex:(t,e)=>{let i=t.attributes.position.array;return e&&t.index&&(i=(t=t.clone().toNonIndexed()).attributes.position.array),i},getNormal:t=>t.attributes.normal.array,getFaces:t=>{let e=[];if(t.index){let i=t.getIndex();for(let t=0;t<i.count;t+=3)e.push([i.getX(t),i.getX(t+1),i.getX(t+2)])}else{let i=t.getAttribute("position").count;for(let t=0;t<i;t+=3)e.push([t,t+1,t+2])}return e},getConnectedFaces:t=>{const e=[];let i,s,a,r,o,n,l,h=t.length,c=h;for(;c--;)for(s=t[c],i=h;i--;)i!==c&&(a=t[i],r=s.filter((t=>a.includes(t))),r.length>1&&(l=[],o=[...s],n=o.indexOf(r[0]),o.splice(n,1),n=o.indexOf(r[1]),o.splice(n,1),l.push(o[0]),o=[...a],n=o.indexOf(r[0]),o.splice(n,1),n=o.indexOf(r[1]),o.splice(n,1),l.push(o[0]),e.push(l)));return e},reduce:t=>{},barycentric:(t,e)=>{},solve:(t,e)=>{},getHash:(t,e=1e-4)=>{e=Math.max(e,Number.EPSILON);const i={},s={},a=t.getAttribute("position"),r=a.count,o=a.array,n=.5*e,l=Math.log10(1/e),h=Math.pow(10,l),c=n*h;let d;for(let t=0;t<r;t++){d=3*t;let e=`${~~(o[d]*h+c)},${~~(o[d+1]*h+c)},${~~(o[d+2]*h+c)}`;i[e]?i[e].push(t):i[e]=[t]}let p=0;for(let t in i)s[p++]=i[t];return s}},fe=ge,ye=["PHYSX","HAVOK"],ve=4e3,xe=1e3,we=4e3,ke=100,Me=100,Se=50,Ae=20,ze={bodyFull:14,body:8,joint:16,contact:1,ray:11,character:16,vehicle:72,solver:128},Ee=function(t,e=!1){const i={};let s={body:ve*(e?ze.bodyFull:ze.body),joint:xe*ze.joint,ray:ke*ze.ray,contact:we*ze.contact,character:Me*ze.character};"PHYSX"!==t&&"AMMO"!==t||(s.vehicle=Se*ze.vehicle),"PHYSX"===t&&(s.solver=Ae*ze.solver),"HAVOK"!==t&&"RAPIER"!==t&&"JOLT"!==t||(ze.joint=0);let a=0;for(let t in s)i[t]=a,a+=s[t];return i.total=a,i};class Pe extends t{constructor(t,r=16776960){const o=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),n=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],l=new e;l.setIndex(new i(o,1)),l.setAttribute("position",new s(n,3)),l.setAttribute("color",new s([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(l,new a({color:r,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=t,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(t){const e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(t))}dispose(){this.geometry.dispose(),this.material.dispose()}}function Re(t,i=!1){const s=null!==t[0].index,a=new Set(Object.keys(t[0].attributes)),r=new Set(Object.keys(t[0].morphAttributes)),o={},n={},l=t[0].morphTargetsRelative,h=new e;let c=0;for(let e=0;e<t.length;++e){const d=t[e];let p=0;if(s!==(null!==d.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const t in d.attributes){if(!a.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+'. All geometries must have compatible attributes; make sure "'+t+'" attribute exists among all geometries, or in none of them.'),null;void 0===o[t]&&(o[t]=[]),o[t].push(d.attributes[t]),p++}if(p!==a.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". Make sure all geometries have the same number of attributes."),null;if(l!==d.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const t in d.morphAttributes){if(!r.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===n[t]&&(n[t]=[]),n[t].push(d.morphAttributes[t])}if(i){let t;if(s)t=d.index.count;else{if(void 0===d.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". The geometry must have either an index or a position attribute"),null;t=d.attributes.position.count}h.addGroup(c,t,e),c+=t}}if(s){let e=0;const i=[];for(let s=0;s<t.length;++s){const a=t[s].index;for(let t=0;t<a.count;++t)i.push(a.getX(t)+e);e+=t[s].attributes.position.count}h.setIndex(i)}for(const t in o){const e=Te(o[t]);if(!e)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" attribute."),null;h.setAttribute(t,e)}for(const t in n){const e=n[t][0].length;if(0===e)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[t]=[];for(let i=0;i<e;++i){const e=[];for(let s=0;s<n[t].length;++s)e.push(n[t][s][i]);const s=Te(e);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" morphAttribute."),null;h.morphAttributes[t].push(s)}}return h}function Te(t){let e,s,a,r=-1,o=0;for(let i=0;i<t.length;++i){const n=t[i];if(void 0===e&&(e=n.array.constructor),e!==n.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===s&&(s=n.itemSize),s!==n.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===a&&(a=n.normalized),a!==n.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===r&&(r=n.gpuType),r!==n.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;o+=n.count*s}const n=new e(o),l=new i(n,s,a);let h=0;for(let e=0;e<t.length;++e){const i=t[e];if(i.isInterleavedBufferAttribute){const t=h/s;for(let e=0,a=i.count;e<a;e++)for(let a=0;a<s;a++){const s=i.getComponent(e,a);l.setComponent(e+t,a,s)}}else n.set(i.array,h);h+=i.count*s}return void 0!==r&&(l.gpuType=r),l}function Fe(t,e=1e-4){e=Math.max(e,Number.EPSILON);const i={},s=t.getIndex(),a=t.getAttribute("position"),r=s?s.count:a.count;let o=0;const n=Object.keys(t.attributes),l={},h={},c=[],d=["getX","getY","getZ","getW"],p=["setX","setY","setZ","setW"];for(let e=0,i=n.length;e<i;e++){const i=n[e],s=t.attributes[i];l[i]=new s.constructor(new s.array.constructor(s.count*s.itemSize),s.itemSize,s.normalized);const a=t.morphAttributes[i];a&&(h[i]||(h[i]=[]),a.forEach(((t,e)=>{const s=new t.array.constructor(t.count*t.itemSize);h[i][e]=new t.constructor(s,t.itemSize,t.normalized)})))}const u=.5*e,m=Math.log10(1/e),b=Math.pow(10,m),g=u*b;for(let e=0;e<r;e++){const a=s?s.getX(e):e;let r="";for(let e=0,i=n.length;e<i;e++){const i=n[e],s=t.getAttribute(i),o=s.itemSize;for(let t=0;t<o;t++)r+=~~(s[d[t]](a)*b+g)+","}if(r in i)c.push(i[r]);else{for(let e=0,i=n.length;e<i;e++){const i=n[e],s=t.getAttribute(i),r=t.morphAttributes[i],c=s.itemSize,u=l[i],m=h[i];for(let t=0;t<c;t++){const e=d[t],i=p[t];if(u[i](o,s[e](a)),r)for(let t=0,s=r.length;t<s;t++)m[t][i](o,r[t][e](a))}}i[r]=o,c.push(o),o++}}const f=t.clone();for(const e in t.attributes){const t=l[e];if(f.setAttribute(e,new t.constructor(t.array.slice(0,o*t.itemSize),t.itemSize,t.normalized)),e in h)for(let t=0;t<h[e].length;t++){const i=h[e][t];f.morphAttributes[e][t]=new i.constructor(i.array.slice(0,o*i.itemSize),i.itemSize,i.normalized)}}return f.setIndex(c),f}class De extends e{constructor(t=1,e=16,i=16,s=16,a=1){super(),this.type="SphereBox",this.name="SphereBox_"+t+"_"+e+"_"+i+"_"+s+"_"+a,t=t||1,e=Math.floor(e),i=Math.floor(i),s=Math.floor(s);let o,l,h,c=new r(1,1,1,e,i,s),d=new n,p=new n,u=c.attributes.position.count,m=c.attributes.position.array,b=c.attributes.normal.array,g=c.attributes.uv.array,f=c.attributes.uv.count,y=f/6,v=1/3,x=0,w=0;for(let t=0;t<f;t++){switch(h=Math.floor(t/y),h){case 0:x=0,w=.5;break;case 5:x=v,w=.5;break;case 1:x=2*v,w=.5;break;case 4:x=0,w=1;break;case 3:x=v,w=1;break;case 2:x=2*v,w=1}l=2*t,g[l]*=v,g[l]+=x,g[l+1]*=-.5,g[l+1]+=w,g[l]>1&&(g[l]=1),g[l]<0&&(g[l]=0),g[l+1]>1&&(g[l+1]=1),g[l+1]<0&&(g[l+1]=0)}for(let e=0;e<u;e++)o=3*e,d.set(m[o],m[o+1],m[o+2]),p.copy(d).normalize(),d.lerp(p,a).multiplyScalar(t),m[o]=d.x,m[o+1]=d.y,m[o+2]=d.z,d.normalize(),b[o]=d.x,b[o+1]=d.y,b[o+2]=d.z;c.computeTangents(),this.copy(c)}}class _e extends e{constructor(t=1,e=1,i=12,s=1){super(),this.type="CapsuleGeometry";let a=Math.PI,r=t/(2*t+e),o=1-2*r;i=Math.floor(i),s=Math.floor(s);let n=Math.floor(.5*i),c=2*Math.PI,d=.5*Math.PI,u=new h(t,t,e,i,s,!0);Oe(u,0,r,1,o);let m=new p(t,i,n,0,c,0,d);Oe(m,0,1-r,1,r);let b=new p(t,i,n,0,c,d,d);Oe(b,0,0,1,r);let g=(new l).makeRotationY(.5*-a),f=(new l).makeTranslation(0,.5*e,0),y=(new l).makeTranslation(0,.5*-e,0);u.applyMatrix4(g),m.applyMatrix4(f),b.applyMatrix4(y);let v=Fe(Re([u,m,b]));this.copy(v)}}class Ce extends e{constructor(t=1,e=.4,i=8,a=6,r=2*Math.PI,o=0,l=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:a,arc:r},i=Math.floor(i),a=Math.floor(a);const h=[],c=[],d=[],p=[],u=new n,m=new n,b=new n;let g,f;for(g=0;g<=i;g++)for(f=0;f<=a;f++){const s=f/a*r,n=g/i*l+o;m.x=(t+e*Math.cos(n))*Math.cos(s),m.y=(t+e*Math.cos(n))*Math.sin(s),m.z=e*Math.sin(n),c.push(m.x,m.y,m.z),u.x=t*Math.cos(s),u.y=t*Math.sin(s),b.subVectors(m,u).normalize(),d.push(b.x,b.y,b.z),p.push(f/a),p.push(g/i)}for(g=1;g<=i;g++)for(f=1;f<=a;f++){const t=(a+1)*g+f-1,e=(a+1)*(g-1)+f-1,i=(a+1)*(g-1)+f,s=(a+1)*g+f;h.push(t,e,s),h.push(e,i,s)}this.setIndex(h),this.setAttribute("position",new s(c,3)),this.setAttribute("normal",new s(d,3)),this.setAttribute("uv",new s(p,2))}}class je extends e{constructor(t=1,e=1,i=1,s=.01,a=12,r=1,o=2){super(),this.type="ChamferCyl",a=Math.floor(a),r=Math.floor(r),o=Math.floor(o);let n=new l,d=new l,p=Math.PI,u=.5*p,m=2*p,b=s/i,g=1-2*b,f=new h(t,e,i-2*s,a,r,!0,0);n.makeRotationY(u),f.applyMatrix4(n),Oe(f,0,b,1,g);let y=new Ce(t-s,s,o,a,m,0,u),v=new c(t-s,a);d.makeTranslation(0,0,s),v.applyMatrix4(d),Oe(y,0,1-b,1,b);let x=Re([y,v]);n.makeTranslation(0,0,.5*i-s),d.makeRotationX(-u),x.applyMatrix4(d.multiply(n)),y=new Ce(e-s,s,o,a,m,0,u),v=new c(e-s,a),d.makeTranslation(0,0,s),v.applyMatrix4(d),Oe(y,0,1-b,1,b,!0);let w=Re([y,v]);n.makeTranslation(0,0,.5*i-s),d.makeRotationX(u),w.applyMatrix4(d.multiply(n));let k=Fe(Re([x,f,w]));this.copy(k)}}let Le=class extends e{constructor(t=1,e=1,i=1,s=.01,a=1,r=1,o=1,n=2){super(),this.type="ChamferBox",a=Math.floor(a),r=Math.floor(r),o=Math.floor(o),n=Math.floor(n);let c=Math.PI,p=.5*c,u=2*s,m=.5*t,b=.5*e,g=.5*i,f=new l,y=new l,v=new l,x=s/t,w=1-2*x,k=s/e,M=1-2*x,S=s/i,A=1-2*S,z=new d(t-u,e-u,a,r),E=new h(s,s,t-u,n,a,!0,0,p),P=new h(s,s,e-u,n,r,!0,0,p),R=new qe(s,n,n,0,p,0,-p),T=new qe(s,n,n,0,p,0,-p);Oe(z,-x,k,w,M),Oe(E,0,x,k,w),y.makeTranslation(0,b-s,0),f.makeRotationX(p),R.applyMatrix4(y.multiply(f)),y.makeTranslation(0,-b+s,0),f.makeRotationX(p),v.makeRotationY(-p),T.applyMatrix4(y.multiply(f).multiply(v));let F=Re([P,R,T]),D=F.clone();y.makeTranslation(m-s,0,-s),F.applyMatrix4(y),y.makeTranslation(-m+s,0,-s),f.makeRotationZ(c),D.applyMatrix4(y.multiply(f));let _=E.clone();f.makeRotationZ(p),y.makeTranslation(0,b-s,-s),E.applyMatrix4(y.multiply(f)),y.makeTranslation(0,-b+s,-s),f.makeRotationZ(-p),_.applyMatrix4(y.multiply(f));let C=Re([E,_,z,F,D]),j=C.clone();y.makeTranslation(0,0,g),C.applyMatrix4(y),y.makeTranslation(0,0,-g),f.makeRotationY(c),j.applyMatrix4(y.multiply(f)),z=new d(i-u,e-u,o,r),E=new h(s,s,i-u,n,o,!0,0,p),_=E.clone(),Oe(z,-S,k,A,M),y.makeTranslation(0,-(b-s),-s,0),f.makeRotationZ(-p),E.applyMatrix4(y.multiply(f)),y.makeTranslation(0,b-s,-s,0),f.makeRotationZ(p),_.applyMatrix4(y.multiply(f));let L=Re([E,_,z]),q=L.clone();y.makeTranslation(-m,0,0),f.makeRotationY(-p),L.applyMatrix4(y.multiply(f)),y.makeTranslation(m,0,0),f.makeRotationY(p),q.applyMatrix4(y.multiply(f)),z=new d(t-u,i-u,a,o),Oe(z,-x,S,w,A);let O=z.clone();y.makeTranslation(0,b,0),f.makeRotationX(-p),z.applyMatrix4(y.multiply(f)),y.makeTranslation(0,-b,0),f.makeRotationX(p),O.applyMatrix4(y.multiply(f));let B=Fe(Re([C,j,L,q,z,O]));Be(B,"box"),this.copy(B)}},qe=class extends e{constructor(t=1,e=8,i=6,a=0,r=2*Math.PI,o=0,l=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:a,phiLength:r,thetaStart:o,thetaLength:l},e=Math.floor(e),i=Math.floor(i);const h=Math.min(o+l,Math.PI);let c=0;const d=[],p=new n,u=new n,m=[],b=[],g=[],f=[];for(let s=0;s<=i;s++){const n=[],m=s/i;let y=0;0==s&&0==o?y=.5/e:s==i&&h==Math.PI&&(y=-.5/e);for(let i=0;i<=e;i++){const s=i/e;p.x=-t*Math.cos(a+s*r)*Math.sin(o+m*l),p.y=t*Math.cos(o+m*l),p.z=t*Math.sin(a+s*r)*Math.sin(o+m*l),b.push(p.x,p.y,p.z),u.copy(p).normalize(),g.push(u.x,u.y,u.z),f.push(s+y,1-m),n.push(c++)}d.push(n)}for(let t=0;t<i;t++)for(let s=0;s<e;s++){const e=d[t][s+1],a=d[t][s],r=d[t+1][s],n=d[t+1][s+1];(0!==t||o>0)&&m.push(e,a,n),(t!==i-1||h<Math.PI)&&m.push(a,r,n)}this.setIndex(m),this.setAttribute("position",new s(b,3)),this.setAttribute("normal",new s(g,3)),this.setAttribute("uv",new s(f,2))}};function Oe(t,e=0,i=0,s=1,a=1,r){let o=t.attributes.uv,n=o.array,l=o.count,h=0;for(;l--;)h=2*l,n[h]=n[h]*s-e,n[h+1]=n[h+1]*a+i,r&&(n[h]=1-n[h],n[h+1]=1-n[h+1])}function Be(t,e="sphere",i,a=[0,0,0],r=[0,0,0,1],o){if(void 0===o&&(o=new l),o.compose({x:a[0],y:a[1],z:a[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===i){t.boundingBox||t.computeBoundingBox();let e=t.boundingBox;i=Math.max(e.max.x-e.min.x,e.max.y-e.min.y,e.max.z-e.min.z)}let h=new u(new n(-i/2,-i/2,-i/2),new n(i/2,i/2,i/2)),c=[];c.length=2*t.attributes.position.count,void 0===t.attributes.uv&&t.setAttribute("uv",new s(c,2));let d,p,m,g,f,y=function(t,e,i){t.applyMatrix4(o),e.applyMatrix4(o),i.applyMatrix4(o);let s=1/(2*Math.PI),a=1/Math.PI;return t.normalize(),e.normalize(),i.normalize(),{uv0:new b(.5-Math.atan(t.z,-t.x)*s,.5-Math.asin(t.y)*a),uv1:new b(.5-Math.atan(e.z,-e.x)*s,.5-Math.asin(e.y)*a),uv2:new b(.5-Math.atan(i.z,-i.x)*s,.5-Math.asin(i.y)*a)}},v=function(t,e,s){t.applyMatrix4(o),e.applyMatrix4(o),s.applyMatrix4(o);let a=new n;a.crossVectors(e.clone().sub(t),e.clone().sub(s)).normalize(),a.x<0||a.y<0||a.z,a.x=Math.abs(a.x),a.y=Math.abs(a.y),a.z=Math.abs(a.z);let r=new b,l=new b,c=new b,d=1/i;return a.y>a.x&&a.y>a.z?(r.set(t.x-h.min.x,h.max.z-t.z).multiplyScalar(d),l.set(e.x-h.min.x,h.max.z-e.z).multiplyScalar(d),c.set(s.x-h.min.x,h.max.z-s.z).multiplyScalar(d)):a.x>a.y&&a.x>a.z?(r.set(t.z-h.min.z,t.y-h.min.y).multiplyScalar(d),l.set(e.z-h.min.z,e.y-h.min.y).multiplyScalar(d),c.set(s.z-h.min.z,s.y-h.min.y).multiplyScalar(d)):a.z>a.y&&a.z>a.x&&(r.set(t.x-h.min.x,t.y-h.min.y).multiplyScalar(d),l.set(e.x-h.min.x,e.y-h.min.y).multiplyScalar(d),c.set(s.x-h.min.x,s.y-h.min.y).multiplyScalar(d)),{uv0:r,uv1:l,uv2:c}},x=new n,w=new n,k=new n;new n,new n,new n;const M=t.getAttribute("position");if(t.getAttribute("normal"),t.index)for(d=0;d<t.index.count;d+=3)p=t.index.getX(d+0),m=t.index.getX(d+1),g=t.index.getX(d+2),x.fromBufferAttribute(M,p),w.fromBufferAttribute(M,m),k.fromBufferAttribute(M,g),f="sphere"===e?y(x,w,k):v(x,w,k),c[2*p]=f.uv0.x,c[2*p+1]=f.uv0.y,c[2*m]=f.uv1.x,c[2*m+1]=f.uv1.y,c[2*g]=f.uv2.x,c[2*g+1]=f.uv2.y;else for(d=0;d<M.count;d+=3){x.fromBufferAttribute(M,d+0),w.fromBufferAttribute(M,d+1),k.fromBufferAttribute(M,d+2),f="sphere"===e?y(x,w,k):v(x,w,k);let t=d,i=d+1,s=d+2;c[2*t]=f.uv0.x,c[2*t+1]=f.uv0.y,c[2*i]=f.uv1.x,c[2*i+1]=f.uv1.y,c[2*s]=f.uv2.x,c[2*s+1]=f.uv2.y}t.attributes.uv.array=new Float32Array(c),t.attributes.uv.needsUpdate=!0}let Ie=class{constructor(){this.geoN=0,this.geo={}}unic(t){this.geo["geo"+this.geoN++]=t}set(t){this.geo[t.name]=t}get(t,e={}){if(!this.geo[t]){let e;switch(t){case"plane":e=new d(1,1),e.rotateX(.5*-Math.PI);break;case"box":e=new r(1,1,1);break;case"sphere":e=new p(1,16,12);break;case"highSphere":e=new De(1);break;case"cylinder":e=new h(1,1,1,16);break;case"cone":e=new h(.001,1,1,16);break;case"particle":e=new p(1,6,4);break;case"joint":e=(new Pe).geometry;break;default:return null}this.geo[t]=e}return this.geo[t]}dispose(){for(let t in this.geo)this.geo[t].isBufferGeometry?this.geo[t].dispose():console.log(this.geo[t]);this.geo={},this.geoN=0}};class Ge{constructor(t,e="rgb(69,69,69)",i="rgb(39,39,39)"){const s=document.createElement("canvas");s.width=s.height=128;const a=s.getContext("2d");if(a.fillStyle=e,a.fillRect(0,0,128,128),t){let s,r,o,n,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=t?"rgb(128,128,255)":e,d=t?"rgb(160,100,255)":i,p=t?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(a.strokeStyle=p,a.lineWidth=1,s=0;s<5;s++){n=a.createLinearGradient(0,h[s][0],0,h[s][1]),n.addColorStop(0,d),n.addColorStop(1,c),a.beginPath(),a.fillStyle=n,a.rect(l[s][0],l[s][1],32,64),a.fill();for(let t=0;t<8;t++)o=2*(Math.random()-.5),a.beginPath(),a.moveTo(l[s][0]+o+2+4*t,l[s][1]),a.lineTo(l[s][0]+o+2+4*t,l[s][1]+64),a.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],s=0;s<5;s++)for(n=a.createLinearGradient(h[s][0],0,h[s][1],0),n.addColorStop(0,c),n.addColorStop(1,d),a.beginPath(),a.fillStyle=n,a.rect(l[s][0],l[s][1],64,32),a.fill(),r=0;r<8;r++)o=2*(Math.random()-.5),a.beginPath(),a.moveTo(l[s][0],l[s][1]+o+2+4*r),a.lineTo(l[s][0]+64,l[s][1]+o+2+4*r),a.stroke()}else a.beginPath(),a.fillStyle=i,a.rect(0,0,32,64),a.rect(32,32,32,64),a.rect(64,64,32,64),a.rect(96,96,32,64),a.rect(96,-32,32,64),a.fill();const r=new g(s);return r.wrapS=r.wrapT=f,r.repeat.x=r.repeat.y=60,t||(r.colorSpace=y),r}}class Ne extends v{constructor(t){super(),this.defines={STANDARD:"",PHYSICAL:"",SUBSURFACE:"",USE_UV:""},this.extra={},this.addParametre("sssMap",null),this.addParametre("sssColor",new x(0,0,0)),this.addParametre("sssAmbient",.5),this.addParametre("sssDistortion",.6),this.addParametre("sssAttenuation",.1),this.addParametre("sssPower",1),this.addParametre("sssScale",6),this.setValues(t);let e=this;e.onBeforeCompile=function(t){for(let i in e.extra)t.uniforms[i]={value:e.extra[i]};t.fragmentShader=t.fragmentShader.replace("#include <common>",Ve.common),t.fragmentShader=t.fragmentShader.replace("#include <lights_fragment_begin>",e.replaceAll(Ue,"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );",Ve.light)),e.userData.shader=t}}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.userData.shader&&(this.userData.shader.uniforms[t].value=this.extra[t])}})}replaceAll(t,e,i){return t.split(e).join(i)}}const Ve={common:"\n\t#include <common>\n\tuniform sampler2D sssMap;\n\tuniform float sssPower;\n\tuniform float sssScale;\n\tuniform float sssDistortion;\n\tuniform float sssAmbient;\n\tuniform float sssAttenuation;\n\tuniform vec3 sssColor;\n\n\tvoid RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n\t\tvec3 thickness = sssColor * texture2D(sssMap, uv).r;\n\t\tvec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * sssDistortion));\n\t\tfloat scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), sssPower) * sssScale;\n\t\tvec3 scatteringIllu = (scatteringDot + sssAmbient) * thickness;\n\t\treflectedLight.directDiffuse += scatteringIllu * sssAttenuation * directLight.color;\n\t}\n\t",light:"\n\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t#if defined( SUBSURFACE ) && defined( USE_UV )\n\t\tRE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n\t#endif\n\t"},Ue="\n\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n\n#ifdef USE_CLEARCOAT\n\n\tgeometryClearcoatNormal = clearcoatNormal;\n\n#endif\n\n#ifdef USE_IRIDESCENCE\n\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\n\tif ( material.iridescenceThickness == 0.0 ) {\n\n\t\tmaterial.iridescence = 0.0;\n\n\t} else {\n\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\n\t}\n\n\tif ( material.iridescence > 0.0 ) {\n\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\n\t\t// Iridescence F0 approximation\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\n\t}\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\n\t\t// spot lights are ordered [shadows with maps, shadows without maps, maps without shadows, none]\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t#if defined( USE_LIGHT_PROBES )\n\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\n\t#endif\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",We={metalness:.1,roughness:.9},He={grey:new x(.18,.18,.18),black:new x(.039,.039,.039),body:new x(13289155),sleep:new x("hsl(33, 15%, 54%)"),solid:new x(7105128),base:new x(13224135),brick:new x(.262,.095,.061),sand:new x(.44,.386,.231),gold:new x(.944,.776,.373),gold2:new x(.998,.981,.751),titanium:new x(.633,.578,.503),titaniumSpec:new x(.728,.68,.55),chrome:new x(.653,.65,.615),chromeSpec:new x(.675,.72,.711),copper:new x(.988,.688,.448),carPaint:new x(.1037792,.59212029,.85064936),clay:new x("hsl(12, 30%, 40%)"),clayWhite:new x(11119017),concrete:new x(.51,.51,.51),Raw_Fire:new x("hsl(40, 18%, 54%)"),Raw_Buff:new x("hsl(33, 15%, 54%)"),Raw_Terracotta:new x("hsl(12, 30%, 40%)"),Raw_Porcelain:new x("hsl(45, 15%, 90%)")},Ke={No:Q,Normal:X,Additive:J,Subtractive:K,Multiply:H,Eadd:W,Esub:U,Erev:V,Emin:N,Emaw:G,Fzero:I,Fone:B,Fcolor:O,Fcolorm:q,Falpha:L,Falpham:j,Fdstalpha:C,Fdstalpham:_,Fdstcolor:D,Fdstcolorm:F,Falphasaturate:T,Front:R,Back:P,Double:E};let Je=class{constructor(){this.renderMode={value:0},this.depthPacking={value:0},this.extendMat=!1,this.isRealism=!1,this.realismOption={},this.envMapIntensity=1,this.mat={},this.TmpMat=[]}changeRenderMode(t){this.renderMode.value=t}initExtandShader(){}useRealLight(t){}setColor(t){}set(t,e,i=null){i||(i=t.onBeforeCompile),this.mat[t.name]=t}extendShader(t,e=null){}addToTmp(t){this.TmpMat.push(t)}create(t){let e,i=null;if(t.isMaterial)e=t;else{let s=void 0!==t.type?t.type:"Standard";switch(t.type&&delete t.type,i=t.beforeCompile||null,t.beforeCompile&&delete t.beforeCompile,(t.thickness||t.sheen||t.clearcoat||t.transmission||t.specularColor)&&(s="Physical"),t.normalScale&&(t.normalScale.isVector2||(t.normalScale=(new b).fromArray(t.normalScale))),t.side&&(t.side=this.findValue(t.side)),t.shadowSide&&(t.shadowSide=this.findValue(t.shadowSide)),t.blending&&(t.blending=this.findValue(t.blending)),t.blendEquation&&(t.blendEquation=this.findValue(t.blendEquation)),t.blendEquationAlpha&&(t.blendEquationAlpha=this.findValue(t.blendEquationAlpha)),t.blendSrc&&(t.blendSrc=this.findValue(t.blendSrc)),t.blendDst&&(t.blendDst=this.findValue(t.blendDst)),t.blendDstAlpha&&(t.blendDstAlpha=this.findValue(t.blendDstAlpha)),t.blendSrcAlpha&&(t.blendSrcAlpha=this.findValue(t.blendSrcAlpha)),t.clearcoatNormalScale&&(t.clearcoatNormalScale.isVector2||(t.clearcoatNormalScale=(new b).fromArray(t.clearcoatNormalScale))),s=s.toLowerCase(),s){case"physical":e=new v(t),e.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":e=new z(t);break;case"lambert":e=new A(t);break;case"basic":e=new S(t);break;case"line":e=new a(t);break;case"toon":e=new M(t);break;case"shadow":e=new k(t);break;case"sss":e=new Ne(t);break;default:e=new w(t)}}return this.mat[e.name]?null:(this.set(e,!1,i),e)}findValue(t){return"string"===t?Ke[t.charAt(0).toUpperCase()+t.slice(1)]:t}addToMat(t){if(this.isRealism)for(let e in t)t[e].onBeforeCompile=function(i){EnhanceLighting(i,this.realismOption),t[e].userData.isRealism=!0,t[e].userData.shader=i};this.mat={...this.mat,...t}}changeType(){}directIntensity(t){for(let t in this.mat);}getList(){let t={...this.mat};const e=["line","debug","hide","svg"];let i=e.length;for(;i--;)delete t[e[i]];return t}get(t){if(!this.mat[t])switch(t){case"grey":this.create({name:"grey",color:He.grey,metalness:0,roughness:.5});break;case"black":this.create({name:"black",color:He.black,metalness:0,roughness:.5});break;case"body":this.create({name:"body",color:He.body,...We});break;case"sleep":this.create({name:"sleep",color:He.sleep,...We});break;case"solid":this.create({name:"solid",color:He.solid,...We});break;case"base":this.create({name:"base",color:He.base,...We});break;case"clay":this.create({name:"clay",color:He.clay,metalness:.1,roughness:.7});break;case"clayWhite":this.create({name:"clayWhite",color:He.clayWhite,metalness:.1,roughness:.7});break;case"concrete":this.create({name:"concrete",color:He.concrete,metalness:0,roughness:.9});break;case"brick":this.create({name:"brick",color:He.brick,metalness:0,roughness:.6});break;case"sand":this.create({name:"sand",color:He.sand,metalness:0,roughness:.9});break;case"chrome":this.create({name:"chrome",color:He.chrome,specularColor:He.chromeSpec,metalness:1,roughness:.075});break;case"silver":this.create({name:"silver",color:11184810,metalness:.8,roughness:.22});break;case"gold":this.create({name:"gold",color:He.gold,specularColor:He.gold2,metalness:1,roughness:.02});break;case"copper":this.create({name:"copper",color:He.copper,metalness:1,roughness:.05});break;case"titanium":this.create({name:"titanium",color:He.titanium,metalness:1,roughness:0,specularColor:He.titaniumSpec});break;case"carPaint":this.create({name:"carPaint",color:He.carPaint,metalness:0,anisotropy:new b(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":this.create({name:"carbon",map:new Ge,normalMap:new Ge(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":this.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":this.create({name:"skinny",color:14724201,...We});break;case"glass":this.create({name:"glass",color:16777215,transparent:!0,roughness:.02,metalness:0,side:E,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.01});break;case"glassX":this.create({name:"glassX",color:16777215,alphaToCoverage:!0,transparent:!0,opacity:1,roughness:0,metalness:0,side:E,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.05,ior:1.52,shadowSide:1,reflectivity:.5,iridescence:0,specularIntensity:1,specularColor:16777215});break;case"plexi":this.create({name:"plexi",blending:J,color:65793,transparent:!0,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:E,alphaToCoverage:!0,premultipliedAlpha:!0});break;case"plexi2":this.create({name:"plexi2",blending:J,color:65793,transparent:!1,opacity:.7,reflectivity:.3,metalness:.6,roughness:.1,clearcoat:.2,clearcoatRoughness:.02,side:E,alphaToCoverage:!1,premultipliedAlpha:!0});break;case"glass2":this.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":this.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":this.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":this.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":this.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":this.create({name:"outline",color:16777215,type:"Basic",side:P,toneMapped:!1,wireframe:!0,transparent:!0,opacity:.25});break;case"debug":this.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":this.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":this.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":this.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":this.create({name:"button",color:16728139,...We});break;case"line":this.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"liner":this.create({name:"liner",type:"line",vertexColors:!0,toneMapped:!1,depthTest:!0,depthWrite:!0,alphaToCoverage:!0});break;case"hide":this.create({name:"hide",type:"basic",visible:!1});break;case"particle":this.create({name:"particle",type:"basic",toneMapped:!1,color:16776960,transparent:!0,opacity:.2});break;case"svg":this.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:E})}return this.mat[t]}dispose(){this.isRealism=!1;for(let t in this.mat)this.mat[t].dispose(),delete this.mat[t];let t=this.TmpMat.length;for(;t--;)this.TmpMat[t].dispose();this.TmpMat=[]}upShader(){let t=this.realismOption;for(let e in this.mat){const i=this.mat[e],s=i.userData.shader;for(let e in t)s&&void 0!==s.uniforms[e]&&(s.uniforms[e].value=t[e]),i[e]&&(i[e]=t[e])}}};class Xe{constructor(t=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(t),this.force=!1}up(t){let e=this.time;return this.unlimited&&(this.force=!0),e.now=void 0!==t?t:this.now(),e.delta=e.now-e.then,this.force&&(e.delta=e.interval,this.force=!1),!!(e.delta>=e.interval||this.unlimited)&&(e.then=this.unlimited?e.now:e.now-e.delta%e.interval,this.delta=.001*e.interval,this.elapsedTime+=this.delta,!0)}setFramerate(t){this.elapsedTime=0,this.framerate=t,this.unlimited=this.framerate<0,this.time.interval=1e3/t,60===t&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(t){return t>1e3?t/1e3+" sec":t+" ms"}}class Qe{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new Ye(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(t){this.keyDown(t)}.bind(this),!1),document.addEventListener("keyup",function(t){this.keyUp(t)}.bind(this),!1)}setKey(t,e){this.key[t]=e}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=-1,i[0]=1;break;case 68:case 39:e[0]=1,i[1]=1;break;case 87:case 90:case 38:e[1]=-1;break;case 83:case 40:e[1]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}else switch(t.which){case 65:case 81:e[0]=-1,i[0]=1;break;case 68:e[0]=1,i[1]=1;break;case 87:case 90:e[1]=-1;break;case 83:e[1]=1;break;case 37:e[2]=-1,i[0]=1;break;case 39:e[2]=1,i[1]=1;break;case 38:e[3]=-1;break;case 40:e[3]=1;break;case 32:e[4]=1;break;case 17:case 67:e[5]=1;break;case 69:e[6]=1;break;case 16:e[7]=1}this.gamepad.reset()}keyUp(t){var e=this.key,i=this.key2;if(t=t||window.event,this.sameAxis)switch(t.which){case 65:case 81:case 37:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:case 39:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:case 38:e[1]=e[1]<0?0:e[1];break;case 83:case 40:e[1]=e[1]>0?0:e[1];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}else switch(t.which){case 65:case 81:e[0]=e[0]<0?0:e[0],i[0]=0;break;case 68:e[0]=e[0]>0?0:e[0],i[1]=0;break;case 87:case 90:e[1]=e[1]<0?0:e[1];break;case 83:e[1]=e[1]>0?0:e[1];break;case 37:e[2]=e[2]<0?0:e[2],i[0]=0;break;case 39:e[2]=e[2]>0?0:e[2],i[1]=0;break;case 38:e[3]=e[3]<0?0:e[3];break;case 40:e[3]=e[3]>0?0:e[3];break;case 32:e[4]=0;break;case 17:case 67:e[5]=0;break;case 69:e[6]=0;break;case 16:e[7]=0}}}class Ye{constructor(t){this.values=[],this.ready=0,this.key=t}update(){var t,e,i,s,a,r,o=this.fix,n=navigator.getGamepads();for(t=0;t<n.length;t++)if(r=n[t])if(i=r.axes.length,s=r.buttons.length){for(this.values[t]||(this.values[t]=[]),e=0;e<i;e++)a=o(r.axes[e],.08),0==this.ready&&0!==a&&(this.ready=1),this.values[t][e]=a;for(e=0;e<s;e++)a=o(r.buttons[e].value),0==this.ready&&0!==a&&(this.ready=1),this.values[t][i+e]=a}else this.values[t]&&(this.values[t]=null)}getValue(t){for(var e,i=19;i--;)e=this.values[t][i],0==this.ready&&0!==e&&(this.ready=1),this.key[i]=e}reset(){this.ready=0}fix(t,e){let i=Number(t.toString().substring(0,5));return e&&i<e&&i>-e&&(i=0),i}}class Ze{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let t=this.list.length;for(;t--;)this.dispose(this.list[t]);this.list=[],this.id=0}byName(t){return this.Utils.byName(t)}setName(t={}){let e=void 0!==t.name?t.name:this.type+this.id++;return t.id=this.remove(e,!0),t.name=e,e}addToWorld(t,e=-1){this.Utils.add(t),-1!==e?this.list[e]=t:this.list.push(t)}remove(t,e){let i=this.byName(t);return i?this.clear(i,e):-1}clear(t,e){let i=this.list.indexOf(t);return-1===i||e?this.list[i]=null:this.list.splice(i,1),this.dispose(t),i}dispose(t){null!==t&&this.Utils.remove(t)}add(t={}){}set(t={}){}step(t,e){}}class $e extends Ze{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="ray",this.iType="ray"}step(t,e){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=e+a*ze.ray,i.update(t,s,this.motor.reflow.ray[a]||null)}add(t={}){this.setName(t);let e=new ti(t,this.motor);return e.visible=void 0===t.visible||t.visible,this.addToWorld(e,t.id),t.parent&&"string"!=typeof t.parent&&(t.parent=t.parent.name),t.callback&&delete t.callback,this.motor.post({m:"add",o:t}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.setRay(t)}}class ti extends Y{constructor(t={},i){super(new e,i.getMat("line")),this.motor=i,this.Utils=this.motor.utils,this.isRay=!0,this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=t.name,this.parentMesh=null,t.parent&&(this.parentMesh="string"==typeof t.parent?this.Utils.byName(t.parent):t.parent,this.data.parent=this.parentMesh),this.callback=t.callback||null,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new n,this.end=new n(0,1,0),this.tmp=new n,this.vnormal=new n,this.vv1=new n,this.vv2=new n,this.fullDistance=0,this.setRay(t);this.geometry.setAttribute("position",new s([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new s([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.noRotation=t.noRotation||!1,this.fakeMatrix=new l,this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(t){t.begin&&this.begin.fromArray(t.begin),t.end&&this.end.fromArray(t.end),this.fullDistance=this.begin.distanceTo(this.end)}update(t,e=0,i=null){if(this.data.hit=0!==t[e],this.data.body=i||"",this.data.distance=t[e+1],this.data.hit)this.local[0]=t[e+2],this.local[1]=t[e+3],this.local[2]=t[e+4],this.tmp.fromArray(t,e+5),this.vnormal.fromArray(t,e+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(fe.angleTo(this.vv1.toArray(),this.data.normal)*ue);else if(this.parentMesh){let t;t=this.noRotation?this.fakeMatrix.setPosition(this.parentMesh.position.x,this.parentMesh.position.y,this.parentMesh.position.z):this.parentMesh.matrixWorld,this.tmp.copy(this.begin).applyMatrix4(t).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(t),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback&&this.callback(this.data)}dispose(){this.callback=null,this.parentMesh=null,this.data={},this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let t=this.vertices.array,e=this.colors.array,i=this.local,s=this.data.hit,a=s?this.c2:this.c1,r=s?this.c3:this.c1;e[3]=a[0],e[4]=a[1],e[5]=a[2],e[6]=r[0],e[7]=r[1],e[8]=r[2],t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}class ei extends Z{constructor(t,e,i=0){super(t,e,i),this.matrixAutoUpdate=!1,this.tmpMatrix=new l,this.tmpQuat=new $,this.instanceUv=null,this.instanceColor=null,this.needSphereUp=!1,this.isRay=!0,this.overMaterial=null,this.currentOver=-1,this.isOver=!1,this.outline=null,this.tmpElement=[]}clearOutLine(){this.overMaterial&&this.outline&&(this.parent.remove(this.outline),this.outline=null,this.currentOver=-1)}addOutLine(t){this.overMaterial&&(this.outline||(this.outline=new tt(this.geometry,this.overMaterial)),this.outline.matrixAutoUpdate=!1,this.tmpMatrix.fromArray(this.instanceMatrix.array,16*t.idx),this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0,this.parent.add(this.outline),this.currentOver=t.idx)}over(t){t&&!this.instance.isOver&&(this.instance.isOver=!0,this.instance.addOutLine(this)),!t&&this.instance.isOver&&(this.instance.isOver=!1,this.instance.clearOutLine())}setColorAt(t,e){null===this.instanceColor&&(this.instanceColor=new et(new Float32Array(3*this.instanceMatrix.count),3)),e.isColor&&(e=e.toArray());let i=3*t;this.instanceColor.array[i]=e[0],this.instanceColor.array[i+1]=e[1],this.instanceColor.array[i+2]=e[2]}add(t,e=[0,0,0],i=[0,0,0,1],s=[1,1,1],a=null,r=null){3===i.length&&(i=this.tmpQuat.setFromEuler({_x:i[0],_y:i[1],_z:i[2],_order:"XYZ"},!1).toArray()),a&&(a.isColor&&(a=a.toArray()),null===this.instanceColor&&(this.instanceColor=new et(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(e,i,s,a,r),this.tmpElement.push(t)}slice(t,e,i){let s=new Float32Array(i-e);for(let a=0;a<e+i;++a)s[a]=t[e+a];return s}remove(t){if(!this.count)return;this.tmpElement.splice(t,1);let e=[...this.instanceMatrix.array];e.splice(16*t,16),this.instanceMatrix=new et(new Float32Array(e),16),null!==this.instanceColor&&(e=[...this.instanceColor.array],e.splice(3*t,3),this.instanceColor=new et(new Float32Array(e),3)),null!==this.instanceUv&&(e=[...this.instanceUv.array],e.splice(2*t,2),this.instanceUv=new et(new Float32Array(e),2)),this.count--,this.reDistribute()}reDistribute(){let t=this.count;for(;t--;)this.tmpElement[t].idx=t}getIDName(t){return this.tmpElement[t].name}getBodyList(){let t=[],e=this.count;for(;e--;)t.push(this.tmpElement[e].name);return t}expand(t,e,i,s=[1,1,1],a){let r=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:e[0],_y:e[1],_z:e[2],_w:e[3]},{x:i[0],y:i[1],z:i[2]}),this.instanceMatrix=new et(new Float32Array([...r,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(r=this.instanceColor.array,this.instanceColor=new et(new Float32Array([...r,...s]),3)),this.count++}setTransformAt(t,e,i,s){this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:i[0],_y:i[1],_z:i[2],_w:i[3]},{x:s[0],y:s[1],z:s[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*t),this.needSphereUp=!0,this.outline&&this.currentOver===t&&(this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0)}dispose(){this.clearOutLine(),this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.tmpElement=[],this.dispatchEvent({type:"dispose"})}setRaycast(t){void 0!==t&&(this.isRay=t)}raycast(t,e){this.isRay&&(this.instanceMatrix.needsUpdate=!0,super.raycast(t,e))}update(){this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp&&this.computeBoundingSphere(),this.needSphereUp=!1,this.updateMatrix()}}class ii{constructor(t=0,e=0,i=0,s=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=s}set(t,e,i,s){return this._x=t,this._y=e,this._z=i,this._w=s,this}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}}class si extends it{constructor(i,a,r,o,n=[0,1,0],l=[0,.5,0],h=!1){if(super(),!i)return;if(!a)return;const c=new e;let d=.5*a-i,p=12,u=.2*i,m=[];const b=[i,d,0,i,-d,0,-i,d,0,-i,-d,0,0,d,i-u,0,d,i+u];m.push(...n,...l,...n,...l,...l,...l),h&&(b.push(0,d,i,0,-d,i,0,d,-i,0,-d,-i),m.push(...n,...l,...n,...l));for(let t=0,e=1;t<p;t++,e++){const s=t/p*Math.PI*2,a=e/p*Math.PI*2;b.push(i*Math.cos(s),d,i*Math.sin(s),i*Math.cos(a),d,i*Math.sin(a),i*Math.cos(s),-d,i*Math.sin(s),i*Math.cos(a),-d,i*Math.sin(a)),m.push(...n,...n,...l,...l)}for(let t=0,e=1;t<p;t++,e++){const s=t/p*Math.PI*2,a=e/p*Math.PI*2;let r=e<=6?1:-1;b.push(i*Math.cos(s),d*r+i*Math.sin(s),0,i*Math.cos(a),d*r+i*Math.sin(a),0),1===r?m.push(...n,...n):m.push(...l,...l),h&&(b.push(0,d*r+i*Math.sin(s),i*Math.cos(s),0,d*r+i*Math.sin(a),i*Math.cos(a)),1===r?m.push(...n,...n):m.push(...l,...l))}if(c.setAttribute("position",new s(b,3)),c.setAttribute("color",new s(m,3)),c.computeBoundingSphere(),this.colors=c.attributes.color.array,this.colorsbase=[...this.colors],this.geometry=c,this.cone=new t(c,o),this.cone.raycast=function(){return!1},this.cone.updateMorphTargets=()=>{},this.cone.name="cone",this.add(this.cone),this.isOver=!1,this.matrixAutoUpdate=!1,this.type="CapsuleHelper",!r)return;const g=new e,f=[.5*u,-d,i-u,.5*u,-d,i+u,.5*-u,-d,i-u,.5*-u,-d,i+u,.5*u,-d,i-u,.5*-u,-d,i-u,.5*-u,-d,i+u,-u,-d,i+u,.5*u,-d,i+u,u,-d,i+u,-u,-d,i+u,0,-d,i+2*u,u,-d,i+u,0,-d,i+2*u];m=[];let y=f.length/3;for(;y--;)m.push(1,0,0);g.setAttribute("position",new s(f,3)),g.setAttribute("color",new s(m,3)),this.direction=new t(g,o),this.direction.raycast=function(){return!1},this.add(this.direction)}over(t){t?this.isOver||(this.isOver=!0,this.changeColor(this.isOver)):this.isOver&&(this.isOver=!1,this.changeColor(this.isOver))}changeColor(t){let e=this.colors.length;for(;e--;)this.colors[e]=t?1:this.colorsbase[e];this.geometry&&(this.geometry.attributes.color.needsUpdate=!0)}setDirection(t){this.direction&&(this.direction.rotation.y=t)}dispose(){this.geometry.dispose(),this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){return!1}update(){}}const ai=new n,ri=new st,oi=new at,ni=new n,li=new rt;class hi{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new ui,this.unassigned=new ui,this.vertices=[]}setFromPoints(t){if(t.length>=4){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.vertices.push(new pi(t[e]));this._compute()}return this}setFromObject(t){const e=[];return t.updateMatrixWorld(!0),t.traverse((function(t){const i=t.geometry;if(void 0!==i){const s=i.attributes.position;if(void 0!==s)for(let i=0,a=s.count;i<a;i++){const a=new n;a.fromBufferAttribute(s,i).applyMatrix4(t.matrixWorld),e.push(a)}}})),this.setFromPoints(e)}containsPoint(t){const e=this.faces;for(let i=0,s=e.length;i<s;i++){if(e[i].distanceToPoint(t)>this.tolerance)return!1}return!0}intersectRay(t,e){const i=this.faces;let s=-1/0,a=1/0;for(let e=0,r=i.length;e<r;e++){const r=i[e],o=r.distanceToPoint(t.origin),n=r.normal.dot(t.direction);if(o>0&&n>=0)return null;const l=0!==n?-o/n:0;if(!(l<=0)&&(n>0?a=Math.min(l,a):s=Math.max(l,s),s>a))return null}return s!==-1/0?t.at(s,e):t.at(a,e),e}intersectsRay(t){return null!==this.intersectRay(t,ai)}makeEmpty(){return this.faces=[],this.vertices=[],this}_addVertexToFace(t,e){return t.face=e,null===e.outside?this.assigned.append(t):this.assigned.insertBefore(e.outside,t),e.outside=t,this}_removeVertexFromFace(t,e){return t===e.outside&&(null!==t.next&&t.next.face===e?e.outside=t.next:e.outside=null),this.assigned.remove(t),this}_removeAllVerticesFromFace(t){if(null!==t.outside){const e=t.outside;let i=t.outside;for(;null!==i.next&&i.next.face===t;)i=i.next;return this.assigned.removeSubList(e,i),e.prev=i.next=null,t.outside=null,e}}_deleteFaceVertices(t,e){const i=this._removeAllVerticesFromFace(t);if(void 0!==i)if(void 0===e)this.unassigned.appendChain(i);else{let t=i;do{const i=t.next;e.distanceToPoint(t.point)>this.tolerance?this._addVertexToFace(t,e):this.unassigned.append(t),t=i}while(null!==t)}return this}_resolveUnassignedPoints(t){if(!1===this.unassigned.isEmpty()){let e=this.unassigned.first();do{const i=e.next;let s=this.tolerance,a=null;for(let i=0;i<t.length;i++){const r=t[i];if(0===r.mark){const t=r.distanceToPoint(e.point);if(t>s&&(s=t,a=r),s>1e3*this.tolerance)break}}null!==a&&this._addVertexToFace(e,a),e=i}while(null!==e)}return this}_computeExtremes(){const t=new n,e=new n,i=[],s=[];for(let t=0;t<3;t++)i[t]=s[t]=this.vertices[0];t.copy(this.vertices[0].point),e.copy(this.vertices[0].point);for(let a=0,r=this.vertices.length;a<r;a++){const r=this.vertices[a],o=r.point;for(let e=0;e<3;e++)o.getComponent(e)<t.getComponent(e)&&(t.setComponent(e,o.getComponent(e)),i[e]=r);for(let t=0;t<3;t++)o.getComponent(t)>e.getComponent(t)&&(e.setComponent(t,o.getComponent(t)),s[t]=r)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(t.x),Math.abs(e.x))+Math.max(Math.abs(t.y),Math.abs(e.y))+Math.max(Math.abs(t.z),Math.abs(e.z))),{min:i,max:s}}_computeInitialHull(){const t=this.vertices,e=this._computeExtremes(),i=e.min,s=e.max;let a=0,r=0;for(let t=0;t<3;t++){const e=s[t].point.getComponent(t)-i[t].point.getComponent(t);e>a&&(a=e,r=t)}const o=i[r],n=s[r];let l,h;a=0,ri.set(o.point,n.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==o&&i!==n){ri.closestPointToPoint(i.point,!0,ni);const t=ni.distanceToSquared(i.point);t>a&&(a=t,l=i)}}a=-1,oi.setFromCoplanarPoints(o.point,n.point,l.point);for(let e=0,i=this.vertices.length;e<i;e++){const i=t[e];if(i!==o&&i!==n&&i!==l){const t=Math.abs(oi.distanceToPoint(i.point));t>a&&(a=t,h=i)}}const c=[];if(oi.distanceToPoint(h.point)<0){c.push(ci.create(o,n,l),ci.create(h,n,o),ci.create(h,l,n),ci.create(h,o,l));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge(e)),c[t+1].getEdge(1).setTwin(c[e+1].getEdge(0))}}else{c.push(ci.create(o,l,n),ci.create(h,o,n),ci.create(h,n,l),ci.create(h,l,o));for(let t=0;t<3;t++){const e=(t+1)%3;c[t+1].getEdge(2).setTwin(c[0].getEdge((3-t)%3)),c[t+1].getEdge(0).setTwin(c[e+1].getEdge(1))}}for(let t=0;t<4;t++)this.faces.push(c[t]);for(let e=0,i=t.length;e<i;e++){const i=t[e];if(i!==o&&i!==n&&i!==l&&i!==h){a=this.tolerance;let t=null;for(let e=0;e<4;e++){const s=this.faces[e].distanceToPoint(i.point);s>a&&(a=s,t=this.faces[e])}null!==t&&this._addVertexToFace(i,t)}}return this}_reindexFaces(){const t=[];for(let e=0;e<this.faces.length;e++){const i=this.faces[e];0===i.mark&&t.push(i)}return this.faces=t,this}_nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let t,e=0;const i=this.assigned.first().face;let s=i.outside;do{const a=i.distanceToPoint(s.point);a>e&&(e=a,t=s),s=s.next}while(null!==s&&s.face===i);return t}}_computeHorizon(t,e,i,s){let a;this._deleteFaceVertices(i),i.mark=1,a=null===e?e=i.getEdge(0):e.next;do{const e=a.twin,i=e.face;0===i.mark&&(i.distanceToPoint(t)>this.tolerance?this._computeHorizon(t,e,i,s):s.push(a)),a=a.next}while(a!==e);return this}_addAdjoiningFace(t,e){const i=ci.create(t,e.tail(),e.head());return this.faces.push(i),i.getEdge(-1).setTwin(e.twin),i.getEdge(0)}_addNewFaces(t,e){this.newFaces=[];let i=null,s=null;for(let a=0;a<e.length;a++){const r=e[a],o=this._addAdjoiningFace(t,r);null===i?i=o:o.next.setTwin(s),this.newFaces.push(o.face),s=o}return i.next.setTwin(s),this}_addVertexToHull(t){const e=[];return this.unassigned.clear(),this._removeVertexFromFace(t,t.face),this._computeHorizon(t.point,null,t.face,e),this._addNewFaces(t,e),this._resolveUnassignedPoints(this.newFaces),this}_cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}_compute(){let t;for(this._computeInitialHull();void 0!==(t=this._nextVertexToAdd());)this._addVertexToHull(t);return this._reindexFaces(),this._cleanup(),this}}class ci{constructor(){this.normal=new n,this.midpoint=new n,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(t,e,i){const s=new ci,a=new di(t,s),r=new di(e,s),o=new di(i,s);return a.next=o.prev=r,r.next=a.prev=o,o.next=r.prev=a,s.edge=a,s.compute()}getEdge(t){let e=this.edge;for(;t>0;)e=e.next,t--;for(;t<0;)e=e.prev,t++;return e}compute(){const t=this.edge.tail(),e=this.edge.head(),i=this.edge.next.head();return li.set(t.point,e.point,i.point),li.getNormal(this.normal),li.getMidpoint(this.midpoint),this.area=li.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(t){return this.normal.dot(t)-this.constant}}class di{constructor(t,e){this.vertex=t,this.prev=null,this.next=null,this.twin=null,this.face=e}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceTo(t.point):-1}lengthSquared(){const t=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(t.point):-1}setTwin(t){return this.twin=t,t.twin=this,this}}class pi{constructor(t){this.point=t,this.prev=null,this.next=null,this.face=null}}class ui{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(t,e){return e.prev=t.prev,e.next=t,null===e.prev?this.head=e:e.prev.next=e,t.prev=e,this}insertAfter(t,e){return e.prev=t,e.next=t.next,null===e.next?this.tail=e:e.next.prev=e,t.next=e,this}append(t){return null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail,t.next=null,this.tail=t,this}appendChain(t){for(null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail;null!==t.next;)t=t.next;return this.tail=t,this}remove(t){return null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,this}removeSubList(t,e){return null===t.prev?this.head=e.next:t.prev.next=e.next,null===e.next?this.tail=t.prev:e.next.prev=t.prev,this}isEmpty(){return null===this.head}}class mi extends e{constructor(t=[]){super();const e=[],i=[],a=(new hi).setFromPoints(t).faces;for(let t=0;t<a.length;t++){const s=a[t];let r=s.edge;do{const t=r.head().point;e.push(t.x,t.y,t.z),i.push(s.normal.x,s.normal.y,s.normal.z),r=r.next}while(r!==s.edge)}this.setAttribute("position",new s(e,3)),this.setAttribute("normal",new s(i,3))}}let bi=null,gi=null;const fi=new n(0,1,0),yi=new n(1,0,0),vi=new n(0,0,1);class xi extends Ze{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,bi=this.motor.geo,gi=this.motor.mat,this.type="body",this.num=ze[this.type],this.full=!1,this.needMatrix="RAPIER"===this.engine||"HAVOK"===this.engine}setFull(t){this.num=ze[t?"bodyFull":"body"],this.full=t}step(t,e){const i=this.list;let s,a,r,o=i.length;for(;o--;)if(s=i[o],null!==s)if(a=e+o*this.num,s.actif){if(s.sleep=!(t[a]>0),s.defMat&&(s.isInstance?s.instance.setColorAt(s.idx,s.sleep?He.sleep:He.body):(s.sleep||"sleep"!==s.material.name||(s.material=gi.get("body")),s.sleep&&"body"===s.material.name&&(s.material=gi.get("sleep")))),!s.sleep||s.isKinematic)if(s.position.fromArray(t,a+1),s.quaternion.fromArray(t,a+4),1!==this.motor.ws&&s.position.multiplyScalar(this.motor.uws),this.full?(s.velocity.fromArray(t,a+8),s.angular.fromArray(t,a+11)):s.getVelocity&&(r=this.motor.reflow.velocity[s.name],r&&(s.velocity.fromArray(r,0),s.angular.fromArray(r,3))),s.isInstance){if(s.speedMat){let e=.01*t[a];s.instance.setColorAt(s.idx,[e,e,e])}s.instance.setTransformAt(s.idx,s.position.toArray(),s.quaternion.toArray(),s.noScale?[1,1,1]:s.size),this.needMatrix&&s.matrixWorld.compose(s.position,s.quaternion,{x:1,y:1,z:1})}else s.auto||s.updateMatrix()}else s.actif=!0}geometry(t={},i=null,s=null){let a,r,o,l=t.size,c="",d=t.type,u=!1,m=!1,b=t.seg||16;const g="OIMO"===this.engine||"JOLT"===this.engine||"AMMO"===this.engine||"CANNON"===this.engine;if(t.instance&&"compound"===d&&(d=t.shapes[0].type,l=t.shapes[0].size,t.translate=t.shapes[0].pos),"mesh"!==d&&"convex"!==d||(t.shape?t.shape.isMesh&&(t.shape=t.shape.geometry):t.mesh&&!t.v&&(t.shape=t.mesh.geometry)),t.radius&&("box"===d&&(d="ChamferBox"),"cylinder"===d&&(d="ChamferCyl")),t.geometry&&("convex"===d?t.shape=t.geometry:d="direct"),"PHYSX"===this.engine&&"cylinder"===t.type){let e=new h(t.size[0],t.size[0],t.size[1],b,1);t.isWheel&&e.rotateZ(-be),t.v=fe.getVertex(e),t.type="convex"}if(("PHYSX"===this.engine||"HAVOK"===this.engine||"JOLT"===this.engine)&&"cone"===t.type){let e=new h(0,t.size[0],t.size[1],b,1);t.v=fe.getVertex(e),t.type="convex"}switch("stair"===t.type&&(t.type="box",d="box"),d){case"direct":a=t.geometry.clone(),t.size&&a.scale(t.size[0],t.size[1],t.size[2]),m=!0,u=!0;break;case"convex":if(t.v){if(t.nogeo)a=new e;else{let e=[];for(r=Math.floor(t.v.length/3);r--;)o=3*r,e.push(new n(t.v[o],t.v[o+1],t.v[o+2]));a=new mi(e)}m=!0,u=!0}if(t.shape){a=t.shape.clone(),t.size&&a.scale(t.size[0],t.size[0],t.size[0]),t.shapeScale&&a.scale(t.shapeScale[0],t.shapeScale[1],t.shapeScale[2]);let e=g?fe.toNonIndexed(a):null;t.v=fe.getVertex(e||a,g),t.index=fe.getIndex(e||a,g),this.engine,m=!0,u=!0}a.boundingBox||a.computeBoundingBox();let i=a.boundingBox;t.boxSize=[-i.min.x+i.max.x,-i.min.y+i.max.y,-i.min.z+i.max.z];break;case"mesh":if(a=t.shape.clone(),t.size&&a.scale(t.size[0],t.size[0],t.size[0]),t.v=fe.getVertex(a,g),t.index=fe.getIndex(a,g),"PHYSX"===this.engine){let e=new n;fe.getCenter(a,e),t.massCenter||(t.massCenter=e.toArray())}m=!0,u=!0;break;case"customSphere":c="customSphere_"+l[0],a=bi.get(c),a?c="":(a=new p(l[0],t.seg1||32,t.seg2||16),a.name=c),u=!0,t.type="sphere";break;case"capsule":c="capsule_"+l[0]+"_"+l[1]+"_"+b,a=bi.get(c),a?c="":(a=new _e(l[0],l[1],b),a.name=c),u=!0;break;case"ChamferBox":c="ChamferBox_"+l[0]+"_"+l[1]+"_"+l[2]+"_"+t.radius,a=bi.get(c),a?c="":(a=new Le(l[0],l[1],l[2],t.radius),a.name=c),u=!0;break;case"ChamferCyl":c="ChamferCyl_"+l[0]+"_"+l[1]+"_"+l[2]+"_"+t.radius+"_"+b,a=bi.get(c),a?c="":(a=new je(l[0],l[0],l[1],t.radius,b),a.name=c),u=!0;break;default:t.breakable?(a=bi.get(d).clone(),a.scale(l[0],l[1],l[2]),m=!0,u=!0):a=bi.get(d),"highSphere"===d&&(t.type="sphere")}if(t.translate&&a.translate(t.translate[0],t.translate[1],t.translate[2]),t.shape&&delete t.shape,t.geometry&&delete t.geometry,(void 0===a.attributes.uv||t.autoUV)&&Be(a,"box",5,t.pos,t.quat),""!==c&&bi.set(a),t.isWheel&&(a=a.clone(),a.rotateZ(-be),m=!0),m&&bi.unic(a),null===i&&null===s)return a.noScale=u,a;t.meshRemplace&&t.debug&&(s=gi.get("debug"));let f=new tt(a,s);if(t.button&&(f.isButton=!0),t.helper){let e=t.hcolor||[.3,.1,0],i=t.hcolor2||[.8,.2,0],s=new si(l[0],l[1]+2*l[0],!1,gi.get("liner"),e,i,!0);f.add(s),f.userData.helper=s}t.localRot&&(t.localQuat=fe.quatFromEuler(t.localRot)),t.localPos&&f.position.fromArray(t.localPos),t.localQuat&&f.quaternion.fromArray(t.localQuat),u||f.scale.fromArray(t.size),void 0!==t.ray&&(t.ray||(f.raycast=()=>{})),t.meshRemplace&&!t.debug||(i.add(f),f.userData.helper&&(i.over=t=>{f.userData.helper.over(t)}))}add(t={}){t.worldScale&&delete(t=this.scaler(t,t.worldScale)).worldScale;let e,i,s,a=0;if(t.instance||(s=this.setName(t)),t.type=void 0===t.type?"box":t.type,"plane"!==t.type||t.visible||(t.visible=!1),"stair"===t.type){let e=new n(0,0,t.size[2]),i=new n(0,.5*t.size[1],.5*t.size[2]),s=e.angleTo(i),a=e.distanceTo(i);t.rot=[s*ue,0,0],t.size[1]*=t.div||.2,t.size[2]=2*a;let r=new n(0,.5*-t.size[1],0);r.applyAxisAngle({x:1,y:0,z:0},s),t.pos[1]+=r.y,t.pos[2]+=r.z}if(t.massCenter&&-1===ye.indexOf(this.engine))if("compound"!==t.type)t.shapes=[{type:t.type,pos:t.massCenter,size:t.size}],t.seg&&(t.shapes[0].seg=t.seg),t.radius&&(t.shapes[0].radius=t.radius),delete t.size,t.type="compound";else for(e=0;e<t.shapes.length;e++)i=t.shapes[e],i.pos?i.pos=fe.addArray(i.pos,t.massCenter):i.pos=t.massCenter;void 0!==t.collision&&!1===t.collision&&("PHYSX"===this.engine&&(t.flags=0),"OIMO"===this.engine&&(t.mask=0)),t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=fe.quatFromEuler(t.rot)),void 0!==t.meshRot&&(t.meshQuat=fe.quatFromEuler(t.meshRot)),t.size=fe.autoSize(t.size,t.type),t.meshScale&&(t.meshScale=fe.autoSize(t.meshScale));let r,o=!1;!1===t.visible&&(t.material="hide"),void 0!==t.material?r=t.material.constructor===String?gi.get(t.material):t.material:(o=!0,r=gi.get(this.type),t.instance&&(r=gi.get("base"))),t.unicMat&&(r=r.clone(),gi.addToTmp(r));let h=t.instance?{}:new it;if(t.mesh&&!t.instance){"terrain"===t.mesh.type&&(t.noClone=!0);let e=t.noClone?t.mesh:t.mesh.clone();if(e.position.fromArray(t.meshPos||[0,0,0]),t.meshQuat&&e.quaternion.fromArray(t.meshQuat),t.meshSize&&e.scale.set(1,1,1).multiplyScalar(t.meshSize),t.meshScale&&e.scale.fromArray(t.meshScale),!o&&(e.material=r,e.children&&!t.nofullmat))for(let t in e.children)e.children[t].material=r;this.motor.tmpMesh.push(e),t.meshRemplace=!0,h.add(e)}switch(t.type){case"null":break;case"compound":for(e=0;e<t.shapes.length;e++)i=t.shapes[e],i.type=void 0===i.type?"box":i.type,i.size=fe.autoSize(i.size,i.type),i.pos&&(i.localPos=i.pos),void 0!==i.rot&&(i.quat=fe.quatFromEuler(i.rot)),i.quat&&(i.localQuat=i.quat),i.debug=t.debug,i.meshRemplace=t.meshRemplace||!1,t.instance?"convex"===i.type&&(i.v=fe.getVertex(i.shape,!1)):this.geometry(i,h,r),a+=fe.getVolume(i.type,i.size,i.v);break;default:t.instance?"convex"===t.type&&(t.v=fe.getVertex(t.shape,!1)):this.geometry(t,h,r),a=fe.getVolume(t.type,t.size,t.v)}if(h.type=this.type,h.size=t.size,h.shapetype=t.type,h.isKinematic=t.kinematic||!1,h.link=0,h.meshSize=t.meshSize?t.meshSize:1,h.velocity=new n,h.angular=new n,h.sleep=t.sleep||!1,h.defMat=!1,t.button&&(h.isButton=!0),h.isRay=void 0===t.ray||t.ray,h.material&&o&&(h.defMat="body"===h.material.name),t.instance){h.isInstance=!0,h.instance=this.getInstance(t,r),h.instance.isRay=h.isRay,h.over=h.instance.over,h.isRay=!1,h.isOver=!1,h.speedMat=t.speedMat||!1,h.defMat="base"===h.instance.material.name,h.idx=h.instance.count,h.name=t.name?t.name:h.instance.name+h.idx,t.name=h.name,h.noScale=h.instance.noScale,t.sizeByInstance&&(h.noScale=!1);let e=t.color;h.defMat&&(e=t.sleep?He.sleep:He.body),h.instance.add(h,t.pos,t.quat,h.noScale?[1,1,1]:h.size,e),h.position=(new n).fromArray(t.pos),h.quaternion=(new ii).fromArray(t.quat),this.needMatrix&&(h.matrixWorld=new l),h.instance.v&&(t.v=h.instance.v),h.instance.index&&(t.index=h.instance.index),t.type=h.instance.type,h.actif=!1}else h.name=s,h.isRay||h.traverse((function(t){t.isObject3D&&(t.raycast=()=>{})})),t.renderOrder&&(h.renderOrder=t.renderOrder),void 0===t.visible&&(t.visible=!0),void 0===t.shadow&&(t.shadow=t.visible),h.dispose=function(){this.clearOutLine&&this.clearOutLine(),this.traverse((function(t){t.isMesh&&t.unic&&t.geometry.dispose()})),this.children=[]}.bind(h),h.visible=void 0===t.visible||t.visible,Object.defineProperty(h,"material",{get(){return this.children[0]?this.children[0].material:null},set(t){this.traverse((function(e){e.isMesh&&"outline"!==e.name&&(e.material=t)}))}}),Object.defineProperty(h,"castShadow",{get(){return!!this.children[0]&&this.children[0].castShadow},set(t){this.traverse((function(e){e.isMesh&&(e.castShadow=t)}))}}),Object.defineProperty(h,"receiveShadow",{get(){return!!this.children[0]&&this.children[0].receiveShadow},set(t){this.traverse((function(e){e.isMesh&&(e.receiveShadow=t)}))}}),h.receiveShadow=t.shadow,h.castShadow=t.shadow,this.motor.mouseActive&&(h.overMaterial=gi.get("outline"),h.isOver=!1,h.addOutLine=function(){this.children[0].isMesh&&(this.outline=(new tt).copy(this.children[0]),this.outline.name="outline",this.outline.material=this.overMaterial,this.outline.matrixAutoUpdate=!1,this.outline.receiveShadow=!1,this.outline.castShadow=!1,this.outline.raycast=()=>!1,this.add(this.outline))}.bind(h),h.clearOutLine=function(){this.outline&&(this.remove(this.outline),this.outline=null)}.bind(h),h.over=function(t){t&&!this.isOver&&this.addOutLine(),!t&&this.isOver&&this.clearOutLine(),this.isOver=t}.bind(h),h.select=function(t){}.bind(h)),this.set(t,h);if(t.breakable){let e=h,i=e.children[0];e.remove(i),h=i,h.position.copy(e.position),h.quaternion.copy(e.quaternion),h.name=s,h.type=this.type,h.breakable=!0,h.breakOption=void 0!==t.breakOption?t.breakOption:[250,1,2,1],h.ignore=t.ignore||[],h.size=t.size,h.shapetype=t.type,h.isKinematic=t.kinematic||!1,h.link=0,h.meshSize=t.meshSize?t.meshSize:1,h.velocity=new n,h.angular=new n,h.sleep=t.sleep||!1,h.defMat=!1,h.auto=t.auto||!1,h.auto?h.matrixAutoUpdate=!0:(h.matrixAutoUpdate=!1,h.updateMatrix())}if(h.mass=t.mass||0,h.density=t.density||0,h.density&&!h.mass?h.mass=fe.massFromDensity(h.density,a):h.mass&&!h.density&&(h.density=fe.densityFromMass(h.mass,a),"RAPIER"!==this.engine&&"OIMO"!==this.engine&&"PHYSX"!==this.engine||(t.density=h.density)),t.massInfo&&console.log("%c"+h.name+" %cdensity:"+h.density+" mass:"+h.mass,"font-size:16px","font-size:12px"),t.getVelocity&&(h.getVelocity=!0),this.addToWorld(h,t.id),t.onlyMakeMesh)return h;if(t.phySize&&(t.size=t.phySize),t.phyPos&&(t.pos=t.phyPos),t.rot&&delete t.rot,t.mesh&&delete t.mesh,t.meshRot&&delete t.meshRot,t.instance&&delete t.instance,t.material&&delete t.material,t.parent&&delete t.parent,t.solver&&"PHYSX"===this.engine){t.mass=h.mass;this.byName(t.solver).addBone(t.name)}if(t.sleep&&this.set(t,h),this.motor.post({m:"add",o:t}),t.breakable){this.motor.getBreaker().add(h)}return h}dispatchEvent(t,e,i){this.byName(t).dispatchEvent({type:e,data:i})}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(void 0!==t.getVelocity&&(e.getVelocity=t.getVelocity),e.isInstance?(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),(t.pos||t.quat)&&e.instance.setTransformAt(e.idx,e.position.toArray(),e.quaternion.toArray(),e.noScale?[1,1,1]:e.size)):(t.pos&&e.position.fromArray(t.pos),t.quat&&e.quaternion.fromArray(t.quat),e.auto=t.auto||!1,e.auto?e.matrixAutoUpdate=!0:(e.matrixAutoUpdate=!1,e.updateMatrix())))}getTransform(t){if("string"==typeof t&&(t=this.byName(o.name)),null===t)return;t.updateWorldMatrix(!0,!1);const e=t.matrixWorld.elements;return{position:t.position.clone(),up:fi.clone().set(e[4],e[5],e[6]).normalize(),right:yi.clone().set(e[0],e[1],e[2]).normalize(),forward:vi.clone().set(e[8],e[9],e[10]).normalize()}}clearInstance(t){let e=this.motor.instanceMesh[t],i=e.getBodyList();this.motor.remove(i),e.dispose(),delete this.motor.instanceMesh[t]}getInstance(t,e){if(this.motor.instanceMesh[t.instance])return this.motor.instanceMesh[t.instance];(t={...t}).sizeByInstance&&(t.size=[1,1,1]);let i=this.geometry(t);t.mesh&&(!t.material&&t.mesh.material&&(e=t.mesh.material),i=t.mesh.isObject3D?t.mesh.geometry.clone():t.mesh.clone(),t.meshSize&&i.scale(t.meshSize,t.meshSize,t.meshSize),t.meshScale&&i.scale(t.meshScale[0],t.meshScale[1],t.meshScale[2]),i.noScale=!0);let s=new ei(i,e,0);return s.type=t.type,s.noScale=i.noScale,"convex"===s.type&&(s.v=t.v),t.index&&(s.index=t.index),s.receiveShadow=void 0===t.shadow||t.shadow,s.castShadow=void 0===t.shadow||t.shadow,this.motor.mouseActive&&(s.overMaterial=gi.get("outline")),s.name=t.instance,this.motor.scene.add(s),this.motor.instanceMesh[t.instance]=s,s}scaler(t,e){if(t.size&&(t.size=math.worldscale(t.size,e)),t.pos&&(t.pos=math.worldscale(t.pos,e)),"convex"===t.type&&(t.shapeScale=[e,e,e]),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(i.size=math.scaleArray(i.size,e)),i.pos&&(i.pos=math.scaleArray(i.pos,e)),"convex"===i.type&&(i.shapeScale=[e,e,e])}return t.mesh&&(t.meshScale=[e,e,e]),t}}class wi extends tt{constructor(t,e={},i=null){if(super(),this.model=t,this.material=i,this.outMaterial=!!i,this.XML=new XMLSerializer,this.color=new x,this.opacity=1,this.svgLoader=new ee,this.base="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.base,"svg"),this.layerUp=1e-4,this.fill=!0,this.stroke=!0,this.size=e.size||1,this.scaler=1/this.size,!this.model)return;let s={radius:5,min:90,max:90,strokeSize:.25,...e};switch(this.model){case"angle":this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke;let t=Math.abs(s.min);this.add("path",{d:this.circle(0,0,s.radius,180,180+s.max,!0),stroke:"none",fill:"#FF0000","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,s.radius,180,180+s.max,!1,!1,.3),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"}),this.add("path",{d:this.circle(0,0,s.radius,180-t,180,!0),stroke:"none",fill:"#0050FF","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,s.radius,180-t,180,!1,!1,.3,!0),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"});break;case"liner":let e=.5*s.radius,i=s.max*this.scaler,a=s.min*this.scaler;this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.segment({x:-e,y:0},{x:e,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:i},{x:e,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-e,y:a},{x:e,y:a}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:i}),stroke:"#FF0000","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:a}),stroke:"#0050FF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"});break;case"needle":this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:4.4}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"round"});break;case"middle":let r=.5*s.radius;this.fill=void 0===s.fill||s.fill,this.stroke=void 0===s.stroke||s.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:-r},{x:0,y:r}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:-r,y:0},{x:r,y:0}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":s.strokeSize,fill:"none","stroke-linecap":"butt"})}this.toMesh()}raycast(){return!1}update(t={}){let e={};if("angle"===this.model){e={radius:5,min:-90,max:90,...t};let i=Math.abs(e.min);this.change("d",this.circle(0,0,e.radius,180,180+e.max,!0),0),this.change("d",this.circle(0,0,e.radius,180,180+e.max,!1,!1,.3),1),this.change("d",this.circle(0,0,e.radius,180-i,180,!0),2),this.change("d",this.circle(0,0,e.radius,180-i,180,!1,!1,.3,!0),3)}void 0!==t.wireframe&&(this.material.wireframe=t.wireframe),this.fill=void 0===e.fill||e.fill,this.stroke=void 0===e.stroke||e.stroke,this.toMesh()}set(t={},e){for(let i in t)e?e.setAttributeNS(null,i,t[i]):this.svg.setAttributeNS(null,i,t[i])}add(t,e={}){let i=document.createElementNS(this.base,t);this.set(e,i),this.svg.appendChild(i)}change(t,e,i){this.svg.childNodes[i].setAttributeNS(null,t,e)}getString(){return this.XML.serializeToString(this.svg)}polarToCartesian(t,e,i,s){var a=(s-90)*Math.PI/180;return{x:t+i*Math.cos(a),y:e+i*Math.sin(a)}}circle(t,e,i,s=0,a=360,r=!1,o=!1,n=0,l=!1){0===s&&360===a&&(s=1e-4,o=!0);let h=this.polarToCartesian(t,e,i,a),c=this.polarToCartesian(t,e,i,s),d=a-s<=180?"0":"1",p=["M",h.x,h.y,"A",i,i,0,d,0,c.x,c.y];if(r&&p.push("L",t,e,"L",h.x,h.y),o&&p.push("Z"),0!==n){let r=this.polarToCartesian(t,e,i-n,l?s:a),o=this.polarToCartesian(t,e,i+n,l?s:a);p.push("M",r.x,r.y,"L",o.x,o.y)}return p.join(" ")}segment(t,e){return["M",t.x,t.y,"L",e.x,e.y].join(" ")}geomColor(t,e,i=1){let a=t.attributes.position.count,r=[];for(;a--;)r.push(e.r,e.g,e.b,i);t.setAttribute("color",new s(r,4))}toGeometry(){if(!this.fill&&!this.stroke)return null;let t=[],i=0,s=1,a=this.svgLoader.parse(this.getString());for(const r of a.paths){const a=r.userData.style.fill;if(this.fill&&void 0!==a&&"none"!==a){this.color.setStyle(a),s=r.userData.style.fillOpacity,s<this.opacity&&(this.opacity=s);const o=ee.createShapes(r);for(const a of o){const r=new ot(a);if(r){this.geomColor(r,this.color,s);let a=(new e).copy(r).toNonIndexed();a.translate(0,0,-i*this.layerUp),t.push(a),i++}}}const o=r.userData.style.stroke;if(this.stroke&&void 0!==o&&"none"!==o){this.color.setStyle(o),s=r.userData.style.strokeOpacity,s<this.opacity&&(this.opacity=s);for(const e of r.subPaths){const a=ee.pointsToStroke(e.getPoints(),r.userData.style,6);a&&(this.geomColor(a,this.color,s),a.translate(0,0,-i*this.layerUp),t.push(a),i++)}}}return t}toMesh(){let t=this.size;this.geometry&&this.geometry.dispose();let i=this.toGeometry();i?(this.geometry=$t(i),this.geometry.scale(t,-t,t),this.geometry.rotateY(Math.PI),this.geometry.rotateZ(.5*-Math.PI),this.geometry.rotateY(.5*Math.PI),this.geometry.computeBoundingSphere()):this.geometry=new e,null===this.material&&(this.material=new S({vertexColors:!0,transparent:1!==this.opacity,side:E}),this.material.defines={USE_COLOR_ALPHA:""})}dispose(){this.material&&!this.outMaterial&&this.material.dispose(),this.geometry&&this.geometry.dispose()}}class ki extends it{constructor(i={},a){super(),this.motor=a,this.isJoint=!0,this.type="joint",this.mode=i.mode||"hinge",this.visible=void 0!==i.visible&&i.visible,this.mtx=new l,this.size=i.helperSize||.1,this.matrixAutoUpdate=!1;let r,o,h=this.motor.mat.get("line");switch(this.mode){case"prismatic":r=this.motor.mat.get("svg"),o={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},i.lm&&(o.min=i.lm[0],o.max=i.lm[1]),this.m1=new wi("liner",o,r),this.m2=new wi("middle",o,r),this.m1.geometry.rotateY(90*fe.torad),this.add(this.m1),this.add(this.m2);break;case"hinge":case"cylindrical":r=this.motor.mat.get("svg"),o={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.5*this.size},i.lm&&(o.min=i.lm[0],o.max=i.lm[1]),i.lmr&&(o.min=i.lmr[0],o.max=i.lmr[1]),this.m1=new wi("angle",o,r),this.m2=new wi("needle",o,r),this.add(this.m1),this.add(this.m2);break;default:const e=this.motor.geo.get("joint");let s=e.clone();s.scale(this.size,this.size,this.size),this.m1=new t(s,h),this.add(this.m1),s=e.clone(),s.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new t(s,h),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new l,this.mat2=new l,this.end=new n;let c=new $;i.quat1&&this.mat1.makeRotationFromQuaternion(c.fromArray(i.quat1)),i.quat2&&this.mat2.makeRotationFromQuaternion(c.fromArray(i.quat2)),this.mat1.setPosition(i.pos1[0],i.pos1[1],i.pos1[2]),this.mat2.setPosition(i.pos2[0],i.pos2[1],i.pos2[2]);const d=new e;d.setAttribute("position",new s([0,0,0,0,0,0],3)),d.setAttribute("color",new s([1,0,0,1,0,0],3)),d.computeBoundingSphere(),this.m3=new t(d,h),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()))}updateFromPhy(t,e=0){this.visible&&(this.position.fromArray(t,e),this.quaternion.fromArray(t,e+3),this.updateMatrix(),this.m2.position.fromArray(t,e+7),this.m2.quaternion.fromArray(t,e+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class Mi extends Ze{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.type="joint",this.v1=new n,this.v2=new n}step(t,e){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=e+a*ze.joint,16===ze.joint?i.updateFromPhy(t,s):i.update()}add(t={}){let e,i=this.setName(t),s=null,a=null,r=!1;if(t.axis1||(t.axis1=[1,0,0]),t.axis2||(t.axis2=[1,0,0]),t.pos1||(t.pos1=[0,0,0]),t.pos2||(t.pos2=[0,0,0]),t.limit?t.lm=t.limit:t.lm&&(t.limit=t.lm),"universal"!==t.mode&&"dof"!==t.mode&&"d6"!==t.mode||(t.mode="generic"),"revolute"===t.mode&&(t.mode="hinge"),"slider"===t.mode&&(t.mode="cylindrical"),t.b1&&(e="string"==typeof t.b1,s=e?this.Utils.byName(t.b1):t.b1,e||(t.b1=t.b1.name),s&&s.link++),t.b2&&(e="string"==typeof t.b2,a=e?this.Utils.byName(t.b2):t.b2,e||(t.b2=t.b2.name),a&&a.link++),t.worldPos&&(t.worldAnchor=t.worldPos),t.worldAnchor&&(t.pos1=s?this.Utils.toLocal(this.v1.fromArray(t.worldAnchor),s).toArray():t.worldAnchor,t.pos2=a?this.Utils.toLocal(this.v2.fromArray(t.worldAnchor),a).toArray():t.worldAnchor,delete t.worldAnchor),t.worldAxis&&(t.axis1=s?this.Utils.toLocal(this.v1.fromArray(t.worldAxis),s,!0).toArray():t.worldAxis,t.axis2=a?this.Utils.toLocal(this.v2.fromArray(t.worldAxis),a,!0).toArray():t.worldAxis,r=!0,delete t.worldAxis),t.worldQuat&&(t.quat1=this.Utils.quatLocal(t.worldQuat,s),t.quat2=this.Utils.quatLocal(t.worldQuat,a),"OIMO"!==this.engine&&"HAVOK"!==this.engine&&"JOLT"!==this.engine||(t.axis1=this.Utils.axisLocal(fe.quatToAxis(t.worldQuat),s),t.axis2=this.Utils.axisLocal(fe.quatToAxis(t.worldQuat),a)),delete t.worldQuat),void 0!==t.rot1&&(t.quat1=fe.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=fe.quatFromEuler(t.rot2),delete t.rot2),t.quat1||(t.quat1=(new $).setFromUnitVectors(new n(1,0,0),(new n).fromArray(t.axis1).normalize()).toArray()),t.quat2||(t.quat2=(new $).setFromUnitVectors(new n(1,0,0),(new n).fromArray(t.axis2).normalize()).toArray()),"AMMO"===this.engine&&r&&"hinge"===t.mode){let e=new nt(0,-90*pe,0),i=(new $).setFromEuler(e).toArray();t.quatX=i}t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=fe.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot);let o=new ki(t,this.motor);return o.name=i,o.body1=s,o.body2=a,void 0===t.visible&&(t.visible=this.motor.jointVisible||!1),this.set(t,o),this.addToWorld(o,t.id),this.motor.post({m:"add",o:t}),o}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&void 0!==t.visible&&(e.visible=t.visible)}}class Si extends Ze{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="contact"}step(t,e){let i,s,a=this.list.length;for(;a--;)i=this.list[a],s=e+a*ze.contact,i.update(t,s)}add(t={}){this.setName(t);let e=new Ai(t);return t.callback&&delete t.callback,this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}}class Ai{constructor(t={}){this.type="contact",this.name=t.name,this.callback=t.callback||function(){},this.b1=t.b1||null,this.b2=t.b2||null,this.ignore=t.ignore||[],this.always=void 0===t.always||t.always,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}detectBody(){}update(t,e=0){this.data.hit=t[e]>0,this.simple||(this.data.point=[t[e+1],t[e+2],t[e+3]],this.data.normal=[t[e+4],t[e+5],t[e+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}let zi=null;class Ei extends Ze{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,this.motor.geo,zi=this.motor.mat,this.type="vehicle",this.num=ze[this.type]}step(t,e){let i,s,a=this.list.length;for(;a--;)s=this.list[a],i=e+a*this.num,s.step(t,i)}add(t={}){this.setName(t);const e=new Pi(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:e.o}),e}set(t={},e=null){null===e&&(e=this.byName(t.name))}}class Pi extends it{constructor(t,e){super(),this.motor=e,this.Utils=this.motor.utils,this.velocity=new n,this.angular=new n,t.extra&&(this.extra=t.extra,delete t.extra),this.type="vehicle",this.name=t.name||"car",this.isRay=t.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(t)}drive(){}raycast(){}init(t){this.mass=t.mass||2e3,this.model=null,this.size=t.size||[1.7,1,5],this.massCenter=t.massCenter||[0,.55,1.594],this.chassisPos=t.chassisPos||[0,.83,0],this.maxSteering=t.maxSteering||24,this.incSteering=t.incSteering||2,this.s_travel=t.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===this.engine?.5*this.s_travel:0,this.numWheel=t.numWheel||4,this.radius=t.radius||.35,this.radiusBack=t.radiusBack||this.radius,this.deep=t.deep||.3,this.deepBack=t.deepBack||this.deep;let e=this.numWheel<4?1:2;if(t.wPos||(t.wPos=[.8,.1,1.4]),t.wPos){this.wPos=t.wPos;var i,s,a,r,o,n,l=t.wPos,h=[],c=1,d=0;l.length,l.length;for(let t=0;t<this.numWheel;t++)c=t%2==0?-1:1,s=Math.floor(.5*t),d=t>=e,0===(a=l[1])&&(a=d?this.radiusBack:this.radius),(r=l[0])instanceof Array&&(r=l[0][s]),o=d?-l[2]:l[2],l[2]instanceof Array&&(o=l[2][s]),i=[r*c,a,o],h.push(i);this.wheelsPosition=h,delete t.wPos}t.wheelsPosition&&(this.wheelsPosition=t.wheelsPosition);const p=t.meshScale||1,u=[];t.chassisShape?u.push({type:"convex",shape:t.chassisShape,size:[p],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):u.push({type:"box",size:this.size,pos:this.chassisPos});for(let i=0;i<this.numWheel;i++)i<e?u.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1}):u.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:t.rad||.05,shadow:!1,ray:!1});var m=zi.get(t.debug?"debug":void 0===t.chassisMesh?"body":"hide");let b,g;for(let t=0;t<u.length;t++)b=u[t],b.pos&&(b.localPos=b.pos),b.size=fe.autoSize(b.size,b.type),this.motor.getGeometryRef(b,this,m);if(t.chassisMesh&&(g=t.noClone?t.chassisMesh:t.chassisMesh.clone(),g.position.set(0,0,0),this.Utils.noRay(g),g.scale.set(p,p,p),this.children[0].add(g),this.model=g,delete t.chassisMesh),t.wheelMesh){for(let i=1;i<this.numWheel+1;i++)d=i>=e+1,g=t.wheelMeshBack&&d?t.wheelMeshBack.clone():t.wheelMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),2==i||4==i?g.scale.set(-p,p,p):g.scale.set(p,p,p),this.children[i].add(g);delete t.wheelMesh}if(t.suspensionMesh){this.suspensionMesh=[];for(let e=1;e<this.numWheel+1;e++)g=t.suspensionMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[e-1]),g.position.x=0,2==e||4==e?g.scale.set(p,p,p):g.scale.set(-p,p,p),this.children[0].add(g),this.suspensionMesh.push(g);delete t.suspensionMesh}if(t.brakeMesh){this.brake=[];for(let e=1;e<this.numWheel+1;e++)d=e>2,g=t.brakeMeshBack&&d?t.brakeMeshBack.clone():t.brakeMesh.clone(),this.Utils.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[e-1]),n=t.brakeMeshBack||d?p:-p,2==e||4==e?g.scale.set(-p,p,n):g.scale.set(p,p,n),this.children[0].add(g),this.brake.push(g);delete t.brakeMesh}t.mass=this.mass,t.size=t.chassisShape?u[0].boxSize:this.size,t.numWheel=this.numWheel,t.wheelsPosition=this.wheelsPosition,t.radius=this.radius,t.radiusBack=this.radiusBack,t.deep=this.deep,t.deepBack=this.deepBack,t.chassisShape=u[0],t.maxSteering=this.maxSteering,t.incSteering=this.incSteering,t.s_travel=this.s_travel,t.massCenter=this.massCenter,t.chassisPos=this.chassisPos,this.o=t}set(t){t.name=this.name,this.motor.change(t)}respawn(t){(t=t||{}).respawn=!0,t.name=this.name,t.keepRotation&&(t.quat=this.quaternion.toArray()),this.motor.change(t)}move(){}dispose(){}step(t,e){if(!this.actif){if(0===t[e+0]+t[e+1]+t[e+2]+t[e+3]+t[e+4]+t[e+5]+t[e+6]+t[e+7])return;this.actif=!0}this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.updateMatrix();let i,s=this.numWheel+1,a=0,r=0,o=[],n=0;for(let l=0;l<s;l++)n=8*l+e,0===l&&(t[n],this.circum),1===l&&(a=t[n]),2===l&&(r=t[n]),i=this.children[l],i&&l>0&&(o[l-1]=this.wheelsPosition[l-1][1]-this.decaly-t[n+2],i.position.fromArray(t,n+1),i.quaternion.fromArray(t,n+4),this.rolling[l-1]=i.rotation.x,this.brake&&(this.brake[l-1].position.copy(i.position),1!=l&&2!=l||(this.brake[l-1].rotation.y=t[n])));for(n=4;n--;)this.suspension[n]=fe.clamp(o[n]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[n]>0?(this.Utils.morph(this.suspensionMesh[n].children[0],"low",this.suspension[n]),this.Utils.morph(this.suspensionMesh[n].children[0],"top",0)):(this.Utils.morph(this.suspensionMesh[n].children[0],"low",0),this.Utils.morph(this.suspensionMesh[n].children[0],"top",-this.suspension[n])));this.steering=Math.round(.5*(a+r)*ue)/this.maxSteering}}const Ri=new l,Ti=new n,Fi=new $,Di=new n,_i=new l,Ci=new l,ji=["hip","abdomen","chest","neck","head","rCollar","lCollar","lShldr","rShldr","lThigh","rThigh","rBreast","lBreast"];class Li extends it{constructor(t,e,i,s,a=null,r={}){super(),this.motor=t,this.prefix=e||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=s,this.model=i,this.scaler=this.model.scale.x,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==this.motor.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.matrixAutoUpdate=!1,this.mass=a,this.friction=.5,this.restitution=0,this.option=r,this.useDrive=void 0===r.useDrive||r.useDrive,this.showJoint=void 0!==r.showJoint&&r.showJoint,this.init()}setMass(t){if(t===this.mass)return;this.mass=t;const e=[];let i=this.nodes.length,s=this.mass/i;for(;i--;)e.push({name:this.nodes[i].name,mass:s});this.motor.change(e)}setMode(t){if(t===this.mode)return;this.mode=t;const e=[];let i,s="follow"===this.mode,a=this.nodes.length;for(;a--;)i=this.nodes[a],e.push({name:i.name,kinematic:s}),i.kinematic=s,i.bone.isPhysics=!s;this.motor.change(e)}freeBone(t){t.kinematic&&(t.cc++,20===t.cc&&(t.cc=0,t.kinematic=!1,t.bone.isPhysics=!0,this.motor.change({name:t.name,kinematic:!1})))}isVisible(t){let e=this.nameList.length;for(;e--;)this.motor.byName(this.nameList[e]).visible=t}init(){this.useSolver&&(this.solver=this.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0})),this.useAggregate="PHYSX"===this.motor.engine;const t=[];let e=(new l).makeScale(this.scaler,this.scaler,this.scaler),i=new n,s=new n,a=new $,r=new nt,o=new l,h=new l,c=new l;_i.copy(this.model.matrixWorld).invert();let d=new n,p=new n,u=[1,1,1,1,1,1,1];this.option.sizer&&(u=this.option.sizer);let m,b,g,f,y,v,x,w,k,M,S,A,z,E=this.bones.length,P=0;for(this.mass&&(P=this.mass/E),m=0;m<E;m++)if(k=null,f=this.bones[m],b=f.name,y=f.parent,y){g=y.name,Ci.multiplyMatrices(_i,f.matrixWorld),d.setFromMatrixPosition(Ci),Ci.multiplyMatrices(_i,y.matrixWorld),p.setFromMatrixPosition(Ci),x=d.distanceTo(p),S=[0,0,.5*x],v=[x,1,1],w=null,M=!0,z=!1,"hip"===g&&"abdomen"===b&&(k="capsule",v=[x*u[0],.08],S=[0,0,-x*u[0]],w=[0,0,90]),"abdomen"===g&&"chest"===b&&(k="capsule",v=[.7*x*u[1],.08],S=[0,0,.5*-x-.06],w=[90,0,0]),"chest"===g&&"neck"===b&&(k="capsule",v=[.4*x*u[2],.04],S=[0,0,.5*-x-.02],w=[0,0,90]),"neck"===g&&"head"===b&&(k="capsule",v=[.06*u[3],x],S=[0,0,.5*-x],w=[90,0,0]),"head"===g&&"End_head"===b&&(k="capsule",v=[.1*u[4],x-.17],S=[0,.02,.5*-x+.02],w=[90,0,0]),"chest"===g&&"rBreast"===b&&"HAVOK"!==this.motor.engine&&(g="rBreast",y=f,k="sphere",v=[.065],S=[.065,0,0],this.breast=!0,z=!0),"chest"===g&&"lBreast"===b&&"HAVOK"!==this.motor.engine&&(g="lBreast",y=f,k="sphere",v=[.065],S=[.065,0,0],this.breast=!0,z=!0);let n=.04*u[5],l=x-n;if("lCollar"===g&&"lShldr"===b&&(k="capsule",v=[n,.3*x],S=[.6*x,0,0],w=[0,0,90]),"lShldr"===g&&"lForeArm"===b&&(k="capsule",v=[n,l],S=[.5*l,0,0],w=[0,0,90]),"lForeArm"===g&&"lHand"===b&&(k="capsule",v=[n,l],S=[.5*l,0,0],w=[0,0,90]),"lHand"===g&&"lMid1"===b&&(k="box",v=[2*x,.09,.05],S=[x,0,0]),"rCollar"===g&&"rShldr"===b&&(k="capsule",v=[n,.3*x],S=[.6*-x,0,0],w=[0,0,90]),"rShldr"===g&&"rForeArm"===b&&(k="capsule",v=[n,l],S=[.5*-l,0,0],w=[0,0,90]),"rForeArm"===g&&"rHand"===b&&(k="capsule",v=[n,l],S=[.5*-l,0,0],w=[0,0,90]),"rHand"===g&&"rMid1"===b&&(k="box",v=[2*x,.09,.05],S=[-x,0,0]),n=.06*u[6],l=x-n,"lThigh"===g&&(k="capsule",v=[n,x],w=[90,0,0],S=[0,0,.5*l]),"lShin"===g&&(k="capsule",v=[n,x],w=[90,0,0],S=[0,0,.5*l]),"lFoot"===g&&(k="capsule",v=[.05,x],S=[0,.5*x-.025,.04]),"rThigh"===g&&(k="capsule",v=[n,x],w=[90,0,0],S=[0,0,.5*l]),"rShin"===g&&(k="capsule",v=[n,x],w=[90,0,0],S=[0,0,.5*l]),"rFoot"===g&&(k="capsule",v=[.05,x],S=[0,.5*x-.025,.04]),n=.04,l=x-n,"rEar_0"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0],ji.push("rEar_0")),"rEar_1"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0],ji.push("rEar_1")),"rEar_2"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0],ji.push("rEar_2")),"rEar_3"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0]),"lEar_0"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0],ji.push("lEar_0")),"lEar_1"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0],ji.push("lEar_1")),"lEar_2"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0],ji.push("lEar_2")),"lEar_3"===g&&(k="capsule",v=[n,x],w=[0,0,90],S=[.5*l,0,0]),this.withFinger&&("lHand"===g&&"lMid1"===b&&(k="box",v=[x,.09,.05],S=[.5*x,0,0]),"rHand"===g&&"rMid1"===b&&(k="box",v=[x,.09,.05],S=[.5*-x,0,0]),"rThumb1"===g&&"rThumb2"===b&&(k="capsule",v=[.02,x],w=[0,0,90]),"rThumb2"===g&&"rThumb3"===b&&(k="capsule",v=[.02,x],w=[0,0,90]),"rHand"===g&&"rMid1"===b&&(k="capsule",v=[.02,x],w=[0,0,90],S=[.6*-x,0,0]),"rMid1"===g&&"rMid2"===b&&(k="capsule",v=[.02,x],w=[0,0,90],S=[.6*-x,0,0]),"rMid2"===g&&"rMid3"===b&&(k="capsule",v=[.02,x],w=[0,0,90],S=[.6*-x,0,0])),null!==k){A=this.prefix+"_bone_"+g,h.makeTranslation(S[0],S[1],S[2]),w&&(c.makeRotationFromEuler(r.set(w[0]*pe,w[1]*pe,w[2]*pe)),h.multiply(c)),y.updateWorldMatrix(!0,!1),Ci.multiplyMatrices(_i,y.matrixWorld),o.copy(Ci),o.decompose(i,a,s),this.posRef[A]=i.toArray(),"lForeArm"!==g&&"rForeArm"!==g||(Fi.setFromAxisAngle({x:0,y:1,z:0},-90*pe),a.multiply(Fi)),this.quatRef[A]=a.toArray(),o.multiplyMatrices(Ci,h),o.decompose(i,a,s),this.nameList.push(A);let n={name:A,friction:this.friction,restitution:this.restitution,type:k,size:fe.scaleArray(v,this.scaler,3),pos:i.toArray(),quat:a.toArray(),kinematic:M,material:"hide",shadow:!1,neverSleep:!0,helper:!0,hcolor:[0,.5,1],hcolor2:[0,.2,1],penetrationVelocity:3,stabilization:.1,damping:[.25,.5],...this.option};if(this.useAggregate)-1!==ji.indexOf(g)&&(n.aggregate=this.prefix+"__Group",n.aggregateMax=21),n.mask=3;else{let t=3;"lForeArm"!==g&&"rForeArm"!==g&&"lShin"!==g&&"rShin"!==g||(t=35),"rEar_1"!==g&&"rEar_2"!==g&&"rEar_3"!==g&&"lEar_1"!==g&&"lEar_2"!==g&&"lEar_3"!==g||(t=35),"rEar_0"!==g&&"rEar_0"!==g||(t=0),n.group=32,n.mask=t}null!==this.mass?n.mass=P:n.density=1,t.push(n);let l=h.clone().invert().premultiply(e);this.nodes.push({name:A,kinematic:M,motion:z,bone:y,decal:h.clone(),decalinv:l,quat:a.toArray(),pos:i.toArray(),cc:0})}}this.motor.add(t),this.addLink(),this.dispatchEvent({type:"start",message:"go !"}),this.ready=!0}existe(t){return-1!==this.nameList.indexOf(t)}addLink(){let t=[.05,1,0];"PHYSX"===this.motor.engine&&(t=[50,10,0,.5]);let e=2,i=.1,s=1e7,a=!1,r=this.prefix+"_bone_",o=[],n={type:"joint",mode:"d6",lm:[["ry",-180,180,...t],["rz",-180,180,...t]],collision:!1,helperSize:.05,visible:this.showJoint};this.useDrive&&(n.drives=[["rx",e,i,s,a],["ry",e,i,s,a],["rz",e,i,s,a]]);let l=[-.001,.001,100,.2,.5];o.push({...n,b1:r+"hip",b2:r+"abdomen",worldPos:this.posRef[r+"abdomen"],worldQuat:this.quatRef[r+"hip"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),o.push({...n,b1:r+"abdomen",b2:r+"chest",worldPos:this.posRef[r+"chest"],worldQuat:this.quatRef[r+"chest"],lm:[["rx",-20,20,...t],["ry",-20,20,...t],["rz",-20,20,...t]]}),o.push({...n,b1:r+"chest",b2:r+"neck",worldPos:this.posRef[r+"neck"],worldQuat:this.quatRef[r+"neck"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),o.push({...n,b1:r+"neck",b2:r+"head",worldPos:this.posRef[r+"head"],worldQuat:this.quatRef[r+"head"],lm:[["rx",0,30,...t],["ry",-1,1,...t],["rz",-30,30,...t]]}),o.push({...n,b1:r+"chest",b2:r+"rCollar",worldPos:this.posRef[r+"rCollar"],worldQuat:this.quatRef[r+"rCollar"],mode:"fixe"}),o.push({...n,b1:r+"chest",b2:r+"lCollar",worldPos:this.posRef[r+"lCollar"],worldQuat:this.quatRef[r+"lCollar"],mode:"fixe"}),o.push({...n,b1:r+"rCollar",b2:r+"rShldr",worldPos:this.posRef[r+"rShldr"],worldQuat:this.quatRef[r+"rShldr"]}),o.push({...n,b1:r+"lCollar",b2:r+"lShldr",worldPos:this.posRef[r+"lShldr"],worldQuat:this.quatRef[r+"lShldr"]}),this.existe(r+"rForeArm")&&o.push({...n,b1:r+"rShldr",b2:r+"rForeArm",worldPos:this.posRef[r+"rForeArm"],worldQuat:this.quatRef[r+"rForeArm"],lm:[["rx",0,160,...t]]}),this.existe(r+"lForeArm")&&o.push({...n,b1:r+"lShldr",b2:r+"lForeArm",worldPos:this.posRef[r+"lForeArm"],worldQuat:this.quatRef[r+"lForeArm"],lm:[["rx",0,160,...t]]}),this.existe(r+"rHand")&&o.push({...n,b1:r+"rForeArm",b2:r+"rHand",worldPos:this.posRef[r+"rHand"],worldQuat:this.quatRef[r+"rHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),this.existe(r+"lHand")&&o.push({...n,b1:r+"lForeArm",b2:r+"lHand",worldPos:this.posRef[r+"lHand"],worldQuat:this.quatRef[r+"lHand"],lm:[["rx",0,160,...t],["ry",-10,10,...t]]}),o.push({...n,b1:r+"hip",b2:r+"rThigh",worldPos:this.posRef[r+"rThigh"],worldQuat:this.quatRef[r+"rThigh"]}),o.push({...n,b1:r+"hip",b2:r+"lThigh",worldPos:this.posRef[r+"lThigh"],worldQuat:this.quatRef[r+"lThigh"]}),this.existe(r+"rShin")&&o.push({...n,b1:r+"rThigh",b2:r+"rShin",worldPos:this.posRef[r+"rShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[r+"rShin"]}),this.existe(r+"lShin")&&o.push({...n,b1:r+"lThigh",b2:r+"lShin",worldPos:this.posRef[r+"lShin"],lm:[["rx",0,160,...t]],worldQuat:this.quatRef[r+"lShin"]}),this.existe(r+"rFoot")&&o.push({...n,b1:r+"rShin",b2:r+"rFoot",worldPos:this.posRef[r+"rFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[r+"rFoot"]}),this.existe(r+"lFoot")&&o.push({...n,b1:r+"lShin",b2:r+"lFoot",worldPos:this.posRef[r+"lFoot"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]],worldQuat:this.quatRef[r+"lFoot"]}),this.breast&&(this.existe(r+"rBreast")&&o.push({...n,b1:r+"chest",b2:r+"rBreast",worldPos:this.posRef[r+"rBreast"],worldQuat:this.quatRef[r+"rBreast"],lm:[["x",...l],["y",...l],["z",...l]]}),this.existe(r+"lBreast")&&o.push({...n,b1:r+"chest",b2:r+"lBreast",worldPos:this.posRef[r+"lBreast"],worldQuat:this.quatRef[r+"lBreast"],lm:[["x",...l],["y",...l],["z",...l]]})),this.existe(r+"lEar_0")&&o.push({...n,b1:r+"head",b2:r+"lEar_0",worldPos:this.posRef[r+"lEar_0"],worldQuat:this.quatRef[r+"lEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"lEar_1")&&o.push({...n,b1:r+"lEar_0",b2:r+"lEar_1",worldPos:this.posRef[r+"lEar_1"],worldQuat:this.quatRef[r+"lEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"lEar_2")&&o.push({...n,b1:r+"lEar_1",b2:r+"lEar_2",worldPos:this.posRef[r+"lEar_2"],worldQuat:this.quatRef[r+"lEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"lEar_3")&&o.push({...n,b1:r+"lEar_2",b2:r+"lEar_3",worldPos:this.posRef[r+"lEar_3"],worldQuat:this.quatRef[r+"lEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_0")&&o.push({...n,b1:r+"head",b2:r+"rEar_0",worldPos:this.posRef[r+"rEar_0"],worldQuat:this.quatRef[r+"rEar_0"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_1")&&o.push({...n,b1:r+"rEar_0",b2:r+"rEar_1",worldPos:this.posRef[r+"rEar_1"],worldQuat:this.quatRef[r+"rEar_1"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_2")&&o.push({...n,b1:r+"rEar_1",b2:r+"rEar_2",worldPos:this.posRef[r+"rEar_2"],worldQuat:this.quatRef[r+"rEar_2"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]}),this.existe(r+"rEar_3")&&o.push({...n,b1:r+"rEar_2",b2:r+"rEar_3",worldPos:this.posRef[r+"rEar_3"],worldQuat:this.quatRef[r+"rEar_3"],lm:[["rx",-10,30,...t],["rz",-10,10,...t]]});let h=0;for(let t in o)o[t].name=this.prefix+"_joint_"+h,this.jointList.push(o[t].name),h++;this.motor.add(o)}updateMatrixWorld(t){if(!this.ready)return;let e=[];const i=this.nodes;let s,a,r,o=i.length,n=0;for(;o--;)s=i[n],a=s.bone,n++,s.kinematic?(Ri.multiplyMatrices(a.matrixWorld,s.decal),Ri.decompose(Ti,Fi,Di),s.pos=Ti.toArray(),s.quat=Fi.toArray(),e.push({name:s.name,pos:s.pos,quat:s.quat}),s.motion&&this.freeBone(s)):(r=this.motor.byName(s.name),r&&(Ri.copy(r.matrixWorld).multiply(s.decalinv),a.phyMtx.copy(Ri),a.isPhysics=!0));0!==e.length&&this.motor.change(e,!0)}dispose(){this.motor.remove(this.jointList),this.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}var qi=function(){var t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),e=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var i,s=WebAssembly.validate(t)?r("b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q:6dkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;G9Mqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk:183lYud97dur978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnalTmbcuhoaiRbbgrc;WeGc:Ge9hmbarcsGgwce0mbc9:hoalcufadcd4cbawEgDadfgrcKcaawEgqaraq0Egk6mbaicefhxavaialfgmar9Rgoad;8qbbcj;abad9Uc;WFbGcjdadca0EhPdndndnadTmbaoadfhscbhzinaeaz9nmdamax9RaD6miabazad2fhHaxaDfhOaPaeaz9RazaPfae6EgAcsfgocl4cifcd4hCavcj;cbfaoc9WGgXcetfhQavcj;cbfaXci2fhLavcj;cbfaXfhKcbhYaoc;ab6h8AincbhodnawTmbaxaYcd4fRbbhokaocFeGhEcbh3avcj;cbfh5indndndndnaEa3cet4ciGgoc9:fPdebdkamaO9RaX6mwavcj;cbfa3aX2faOaX;8qbbaOaAfhOxdkavcj;cbfa3aX2fcbaX;8kbxekamaO9RaC6moaoclVcbawEhraOaCfhocbhidna8Ambamao9Rc;Gb6mbcbhlina5alfhidndndndndndnaOalco4fRbbgqciGarfPDbedibledibkaipxbbbbbbbbbbbbbbbbpklbxlkaiaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaiaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaiaopbbbpklbaoczfhoxekaiaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqcd4ciGarfPDbedibledibkaiczfpxbbbbbbbbbbbbbbbbpklbxlkaiczfaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaiczfaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaiczfaopbbbpklbaoczfhoxekaiczfaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqcl4ciGarfPDbedibledibkaicafpxbbbbbbbbbbbbbbbbpklbxlkaicafaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaoclffahc:q:yjjbfRbbfhoxikaicafaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaaaocwffahc:q:yjjbfRbbfhoxdkaicafaopbbbpklbaoczfhoxekaicafaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaaaocdffahc:q:yjjbfRbbfhokdndndndndndnaqco4arfPDbedibledibkaic8Wfpxbbbbbbbbbbbbbbbbpklbxlkaic8Wfaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngicitc:q1jjbfpbibaic:q:yjjbfRbbgipsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Ngqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaiaoclffaqc:q:yjjbfRbbfhoxikaic8Wfaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngicitc:q1jjbfpbibaic:q:yjjbfRbbgipsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Ngqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spklbaiaocwffaqc:q:yjjbfRbbfhoxdkaic8Wfaopbbbpklbaoczfhoxekaic8WfaopbbdaoRbbgicitc:q1jjbfpbibaic:q:yjjbfRbbgipsaoRbegqcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpklbaiaocdffaqc:q:yjjbfRbbfhokalc;abfhialcjefaX0meaihlamao9Rc;Fb0mbkkdnaiaX9pmbaici4hlinamao9RcK6mwa5aifhqdndndndndndnaOaico4fRbbalcoG4ciGarfPDbedibledibkaqpxbbbbbbbbbbbbbbbbpkbbxlkaqaopbblaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLg8Ecdp:mea8EpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9og8Fpxiiiiiiiiiiiiiiiip8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spkbbaaaoclffahc:q:yjjbfRbbfhoxikaqaopbbwaopbbbg8Eclp:mea8EpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9og8Fpxssssssssssssssssp8Jg8Ep5b9cjF;8;4;W;G;ab9:9cU1:Ngacitc:q1jjbfpbibaac:q:yjjbfRbbgapsa8Ep5e9cjF;8;4;W;G;ab9:9cU1:Nghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPa8Fa8Ep9spkbbaaaocwffahc:q:yjjbfRbbfhoxdkaqaopbbbpkbbaoczfhoxekaqaopbbdaoRbbgacitc:q1jjbfpbibaac:q:yjjbfRbbgapsaoRbeghcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPpkbbaaaocdffahc:q:yjjbfRbbfhokalcdfhlaiczfgiaX6mbkkaohOaoTmoka5aXfh5a3cefg3cl9hmbkdndndndnawTmbasaYcd4fRbbglciGPlbedwbkaXTmdavcjdfaYfhlavaYfpbdbhgcbhoinalavcj;cbfaofpblbg8JaKaofpblbg8KpmbzeHdOiAlCvXoQrLg8LaQaofpblbg8MaLaofpblbg8NpmbzeHdOiAlCvXoQrLgypmbezHdiOAlvCXorQLg8Ecep9Ta8Epxeeeeeeeeeeeeeeeeg8Fp9op9Hp9rg8Eagp9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8LaypmwDKYqk8AExm35Ps8E8Fg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8Ja8KpmwKDYq8AkEx3m5P8Es8Fg8Ja8Ma8NpmwKDYq8AkEx3m5P8Es8Fg8KpmbezHdiOAlvCXorQLg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Uggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp9Uggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp9Uggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9Abbbaladfglaga8Ja8KpmwDKYqk8AExm35Ps8E8Fg8Ecep9Ta8Ea8Fp9op9Hp9rg8Ep9Ug8Fp9Abbbaladfgla8Fa8Ea8Epmlvorlvorlvorlvorp9Ug8Fp9Abbbaladfgla8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9Ug8Fp9Abbbaladfgla8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9Uggp9AbbbaladfhlaoczfgoaX6mbxikkaXTmeavcjdfaYfhlavaYfpbdbhgcbhoinalavcj;cbfaofpblbg8JaKaofpblbg8KpmbzeHdOiAlCvXoQrLg8LaQaofpblbg8MaLaofpblbg8NpmbzeHdOiAlCvXoQrLgypmbezHdiOAlvCXorQLg8Ecep:nea8Epxebebebebebebebebg8Fp9op:bep9rg8Eagp:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8LaypmwDKYqk8AExm35Ps8E8Fg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8Ja8KpmwKDYq8AkEx3m5P8Es8Fg8Ja8Ma8NpmwKDYq8AkEx3m5P8Es8Fg8KpmbezHdiOAlvCXorQLg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeggp9Abbbaladfglaga8Ea8Epmlvorlvorlvorlvorp:oeggp9Abbbaladfglaga8Ea8EpmwDqkwDqkwDqkwDqkp:oeggp9Abbbaladfglaga8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9Abbbaladfglaga8Ja8KpmwDKYqk8AExm35Ps8E8Fg8Ecep:nea8Ea8Fp9op:bep9rg8Ep:oeg8Fp9Abbbaladfgla8Fa8Ea8Epmlvorlvorlvorlvorp:oeg8Fp9Abbbaladfgla8Fa8Ea8EpmwDqkwDqkwDqkwDqkp:oeg8Fp9Abbbaladfgla8Fa8Ea8EpmxmPsxmPsxmPsxmPsp:oeggp9AbbbaladfhlaoczfgoaX6mbxdkkaXTmbcbhocbalcl4gl9Rc8FGhiavcjdfaYfhravaYfpbdbh8Finaravcj;cbfaofpblbggaKaofpblbg8JpmbzeHdOiAlCvXoQrLg8KaQaofpblbg8LaLaofpblbg8MpmbzeHdOiAlCvXoQrLg8NpmbezHdiOAlvCXorQLg8Eaip:Rea8Ealp:Sep9qg8Ea8Fp9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Fa8Ka8NpmwDKYqk8AExm35Ps8E8Fg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Faga8JpmwKDYq8AkEx3m5P8Es8Fgga8La8MpmwKDYq8AkEx3m5P8Es8Fg8JpmbezHdiOAlvCXorQLg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9Abbbaradfgra8Faga8JpmwDKYqk8AExm35Ps8E8Fg8Eaip:Rea8Ealp:Sep9qg8Ep9rg8Fp9Abbbaradfgra8Fa8Ea8Epmlvorlvorlvorlvorp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmwDqkwDqkwDqkwDqkp9rg8Fp9Abbbaradfgra8Fa8Ea8EpmxmPsxmPsxmPsxmPsp9rg8Fp9AbbbaradfhraoczfgoaX6mbkkaYclfgYad6mbkaHavcjdfaAad2;8qbbavavcjdfaAcufad2fad;8qbbaAazfhzc9:hoaOhxaOmbxlkkaeTmbaDalfhrcbhocuhlinaralaD9RglfaD6mdaPaeao9RaoaPfae6Eaofgoae6mbkaial9Rhxkcbc99amax9RakSEhoxekc9:hokavcj;kbf8Kjjjjbaokwbz:bjjjbk:TseHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhldnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhoindnalaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfaoaDcu7gPcl4fcsGcitfgsydlhzasydbhHdndnaDcsGgsak9pmbavaiaPfcsGcdtfydbaxasEhDaxasTgOfhxxekdndnascsSmbcehOasc987asamffcefhDxekalcefhDal8SbbgscFeGhPdndnascu9mmbaDhlxekalcvfhlaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhlkcehOaPce4cbaPceG9R7amfhDkaDhmkavc;abfaocitfgsaDBdbasazBdlavaicdtfaDBdbavc;abfaocefcsGcitfgsaHBdbasaDBdlaocdfhoaOaifhidnadcd9hmbabarcetfgsaH87ebasclfaD87ebascdfaz87ebxdkabarcdtfgsaHBdbascwfaDBdbasclfazBdbxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHclfas87ebaHcdfaD87ebxekabarcdtfgHaxBdbaHcwfasBdbaHclfaDBdbkavaicdtfaxBdbavc;abfaocitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfaocefcsGcitfgHasBdbaHaDBdlavaiaPfgicsGcdtfasBdbavc;abfaocdfcsGcitfgDaxBdbaDasBdlaocifhoaiaOfhiazaOfhxxekaxcbalRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbalcefhDxekalcdfhDal8SbegPcFeGhsdnaPcu9kmbalcofhAascFbGhscrhldninaD8SbbgPcFbGaltasVhsaPcu9kmeaDcefhDalcrfglc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbglcFeGhPdnalcu9kmbaDcvfhzaPcFbGhPcrhldninas8SbbgDcFbGaltaPVhPaDcu9kmeascefhsalcrfglc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashlxekascefhlas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninal8SbbgscFbGaDtaPVhPascu9kmealcefhlaDcrfgDc8J9hmbkaOhlxekalcefhlkaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDclfaO87ebaDcdfaz87ebxekabarcdtfgDaABdbaDcwfaOBdbaDclfazBdbkavc;abfaocitfgDazBdbaDaABdlavaicdtfaABdbavc;abfaocefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfaocdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhiaocifhokawcefhwaocsGhoaicsGhiarcifgrae6mbkkcbc99alaqSEhokavc;aef8Kjjjjbaok:clevu8Jjjjjbcz9Rhvdnaecvfal9nmbc9:skdnaiRbbc;:eGc;qeSmbcuskav9cb83iwaicefhoaialfc98fhrdnaeTmbdnadcdSmbcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcdtfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgiBdbalaiBdbawcefgwae9hmbxdkkcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcetfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgi87ebalaiBdbawcefgwae9hmbkkcbc99aoarSEk:SPliuo97eue978Jjjjjbca9Rhiaec98Ghldndnadcl9hmbdnalTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalaeSmeaipxbbbbbbbbbbbbbbbbgqpklbaiabalcdtfgdaeciGglcdtgv;8qbbdnalTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDaqp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkadaiav;8qbbskdnalTmbcbhvabhdinadczfgxaxpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;7eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oaoarpmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgval6mbkkalaeSmbaiczfpxbbbbbbbbbbbbbbbbgopklbaiaopklbaiabalcitfgdaeciGglcitgv;8qbbdnalTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;7eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oaoarpmbezHdiOAlvCXorQLp9qpklbkadaiav;8qbbkk:oDllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalaeSmbaiczfpxbbbbbbbbbbbbbbbbgkpklbaiakpklbaiabalcitfgoaeciGgvcitgw;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkaoaiaw;8qbbkk;uddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbheabhdinadadpbbbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepkbbadczfhdaeclfgeav6mbkkdnavalSmbaic8WfpxbbbbbbbbbbbbbbbbgopklbaicafaopklbaiczfaopklbaiaopklbaiabavcdtfgdalciGgecdtgv;8qbbdnaeTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepklbkadaiav;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz:Dbb"):r("b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:W:Odkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:S86qdbk;jYi5ud9:du8Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnalTmbcuhoaiRbbgrc;WeGc:Ge9hmbarcsGgwce0mbc9:hoalcufadcd4cbawEgDadfgrcKcaawEgqaraq0Egk6mbaicefhxcj;abad9Uc;WFbGcjdadca0EhmaialfgPar9Rgoadfhsavaoadz1jjjbgzceVhHcbhOdndninaeaO9nmeaPax9RaD6mdamaeaO9RaOamfgoae6EgAcsfglc9WGhCabaOad2fhXaAcethQaxaDfhiaOaeaoaeao6E9RhLalcl4cifcd4hKazcj;cbfaAfhYcbh8AazcjdfhEaHh3incbhodnawTmbaxa8Acd4fRbbhokaocFeGh5cbh8Eazcj;cbfhqinaih8Fdndndndna5a8Ecet4ciGgoc9:fPdebdkaPa8F9RaA6mrazcj;cbfa8EaA2fa8FaAz1jjjb8Aa8FaAfhixdkazcj;cbfa8EaA2fcbaAz:jjjjb8Aa8FhixekaPa8F9RaK6mva8FaKfhidnaCTmbaPai9RcK6mbaocdtc:q1jjbfcj1jjbawEhaczhrcbhlinargoc9Wfghaqfhrdndndndndndnaaa8Fahco4fRbbalcoG4ciGcdtfydbPDbedvivvvlvkar9cb83bbarcwf9cb83bbxlkarcbaiRbdai8Xbb9c:c:qj:bw9:9c:q;c1:I1e:d9c:b:c:e1z9:gg9cjjjjjz:dg8J9qE86bbaqaofgrcGfag9c8F1:NghcKtc8F91aicdfa8J9c8N1:Nfg8KRbbG86bbarcVfcba8KahcjeGcr4fghRbbag9cjjjjjl:dg8J9qE86bbarc7fcbaha8J9c8L1:NfghRbbag9cjjjjjd:dg8J9qE86bbarctfcbaha8J9c8K1:NfghRbbag9cjjjjje:dg8J9qE86bbarc91fcbaha8J9c8J1:NfghRbbag9cjjjj;ab:dg8J9qE86bbarc4fcbaha8J9cg1:NfghRbbag9cjjjja:dg8J9qE86bbarc93fcbaha8J9ch1:NfghRbbag9cjjjjz:dgg9qE86bbarc94fcbahag9ca1:NfghRbbai8Xbe9c:c:qj:bw9:9c:q;c1:I1e:d9c:b:c:e1z9:gg9cjjjjjz:dg8J9qE86bbarc95fag9c8F1:NgicKtc8F91aha8J9c8N1:NfghRbbG86bbarc96fcbahaicjeGcr4fgiRbbag9cjjjjjl:dg8J9qE86bbarc97fcbaia8J9c8L1:NfgiRbbag9cjjjjjd:dg8J9qE86bbarc98fcbaia8J9c8K1:NfgiRbbag9cjjjjje:dg8J9qE86bbarc99fcbaia8J9c8J1:NfgiRbbag9cjjjj;ab:dg8J9qE86bbarc9:fcbaia8J9cg1:NfgiRbbag9cjjjja:dg8J9qE86bbarcufcbaia8J9ch1:NfgiRbbag9cjjjjz:dgg9qE86bbaiag9ca1:NfhixikaraiRblaiRbbghco4g8Ka8KciSg8KE86bbaqaofgrcGfaiclfa8Kfg8KRbbahcl4ciGg8La8LciSg8LE86bbarcVfa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc7fa8Ka8Lfg8KRbbahciGghahciSghE86bbarctfa8Kahfg8KRbbaiRbeghco4g8La8LciSg8LE86bbarc91fa8Ka8Lfg8KRbbahcl4ciGg8La8LciSg8LE86bbarc4fa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc93fa8Ka8Lfg8KRbbahciGghahciSghE86bbarc94fa8Kahfg8KRbbaiRbdghco4g8La8LciSg8LE86bbarc95fa8Ka8Lfg8KRbbahcl4ciGg8La8LciSg8LE86bbarc96fa8Ka8Lfg8KRbbahcd4ciGg8La8LciSg8LE86bbarc97fa8Ka8Lfg8KRbbahciGghahciSghE86bbarc98fa8KahfghRbbaiRbigico4g8Ka8KciSg8KE86bbarc99faha8KfghRbbaicl4ciGg8Ka8KciSg8KE86bbarc9:faha8KfghRbbaicd4ciGg8Ka8KciSg8KE86bbarcufaha8KfgrRbbaiciGgiaiciSgiE86bbaraifhixdkaraiRbwaiRbbghcl4g8Ka8KcsSg8KE86bbaqaofgrcGfaicwfa8Kfg8KRbbahcsGghahcsSghE86bbarcVfa8KahfghRbbaiRbeg8Kcl4g8La8LcsSg8LE86bbarc7faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarctfaha8KfghRbbaiRbdg8Kcl4g8La8LcsSg8LE86bbarc91faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc4faha8KfghRbbaiRbig8Kcl4g8La8LcsSg8LE86bbarc93faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc94faha8KfghRbbaiRblg8Kcl4g8La8LcsSg8LE86bbarc95faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc96faha8KfghRbbaiRbvg8Kcl4g8La8LcsSg8LE86bbarc97faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc98faha8KfghRbbaiRbog8Kcl4g8La8LcsSg8LE86bbarc99faha8LfghRbba8KcsGg8Ka8KcsSg8KE86bbarc9:faha8KfghRbbaiRbrgicl4g8Ka8KcsSg8KE86bbarcufaha8KfgrRbbaicsGgiaicsSgiE86bbaraifhixekarai8Pbb83bbarcwfaicwf8Pbb83bbaiczfhikdnaoaC9pmbalcdfhlaoczfhraPai9RcL0mekkaoaC6moaimexokaCmva8FTmvkaqaAfhqa8Ecefg8Ecl9hmbkdndndndnawTmbasa8Acd4fRbbgociGPlbedrbkaATmdaza8Afh8Fazcj;cbfhhcbh8EaEhaina8FRbbhraahocbhlinaoahalfRbbgqce4cbaqceG9R7arfgr86bbaoadfhoaAalcefgl9hmbkaacefhaa8Fcefh8FahaAfhha8Ecefg8Ecl9hmbxikkaATmeaza8Afhaazcj;cbfhhcbhoceh8EaYh8FinaEaofhlaa8Vbbhrcbhoinala8FaofRbbcwtahaofRbbgqVc;:FiGce4cbaqceG9R7arfgr87bbaladfhlaLaocefgofmbka8FaQfh8FcdhoaacdfhaahaQfhha8EceGhlcbh8EalmbxdkkaATmbcbaocl49Rh8Eaza8AfRbbhqcwhoa3hlinalRbbaotaqVhqalcefhlaocwfgoca9hmbkcbhhaEh8FaYhainazcj;cbfahfRbbhrcwhoaahlinalRbbaotarVhralaAfhlaocwfgoca9hmbkara8E93aq7hqcbhoa8Fhlinalaqao486bbalcefhlaocwfgoca9hmbka8Fadfh8FaacefhaahcefghaA9hmbkkaEclfhEa3clfh3a8Aclfg8Aad6mbkaXazcjdfaAad2z1jjjb8AazazcjdfaAcufad2fadz1jjjb8AaAaOfhOaihxaimbkc9:hoxdkcbc99aPax9RakSEhoxekc9:hokavcj;kbf8Kjjjjbaok:XseHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhldnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhoindnalaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfaoaDcu7gPcl4fcsGcitfgsydlhzasydbhHdndnaDcsGgsak9pmbavaiaPfcsGcdtfydbaxasEhDaxasTgOfhxxekdndnascsSmbcehOasc987asamffcefhDxekalcefhDal8SbbgscFeGhPdndnascu9mmbaDhlxekalcvfhlaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhlkcehOaPce4cbaPceG9R7amfhDkaDhmkavc;abfaocitfgsaDBdbasazBdlavaicdtfaDBdbavc;abfaocefcsGcitfgsaHBdbasaDBdlaocdfhoaOaifhidnadcd9hmbabarcetfgsaH87ebasclfaD87ebascdfaz87ebxdkabarcdtfgsaHBdbascwfaDBdbasclfazBdbxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHclfas87ebaHcdfaD87ebxekabarcdtfgHaxBdbaHcwfasBdbaHclfaDBdbkavaicdtfaxBdbavc;abfaocitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfaocefcsGcitfgHasBdbaHaDBdlavaiaPfgicsGcdtfasBdbavc;abfaocdfcsGcitfgDaxBdbaDasBdlaocifhoaiaOfhiazaOfhxxekaxcbalRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbalcefhDxekalcdfhDal8SbegPcFeGhsdnaPcu9kmbalcofhAascFbGhscrhldninaD8SbbgPcFbGaltasVhsaPcu9kmeaDcefhDalcrfglc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbglcFeGhPdnalcu9kmbaDcvfhzaPcFbGhPcrhldninas8SbbgDcFbGaltaPVhPaDcu9kmeascefhsalcrfglc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashlxekascefhlas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninal8SbbgscFbGaDtaPVhPascu9kmealcefhlaDcrfgDc8J9hmbkaOhlxekalcefhlkaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDclfaO87ebaDcdfaz87ebxekabarcdtfgDaABdbaDcwfaOBdbaDclfazBdbkavc;abfaocitfgDazBdbaDaABdlavaicdtfaABdbavc;abfaocefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfaocdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhiaocifhokawcefhwaocsGhoaicsGhiarcifgrae6mbkkcbc99alaqSEhokavc;aef8Kjjjjbaok:clevu8Jjjjjbcz9Rhvdnaecvfal9nmbc9:skdnaiRbbc;:eGc;qeSmbcuskav9cb83iwaicefhoaialfc98fhrdnaeTmbdnadcdSmbcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcdtfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgiBdbalaiBdbawcefgwae9hmbxdkkcbhwindnaoar6mbc9:skaocefhlao8SbbgicFeGhddndnaicu9mmbalhoxekaocvfhoadcFbGhdcrhidninal8SbbgDcFbGaitadVhdaDcu9kmealcefhlaicrfgic8J9hmbxdkkalcefhokabawcetfadc8Etc8F91adcd47avcwfadceGcdtVglydbfgi87ebalaiBdbawcefgwae9hmbkkcbc99aoarSEk:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;oiliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabaiavcefciGfcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavciGfgkcd7cetfaD87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavcufciGfcetfaD87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohvxekcjjjj94hvkabakcetfav87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2gdTmbinababydbgecwtcw91:Yaece91cjjj98Gcjjj;8if::NUdbabclfhbadcufgdmbkkk9teiucbcbyd:K1jjbgeabcifc98GfgbBd:K1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;teeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiaeydlBdlaiaeydwBdwaiaeydxBdxaeczfheaiczfhiadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk:3eedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdxaialBdwaialBdlaialBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkk81dbcjwk8Kbbbbdbbblbbbwbbbbbbbebbbdbbblbbbwbbbbc:Kwkl8WNbb"),a=WebAssembly.instantiate(s,{}).then((function(t){(i=t.instance).exports.__wasm_call_ctors()}));function r(t){for(var i=new Uint8Array(t.length),s=0;s<t.length;++s){var a=t.charCodeAt(s);i[s]=a>96?a-97:a>64?a-39:a+4}var r=0;for(s=0;s<t.length;++s)i[r++]=i[s]<60?e[i[s]]:64*(i[s]-60)+i[++s];return i.buffer.slice(0,r)}function o(t,e,i,s,a,r,o){var n=t.exports.sbrk,l=s+3&-4,h=n(l*a),c=n(r.length),d=new Uint8Array(t.exports.memory.buffer);d.set(r,c);var p=e(h,s,a,c,r.length);if(0==p&&o&&o(h,l,a),i.set(d.subarray(h,h+s*a)),n(h-n(0)),0!=p)throw new Error("Malformed buffer data: "+p)}var n={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function d(t){var e={object:new Worker(t),pending:0,requests:{}};return e.object.onmessage=function(t){var i=t.data;e.pending-=i.count,e.requests[i.id][i.action](i.value),delete e.requests[i.id]},e}function p(t){var e=t.data;if(!e.id)return self.close();self.ready.then((function(t){try{var i=new Uint8Array(e.count*e.size);o(t,t.exports[e.mode],i,e.count,e.size,e.source,t.exports[e.filter]),self.postMessage({id:e.id,count:e.count,action:"resolve",value:i},[i.buffer])}catch(t){self.postMessage({id:e.id,count:e.count,action:"reject",value:t})}}))}return{ready:a,supported:!0,useWorkers:function(t){!function(t){for(var e="self.ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(s)+"]), {}).then(function(result) { result.instance.exports.__wasm_call_ctors(); return result.instance; });self.onmessage = "+p.name+";"+o.toString()+p.toString(),i=new Blob([e],{type:"text/javascript"}),a=URL.createObjectURL(i),r=h.length;r<t;++r)h[r]=d(a);for(r=t;r<h.length;++r)h[r].object.postMessage({});h.length=t,URL.revokeObjectURL(a)}(t)},decodeVertexBuffer:function(t,e,s,a,r){o(i,i.exports.meshopt_decodeVertexBuffer,t,e,s,a,i.exports[n[r]])},decodeIndexBuffer:function(t,e,s,a){o(i,i.exports.meshopt_decodeIndexBuffer,t,e,s,a)},decodeIndexSequence:function(t,e,s,a){o(i,i.exports.meshopt_decodeIndexSequence,t,e,s,a)},decodeGltfBuffer:function(t,e,s,a,r,h){o(i,i.exports[l[r]],t,e,s,a,i.exports[n[h]])},decodeGltfBufferAsync:function(t,e,s,r,d){return h.length>0?function(t,e,i,s,a){for(var r=h[0],o=1;o<h.length;++o)h[o].pending<r.pending&&(r=h[o]);return new Promise((function(o,n){var l=new Uint8Array(i),h=++c;r.pending+=t,r.requests[h]={resolve:o,reject:n},r.object.postMessage({id:h,count:t,size:e,source:l,mode:s,filter:a},[l.buffer])}))}(t,e,s,l[r],n[d]):a.then((function(){var a=new Uint8Array(t*e);return o(i,i.exports[l[r]],a,t,e,s,i.exports[n[d]]),a}))}}}();const Oi=new WeakMap;class Bi extends lt{constructor(t){super(t),this.useLocal=!1,this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setUseLocal(t){return this.useLocal=t,this}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,e,i,s){const a=new ht(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),console.log(this.withCredentials,this.requestHeader,this.path),a.load(t,(t=>{this.parse(t,e,s)}),i,s)}parse(t,e,i){this.decodeDracoFile(t,e,null,null,y).catch(i)}decodeDracoFile(t,e,i,s,a=ct){const r={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:a};return this.decodeGeometry(t,r).then(e)}decodeGeometry(t,e){const i=JSON.stringify(e);if(Oi.has(t)){const e=Oi.get(t);if(e.key===i)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const a=this.workerNextTaskID++,r=t.byteLength,o=this._getWorker(a,r).then((i=>(s=i,new Promise(((i,r)=>{s._callbacks[a]={resolve:i,reject:r},s.postMessage({type:"decode",id:a,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return o.catch((()=>!0)).then((()=>{s&&a&&this._releaseTask(s,a)})),Oi.set(t,{key:i,promise:o}),o}_createGeometry(t){const s=new e;t.index&&s.setIndex(new i(t.index.array,1));for(let e=0;e<t.attributes.length;e++){const a=t.attributes[e],r=a.name,o=a.array,n=a.itemSize,l=new i(o,n);"color"===r&&(this._assignVertexColorSpace(l,a.vertexColorSpace),l.normalized=o instanceof Float32Array==!1),s.setAttribute(r,l)}return s}_assignVertexColorSpace(t,e){if(e!==y)return;const i=new x;for(let e=0,s=t.count;e<s;e++)i.fromBufferAttribute(t,e).convertSRGBToLinear(),t.setXYZ(e,i.r,i.g,i.b)}_loadLibrary(t,e){const i=new ht(this.manager);return i.setPath(this.decoderPath),i.setResponseType(e),i.setWithCredentials(this.withCredentials),new Promise(((e,s)=>{i.load(t,e,void 0,s)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t=[];return"object"!=typeof WebAssembly||"js"===this.decoderConfig.type?this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_decoder.js",import.meta.url),"text"))):t.push(this._loadLibrary("draco_decoder.js","text")):this.useLocal?(this.decoderPath="",t.push(this._loadLibrary(new URL("../build/draco/draco_wasm_wrapper.js",import.meta.url),"text"))):t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),this.decoderPending=Promise.all(t).then((t=>{const e=t[0],i=Ii.toString(),s=["/* draco decoder */",e,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const i=e.data;switch(i.type){case"decode":t._callbacks[i.id].resolve(i);break;case"error":t._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[t]=e,i._taskLoad+=e,i}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function Ii(){let t,e;function i(t,e,i,s,a,r){const o=r.num_components(),n=i.num_points()*o,l=n*a.BYTES_PER_ELEMENT,h=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,a),c=t._malloc(l);e.GetAttributeDataArrayForAllPoints(i,r,h,l,c);const d=new a(t.HEAPF32.buffer,c,n).slice();return t._free(c),{name:s,array:d,itemSize:o}}onmessage=function(s){const a=s.data;switch(a.type){case"init":t=a.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const s=a.buffer,r=a.taskConfig;e.then((t=>{const e=t.draco,o=new e.Decoder;try{const t=function(t,e,s,a){const r=a.attributeIDs,o=a.attributeTypes;let n,l;const h=e.GetEncodedGeometryType(s);if(h===t.TRIANGULAR_MESH)n=new t.Mesh,l=e.DecodeArrayToMesh(s,s.byteLength,n);else{if(h!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");n=new t.PointCloud,l=e.DecodeArrayToPointCloud(s,s.byteLength,n)}if(!l.ok()||0===n.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const s in r){const l=self[o[s]];let h,d;if(a.useUniqueIDs)d=r[s],h=e.GetAttributeByUniqueId(n,d);else{if(d=e.GetAttributeId(n,t[r[s]]),-1===d)continue;h=e.GetAttribute(n,d)}const p=i(t,e,n,s,l,h);"color"===s&&(p.vertexColorSpace=a.vertexColorSpace),c.attributes.push(p)}h===t.TRIANGULAR_MESH&&(c.index=function(t,e,i){const s=i.num_faces(),a=3*s,r=4*a,o=t._malloc(r);e.GetTrianglesUInt32Array(i,r,o);const n=new Uint32Array(t.HEAPF32.buffer,o,a).slice();return t._free(o),{array:n,itemSize:1}}(t,e,n));return t.destroy(n),c}(e,o,new Int8Array(s),r),n=t.attributes.map((t=>t.array.buffer));t.index&&n.push(t.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:t},n)}catch(t){console.error(t),self.postMessage({type:"error",id:a.id,error:t.message})}finally{e.destroy(o)}}))}}}let Gi=0;class Ni extends ce{constructor(t){super(t),this.useLocal=!1}setUseLocal(t){return this.useLocal=t,this}_loadLibrary(t,e){const i=new FileLoader(this.manager);return i.setPath(this.transcoderPath),i.setResponseType(e),i.setWithCredentials(this.withCredentials),new Promise(((e,s)=>{i.load(t,e,void 0,s)}))}init(){if(!this.transcoderPending){let t,e;this.useLocal?(this.transcoderPath="",t=this._loadLibrary(new URL("../build/basis/basis_transcoder.js",import.meta.url),"text"),e=this._loadLibrary(new URL("../build/basis/basis_transcoder.wasm",import.meta.url),"arraybuffer")):(t=this._loadLibrary("basis_transcoder.js","text"),e=this._loadLibrary("basis_transcoder.wasm","arraybuffer")),this.transcoderPending=Promise.all([t,e]).then((([t,e])=>{const i=Ni.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify(Ni.EngineFormat),"let _EngineType = "+JSON.stringify(Ni.EngineType),"let _TranscoderFormat = "+JSON.stringify(Ni.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Ni.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s])),this.transcoderBinary=e,this.workerPool.setWorkerCreator((()=>{const t=new Worker(this.workerSourceURL),e=this.transcoderBinary.slice(0);return t.postMessage({type:"init",config:this.workerConfig,transcoderBinary:e},[e]),t}))})),Gi>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Gi++}return this.transcoderPending}}var Vi=function(){var t,e=0x10000000000000000,i=4294967295,s=2147483647;function a(t){var e=[];return e[t-1]=void 0,e}function r(t,e){return n(t[0]+e[0],t[1]+e[1])}function o(t,e){var i,s;return t[0]==e[0]&&t[1]==e[1]?0:(i=0>t[1],s=0>e[1],i&&!s?-1:!i&&s?1:function(t,e){return n(t[0]-e[0],t[1]-e[1])}(t,e)[1]<0?-1:1)}function n(t,s){var a,r;for(t%=e,s=(s%=e)-(a=s%L)+(r=Math.floor(t/L)*L),t=t-r+a;0>t;)t+=L,s-=L;for(;t>i;)t-=L,s+=L;for(s%=e;s>0x7fffffff00000000;)s-=e;for(;-0x10000000000000000>s;)s+=e;return[t,s]}function l(t){return t>=0?[t,0]:[t+L,-4294967296]}function h(t){return t[0]>=2147483648?~~Math.max(Math.min(t[0]-L,s),-2147483648):~~Math.max(Math.min(t[0],s),-2147483648)}function c(t){return t.cb>=t.O?-1:255&t.ab[t.cb++]}function d(t){var e=t.ab;return e.length=t.O,e}function p(t,e,s){var a,r,o,n,h="",d=[];for(r=0;5>r;++r){if(-1==(o=c(e)))throw Error("truncated input");d[r]=o<<24>>24}if(!function(t,e){var i,s,a,r,o,n,l;if(5>e.length)return 0;for(l=255&e[0],a=l%9,r=(n=~~(l/9))%5,o=~~(n/5),i=0,s=0;4>s;++s)i+=(255&e[1+s])<<8*s;return i>99999999||!function(t,e,i,s){if(e>8||i>4||s>4)return 0;S(t.k,i,e);var a=1<<s;return x(t.C,a),x(t.o,a),t.P=a-1,1}(t,a,r,o)?0:function(t,e){return 0>e?0:(t.z!=e&&(t.z=e,t.m=Math.max(t.z,1),m(t.b,Math.max(t.m,4096))),1)}(t,i)}(a=v({}),d))throw Error("corrupted input");for(r=0;64>r;r+=8){if(-1==(o=c(e)))throw Error("truncated input");1==(o=o.toString(16)).length&&(o="0"+o),h=o+""+h}/^0+$|^f+$/i.test(h)?t.N=q:(n=parseInt(h,16),t.N=n>i?q:l(n)),t.Q=function(t,e,i,s){return t.a.K=e,f(t.b),t.b.V=i,function(t){t.b.w=0,t.b.D=0,T(t.q),T(t.n),T(t.E),T(t.s),T(t.u),T(t.r),T(t.J),function(t){var e,i;for(i=1<<t.g+t.y,e=0;i>e;++e)T(t.F[e].v)}(t.k);for(var e=0;4>e;++e)T(t.j[e].B);M(t.C),M(t.o),T(t.t.B),function(t){t.p=0,t.i=-1;for(var e=0;5>e;++e)t.p=t.p<<8|c(t.K)}(t.a)}(t),t.f=0,t.l=0,t.T=0,t.R=0,t._=0,t.U=s,t.d=O,t.I=0,function(t,e){return t.h=e,t.bb=null,t.X=1,t}({},t)}(a,e,s,t.N)}function u(t,e){return t.S=function(t){return t.ab=a(32),t.O=0,t}({}),p(t,function(t,e){return t.ab=e,t.cb=0,t.O=e.length,t}({},e),t.S),t}function m(t,e){(null==t.x||t.c!=e)&&(t.x=a(e)),t.c=e,t.D=0,t.w=0}function b(t){var e=t.D-t.w;e&&(function(t,e,i,s){(function(t,e,i,s,a){for(var r=0;a>r;++r)i[s+r]=t[e+r]})(e,i,t.ab,t.O,s),t.O+=s}(t.V,t.x,t.w,e),t.D>=t.c&&(t.D=0),t.w=t.D)}function g(t,e){var i=t.D-e-1;return 0>i&&(i+=t.c),t.x[i]}function f(t){b(t),t.V=null}function y(t){if(!t.X)throw Error("bad state");if(t.bb)throw Error("No encoding");return function(t){var e=function(t){var e,i,s,a,n,c;if(c=h(t.d)&t.P,P(t.a,t.q,(t.f<<4)+c)){if(P(t.a,t.E,t.f))s=0,P(t.a,t.s,t.f)?(P(t.a,t.u,t.f)?(P(t.a,t.r,t.f)?(i=t._,t._=t.R):i=t.R,t.R=t.T):i=t.T,t.T=t.l,t.l=i):P(t.a,t.n,(t.f<<4)+c)||(t.f=7>t.f?9:11,s=1),s||(s=w(t.o,t.a,c)+2,t.f=7>t.f?8:11);else if(t._=t.R,t.R=t.T,t.T=t.l,s=2+w(t.C,t.a,c),t.f=7>t.f?7:10,n=E(t.j[function(t){return 4>(t-=2)?t:3}(s)],t.a),n>=4){if(a=(n>>1)-1,t.l=(2|1&n)<<a,14>n)t.l+=function(t,e,i,s){var a,r,o=1,n=0;for(r=0;s>r;++r)a=P(i,t,e+o),o<<=1,o+=a,n|=a<<r;return n}(t.J,t.l-n-1,t.a,a);else if(t.l+=R(t.a,a-4)<<4,t.l+=function(t,e){var i,s,a=1,r=0;for(s=0;t.A>s;++s)i=P(e,t.B,a),a<<=1,a+=i,r|=i<<s;return r}(t.t,t.a),0>t.l)return-1==t.l?1:-1}else t.l=n;if(o(l(t.l),t.d)>=0||t.l>=t.m)return-1;(function(t,e,i){var s=t.D-e-1;for(0>s&&(s+=t.c);0!=i;--i)s>=t.c&&(s=0),t.x[t.D++]=t.x[s++],t.D>=t.c&&b(t)})(t.b,t.l,s),t.d=r(t.d,l(s)),t.I=g(t.b,0)}else e=function(t,e,i){return t.F[((e&t.Y)<<t.g)+((255&i)>>>8-t.g)]}(t.k,h(t.d),t.I),t.I=7>t.f?function(t,e){var i=1;do{i=i<<1|P(e,t.v,i)}while(256>i);return i<<24>>24}(e,t.a):function(t,e,i){var s,a,r=1;do{if(a=i>>7&1,i<<=1,s=P(e,t.v,(1+a<<8)+r),r=r<<1|s,a!=s){for(;256>r;)r=r<<1|P(e,t.v,r);break}}while(256>r);return r<<24>>24}(e,t.a,g(t.b,t.l)),function(t,e){t.x[t.D++]=e,t.D>=t.c&&b(t)}(t.b,t.I),t.f=function(t){return 4>t?0:10>t?t-3:t-6}(t.f),t.d=r(t.d,B);return 0}(t.h);if(-1==e)throw Error("corrupted input");t.$=q,t.Z=t.h.d,(e||o(t.h.U,O)>=0&&o(t.h.d,t.h.U)>=0)&&(b(t.h.b),f(t.h.b),t.h.a.K=null,t.X=0)}(t),t.X}function v(t){t.b={},t.a={},t.q=a(192),t.E=a(12),t.s=a(12),t.u=a(12),t.r=a(12),t.n=a(192),t.j=a(4),t.J=a(114),t.t=z({},4),t.C=k({}),t.o=k({}),t.k={};for(var e=0;4>e;++e)t.j[e]=z({},6);return t}function x(t,e){for(;e>t.e;++t.e)t.G[t.e]=z({},3),t.H[t.e]=z({},3)}function w(t,e,i){return P(e,t.M,0)?8+(P(e,t.M,1)?8+E(t.L,e):E(t.H[i],e)):E(t.G[i],e)}function k(t){return t.M=a(2),t.G=a(16),t.H=a(16),t.L=z({},8),t.e=0,t}function M(t){T(t.M);for(var e=0;t.e>e;++e)T(t.G[e].B),T(t.H[e].B);T(t.L.B)}function S(t,e,i){var s,r;if(null==t.F||t.g!=i||t.y!=e)for(t.y=e,t.Y=(1<<e)-1,t.g=i,r=1<<t.g+t.y,t.F=a(r),s=0;r>s;++s)t.F[s]=A({})}function A(t){return t.v=a(768),t}function z(t,e){return t.A=e,t.B=a(1<<e),t}function E(t,e){var i,s=1;for(i=t.A;0!=i;--i)s=(s<<1)+P(e,t.B,s);return s-(1<<t.A)}function P(t,e,i){var s,a=e[i];return(-2147483648^(s=(t.i>>>11)*a))>(-2147483648^t.p)?(t.i=s,e[i]=a+(2048-a>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),0):(t.i-=s,t.p-=s,e[i]=a-(a>>>5)<<16>>16,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8),1)}function R(t,e){var i,s,a=0;for(i=e;0!=i;--i)t.i>>>=1,s=t.p-t.i>>>31,t.p-=t.i&s-1,a=a<<1|1-s,-16777216&t.i||(t.p=t.p<<8|c(t.K),t.i<<=8);return a}function T(t){for(var e=t.length-1;e>=0;--e)t[e]=1024}function F(t){for(var e,i,s,a=0,r=0,o=t.length,n=[],l=[];o>a;++a,++r){if(128&(e=255&t[a]))if(192==(224&e)){if(a+1>=o)return t;if(128!=(192&(i=255&t[++a])))return t;l[r]=(31&e)<<6|63&i}else{if(224!=(240&e))return t;if(a+2>=o)return t;if(128!=(192&(i=255&t[++a])))return t;if(128!=(192&(s=255&t[++a])))return t;l[r]=(15&e)<<12|(63&i)<<6|63&s}else{if(!e)return t;l[r]=e}16383==r&&(n.push(String.fromCharCode.apply(String,l)),r=-1)}return r>0&&(l.length=r,n.push(String.fromCharCode.apply(String,l))),n.join("")}function D(t){return t[1]+t[0]}var _=2,C=3,j="function"==typeof setImmediate?setImmediate:setTimeout,L=4294967296,q=[i,-4294967296],O=[0,0],B=[1,0];return{decompress:function(e,i,s){var a,r,o,n,l={},h=void 0===i&&void 0===s;if("function"!=typeof i&&(r=i,i=s=0),s=s||function(e){return void 0!==r?function(e,i){t({action:C,cbn:i,result:e})}(o?e:-1,r):void 0},i=i||function(e,i){return void 0!==r?t({action:_,cbn:r,result:e,error:i}):void 0},h){for(l.d=u({},e);y(l.d.Q););return F(d(l.d.S))}try{l.d=u({},e),n=D(l.d.N),o=n>-1,s(0)}catch(t){return i(null,t)}j((function t(){try{for(var e,r=0,h=(new Date).getTime();y(l.d.Q);)if(++r%1e3==0&&(new Date).getTime()-h>200)return o&&(a=D(l.d.Q.h.d)/n,s(a)),j(t,0),0;s(1),e=F(d(l.d.S)),j(i.bind(null,e),0)}catch(t){i(null,t)}}),0)}}}();const Ui={decompress:(t,e)=>{Vi.decompress(new Uint8Array(t),e)}},Wi={getMesh:(t,e)=>{let i={};if(e){const e={},i={};let s;t.traverse((t=>{if(t.isGroup){let s=Wi.groupToMesh(t);s&&(s.applyMatrix4(t.matrix),e[t.name]=t,i[t.name]=s)}}));for(let t in e)s=e[t].parent,s.remove(e[t]),s.add(i[t])}return t.traverse((t=>{t.isMesh&&(i[t.name]=t)})),i},getGroup:(t,e,i)=>{const s={};return t.traverse((t=>{t.isGroup&&(s[t.name]=e?Wi.groupToMesh(t,mats):t)})),s},getMaterial:t=>{const e={};let i,s=[];return t.traverse((t=>{t.isMesh&&(i=t.material,-1===s.indexOf(i.name)&&(s.push(i.name),e[i.name]=i))})),e},groupToMesh:t=>{if(t.children[0].name!==t.name+"_1")return!1;if(!t.children[0].isMesh)return!1;let e=[],i=[],s=t.children.length;for(;s--;)i[s]=t.children[s].material,e[s]=t.children[s].geometry,e[s].group=s;let a=new tt(new $t(e,!0),i);return a.name=t.name,a},symetric:t=>{t.isMesh&&(t=t.geometry);let e=t.attributes.uv.array,i=.5*e.length;for(;i--;)e[2*i]<0&&(e[2*i]*=-1);t.attributes.uv.needsUpdate=!0},uv2:t=>{t.isMesh&&(t=t.geometry),t.setAttribute("uv2",t.attributes.uv)},autoMorph:(t,e,i=!0,a=!1)=>{let r,o,n,l,h,c,d,p,u,m,b,g={},f=[];t.traverse((t=>{t.isMesh&&-1!==t.name.search("__M__")&&(g[t.name]=t.geometry,f.push(t))}));for(let t in g)if(r=t.substring(0,t.indexOf("__")),o=t.substring(t.lastIndexOf("__")+2),n=e[r],n)if(h=n.geometry,c=g[t],h.morphTargetsRelative=a,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],i&&(h.morphAttributes.normal=[]),n.morphTargetInfluences=[],n.morphTargetDictionary={}),l=h.morphAttributes.position.length,a){for(d=c.attributes.position.array.length,m=[];d--;)m[d]=c.attributes.position.array[d]-h.attributes.position.array[d];p=new s(m,3)}else p=new s(c.attributes.position.array,3);h.morphAttributes.position.push(p),i&&(u=new s(c.attributes.normal.array,3),h.morphAttributes.normal.push(u)),n.morphTargetInfluences.push(0),n.morphTargetDictionary[o]=l}else console.warn("Morph "+o+" target is no good on "+n.name);for(g={},d=f.length;d--;)b=f[d],b.parent&&b.parent.remove(b),b.material&&b.material.dispose(),b.geometry&&b.geometry.dispose()}},Hi={manager:new dt,renderer:null,msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],lzma:null,dracoLoader:null,dracoPath:"./build/draco/",basisPath:"./build/basis/",useLocal:!1,formatGltf:{draco:!0,ktx2:!1,meshop:!1},setSupport:t=>{for(let e in t)Hi.formatGltf[e]&&(Hi.formatGltf[e]=t[e])},maxAnisotropy:1,onLoad:()=>{},onEnd:()=>{},log:t=>{},materialRoot:t=>{console.log(t)},setLoadEvent:(t,e)=>{Hi.onLoad=t,Hi.onEnd=e},prefix:t=>{let e="";switch(t){case"S":case"sound":case"mp3":case"wav":case"ogg":e="S_";break;case"I":case"image":case"jpg":case"png":e="I_";break;case"E":case"hdr":case"env":case"T":case"texture":e="T_";break;case"J":case"json":e="J_";break;case"JS":case"js":e="JS_";break;case"H":case"bin":case"hex":e="H_";break;case"O":case"object3d":e="O_";break;case"M":case"material":e="M_"}return e},dispose:()=>{Hi.data.forEach((function(t,e){(t.isMaterial||t.isTexture)&&(t.dispose(),Hi.data.delete(e)),t.isObject3D&&(t.traverse((function(t){t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose&&t.material.dispose())})),Hi.data.delete(e))}))},createElementNS:t=>document.createElementNS("http://www.w3.org/1999/xhtml",t),exist:(t,e="")=>!!Hi.get(t,e),delete:(t,e="")=>Hi.data.delete(Hi.prefix(e)+t),get:(t,e="")=>Hi.data.get(Hi.prefix(e)+t),set:(t,e,i="",s)=>{e?(e.isMaterial&&(i="material",e.name=t,Hi.materialRoot(e,s)),e.isTexture&&(i="texture"),e.isObject3D&&(i="object3d"),Hi.get(t,i)||Hi.data.set(Hi.prefix(i)+t,e)):console.log("Loading error on "+t)},getScript:t=>Hi.data.get(Hi.prefix("js")+t),getMaterials:t=>("string"==typeof t&&(t=Hi.get(t,"O")),Wi.getMaterial(t)),getGLB:(t,e)=>("string"==typeof t&&(t=Hi.get(t,"O")),t?(e&&Wi.getMesh(t,e),t):console.error("Not find Model ?")),getMesh:(t,e)=>("string"==typeof t&&(t=Hi.get(t,"O")),t?Wi.getMesh(t,e):console.error("Not find Model ?")),getGroup:(t,e,i)=>("string"==typeof t&&(t=Hi.get(t,"O")),Wi.getGroup(t,e,i)),applyMorph(t,e=null,i=!0,s=!0){let a;a=t.isObject3D?t:Hi.get(t,"O"),e||(e=Hi.getMesh(t)),a&&e&&Wi.autoMorph(a,e,i,s)},uv2(t){Wi.uv2(t)},symetric(t){Wi.symetric(t)},objectSpaceNormal(t){t.material.normalMapType=vt},add:(t,e,i)=>{Hi.set(t,e,i),Hi.next()},getMaterial:t=>Hi.data.get("M_"+t),texture:(t={})=>{Hi.loaderMap||(Hi.loaderMap=new ft);let e=t.name||"",i=t.format||"";if(t.url&&(-1!==t.url.lastIndexOf(".")?(e=t.url.substring(t.url.lastIndexOf("/")+1,t.url.lastIndexOf(".")),i=t.url.substring(t.url.lastIndexOf(".")+1).toLowerCase()):e=t.url.substring(t.url.lastIndexOf("/")+1)),-1===e.search("_c")&&-1===e.search("_l")&&-1===e.search("_u")&&-1===e.search("_d")||(t.srgb=!0),Hi.exist(e,"texture"))return Hi.get(e,"texture");if(Hi.exist(e,"image"))return Hi.getTexture(e,t);if("ktx2"===i){const i=new yt;return Hi.data.set("T_"+e,i),Hi.loaderKTX2().load(t.url,(function(e){Hi.setTextureOption(e,t),i.copy(e),e.dispose(),t.callback&&t.callback()})),i}return Hi.loaderMap.load(t.url,(function(i){return Hi.setTextureOption(i,t),Hi.data.set("T_"+e,i),t.callback&&t.callback(),i}))},getTexture:(t,e={})=>{t=(e.quality?e.quality+"k_":"")+t;let i=Hi.get(t,"texture");if(!i){let s=Hi.get(t,"image");if(!s)return null;i=new gt(s),-1===t.search("_c")&&-1===t.search("_d")&&-1===t.search("_l")&&-1===t.search("_u")||(e.srgb=!0),Hi.data.set("T_"+t,i)}return Hi.setTextureOption(i,e),i},setTextureOption:(t,e={})=>{t.colorSpace=e.encoding||e.srgb?y:mt,t.flipY=(void 0!==e.flipY||void 0!==e.flip)&&e.flipY,e.anisotropy&&(t.anisotropy="max"===e.anisotropy?Hi.maxAnisotropy:e.anisotropy),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),e.repeat&&(t.repeat.fromArray(e.repeat),t.wrapS=t.wrapT=f),e.center&&t.center.fromArray(e.center),e.offset&&t.offset.fromArray(e.offset),e.filter&&"near"===e.filter&&(t.minFilter=bt,t.magFilter=bt),e.channel&&(t.channel=e.channel),t.needsUpdate=!0},loadAsync:(t,e="",i="")=>new Promise(((s,a)=>{Hi.waiting=!0,Hi.load(t,(()=>{Hi.waiting=!1}),e,i)})),load:(t,e,i="",s="",a=0)=>{Hi.msg=s;let r=[],o=e||function(){},n=("undefined"==typeof performance?Date:performance).now();"string"==typeof t||t instanceof String?r.push(t):r=r.concat(t),Hi.tmp.push({urls:r,path:i,callback:o,start:n,quality:a}),Hi.inLoad||Hi.loadOne()},loadOne:()=>{Hi.inLoad=!0,Hi.onLoad();let t=Hi.tmp[0].path+Hi.tmp[0].urls[0],e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),i=t.substring(t.lastIndexOf(".")+1).toLowerCase();"jpg"!==i&&"png"!==i||(e=(Hi.tmp[0].quality?Hi.tmp[0].quality+"k_":"")+e),Hi.exist(e,i)?Hi.next():Hi.loading(t,e,i)},next:()=>{Hi.tmp[0].urls.shift(),0===Hi.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-Hi.tmp[0].start),Hi.tmp[0].callback(),Hi.tmp.shift(),Hi.tmp.length>0?Hi.loadOne():(Hi.inLoad=!1,Hi.clearDRACO(),Hi.clearKTX2(),Hi.onEnd())):Hi.loadOne()},loading:(t,e,i)=>{switch(Hi.log(Hi.msg),i){case"glb":case"gltf":Hi.load_GLTF(t,e);break;case"fbx":case"FBX":Hi.load_FBX(t,e);break;case"obj":Hi.load_OBJ(t,e);break;case"stl":Hi.load_STL(t,e);break;case"ktx2":Hi.load_KTX2(t,e);break;case"hdr":Hi.load_RGBE(t,e);break;case"exr":Hi.load_EXR(t,e);break;default:Hi.extand(t,e,i)}},extand:(t,e,i)=>{Hi.XHTTP||(Hi.XHTTP=new XMLHttpRequest);const s=Hi.XHTTP;switch(s.open("GET",t,!0),"json"===i&&s.overrideMimeType("application/json"),i){case"bin":case"hex":case"wasm":case"mp3":case"wav":case"ogg":s.responseType="arraybuffer";break;case"jpg":case"png":s.responseType="blob";break;case"bvh":case"glsl":case"js":case"json":s.responseType="text"}s.onreadystatechange=function(){4===s.readyState&&(s.status>=300?console.log("Error, status code = "+s.status):Hi.direct(s.response,e,i))},"onprogress"in s&&(s.onprogress=function(t){}),s.send(null)},direct:(t,e,i)=>{switch(i){case"jpg":case"png":let s=Hi.createElementNS("img");s.onload=function(t){window.URL.revokeObjectURL(s.src),Hi.add(e,s,"image")},s.src=window.URL.createObjectURL(t);break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(t.slice(0),(function(t){Hi.add(e,t,"sound")}),(function(t){console.error("decodeAudioData error",t)}));break;case"hex":case"bin":Ui.decompress(t,(t=>{Hi.add(e,t,i)}));break;case"wasm":Hi.add(e,new Uint8Array(t),i);break;case"json":Hi.add(e,JSON.parse(t),i);break;default:Hi.add(e,t,i)}},clearKTX2:()=>{Hi.KTX2&&(Hi.KTX2.dispose(),Hi.KTX2=null)},clearDRACO:()=>{Hi.dracoLoader&&(Hi.dracoLoader.dispose(),Hi.dracoLoader=null),Hi.GLTF&&(Hi.GLTF=null)},loaderFILE:()=>(Hi.FILE||(Hi.FILE=new ht(Hi.manager)),Hi.FILE),loaderDRACO:()=>{if(Hi.dracoLoader)return Hi.dracoLoader;if(!Hi.dracoLoaderType)if(navigator.userAgentData)Hi.dracoLoaderType="wasm";else{let t=navigator.userAgent.toLowerCase();Hi.dracoLoaderType=-1!==t.indexOf("safari")&&-1===t.indexOf("chrome")?"js":"wasm"}return Hi.dracoLoader=(new Bi).setDecoderConfig({type:Hi.dracoLoaderType}).setDecoderPath(Hi.dracoPath).setUseLocal(Hi.useLocal),Hi.dracoLoader},loaderKTX2:()=>(Hi.KTX2||(Hi.KTX2=new Ni(Hi.manager).setTranscoderPath(Hi.basisPath).detectSupport(Hi.renderer).setUseLocal(Hi.useLocal)),Hi.KTX2),loaderGLTF:()=>(Hi.GLTF||(Hi.GLTF=new se(Hi.manager).setCrossOrigin("anonymous"),Hi.formatGltf.draco&&Hi.GLTF.setDRACOLoader(Hi.loaderDRACO()),Hi.formatGltf.ktx2&&Hi.GLTF.setKTX2Loader(Hi.loaderKTX2()),Hi.formatGltf.meshop&&Hi.GLTF.setMeshoptDecoder(qi)),Hi.GLTF),loaderFBX:()=>(Hi.FBX||(Hi.FBX=new ae(Hi.manager)),Hi.FBX),loaderSTL:()=>(Hi.STL||(Hi.STL=new oe(Hi.manager)),Hi.STL),loaderOBJ:()=>(Hi.OBJ||(Hi.OBJ=new re(Hi.manager)),Hi.OBJ),loaderRGBE:()=>(Hi.RGBE||(Hi.RGBE=new ne(Hi.manager)),Hi.RGBE),loaderEXR:()=>(Hi.EXR||(Hi.EXR=new le(Hi.manager)),Hi.EXR),loaderUltra:()=>(Hi.ULTRA||(Hi.ULTRA=new he(Hi.manager).setDataType(THREE.HalfFloatType)),Hi.ULTRA),load_GLTF:(t,e)=>{Hi.loaderGLTF().load(t,(function(t){const i=t.scene;if(t.animations){const e=t.animations,s=new ut(t.scene);i.mixer=s,i.actions={};for(let t=0;t<e.length;t++){let a=e[t];i.actions[a.name]=s.clipAction(a)}i.play=t=>{i.actions[t]&&(i.actions[t].paused=!1,i.actions[t].time=0,i.actions[t].play())},i.pause=(t,e=!0)=>{i.actions[t]&&(i.actions[t].paused=e)}}Hi.add(e,i)}))},load_FBX:(t,e)=>{Hi.loaderFBX().load(t,(function(t){Hi.add(e,t)}))},load_OBJ:(t,e)=>{Hi.loaderOBJ().load(t,(function(t){Hi.add(e,t)}))},load_STL:(t,e)=>{Hi.loaderSTL().load(t,(function(t){let i=new tt(t);Hi.add(e,i)}))},load_KTX2:(t,e,i)=>{Hi.loaderKTX2().load(t,(function(t){return Hi.add(e,t),t}))},load_RGBE:(t,e)=>{Hi.loaderRGBE().load(t,(function(t){t.mapping=pt,Hi.add(e,t)}))},load_EXR:(t,e,i)=>{Hi.loaderEXR().load(t,(function(t){return i&&i(t),t}))},direct_EXR:(t,e)=>{Hi.loaderEXR().parse(url,(function(t){return Hi.add(e,t),t}))}};class Ki{constructor(t,e){this.target=e||t,this.baseGeometry=t.geometry,this.geometry=this.target.geometry,this.V=[new n,new n,new n],this.X=[new xt,new xt,new l],this.M=[new n,new n,new n],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const t=this.geometry;let e=t.attributes.position.array.length;t.setAttribute("color",new s(new Array(e).fill(0),3))}resetEdge(t){let e=t.length;for(;e--;)t[e]=0}getEdge(t,e,i=!1,s=!1){let a=t.attributes.position.array;const r=t.index.array;let o,n,l,h,c,d,p,u=this.V[0],m=this.V[1],b=this.V[2],g=0;for(s&&(a=this.getMorph()),i&&(a=this.getSkinned(a)),(i||s)&&this.resetEdge(e),o=this.indexLength;o--;)n=r[g],l=r[g+1],h=r[g+2],u.fromArray(a,3*n),m.fromArray(a,3*l),b.fromArray(a,3*h),c=u.distanceTo(m),d=u.distanceTo(b),p=m.distanceTo(b),e[n]+=.5*(c+d),e[l]+=.5*(c+p),e[h]+=.5*(d+p),g+=3}isZero(t){return 0===t.x&&0===t.y&&0===t.z}getMorph(){const t=this.target.morphTargetInfluences,e=this.geometry.morphAttributes.position,i=t.length,s=this.geometry.attributes.position.array;let a,r,o,n,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],d=this.M[2],p=this.geometry.morphTargetsRelative;for(r=l;r--;){for(a=3*r,c.fromArray(s,a),h.set(0,0,0),o=i;o--;)0!=t[o]&&(n=e[o].data?e[o].data.array:e[o].array,p?h.addScaledVector(d.fromArray(n,a),t[o]):h.addScaledVector(d.fromArray(n,a).sub(c),t[o]));c.add(h),c.toArray(this.back,a)}return this.back}getSkinned(t){const e=this.target.skeleton;e.boneMatrices;const i=this.geometry,s=i.attributes.skinIndex.array,a=i.attributes.skinWeight.array,r=this.target.bindMatrix,o=this.target.bindMatrixInverse;let n,l,h,c,d,p=this.V[0],u=this.V[1],m=this.V[2],b=this.X[0],g=this.X[1],f=this.X[2];for(n=i.attributes.position.count;n--;){for(d=3*n,b.fromArray(s,4*n),g.fromArray(a,4*n),p.fromArray(t,d).applyMatrix4(r),u.set(0,0,0),l=4;l--;)c=g.getComponent(l),c>0&&(h=b.getComponent(l),f.multiplyMatrices(e.bones[h].matrixWorld,e.boneInverses[h]),u.addScaledVector(m.copy(p).applyMatrix4(f),c));u.applyMatrix4(o),u.toArray(this.back,d)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const t=this.geometry.attributes.color.array;let e,i,s,a=this.length;for(;a--;)e=this.originEdges[a],i=(e-this.targetEdges[a])/e+.5,s=3*a,t[s]=i>.5?2*(i-.5):0,t[s+1]=0,t[s+2]=i<.5?1-2*i:0;this.geometry.attributes.color.needsUpdate=!0}}class Ji extends it{constructor(t,e){super(),this.isReady=!1,this.skeleton=e,this.bones=this.skeleton.bones,this.root=t,this.box=new r,this.mtxr=new l,this.mtx0=new l,this.mtx1=new l,this.mtx=new l,this.mtx2=new l,this.p=new n,this.s=new n,this.q=new $,this.e=new nt,this.mat=new S({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(t){if(!this.isReady)return;let e,i,s=this.children,a=s.length;for(this.mtxr.copy(this.root.matrixWorld).invert();a--;)e=s[a],i=e.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,i.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,e.userData.decal),this.mtx.decompose(this.p,this.q,this.s),e.position.copy(this.p),e.quaternion.copy(this.q),e.updateMatrix();super.updateMatrixWorld(t)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const t=this.bones;let e,i,s,a,r,o,l,h,c,d,p,u=new n,m=new n,b=t.length;for(e=0;e<b;e++)h=null,a=t[e],i=a.name,r=a.parent,r&&(s=r.name,u.setFromMatrixPosition(r.matrixWorld),m.setFromMatrixPosition(a.matrixWorld),l=u.distanceTo(m),c=[0,0,.5*l],o=[l,1,1],d=[0,0,0],p="_C","head"===s&&"End_head"===i&&(h="box",o=[.16,.2,l],c=[0,.025,.5*-l]),"chest"===s&&"neck"===i&&(h="box",o=[.3,.28,l],c=[0,0,.5*-l]),"abdomen"===s&&(h="box",o=[.28,.24,l+.14],d[2]=0,c=[0,0,.5*-l],c[2]+=.07),"rThigh"===s&&(h="box",o=[.15,.15,l]),"lThigh"===s&&(h="box",o=[.15,.15,l]),"rShin"===s&&(h="box",o=[.12,.12,l+.1],c[2]+=.05),"lShin"===s&&(h="box",o=[.12,.12,l+.1],c[2]+=.05),"rShldr"===s&&(h="box",o=[l+.06,.12,.12],c[0]=.03-c[2],c[2]=0),"lShldr"===s&&(h="box",o=[l+.06,.12,.12],c[0]=c[2]-.03,c[2]=0),"rForeArm"===s&&(h="box",o=[l+.1,.1,.1],c[0]=-c[2]-.05,c[2]=0),"lForeArm"===s&&(h="box",o=[l+.1,.1,.1],c[0]=c[2]+.05,c[2]=0),null!==h&&this.addMesh(r,h,o,c,d,"_C"));this.isReady=!0}addMesh(t,e,i,s,a,r){this.mtx.makeTranslation(s[0],s[1],s[2]);var o=new tt(this.box,this.mat);o.scale.fromArray(i),o.userData.decal=this.mtx.clone(),o.userData.bone=t,o.userData.size=i,this.add(o)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const Xi={mixRatio:0,threshold:.1,normal:.25,hair:7675906,bow:1049602,sheen:1,sheenRoughness:.6,metalness:.6,roughness:.4,vertexColors:!1,alphaTest:.1,h_metal:0,h_rough:.5,clearcoat:1,wireframe:!1,transparent:!1,opacity:1},Qi={refSize:1.81,isBreath:!1,isEyeMove:!1,haveHair:!0,haveBlink:!0,haveMorph:!0,morphNormal:!1,morphRelative:!1,haveLOD:!0,levelHigh:["body","Head","crane","eyelash","eyebrow","tear","eye_l","eye_r","eye_l_s","eye_r_s"],levelHair:["hair","hair_man"],levelLow:["body_low"],skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureQuality:1,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_t.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg","avatar_ao.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:Xi,materialRef:"skin",materials:{skin:{type:"Sss",map:"avatar_c",normalMap:"avatar_n",reflectivity:.2,roughness:.54,metalness:.14,normalScale:new b(Xi.normal,-Xi.normal),sheenColor:6291456,sheen:Xi.sheen,sheenRoughness:Xi.sheenRoughness,wireframe:Xi.wireframe,aoMap:"avatar_ao",aoMapIntensity:1,vertexColors:!1,sssMap:"avatar_t",sssColor:new x(15606563),sssAmbient:.5,sssDistortion:.6,sssAttenuation:.1,sssScale:6},mouth:{type:"Standard",map:"mouth_c",roughness:.02,metalness:0,vertexColors:!1,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n",normalScale:new b(.5,-.5)},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:.1,clearcoat:1,transparent:!0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new b(2,-2),clearcoat:.25},hair:{type:"Standard",color:Xi.hair,aoMap:"hair",metalnessMap:"hair",roughness:.6,metalness:1,alphaMap:"hair_a",side:E,shadowSide:E,emissive:Xi.hair,emissiveIntensity:.5,transparent:!0,blending:wt,blendDst:I,blendDstAlpha:L,alphaToCoverage:!0},hair_man:{type:"Standard",color:Xi.hair,aoMap:"hair_man",metalnessMap:"hair_man",roughness:.6,metalness:1,alphaMap:"hair_man_a",side:E,transparent:!0,blending:wt,blendDst:I,blendDstAlpha:L,forceSinglePass:!0,alphaToCoverage:!0},eyelash:{type:"Standard",color:Xi.hair,map:"eyelash_c",alphaMap:"eyelash_a",transparent:!0,opacity:1,side:E,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Standard",map:"eyelash_c",roughness:0,metalness:1,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic"}},changeMaterial:(t={},e=!1)=>{if(!Hi.getMaterial(Qi.materialRef))return;const i=Qi.setting,s=Qi.materials;let a,r=!1;for(let e in t)void 0!==i[e]&&i[e]!==t[e]&&(i[e]=t[e],r=!0);if(r)for(let i in s){a=Hi.getMaterial(i);for(let r in t)void 0!==a[r]&&(e&&s[i][r]?a[r]=s[i][r]:a[r]=t[r])}},applyMaterial:(t,e)=>{const i=!0,s=Hi.getMaterial("skin");//!Human.haveLOD;
t.traverse((t=>{if(t.isMesh)switch(t.name){case"body":case"Head":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=i;break;case"body_low":t.material=s,t.receiveShadow=!0,t.castShadow=!0,t.visible=!1;break;case"crane":t.material=s,t.receiveShadow=!0,t.castShadow=!1,t.visible=!Qi.haveHair;break;case"mouth":t.material=Hi.getMaterial("mouth")||s,t.receiveShadow=!0,t.castShadow=!1,t.visible=i,t.geometry.computeVertexNormals();break;case"eyelash":case"eyebrow":t.material=Hi.getMaterial("eyelash")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"tear":t.material=Hi.getMaterial("tear")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"eye_l":case"eye_r":t.material=Hi.getMaterial("eye")||s,t.receiveShadow=!1,t.castShadow=!1;break;case"eye_l_s":case"eye_r_s":t.material=Hi.getMaterial("sub_eye")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=i;break;case"hair":t.material=Hi.getMaterial("hair")||s,t.receiveShadow=!1,t.castShadow=!0,t.visible=!!Qi.haveHair&&i;break;case"hair_man":t.material=Hi.getMaterial("hair_man")||s,t.receiveShadow=!1,t.castShadow=!1,t.visible=!!Qi.haveHair&&i}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,5]},{name:"rShldr",values:[-20,-2,-5]},{name:"lForeArm",values:[0,0,10]},{name:"rForeArm",values:[0,0,-10]},{name:"lHand",values:[0,15,10]},{name:"rHand",values:[0,-15,-10]},{name:"lThumb2",values:[0,25,10]},{name:"rThumb2",values:[0,-25,-10]}]},Yi={wireframe:!1,normal:.25,hair:2433041},Zi={isBreath:!1,isEyeMove:!1,haveMorph:!0,skeletonRef:"body_low",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],textureRef:"avatar_c_0k",texturePath:"assets/textures/avatar/",textures:["avatar_c_0k.jpg","avatar_n_0k.jpg","avatar_ao_0k.jpg","hair_man_a_0k.jpg","Hair_01_c.png","Hair_01_n.png"],modelPath:"assets/models/avatar/",forceModel:null,setting:Yi,materialRef:"skin_low",materials:{skin_low:{type:"Standard",map:"avatar_c_0k",aoMap:"avatar_ao_0k",normalMap:"avatar_n_0k",normalScale:new b(Yi.normal,-Yi.normal),envMapIntensity:.3,roughness:.22,metalness:0,vertexColors:!1},hair_low:{type:"Standard",color:Yi.hair,alphaMap:"hair_man_a_0k",transparent:!0},hair_low_2:{type:"Standard",color:Yi.hair,map:"Hair_01_c",normalMap:"Hair_01_n"}},changeMaterial:(t={},e=!1)=>{if(!Hi.getMaterial(Zi.materialRef))return;const i=Lee.materials;let s;for(let a in i){s=Hi.getMaterial(a);for(let r in t)void 0!==s[r]&&(e&&i[a][r]?s[r]=i[a][r]:s[r]=t[r])}},applyMaterial:(t,e)=>{const i=Hi.getMaterial(Zi.materialRef);t.traverse((t=>{if(t.isMesh)switch(t.name){case"body_low":t.material=i,t.receiveShadow=!0,t.castShadow=!0;break;case"hair_low":t.material=Hi.getMaterial("hair_low")||i,t.receiveShadow=!1,t.castShadow=!1;break;case"hair_low_2":t.material=Hi.getMaterial("hair_low_2")||i,t.receiveShadow=!1,t.castShadow=!1}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,0]},{name:"rShldr",values:[-20,-2,0]}]},$i={metalness:.33,roughness:.11,clearcoat:0,wireframe:!1},ts={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg","eva_ao.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:$i,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:$i.roughness,metalness:$i.metalness,wireframe:$i.wireframe,clearcoat:$i.clearcoat,aoMap:"eva_ao"},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:$i.roughness,metalness:$i.metalness,wireframe:$i.wireframe,clearcoat:$i.clearcoat,aoMap:"eva_ao"},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:$i.roughness,metalness:$i.metalness,wireframe:$i.wireframe,clearcoat:$i.clearcoat,aoMap:"eva_ao"}},changeMaterial:(t,e=!1)=>{if(!Hi.getMaterial(ts.materialRef))return;const i=ts.materials;let s;for(let a in i){s=Hi.getMaterial(a);for(let r in t)void 0!==s[r]&&(e&&i[a][r]?s[r]=i[a][r]:s[r]=t[r]);s.needsUpdate=!0}},applyMaterial:(t,e)=>{const i=Hi.getMaterial(e);t.traverse((t=>{if(t.isMesh)switch(t.material=i,t.receiveShadow=!0,t.castShadow=!0,t.name){case"eva_2_head":case"eva_2_mach":t.visible="eva02"===e;break;case"eva_L_COLLAR":case"eva_R_COLLAR":t.visible="eva00"!==e;break;case"eva_HEAD":case"eva_MACHOIR":t.visible="eva01"===e;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":t.visible="eva00"===e;break;case"eva_0_CHEST2":t.visible="eva01"!==e}}))}},es={metalness:.2,roughness:.8,wireframe:!1},is={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:es,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:es.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{if(!Hi.getMaterial(is.materialRef))return;const i=is.materials;let s;for(let a in i){s=Hi.getMaterial(a);for(let r in t)void 0!==s[r]&&(e&&i[a][r]?s[r]=i[a][r]:s[r]=t[r])}},applyMaterial:(t,e)=>{const i=Hi.getMaterial("lee_material");t.traverse((t=>{t.isMesh&&(t.material=i,t.receiveShadow=!0,t.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},ss={metalness:.2,roughness:.8,wireframe:!1},as={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"barbados",multyMaterial:!0,fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:[],modelPath:"assets/models/",forceModel:"barbados",setting:ss,materialRef:"bb",materials:{bb:{type:"Physical",roughness:.3,metalness:.08,wireframe:ss.wireframe,sheen:2.2,sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(t,e=!1)=>{},applyMaterial:(t,e)=>{},adjustment:()=>[]},rs=1/30,os=Math.PI/180,ns=180/Math.PI,ls=new n,hs={tmp:[],model:[],avatar:null,callback:()=>{},add:(t,e)=>{hs.tmp=[...t],hs.callback=e,hs.tmp.length&&hs.loadOne()},loadOne:()=>{let t=hs.tmp[0];hs.avatar=new cs({type:t,callback:hs.next,morph:!0,isPreload:!0})},next:t=>{hs.avatar.dispose(),hs.tmp.shift(),0===hs.tmp.length?hs.callback():hs.loadOne()}};class cs extends kt{constructor(t={}){switch(super(),this.isPreload=t.isPreload||!1,this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.rootPath=t.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",this.callback=t.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.randomMorph=t.randomMorph||!1,this.randomSize=t.randomSize||!1,this.actionPose=null,this.model=t.type||"man",this.startAnimation=t.anim||"idle",this.bodyMorph=[0,0],this.faceMorph=[0,0],this.ref=null,this.model){case"barbados":this.ref=as;break;case"lee":this.ref=is;break;case"man":case"woman":this.ref=Qi;break;case"man_low":case"woman_low":this.ref=Zi;break;case"eva00":case"eva01":case"eva02":this.ref=ts}this.compact=void 0===t.compact||t.compact,this.haveMorph=void 0!==t.morph&&t.morph,this.fullMaterial=void 0===t.material||t.material,this.size=t.size||1,this.realSize=0,this.baseSize=0,this.fullMorph=this.ref.fullMorph||[],this.randomMorph&&this.fullMorph.length&&(this.haveMorph=!0),this.textureQuality=this.ref.textureQuality||0,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.haveBlink=this.ref.haveBlink||!1,this.haveLOD=this.ref.haveLOD||!1,t.noLOD&&(this.ref.haveLOD=!1,this.haveLOD=!1),this.lod=-1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new $).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new n,this.eyeTarget=new kt,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new l,this.tmpQ=new $,this.setting={},this.root=Hi.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=ie.clone(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}rand(t=0,e=1){return t+Math.random()*(e-t)}load(){if(this.ref.textures&&this.ref.textures.length)if(this.skin=Hi.getTexture(this.ref.textureRef,{quality:this.textureQuality}),this.skin)this.loadModels();else{const t=this.rootPath+this.ref.texturePath+(this.textureQuality?this.textureQuality+"k/":"");Hi.load(this.ref.textures,this.loadModels.bind(this),t,"loading images...",this.textureQuality)}else this.loadModels()}loadModels(){const t=this.ref.forceModel?this.ref.forceModel:this.model,e=[t+".glb"],i=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&e.push(t+"_morph.glb"),Hi.load(e,this.init.bind(this),i,"loading models...")}update(t){this.done&&this.mixer&&(this.mixer.update(t),this.haveBlink&&this.eyeBlink(),this.isClone||(this.look(10*t),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),this.actionPose&&this.actionPose.setEffectiveWeight(this.getAction("idle")._effectiveWeight),window.gui&&window.gui.updateTimeBarre&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax))}eyeBlink(){const t=this.n++;let e=0;t<=10&&(e=.1*t),t>10&&t<=20&&(e=1-.1*(t-10)),this.n>500&&(this.n=0),this.setMorph("EyeBlink",e)}look(t){if(!this.isEyeMove)return;if(this.isPause)return;const e=window.mouse||{x:0,y:0};t>1&&(t=1),this.headBoneLook.lerp({x:-20*e.y*os,y:0,z:-20*e.x*os},t),this.eyeTarget.position.lerp({x:.5*e.x,y:1,z:.25*-e.y},t);let i=this.headBoneLook;this.tmpQ.setFromEuler({_x:i.x,_y:i.y,_z:i.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let s=this.bones.ER,a=this.bones.EL,r={x:0,y:0,z:1};this.tmpMtx.lookAt(a.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),r),a.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(s.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),r),s.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let t=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,t),this.lerp(1,1.04,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,t),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,t),this.lerp(1.04,1,t),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,t),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(t,e,i){this.position.set(t,e,i),this.updateMatrix()}setRotation(t,e,i,s){let a=this.lerp(this.rotation.y,e,s);this.rotation.set(t,a,i),this.updateMatrix()}lerp(t,e,i){return(1-i)*t+i*e}onReady(){}initMaterial(){if(Hi.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void Hi.set(this.ref.materialRef,new w);let t,e,i;for(const s in this.ref.materials){i={...this.ref.materials[s]},e=i.type,delete i.type;for(const t in i)"envMapIntensity"!==t&&"normalMapType"!==t&&"aoMapIntensity"!==t&&"aoMapIntensity"!==t&&("map"!==t&&-1===t.search("Map")||(i[t]=Hi.getTexture(i[t],{quality:this.textureQuality})));"Basic"===e?t=new S(i):"Standard"===e?t=new w(i):"Physical"===e?t=new v(i):"Sss"===e&&(t=new Ne(i)),t.name=s,Hi.set(s,t)}this.setting=this.ref.setting}setMaterial(t,e){let i=Hi.getMaterial(this.ref.materialRef);if(i)for(let e in t)void 0!==i[e]&&(i[e]=t[e])}setMaterialNormal(t){let e=Hi.getMaterial("skin");e&&(t<0&&(t=0),e.normalScale.set(t,-t))}getMaterial(t){return Hi.getMaterial(t)}init(){if(this.initMaterial(),!this.isClone){let t=this.ref.forceModel?this.ref.forceModel:this.model;this.ref.multyMaterial&&Hi.getMesh(t,!0),this.root=Hi.get(t,"O"),this.ref.applyMaterial(this.root,this.model)}this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.realSize=0,this.root.traverse(function(t){t.raycast=function(){},t.isMesh&&(t.name===this.ref.skeletonRef&&(t.matrixAutoUpdate=!1,this.skeleton=t.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling(),this.realSize=t.geometry.boundingBox.max.y),"Head"===t.name&&(this.realSize=t.geometry.boundingBox.max.y),this.mesh[t.name]=t),t.isBone&&(this.bones[t.name]=t)}.bind(this)),this.realSizeRatio=1/this.realSize,this.baseSize=this.realSize,this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let t in this.mesh)this.mesh[t].isSkinnedMesh&&t!==this.ref.skeletonRef&&(this.mesh[t].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&Hi.applyMorph(this.model+"_morph",this.mesh,this.ref.morphNormal,this.ref.morphRelative),Hi.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new ut(this),0===Hi.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let t=Hi.clip.length;for(;t--;)this.addAction(Hi.clip[t]);this.start()}}setRealSize(t){this.realSize=t;let e=.5+this.baseSize/this.realSize*.5;this.setSize(this.realSize*this.realSizeRatio),this.setHeadSize(e)}setSize(t){this.size=t,this.root.scale.set(1,1,1).multiplyScalar(this.size)}setHeadSize(t){this.bones.head.scale.set(1,1,1).multiplyScalar(t)}addTensionMap(){this.tension1=new Ki(this.mesh.body),this.tension2=new Ki(this.mesh.Head)}setBounding(t){for(let e in this.mesh)this.mesh[e].isMesh&&(this.mesh[e].geometry.boundingSphere.radius=t)}setLevel(t){this.haveLOD&&this.lod!==t&&(this.lod=t,this.hideAll(),0===this.lod?this.setVisible(this.ref.levelLow,!0):(this.setVisible(this.ref.levelHigh,!0),this.ref.haveHair&&this.setVisible(this.ref.levelHair,!0)))}hideAll(){for(let t in this.mesh)this.mesh[t].visible=!1}setVisible(t,e){"string"==typeof t&&(t=[t]);let i,s=t.length;for(;s--;)i=t[s],this.mesh[i]&&(this.mesh[i].visible=e)}setMorph(t,e){e=e<0?0:e,this.haveMorph&&(this.morpher("eyelash",t,e),this.morpher("eyebrow",t,e),this.morpher("tear",t,e),this.morpher("mouth",t,e),this.morpher("body",t,e),this.morpher("Head",t,e),this.morpher("body_low",t,e))}morpher(t,e,i){this.mesh[t]&&this.mesh[t].morphTargetInfluences&&void 0!==this.mesh[t].morphTargetDictionary[e]&&(this.mesh[t].morphTargetInfluences[this.mesh[t].morphTargetDictionary[e]]=i)}lerp(t,e,i){return(1-i)*t+i*e}clone(t){return new this.constructor({type:t.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent&&this.parent.remove(this),this.isClone}start(){this.isPreload?this.callback():this.done||(this.done=!0,this.onReady(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment(),!0),this.randomMorph&&this.setBodyMorph([this.rand(-1,1),this.rand(-1,1)]),this.randomSize&&this.setRealSize(this.rand(1,2)),setTimeout(function(){this.add(this.root),this.callback()}.bind(this),100))}setBodyMorph(t){if(!this.haveMorph)return;t&&(this.bodyMorph=t);let e=Number(this.bodyMorph[0]),i=Number(this.bodyMorph[1]);this.setMorph("MUSCLE",i<0?-i:0),this.setMorph("LOW",i>=0?i:0),this.setMorph("BIG",e<0?-e:0),this.setMorph("MONSTER",e>=0?e:0);let s=.5*(e+1),a=1-.5*(i+1);this.setMaterialNormal(.5*(a+s))}setFaceMorph(t){if(!this.haveMorph)return;t&&(this.faceMorph=t);let e=Number(this.faceMorph[0]),i=Number(this.faceMorph[1]);this.setMorph("Shock",i<0?-i:0),this.setMorph("Frown",i>=0?i:0),this.setMorph("SmileOpen",e<0?-e:0),this.setMorph("Angry",e>=0?e:0)}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new Mt(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new Ji(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(t,e){t.matrix=e.matrixWorld,t.matrixAutoUpdate=!1}loadAnimationJson(t,e){const i=new XMLHttpRequest;i.open("GET",t,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){let t=JSON.parse(i.responseText);this.urls=[];for(let e in t)"main"===e?this.urls.push(...t[e]):this.urls.push(...t[e].map((t=>e+"/"+t)));this.endCallback=e||function(){},this.loadOne()}}.bind(this),i.send()}loadOne(){let t=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+t+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(t="./assets/models/animations.bin"){var e=new XMLHttpRequest;e.open("GET",t,!0),e.responseType="arraybuffer";const i={animations:[]},s=this;e.onload=function(){Ui.decompress(e.response,(t=>{const e=JSON.parse(t);for(let t in e)i.animations.push(St.parse(e[t]));s.applydAnimation(i),s.start()}))},e.send()}loadAnimationGlb(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));Hi.loaderGLTF().load(t,function(t){this.applydAnimation(t,i),e&&e()}.bind(this),null,e)}directGlb(t,e){Hi.loaderGLTF().parse(t,"",function(t){this.stop(),this.applydAnimation(t,e)}.bind(this))}loadAnimationFbx(t,e){let i=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));Hi.loaderFBX().load(t,function(t){this.convertFbx(i,t.animations[0]),e&&e()}.bind(this),null,e)}directFbx(t,e){try{let i=Hi.loaderFBX().parse(t,"");this.convertFbx(e,i.animations[0],!0)}catch(t){console.error("bug",t)}}applydAnimation(t,e){let i=t.animations.length,s=!1;for(1===i&&(e&&(t.animations[0].name=e),s=!0);i--;)this.addClip(t.animations[i]),this.addAction(t.animations[i],s)}addClip(t,e=!1){e&&At.makeClipAdditive(t);let i=Hi.clip.length,s=-1;for(;i--;)Hi.clip[i].name===t.name&&(s=i);-1!==s&&Hi.clip.slice(s,1),Hi.clip.push(t)}addAction(t,e){const i=this.mixer.clipAction(t);i.frameMax=Math.round(30*t.duration),i.play(),i.enabled=!0,-1!==t.name.search("idle")&&(i.enabled=!0),"Jumping Up"===t.name&&(i.loop=LoopPingPong),this.actions.set(t.name,i),window.gui&&window.gui.getAnimation&&window.gui.getAnimation()}getAnimation(t=!1,e=!1){let i=[],s=0;if(e){let e=Hi.clip.length;for(;e--;)i[s]=t?Hi.clip[s].toJSON():Hi.clip[s],s++}else this.actions.forEach((function(e,a){i[s]=t?e._clip.toJSON():e._clip,s++}));return i}exportAnimationLzma(t){this.lzma||(this.lzma=new Ui(this.lzmaPath));const e=this.getAnimation(!0);this.lzma.compress(JSON.stringify(e),2,(function(e){if(t)t({name:"animations",data:new Uint8Array(e),type:"bin"});else{let t=document.createElement("a");t.style.display="none",document.body.appendChild(t),t.href=URL.createObjectURL(new Blob([new Uint8Array(e)],{type:"application/octet-stream"})),t.download="animations.bin",t.click()}}))}armAngle(){}autoToes(){if(!this.fixToe)return;let t=this.getRot("rFoot"),e=this.getRot("lFoot"),i=this.getWorldPos("hip"),s=this.getWorldPos("rToes"),a=this.getWorldPos("lToes");t[0]>0&&s.z-i.z<0?this.setRot("rToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("rToes",0,0,0),e[0]>0&&a.z-i.z<0?this.setRot("lToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(t,e,i){const s=Math.PI/180;let a=new n,r=new $,o=(new $).setFromAxisAngle({x:1,y:0,z:0},90*s);const l=e.tracks,h=[];let c,d,p,u,m=l.length,b=0;for(;m--;){if(p=l[b],u=p.name.substring(0,p.name.lastIndexOf(".")),"hip.position"===p.name){let t=[];for(c=p.values.length/3;c--;)d=3*c,a.set(p.values[d],p.values[d+1],0).multiplyScalar(.01),a.toArray(t,d);h.push(new zt(p.name,p.times,t))}else{let t=[];for(c=p.values.length/4;c--;)d=4*c,"hip"===u?r.set(p.values[d],p.values[d+1],p.values[d+2],p.values[d+3]).multiply(o):r.set(p.values[d],p.values[d+2],-p.values[d+1],p.values[d+3]),r.toArray(t,d);h.push(new Et(p.name,p.times,t))}b++}let g=new St(t,-1,h);g.duration=e.duration,this.stop(),this.addClip(g),this.addAction(g,i)}makePoseTrack(t,e,i=!1){const s=Math.PI/180;let a=new $;const r=e,o=[];let n,l,h,c,d=r.length,p=0;for(;d--;){c=r[d],c.name;let t=[],e=[];for(p=0,n=3;n--;)l=0,h=4*p,e.push(.03333333507180214*p),a.setFromEuler({_x:c.values[0]*s,_y:c.values[1]*s,_z:c.values[2]*s,_order:"XYZ"}),a.toArray(t,h),p++;o.push(new Et(c.name+".quaternion",e,t))}let u=new St(t,-1,o,i?Pt:Rt);u.duration=.10000000521540642;const m=this.mixer.clipAction(u);m.enabled=!0,m.setEffectiveTimeScale(1),m.setEffectiveWeight(1),m.play(),this.actionPose=m}prepareCrossFade(t,e,i){this.isPause=!1,this.unPause(),"idle"!==e._clip.name?this.executeCrossFade(t,e,i):this.synchronizeCrossFade(t,e,i)}synchronizeCrossFade(t,e,i){this.mixer.addEventListener("loop",(function a(r){r.action===t&&(s.mixer.removeEventListener("loop",a),s.executeCrossFade(t,e,i))}));const s=this}executeCrossFade(t,e,i,s=!0){this.setWeight(e,1),e.time=0,t.crossFadeTo(e,i,!0)}pause(){this.actions.forEach((function(t){t.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(t){t.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(t){t.play()}))}setTimescale(t){this.actions.forEach((function(e){e.setEffectiveTimeScale(t)}))}syncro(t){let e=this.getAction(t);if(!e)return;let i=e.time;this.actions.forEach((function(t){t.time=i}))}setWeight(t,e){t.enabled=!0,e<0&&(e=0),e>1&&(e=1),t.setEffectiveWeight(e)}getAnimInfo(t){let e=this.getAction(t);if(e)return{name:t,time:e.time,frame:Math.round(30*e.time),frameMax:e.frameMax,timeScale:e.timeScale}}getAction(t){return this.actions.get(t)}play(t,e=.5){let i=this.getAction(t);if(!i)return!1;if(this.current){if(this.current!==i){this.old=this.current,this.current=i;let s="idle"===this.current.getClip().name;s="idle"===this.old.getClip().name,-1!==this.clipsToesFix.indexOf(t)?this.fixToe=!0:this.resetToes();let a=this.old.getEffectiveWeight(),r=this.current.getEffectiveWeight(),o=this.current.time;if(!s){let t=this.current.getClip().duration/this.old.getClip().duration;o=this.old.time*t}this.current.reset(),this.current.time=o,this.fixWeight?(this.current.weight=1,this.current.stopFading(),this.old.stopFading(),this.old._scheduleFading(e,a,0),this.current._scheduleFading(e,r,1)):this.executeCrossFade(this.old,this.current,e)}}else this.stop(),this.current=i,i.setEffectiveWeight(1);return this.isPause=!1,!0}playFrame(t,e,i=1){let s=this.getAction(t);s&&(s.time=e*rs,s.setEffectiveWeight(i),s.play(),s.paused=!0,this.isPause=!0)}playOne(t,e=1){this.current&&(this.current.time=t*rs,this.current.setEffectiveWeight(e),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(t){t.setEffectiveWeight(0)}))}setRot(t,e,i,s){let a=this.bones[t];a&&(a.rotation.set(e*os,i*os,s*os,"XYZ"),a.updateMatrix())}setRot2(t,e,i,s){let a=this.bones[t];if(!a)return;let r=(new $).setFromEuler({_x:e*ns,_y:i*ns,_z:s*ns,_order:"XYZ"}).invert();a.quaternion.premultiply(r),a.updateMatrix()}getRot(t){let e=this.bones[t];if(!e)return;let i=e.rotation.toArray();return[Math.round(i[0]*ns),Math.round(i[1]*ns),Math.round(i[2]*ns)]}getWorldPos(t){let e=this.bones[t];if(e)return ls.set(0,0,0),e.localToWorld(ls),{x:ls.x,y:ls.y,z:ls.z}}bodyMask(t={arm:!0,leg:!0,foot:!0,chest:!0}){let e=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const i=this.canvas.getContext("2d");i.fillStyle="#FFFFFF",i.fillRect(0,0,256,256),i.fillStyle="black",t.arm&&i.fillRect(196,112,59,46.5),t.leg&&i.fillRect(128,183.5,71.75,72.5),t.foot&&i.fillRect(817*e,205.5,51.5,50),t.chest&&(i.fillRect(120,144,75,40),i.fillRect(553*e,116.5,57,27.5),i.fillRect(533*e,531*e,5,45*e));let s=new Image;s.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new gt(s),this.mask.flipY=!1,this.mask.needsUpdate=!0;const a=Hi.getMaterial("skin");a.alphaTest=.9,a.alphaMap=this.mask}zeroColor(t){t.isMesh&&(t=t.geometry);let e=t.attributes.position.array.length;t.setAttribute("color",new s(new Array(e).fill(0),3))}}class ds extends it{constructor(t={},e){super(),this.motor=e,this.utils=this.motor.utils,this.isCharacter=!0,this.isPlayer=!1,this.enable=!1,this.useImpulse=t.useImpulse||!1,this.useFloating=t.floating||!1,this.waitRotation=!1;let i=.3,s=t.radius||.3,a=t.height||1.8;this.realHeight=a,this.useFloating&&(a-=i),this.option={debug:!1,capsuleHalfHeight:.5*a,capsuleRadius:s,floatHeight:i,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-a,z:0},rayHitForgiveness:.1,rayLength:s+2,rayDir:{x:0,y:-1,z:0},floatingDis:s+i+.08,springK:2,dampingC:.2,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:s-.03,slopeRayLength:s+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:1.2,autoBalanceDampingC:.04,autoBalanceSpringOnY:.7,autoBalanceDampingOnY:.05,animated:!1,mode:null},this.v={movingObjectVelocityInCharacterDir:new n,movingObjectVelocity:new n,standingForcePoint:new n,pivotPosition:new n,modelQuat:new $,moveImpulse:new n,impulseCenter:new n,movingDirection:new n,moveAccNeeded:new n,jumpVelocityVec:new n,jumpDirection:new n,currentVel:new n,currentPos:new n,dragForce:new n,dragAngForce:new n,wantToMoveVel:new n,rejectVel:new n,floatingForce:null,springDirVec:new n,rayOrigin:new n,characterMassForce:new n,slopeAngle:null,actualSlopeNormal:new n,actualSlopeAngle:null,actualSlopeNormalVec:new n,floorNormal:new n(0,1,0),slopeRayOriginRef:new n,slopeRayorigin:new n,canJump:!1,isFalling:!1,isOnMovingObject:!1},this.fixWeight=void 0===t.fixWeight||t.fixWeight,this.type="character",this.name=t.name||"hero",t.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.running=!1,this.wantJump=!1,this.radius=s,this.height=a,this.mass=t.mass||.84,delete t.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-1.2,this.maxRayDistance=this.height,this.contact=!1,this.velocity=new n,this.angular=new n,this.tmpV1=new n,this.tmpV2=new n,this.ease=new n,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(t.angle||0)*pe,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=t.ray||!1,this.callback=t.callback||function(){},t.callback&&delete t.callback,this.initPhysic(t)}setHeight(t){this.model&&this.model.setRealSize(t)}reSizePhysics(t){if(t===this.realHeight)return;this.realHeight=t,this.height=this.realHeight-(this.useFloating?this.option.floatHeight:0);let e=this.position.toArray();e[1]+=.5*this.height+(this.useFloating?this.option.floatHeight:0);let i=[this.radius,this.height-2*this.radius];this.phyData.pos=e,this.phyData.size=i,this.motor.post({m:"add",o:this.phyData})}initPhysic(t){t.size||(t.size=[this.radius,this.height-2*this.radius]),t.pos||(t.pos=[0,0,0]),t.pos[1]+=.5*this.height,this.useFloating&&(t.pos[1]+=this.option.floatHeight),this.globalRay&&this.motor.getGeometryRef({...t,type:"capsule",ray:!0},this,this.motor.mat.get("hide")),this.phyData={name:this.name,size:t.size,pos:t.pos,type:"character",shapeType:t.shapeType||"capsule",density:1,mass:this.mass,friction:void 0!==t.friction?t.friction:.5,angularFactor:[0,0,0],group:16,regular:!0,massInfo:t.massInfo},"HAVOK"===this.motor.engine&&(this.phyData.inertia=[0,0,0]),t.mask&&(this.phyData.mask=t.mask),this.motor.getCharacterRef().addToWorld(this,t.id),this.motor.post({m:"add",o:this.phyData}),this.useFloating&&(this.ray=this.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name})),t.gender?this.addModel(t):this.showHelper(!0),this.enable=!0}extraRemove(){this.ray&&this.motor.remove(this.name+"_ray")}selfRay(t){t.hit?(this.distance=t.distance,this.rayAngle=t.angle):(this.distance=this.option.rayLength,this.rayAngle=0)}hit(t){this.contact=t}showHelper(t){t?this.helper||(this.helper=new si(this.radius,this.height,!0,this.motor.mat.get("line"),[1,.6,0],[.6,.2,0]),this.helper.setDirection(this.angle),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=t)}addSkeleton(){this.skeletonBody||this.model&&(this.skeletonBody=new Li(this.motor,this.name,this.model.root,this.model.skeleton.bones),this.motor.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(t=!1){this.skeletonBody&&this.skeletonBody.isVisible(t),this.model&&this.skeletonBody&&this.model.setMaterial({transparent:t,opacity:t?.8:1},!t),this.showHelper(t)}setMode(t){this.skeletonBody&&this.skeletonBody.setMode(t)}addModel(t){this.model=new cs({type:t.gender,anim:void 0!==t.anim?t.anim:"idle",compact:!0,material:!t.noMat,morph:t.morph||!1,randomMorph:t.randomMorph||!1,randomSize:t.randomSize||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:t.noLOD||!1}),this.add(this.model);let e=-.5*this.height;this.useFloating&&(e-=this.option.floatHeight),this.model.setPosition(0,this.model.decalY+e,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(t,e){this.position.fromArray(t,e+1),this.quaternion.fromArray(t,e+4),this.velocity.fromArray(t,e+8),this.angular.fromArray(t,e+11),this.fall=this.position.y<this.oy,this.floor=fe.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.model&&(this.model.update(this.motor.delta),this.getDistanceToCamera()),this.useFloating&&!this.isPlayer&&(this.stopMoving(),this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()})),this.updateMatrix()}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const t=this.motor.getCamera();this.tmpV1.copy(this.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let e=this.tmpV1.distanceTo(this.tmpV2)/t.zoom>3?0:1;this.model.setLevel(e)}set(t){t.morph&&this.model&&this.model.setMorph(t.morph,t.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper()}onFrame(t,e){this.v,this.option}autoBalance(){const t=this.v,e=this.option,i=this.rotation;t.dragAngForce.set(-e.autoBalanceSpringK*i.x-this.angular.x*e.autoBalanceDampingC,-e.autoBalanceSpringK*i.y-this.angular.y*e.autoBalanceDampingOnY,-e.autoBalanceSpringK*i.z-this.angular.z*e.autoBalanceDampingC)}moveCharacter(t,e=0){const i=this.v,s=this.option,a=this.motor.getKey();this.motor.getAzimut(),i.currentPos.copy(this.position),i.slopeAngle=0,i.actualSlopeAngle<s.slopeMaxAngle&&Math.abs(i.slopeAngle)>.2&&Math.abs(i.slopeAngle)<s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle),Math.cos(i.slopeAngle)):i.actualSlopeAngle>=s.slopeMaxAngle?i.movingDirection.set(0,Math.sin(i.slopeAngle)>0?0:Math.sin(i.slopeAngle),Math.sin(i.slopeAngle)>0?.1:1):i.movingDirection.set(0,0,1),i.movingDirection.applyAxisAngle({x:0,y:1,z:0},e),i.movingObjectVelocityInCharacterDir.copy(i.movingObjectVelocity).projectOnVector(i.movingDirection).multiply(i.movingDirection);const r=i.movingObjectVelocity.angleTo(i.movingDirection),o=i.currentVel.dot(i.movingDirection);i.wantToMoveVel.set(i.movingDirection.x*o,0,i.movingDirection.z*o),i.rejectVel.copy(i.currentVel).sub(i.wantToMoveVel),i.moveAccNeeded.set((i.movingDirection.x*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.x)-(i.currentVel.x-i.movingObjectVelocity.x*Math.sin(r)+i.rejectVel.x*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime,0,(i.movingDirection.z*(s.maxVelLimit*(this.running?s.sprintMult:1)+i.movingObjectVelocityInCharacterDir.z)-(i.currentVel.z-i.movingObjectVelocity.z*Math.sin(r)+i.rejectVel.z*(i.isOnMovingObject?0:s.rejectVelMult)))/s.accDeltaTime);const n=i.moveAccNeeded.multiplyScalar(this.mass);let l=!0;this.waitRotation&&(l=Math.sin(e).toFixed(3)==Math.sin(this.rotation.y).toFixed(3)),l?i.moveImpulse.set(n.x*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),n.z*(i.canJump?1:s.airDragMultiplier)):i.moveImpulse.set(n.x*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier),null===i.slopeAngle||0==i.slopeAngle?0:i.movingDirection.y*s.turnVelMultiplier*(i.movingDirection.y>0?s.slopeUpExtraForce:s.slopeDownExtraForce)*(this.running?s.sprintMult:1),n.z*s.turnVelMultiplier*(i.canJump?1:s.airDragMultiplier)),i.impulseCenter.set(i.currentPos.x,i.currentPos.y+s.moveImpulsePointY,i.currentPos.z),i.currentVel.copy(this.velocity),a[4]&&i.canJump&&(i.jumpVelocityVec.set(i.currentVel.x,this.running?s.sprintJumpMult*s.jumpVel:s.jumpVel,i.currentVel.z),i.moveImpulse.y=i.jumpVelocityVec.y)}getFloating(){const t=this.v,e=this.option,i=e.springK*(e.floatingDis-this.distance)-this.velocity.y*e.dampingC;t.moveImpulse.y=i*this.mass}stopMoving(){this.v,this.option,this.v.moveImpulse.set(0,0,0),this.tmpV1.copy(this.velocity),this.tmpV1.x*=.9,this.tmpV1.z*=.9,this.tmpV1.x+this.tmpV1.z!==0&&this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!1})}move(){this.v;const t=this.motor.getKey(),e=this.motor.getAzimut(),i=this.motor.delta;let s=0!==t[7]?"run":"walk";0===t[0]&&0===t[1]&&(s="idle");let a=0!==t[0]&&0!==t[1]?this.diagonal:1;t[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===t[5]&&(this.toggle=!0),"walk"!==s&&"run"!==s||!this.crouch||(s="crouch"),1===t[6]&&(s="fight"),!this.jump&&t[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let r="idle";switch(s){case"idle":r=this.crouch?"Crouch Idle":"idle";break;case"walk":r="Jog Forward";break;case"run":r="Standard Run";break;case"crouch":r="Crouch Walk";break;case"fight":r="Attack"}this.moving=0!==t[0]||0!==t[1],this.running=0!==t[7],this.wantJump=0!==t[4];let o=fe.unwrapRad(Math.atan2(t[0],t[1])+e);if(this.useImpulse)this.moving?this.moveCharacter(i,o):this.stopMoving(),this.useFloating&&this.getFloating(),this.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()});else{this.tmpAcc+=4*i;const r=1;let o=this.speed[s]*r;this.moving&&(this.rs=t[0]*o,this.ts=t[1]*o),0===t[0]&&0===t[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*a),this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let n=this.vy-9.81;this.ease.y=n,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},e),this.tmpV2.set(0,0,0),this.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()})}if(this.helper&&(this.helper.updateMatrix(),this.helper.cone.rotation.y=e,"idle"!==s&&this.helper.setDirection(o)),this.model&&(this.jump?this.model.play("Jump",.5):this.model.play(r,.75),"idle"!==s)){let t=fe.unwrapRad(this.model.rotation.y),i=fe.nearAngle(o,t),a=Math.abs(Math.floor((t-i)*math.todeg)/180);this.model.rotation.y="fight"===s?e+Math.PI:fe.lerp(t,i,.2-.1*a),this.model.updateMatrix()}}}class ps extends Ze{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="character",this.num=ze[this.type]}step(t,e){let i,s,a=this.list.length;for(;a--;)s=this.list[a],i=e+a*this.num,s&&s.step(t,i)}add(t={}){this.setName(t);return new ds(t,this.motor)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const us={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),toFixed:(t,e=3)=>1*t.toFixed(e),int:t=>Math.floor(t),lerp:(t,e,i)=>(1-i)*t+i*e,clamp:(t,e,i)=>Math.max(e,Math.min(i,t)),nearEquals:(t,e,i)=>Math.abs(t-e)<=i,lerpAr:(t,e,i,s)=>{let a=t.length;for(;a--;)t[a]=us.lerp(e[a],i[a],s)},unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),scaleArray:(t,e)=>{for(var i=t.length;i--;)t[i]*=e;return t},addArray:(t,e)=>{for(var i=[],s=t.length;s--;)i[s]=t[s]+e[s];return i},angleDistance:(t,e)=>{var i=(t-e+180)%360-180;return i<-180?i+360:i},tmpE:new nt,tmpM:new l,tmpM2:new l,tmpV:new n,tmpQ:new $,fromTransformToQ:(t,e,i)=>(i=i||!1,us.tmpM.compose(us.tmpV.fromArray(t),us.tmpQ.fromArray(e),{x:1,y:1,z:1}),us.tmpM.decompose(us.tmpV,us.tmpQ,{x:1,y:1,z:1}),i&&us.tmpQ.invert(),us.tmpQ.toArray()),fromTransform:(t,e,i,s,a)=>(a=a||!1,s=s||[0,0,0,1],us.tmpM.compose(us.tmpV.fromArray(t),us.tmpQ.fromArray(e),{x:1,y:1,z:1}),us.tmpM2.compose(us.tmpV.fromArray(i),us.tmpQ.fromArray(s),{x:1,y:1,z:1}),a?(us.tmpM.invert(),us.tmpM.multiply(us.tmpM2)):us.tmpM.multiply(us.tmpM2),us.tmpM.decompose(us.tmpV,us.tmpQ,{x:1,y:1,z:1}),us.tmpV.toArray()),arCopy:(t,e)=>{},axisToQuatArray:(t,e)=>(e=e||!1,us.tmpQ.setFromAxisAngle(us.tmpV.fromArray(t,1),e?t[0]*us.torad:t[0]).normalize().toArray()),toQuatArray:t=>us.tmpQ.setFromEuler(us.tmpE.fromArray(us.vectorad(t))).toArray(),vectorad:t=>{let e=3,i=[];for(;e--;)i[e]=t[e]*us.torad;return i[3]=t[3],i},rgbToHex:t=>"0x"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),hexToRgb:t=>[((t=Math.floor(t))>>16&255)/255,(t>>8&255)/255,(255&t)/255],htmlToHex:t=>t.toUpperCase().replace("#","0x"),hexToHtml:t=>"#"+("000000"+(t=void 0===t?0:t).toString(16)).substr(-6),rgbToHtml:t=>"#"+("000000"+(255*t[0]<<16^255*t[1]<<8^255*t[2]).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==us.perlin&&(us.perlin=null)},noise:(t,e)=>{null===us.perlin&&(us.perlin=new ms);let i,s,a=(e=e||{}).level||[1,.2,.05],r=e.frequency||[.016,.05,.2],o=0,n=0;for(i=0;i<a.length;i++)s=r[i],o+=a[i]*(.5+.5*us.perlin.noise3d(t.x*s,t.y*s,t.z*s)),n+=a[i];return o/=n,o}};class ms{constructor(t){null==t&&(t=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var e=0;e<256;e++)this.p[e]=Math.floor(256*t.random());this.perm=[];for(e=0;e<512;e++)this.perm[e]=this.p[255&e];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(t,e,i){return t[0]*e+t[1]*i}dot3(t,e,i,s){return t[0]*e+t[1]*i+t[2]*s}dot4(t,e,i,s,a){return t[0]*e+t[1]*i+t[2]*s+t[3]*a}noise(t,e){var i,s,a=(t+e)*(.5*(Math.sqrt(3)-1)),r=Math.floor(t+a),o=Math.floor(e+a),n=(3-Math.sqrt(3))/6,l=(r+o)*n,h=t-(r-l),c=e-(o-l);h>c?(i=1,s=0):(i=0,s=1);var d=h-i+n,p=c-s+n,u=h-1+2*n,m=c-1+2*n,b=255&r,g=255&o,f=this.perm[b+this.perm[g]]%12,y=this.perm[b+i+this.perm[g+s]]%12,v=this.perm[b+1+this.perm[g+1]]%12,x=.5-h*h-c*c,w=.5-d*d-p*p,k=.5-u*u-m*m;return 70*((x<0?0:(x*=x)*x*this.dot(this.grad3[f],h,c))+(w<0?0:(w*=w)*w*this.dot(this.grad3[y],d,p))+(k<0?0:(k*=k)*k*this.dot(this.grad3[v],u,m)))}noise3d(t,e,i){var s,a,r,o,n,l,h=(t+e+i)*(1/3),c=Math.floor(t+h),d=Math.floor(e+h),p=Math.floor(i+h),u=1/6,m=(c+d+p)*u,b=t-(c-m),g=e-(d-m),f=i-(p-m);b>=g?g>=f?(s=1,a=0,r=0,o=1,n=1,l=0):b>=f?(s=1,a=0,r=0,o=1,n=0,l=1):(s=0,a=0,r=1,o=1,n=0,l=1):g<f?(s=0,a=0,r=1,o=0,n=1,l=1):b<f?(s=0,a=1,r=0,o=0,n=1,l=1):(s=0,a=1,r=0,o=1,n=1,l=0);var y=b-s+u,v=g-a+u,x=f-r+u,w=b-o+2*u,k=g-n+2*u,M=f-l+2*u,S=b-1+.5,A=g-1+.5,z=f-1+.5,E=255&c,P=255&d,R=255&p,T=this.perm[E+this.perm[P+this.perm[R]]]%12,F=this.perm[E+s+this.perm[P+a+this.perm[R+r]]]%12,D=this.perm[E+o+this.perm[P+n+this.perm[R+l]]]%12,_=this.perm[E+1+this.perm[P+1+this.perm[R+1]]]%12,C=.6-b*b-g*g-f*f,j=.6-y*y-v*v-x*x,L=.6-w*w-k*k-M*M,q=.6-S*S-A*A-z*z;return 32*((C<0?0:(C*=C)*C*this.dot3(this.grad3[T],b,g,f))+(j<0?0:(j*=j)*j*this.dot3(this.grad3[F],y,v,x))+(L<0?0:(L*=L)*L*this.dot3(this.grad3[D],w,k,M))+(q<0?0:(q*=q)*q*this.dot3(this.grad3[_],S,A,z)))}noise4d(t,e,i,s){var a,r,o,n,l,h,c,d,p,u,m,b,g=this.grad4,f=this.simplex,y=this.perm,v=(Math.sqrt(5)-1)/4,x=(5-Math.sqrt(5))/20,w=(t+e+i+s)*v,k=Math.floor(t+w),M=Math.floor(e+w),S=Math.floor(i+w),A=Math.floor(s+w),z=(k+M+S+A)*x,E=t-(k-z),P=e-(M-z),R=i-(S-z),T=s-(A-z),F=(E>P?32:0)+(E>R?16:0)+(P>R?8:0)+(E>T?4:0)+(P>T?2:0)+(R>T?1:0),D=E-(a=f[F][0]>=3?1:0)+x,_=P-(r=f[F][1]>=3?1:0)+x,C=R-(o=f[F][2]>=3?1:0)+x,j=T-(n=f[F][3]>=3?1:0)+x,L=E-(l=f[F][0]>=2?1:0)+2*x,q=P-(h=f[F][1]>=2?1:0)+2*x,O=R-(c=f[F][2]>=2?1:0)+2*x,B=T-(d=f[F][3]>=2?1:0)+2*x,I=E-(p=f[F][0]>=1?1:0)+3*x,G=P-(u=f[F][1]>=1?1:0)+3*x,N=R-(m=f[F][2]>=1?1:0)+3*x,V=T-(b=f[F][3]>=1?1:0)+3*x,U=E-1+4*x,W=P-1+4*x,H=R-1+4*x,K=T-1+4*x,J=255&k,X=255&M,Q=255&S,Y=255&A,Z=y[J+y[X+y[Q+y[Y]]]]%32,$=y[J+a+y[X+r+y[Q+o+y[Y+n]]]]%32,tt=y[J+l+y[X+h+y[Q+c+y[Y+d]]]]%32,et=y[J+p+y[X+u+y[Q+m+y[Y+b]]]]%32,it=y[J+1+y[X+1+y[Q+1+y[Y+1]]]]%32,st=.6-E*E-P*P-R*R-T*T,at=.6-D*D-_*_-C*C-j*j,rt=.6-L*L-q*q-O*O-B*B,ot=.6-I*I-G*G-N*N-V*V,nt=.6-U*U-W*W-H*H-K*K;return 27*((st<0?0:(st*=st)*st*this.dot4(g[Z],E,P,R,T))+(at<0?0:(at*=at)*at*this.dot4(g[$],D,_,C,j))+(rt<0?0:(rt*=rt)*rt*this.dot4(g[tt],L,q,O,B))+(ot<0?0:(ot*=ot)*ot*this.dot4(g[et],I,G,N,V))+(nt<0?0:(nt*=nt)*nt*this.dot4(g[it],U,W,H,K)))}}class bs extends tt{constructor(t={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=t.name,this.folder=t.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=t.terrainType||"terrain",this.callback=t.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[t.uv||18,t.uv||18],this.sample=null==t.sample?[128,128]:t.sample,this.size=void 0===t.size?[100,30,100]:t.size;let e=this.sample[0]-1,s=this.sample[1]-1;this.rx=e/this.size[0],this.rz=s/this.size[2],this.zone=t.zone||1;let a=[this.size[0]/e,this.size[2]/s];this.sampleZ=[t.sample[0]*this.zone,t.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*a[0],t.size[1],(this.sampleZ[1]-1)*a[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:t.level||[1,.2,.05],frequency:t.frequency||[.016,.05,.2],expo:t.expo||1},this.isWater=t.water||!1,this.isIsland=t.island||!1,this.isBorder=!1,this.wantBorder=t.border||!1,this.isBottom=!1,this.wantBottom=t.bottom||!1,this.wantBorder=t.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=t.maxSpeed||.1,this.acc=null==t.acc?.01:t.acc,this.dec=null==t.dec?.01:t.dec,this.deep=null==t.deep?0:t.deep,this.ease=new b,this.complexity=null==t.complexity?30:t.complexity,this.complexity2=null==t.complexity2?null:t.complexity2,this.local=new n,t.local&&this.local.fromArray(t.local),this.pp=new n,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=t.is64||!1,this.isTurn=t.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=t.isAbsolute||!1,this.isTurned=t.isTurned||!1,this.isReverse=t.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new d(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-us.PI90),this.geometry.setAttribute("color",new i(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var r=new $(.5,.5,.1,.2);t.maplevels&&r.fromArray(t.maplevels);var o,l=gs,h=t.maps||["sand","grass3","rock"],c={};this.isWater&&(h=["water"]);for(let e in h)o=h[e],c[o+"_c"]=Hi.texture({url:this.folder+o+"_c.jpg",flip:!1,repeat:this.uvx,encoding:t.encoding||!0,callback:this.mapcallback.bind(this)}),c[o+"_n"]=Hi.texture({url:this.folder+o+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});c.noise=Hi.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=c,this.material=new v({name:"terrain",vertexColors:!0,color:16777215,map:c[h[0]+"_c"],normalMap:c[h[0]+"_n"]}),void 0!==t.envmap&&(this.material.envMap=t.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=t.opacity||.4,this.material.side=E,this.material.alphaMap=c[h[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=0,this.material.metalness=t.metalness||0,this.material.roughness=t.roughness||.3);var p=t.nScale||.5;if(this.material.normalScale.set(p,-p),this.isWater)this.material.onBeforeCompile=function(t){var e=t.fragmentShader;e=e.replace("#include <alphamap_fragment>",l.alphamap),t.fragmentShader=e};else{let t=this;this.material.onBeforeCompile=function(e){let i=e.uniforms;i.clevels={value:r},i.map1={value:c[h[1]+"_c"]},i.map2={value:c[h[2]+"_c"]},i.randomUv={value:1},i.normalMap1={value:c[h[1]+"_n"]},i.normalMap2={value:c[h[2]+"_n"]},i.noiseMap={value:c.noise},i.useNoiseMap={value:1},e.uniforms=i;let s=e.fragmentShader;s=s.replace("#include <clipping_planes_pars_fragment>","#include <clipping_planes_pars_fragment>"+fs+l.fragmentAdd),s=s.replace("#include <map_fragment>",l.map),s=s.replace("#include <normal_fragment_maps>",l.normal),s=s.replace("#include <color_fragment>",""),e.fragmentShader=s,t.material.userData.shader=e},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(t){this.userData.shader.uniforms.randomUv.value=t?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(t){this.userData.shader.uniforms.map1.value=t}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(t){this.userData.shader.uniforms.map2.value=t}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(t){this.userData.shader.uniforms.normalMap1.value=t}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(t){this.userData.shader.uniforms.normalMap2.value=t}})}t.debug&&this.debugZone(t),this.wantBorder&&this.addBorder(t),this.wantBottom&&this.addBottom(t),t.pos&&this.position.fromArray(t.pos),t.quat=void 0===t.quat?[0,0,0,1]:t.quat,void 0!==t.rot&&(t.quat=us.toQuatArray(t.rot),delete t.rot),this.quaternion.fromArray(t.quat),t.decal&&(this.position.y+=t.decal),this.castShadow=!0,this.receiveShadow=!0,Hi.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let t=.5*(this.sample[0]-this.sampleZ[0]),e=.5*(this.sample[1]-this.sampleZ[1]),i=this.sample[0]*e+t,s=0;for(let e=0;e<this.lngZ;e++)s=Math.floor(e/this.sampleZ[0]),this.zid[i+e+s*(2*t)]=e}debugZone(t){this.geometryZ=new d(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-us.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const e=new tt(this.geometryZ,new S({color:0,wireframe:!0,transparent:!0,opacity:.1}));this.add(e)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(t){var e=new d(this.size[0],this.size[2],1,1);e.rotateX(us.PI90),this.bottomMesh=new tt(e,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(t){this.borderMaterial=new w({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?t.opacity||.8:1,envMap:t.envmap||null});var e=new d(this.size[0],2,this.sample[0]-1,1),s=new d(this.size[0],2,this.sample[0]-1,1),a=new d(this.size[2],2,this.sample[1]-1,1),r=new d(this.size[2],2,this.sample[1]-1,1);e.translate(0,1,.5*this.size[2]),s.rotateY(-us.Pi),s.translate(0,1,.5*-this.size[2]),a.rotateY(-us.PI90),a.translate(.5*-this.size[0],1,0),r.rotateY(us.PI90),r.translate(.5*this.size[0],1,0),this.borderGeometry=te($t([e,s,a,r])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new i(this.borderColors,3)),this.borderMesh=new tt(this.borderGeometry,this.borderMaterial);for(var o,n,l=this.lng2;l--;)o=3*l,n=this.borderVertices[o+1]>0?this.findPoint(this.borderVertices[o],this.borderVertices[o+2]):-1,this.list[l]=n;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let t in this.txt)this.txt[t].dispose()}easing(t,e,i){if(0!==t[0]||0!==t[1]){var s=e||0;t[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=t[1]*this.acc,this.ease.x+=t[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,t[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),t[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(s)*this.ease.x+Math.cos(s)*this.ease.y,this.local.x+=Math.cos(s)*this.ease.x-Math.sin(s)*this.ease.y,this.update(i))}}getTri(){return this.geometry}getHeight(t,e){return t*=this.rx,e*=this.rz,t+=.5*this.sample[0],e+=.5*this.sample[1],t=Math.floor(t),e=Math.floor(e),(this.isTurn?this.height[this.findId2(t,e)]:this.height[this.findId(t,e)])*this.size[1]+this.position.y}findIdZ(t,e){return t+e*this.sampleZ[1]}findId(t,e){return t+e*this.sample[1]}findId2(t,e){return e+-t*this.sample[0]||1}findPoint(t,e){for(var i,s=this.lng;s--;)if(i=3*s,this.vertices[i]===t&&this.vertices[i+2]===e)return s;return-1}getReverseID(){this.invId=[];let t,e,i=this.lngZ;const s=this.sampleZ[1]-1;for(this.sampleZ[0];i--;)t=i%this.sampleZ[0],e=Math.floor(i*this.ratioZ),this.isReverse&&(e=s-e),this.invId[i]=this.isTurned?this.lngZ-1-this.findIdZ(e,t):this.findIdZ(t,e)}set(t){t.ease&&this.easing(t.key,t.azimut),t.decal&&this.decal(t.decal,!0)}decal(t,e){this.local.x+=t[0],this.local.y+=t[1],this.local.z+=t[2],this.update(e)}updateUv(){if(this.isWater)this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001;else{let t={x:this.local.x*this.ruvx,y:this.local.z*this.ruvy};this.material.map&&this.material.map.offset.copy(t),this.material.normalMap&&this.material.normalMap.offset.copy(t)}}distance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}clamp(t,e=0,i=1){return t=(t=t<e?e:t)>i?i:t}update(t){let e,i,s,a,r,o,n,l,h,c,d,p=this.pp,u=[1,1,1],m=this.lng;for(;m--;){if(e=3*m,i=m%this.sample[0],s=Math.floor(m*this.ratio),p.set(i+this.local.x*this.rx,this.local.y,s+this.local.z*this.rz),a=us.noise(p,this.data),this.isIsland){let t=1-this.distance({x:i,y:s},{x:.5*(this.sample[0]-1),y:.5*(this.sample[1]-1)})/(.5*(this.sample[0]-1));t*=4,t=this.clamp(t),a*=t}a=Math.pow(a,this.data.expo),a=this.clamp(a),"road"===this.ttype&&(l===s?a=1===i||2===i||29===i||30===i?h+.1:h:(l=s,h=a)),this.height[m]=a,c=a*this.size[1]+this.deep,this.vertices[e+1]=c,o=this.isAbsolute?a:a*this.size[1],void 0!==this.zid[m]&&(n=this.zid[m],r=this.changeId?this.invId[n]:n,this.heightData[r]=o,this.verticesZ&&(this.verticesZ[3*n+1]=c)),u=this.isWater?[a*this.colorBase.r,a*this.colorBase.g,a*this.colorBase.b]:[a,0,0],d=u[0],this.colors[e]=d,this.colors[e+1]=d,this.colors[e+2]=d}if(this.isBorder){let t,i=this.lng2;for(;i--;)e=3*i,-1!==this.list[i]?(t=this.height[this.list[i]],this.borderVertices[e+1]=t*this.size[1]+this.deep,d=us.clamp(t+.25,.25,1),this.borderColors[e]=d,this.borderColors[e+1]=d,this.borderColors[e+2]=d):(this.borderColors[e]=this.colorBase.r,this.borderColors[e+1]=this.colorBase.g,this.borderColors[e+2]=this.colorBase.b)}t?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(t){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const gs={fragmentAdd:"\n        uniform vec4 clevels;\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.x) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (slope == 0.0 ) cc = sands;\n            //if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            //if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n\n            float d = level.y;\n            float rx = 1.0/level.y;\n\n            if (( slope < level.x + d ) && (slope > level.x)) cc = mix( grasss , rocks, ( slope - (level.x) ) * rx );\n\n            d = level.w;\n            rx = 1.0/level.w;\n            if (( slope < level.z + d ) && (slope > level.z )) cc = mix( sands , grasss, ( slope - (level.z) ) * rx );\n\n            //cc = mix( grasss, cc, smoothstep(0.0,1.0, slope)*20.0 );\n            return cc;\n        }\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 sampledDiffuseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n\n            diffuseColor *= sampledDiffuseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "},fs="\n\nuniform sampler2D noiseMap;\nuniform float useNoiseMap;\n\nfloat directNoise(vec2 p){\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u*u*(3.0-2.0*u);\n    \n    float res = mix(\n        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),\n        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);\n    return res*res;\n}\n\nfloat sum( vec4 v ) { return v.x+v.y+v.z; }\n\nvec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n    // sample variation pattern\n    float k = 0.0;\n    if( useNoiseMap == 1.0 ) k = texture2D( noiseMap, 0.005*uv ).x;\n    else k = directNoise( uv );\n    \n    // compute index    \n    float index = k*8.0;\n    float f = fract( index );\n\n    float ia = floor( index );\n    float ib = ia + 1.0;\n    // or\n    //float ia = floor(index+0.5); // suslik's method (see comments)\n    //float ib = floor(index);\n    //f = min(f, 1.0-f)*2.0;\n\n    // offsets for the different virtual patterns    \n    vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n    vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n    // compute derivatives for mip-mapping    \n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n    \n    // sample the two closest virtual patterns    \n    vec4 cola = textureGrad( mapper, uv + offa, dx, dy );\n    vec4 colb = textureGrad( mapper, uv + offb, dx, dy );\n\n    // interpolate between the two virtual patterns    \n    return mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) );\n\n}\n";let ys=null;class vs extends Ze{constructor(t){super(),this.motor=t,this.engine=this.motor.engine,this.Utils=this.motor.utils,ys=this.motor.mat,this.type="terrain",this.num=ze[this.type]}step(t,e){let i,s=this.list.length;for(;s--;)i=this.list[s],i.step()}add(t={}){this.setName(t),"JOLT"===this.engine&&(t.isAbsolute=!0,t.isTurned=!1),"PHYSX"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"HAVOK"===this.engine&&(t.isAbsolute=!0,t.isTurned=!0),"OIMO"!==this.engine&&(t.zone=t.zone||.25);const e=new bs(t);return ys.extendShader(e.material,e.material.onBeforeCompile),e.physicsUpdate=(t,e)=>{this.motor.flow.tmp.push({name:t,heightData:e})},this.addToWorld(e,t.id),this.motor.post({m:"add",o:xs(e,this.engine)}),e}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}const xs=function(t,e){const i={name:t.name,type:t.type,pos:t.position.toArray(),quat:"PHYSX"===e?[0,0,0,1]:t.quaternion.toArray()};return"PHYSX"===e||"AMMO"===e||"HAVOK"===e||"JOLT"===e?(i.type="terrain",i.size=t.sizeZ,i.sample=t.sampleZ,i.zone=t.zone,i.heightData=t.heightData):(i.type="mesh",i.v=fe.getVertex(t.geometry,"OIMO"===e),i.index="OIMO"===e?null:fe.getIndex(t.geometry)),i};class ws extends Ze{constructor(t){super(),this.motor=t,this.Utils=this.motor.utils,this.type="solver"}step(t,e){let i,s=this.list.length;for(;s--;)i=e+s*ze[this.type],this.list[s].update(t,i)}add(t={}){this.setName(t);let e=new ks(t,this.motor);return this.addToWorld(e,t.id),this.motor.post({m:"add",o:t}),e}set(t={}){}}class ks{constructor(t,e){this.motor=e,this.name=t.name,this.type="solver",this.needData=t.needData||!1,this.bones=[],this.joints=[],this.jid=0,this.speed=1}addBone(t){this.bones.push(t)}dispose(){this.motor.remove(this.bones,!0)}update(t,e){if(!this.needData)return;let i,s,a=this.joints.length;for(;a--;)s=e+7*a,i=this.joints[a],i.data.target.x=t[s+0],i.data.target.y=t[s+1],i.data.target.z=t[s+2],i.data.target.rx=t[s+3],i.data.target.ry=t[s+4],i.data.target.rz=t[s+5],i.data.target.count=t[s+6]}start(){this.motor.post({m:"startArticulation",o:{name:this.name}})}stop(){this.motor.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){this.motor.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(t){this.jid=this.joints.length,t.name=t.name||this.name+"_Joint_"+this.jid,t.solver=this.name,void 0!==t.rot1&&(t.quat1=fe.quatFromEuler(t.rot1),delete t.rot1),void 0!==t.rot2&&(t.quat2=fe.quatFromEuler(t.rot2),delete t.rot2),"fixe"!==t.type&&this.joints.push(new Ms(t,this)),this.motor.post({m:"addSolverJoint",o:t})}driveJoints(t){let e,i,s=!1,a=this.joints.length,r=[];for(;a--;)e=this.joints[a],e.update(t),i=e.isDrive,e.nup&&r.push(e.nup),s=!!i||s;s?this.motor.change(r):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(t,e){if(!t)return;let i=this.joints.length;for(;i--;)this.joints[i].pose(void 0!==t[i]?t[i]:0,void 0!==e?e:this.speed);return new Promise((t=>this.resolve=t))}}class Ms{constructor(t,e){if(this.name=t.name,this.solver=e,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},t.limits&&(this.driveType=t.limits[0][0],this.min=t.limits[0][1],this.max=t.limits[0][2]),t.position&&(t.target=t.position),t.target){let e,i=t.target.length;for(;i--;)e=t.target[i],this.data.target[e[0]]=e[1]}}start(){}pose(t,e){this.target=fe.clamp(t,this.min,this.max),this.current=fe.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=e,this.isDrive=!0)}update(t){if(this.isDrive){this.tmp+=t*this.time;let e=this.tmp;e=e>1?1:e;let i=this.target;this.nup={name:this.name,drivesTarget:[[this.driveType,i]]},1===e&&(this.isDrive=!1)}else this.nup=null}}class Ss{constructor(t){this.map=new Map,this.motor=t,this.enginReady=["PHYSX","HAVOK","OIMO"],this.rc=this.refresh.bind(this)}reset(){this.map=new Map}step(){this.map.forEach(this.rc)}refresh(t,e){let i=this.motor.reflow.contact[e];if(void 0!==i)for(let e=0,s=i.length;e<s;e++)t.userData.collisionCallback?t.userData.collisionCallback(i[e]):t.dispatchEvent({type:"collision",data:i[e]})}isReady(){return-1!==this.enginReady.indexOf(this.motor.engine)}remove(t){this.isReady()&&this.map.has(t)&&(this.map.delete(t),this.motor.post({m:"removeCollision",o:{name:t}}))}add(t){if(!this.isReady())return;let e=t.name,i=this.motor.byName(e);null!==i&&(t.vs&&t.vs.constructor!==Array&&(t.vs=[t.vs]),t.ignore&&t.ignore.constructor!==Array&&(t.ignore=[t.ignore]),t.callback&&(i.userData.collisionCallback=t.callback,delete t.callback),this.map.set(e,i),this.motor.post({m:"addCollision",o:t}))}}const As=t=>t?.reduce(((t,e)=>t+e),0)/t.length;class zs{constructor(){this.chartLen=60,this.frame=0,this.frameG=0,this.gpuAccums=[],this.activeAccums=[],this.queryCreated=!1,this.queryHasResult=!1,this.withGpu=!0,this.reset()}reset(){this.msChart=new Array(this.chartLen).fill(0),this.fpsChart=new Array(this.chartLen).fill(0),this.gpuChart=new Array(this.chartLen).fill(0)}up(t){this.msChart[this.frame]=t.ms,this.fpsChart[this.frame]=t.fps,this.frame++,this.frame===this.chartLen&&(this.frame=0)}setRenderer(t){this.withGpu&&(this.gl=t.getContext(),this.extension=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),null!==this.extension&&this.startGpu())}upGpu(){let t=this.startGpu(this.frameG);t&&(this.gpuChart[this.frameG]=t,this.frameG++,this.frameG===this.chartLen&&(this.frameG=0)),this.endGpu()}startGpu(){const t=this.gl,e=this.extension;if(!t||!e)return;let i,s,a=!1,r=null;if(this.query){this.queryHasResult=!1;let o=this.query;if(a=t.getQueryParameter(o,t.QUERY_RESULT_AVAILABLE),i=t.getParameter(e.GPU_DISJOINT_EXT),a&&!i){s=t.getQueryParameter(this.query,t.QUERY_RESULT);const e=1e-6*s;this.gpuAccums[0]=e,(a||i)&&(t.deleteQuery(this.query),o=null),a&&e>0&&(i||(r=e))}}return!a&&this.query||(this.queryCreated=!0,this.query=t.createQuery(),t.beginQuery(e.TIME_ELAPSED_EXT,this.query)),r}endGpu(){const t=this.extension,e=this.gl;this.queryCreated&&e.getQuery(t.TIME_ELAPSED_EXT,e.CURRENT_QUERY)&&e.endQuery(t.TIME_ELAPSED_EXT)}get ms(){return As(this.msChart)}get fps(){return As(this.fpsChart)}get gpu(){return As(this.gpuChart)}}class Es extends tt{constructor(t={}){super(new d,new S({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=t.nam||"text",this.canvas=null,this.w=t.w||0,this.h=t.h||0,this.weight=t.weight??700,this.font=t.font??"'Mulish', sans-serif",this.fontSize=t.fontSize??32,this.backgroundColor=t.backgroundColor??"#00000000",this.fontColor=t.color??"#FFFFFF",this.material.alphaTest=.5,this.set(t.text),t.pos&&this.position.fromArray(t.pos),t.rot&&this.quaternion.fromArray(fe.quatFromEuler(t.rot))}set(t){this.canvas||(this.canvas=document.createElement("canvas"));let e,i,s,a=this.canvas.getContext("2d");a.font=this.weight+" "+this.fontSize+"px "+this.font;let r=a.measureText(t);e=2**Math.ceil(Math.log2(r.width)),i=2**Math.ceil(Math.log2(a.measureText("M").width)),this.canvas.width=e,this.canvas.height=i,a.fillStyle=this.backgroundColor,a.fillRect(0,0,e,i),a.fillStyle=this.fontColor,a.font=this.weight+" "+this.fontSize+"px "+this.font,a.textAlign="center",a.textBaseline="middle",a.fillText(t,.5*e,.5*i),this.material.map=new g(this.canvas),0!==this.h?(s=this.h/i,this.scale.set(e*s,this.h,0)):0!==this.w?(s=this.w/i,this.scale.set(this.w,i*s,0)):this.scale.set(.025*e,.025*i,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let Ps=0;class Rs{constructor(t={},e){this.motor=e,this.down=!1,this.time=t.time||250,this.p=t.pos||[0,0,0],this.type=t.type||"box",this.name=t.name||"button"+Ps++,this.pos=t.pos||[0,0,0],this.size=t.size||[1,1,1],this.radius=t.radius||0,this.axe=void 0!==t.axe?t.axe:1,this.fontSize=t.fontSize||.8,this.fontScale=t.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let i=this.size[this.axe]-2*this.radius;this.range=[this.origin-i,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},t.callback&&(this.callback=t.callback,delete t.callback),t.button=!0,t.pos=this.pos,t.material||(t.material="button"),t.kinematic=!0,t.mask=1,this.timeout=null,this.b=this.motor.add(t),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),t.text&&this.addText(t.text)}addText(t,e){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let i={text:t,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(i={text:t,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new Es(i),this.b.add(this.txt)}action(t){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&this.motor.explosion(t||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&this.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=fe.lerp(this.value,this.target,this.speed),fe.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,this.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}class Ts{constructor(t,e="drag",i){this.motor=i,this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=e,this.option={},this.overObj=null,this.controler=t,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new n,this.tmpPos=new n,this.tmpD=new n,this.mouse=new b,this.oldMouse=new b,this.raycast=new Tt,this.raycast.far=1e3,this.button=0,this.pos=new n,this.velocity=new n,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.floorDrag=2===this.button,this.helper=new Fs(this.motor),this.dragPlane=new tt(new d(1,1),this.motor.mat.get("hide")),this.floorDrag&&this.dragPlane.geometry.rotateX(.5*-Math.PI),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),this.motor.scenePlus.add(this.helper),this.motor.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(this.motor.scenePlus.remove(this.dragPlane),this.motor.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(t,e={}){t!==this.mode&&(this.mode=t,this.option=e,"blast"===this.mode&&this.option.visible&&this.motor.initParticle())}activeDragMouse(t){t?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("start",this.controleStart.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("start",this.controleStart.bind(this),!1),this.isActive=!1)}controleEnd(t){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleStart(t){this.raycastTest=!1}controleChange(t){}getMouse(t){this.motor.viewSize?(this.mouse.x=t.offsetX/this.motor.viewSize.w*2-1,this.mouse.y=-t.offsetY/this.motor.viewSize.h*2+1):(this.mouse.x=t.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-t.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==t.pointerType?t.button:0}contextmenu(t){}mousedown(t){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(t),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(t){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(t){if("drag"===this.mode)this.getMouse(t),this.needRay=!0}castray(){let t,e,i,s,a,r="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObject(this.dragPlane),t.length&&this.mouseDown&&this.moveSelect(t[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),t=this.raycast.intersectObjects(this.motor.scene.children,!0),this.tmpSelected=null,t.length>0?(i=t[0].object,i.isInstancedMesh?(a=t[0].instanceId,e=this.motor.byName(i.getIDName(a))):i.parent!==this.motor.scene?(s=i.parent,e=s.parent!==this.motor.scene?s.parent:s):e=i,this.mouseDown2&&e.extra&&e.extra(e.name),r=e&&!e.isButton?this.select(e,t[0].point):this.actionButton(e,t[0])):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,r="auto",this.resetOver()),document.body.style.cursor=r}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,this.needRay=!0}blast(){let t=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let e=this.raycast.intersectObjects(this.motor.scene.children,!0);e.length>0?e[0].object.isButton?e[0].object.parent.userData.direct():t=e[0]:(e=this.raycast.intersectObjects(this.motor.scenePlus.children,!0),e.length>0&&(t=e[0]));const i=this.option;t&&(this.motor.explosion(t.point,i.radius||3,i.power||.1),i.visible&&this.motor.addParticle({name:"blast",type:"cube",position:t.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){const t=this.option;this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(t.velocity||60),this.motor.add({name:"bullet_"+this.numBullet,type:"sphere",mass:t.mass||10,size:[t.size||.2],material:t.mat||"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(t,e){if(this.buttonRef?this.buttonRef.name!==t.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=t):this.mouseDown&&(this.buttonRef=t),this.mouseDown&&this.buttonRef.userData.action){let t=e.point;this.buttonRef.userData.action(t)}return"pointer"}setOver(t){t&&(this.overObj&&t.name!==this.overObj.name&&this.resetOver(),this.overObj=t,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(t,e){if(this.mouseDown||this.setOver(t),!this.mouseDown||this.selected===t)return"grab";this.pz=0;let i=e,s=[0,0,0,1];this.selected=t,this.decal.copy(i).sub(this.selected.position),this.tmpPos.copy(i).sub(this.decal),this.angle=this.controler.getAzimuthalAngle(),s=this.selected.quaternion.toArray(),this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(i),this.helper.position.copy(i);let a=i.toArray(),r=!1;this.motor.change({name:this.selected.name,neverSleep:!0,wake:!0});const o=this.motor.engine;if(this.moveDirect)this.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let t=[-.1,.1,600,1],e=[-.1,.1,600,1],i="OIMO"===o||"RAPIER"===o||"JOLT"===o,n=0===this.selected.link?"fixe":"d6";"JOLT"===o&&(n="fixe");let l=[["x",...t],["y",...t],["z",...t],["rx",...e],["ry",...e],["rz",...e]];"HAVOK"===o&&(l=[["x",...t],["y",...t],["z",...t]]),"OIMO"===o&&(r=!0,n=0===this.selected.link?"fixe":"spherical",l=[["x",...t],["y",...t],["z",...t]]),"HAVOK"===o&&(n=0===this.selected.link?"fixe":"spherical",l=[-180,180,.1,.1]),this.motor.add([{name:"mouse",type:"null",pos:a,quat:s,kinematic:!i},{name:"mouseJoint",type:"joint",mode:n,lm:l,sd:[4,1],autoDrive:!0,b1:r?this.selected.name:"mouse",b2:r?"mouse":this.selected.name,worldAnchor:a,visible:!1}])}return"grabbing"}moveSelect(t){if(null===this.selected)return;if(t&&this.tmpPos.copy(t).sub(this.decal),this.moveDeep){let t=this.selected.position.y,e=t-this.tmpPos.y;this.tmpPos.y=t,this.tmpD.set(0,0,e).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let e=this.tmpPos.toArray();this.moveDirect?this.motor.change({name:this.selected.name,pos:e,reset:!0}):this.motor.change({name:"mouse",pos:t.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?this.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(this.motor.remove(["mouseJoint","mouse"]),this.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let t=this.motor.flow.key;if(0!==t[1]){let e=.1*t[1];this.dragPlane.translateZ(e),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class Fs extends Y{constructor(t){super(new e,t.mat.get("line"));let i=.75;const a=[i,i,i,0,0,0];this.geometry.setAttribute("position",new s([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new s(a,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}const Ds=new n;new n;const _s=new n,Cs=new n,js=new n,Ls=new n,qs=new n;class Os{constructor(t={},e){this.first=!0,this.debug=t.debug||!1,this.motor=e,this.name=t.name||"ppp",this.pMass=t.pMass||.01,this.vSize=t.vSize||.16,this.pSize=t.pSize||.02,this.particles=[],this.density=t.density||.01,this.smoothMulty=t.smoothMulty||1,this.smoothing=t.smoothing||.2,this.smoothing*=this.smoothMulty,this.speed=t.speed||.1,this.viscosity=t.viscosity||.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.maxDist=0,this.tv=new n,this.tv2=new n,t.mesh&&this.setMesh(t.mesh,t.crossEdge)}setMesh(t,e=!1){const i=[],s=[];this.mesh=t,this.geometry=t.geometry,this.geometry.getIndex();const a=this.geometry.getAttribute("position").array,r=fe.getHash(this.geometry),o=fe.getFaces(this.geometry),n=e?fe.getConnectedFaces(o):null;let l,h,c,d,p,u;for(let t in r)l=r[t][0],h=3*l,Ds.set(a[h],a[h+1],a[h+2]),this.mesh.localToWorld(Ds),this.add(Ds.toArray());for(let t=0;t<o.length;t++)c=o[t],d=this.getKey(r,c[0]),p=this.getKey(r,c[1]),u=this.getKey(r,c[2]),this.sameLink(i,d,p)||i.push([d,p]),this.sameLink(i,p,u)||i.push([p,u]),this.sameLink(i,u,d)||i.push([u,d]);if(this.connect(i),n){for(let t=0;t<n.length;t++)c=n[t],d=this.getKey(r,c[0]),p=this.getKey(r,c[1]),this.sameLink(i,d,p)||this.sameLink(s,d,p)||s.push([d,p]);this.connect(s,!0)}this.hash=r,this.mesh.position.set(0,0,0),this.mesh.quaternion.set(0,0,0,1),this.mesh.receiveShadow=!0,this.mesh.castShadow=!0,phy.addDirect(this.mesh)}updateMesh(){if(!this.geometry)return;let t,e,i,s=this.hash,a=this.geometry.attributes.position.array,r=this.particles.length;for(;r--;)for(e=this.particles[r],i=s[r].length;i--;)t=3*s[r][i],a[t]=e.position.x,a[t+1]=e.position.y,a[t+2]=e.position.z;this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeVertexNormals(),this.geometry.computeBoundingSphere()}add(t){let e=this.motor.add({instance:this.name,type:"particle",size:[this.vSize],pSize:this.pSize,pos:t,inertia:[0,0,0],mass:this.pMass,restitution:0,friction:.5,damping:[.2,.1],material:this.debug?"particle":"hide",shadow:!1,getVelocity:!0});this.first=!1,e.force=new n,this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(t,e){let i,s,a,r=t.length,o=[],n=0;for(;r--;){if(i=t[r],this.name,i[0],this.name,i[1],s=this.particles[i[0]].position,a=this.particles[i[1]].position,n=this.tv.copy(s).distanceTo(a),e){if(n>this.maxDist)continue}else n>this.maxDist&&(this.maxDist=n);this.tv.copy(a).sub(s),o.push({type:"distance",helperSize:.03,b1:this.name+i[0],b2:this.name+i[1],limit:[.5*n,n],spring:[20,1],collision:!0,noPreProcess:!0,alway:!0})}this.motor.add(o)}getPosition(){let t,e,i=[],s=this.particles.length;for(;s--;)e=3*s,t=this.particles[s],i[e]=t.position.x,i[e+1]=t.position.y,i[e+2]=t.position.z;return i}getNeighbors(t,e){const i=this.particles.length,s=t.idx,a=this.smoothing*this.smoothing;let r=0;for(let o=0;o!==i;o++){const i=this.particles[o];r=this.distanceSq(i,t),s!==i.idx&&r<a&&e.push(i)}}distance(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,a=t.position.z-e.position.z;return Math.sqrt(i*i+s*s+a*a)}distanceSq(t,e){const i=t.position.x-e.position.x,s=t.position.y-e.position.y,a=t.position.z-e.position.z;return i*i+s*s+a*a}w(t){const e=this.smoothing;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)}gradw(t,e){const i=t.length(),s=this.smoothing,a=945/(32*Math.PI*Math.pow(s,9))*Math.pow(s*s-i*i,2);e.copy(t).multiplyScalar(a)}nablaw(t){const e=this.smoothing;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}getKey(t,e){let i;for(let s in t)if(i=t[s],-1!==i.indexOf(e))return s}sameLink(t,e,i){let s,a=t.length,r=!1;for(;a--;)s=t[a],e===i&&(r=!0),e===s[0]&&i===s[1]&&(r=!0),e===s[1]&&i===s[0]&&(r=!0);return r}update(){const t=[],e=this.particles.length,i=this.speed,s=this.eps;let a;for(let t=0;t!==e;t++){const e=this.particles[t];e.force.set(0,0,0);const s=this.neighbors[t];s.length=0,this.getNeighbors(e,s),s.push(this.particles[t]);let r=0;for(a=s.length;a--;){const t=this.w(this.distance(e,s[a]));r+=s[a].mass*t}this.densities[t]=r,this.pressures[t]=i*i*(this.densities[t]-this.density)}const r=_s,o=Cs,n=js,l=Ls,h=qs;let c,d;for(let i=0;i!==e;i++){const e=this.particles[i];let a,p;r.set(0,0,0),o.set(0,0,0);const u=this.neighbors[i],m=u.length;for(let t=0;t!==m;t++)c=u[t],l.copy(e.position).sub(c.position),d=l.length(),a=-c.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+s)+this.pressures[t]/(this.densities[t]*this.densities[t]+s)),this.gradw(l,n),n.multiplyScalar(a),r.add(n),h.copy(c.velocity).sub(e.velocity),h.multiplyScalar(1/(1e-4+this.densities[i]*this.densities[t])*this.viscosity*c.mass),p=this.nablaw(d),h.multiplyScalar(p),o.add(h);o.multiplyScalar(e.mass),r.multiplyScalar(e.mass),e.force.add(o),e.force.add(r),t.push({name:e.name,force:e.force.toArray()})}this.motor.change(t),this.updateMesh()}}const Bs=Math.max(1e-9,Number.EPSILON),Is=.5*Bs,Gs=Math.log10(1/Bs),Ns=Math.pow(10,Gs),Vs=Is*Ns;function Us(t,e,i,s){return function(t,e,i,s,a){let r=e.x-t.x,o=e.y-t.y,n=s.x-i.x,l=s.y-i.y;const h=Xs(t),c=Xs(i);if(h===c)return a;const d=Xs(e);if(d===c)return a;const p=Xs(s);if(h===p)return a;if(d===p)return a;let u=(t.x-i.x)*l-(t.y-i.y)*n,m=(e.x-i.x)*l-(e.y-i.y)*n,b=(i.x-t.x)*o-(i.y-t.y)*r,g=(s.x-t.x)*o-(s.y-t.y)*r;return(u>=0&&m<=0||u<=0&&m>=0)&&(b>=0&&g<=0||b<=0&&g>=0)}(t,e,i,s,!1)}function Ws(t,e,i,s){let a=0,r=new n;return Qs(t)===Qs(e)||0===i.x&&0===i.y&&0===i.z?null:(a=((s.x-t.x)*i.x+(s.y-t.y)*i.y+(s.z-t.z)*i.z)/((e.x-t.x)*i.x+(e.y-t.y)*i.y+(e.z-t.z)*i.z),a>=0&&a<=1?(r=new n(t.x+(e.x-t.x)*a,t.y+(e.y-t.y)*a,t.z+(e.z-t.z)*a),{x:r,s:a}):null)}function Hs(t,e,i){return(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)<=0}function Ks(t){return~~(t*Ns+Vs)}function Js(t,e){return Math.round((t+e)*(t+e+1)*.5+e)}function Xs(t){return Js(Ks(t.x),Ks(t.y))}function Qs(t){return function(t,e,i){const s=(t+e)*(t+e+1)*.5+e;return(s+i)*(s+i+1)*.5+i}(Ks(t.x),Ks(t.y),Ks(t.z))}function Ys(t,e,i){return e.x*(t.x-i.x)+e.y*(t.y-i.y)+e.z*(t.z-i.z)>=0}class Zs{constructor(t=new n,e=new n,i=new b){this.position=t,this.normal=e,this.uv=i}clone(t){return new Zs(this.position.clone(),this.normal.clone(),this.uv.clone())}equals(t){return Qs(this.position)===Qs(t.position)}toString(){return`Position = ${this.position.x}, ${this.position.y}, ${this.position.z}, Normal = ${this.normal.x}, ${this.normal.y}, ${this.normal.z}, UV = ${this.uv.x}, ${this.uv.y}`}}let $s=class{constructor(t=null){this.isFragment=!0,this.vertices=[],this.cutVertices=[],this.triangles=[[],[]],this.constraints=[],this.indexMap=[],this.bounds=new u,this.vertexAdjacency=[],this.convextested=!1,this.minSize=.005,this.good=!0,null!==t&&this.fromArgs(t)}fromArgs(t){const{positions:e,normals:i,uvs:s,indices:a}=t;for(let t=0;t<e.length/3;t++){const a=new n(e[3*t],e[3*t+1],e[3*t+2]),r=new n(i[3*t],i[3*t+1],i[3*t+2]),o=s?new b(s[2*t],s[2*t+1]):new b(0,0);this.vertices.push(new Zs(a,r,o))}if(a)this.triangles=[Array.from(a),[]];else{const t=e.length/3;this.triangles=[Array.from({length:t},((t,e)=>e)),[]]}this.calculateBounds()}get valid(){let t=this.triangleCount>6&&this.vertexCount>14;return this.volume()<this.minSize&&(t=!1),t}get size(){this.bounds||this.calculateBounds();let t=new n;return this.bounds.getSize(t)}get convex(){return this.convextested||(this.cc=this.isConvex()),this.cc}get triangleCount(){return(this.triangles[0].length+this.triangles[1].length)/3}get vertexCount(){return this.vertices.length+this.cutVertices.length}addCutFaceVertex(t,e,i){const s=new Zs(t,e,i);this.vertices.push(s),this.cutVertices.push(s),this.vertexAdjacency.push(this.vertices.length-1)}addMappedVertex(t,e){this.vertices.push(t),this.indexMap[e]=this.vertices.length-1}addTriangle(t,e,i,s){this.triangles[s].push(t,e,i)}addMappedTriangle(t,e,i,s){this.triangles[s].push(this.indexMap[t],this.indexMap[e],this.indexMap[i])}weldCutFaceVertices(){const t=[],e=[],i=new Array(this.cutVertices.length);let s=0;const a=new Map;this.cutVertices.forEach(((r,o)=>{const n=Qs(r.position),l=a.get(n);a.has(n)?i[o]=l:(i[o]=s,a.set(n,s),t.push(this.cutVertices[o]),e.push(this.vertexAdjacency[o]),s++)}));const r=[];for(let t=0;t<this.constraints.length;t++){const e=this.constraints[t];e.v1=i[e.v1],e.v2=i[e.v2],Math.abs(e.v1-e.v2)<1e-9||r.push(e)}this.constraints=r,this.cutVertices=t,this.vertexAdjacency=e}volume(){let t=[];this.vertices.forEach((e=>{t.push(e.position.x,e.position.y,e.position.z)})),this.cutVertices.forEach((e=>{t.push(e.position.x,e.position.y,e.position.z)}));let e,i=t.length/3,s=[0,0,0],a=[0,0,0];for(;i--;)e=3*i,t[e]<s[0]?s[0]=t[e]:t[e]>a[0]&&(a[0]=t[e]),t[e+1]<s[1]?s[1]=t[e+1]:t[e+1]>a[1]&&(a[1]=t[e+1]),t[e+2]<s[2]?s[2]=t[e+2]:t[e+2]>a[2]&&(a[2]=t[e+2]);let r=[a[0]-s[0],a[1]-s[1],a[2]-s[2]];return.5*r[0]*8*(.5*r[1])*(.5*r[2])}calculateBounds(){if(!this.vertices.length)return;let t=this.vertices[0].position.clone(),e=t.clone();this.vertices.forEach((i=>{t.x=Math.min(t.x,i.position.x),t.y=Math.min(t.y,i.position.y),t.z=Math.min(t.z,i.position.z),e.x=Math.max(e.x,i.position.x),e.y=Math.max(e.y,i.position.y),e.z=Math.max(e.z,i.position.z)})),this.bounds=new u(t,e)}toMesh(t,e=null,i=!0,s=0){const a=new n,r=new n;let o=this.toGeometry(i,s);o.boundingBox.getCenter(a),o.boundingBox.getSize(r),o.translate(-a.x,-a.y,-a.z),o.boundingSphere=new Ft(new n,.5*r.length());let l=t.material;e&&l.isMaterial&&(l=[t.material,e]);const h=new tt(o,l);return h.receiveShadow=t.receiveShadow,h.castShadow=t.castShadow,h.matrixAutoUpdate=t.matrixAutoUpdate,h.frustumCulled=t.frustumCulled,h.renderOrder=t.renderOrder,h.sizer=r.length(),a.applyQuaternion(t.quaternion),h.position.copy(t.position).add(a),h.quaternion.copy(t.quaternion),h.userData={origin:h.position.clone(),direction:a.normalize(),size:r},h}makeTrickness(t,e,i,s,a){let r,o=1-a,n=[...t],l=[...e],h=[...i],c=t.length/3,d=c;for(;d--;)r=3*d,n[r]*=o,n[r+1]*=o,n[r+2]*=o;let p=[];for(d=s.length;d--;)p[d]=s[d]+c;return[n,l,h,p]}toGeometry(t,s){let a;const r=new e;let o=[],n=[],l=[];if(this.vertices.forEach((t=>{o.push(t.position.x,t.position.y,t.position.z),n.push(t.normal.x,t.normal.y,t.normal.z),l.push(t.uv.x,t.uv.y)})),0!==s){let t=this.makeTrickness(o,n,l,this.triangles[0],s);o=o.concat(t[0]),n=n.concat(t[1]),l=l.concat(t[2]),a=t[3]}return t&&this.cutVertices.forEach((t=>{o.push(t.position.x,t.position.y,t.position.z),n.push(t.normal.x,t.normal.y,t.normal.z),l.push(t.uv.x,t.uv.y)})),r.addGroup(0,this.triangles[0].length,0),0!==s&&(r.addGroup(this.triangles[0].length,a.length,1),this.triangles[0]=this.triangles[0].concat(a)),t&&r.addGroup(this.triangles[0].length,this.triangles[1].length,1),r.setAttribute("position",new i(new Float32Array(o),3)),r.setAttribute("normal",new i(new Float32Array(n),3)),r.setAttribute("uv",new i(new Float32Array(l),2)),r.setIndex(new i(new Uint32Array(this.triangles.flat()),1)),r.computeBoundingBox(),r}isConvex(t=.001){this.convextested=!0;let e=0;const i=this.triangleCount,s=[...this.triangles[0],...this.triangles[1]],a=[...this.vertices,...this.cutVertices],r=a.length;if(0===i||0===r)return!1;const o=new n,l=new n,h=new n,c=new n,d=new n;let p,u;for(let n=0;n<i;n++){e=3*n,d.copy(a[0].position),o.copy(a[s[e]].position),l.copy(a[s[e+1]].position),h.copy(a[s[e+2]].position),l.sub(o),h.sub(o),c.copy(l).cross(h).normalize(),p=d.sub(o).dot(c);for(let e=0;e<r;e++)if(u=d.copy(a[e].position).sub(o).dot(c),Math.abs(p)>t&&Math.abs(u)>t&&p*u<0)return!1}return!0}};class ta{constructor(t,e,i=-1,s=-1,a=0){this.v1=t,this.v2=e,this.t1=i,this.t2=s,this.t1Edge=a}clone(){return new ta(this.v1,this.v2,this.t1,this.t2,this.t1Edge)}equals(t){return this.v1===t.v1&&this.v2===t.v2||this.v1===t.v2&&this.v2===t.v1}toString(){return`Edge: T${this.t1}->T${this.t2} (V${this.v1}->V${this.v2})`}}class ea{static getBinNumber(t,e,i){return t%2==0?t*i+e:(t+1)*i-e-1}static sort(t,e,i){if(i<=1)return t;e>t.length&&(e=t.length);const s=new Array(i).fill(0),a=new Array(t.length);for(let i=0;i<e;i++)s[t[i].bin]++;for(let t=1;t<i;t++)s[t]+=s[t-1];for(let i=e-1;i>=0;i--){const e=t[i].bin;s[e]--,a[s[e]]=t[i]}for(let i=e;i<a.length;i++)a[i]=t[i];return a}}let ia=class{constructor(t,e){this.index=t,this.coords=e,this.bin=0}toString(){return`${this.coords} -> ${this.bin}`}};const sa=-1;let aa=class{constructor(t,e){if(this.normalizationScaleFactor=1,this.N=t.length,this.N>=3){this.triangleCount=2*this.N+1,this.triangulation=Array.from({length:this.triangleCount},(()=>new Array(6).fill(0))),this.skipTriangle=new Array(this.triangleCount).fill(!1),this.points=new Array(this.N+3),this.normal=e.clone().normalize();let a=t[0].position.clone().sub(t[1].position).normalize(),r=this.normal.clone(),o=new n;o.crossVectors(a,r).normalize();for(let e=0;e<this.N;e++){var i=t[e].position,s=new b(i.dot(a),i.dot(o));this.points[e]=new ia(e,s)}}else this.triangleCount=0,this.triangulation=[],this.skipTriangle=[],this.points=[],this.normal=new n}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.discardTrianglesWithSuperTriangleVertices();const t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||t.push(this.triangulation[e][0],this.triangulation[e][1],this.triangulation[e][2]);return t}normalizeCoordinates(){let t=Number.MAX_VALUE,e=Number.MIN_VALUE,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let a=0;a<this.N;a++)t=Math.min(t,this.points[a].coords.x),e=Math.max(e,this.points[a].coords.x),i=Math.min(i,this.points[a].coords.y),s=Math.max(s,this.points[a].coords.y);const a=Math.max(e-t,s-i);for(let e=0;e<this.N;e++){var r=this.points[e],o=new b((r.coords.x-t)/a,(r.coords.y-i)/a);this.points[e].coords=o}}sortPointsIntoBins(){const t=Math.round(Math.pow(this.N,.25)),e=t*t;for(let e=0;e<this.N;e++){var i=this.points[e];const s=Math.floor(.99*t*i.coords.y),a=Math.floor(.99*t*i.coords.x);i.bin=ea.getBinNumber(s,a,t)}return ea.sort(this.points,this.N,e)}computeTriangulation(){let t=0,e=0,i=this.sortPointsIntoBins();for(let s=0;s<this.N;s++){let a=i[s];if(!a)break;let r=0,o=!1;for(;!o&&!(r++>e||t===sa);){let i=this.points[this.triangulation[t][0]].coords,s=this.points[this.triangulation[t][1]].coords,r=this.points[this.triangulation[t][2]].coords;Hs(i,s,a.coords)?Hs(s,r,a.coords)?Hs(r,i,a.coords)?(this.insertPointIntoTriangle(a,t,e),e+=2,t=e,o=!0):t=this.triangulation[t][5]:t=this.triangulation[t][4]:t=this.triangulation[t][3]}}}addSuperTriangle(){this.points[this.N]=new ia(this.N,new b(-100,-100)),this.points[this.N+1]=new ia(this.N+1,new b(0,100)),this.points[this.N+2]=new ia(this.N+2,new b(100,-100)),this.triangulation[0][0]=this.N,this.triangulation[0][1]=this.N+1,this.triangulation[0][2]=this.N+2,this.triangulation[0][3]=sa,this.triangulation[0][4]=sa,this.triangulation[0][5]=sa}insertPointIntoTriangle(t,e,i){const s=e,a=i+1,r=i+2;this.triangulation[a][0]=t.index,this.triangulation[a][1]=this.triangulation[e][1],this.triangulation[a][2]=this.triangulation[e][2],this.triangulation[a][3]=r,this.triangulation[a][4]=this.triangulation[e][4],this.triangulation[a][5]=s,this.triangulation[r][0]=t.index,this.triangulation[r][1]=this.triangulation[e][0],this.triangulation[r][2]=this.triangulation[e][1],this.triangulation[r][3]=s,this.triangulation[r][4]=this.triangulation[e][3],this.triangulation[r][5]=a,this.updateAdjacency(this.triangulation[e][3],e,r),this.updateAdjacency(this.triangulation[e][4],e,a),this.triangulation[s][1]=this.triangulation[e][2],this.triangulation[s][2]=this.triangulation[e][0],this.triangulation[s][0]=t.index,this.triangulation[s][4]=this.triangulation[e][5],this.triangulation[s][3]=a,this.triangulation[s][5]=r,this.restoreDelauneyTriangulation(t,s,a,r)}restoreDelauneyTriangulation(t,e,i,s){const a=[];for(a.push([e,this.triangulation[e][4]]),a.push([i,this.triangulation[i][4]]),a.push([s,this.triangulation[s][4]]);a.length>0;)if([e,i]=a.pop()??[sa,sa],i!==sa){const s=this.swapQuadDiagonalIfNeeded(t.index,e,i);null!==s&&(a.push([e,s.t3]),a.push([i,s.t4]))}}swapQuadDiagonalIfNeeded(t,e,i){let s=0,a=0,r=0,o=t,n=0,l=0;return this.triangulation[i][3]===e?(s=this.triangulation[i][1],a=this.triangulation[i][0],r=this.triangulation[i][2],n=this.triangulation[i][4],l=this.triangulation[i][5]):this.triangulation[i][4]===e?(s=this.triangulation[i][2],a=this.triangulation[i][1],r=this.triangulation[i][0],n=this.triangulation[i][5],l=this.triangulation[i][3]):(s=this.triangulation[i][0],a=this.triangulation[i][2],r=this.triangulation[i][1],n=this.triangulation[i][3],l=this.triangulation[i][4]),this.swapTest(this.points[s].coords,this.points[a].coords,this.points[r].coords,this.points[o].coords)?(this.updateAdjacency(n,i,e),this.updateAdjacency(this.triangulation[e][5],e,i),this.triangulation[e][0]=o,this.triangulation[e][1]=s,this.triangulation[e][2]=r,this.triangulation[i][0]=o,this.triangulation[i][1]=r,this.triangulation[i][2]=a,this.triangulation[i][3]=e,this.triangulation[i][4]=l,this.triangulation[i][5]=this.triangulation[e][5],this.triangulation[e][4]=n,this.triangulation[e][5]=i,{t3:n,t4:l}):null}discardTrianglesWithSuperTriangleVertices(){for(let t=0;t<this.triangleCount;t++)(this.triangleContainsVertex(t,this.N)||this.triangleContainsVertex(t,this.N+1)||this.triangleContainsVertex(t,this.N+2))&&(this.skipTriangle[t]=!0)}swapTest(t,e,i,s){const a=t.x-i.x,r=e.x-i.x,o=t.y-i.y,n=e.y-i.y,l=t.x-s.x,h=e.x-s.x,c=t.y-s.y,d=e.y-s.y,p=a*r+o*n,u=h*l+d*c;return!(p>=0&&u>=0)&&(p<0&&u<0||(a*n-r*o)*u+(h*c-l*d)*p<0)}triangleContainsVertex(t,e){return this.triangulation[t][0]===e||this.triangulation[t][1]===e||this.triangulation[t][2]===e}updateAdjacency(t,e,i){if(t===sa)return;const s=this.findSharedEdge(t,e);s&&(this.triangulation[t][s]=i)}findSharedEdge(t,e){return t===sa?null:this.triangulation[t][3]===e?3:this.triangulation[t][4]===e?4:this.triangulation[t][5]===e?5:null}},ra=class{constructor(t,e,i,s,a,r,o,n,l,h){this.q1=t,this.q2=e,this.q3=i,this.q4=s,this.t1=a,this.t2=r,this.t1L=o,this.t1R=n,this.t2L=l,this.t2R=h}toString(){return`T${this.t1}/T${this.t2} (V${this.q1},V${this.q2},V${this.q3},V${this.q4})`}},oa=class extends aa{edgeVertex1=[0,0,0,0,1,2];edgeVertex2=[0,0,0,1,2,0];oppositePoint=[0,0,0,2,0,1];nextEdge=[0,0,0,4,5,3];previousEdge=[0,0,0,5,3,4];constructor(t,e,i){super(t,i),this.constraints=e,this.vertexTriangles=[]}triangulate(){if(this.N<3)return[];this.addSuperTriangle(),this.normalizeCoordinates(),this.computeTriangulation(),this.constraints.length>0&&(this.applyConstraints(),this.discardTrianglesViolatingConstraints()),this.discardTrianglesWithSuperTriangleVertices();let t=[];for(let e=0;e<this.triangleCount;e++)this.skipTriangle[e]||(t.push(this.triangulation[e][0]),t.push(this.triangulation[e][1]),t.push(this.triangulation[e][2]));return t}applyConstraints(){const t=this.triangulation.length;this.vertexTriangles=new Array(this.N+3).fill(0);for(let e=0;e<t;e++)this.vertexTriangles[this.triangulation[e][0]]=e,this.vertexTriangles[this.triangulation[e][1]]=e,this.vertexTriangles[this.triangulation[e][2]]=e;for(let t of this.constraints){if(t.v1===t.v2)continue;const e=this.findIntersectingEdges(t,this.vertexTriangles);this.removeIntersectingEdges(t,e)}}findIntersectingEdges(t,e){const i=[],s=this.findStartingEdge(e,t);if(null===s)return i;i.push(s);let a=s.t1,r=s.t1Edge,o=a,n=!1;for(;!n;){o=a,a=this.triangulation[a][r];const e=this.points[t.v1].coords,s=this.points[t.v2].coords,l=this.points[this.triangulation[a][0]].coords,h=this.points[this.triangulation[a][1]].coords,c=this.points[this.triangulation[a][2]].coords;if(this.triangleContainsVertex(a,t.v2))n=!0;else if(this.triangulation[a][3]!==o&&Us(e,s,l,h)){r=3;const t=new ta(this.triangulation[a][0],this.triangulation[a][1],a,this.triangulation[a][3],r);i.push(t)}else if(this.triangulation[a][4]!==o&&Us(e,s,h,c)){r=4;const t=new ta(this.triangulation[a][1],this.triangulation[a][2],a,this.triangulation[a][4],r);i.push(t)}else{if(this.triangulation[a][5]===o||!Us(e,s,c,l)){console.warn("Failed to find final triangle, exiting early.");break}{r=5;const t=new ta(this.triangulation[a][2],this.triangulation[a][0],a,this.triangulation[a][5],r);i.push(t)}}}return i}findStartingEdge(t,e){let i,s,a,r=new ta(-1,-1),o=e.v1,n=t[o],l=!1,h=null;const c=new Array(this.triangulation.length);for(;!h&&!l;){if(c[n]=!0,this.triangleContainsConstraint(n,e))return null;if(h=this.edgeConstraintIntersectsTriangle(n,e),h)break;if(i=this.triangulation[n][3],s=this.triangulation[n][4],a=this.triangulation[n][5],-1!==i&&!c[i]&&this.triangleContainsVertex(i,o))n=i;else if(-1!==s&&!c[s]&&this.triangleContainsVertex(s,o))n=s;else{if(-1===a||c[a]||!this.triangleContainsVertex(a,o)){l=!0;break}n=a}}if(h){const t=this.triangulation[n][this.edgeVertex1[h]],e=this.triangulation[n][this.edgeVertex2[h]],i=this.triangulation[n][h];return r=new ta(t,e,n,i,h),r}return null}removeIntersectingEdges(t,e){let i,s=[],a=0;for(;e.length>0&&a<=e.length;){i=e.shift(),null==i&&console.log("no edge !!");let r=this.findQuadFromSharedEdge(i.t1,i.t1Edge);if(r)if(Us(this.points[r.q4].coords,this.points[r.q3].coords,this.points[r.q1].coords,this.points[r.q2].coords)){this.swapQuadDiagonal(r,e,s,this.constraints);let i=new ta(r.q3,r.q4,r.t1,r.t2,5);Us(this.points[t.v1].coords,this.points[t.v2].coords,this.points[r.q3].coords,this.points[r.q4].coords)?e.push(i):(a=0,s.push(i))}else e.push(i);a++}s.length>0&&this.restoreConstrainedDelauneyTriangulation(t,s)}restoreConstrainedDelauneyTriangulation(t,e){let i=!0;for(;i;){i=!1;for(let s=0;s<e.length;s++){const a=e[s];if(a.equals(t))continue;let r=this.findQuadFromSharedEdge(a.t1,a.t1Edge);if(r&&this.swapTest(this.points[r.q1].coords,this.points[r.q2].coords,this.points[r.q3].coords,this.points[r.q4].coords)){this.swapQuadDiagonal(r,e,this.constraints,null);const t=r.q3,a=r.q4;e[s]=new ta(t,a,r.t1,r.t2,5),i=!0}}}}discardTrianglesViolatingConstraints(){this.skipTriangle.fill(!0);let t=new Set;for(let e=0;e<this.constraints.length;e++){const i=this.constraints[e];t.add(Js(i.v1,i.v2))}let e,i,s,a,r,o,n,l,h,c=[];const d=new Array(this.triangulation.length);for(let p=0;p<this.triangleCount;p++)if(!d[p]&&(e=this.triangulation[p][0],i=this.triangulation[p][1],s=this.triangulation[p][2],a=t.has(Js(e,i)),r=t.has(Js(i,s)),o=t.has(Js(s,e)),n=t.has(Js(i,e)),l=t.has(Js(s,i)),h=t.has(Js(e,s)),!(n||l||h)&&(a||r||o)))for(this.skipTriangle[p]=!1,c=[],a||c.push(this.triangulation[p][3]),r||c.push(this.triangulation[p][4]),o||c.push(this.triangulation[p][5]);c.length>0;){const a=c.shift();void 0===a||-1===a||d[a]||(e=this.triangulation[a][0],i=this.triangulation[a][1],s=this.triangulation[a][2],n=t.has(Js(i,e)),l=t.has(Js(s,i)),h=t.has(Js(e,s)),n||l||h?d[a]=!0:(this.skipTriangle[a]=!1,d[a]=!0,t.has(Js(e,i))||c.push(this.triangulation[a][3]),t.has(Js(i,s))||c.push(this.triangulation[a][4]),t.has(Js(s,e))||c.push(this.triangulation[a][5])))}}triangleContainsConstraint(t,e){return!(t>=this.triangulation.length||this.triangulation[t][0]!==e.v1&&this.triangulation[t][1]!==e.v1&&this.triangulation[t][2]!==e.v1||this.triangulation[t][0]!==e.v2&&this.triangulation[t][1]!==e.v2&&this.triangulation[t][2]!==e.v2)}edgeConstraintIntersectsTriangle(t,e){const i=this.points[e.v1].coords,s=this.points[e.v2].coords,a=this.points[this.triangulation[t][0]].coords,r=this.points[this.triangulation[t][1]].coords,o=this.points[this.triangulation[t][2]].coords;return Us(i,s,a,r)?3:Us(i,s,r,o)?4:Us(i,s,o,a)?5:null}findQuadFromSharedEdge(t,e){let i,s,a,r,o,n,l,h,c=this.triangulation[t][e],d=this.findSharedEdge(c,t);return d?(3===d?(s=this.triangulation[c][0],i=this.triangulation[c][1],a=this.triangulation[c][2]):4===d?(s=this.triangulation[c][1],i=this.triangulation[c][2],a=this.triangulation[c][0]):(s=this.triangulation[c][2],i=this.triangulation[c][0],a=this.triangulation[c][1]),r=this.triangulation[t][this.oppositePoint[e]],o=this.triangulation[t][this.previousEdge[e]],n=this.triangulation[t][this.nextEdge[e]],l=this.triangulation[c][this.nextEdge[d]],h=this.triangulation[c][this.previousEdge[d]],new ra(i,s,a,r,t,c,o,n,l,h)):null}swapQuadDiagonal(t,e,i,s){const a=t.t1,r=t.t2,o=t.t1R,n=t.t1L,l=t.t2R,h=t.t2L;this.triangulation[a][0]=t.q4,this.triangulation[a][1]=t.q1,this.triangulation[a][2]=t.q3,this.triangulation[r][0]=t.q4,this.triangulation[r][1]=t.q3,this.triangulation[r][2]=t.q2,this.triangulation[a][3]=n,this.triangulation[a][4]=h,this.triangulation[a][5]=r,this.triangulation[r][3]=a,this.triangulation[r][4]=l,this.triangulation[r][5]=o,this.updateAdjacency(h,r,a),this.updateAdjacency(o,a,r),this.updateEdgesAfterSwap(e,a,r,n,o,h,l),this.updateEdgesAfterSwap(i,a,r,n,o,h,l),this.updateEdgesAfterSwap(s,a,r,n,o,h,l),this.vertexTriangles[t.q1]=a,this.vertexTriangles[t.q2]=r}updateEdgesAfterSwap(t,e,i,s,a,r,o){if(t)for(let n of t)n.t1===e&&n.t2===a?(n.t1=i,n.t2=a,n.t1Edge=5):n.t1===e&&n.t2===s?n.t1Edge=3:n.t1===a&&n.t2===e?n.t2=i:n.t1===s&&n.t2===e||(n.t1===i&&n.t2===o?n.t1Edge=4:n.t1===i&&n.t2===r?(n.t1=e,n.t2=r,n.t1Edge=4):n.t1===o&&n.t2===i||n.t1===r&&n.t2===i&&(n.t2=e))}};function na(t,e,i,s,a,r=!1,o=!0){const n=new $s,l=new $s,h=new Array(t.vertexCount).fill(!1);for(let s=0;s<t.vertices.length;s++){const a=t.vertices[s];h[s]=Ys(a.position,e,i),(h[s]?n:l).addMappedVertex(a,s)}const c=t.vertices.length;for(let s=0;s<t.cutVertices.length;s++){const a=t.cutVertices[s];h[s+c]=Ys(a.position,e,i),(h[s+c]?n:l).addMappedVertex(a,s+c)}return la(t,n,l,e,i,h,0),o&&la(t,n,l,e,i,h,1),o&&function(t,e,i,s,a,r){if(t.weldCutFaceVertices(),e.weldCutFaceVertices(),t.cutVertices.length<3)return;const o=r?new aa(t.cutVertices,i):new oa(t.cutVertices,t.constraints,i),n=o.triangulate();for(let r=0;r<t.cutVertices.length;r++){var l=t.cutVertices[r],h=o.points[r];const n=new b(o.normalizationScaleFactor*h.coords.x*s.x+a.x,o.normalizationScaleFactor*h.coords.y*s.y+a.y),c=new Zs(l.position.clone(),i.clone(),n.clone()),d=new Zs(l.position.clone(),i.clone().negate(),n.clone());t.cutVertices[r]=c,e.cutVertices[r]=d}let c=t.vertices.length,d=e.vertices.length;for(let i=0;i<n.length;i+=3)t.addTriangle(c+n[i],c+n[i+1],c+n[i+2],1),e.addTriangle(d+n[i],d+n[i+2],d+n[i+1],1)}(n,l,e.clone().negate(),s,a,r),{topSlice:n,bottomSlice:l}}function la(t,e,i,s,a,r,o){const n=t.triangles[o];let l,h,c;for(let d=0;d<n.length;d+=3)l=n[d],h=n[d+1],c=n[d+2],r[l]&&r[h]&&r[c]?e.addMappedTriangle(l,h,c,o):r[l]||r[h]||r[c]?r[h]&&r[c]&&!r[l]?ha(h,c,l,s,a,t,e,i,o,!0):r[c]&&r[l]&&!r[h]?ha(c,l,h,s,a,t,e,i,o,!0):r[l]&&r[h]&&!r[c]?ha(l,h,c,s,a,t,e,i,o,!0):r[h]||r[c]||!r[l]?r[c]||r[l]||!r[h]?r[l]||r[h]||!r[c]||ha(l,h,c,s,a,t,e,i,o,!1):ha(c,l,h,s,a,t,e,i,o,!1):ha(h,c,l,s,a,t,e,i,o,!1):i.addMappedTriangle(l,h,c,o)}function ha(t,e,i,s,a,r,o,l,h,c){const d=r.vertices.length;let p=t<d?r.vertices[t]:r.cutVertices[t-d],u=e<d?r.vertices[e]:r.cutVertices[e-d],m=i<d?r.vertices[i]:r.cutVertices[i-d];const g=Ws(p.position,m.position,s,a),f=Ws(u.position,m.position,s,a);if(g&&f){const s=new n(p.normal.x+g.s*(m.normal.x-p.normal.x),p.normal.y+g.s*(m.normal.y-p.normal.y),p.normal.z+g.s*(m.normal.z-p.normal.z)).normalize(),a=new n(u.normal.x+f.s*(m.normal.x-u.normal.x),u.normal.y+f.s*(m.normal.y-u.normal.y),u.normal.z+f.s*(m.normal.z-u.normal.z)).normalize(),r=new b(p.uv.x+g.s*(m.uv.x-p.uv.x),p.uv.y+g.s*(m.uv.y-p.uv.y)),d=new b(u.uv.x+f.s*(m.uv.x-u.uv.x),u.uv.y+f.s*(m.uv.y-u.uv.y));o.addCutFaceVertex(g.x,s,r),o.addCutFaceVertex(f.x,a,d),l.addCutFaceVertex(g.x,s,r),l.addCutFaceVertex(f.x,a,d);const y=o.vertices.length,v=l.vertices.length,x=o.cutVertices.length,w=l.cutVertices.length,k=y-2,M=y-1,S=v-2,A=v-1;c?(o.addTriangle(M,k,o.indexMap[e],h),o.addTriangle(k,o.indexMap[t],o.indexMap[e],h),l.addTriangle(l.indexMap[i],S,A,h),o.constraints.push(new ta(x-2,x-1)),l.constraints.push(new ta(w-1,w-2))):(o.addTriangle(k,M,o.indexMap[i],h),l.addTriangle(l.indexMap[t],l.indexMap[e],S,h),l.addTriangle(l.indexMap[e],A,S,h),o.constraints.push(new ta(x-1,x-2)),l.constraints.push(new ta(w-2,w-1)))}}let ca=class{constructor(t){this.parent=[],this.rank=[];for(let e=0;e<t;e++)this.parent[e]=e,this.rank[e]=1}find(t){return this.parent[t]!==t&&(this.parent[t]=this.find(this.parent[t])),this.parent[t]}union(t,e){const i=this.find(t),s=this.find(e);i!==s&&(this.rank[i]>this.rank[s]?this.parent[s]=i:this.rank[i]<this.rank[s]?this.parent[i]=s:(this.parent[s]=i,this.rank[i]+=1))}};function da(t){const e=new ca(t.vertexCount),i={},s=t.vertices.length,a=t.cutVertices.length,r=new Map;t.vertices.forEach(((t,i)=>{const s=Qs(t.position),a=r.get(s);void 0===a?r.set(s,i):e.union(a,i)}));for(let i=0;i<a;i++)e.union(t.vertexAdjacency[i],i+s);const o=t.triangles;for(let t=0;t<o.length;t++)for(let s=0;s<o[t].length;s+=3){const a=o[t][s],r=o[t][s+1],n=o[t][s+2];e.union(a,r),e.union(r,n);const l=e.find(a);i[l]||(i[l]=[[],[]]),i[l][t].push(a,r,n)}const n={},l=Array(t.vertexCount);for(let i=0;i<s;i++){const s=e.find(i);n[s]||(n[s]=new $s),n[s].vertices.push(t.vertices[i]),l[i]=n[s].vertices.length-1}for(let i=0;i<a;i++){const a=e.find(i+s);n[a].cutVertices.push(t.cutVertices[i]),l[i+s]=n[a].vertices.length+n[a].cutVertices.length-1}for(const s of Object.keys(i)){let a=Number(s),r=e.parent[a];for(let e=0;e<t.triangles.length;e++)for(const t of i[a][e]){const i=l[t];n[r].triangles[e].push(i)}}return Object.values(n)}const pa={textureScale:new b(1,1),textureOffset:new b},ua=new n,ma=new n,ba=new n,ga=new at,fa=new at;function ya(t,e,i,s,a,r){const o=[],l=t.matrixWorld.clone().invert(),h=t.position;e.applyMatrix4(l);const c=function(t){const e=t.attributes.position.array,i=t.attributes.normal.array,s=t.attributes.uv?.array,a=new $s,r=t.attributes.position.count;let o,l,h;for(let t=0;t<r;t++){o=3*t,l=2*t;const r=new n(e[o],e[o+1],e[o+2]),h=new n(i[o],i[o+1],i[o+2]),c=s?new b(s[l],s[l+1]):new b(0,0);a.vertices.push(new Zs(r,h,c))}if(t.index)h=Array.from(t.index.array);else{const t=e.length/3;h=Array.from({length:t},((t,e)=>e))}if(t.groups&&2===t.groups.length){const e=[],i=[];for(const s of t.groups){const t=0===s.materialIndex?e:i,a=s.start,r=a+s.count;for(let e=a;e<r;e++)t.push(h[e])}a.triangles=[e,i]}else a.triangles=[h,[]];return a.calculateBounds(),a}(t.geometry);let d=c.convex,p=.03*c.volume();ua.addVectors(e,i),ga.setFromCoplanarPoints(e,h,ua);const u=a+s;return function t(a,c,m,b){if(!a)return;if(Math.random()<.05*b||b>u)return void(a.valid&&o.push(a));let g=Math.PI,f=new n;a.calculateBounds(),a.bounds.getCenter(f);let y=d;if(0===b)fa.normal.copy(ga.normal),fa.constant=ga.constant;else if(b<=s)g=(m-c)*(.2+.6*Math.random())+c,ma.copy(h).sub(e).applyAxisAngle(i,g).add(e),fa.setFromCoplanarPoints(e,ua,ma);else{let t=f.clone().applyMatrix4(l);g=(.5*(1&b)+.2*(2-Math.random()))*Math.PI,ma.copy(e).sub(t).applyAxisAngle(i,g).add(t),ba.copy(i).add(t),fa.setFromCoplanarPoints(t,ba,ma)}const{topSlice:v,bottomSlice:x}=na(a,fa.normal,ma,pa.textureScale,pa.textureOffset,y,r);let w=v,k=x;w=da(v),k=da(x),w&&(w.isFragment&&(w=[w]),w=va(w,p),w.length>0&&w.forEach(((e,i)=>{0===i?t(e,g,m,b+1):o.push(e)}))),k&&(k.isFragment&&(k=[k]),k=va(k,p),k.length>0&&k.forEach(((e,i)=>{0===i?t(e,g,m,b+1):o.push(e)})))}(c,0,2*Math.PI,0),o}function va(t,e){if(0===t.length)return[];let i=0,s=-1,a=[];return t.forEach(((t,a)=>{t.minSize=e,t.bounds=null;let r=.5*t.size.length();t.valid&&r>0?r>i&&(i=r,s=a):t.good=!1})),-1!==s&&a.push(t[s]),t.forEach(((t,e)=>{t.good&&e!==s&&a.push(t)})),a}class xa{constructor(t){this.motor=t,this.tpos=new n,this.tnormal=new n,this.nDebris=0,this.maxDebris=1500,this.interneMat=this.motor.getMat("chrome"),this.tt=null}add(t,e=[]){let i=this,s=0;-1!==t.name.search("_debris_")&&(s=1e3),setTimeout((()=>{i.motor.addCollision({name:t.name,ignore:t.ignore}),t.addEventListener("collision",(t=>{let e=t.data;1===e.hit&&i.makeBreak(e.from,e.point,e.normal,e.impulse,e.v1)}))}),s)}makeBreak(t,e,i,s,a){let r=this.motor.byName(t);if(!r)return;if(!r.breakable)return;let o=r.breakOption;const l=void 0===o[4]||o[4];if(s<o[0])return;this.motor.removeCollision(t),this.motor.remove(t);const h=new n;r.geometry.boundingBox.getSize(h);const c=h.length();let d=function(t,e,i,s=!0,a=0){const r=[];return t.map(((t,o)=>{r.push(t.toMesh(e,i,s,a))})),r}(ya(r,this.tpos.fromArray(e),this.tnormal.fromArray(i),o[1],o[2],l),r,this.interneMat,l,0);if(d.length<1)return;let p,u,m,b,g,f=[],y=d.length,v=0,x=[...r.ignore];for(;y--;)p=d[v],u=p.geometry.attributes.position.count,m=p.sizer/c,b={},g=[...o],g[3]=g[3]-1,m<.2&&(g[3]=0),p.sizer>.02&&u>6&&(this.nDebris++,b.name=t+"_debris_"+v,b.mass=r.mass*m,f.push(this.addDebris(p,g,b)),x.push(b.name)),v++;for(y=f.length;y--;)f[y].ignore=x;this.motor.add(f)}addDebris(t,e,i){let s=e[3]>0;return{...i,type:"convex",shape:t.geometry,material:t.material,pos:t.position.toArray(),quat:t.quaternion.toArray(),breakable:s,breakOption:e}}}class wa{constructor(t={},e){this.motor=e,this.utils=this.motor.utils,this.id=0,this.type="autoRagdoll",this.name=t.name||this.type+this.id++;let i=this.utils.byName(this.name);i&&this.utils.remove(i),this._mode=t.mode||"follow",this._size=t.size||1,this._debug=t.debug||!1;const s=ie.clone(t.model);let a;s.scale.set(1,1,1).multiplyScalar(this._size),t.pos&&s.position.fromArray(t.pos),s.raycast=function(){},s.name=this.name,s.traverse((e=>{e.isMesh&&(e.frustumCulled=!1),e.isSkinnedMesh&&(e.raycast=function(){},e.frustumCulled=!1,e.matrixAutoUpdate=!1,e.receiveShadow=!0,e.castShadow=!0,t.material&&(e.material=t.material),e.skeleton.resetScalling(),a=e.skeleton.bones)}));let r=t.mass||null;return this.skeletonBody=new Li(this.motor,s.name,s,a,r,t.option),this.debug=this._debug,this.mode=this._mode,s.add(this.skeletonBody),this.model=s,this.utils.add(this),this}getRealPosition(){return this.utils.byName(this.skeletonBody.nodes[0].name).position}dispose(){this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.parent.remove(this.model)}get position(){return model.position}get size(){return this._size}set size(t){this._size=t,this.model.scale.set(1,1,1).multiplyScalar(this._size)}get debug(){return this._debug}set debug(t){this._debug=t,this.skeletonBody.isVisible(this._debug)}get mode(){return this._mode}set mode(t){this._mode=t,this.skeletonBody.setMode(this._mode)}}class ka extends t{constructor(t){super(),this.rayCount=0,this.ray=[],this.motor=t,this.maxVertices=1e4,this.currentVertex=0,this.geometry=new e,this.geometry.setAttribute("position",new s(3*this.maxVertices,3)),this.geometry.setAttribute("color",new s(3*this.maxVertices,3)),this.positions=this.geometry.attributes.position.array,this.colors=this.geometry.attributes.color.array,this.material=new a({vertexColors:!0,toneMapped:!1,depthTest:!1,depthWrite:!1}),this.material.transparent=!0,this.renderOrder=3e4,this.frustumCulled=!1}DrawRay(t,e,i){i=new x(i);let s=this.currentVertex,a=3*s;this.positions[a]=t.x,this.positions[a+1]=t.y,this.positions[a+2]=t.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,s++,a=3*s,this.positions[a]=t.x+e.x,this.positions[a+1]=t.y+e.y,this.positions[a+2]=t.z+e.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,this.currentVertex+=2}collapseBuffer(){let t=this.maxVertices,e=this.currentVertex,i=0;for(;t>=e;)i=3*t,this.positions[i]=0,this.positions[i+1]=0,this.positions[i+2]=0,this.colors[i]=0,this.colors[i+1]=0,this.colors[i+2]=0,t--}insertLine(t,e,i){let s=this.currentVertex,a=3*s;this.positions[a]=t.x,this.positions[a+1]=t.y,this.positions[a+2]=t.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,s++,a=3*s,this.positions[a]=e.x,this.positions[a+1]=e.y,this.positions[a+2]=e.z,this.colors[a]=i.r,this.colors[a+1]=i.g,this.colors[a+2]=i.b,this.currentVertex+=2}draw(){this.collapseBuffer(),this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.currentVertex=0}dispose(){this.parent.remove(this),this.material.dispose(),this.geometry.dispose()}}const Ma={sunPosition:new n(.27,1,.5),sunTop:new n(0,.99,0),saturation:1,noiseMap:null,nightLuminosity:.03,cloud_size:.29,cloud_covr:.1,cloud_dens:.4,cloud_dist:.64,haze:.1,mixRatio:.76,SAMPLE:64,STEP:4,cloudColor:new x(16777209).multiplyScalar(1),skyColor:new x(4348022),fogColor:new x(11253184),groundColor:new x(8421504),sunColor:new x(16777215).multiplyScalar(3)},Sa={defines:{USE_NOISE_MAP:!1},uniforms:{lightdir:{value:Ma.sunPosition},sunTop:{value:Ma.sunTop},noiseMap:{value:Ma.noiseMap},mixRatio:{value:Ma.mixRatio},cloud_size:{value:Ma.cloud_size},cloud_covr:{value:Ma.cloud_covr},cloud_dens:{value:Ma.cloud_dens},cloud_dist:{value:Ma.cloud_dist},nightLuminosity:{value:Ma.nightLuminosity},haze:{value:Ma.haze},saturation:{value:Ma.saturation},SAMPLE:{value:Ma.SAMPLE},STEP:{value:Ma.STEP},fogy:{value:Ma.fogy},t:{value:1},fogColor:{value:Ma.fogColor},groundColor:{value:Ma.groundColor},cloudColor:{value:Ma.cloudColor},skyColor:{value:Ma.skyColor},sunColor:{value:Ma.sunColor}},vertexShader:"\nvarying vec3 worldPosition;\nvoid main()\t{\n\tworldPosition = ( modelMatrix * vec4( position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n//precision highp float;\nvarying vec3 worldPosition;\n\nuniform vec3 fogColor;\nuniform vec3 groundColor;\nuniform vec3 cloudColor;\nuniform vec3 skyColor;\nuniform vec3 sunColor;\n\nuniform float saturation;\n\nuniform float hue;\nuniform float mixRatio;\nuniform float fogy;\n\nuniform vec3 sunTop;\n\nuniform sampler2D noiseMap;\nuniform vec3 lightdir;\n\nuniform float cloud_size;\nuniform float cloud_covr;\nuniform float cloud_dens;\nuniform float cloud_dist;\n\nuniform float nightLuminosity;\nuniform float haze;\nuniform float t;\n\nuniform int SAMPLE;\nuniform int STEP;\n\n//const float c = 6.36e6;\n//const float d = 6.38e6;\nconst float c = 6.407e6;\nconst float d = 6.416e6;\n\n//const float g = 0.76; // mix ratio\n//const float h = g*g;\nconst float icc = 1.0/8e3;\nconst float jcc = 1.0/1200.0;\nconst float pi = 3.141592653589793;\n\nconst vec3 vm = vec3( 0,-c,0 );\n//const vec3 vn = vec3( 2.1e-5 );\n//const vec3 vo = vec3( 5.8e-6, 1.35e-5, 3.31e-5 );\n\n//const vec3 vn = vec3( 0.000021 );\n//const vec3 vo = vec3( 0.0000058, 0.0000135, 0.0000331 );// sky base color\n\n//const vec3 vo = vec3( 0.000021 );// sky base color\n\n\n#ifdef USE_NOISE_MAP\n\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    vec2 uv = (p.xy+vec2(37.0,17.0)*p.z) + f.xy;\n    vec2 rg = texture2D( noiseMap, (uv+0.5)/256.0, -16.0 ).yx;\n    return mix( rg.x, rg.y, f.z );\n}\n\n#else\n\nfloat hash( float n ) { return fract(sin(n)*753.5453123); }\nfloat noise( in vec3 x ){\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n    float n = p.x + p.y*157.0 + 113.0*p.z;\n    return mix(mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n                   mix( hash(n+157.0), hash(n+158.0),f.x),f.y),\n               mix(mix( hash(n+113.0), hash(n+114.0),f.x),\n                   mix( hash(n+270.0), hash(n+271.0),f.x),f.y),f.z);\n}\n\n#endif\n\nfloat NOISE( vec3 r )\n{\n\tr.xz += t;\n\tr *= 0.5;\n\tfloat s;\n\ts = 0.5 * noise(r);\n\tr = r * 2.52;\n\ts += 0.25 * noise(r);\n\tr = r * 2.53;\n\ts += 0.125 * noise(r);\n\tr = r * 2.51;\n\ts += 0.0625 * noise(r);\n\tr = r * 2.53;\n\ts += 0.03125 * noise(r);\n\tr = r * 2.52;\n\ts += 0.015625 * noise(r);\n\treturn s;\n}\n\nfloat MakeNoise( vec3 r )\n{\n\tfloat s,tt;\n\ts = NOISE( r * 2e-4 * ( 1.0 - cloud_size ) );\n\ttt = ( 1.0 - cloud_covr ) * 0.5 + 0.2;\n\ts = smoothstep( tt, tt+.2 , s );\n\ts *= 0.5*(cloud_dens*100.0);\n\treturn s;\n}\n\nvoid clouds( in vec3 r, out vec3 u )\n{\n\tfloat v,w;\n\tv = length( r-vm ) - c;\n\tw = 0.0;\n\tif( 5e3 < v && v < 1e4 ) w = MakeNoise( r ) * (sin( pi*(v-5e3)/5e3 ));\n\tu = vec3( exp(-v*icc), exp(-v*jcc), w );\n}\n\nfloat ca( in vec3 r, in vec3 s, in float t )\n{\n\tvec3 u = r - vm;\n\tfloat v,w,x,y,z,A;\n\tv = dot(u,s);\n\tw = dot(u,u)-t*t;\n\tx = v*v-w;\n\tif( x < 0.0 ) return -1.0;\n\ty = sqrt(x);\n\tz = -v-y;\n\tA = -v+y;\n\treturn z >= 0.0 ? z : A;\n}\n\nvec3 czm_saturation(vec3 rgb, float adjustment)\n{\n    vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(rgb, W));\n    return mix(intensity, rgb, adjustment);\n}\n\n\nvec3 makeSky( in vec3 lightpos, in vec3 r, in vec3 world, out float mask )\n{\n\n\tvec3 vn = vec3( 0.000021 );\n\tvec3 vo = skyColor;\n\tvo *= 0.00005;\n\n\tfloat u,v,w,x,y,z,m, M, N, S, H, F;\n\tvec3 p = lightpos;\n\tu = ca(r,world,d);\n\tv = dot(world,p);\n\tw = 1.0+v*v;\n\n\tfloat gg = mixRatio;\n\tfloat hh = gg*gg;\n\n\tx = 0.0596831*w;\n\ty = 0.0253662*(1.0-hh)*w/((2.0+hh)*pow(abs(1.0+hh-2.0*gg*v),1.5));\n\tz = 50.*pow(abs(1.+dot(world,-p)),2.0)*dot(vec3(0.,1.,0.),p)*(1.0-cloud_covr)*(1.0-min(fogy,1.0));\n\n\tm = 0.0;\n\tvec3 D,E, CB, CM, BB, BM, SX;\n\n\tF = u / float( SAMPLE );\n\n\tBB = vec3(0.0);\n\tBM = vec3(0.0);\n\n\tfloat count = 0.0;\n\n\tfor( int G=0; G<SAMPLE; ++G ){\n\n\t\tH = float(G)*F;\n\t\tvec3 I = r + world * H;\n\t\t//CB = vec3(1.0);\n\t\t//BB = vec3(0.0);\n\t\tclouds( I, CB );\n\t\tCB += fogy;// add fog\n\t\tCB.y += CB.z;// add clound\n\t\tCB.xy *= F;\n\t\tBB += CB;\n\n\t\tM = ca(I,p,d);\n\n\t\tif( M > 0.0 ){\n\n\t\t\tN = M/float(STEP);\n\t\t\tBM = vec3(0.0);\n\n\t\t\tfor( int R=0; R<STEP; ++R ){\n\n\t\t\t\tS = float(R)*N;\n\t\t\t\tvec3 T=I+p*S;\n\t\t\t\tclouds( T, CM );\n\t\t\t\tCM += fogy;// add fog\n\t\t\t\tCM.y += CM.z;// add clound\n\t\t\t\tBM += CM * N;\n\n\t\t\t}\n\n\t\t\tSX = exp(-(vo*(BM.x+BB.x)+vn*(BM.y+BB.y)* cloud_dist));\n\n\t\t\tm += CB.z;\n\t\t\tcount += 1.0;\n\t\t\tD += SX*CB.x;\n\t\t\tE += (SX*CB.y)+z*m;\n\t\t}\n\t\telse return vec3(0.0);\n\t}\n\t//mask = m * 0.0125;\n\t//mask = m / count;\n\tmask = m / float( SAMPLE );\n\n\treturn ((D * vo * x ) + (E * vn * y * sunColor)) * 15.0;\n}\n\n\nvoid main()\n{\n\tvec3 light = normalize( lightdir );\n\tvec3 world = normalize( worldPosition.xyz );\n\n\tfloat uvy = acos( world.y ) / pi;\n\n\t//float luma = smoothstep(0.0, 4.0,  1.0-(abs(world.y)/0.8) );\n    //float mid = smoothstep(0.0, 1.0,  abs(world.y) < haze ? 1.0-(abs(world.y)/(haze*1.0)) : 0.0 );\n    //mid *= nightLuminosity;//pow(  mid, 1.0 );\n\n    // ground reapeat sky\n\t//if( world.y < -0.15) world.y = -0.15+((-world.y-0.15)*0.1);\n\tif( world.y < 0.0) world.y = -world.y;\n\n\tfloat high = smoothstep(1.0, 0.0, (uvy)*10000.0);\n\tfloat top =  smoothstep(1.0, 0.0, (uvy-0.5)*50.0);\n\tfloat middle = uvy > 0.5 ? high : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tfloat middle2 = uvy > 0.5 ? smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0)) : smoothstep(0.0, 1.0, (0.5-uvy)*((1.0-haze)*100.0));\n\n\tvec3 s = sunTop;\n\tfloat lm = dot( s, light );\n\tfloat day = clamp((lm*4.0), 0.0, (1.0-nightLuminosity) )+nightLuminosity;\n\n\tif(lm <= 0.0) light *= -1.0;\n\tlight.y = abs(light.y);\n\n\t//if(light.y < 0.1) light.y = 0.1;\n\tlight.y = clamp(light.y, 0.1, 1.0 );\n\t//light.y += 0.5;\n\n\tfloat mask = 0.0;\n\n\tvec3 sky = makeSky( light, s, world, mask );\n\tmask = clamp(mask, 0.0, 1.0 );\n\tsky = mix( sky, cloudColor, mask ); //apply cloud color\n\t\n\n\t//sky = mix( sky, groundColor, 1.0-middle ); // apply ground color\n\tsky = mix( sky, fogColor, 1.0-middle2 ); // apply fog color\n\t\n    //float dd = clamp(day+(nightLuminosity*0.5), 0.0, 1.0);\n\t//luma *= 1.0-dd;\n\t//clear = mix( clear, clear+skyColor, luma ); // extra luminosity on night\n\n\tsky *= day;\n\t//sky = czm_saturation(sky, saturation);\n    //sky = clamp(sky, 0.0, 1.0 );\n\n\n \tgl_FragColor = vec4( sky, 1.0 );\n\n}\n",depthWrite:!1,depthTest:!1,side:1,toneMapped:!1,fog:!1},Aa=Math.PI/180;class za{constructor(t={}){this.mainScene=t.scene,this.renderer=t.renderer,this.usePrem=void 0!==t.usePmrem&&t.usePmrem,this.useBackground=void 0===t.useBackground||t.useBackground,this.envBlur=void 0!==t.envBlur?t.envBlur:0,this.callback=t.callback||null,this.isSky=!1,this.usePrem&&(this.pmremGenerator=new Dt(this.renderer),this.pmremGenerator.compileEquirectangularShader()),t.cube&&this.initCubeEnv(t),t.url&&this.load(t.url)}initCubeEnv(t={}){this.isCubeEnv=!0,this._quality=t.quality||1,this.scene=new _t,t.color&&(this.scene.background=new x(t.color)),this.target=new Ct(256*this._quality,{minFilter:Lt,type:jt,colorSpace:y,anisotropy:1}),this.camera=new qt(t.near||.1,t.far||100,this.target),this.mainScene.environment=this.target.texture,this.useBackground&&(this.mainScene.background=this.target.texture)}addSky(){let t=new Ot(20,1);const e=new Bt(Sa);this.sky=new tt(t,e),this.scene.add(this.sky),this.render(),this.isSky=!0}getSkyOtion(){if(this.isSky)return Ma}setSkyOtion(t){if(!this.isSky)return;let e=this.sky.material.uniforms;for(let i in t)e[i]&&(e[i].value=t[i]);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.render.bind(this),0)}render(){if(!this.isCubeEnv)return;const t=this.renderer,e=t.toneMapping;t.toneMapping=It,this.camera.update(t,this.scene),t.toneMapping=e}load(t){switch(this.name=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")),this.type=t.substring(t.lastIndexOf(".")+1).toLowerCase(),this.loader=null,this.type){case"hdr":this.loader=(new ne).load(t,this.end.bind(this),null,this.bug.bind(this));break;case"exr":this.loader=(new le).load(t,this.end.bind(this),null,this.bug.bind(this))}}bug(){console.log("Envmap is not find :",this.name),this.callback&&this.callback()}end(){let t;switch(this.type){case"hdr":case"exr":t=this.loader,t.mapping=pt;break;case"jpg":t=this.loader.renderTarget.texture,t.mapping=pt}this.usePrem&&(t=this.pmremGenerator.fromEquirectangular(t).texture,this.pmremGenerator.dispose()),t.needsUpdate=!0;const e=this.isCubeEnv?this.scene:this.mainScene;(this.isCubeEnv||this.useBackground)&&(e.background=t),this.envBlur&&(e.backgroundBlurriness=this.envBlur),e.environment=t,this.loader.dispose(),this.callback&&this.callback()}get intensity(){return this.mainScene.environmentIntensity}set intensity(t){this.mainScene.environmentIntensity=t}get bgIntensity(){return this.mainScene.backgroundIntensity}set bgIntensity(t){this.mainScene.backgroundIntensity=t}get blur(){return this.mainScene.backgroundBlurriness}set blur(t){this.mainScene.backgroundBlurriness=t}rotate(t=0,e=0,i=0){0!==t&&(t*=Aa),0!==e&&(e*=Aa),0!==i&&(i*=Aa),this.mainScene.environmentRotation.set(t,e,i),this.mainScene.backgroundRotation.set(t,e,i)}}class Ea extends e{constructor(t=1,e=1,i=1,a=.01,r=1,o=1,c=1,p=2){super(),this.type="ChamferBox",r=Math.floor(r),o=Math.floor(o),c=Math.floor(c),p=Math.floor(p);let m=Math.PI,g=.5*m,f=2*a,y=.5*t,v=.5*e,x=.5*i,w=new l,k=new l,M=new l,S=a/t,A=1-2*S,z=a/e,E=1-2*S,P=a/i,R=1-2*P,T=new d(t-f,e-f,r,o),F=new h(a,a,t-f,p,r,!0,0,g),D=new h(a,a,e-f,p,o,!0,0,g),_=new Pa(a,p,p,0,g,0,-g),C=new Pa(a,p,p,0,g,0,-g);Ra(T,-S,z,A,E),Ra(F,0,S,z,A),k.makeTranslation(0,v-a,0),w.makeRotationX(g),_.applyMatrix4(k.multiply(w)),k.makeTranslation(0,-v+a,0),w.makeRotationX(g),M.makeRotationY(-g),C.applyMatrix4(k.multiply(w).multiply(M));let j=$t([D,_,C]),L=j.clone();k.makeTranslation(y-a,0,-a),j.applyMatrix4(k),k.makeTranslation(-y+a,0,-a),w.makeRotationZ(m),L.applyMatrix4(k.multiply(w));let q=F.clone();w.makeRotationZ(g),k.makeTranslation(0,v-a,-a),F.applyMatrix4(k.multiply(w)),k.makeTranslation(0,-v+a,-a),w.makeRotationZ(-g),q.applyMatrix4(k.multiply(w));let O=$t([F,q,T,j,L]),B=O.clone();k.makeTranslation(0,0,x),O.applyMatrix4(k),k.makeTranslation(0,0,-x),w.makeRotationY(m),B.applyMatrix4(k.multiply(w)),T=new d(i-f,e-f,c,o),F=new h(a,a,i-f,p,c,!0,0,g),q=F.clone(),Ra(T,-P,z,R,E),k.makeTranslation(0,-(v-a),-a,0),w.makeRotationZ(-g),F.applyMatrix4(k.multiply(w)),k.makeTranslation(0,v-a,-a,0),w.makeRotationZ(g),q.applyMatrix4(k.multiply(w));let I=$t([F,q,T]),G=I.clone();k.makeTranslation(-y,0,0),w.makeRotationY(-g),I.applyMatrix4(k.multiply(w)),k.makeTranslation(y,0,0),w.makeRotationY(g),G.applyMatrix4(k.multiply(w)),T=new d(t-f,i-f,r,c),Ra(T,-S,P,A,R);let N=T.clone();k.makeTranslation(0,v,0),w.makeRotationX(-g),T.applyMatrix4(k.multiply(w)),k.makeTranslation(0,-v,0),w.makeRotationX(g),N.applyMatrix4(k.multiply(w));let V=te($t([O,B,I,G,T,N]));!function(t,e="sphere",i,a=[0,0,0],r=[0,0,0,1],o){void 0===o&&(o=new l);if(o.compose({x:a[0],y:a[1],z:a[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===i){t.boundingBox||t.computeBoundingBox();let e=t.boundingBox;i=Math.max(e.max.x-e.min.x,e.max.y-e.min.y,e.max.z-e.min.z)}let h=new u(new n(-i/2,-i/2,-i/2),new n(i/2,i/2,i/2)),c=[];c.length=2*t.attributes.position.count,void 0===t.attributes.uv&&t.setAttribute("uv",new s(c,2));let d,p,m,g,f,y=function(t,e,i){t.applyMatrix4(o),e.applyMatrix4(o),i.applyMatrix4(o);let s=1/(2*Math.PI),a=1/Math.PI;return t.normalize(),e.normalize(),i.normalize(),{uv0:new b(.5-Math.atan(t.z,-t.x)*s,.5-Math.asin(t.y)*a),uv1:new b(.5-Math.atan(e.z,-e.x)*s,.5-Math.asin(e.y)*a),uv2:new b(.5-Math.atan(i.z,-i.x)*s,.5-Math.asin(i.y)*a)}},v=function(t,e,s){t.applyMatrix4(o),e.applyMatrix4(o),s.applyMatrix4(o);let a=new n;a.crossVectors(e.clone().sub(t),e.clone().sub(s)).normalize(),a.x<0||a.y<0||a.z,a.x=Math.abs(a.x),a.y=Math.abs(a.y),a.z=Math.abs(a.z);let r=new b,l=new b,c=new b,d=1/i;return a.y>a.x&&a.y>a.z?(r.set(t.x-h.min.x,h.max.z-t.z).multiplyScalar(d),l.set(e.x-h.min.x,h.max.z-e.z).multiplyScalar(d),c.set(s.x-h.min.x,h.max.z-s.z).multiplyScalar(d)):a.x>a.y&&a.x>a.z?(r.set(t.z-h.min.z,t.y-h.min.y).multiplyScalar(d),l.set(e.z-h.min.z,e.y-h.min.y).multiplyScalar(d),c.set(s.z-h.min.z,s.y-h.min.y).multiplyScalar(d)):a.z>a.y&&a.z>a.x&&(r.set(t.x-h.min.x,t.y-h.min.y).multiplyScalar(d),l.set(e.x-h.min.x,e.y-h.min.y).multiplyScalar(d),c.set(s.x-h.min.x,s.y-h.min.y).multiplyScalar(d)),{uv0:r,uv1:l,uv2:c}},x=new n,w=new n,k=new n;new n,new n,new n;const M=t.getAttribute("position");if(t.getAttribute("normal"),t.index)for(d=0;d<t.index.count;d+=3)p=t.index.getX(d+0),m=t.index.getX(d+1),g=t.index.getX(d+2),x.fromBufferAttribute(M,p),w.fromBufferAttribute(M,m),k.fromBufferAttribute(M,g),f="sphere"===e?y(x,w,k):v(x,w,k),c[2*p]=f.uv0.x,c[2*p+1]=f.uv0.y,c[2*m]=f.uv1.x,c[2*m+1]=f.uv1.y,c[2*g]=f.uv2.x,c[2*g+1]=f.uv2.y;else for(d=0;d<M.count;d+=3){x.fromBufferAttribute(M,d+0),w.fromBufferAttribute(M,d+1),k.fromBufferAttribute(M,d+2),f="sphere"===e?y(x,w,k):v(x,w,k);let t=d,i=d+1,s=d+2;c[2*t]=f.uv0.x,c[2*t+1]=f.uv0.y,c[2*i]=f.uv1.x,c[2*i+1]=f.uv1.y,c[2*s]=f.uv2.x,c[2*s+1]=f.uv2.y}t.attributes.uv.array=new Float32Array(c),t.attributes.uv.needsUpdate=!0}(V,"box"),this.copy(V)}}class Pa extends e{constructor(t=1,e=8,i=6,a=0,r=2*Math.PI,o=0,l=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:a,phiLength:r,thetaStart:o,thetaLength:l},e=Math.floor(e),i=Math.floor(i);const h=Math.min(o+l,Math.PI);let c=0;const d=[],p=new n,u=new n,m=[],b=[],g=[],f=[];for(let s=0;s<=i;s++){const n=[],m=s/i;let y=0;0==s&&0==o?y=.5/e:s==i&&h==Math.PI&&(y=-.5/e);for(let i=0;i<=e;i++){const s=i/e;p.x=-t*Math.cos(a+s*r)*Math.sin(o+m*l),p.y=t*Math.cos(o+m*l),p.z=t*Math.sin(a+s*r)*Math.sin(o+m*l),b.push(p.x,p.y,p.z),u.copy(p).normalize(),g.push(u.x,u.y,u.z),f.push(s+y,1-m),n.push(c++)}d.push(n)}for(let t=0;t<i;t++)for(let s=0;s<e;s++){const e=d[t][s+1],a=d[t][s],r=d[t+1][s],n=d[t+1][s+1];(0!==t||o>0)&&m.push(e,a,n),(t!==i-1||h<Math.PI)&&m.push(a,r,n)}this.setIndex(m),this.setAttribute("position",new s(b,3)),this.setAttribute("normal",new s(g,3)),this.setAttribute("uv",new s(f,2))}}function Ra(t,e=0,i=0,s=1,a=1,r){let o=t.attributes.uv,n=o.array,l=o.count,h=0;for(;l--;)h=2*l,n[h]=n[h]*s-e,n[h+1]=n[h+1]*a+i}const Ta=new u;class Fa extends t{constructor(t,s=16776960){const r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),o=new Float32Array(24);let n=new x(s),l=[],h=8;for(;h--;)l.push(n.r,n.g,n.b);const c=new Float32Array(l),d=new e;d.setIndex(new i(r,1)),d.setAttribute("position",new i(o,3)),d.setAttribute("color",new i(c,3)),super(d,new a({vertexColors:!0,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&Ta.setFromObject(this.object),Ta.isEmpty())return;const e=Ta.min,i=Ta.max,s=this.geometry.attributes.position,a=s.array;a[0]=i.x,a[1]=i.y,a[2]=i.z,a[3]=e.x,a[4]=i.y,a[5]=i.z,a[6]=e.x,a[7]=e.y,a[8]=i.z,a[9]=i.x,a[10]=e.y,a[11]=i.z,a[12]=i.x,a[13]=i.y,a[14]=e.z,a[15]=e.x,a[16]=i.y,a[17]=e.z,a[18]=e.x,a[19]=e.y,a[20]=e.z,a[21]=i.x,a[22]=e.y,a[23]=e.z,s.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(t){return this.object=t,this.update(),this}copy(t,e){return super.copy(t,e),this.object=t.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Da{constructor(t={},e){this.motor=e,this.isCompound=!0,this.remplace=t.remplace||!1,this.init(t)}init(t={}){const e=t.intern||!1;let i=t.size||[5,3,8],s=t.pos||[0,2,0],a=t.wall||.1;void 0!==t.size[3]&&(a=t.size[3]),a<=0&&(a=.01);let o=.5*a,n=2*a;t.face||(t.face={});let l={up:1,down:1,left:1,right:1,front:1,back:1,...t.face};delete t.face;const h=[];e?(1===l.up&&h.push({pos:[0,.5*i[1]+o,0],size:[i[0]+n,a,i[2]+n]}),1===l.down&&h.push({pos:[0,-o-.5*i[1],0],size:[i[0]+n,a,i[2]+n]}),1===l.left&&h.push({pos:[-o-.5*i[0],0,0],size:[a,i[1],i[2]]}),1===l.right&&h.push({pos:[.5*i[0]+o,0,0],size:[a,i[1],i[2]]}),1===l.back&&h.push({pos:[0,0,-o-.5*i[2]],size:[i[0]+n,i[1],a]}),1===l.front&&h.push({pos:[0,0,.5*i[2]+o],size:[i[0]+n,i[1],a]})):(1===l.up&&h.push({pos:[0,.5*i[1]-o,0],size:[i[0],a,i[2]]}),1===l.down&&h.push({pos:[0,o-.5*i[1],0],size:[i[0],a,i[2]]}),1===l.left&&h.push({pos:[o-.5*i[0],0,0],size:[a,i[1]-n,i[2]]}),1===l.right&&h.push({pos:[.5*i[0]-o,0,0],size:[a,i[1]-n,i[2]]}),1===l.back&&h.push({pos:[0,0,o-.5*i[2]],size:[i[0]-n,i[1]-n,a]}),1===l.front&&h.push({pos:[0,0,.5*i[2]-o],size:[i[0]-n,i[1]-n,a]}));const c=[];let d,p,u=h.length,m=0;for(;u--;)p=h[m],d=this.isCompound?p.pos:fe.addArray(s,p.pos),c.push({type:"box",size:p.size,pos:d,material:t.material}),m++;if(this.isCompound){let e=null;this.remplace&&(e=0===t.radius?new tt(new r(i[0],i[1],i[2])):new tt(new Ea(i[0],i[1],i[2],t.radius||o)),t.material&&"debug"===t.material&&(e=new Fa(e,t.color),t.material="line"),e.raycast=()=>{}),this.motor.add({...t,mesh:e,shapes:c,type:"compound",ray:!1})}else this.motor.add(c)}}const _a=Math.PI/180,Ca=[new n(1,0,0),new n(0,1,0),new n(0,0,1)],ja=new n,La=new n,qa=new n,Oa=new n,Ba=[],Ia=[],Ga=new n,Na=new n,Va=new n;new l;class Ua{constructor(t={},e){this.motor=e,this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=t.name||"car",this.mass=t.mass||1e3,this.size=t.size||[1.5,.7,3.8],this.pos=t.pos||[0,4,0],this.rot=t.rot||[0,0,0],this.friction=t.friction||.2,this.restitution=t.restitution||.3,this.massCenter=t.massCenter||[0,0,0],this.driveWheel=t.driveWheel||null;let i=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];t.shapeMesh&&(i=[{type:"convex",shape:t.shapeMesh.geometry,pos:t.shapePos||[0,0,0]}]),this.body=this.motor.add({type:"compound",shapes:i,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:t.bodyMesh||null,meshPos:t.meshPos||[0,-1.1,0],material:t.material,damping:[.05,.05],debug:!1}),this.body.inertia=new n(1.416666865348816,1.666666865348816,.416666716337204),this.vehicle=new Wa({chassis:this.body},this.motor);let s=t.wheelPosition||[.61,0,1.2];const a=[new n(-s[0],s[1],-s[2]),new n(s[0],s[1],-s[2]),new n(-s[0],s[1],s[2]),new n(s[0],s[1],s[2])],r={radius:t.wheelRadius||.31,directionLocal:new n(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new n(1,0,0),chassisConnectionPointLocal:new n(1,1,0)};let o,l,c;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),a.forEach((t=>{r.chassisConnectionPointLocal.copy(t),this.vehicle.addWheel(r)}));let d=this.motor.getMat("debug");if(t.wheelMesh?(l=t.wheelMesh,c=t.wheelMesh2?t.wheelMesh2:null,t.material&&(d=t.material||d,l.material=d,c&&(c.material=d))):(o=new h(r.radius,r.radius,t.wheelDepth||.2),o.rotateZ(.5*Math.PI),l=new tt(o,d),c=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[c||l.clone(),l,c?c.clone():l.clone(),l.clone()];let t=this.vehicle.wheelMeshes.length,e=0;for(;t--;)this.body.add(this.vehicle.wheelMeshes[e++])}else m.matrixAutoUpdate=!1,c&&(c.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[this.motor.add(c||m.clone()),this.motor.add(m),this.motor.add(c?c.clone():m.clone()),this.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let t=this.motor.getDelta();this.motor.getAzimut();let e=this.motor.getKey();this.tmp.forwardForce=e[1],this.tmp.steerDirection=-1*e[0],this.tmp.brakeForce=1===e[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let i=Math.abs(this.vehicle.currentVehicleSpeedKmHour);i=Math.min(i,this.maxSpeed),this.maxSpeed;const s=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(s,0),this.vehicle.applyEngineForce(s,1),this.vehicle.applyEngineForce(s,2),this.vehicle.applyEngineForce(s,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(t),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*_a)}addParametre(t,e){this.extra[t]=e,Object.defineProperty(this,t,{get:()=>this.extra[t],set:e=>{this.extra[t]=e,this.vehicle&&this.vehicle.setWheels(t,this.extra[t])}})}}class Wa{constructor(t,e){this.motor=e,this.chassisBody=t.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:0,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:2,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(t={}){let e=new Ja(t,this.motor),i=this.wheelInfos.length-1;e.chassisBody=this.chassisBody;let s=e.suspensionRestLength+e.radius;return e.ray=this.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+i,begin:e.chassisConnectionPointLocal.toArray(),end:[e.chassisConnectionPointLocal.x,-s,e.chassisConnectionPointLocal.z],callback:function(t){e.castRay(t)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(e),i}setWheels(t,e){let i,s=this.wheelInfos.length;for(;s--;)i=this.wheelInfos[s],i[t]&&(i[t]=e)}setSteeringValue(t,e){this.wheelInfos[e].steering=t}applyEngineForce(t,e){this.wheelInfos[e].engineForce=t}setBrake(t,e){this.wheelInfos[e].brake=t}getVehicleAxisWorld(t,e){return e.set(0===t?1:0,1===t?1:0,2===t?1:0),nr(e,tr(this.chassisBody,new l),e),e}updateVehicle(t){let e=this.wheelInfos,i=e.length,s=this.chassisBody,a=i;for(;a--;)this.updateWheelTransform(a);const r=$a(s,new n),o=lr(r,tr(s,new l).invert(),new n);this.currentVehicleSpeedKmHour=o.z;let h=new n;this.getVehicleAxisWorld(this.indexForwardAxis,h),h.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(t);let c=new n;for(new n,a=0;a<i;a++){let i=e[a],r=i.suspensionForce;r>i.maxSuspensionForce&&(r=i.maxSuspensionForce),c.copy(i.raycastResult.hitNormalWorld).multiplyScalar(r*t),ir(this.motor,s,c,i.raycastResult.hitPointWorld)}this.updateFriction(t);let d=new n,p=new n,u=new n;for(a=0;a<i;a++){let i=e[a];sr(s,i.chassisConnectionPointWorld,u);let r=1;if(1===this.indexUpAxis)r=-1;if(i.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,p);let e=rr(p,i.raycastResult.hitNormalWorld);d.copy(i.raycastResult.hitNormalWorld).multiplyScalar(e),p.sub(d);let s=rr(p,u);i.deltaRotation=r*s*t/i.radius}!i.sliding&&i.isInContact||0===i.engineForce||!i.useCustomSlidingRotationalSpeed||(i.deltaRotation=(i.engineForce>0?1:-1)*i.customSlidingRotationalSpeed*t),Math.abs(i.brake)>Math.abs(i.engineForce)&&(i.deltaRotation=0),i.rotation-=i.deltaRotation,i.deltaRotation*=.99}}updateSuspension(t){let e=this.chassisBody,i=Qa(e),s=this.wheelInfos,a=s.length;for(let t=0;t<a;t++){let e=s[t];if(e.isInContact){let t,s=e.suspensionRestLength-e.suspensionLength;t=e.suspensionStiffness*s*e.clippedInvContactDotSuspension;let a,r=e.suspensionRelativeVelocity;a=r<0?e.dampingCompression:e.dampingRelaxation,t-=a*r,e.suspensionForce=t*i,e.suspensionForce<0&&(e.suspensionForce=0)}else e.suspensionForce=0}}updateFriction(t){let e,i,s,a=Oa,r=this.wheelInfos,o=r.length,h=this.chassisBody,c=Ba,d=Ia;for(e=0;e<o;e++)if(i=r[e],s=i.raycastResult.body,i.sideImpulse=0,i.forwardImpulse=0,c[e]||(c[e]=new n),d[e]||(d[e]=new n),s){let t=d[e],r=this.getWheelTransformWorld(e);lr(Ca[this.indexRightAxis],r,t);let o=i.raycastResult.hitNormalWorld,n=rr(t,o);a.copy(o).multiplyScalar(n),t.sub(a).normalize(),or(o,t,c[e]),c[e].normalize(),i.sideImpulse=vr(h,i.raycastResult.hitPointWorld,s,i.raycastResult.hitPointWorld,t),i.sideImpulse*=1}for(this.sliding=!1,e=0;e<o;e++){i=r[e],s=i.raycastResult.body;let a=0;if(i.slipInfo=1,s){let r=0,o=i.brake?i.brake:r;a=cr(h,s,i.raycastResult.hitPointWorld,c[e],o),a+=i.engineForce*t;let n=o/a;i.slipInfo*=n}if(i.forwardImpulse=0,i.skidInfo=1,s){i.skidInfo=1;let e=i.suspensionForce*t*i.frictionSlip,s=e*e;i.forwardImpulse=a;let r=.5*i.forwardImpulse/i.forwardAcceleration,o=1*i.sideImpulse/i.sideAcceleration,n=r*r+o*o;if(i.sliding=!1,n>s){this.sliding=!0,i.sliding=!0;let t=e/Math.sqrt(n);i.skidInfo*=t}}}if(this.sliding)for(let t=0;t<o;t++)i=r[t],0!==i.sideImpulse&&i.skidInfo<1&&(i.forwardImpulse*=i.skidInfo,i.sideImpulse*=i.skidInfo);for(e=0;e<o;e++){i=r[e];let t=new n;if(t.copy(i.raycastResult.hitPointWorld).sub(Za(h,new n)),0!==i.forwardImpulse){let t=new n;t.copy(c[e]).multiplyScalar(i.forwardImpulse),ir(this.motor,h,t,i.raycastResult.hitPointWorld)}if(0!==i.sideImpulse){s=i.raycastResult.body,(new n).copy(i.raycastResult.hitPointWorld).sub(Za(s,new n));let a=new n;a.copy(d[e]).multiplyScalar(i.sideImpulse),lr(t,tr(h,new l).invert(),t),t["xyz"[this.indexUpAxis]]*=i.rollInfluence,lr(t,tr(h,new l),t),ir(this.motor,h,a,Za(h,new n).add(t)),a.multiplyScalar(-1),ir(this.motor,s,a,i.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(t){const e=this.chassisBody.matrixWorld;nr(t.chassisConnectionPointLocal,e,t.chassisConnectionPointWorld),lr(t.directionLocal,e,t.directionWorld)}updateWheelTransform(t){let e=Ga,i=Na,s=Va,a=this.wheelInfos[t];this.updateWheelTransformWorld(a),e.copy(a.directionLocal).multiplyScalar(-1),i.copy(a.axleLocal),or(e,i,s),s.normalize(),i.normalize();let r=a.steering,o=new $;hr(e,r,o);let n=new $;hr(i,a.rotation,n);let l=a.quaternion;er(this.chassisBody,l),l.multiply(o).multiply(n).normalize();let h=a.position;h.copy(a.directionWorld),h.multiplyScalar(a.suspensionLength);let c=h.clone();h.add(a.chassisConnectionPointWorld),a.matrix.compose(a.position,a.quaternion,{x:1,y:1,z:1}),this.localWheel?(c.add(a.chassisConnectionPointLocal),this.wheelMeshes[t].quaternion.copy(o).multiply(n).normalize(),this.wheelMeshes[t].position.copy(c),this.brakeMeshs&&(2!==t&&3!==t||this.brakeMeshs[t].quaternion.copy(o).normalize(),this.brakeMeshs[t].position.copy(c),this.brakeMeshs[t].updateMatrix())):(this.wheelMeshes[t].position.copy(a.position),this.wheelMeshes[t].quaternion.copy(a.quaternion),this.wheelMeshes[t].updateMatrix())}getWheelTransformWorld(t){return this.wheelInfos[t].matrix}}var Ha=new n,Ka=new n;class Ja{constructor(t,e){this.motor=e,t=((t,e)=>{for(var i in t=t||{},e)i in t||(t[i]=e[i]);return t})(t,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointLocal.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionLocal.clone(),this.axleLocal=t.axleLocal.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.forwardAcceleration=t.forwardAcceleration,this.sideAcceleration=t.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new Xa,this.position=(new n).copy(this.chassisConnectionPointLocal),this.quaternion=new $,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new l}castRay(t){if(t.hit){this.isInContact=!0;let i=t.distance;this.raycastResult.hitPointWorld.fromArray(t.point),this.raycastResult.hitNormalWorld.fromArray(t.normal),this.raycastResult.body=this.motor.byName(t.body),this.suspensionLength=i-this.radius;let s=this.suspensionRestLength-this.maxSuspensionTravel,a=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<s&&(this.suspensionLength=s),this.suspensionLength>a&&(this.suspensionLength=a,this.raycastResult.reset());let r=rr(this.raycastResult.hitNormalWorld,this.directionWorld);sr(this.chassisBody,this.raycastResult.hitPointWorld,Ha);var e=rr(this.raycastResult.hitNormalWorld,Ha);if(r>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/r;this.suspensionRelativeVelocity=e*t,this.clippedInvContactDotSuspension=t}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(t){let e=this.raycastResult;if(this.isInContact){let i=e.hitNormalWorld.dot(e.directionWorld);Ka.copy(e.hitPointWorld).sub(t.position),sr(t,Ka,Ha);let s=e.hitNormalWorld.dot(Ha);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let t=-1/i;this.suspensionRelativeVelocity=s*t,this.clippedInvContactDotSuspension=t}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.hitNormalWorld.copy(e.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}}class Xa{constructor(){this.body=null,this.hitPointWorld=new n,this.hitNormalWorld=new n,this.directionWorld=new n}reset(){this.body=null,this.hitPointWorld=new n,this.hitNormalWorld=new n,this.directionWorld=new n}}const Qa=t=>t.mass,Ya=t=>t.mass>0?1/t.mass:0,Za=(t,e)=>e.copy(t.position),$a=(t,e)=>e.copy(t.velocity),tr=(t,e)=>e.copy(t.matrixWorld),er=(t,e)=>e.copy(t.quaternion),ir=(t,e,i,s)=>{t.change({name:e.name,impulse:i.toArray(),impulseCenter:s.toArray()})},sr=(t,e,i)=>(i.copy(e).sub(t.position),i.crossVectors(t.angular,i),i.add(t.velocity),i),ar=(t,e)=>(t.inertia&&e.copy(t.inertia),lr(e,t.matrixWorld,e),e.x=e.x>0?1/e.x:0,e.y=e.y>0?1/e.y:0,e.z=e.z>0?1/e.z:0,e),rr=(t,e)=>t.x*e.x+t.y*e.y+t.z*e.z,or=(t,e,i)=>{const s=t.y*e.z-t.z*e.y,a=t.z*e.x-t.x*e.z,r=t.x*e.y-t.y*e.x;return i.set(s,a,r),i},nr=(t,e,i)=>{const s=t.x,a=t.y,r=t.z,o=e.elements,n=s*o[0]+a*o[4]+r*o[8]+o[12],l=s*o[1]+a*o[5]+r*o[9]+o[13],h=s*o[2]+a*o[6]+r*o[10]+o[14],c=1/(s*o[3]+a*o[7]+r*o[11]+o[15]);return i.x=n*c,i.y=l*c,i.z=h*c,i},lr=(t,e,i)=>{const s=t.x,a=t.y,r=t.z,o=e.elements;return i.x=s*o[0]+a*o[4]+r*o[8],i.y=s*o[1]+a*o[5]+r*o[9],i.z=s*o[2]+a*o[6]+r*o[10],i},hr=(t,e,i)=>{const s=Math.sin(e/2);return t.normalize(),i.w=Math.cos(e/2),i.x=t.x*s,i.y=t.y*s,i.z=t.z*s,i};function cr(t,e,i,s,a){var r=0,o=i,n=ja,l=La,h=qa;sr(t,o,n),sr(e,o,l),h.copy(n).sub(l);return a<(r=-rr(s,h)*(1/(br(t,i,s)+br(e,i,s))))&&(r=a),r<-a&&(r=-a),r}var dr=new n,pr=new n,ur=new n,mr=new n;function br(t,e,i){var s=dr,a=pr,r=ur,o=mr;return s.copy(e).sub(Za(t,new n)),or(s,i,a),o.copy(ar(t,new n)).multiply(a),or(o,s,r),Ya(t)+rr(i,r)}var gr=new n,fr=new n,yr=new n;function vr(t,e,i,s,a){if(a.lengthSq()>1.1)return 0;let r=gr,o=fr,n=yr;return sr(t,e,r),sr(i,s,o),n.copy(r).sub(o),-.1*rr(a,n)*(1/(Ya(t)+Ya(i)))}class xr{constructor(t={},e){this.MoveSpeed=50,this.MaxSpeed=15,this.Drag=.98,this.SteerAngle=20,this.Traction=10,this.MoveForce=new n(0,0,0),this.tt=new n(0,0,0),this.v1=new n(0,0,0),this.v2=new n(0,0,0),this.motor=e,this.debug=this.motor.addDebuger(),this._reponsivness=500,this._throttleAmt=25,this._thottle=0,this._roll=0,this._pitch=0,this._yaw=0,this.init(t)}init(){this.car=new tt(new r(2,1,3),new S({wireframe:!0})),this.car.position.y=.5,this.motor.add(this.car);let t=new Gt;this.car.add(t)}update(t){this.updateCar(t)}updateCar(t){const e=this.motor.getKey(),i=this.motor.getTransform(this.car);this.tt.copy(i.forward).multiplyScalar(this.MoveSpeed*-e[1]*t),this.MoveForce.add(this.tt),this.car.position.add(this.MoveForce.clone().multiplyScalar(t));let s=-e[0],a=this.MoveForce.length();i.up.multiplyScalar(s*a*this.SteerAngle*t),this.car.rotation.y+=i.up.y*this.motor.math.torad,this.MoveForce.multiplyScalar(this.Drag),this.MoveForce.clampLength(0,this.MaxSpeed),a=this.MoveForce.length(),this.v1.copy(this.MoveForce).normalize().multiplyScalar(3),this.v2.copy(i.forward).multiplyScalar(3),this.debug.DrawRay(i.position,this.v1,"white"),this.debug.DrawRay(i.position,this.v2,"blue"),this.debug.DrawRay(i.position,i.right,"red"),this.v1.copy(this.MoveForce).normalize().lerp(i.forward,this.Traction*t),this.MoveForce.copy(this.v1).multiplyScalar(a)}fixedUpdate(t){const e=this.motor.getTransform(this.body);e.position.copy(this.body.position),e.forward.copy(this.forward).applyQuaternion(this.body.quaternion),e.right.copy(this.right).applyQuaternion(this.body.quaternion),e.up.copy(this.up).applyQuaternion(this.body.quaternion),e.thottle.copy(e.up),this.motor.change({name:this.body.name,impulse:e.thottle.multiplyScalar(this._thottle).toArray()}),this.debug.DrawRay(e.position,e.thottle,"red"),this.debug.DrawRay(e.position,e.forward,"yellow"),this.debug.DrawRay(e.position,e.right,"cyan"),this.debug.DrawRay(e.position,e.up,"green")}handleInputs(t){const e=this.motor.getKey();this._roll=e[0],this._pitch=e[1],e[4]?this._thottle+=t*this._throttleAmt:e[5]&&(this._thottle-=t*this._throttleAmt),this._thottle=this.motor.math.clamp(this._thottle,0,100)}}class wr{constructor(t={},e){this.startPosition=t.pos||[0,0,0],this.model=t.model||null,this.debug=t.debug||!1,this.angle=0,this.speed=50,this.maxSpeed=20,this.drag=.98,this.steerAngle=5,this.traction=3,this.moveForce=new n(0,0,0),this.side=0,this.onAir=!1,this.tt=new n(0,0,0),this.v1=new n(0,0,0),this.v2=new n(0,0,0),this.floorNormal=new n(0,0,0),this.up=new n(0,1,0),this.decal=new n(0,-.5,0),this.tmpQ1=new $,this.tmpQ2=new $,this.tmpQ3=new $,this.motor=e,this.angleS=0,this.debug&&(this.debuger=this.motor.addDebuger()),this.phyMove=!0,this.init(t)}setDebug(t){t&&(this.debug=t),this.sphere.visible=this.debug,this.ray.visible=this.debug}init(){this.radius=1,this.decal.y=-.5,this.radius=1.7,this.decal.y=-1.2;const t=this.motor.math;this.sphere=this.motor.add({type:"sphere",name:"baser",mass:1,size:[this.radius],pos:t.addArray(this.startPosition,[0,this.radius,0]),friction:.5,material:"debug",getVelocity:!0,visible:this.debug,shadow:!1,ray:!1});let e=this.rayHit.bind(this);if(this.ray=this.motor.add({name:"raySphere",type:"ray",begin:[0,0,0],end:[0,-(this.radius+1),0],visible:this.debug,parent:this.sphere,noRotation:!0,callback:e}),this.model){for(let t in this.model)this.model[t].receiveShadow=!0,this.model[t].castShadow=!0;this.car=this.model.body,this.w=[this.model.wheel_0,this.model.wheel_1,this.model.wheel_2,this.model.wheel_3,this.model.d_wheel]}else this.car=new tt(new r(1,.4,2),new S({wireframe:!0})),this.addWheels();this.motor.add(this.car)}addWheels(){let t=new h(.3,.3,.3,16);t.rotateZ(Math.PI/2);let e,i=new S({wireframe:!0}),s=4,a=[.7,-.2,.7],r=[];for(;s--;)r[s]=new tt(t,i),e=[0===s||3===s?a[0]:-.7,a[1],s<2?a[2]:-.7],r[s].position.fromArray(e),this.car.add(r[s]);this.w=r}updateWheels(){this.motor.math;let t,e=4;this.tmpQ3.setFromAxisAngle({x:0,y:1,z:0},3*this.angleS);let i=this.sphere.velocity.length()*this.side,s={x:1,y:0,z:0};for(;e--;)t=this.w[e],e<2?t.quaternion.setFromAxisAngle(s,i).premultiply(this.tmpQ3):t.quaternion.setFromAxisAngle(s,i);this.w[4]&&(this.w[4].rotation.y=10*this.angleS)}rayHit(t){t.hit?this.floorNormal.fromArray(t.normal).normalize():this.floorNormal.set(0,0,0),this.onAir=!t.hit}update(t){const e=this.motor.getKey(),i=this.motor.math;this.phyMove&&this.car.position.copy(this.sphere.position).add(this.decal);const s=this.motor.getTransform(this.car);let a=-e[1]*this.speed*t;this.onAir&&(a=0),this.tt.copy(s.forward).multiplyScalar(a),this.moveForce.add(this.tt),this.phyMove||this.car.position.add(this.moveForce.clone().multiplyScalar(t)),this.tmpQ1.setFromUnitVectors(this.up,this.floorNormal),this.tmpQ2.slerp(this.tmpQ1,4*t);let r=this.moveForce.toArray();this.motor.change({name:this.sphere.name,linear:r,velocityOperation:"xz"}),this.chassis&&this.motor.change({name:this.chassis.name,quat:this.car.quaternion.toArray(),pos:this.car.position.toArray()});let o=-e[0],n=this.moveForce.length();this.angleS=o*this.steerAngle*i.torad,this.angle+=this.angleS*n*t,this.car.quaternion.setFromAxisAngle(this.up,this.angle).premultiply(this.tmpQ2),this.moveForce.multiplyScalar(this.drag),this.moveForce.clampLength(0,this.maxSpeed),n=this.moveForce.length(),this.v1.copy(this.moveForce).normalize().multiplyScalar(1),this.v2.copy(s.forward).multiplyScalar(1),this.debug&&(this.debuger.DrawRay(s.position,this.v1,"white"),this.debuger.DrawRay(s.position,this.v2,"blue")),this.v1.copy(this.moveForce).normalize().lerp(s.forward,this.traction*t),this.moveForce.copy(this.v1).multiplyScalar(n),this.side=this.moveForce.dot(s.forward)>0?-1:1,this.updateWheels()}}const kr=new l,Mr=new l;new n;let Sr=Nt.prototype;Sr.byName=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return this.bones[e];return null},Sr.getId=function(t){let e=this.bones.length;for(;e--;)if(this.bones[e].name===t)return e;return null},Sr.setExtraRotation=function(t,e,i,s){(t.isBone?t:this.byName(t))&&Vt.DEG2RAD},Sr.setScalling=function(t,e,i,s){let a=t.isBone?t:this.byName(t);a&&(a.scalling=new n(e,i,s))},Sr.resetScalling=function(t){this.pose(),this.scalled=!0;for(let t=0,e=this.bones.length;t<e;t++)this.bones[t].isPhysics=!1,this.bones[t].phyMtx=new l;t||this.applyScalling()},Sr.childScale=function(t,e){if(!this.scalled)return;t.scalling&&e.scale(t.scalling);let i,s=t.children.length,a=0;for(;s--;)i=t.children[a],a++,i.isBone,i.matrixWorld.multiplyMatrices(e,i.matrix)},Sr.applyScalling=function(t){let e,i,s,a=this.bones.length;for(i=0;i<a;i++)e=this.bones[i],s=e.parent||null,null!==s&&s.scalling&&"root"!==e.name&&(e.position.multiply(s.scalling),e.updateMatrixWorld(!0));this.calculateInverses()},Sr.update=function(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,s=this.boneTexture;let a,r=t.length,o=0;for(;r--;){a=t[o];const s=a?a.isPhysics?a.phyMtx:a.matrixWorld:Mr;this.childScale(a,s),kr.multiplyMatrices(s,e[o]),kr.toArray(i,16*o),o++}null!==s&&(s.needsUpdate=!0)};const Ar={getColor(t){let e=t.toString();e=e.substring(e.lastIndexOf(".")+1);let i,s=[255,255,255];switch(e){case"grass":s=[.223,.827,.325],i=[.741,.498,.258];break;case"dirt":s=[.741,.498,.258];break;case"leaves":s=[.152,.682,.376];break;case"sand":s=[.878,.819,.686];break;case"ice":s=[.65,.882,.96];break;case"stone":s=[.537,.64,.65];break;case"cobblestone":s=[.666,.647,.588];break;case"wood":s=[.603,.321,.152];break;case"snow":s=[.905,.976,1]}return i?[s[0],s[1],s[2],i[0],i[1],i[2]]:[s[0],s[1],s[2]]},fire:{type:"star",numParticles:20,position:[0,0,0],colors:[1,1,0,0,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,.5,0,0,0,0],lifeTime:2,timeRange:2,startSize:.3,endSize:.9,velocity:[0,.8,0],velocityRange:[.15,.15,.15],gravity:[0,-.2,0],spinSpeedRange:4},smoke:{position:[-2,-.2,0],colors:[0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],numParticles:20,lifeTime:2,timeRange:2,startSize:.5,endSize:2,velocity:[0,1.6,0],velocityRange:[.2,0,.2],gravity:[0,-.25,0],spinSpeedRange:4,blending:"normal"},addBlock:{type:"cube",numParticles:30,lifeTime:1.5,endTime:1.5,startTime:0,startSize:.25,endSize:.5,sizeRange:.25,spinSpeedRange:2,radius:.25,velocity:[1,0,1],velocityRange:[.25,0,.25],acceleration:[1,0,1],accelerationRange:[.25,0,.25],gravity:[0,.05,0],tween:"outQuad",blending:"normal",alphaTest:.1},removeBlock:{type:"cube",lifeTime:1.5,endTime:1.5,startTime:0,startSize:.5,sizeRange:.25,endSize:.1,spinSpeedRange:2,accelerationRange:[.5,.5,.5],gravity:[0,-.1,0],tween:"outQuad",blending:"normal",alphaTest:.1},explosion:{colors:[1,0,0,0,1,0,0,1,1,0,0,1,1,1,0,1,1,1,1,.5,1,1,1,0],type:"cloud",radius:.5,radiusRange:.5,numParticles:400,positionRange:[2,1,2],lifeTime:3,endTime:4,lifeTimeRange:1,startTime:0,startSize:.1,endSize:2,sizeRange:1,accelerationRange:[1,.3,1],acceleration:[.8,.8,.8],gravity:[0,-.5,0],spinSpeedRange:2,luma:!1},playerMove:{trail:!0,colors:[1,1,1,1,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:1e3,positionRange:[.2,0,.2],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.1,0]},vehicleMove:{trail:!0,colors:[.5,.5,.5,.25,.2,.2,.2,0],type:"round",blending:"normal",numParticles:4,maxParticles:2e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.25,velocityRange:[.6,0,.6],gravity:[0,.2,0]},vehicleTrack:{trail:!0,colors:[.2,.2,.2,.1,.2,.2,.2,0],type:"round2",blending:"normal",startSize:.3,endSize:.3,numParticles:4,maxParticles:2e3,position:[0,-.1,0],lifeTime:6,oriented:!0},underWater:{trail:!0,colors:[1,1,1,1,.5,.5,1,0],type:"bubble",blending:"normal",numParticles:1,maxParticles:1e3,positionRange:[.25,0,.25],lifeTime:1.5,startSize:.1,endSize:.5,sizeRange:.05,velocity:[0,1,0],velocityRange:[1,0,1],acceleration:[.2,0,.2],gravity:[0,1,0]},bazookaFire:{trail:!0,colors:[1,0,0,1,1,1,0,.5,1,1,1,0],type:"round",numParticles:2,maxParticles:600,positionRange:[.1,.1,.1],lifeTime:1.5,startSize:.5,endSize:1,sizeRange:.1,velocityRange:[.6,.6,.6],gravity:[0,.1,0],luma:!1}},zr=["pixel","basic","cube","cloud","round","round2","donut","bubble","smoke","circle","field","star","octo"];function Er(){this.parent=null,this.position=[0,0,0],this.rotation=[0,0,0],this.name="default",this.type="round",this.tween="linear",this.trail=!1,this.model="",this.numParticles=1,this.maxParticles=0,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.endTime=-1,this.lifeTimeRange=0,this.sizeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.pposition=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.gravity=[0,0,0],this.oriented=!1,this.orientation=[0,0,0,1],this.colors=[1,1,1,1],this.blending="additive",this.radius=0,this.radiusPosition=!1,this.axis="Y",this.radiusRange=0,this.tmpRotation=null,this.alphaTest=0,this.renderOrder=0,this.luma=!0,this.depthWrite=!1,this.transparent=!0}const Pr={torad:Math.PI/180,todeg:180/Math.PI,random:()=>Math.random(),rand:(t,e)=>t+Pr.random()*(e-t),randInt:(t,e)=>t+Math.floor(Pr.random()*(e-t+1)),plusMinus:t=>(Pr.random()-.5)*t*2,plusMinusVector:t=>{const e=[];let i=t.length;for(;i--;)e.push(Pr.plusMinus(t[i]));return e},toTexture:t=>{let e=new gt(t);return e.minFilter=Lt,e.magFilter=Lt,e.flipY=!1,e.colorSpace=y,e.needsUpdate=!0,e},createTextureFromFloats:(t,e,i,s)=>{let a=null;if(null==s){const s=new Uint8Array(i.length);let r;for(let t=0;t<i.length;t++)r=255*i[t],s[t]=r;return a=new Qt(s,t,e,Yt),a.minFilter=Lt,a.magFilter=Lt,a.needsUpdate=!0,a}return a=s,a}},Rr=function(t){let e;switch(t){case"linear":e="float tween( float k ) { return k; }";break;case"inQuad":e="float tween( float k ) { return k * k; }";break;case"outQuad":e="float tween( float k ) { return k * ( 2.0 - k ); }";break;case"inOutQuad":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k;\n            return - 0.5 * ( --k * ( k - 2.0 ) - 1.0 ); \n        }";break;case"inCubic":e="float tween( float k ) { return k * k * k; }";break;case"outCubic":e="float tween( float k ) { return --k * k * k + 1.0; }";break;case"inOutCubic":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k + 2.0 ); \n        }";break;case"inQuart":e="float tween( float k ) { return k * k * k * k; }";break;case"outQuart":e="float tween( float k ) { return 1.0 - ( --k * k * k * k ); }";break;case"inOutQuart":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return 0.5 * k * k * k * k;\n\t\t\treturn - 0.5 * ( ( k -= 2.0 ) * k * k * k - 2.0 ); \n        }";break;case"inQuint":e="float tween( float k ) { return k * k * k * k * k; }";break;case"outQuint":e="float tween( float k ) { return --k * k * k * k * k + 1.0; }";break;case"inOutQuint":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0 ) return 0.5 * k * k * k * k * k;\n\t\t\treturn 0.5 * ( ( k -= 2.0 ) * k * k * k * k + 2.0 );\n        }";break;case"inSine":e="#define PI_90 1.570796326794896\n        float tween( float k ) { float j = k * PI_90; return 1.0 - cos( j ); }";break;case"outSine":e="#define PI_90 1.570796326794896\n\t\tfloat tween( float k ) { float j = k * PI_90; return sin( j ); }";break;case"inOutSine":e="#define M_PI 3.14159265358979323846\n\t\tfloat tween( float k ) { \n\t\t\tfloat j = k * M_PI; return 0.5 * (1.0-cos(j));\n        }";break;case"inExpo":e="float tween( float k ) { return k == 0.0 ? 0.0 : pow( 1024.0, k - 1.0 ); }";break;case"outExpo":e="float tween( float k ) { return k == 1.0 ? 1.0 : 1.0 - pow( 2.0, - 10.0 * k ); }";break;case"inOutExpo":e="float tween( float k ) { \n\t\t\tif ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * pow( 1024.0, k - 1.0 );\n\t\t    return 0.5 * ( - pow( 2.0, - 10.0 * ( k - 1.0 ) ) + 2.0 );\n        }";break;case"inCirc":e="float tween( float k ) { return 1.0 - sqrt( 1.0 - k * k ); }";break;case"outCirc":e="float tween( float k ) { return sqrt( 1.0 - ( --k * k ) ); }";break;case"inOutCirc":e="float tween( float k ) { \n\t\t\tif ( ( k *= 2.0 ) < 1.0) return - 0.5 * ( sqrt( 1.0 - k * k ) - 1.0 );\n\t\t\treturn 0.5 * ( sqrt( 1.0 - ( k -= 2.0 ) * k ) + 1.0 ); \n        }";break;case"inElastic":e="#define TWO_PI 6.28318530717958647692\n        float tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return - ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t}";break;case"outElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1; \n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    return ( a * pow( 2.0, - 10.0 * k) * sin( ( k - s ) * TWO_PI / p ) + 1.0 );\n\t\t}";break;case"inOutElastic":e="#define TWO_PI 6.28318530717958647692\n\t\tfloat tween(float k) {\n\t\t    float s;\n\t\t    float a = 0.1;\n\t\t    float p = 0.4;\n\t\t    if ( k == 0.0 ) return 0.0;\n\t\t    if ( k == 1.0 ) return 1.0;\n\t\t    if ( a < 1.0 ) { a = 1.0; s = p * 0.25; }\n\t\t    else s = p * asin( 1.0 / a ) / TWO_PI;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return - 0.5 * ( a * pow( 2.0, 10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) );\n\t\t    return a * pow( 2.0, -10.0 * ( k -= 1.0 ) ) * sin( ( k - s ) * TWO_PI / p ) * 0.5 + 1.0;\n\t\t}";break;case"inBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return k * k * ( ( s + 1.0 ) * k - s );\n\t\t}";break;case"outBack":e="float tween(float k) {\n\t\t    float s = 1.70158;\n\t\t    return --k * k * ( ( s + 1.0 ) * k + s ) + 1.0;\n\t\t}";break;case"inOutBack":e="float tween(float k) {\n\t\t    float s = 1.70158 * 1.525;\n\t\t    if ( ( k *= 2.0 ) < 1.0 ) return 0.5 * ( k * k * ( ( s + 1.0 ) * k - s ) );\n\t\t    return 0.5 * ( ( k -= 2.0 ) * k * ( ( s + 1.0 ) * k + s ) + 2.0 );\n\t\t}";break;case"inBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat tween(float k) { return 1.0 - outBounce( 1.0 - k ); }";break;case"outBounce":e="float tween(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}";break;case"inOutBounce":e="float outBounce(float k) {\n\t\t    if ( k < ( 1.0 / 2.75 ) ) return 7.5625 * k * k;\n\t\t    else if ( k < ( 2.0 / 2.75 ) ) return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n\t\t    else if ( k < ( 2.5 / 2.75 ) ) return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n\t\t    else return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n\t\t}\n\t\tfloat inBounce(float k) { return 1.0 - outBounce( 1.0 - k ); }\n\t\tfloat tween(float k) {\n\t\t    if ( k < 0.5 ) return inBounce( k * 2.0 ) * 0.5;\n\t\t    return outBounce( k * 2.0 - 1.0 ) * 0.5 + 0.5;\n\t\t}"}return e},Tr=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]],Fr=new Float32Array(28);class Dr extends Ut{constructor(t,e){super(),this.pe=t,this.count=0,this.color=null,this.texture=null,this.localTime=0,this.time=0,this.endTime=-1,this.num=0,this.matrixAutoUpdate=!1,this.frustumCulled=e.frustum||!1,this.receiveShadow=!1,this.castShadow=!1,this.birthIndex=0,this.luma=!0,e&&this.setParameters(e)}setParameters(t){this.validateParameters(t),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.name=t.name,this.isTrail=t.trail||!1,this.parameters=t;const e=this.isTrail?t.maxParticles:t.numParticles;this.allocateParticles_(e,t),this.isTrail||this.createParticles_(0,e,t),t.parent?t.parent.add(this):this.pe.scene?this.pe.scene.add(this):this.pe.add(this)}makeGeometry(t){this.geometry=t.oriented?new Wt:new e,this.isMesh=t.oriented}setColorRamp(t){const e=t.length/4;if(e%1!=0)throw"colorRamp must have multiple of 4 entries";this.color=Pr.createTextureFromFloats(e,1,t)}validateParameters(t){var e=new Er;for(let i in t)if(void 0===e[i])throw'unknown particle parameter "'+i+'"';for(let i in e)void 0===t[i]&&(t[i]=e[i])}perParticle(t,e){}birthParticles(t,e){var i=this.parameters.numParticles;this.parameters.pposition=t,this.parameters.startTime=this.time,this.endTime=this.time+this.parameters.lifeTime,e&&this.setColorRamp(e),this.createParticles_(this.birthIndex,i,this.parameters),this.birthIndex+=i,this.birthIndex+i>=this.parameters.maxParticles&&(this.birthIndex=0)}createParticles_(t,e,i){const s=Pr.plusMinus,a=Pr.plusMinusVector,r=this.interleavedBuffer.array;let o,l=e;for(;l--;){this.perParticle(l,i);let h=i.lifeTime+s(i.lifeTimeRange),c=null===i.startTime?l*i.lifeTime/e:i.startTime,d=i.frameStart+s(i.frameStartRange),p=(new n).addVectors((new n).fromArray(i.pposition),(new n).fromArray(a(i.positionRange))),u=(new n).addVectors((new n).fromArray(i.velocity),(new n).fromArray(a(i.velocityRange))),m=(new n).addVectors((new n).fromArray(i.acceleration),(new n).fromArray(a(i.accelerationRange))),b=(new xt).addVectors((new xt).fromArray(i.colorMult),(new xt).fromArray(a(i.colorMultRange))),g=i.spinStart+s(i.spinStartRange),f=i.spinSpeed+s(i.spinSpeedRange),y=i.startSize+s(i.sizeRange||i.startSizeRange),v=i.endSize+s(i.sizeRange||i.endSizeRange),x=(new xt).fromArray(i.orientation);if(i.positionRange[0],i.positionRange[1],i.positionRange[2],i.radius){let t=i.axis||"Y",e=Pr.rand(0,2*Math.PI);i.tmpRotation=[90,-e*Pr.todeg,90,"YXZ"];let a=i.radius+s(i.radiusRange),r=Math.cos(e),o=Math.sin(e),l=new n;switch(t){case"X":l.y=r,l.z=o;break;case"Y":l.x=r,l.z=o;break;case"Z":l.x=r,l.y=o}switch(l.multiplyScalar(a),i.radiusPosition&&p.add(l),t){case"X":l.x=1;break;case"Y":l.y=1;break;case"Z":l.z=1}m.multiply(l),u.multiply(l)}i.tmpRotation&&(x=(new $).setFromEuler(new nt(i.tmpRotation[0]*Pr.torad,i.tmpRotation[1]*Pr.torad,i.tmpRotation[2]*Pr.torad,i.tmpRotation[3]))),o=0+28*l*4+28*t*4,r[0+o]=p.x,r[0+o+1]=p.y,r[0+o+2]=p.z,r[0+o+3]=c,r[4+o]=Tr[0][0],r[4+o+1]=Tr[0][1],r[4+o+2]=h,r[4+o+3]=d,r[8+o]=u.x,r[8+o+1]=u.y,r[8+o+2]=u.z,r[8+o+3]=y,r[12+o]=m.x,r[12+o+1]=m.y,r[12+o+2]=m.z,r[12+o+3]=v,r[16+o]=g,r[16+o+1]=f,r[16+o+2]=0,r[16+o+3]=0,r[20+o]=x.x,r[20+o+1]=x.y,r[20+o+2]=x.z,r[20+o+3]=x.w,r[24+o]=b.x,r[24+o+1]=b.y,r[24+o+2]=b.z,r[24+o+3]=b.w}this.interleavedBuffer.needsUpdate=!0,this.material.uniforms.worldVelocity.value.fromArray(i.worldVelocity),this.material.uniforms.gravity.value.fromArray(i.gravity),this.material.uniforms.timeRange.value=i.timeRange,this.material.uniforms.frameDuration.value=i.frameDuration,this.material.uniforms.numFrames.value=i.numFrames,this.material.uniforms.rampSampler.value=this.color,this.material.uniforms.colorSampler.value=this.texture,this.material.blending="normal"===i.blending?X:J,this.updateMatrix()}allocateParticles_(t,e){if(this.count!==t){if(e.oriented||(e.oriented=!1),e.position&&this.position.fromArray(e.position),e.rotation&&this.quaternion.setFromEuler(new nt(e.rotation[0]*Pr.torad,e.rotation[1]*Pr.torad,e.rotation[2]*Pr.torad)),this.setColorRamp(e.colors),this.pe.textures.has(e.type)||-1!==zr.indexOf(e.type)&&this.pe.textures.make(e.type),this.texture=this.pe.textures.get(e.type),this.texture||console.log("this texture is undefined !!"),this.endTime=e.endTime||-1,this.luma=e.luma,this.makeGeometry(e),this.count=t,e.oriented){var s=new Ht(new Float32Array([0,0,0,0,-.5,-.5,0,0,0,0,0,0,.5,-.5,0,0,0,0,0,0,.5,.5,0,0,0,0,0,0,-.5,.5,0,0]),8);this.geometry.setAttribute("position",new Kt(s,3,0)),this.geometry.setAttribute("uv",new Kt(s,2,4)),this.geometry.setIndex(new i(new Uint16Array([0,1,2,0,2,3]),1)),this.interleavedBuffer=new Jt(new Float32Array(t*Fr.byteLength),28,1).setUsage(Xt)}else this.interleavedBuffer=new Ht(new Float32Array(t*Fr.byteLength),28).setUsage(Xt);this.geometry.setAttribute("position",new Kt(this.interleavedBuffer,3,0)),this.geometry.setAttribute("startTime",new Kt(this.interleavedBuffer,1,3)),this.geometry.setAttribute("uvLifeTimeFrameStart",new Kt(this.interleavedBuffer,4,4)),this.geometry.setAttribute("velocityStartSize",new Kt(this.interleavedBuffer,4,8)),this.geometry.setAttribute("accelerationEndSize",new Kt(this.interleavedBuffer,4,12)),this.geometry.setAttribute("spinStartSpinSpeed",new Kt(this.interleavedBuffer,4,16)),this.geometry.setAttribute("orientation",new Kt(this.interleavedBuffer,4,20)),this.geometry.setAttribute("colorMult",new Kt(this.interleavedBuffer,4,24)),this.geometry.boundingSphere=new Ft,this.geometry.boundingSphere.radius=3;let r=J;switch(e.blending){case"sub":case"subtractive":r=K;break;case"multi":case"multiply":r=H;break;case"normal":r=X;break;default:r=J}var a={worldVelocity:{value:new n},gravity:{value:new n},timeRange:{value:0},time:{value:0},timeOffset:{value:0},frameDuration:{value:0},numFrames:{value:0},rampSampler:{value:null},colorSampler:{value:null},scale:{value:.5*window.innerHeight},luma:{value:this.luma?this.pe.luminosity:1},alphaTest:{value:e.alphaTest}};this.material=new Bt({defines:{USE_ORIENTATION:e.oriented},uniforms:a,vertexShader:Rr(e.tween||"linear")+"\nprecision mediump float;\nprecision mediump int;\n\n#ifdef USE_ORIENTATION\n\t//uniform mat4 worldViewProjection;\n\t//uniform mat4 world;\n\tattribute vec3 offset;\n\tattribute vec4 orientation;\n#else\n    uniform float scale;\n#endif\n\nuniform vec3 worldVelocity;\nuniform vec3 gravity;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart;\nattribute float startTime;\nattribute vec4 velocityStartSize;\nattribute vec4 accelerationEndSize;\nattribute vec4 spinStartSpinSpeed;\nattribute vec4 colorMult;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n//#include <clipping_planes_pars_vertex>\n\nvec3 lerp( vec3 a, vec3 b, float p ){ return a + (b - a) * p; }\n\nvoid main() \n{\n    float lifeTime = uvLifeTimeFrameStart.z;\n    float frameStart = uvLifeTimeFrameStart.w;\n    float startSize = velocityStartSize.w;\n\n    //vec3 velocity = (modelMatrix * vec4(velocityStartSize.xyz, 0.0)).xyz + worldVelocity;\n\t//vec3 acceleration = (modelMatrix * vec4(accelerationEndSize.xyz, 0.0)).xyz + gravity;\n\n    //vec3 velocity = velocityStartSize.xyz + worldVelocity;\n\t//vec3 acceleration = accelerationEndSize.xyz + gravity;\n\n\tvec3 velocity = velocityStartSize.xyz + (inverse(modelMatrix) * vec4(worldVelocity, 0.0)).xyz;\n\tvec3 acceleration = accelerationEndSize.xyz + (inverse(modelMatrix) * vec4(gravity, 0.0)).xyz;\n\n    float endSize = accelerationEndSize.w;\n    float spinStart = spinStartSpinSpeed.x;\n    float spinSpeed = spinStartSpinSpeed.y;\n\n    float localTime = mod((time - timeOffset - startTime), timeRange);\n    //localTime = tween( localTime );\n    float percentLife = localTime / lifeTime;\n    percentLife = tween( percentLife );\n\n    vec3 posEnd = velocity * lifeTime + acceleration * lifeTime * lifeTime;\n\n    float frame = mod(floor(localTime / frameDuration + frameStart), numFrames);\n    float uOffset = frame / numFrames;\n    float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n    outputTexcoord = vec2(u, uv.y + 0.5);\n    outputColorMult = colorMult;\n\n    float size = mix(startSize, endSize, percentLife);\n\tsize = (percentLife < 0. || percentLife > 1.0) ? 0.0 : size;\n\n\tfloat s = sin(spinStart + spinSpeed * localTime);\n\tfloat c = cos(spinStart + spinSpeed * localTime);\n\n    #ifdef USE_ORIENTATION\n\t\t\n\t\tvec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0., (uv.x * s - uv.y * c) * size, 1.);\n\t\t//vec3 center = velocity * localTime + acceleration * localTime * localTime + position + offset;\n\t\tvec3 center = (posEnd * percentLife) + position + offset;\n\n\t\tvec4 q2 = orientation + orientation;\n\t\tvec4 qx = orientation.xxxw * q2.xyzx;\n\t\tvec4 qy = orientation.xyyw * q2.xyzy;\n\t\tvec4 qz = orientation.xxzw * q2.xxzz;\n\n\t\tmat4 localMatrix = mat4(\n\t\t    (1.0 - qy.y) - qz.z,  qx.y + qz.w,  qx.z - qy.w, 0,\n\t\t    qx.y - qz.w, (1.0 - qx.x) - qz.z, qy.z + qx.w, 0,\n\t\t    qx.z + qy.w, qy.z - qx.w, (1.0 - qx.x) - qy.y, 0,\n\t\t    center.x, center.y, center.z, 1\n\t\t);\n\t\trotatedPoint = localMatrix * rotatedPoint;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n\n\t#else\n\n\t    //vec3 pos = position + velocity * localTime + acceleration * localTime * localTime;\n\n\t    vec3 pos = (posEnd * percentLife) + position;\n\t    \n\t    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );\n        //gl_PointSize = size * 1.5 * ( scale / length( mvPosition.xyz ) );\n        gl_PointSize = size * 1.5 * ( scale / - mvPosition.z );\n\n        mat2 r = mat2( c, -s, s, c);\n        r *= 0.5; r += 0.5;  r = r * 2.0 - 1.0;\n        rotationMtx = r;\n\n        gl_Position = projectionMatrix * mvPosition;\n\n\t#endif\n\n\toutputPercentLife = percentLife;\n\n\t#include <logdepthbuf_vertex>\n\t//#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",fragmentShader:"\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\nuniform float luma;\nuniform float alphaTest;\n\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\nvarying mat2 rotationMtx;\n\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n//#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t//#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\n\tvec4 diffuseColor = texture2D( rampSampler, vec2(outputPercentLife, 0.5) ) * outputColorMult;\n\n    vec2 uv = vec2(0.0);\n    #ifdef USE_ORIENTATION\n        uv = outputTexcoord;\n\t#else\n\t    uv = gl_PointCoord;\n\t    uv -= 0.5; uv = uv * rotationMtx; uv += 0.5;\n\t#endif\n\n\t// texture\n\tdiffuseColor *= texture2D( colorSampler, uv );\n\n\tif ( diffuseColor.a < alphaTest ) discard;\n\n\tdiffuseColor.rgb *= luma;\n\n\tgl_FragColor = diffuseColor; \n\t#include <fog_fragment>\n\n}\n",side:e.oriented?E:R,blending:r,depthTest:!0,depthWrite:e.depthWrite,transparent:e.transparent,forceSinglePass:e.single||!1,fog:e.fog||!1}),this.renderOrder=e.renderOrder||0}}draw(t=0){if(!this.material.uniforms)return;const e=this.material.uniforms;this.time+=this.pe.delta,e.time.value=this.time,e.timeOffset.value=t,e.scale.value=this.pe.hscale,e.luma.value=this.luma?this.pe.luminosity:1,-1!==this.endTime&&this.time>=this.endTime&&this.pe.remove(this.name)}dispose(){this.parent.remove(this),this.geometry.dispose(),this.material.dispose(),this.color.dispose()}raycast(){}clone(t){return void 0===t&&(t=this.pe.createEmitter(this.texture)),t.time=0,t.endTime=this.endTime,t.geometry=this.geometry,t.material=this.material.clone(),t.material.uniforms.rampSampler.value=this.color,t.material.uniforms.colorSampler.value=this.texture,super.copy(t),this.num++,t.name=this.name+this.num,t}}class _r extends Map{constructor(){super()}dispose(){this.forEach((t=>{t.dispose()})),this.clear()}add(t,e){this.has(t)||this.set(t,e)}make(t){if(!this.has(t)){let e=this["make"+t[0].toUpperCase()+t.substring(1)]();this.set(t,e)}}makePixel(){const t=[];for(let e=0;e<2;++e)for(let e=0;e<2;++e)t.push(1,1,1,1);return Pr.createTextureFromFloats(2,2,t)}makeBasic(){const t=[0,.2,.7,1,.7,.2,0,0],e=[];for(let i=0;i<8;++i)for(let s=0;s<8;++s){let a=t[s]*t[i];e.push(a,a,a,1)}return Pr.createTextureFromFloats(8,8,e)}makeCube(){let t=document.createElement("canvas");t.width=t.height=8;const e=t.getContext("2d");return e.fillStyle="rgba(255,255,255,1.0)",e.fillRect(2,2,4,4),Pr.toTexture(t)}makeCloud(){let t=16,e=document.createElement("canvas");e.width=e.height=t;const i=e.getContext("2d");let s="rgba(255,255,255,1)",a="rgba(255,255,255,0)",r=i.createRadialGradient(8,6.4,0,8,6.4,6.4);return r.addColorStop(.3,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),r=i.createRadialGradient(6.4,9.92,0,6.4,9.92,5.6),r.addColorStop(.3,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),r=i.createRadialGradient(4.32,6.4,0,4.32,6.4,4.16),r.addColorStop(.2,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),r=i.createRadialGradient(12.16,9.6,0,12.16,9.6,3.68),r.addColorStop(.2,s),r.addColorStop(1,a),i.fillStyle=r,i.fillRect(0,0,t,t),Pr.toTexture(e)}makeRound(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.3,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),Pr.toTexture(t)}makeRound2(){let t=document.createElement("canvas");t.width=t.height=16;const e=t.getContext("2d"),i=e.createRadialGradient(8,8,0,8,8,8);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,16,16),Pr.toTexture(t)}makeDonut(){let t=document.createElement("canvas");t.width=t.height=32;const e=t.getContext("2d"),i=e.createRadialGradient(16,16,0,16,16,16);return i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.9,"rgba(255,255,255,0.1)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.beginPath(),e.arc(16,16,16,0,2*Math.PI,!1),e.arc(16,16,8,0,2*Math.PI,!0),e.fill(),Pr.toTexture(t)}makeBubble(){let t=document.createElement("canvas");t.width=t.height=64;let e="rgba(0,255,255,0)";const i=t.getContext("2d"),s=i.createRadialGradient(25.6,25.6,0,32,32,32);return s.addColorStop(.4,e),s.addColorStop(.9,"rgba(0,255,255,0.6)"),s.addColorStop(.99,"rgba(0,255,255,1)"),s.addColorStop(1,e),i.fillStyle=s,i.fillRect(0,0,64,64),i.fillStyle="rgba(255,255,255,1)",i.beginPath(),i.arc(44.8,25.6,8.96,0,2*Math.PI,!1),i.fill(),i.beginPath(),i.arc(12.8,41.6,3.2,0,2*Math.PI,!1),i.fill(),Pr.toTexture(t)}makeSmoke(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");let i=new Image;i.src=Cr;let s=Pr.toTexture(t);return i.onload=function(){e.drawImage(i,0,0),s.needsUpdate=!0},s}makeCircle(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d");return e.strokeStyle="white",e.lineWidth=4,e.beginPath(),e.arc(32,32,30,0,2*Math.PI),e.stroke(),Pr.toTexture(t)}makeField(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,0,64);return i.addColorStop(0,"rgba(255,255,255,0)"),i.addColorStop(.8,"rgba(255,255,255,0.4)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(24,0,16,64),Pr.toTexture(t)}makeStar(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255,255,255,0.5)"),i.addColorStop(.5,"rgba(255,255,255,0.1)"),i.addColorStop(.9,"rgba(255,255,255,0)"),e.fillStyle=i,this.star(e,32,6.4,32,32,3),this.star(e,32,25.6,32,32,3),Pr.toTexture(t)}makeOcto(){let t=document.createElement("canvas");t.width=t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(.4,"rgba(255,255,255,0.2)"),i.addColorStop(1,"rgba(255,255,255,0.4)"),e.fillStyle=i,this.star(e,25.6,22.4,32,32,6),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=6,e.stroke(),Pr.toTexture(t)}star(t,e,i,s,a,r){let o,n,l;t.beginPath(),t.moveTo(s+e,a);for(var h=1;h<=2*r;h++)h%2==0?(l=h*(2*Math.PI)/(2*r),o=s+e*Math.cos(l),n=a+e*Math.sin(l)):(l=h*(2*Math.PI)/(2*r),o=s+i*Math.cos(l),n=a+i*Math.sin(l)),t.lineTo(o,n);t.closePath(),t.fill()}}const Cr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAPOklEQVR42rWb224dRRaGq\n7r30Tu2Y5MhmYsZRZqbeahBiCvgPnCBOCeAEEjcI/E2vAfiYqJJgIHE2/Y+Vk2tzf9Ji2XZDsmkpeXu3V1dXf9f61Sr2316wa3Wmj/++GO\nTrkkvSTo3aDKUdB999JHJoMlEYud72tk13ce53kmmX5PWNr///vvpgw8+yPfv30+llPzee+917Xd68ODBM4+/f1HwbYd04XhgouNqx3re0\nF3rc85DtUntmK6zk7G11XHh0fZns9nk1WqVjYR23J2ennZtn7788sv6UgkA/Hq97mzwbevbbwMzEMBJGPj290HnDrC2qe3IzrV7N2oXSR2\nZ2PN4dNbW972JjSOfnJx0o9EoDwaD+sUXX7w8Ah4+fJgbw7nWCphRztnkDzMr0Wwx8ISWVNvTXrNv14xI7u+4LmLpE82xbcd+A50nk0kdj\n8fJCHnzzTfTN998U18KAW+88UY+OjoypjsNdtTGMLQJYXYBDUjTjqC+nYD1XtVbu7Ht23lIsfPW936TiZ0HOP3YRLTNNKG2LW2aVp6dnqZ\n/vfZa/fbbb//vBJiDMcbtgTv71aDs2IMvkl4AbKDJ9tZW94w0k0nmcsOO7bp+j0TErO1nOgeRmIqZQ3UkNlOYp58eP0qL5bJ+99139YUJ+\nP77702l8ttvv51ff/31bjab5f39/a7h3wFv7GP7nfMPqC8qW5htAd8ToKTr+9pXAZ+atH72pCkFMtVmg48Ag55Rt9tt3pRSbx4epPv3H+T\nPP/+8mrP89NNPn48AA95sKw+Hw7xcLvPh4WG3t7eXmhb0+AER4L3/UOKdYFbbPQOs6xknh1MUMfQ71bkiDaO/KvFRZrsD1Hf1xmy2PTy8m\nc0pWli07cMPP4SEP0fAu+++m9ssAz5Pp1MzAXuone+c+mcAAEr9V+0xh5ns3druOe0ZVbv++zERoUdbpOreufZ6Bu1LbVsjoLTxFXtuKaV\nmF1v/NAE//PCDObtk4J8+fZru3LnTNfXPTc0MuBExMBNgxph5+YbeacN0Z+8pT2qqaIYBu6H7JtYmy/tLcJY7LfBaBpkci6zN76aSa3DC6\nbkJuHfvns18Oj8/z/P5PN29e7c3AizWNsmEJ0DrgcwMmnBDx5yHgJGAkzNwL2qfaEN/zvvzLHwBJlDYk1hJc5KN+Zl9wOPHj/Nbb72VF4t\nFMqfSJN26das7Pj7uBDzLAe5mzhwbaqvBzQAmQBBVNPO3mhziH3R96tp2uncm4N6nmPbZPWvA4hjdcRZwSLDUOX3yySfPRsBXX31l6tKSi\n3GaTmfN9g924Jsz9NmeATcbTnr4K03+0eS2AwEJaEMS+L/p2mmTousHTY5s77z/EBIEHFNgNrdEADcBbBXnye9nIoDts88+a1502Lz/yLx\n+3zIt4rl1aLO/51TxZpN/Nvm7wJ+LfYvtM9vL8++3xsf2WwNeYCYCuqd8YExYM6J1viOlJqSi8oRT38Y0BALIqdCCawkwtd85+G4X5bu+R\nX2lqR2q6LzrRMDvaqbO9PChG3wvMzlq+4NUKzNETnCg/ZA0mO51Du1Z2vBEAODxA7TBNOgju8VWtRUlJFxKQGtkM52hAG+q2TQQE2K+4vq\nrTf5CMqP9mFlxWeG+zW7F4THrzjG6sBjziixwC5PWbi3wtIWMVZOiBZT1h6ZU7a8mwICLva4dDGgjsH9tcstASI2P5KTMBI6lytPWybQaM\nFskaXZqO6e21nfVnri+lmrPlBsAyGSsxVYncGcysRVpsPcBkmrgyTad06xXEQD4rIXHrB0NmzCbNpA7Lvk4tt8Cf2gDx4sbcFP1LIIEaso\nCiDiv2L0SiIna9HZeA06ocq311EzA5RhbgTtX25Eky/aL4WlixxtpzPZSAnTB1H/MzMrmqmb9WECxa0LdDQjQAAa0IaZr1WbgR5yzKZKNk\nvtjCpgb8R1Vt/b4lTFaAilyxGM0Aa2wRZj8BqZxrQbsCViV0Pmr2ncCfSwSpiQ72DGgdT+eewx4BxBCmHnsH8FubdYP3RpiWWs9MVDSwCM\nIwDnqEUVttiKhxHDYB/CEExzPvpzbEbMPYInXhJ4Bh7oAMvAAQ2aIWbB1FD1Ybvt1hsBh0zM3tuzMp9CuyVIkFJMLBAC+2kSlDAl7YvUVN\n8PTkOWh5iP6Ql19Dc9XiaKHD+cK99LepcUrSYdPCmk096+UYJ0T1Ru+FVHjAgEsFSlJ5STV1AMkexJ+Q8bEgc8BTGJgYZZzJILjIPSJhi7\nl+akTohFDgV4TCgV+ASHyE7oeCCilsKQdNfDYsLdjzmGnFD1nzM4ldT7AebBe2OL5DgE7lR9MwfVXQypcHQlryZmZAATJB3Bf2tXbvXfFk\nzuwPmxBCFrRexAcR3XHriPweG/Yxy0z44B3oFJIhM4VwRYco/4mfyCg5ceoPwMO+zBoPDkq6BxbsN84o33s6wrANYIPYwF8hQyBXDkS5k1\nOjASIwkmTDnsC6DiWtHyUsGMywL1QAq9h9qNtR9WOYCIZRJN4Lap4If/HSZIuC/wTaQAEEA53aYiREDVggODdA7CZZXgu6ekYBGEngI4zG\nDeARo2IfiX5NNcdF8BpjwN8auC1xxkWHwW8BpD7Q0DvvHzPAJWCjmuq45zyGPWP6oq6M2gGGK6zlUsIyvE8M49msAc4CRAE1Fqf5Jznvk5\nwqQ/ggVRecTaAQTt8FMiJWj0DdKrvPLPi8JaiZvDg0TzYIhGAAwzgVxYeqf6wWML+2/kzTxraEwnABdgegIPg8SeszRvwvSb7So6IGBlwJ\ngK9Id3lAdFEop+4wkQAsXZkFmxeE7cR+FMtnObtvHOA9HExDCZMAEAhvFGYzJSuAE97rwXMmDAPfJv4yuwa71/DbBdWeZw3Mpg5A0rI08J\nnIQJ8kkQekDwBdnN0gjGx6STEf9oQCuNM9aFymzwBPO8a8EiJ4RIwqikMCH0ihcRpHULjBkyEQQiICYm30S4scGKGiCNMHrykwjj9egn91\n0tUv9qmWS/BZIonR9qw1OJnFRKgKnJKLIr0qgF4Aipg48tIVn+sA3CWGsAaH8IAQRM0KZKcaQRoSKgURoPTJLp4AjTjC6W+Oz8gItZMhpb\nHjgCpobSADVUfQgDnRcC+r+UxKzg8SQ5ZYQxxSNyKN4EMQHfORwQJx+da+xdMgCTIRw9INudv0sMGzpAECNaoBKtcFatBgMtBa6JfAVy0/\nwg67itLdaq6zt6XIc9Y6Fqv945FYZC2tKd/+7iiMhBIGJHrMzAqv8w8xRDqf0HVAZwlHPs4nJ2UeC2S4AlWZCHZWVzTZ5YJzBUeF/5ZBn4\n34FgOJw9A3GupiSovN0XGOFaBorML4FNMlIJEP1QFIprLhvhOe2npxNoqAXqiPs0kfm3X5+3KihenmL1JJCChyiEhwr4PAR8iBGSi/hFIu\nSZFjibC7EftoJK8dZ4dM4QYy/9/bccmv7XrLIm3XrtUbquxKlwbCdF2s3/1Hew8xvUcB891hOtIyPUJo7H/qBXYvG0DJT0PDbgRq7XATyy\nHCYUCbR0U8EJA1AJf0CgskTnHbwZ+hbevkflos5yL/dA+fB5nUlj+4tQE/D/SgCxCfpPtky1Gjaq75XD44tNXbgEQzSIukhJZWIjTyautB\nx8JiWbCfQKdEPry1R/z9E2eKuxx75oQKNL88hlJEADLvQMY1Tb7zC/k6RsHehVUGm3iOM58zBTZs3kNKgrLBXtX9Zd8vwJOoTApDK5jvRB\nt8olQVD1fDI3LYcBWsXzC93p6TcXD1hKWwcEfsOFf4nlAx3UGROeleXa3Cly68hd+jklZ+fsBHwngZFT5HgEYbXR8oj2VJexzKYJKzBdi3\nVHiNSQ60Q0AciYRspw/VcX5X/S8gZ4/17qAfs/1bsC/GYoEsF0sZjIb0aGFslTiCzBXmKiE05jxcR67DoAhwKktYZM3PQkT+K9kqDCdjBA\n5wY1ejvpMMPsPJXwqnAP4dEkeTgaI7fGd0MS9UCnGOKRAABJtPPgTzKtwLhCNZhnAx9qva7U6RZ3hH3SPOce5osJWDlFZoNOAK7Qggu/8C\nlBveW8oC6vKyLZ8RNUEMr3jZPMLGsBCRqWqJEDVacpCBc9fZX4qe9WO+3DoAv4katgFEwgLouioiMdJlTMADUO1J5KWib2Q6olgJgHgica\nBatY8YWu1/012fyo175y/8vn/mUUCCiWMg3+8cHlAICFUZtbrddJXoYWZ452/V2m7jr36d3GQo2tLvvKgYhPMASe6DuaysEovs45NKzWfE\nqIF/t9NfpYjJOwl7XdcXFgMeVOIBJydnSX77lY328CQWAcE4EbHzCzhaIEAIBQsmf1YzFyR4wsgaj4LobrIPB5ZUcSFQsBnbwYNF4uhK7T\nAenv0KLUvRJWKJr684CMEPl4sOL743Q7FCcJjfI3Fbw8Y4VU3ak07/JEnEfWXFLROmkl9IZVS7DtI+xTw0q/EsoGFiB9//DG1DyVT3/fVv\nSgZmWgg5Og4RpPs1G/DQH3CErw64NAA2s0hA63w4ZE+Q4EEKe5bwYrqG/jgBC9qgTeH27dvJ3VQmtqU4XDYt474jLWYkHqhjuTvfBjFmgF\nNCCqPFgAe/xBJAnwN959KqGgV/c5kmTjya78TjERgEsbccrWqv/z8c9o/OBjq32SSr7pCArNuh/xGRRXa8DPk9ZjAGWCYccwgRIu42oTA5\nN8UY4oQR0SxRMjVBNmuJ8Js5uuvv+7MFHwMj6s5acWaNl6FfbE01PgXCm9zpyVr7B+zCNEBcMUVY88k29A+VqbytRpwlXmEjxJZb7Px1ma\ntGUaVS9Zmx4EcoodpyRqtQGhLP8Gn4PBYB5yiBY6guNXnIgCTkJOsLv4jqOaaj5NM9LuSHOWUlyEk4jCLTMXab3B8OFIvgPR+QhKrwHGro\nSr8fFoAGd4HsF7Hthk49opG4OVjfZ/j0rZt2+y4DbSgVSEZox/fnzO9izMPcDAEAp6LDDSBZMMGvml+gvjrFzokS+uUk2lHVOfdrJO2bjY\n6NFEmJxIgwAvA/TMrYL2wQcALb1ETmDGfpDDzDPaSLLAivMtbrVZpcX6+y0G6JlnpbAAaS14cAzhsgYCXQAL7uK4v7C8T8gpy9fl8npeNh\nJZ71L7ryUYhwUsKx+T7L5WASAJSEUjBWfK7bQCOIGi/S1lLazadTtPBwUF955179r+A9g9QXq13MV2qXtvxM4Fn+x+D0fC1BkndygAAAAB\nJRU5ErkJggg==";class jr extends kt{constructor(t){super(),this.scene=t||null,this.isGl2=!0,this.emitters=new Map,this.textures=new _r,this.loader=null,this.now=0,this.last=0,this.delta=0,this.elapsed=0,this.num=0,this.hscale=.5*window.innerHeight,this.luminosity=1,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}updateMatrixWorld(t){super.updateMatrixWorld(t),null===this.scene&&this.update()}get(t){return this.emitters.has(t)?this.emitters.get(t):null}add(t,e){if(t.isPoints)return void super.add(t);t.name||(t.name="PP"+this.num++),this.remove(t.name),t.model&&Ar[t.model]&&(t={...Ar[t.model],...t});let i=new Dr(this,t);return this.emitters.set(t.name,i),i}remove(t){if("string"==typeof t||t instanceof String){if(!this.emitters.has(t))return;this.emitters.get(t).dispose(),this.emitters.delete(t)}else if(t.isPoints)return void super.remove(t)}addTexture(t,e,i=!0){this.textures.has(t)?console.log("this name of texture is already take !"):"string"==typeof e?(this.loader||(this.loader=new ft),this.loader.load(e,(e=>{e.flipY=!1,i&&(e.colorSpace=y),this.textures.add(t,e)}))):e.isTexture&&(e.flipY=!1,this.textures.add(t,e))}load(t){const e=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));var i=new XMLHttpRequest;i.open("GET",t),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){let t=JSON.parse(i.responseText);for(let e in t)this.add(t[e])}else console.error("Couldn't load ["+e+"] ["+i.status+"]")}.bind(this),i.send()}resize(t){this.hscale=.5*t}onresize(t){this.hscale=.5*t}loop(t){this.delta=t,this.emitters.forEach((t=>{t.draw()}))}update(t){this.now=void 0!==t?t:Date.now(),this.delta=.001*(this.now-this.last),this.elapsed+=this.delta,this.last=this.now,this.emitters.forEach((t=>{t.draw()}))}dispose(t=!0){this.emitters.forEach((t=>{t.dispose()})),this.emitters.clear(),t&&this.textures.dispose(),this.num=0}addBlock(t,e){let i=t[1]<=4?-2:0,s=Ar.getColor(e),a=s[0],r=s[1],o=s[2];s.length>3&&(a=s[3],r=s[4],o=s[5]),t[0]+=.5,t[2]+=.5,this.add({position:t,colors:[a,r,o,1,a,r,o,0],renderOrder:i,...Ar.addBlock})}delBlock(t,e){let i=t[1]<=4?-2:0,s=Ar.getColor(e),a=s[0],r=s[1],o=s[2];t[0]+=.5,t[2]+=.5,t[1]+=.5;let n=30;s.length>3&&(n=20,this.add({position:[t[0],t[1]+.375,t[2]],positionRange:[.5,.25,.5],colors:[a,r,o,.5,a,r,o,0],numParticles:10,renderOrder:i,...Ar.removeBlock}),a=s[3],r=s[4],o=s[5]),this.add({position:t,positionRange:[.5,.5,.5],colors:[a,r,o,.5,a,r,o,0],numParticles:n,renderOrder:i,...Ar.removeBlock})}removePlayerTrail(t){this.remove("PlayerTrail_"+t)}onPlayerWalk(t,e,i){let s=this.get("PlayerTrail_"+e);null===s&&(s=this.addTrail({name:"PlayerTrail_"+e,...Ar.playerMove}));let a=t.toArray();a[1]+=.2;let r=Ar.getColor(i),o=[r[0],r[1],r[2],.75,r[0],r[1],r[2],0];r.length>3&&(o=[r[0],r[1],r[2],.75,r[3],r[4],r[5],0]),s.birthParticles(a,o)}onVehicleDrive(t,e){let i=this.get("VehicleTrail_"+e);null===i&&(i=this.addTrail({name:"VehicleTrail_"+e,...Ar.vehicleMove})),i.birthParticles(t.toArray())}onBazookaFire(t,e){let i=this.get("BazookaTrail_"+e);null===i&&(i=this.addTrail({name:"BazookaTrail_"+e,...Ar.bazookaFire})),i.birthParticles(t.toArray())}onExplosion(t){this.add({position:t.toArray(),...Ar.explosion})}}new n,new n,new tt(new p(.03),new S({transparent:!0})),new n,new n,new tt(new p(.03),new S({transparent:!0})),new d;new h(1,1,1).rotateX(Math.PI/2),new it,new n,new n,new x("red");const Lr={PHY:"0.5.0",PHYSX:"5.06.10",HAVOK:"1.2.1",JOLT:"0.39.0",RAPIER:"0.20.0",OIMO:"1.2.4",AMMO:"3.2.6"};class qr{constructor(t={}){this.noBuffer=!0,this.stats=new zs,this.geo=new Ie,this.mat=new Je,this.math=fe,this.pool=Hi,this.version=Lr.PHY,this.Version=Lr,this.engine="",this.jointVisible=!1,this.utils=new Br(this),this.collision=new Ss(this),this.viewSize=null,this.debug=!1,this.delta=0,this.debuger=null,this.mouseActive=!1;const e=this;let i=null,s=!1,a=!1,r=!1,o=null,l=null,h=null,c=!1,d=!1,p=!1,u=!0,m=!1,b=null,g=!1,f={t1:0,t2:0,t3:0,t4:0},y=null,v=null,x=null,w=!1,k=!0,M=null,S=null,A=0,z=0,E="",P=null,R=null,T=null;const F=new Qe,D=new Xe(60),_={start:0,end:0,startTime:""};let C=()=>0,j=()=>{},L=()=>{},q=()=>{},O=[],B=[],I=[],G=null;const N={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};let V=null,U={};this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},this.reflow={ray:[],stat:{fps:0,delta:0,ms:0},point:{},contact:{},velocity:{}};const W={};this.scene=null,this.scenePlus=null,this.ws=1,this.uws=1,this.garbage=[],this.tmpMesh=[],this.instanceMesh={},this.tmpTex=[],this.disposeTmp=()=>{let t,e,i;for(t in this.tmpMesh){if(i=this.tmpMesh[t],i.children)for(e in i.children)this.disposeMesh(i.children[e]);this.disposeMesh(i),i.parent&&i.parent.remove(i)}for(t in this.tmpMesh=[],this.tmpTex)this.tmpTex[t].dispose();this.tmpTex=[]},this.disposeMesh=t=>{t.geometry&&t.geometry.dispose(),t.dispose&&t.dispose()},this.setStep=t=>{L=t},this.debugMode=t=>{this.setDebugMode(t)},this.setDebugMode=t=>{this.debug=t},this.useRealLight=t=>{this.mat.useRealLight(t)},this.getSetting=()=>N,this.setGravity=t=>{t&&(N.gravity=t),this.post({m:"setGravity",o:{gravity:N.gravity}})},this.set=(t={})=>{N.fixe=void 0===t.fixe||t.fixe,N.full=void 0!==t.full&&t.full,N.gravity=t.gravity?t.gravity:[0,-9.81,0],N.substep=t.substep?t.substep:1,N.fps=t.fps?t.fps:60,this.ws=void 0!==t.worldScale?t.worldScale:1,this.uws=1/this.ws,t.key&&q(),W.body.setFull(N.full),this.initArray(N.full),z=0,p=c,u=!p,this.jointVisible=t.jointVisible||!1,u&&D.setFramerate(N.fps);const e={...t,...N,ArPos:U,isTimeout:p,outsideStep:u};this.post({m:"set",o:e})},this.activeMouse=(t,e)=>{y||(y=new Ts(t,e,this)),this.mouseActive=!0},this.mouseMode=(t,e)=>{y&&y.setMode(t,e)},this.getTime=()=>Xe.now(),this.readTime=t=>Xe.format_time(t),this.startTime=()=>_.startTime,this.getTimeTest=()=>f,this.setMaxFps=t=>{},this.getMouse=()=>y?y.mouse:null,this.setMaxAnisotropy=t=>{Hi.maxAnisotropy=t},this.setAddControl=t=>{q=t},this.setPrevUpdate=t=>{},this.setPostUpdate=t=>{L=null!==t?t:()=>{}},this.setAzimut=t=>{C=t},this.setRenderer=t=>{R=t,Hi.renderer=R},this.setKey=(t,e)=>F.setKey(t,e),this.getKey=()=>F.key,this.getKey2=()=>F.key2,this.getAzimut=()=>C(),this.setContent=t=>{g||(T=t,T.add(this.scene),T.add(this.scenePlus),g=!0)},this.message=t=>{let i=t.data;i.Ar&&(V=i.Ar),i.reflow&&(this.reflow=i.reflow,this.reflow.stat.delta&&(this.stats.up(this.reflow.stat),z+=this.reflow.stat.delta)),e[i.m](i.o)},this.worldScaler=t=>{const e=this.ws;if(t.pos&&(t.pos=fe.worldscale(t.pos,e)),t.localPos&&(t.localPos=fe.worldscale(t.localPos,e)),t.massCenter&&(t.massCenter=fe.worldscale(t.massCenter,e)),t.pos1&&(t.pos1=fe.worldscale(t.pos1,e)),t.pos2&&(t.pos2=fe.worldscale(t.pos2,e)),t.shapes){let i,s=t.shapes.length;for(;s--;)i=t.shapes[s],i.size&&(t.shapes[s].size=fe.worldscale(i.size,e)),i.pos&&(t.shapes[s].pos=fe.worldscale(i.pos,e)),i.v&&(t.shapes[s].v=fe.worldscale(i.v,e))}else t.size&&(t.size=fe.worldscale(t.size,e)),t.v&&(t.v=fe.worldscale(t.v,e))},this.post=(t,e=null,i=!1)=>{1!==this.ws&&("add"!==t.m&&"change"!==t.m||this.worldScaler(t.o)),c?(t.o&&("solver"===t.o.type&&(i=!0),void 0!==t.o.solver&&(i=!0)),i?h.postMessage(t,e):"add"===t.m?this.flow.add.push(t.o):"remove"===t.m?this.flow.remove.push(t.o):h.postMessage(t,e)):v({data:t})},this.addDebuger=()=>{if(null===this.debuger)return this.debuger=new ka(this),this.scenePlus.add(this.debuger),this.debuger},this.removeDebuger=()=>{null!==this.debuger&&(this.debuger.dispose(),this.debuger=null)},this.vehicle=t=>{let e;switch(t.type){case"raycar":e=new Ua(t,this);break;case"kart":e=new wr(t,this);break;case"helico":e=new xr(t,this)}return e},this.autoRagdoll=t=>{const e=new wa(t,this);return this.scene.add(e.model),e},this.byName=t=>this.utils.byName(t),this.getScene=()=>this.scene,this.makeView=()=>{},this.resize=t=>{this.viewSize=t,i&&i.resize(this.viewSize.h)},this.init=(t={})=>{"undefined"!=typeof document&&document.currentScript&&document.currentScript.src,_.start=Xe.now();const i=t.compact||!1;let r=document.location.href.replace(/\/[^/]*$/,"/"),o=r.split("/");r=o[0]+"//"+o[2]+"/","https://lo-th.github.io/"===r&&(r="https://lo-th.github.io/phy/");let n=t.path||"";n+=i?"compact/":"build/";let p=t.type||"PHYSX",u=p.toLowerCase(),m=u.charAt(0).toUpperCase()+u.slice(1);if(this.engine=p.toUpperCase(),this.initItems(),Hi.materialRoot=this.mat.set.bind(this.mat),t.callback&&(l=t.callback,delete t.callback),c=t.worker||!1,this.scene=new kt,this.scene.name="phy_scene",this.scenePlus=new kt,this.scenePlus.name="phy_scenePlus",t.scene&&(this.setContent(t.scene),delete t.scene),t.renderer&&(this.setRenderer(t.renderer),delete t.renderer),E=t.envmap||"",a=!!t.useModule&&this.supportModuleWorker(),s=t.useLocal||!1,t.useDecal,Hi.useLocal=s,i)s?a?Hi.load(new URL("../"+n+m+".module.hex",import.meta.url),(function(){e.onCompactDone(t)})):Hi.load(new URL("../"+n+m+".hex",import.meta.url),(function(){e.onCompactDone(t)})):a?Hi.load(r+n+m+".module.hex",(function(){e.onCompactDone(t)})):Hi.load(r+n+m+".hex",(function(){e.onCompactDone(t)}));else if(c){let e,i=a?m+".module.js":m+".min.js";if(e=s?new URL(`./${i}`,import.meta.url):r+n+i,h=new Worker(e,{type:a?"module":"classic"}),h.postMessage=h.webkitPostMessage||h.postMessage,h.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);h.postMessage({m:"test",ab:e},[e]),d=!e.byteLength,t.isBuffer=d}this.initPhysics(t)}else t.devMode?this.preLoad(m,t,r):this.preLoadMin(m,t,r,s)},this.supportModuleWorker=()=>{let t=!1;const e={get type(){t=!0}};try{new Worker("data:,",e).terminate()}finally{return t}},this.onCompactDone=t=>{let e=this.engine.toLowerCase(),i=e.charAt(0).toUpperCase()+e.slice(1),s=a?Hi.get(i+".module","H"):Hi.get(i,"H");if(c){let e;try{e=new Blob([s],{type:"application/javascript"})}catch(t){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,e=new BlobBuilder,e.append(s),e=e.getBlob()}if(h=a?new Worker(URL.createObjectURL(e),{type:"module"}):new Worker(URL.createObjectURL(e)),h.postMessage=h.webkitPostMessage||h.postMessage,h.onmessage=this.message,this.noBuffer)t.isBuffer=!1;else{let e=new ArrayBuffer(1);h.postMessage({m:"test",ab:e},[e]),d=!e.byteLength,t.isBuffer=d}this.initPhysics(t)}else{let i=e.toUpperCase(),a=document.createElement("script");a.language="javascript",a.type="text/javascript",a.charset="utf-8",a.async=!0,a.innerHTML=s,document.getElementsByTagName("head")[0].appendChild(a),v=window[i].engine.message,t.message=this.message,this.initPhysics(t)}},this.loadWasmDirect=(t,e,i,s)=>{let a=document.createElement("script");a.src=s+t,document.body.appendChild(a),a.onload=()=>{this.preLoad(i,e,s)}},this.preLoadMin=(t,e,i,s=!1)=>{let a=i+"build/"+t+".min.js";s&&(a=new URL("./"+t+".min.js",import.meta.url));let r=t.toUpperCase();var o=new XMLHttpRequest;o.open("GET",a),o.overrideMimeType("text/javascript"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status){let t=document.createElement("script");t.language="javascript",t.type="text/javascript",t.charset="utf-8",t.async=!0,t.innerHTML=o.responseText,console.log(o.responseText),document.getElementsByTagName("head")[0].appendChild(t),v=window[r].engine.message,e.message=this.message,this.initPhysics(e)}else console.error("Couldn't load ["+t+"] ["+o.status+"]")}.bind(this),o.send(null)},this.preLoad=async(t,e,i)=>{let s=i+"build/"+t+".module.js";e.devMode&&(s=i+"src/"+t+".js");let a=await import(s);v=a.engine.message,e.message=this.message,this.initPhysics(e)},this.initPhysics=t=>{""===E?(this.post({m:"init",o:t}),m=!0):this.preloadEnvmap(t)},this.addEnvmap=t=>(P||(P=new za({renderer:R,scene:T,...t})),P),this.preloadEnvmap=t=>{P=new za({url:E,renderer:R,scene:T,usePmrem:t.usePmrem,useBackground:void 0===t.useBackground||t.useBackground,envBlur:void 0!==t.envBlur?t.envBlur:0,callback:()=>{E="",this.initPhysics(t)}})},this.getPause=()=>w,this.pause=t=>{t!==w&&(w=t,w?this.pausetimout():this.playtimout(),this.post({m:"pause",o:{value:w}}))},this.flowReset=()=>{this.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}},this.reset=t=>{if(k)return k=!1,void t();O=[],o=null,r=!1,x&&x.resetAll(),y&&y.unSelect(),i&&(i.dispose(),i=null),j=t,L=function(){},this.collision.reset(),this.clearText(),this.clearSoftSolver(),this.cleartimout(),this.flowReset(),this.clearInstance(),this.resetItems(),this.geo.dispose(),this.mat.dispose(),this.disposeTmp(),this.stats.reset(),this.garbage=[],G=null,null!==b&&(b=null),null!==this.debuger&&this.removeDebuger(),this.scenePlus.children=[],this.scene.children=[],this.post({m:"reset",o:{}})},this.clearGarbage=()=>{this.remove(this.garbage),this.clearInstance(),this.garbage=[]},this.clear=t=>{this.reset(t)},this.resetCallback=()=>{j()},this.dispose=()=>{this.reset((()=>{h&&(h.terminate(),h=null),g&&(e.scene.parent.remove(e.scene),e.scenePlus.parent.remove(e.scenePlus),g=!1)}))},this.ready=()=>{_.end=Xe.now(),_.startTime=Xe.format_time(_.end-_.start),console.log("%c"+this.engine+" %c"+Lr[this.engine]+"%c | "+(a?"Module ":"")+(c?"Worker":"Direct")+" "+_.startTime,"font-size:16px","font-size:12px","font-size:12px"),l&&l()},this.start=(t={})=>{this.post({m:"start",o:t})},this.morph=(t,e,i)=>{this.utils.morph(t,e,i)},this.getFps=()=>this.stats.fps.toFixed(0),this.getMs=()=>this.stats.ms.toFixed(1),this.getGpu=()=>this.stats.gpu.toFixed(1),this.getDelta2=()=>this.delta,this.getElapsedTime2=()=>z,this.setDelta=t=>{D.delta=t},this.getDelta=()=>D.delta,this.getElapsedTime=()=>D.elapsedTime,this.doStep=t=>{m&&u&&D.up(t)&&this.post({m:"step",o:t})},this.step=()=>{this.delta=this.reflow.stat.delta,this.flow.key=F.update(),this.flow.current=null!==o?o.name:"",this.stepItems(),this.collision.step(),y&&y.step(),null!==o&&o.move(),null!==this.debuger&&this.debuger.draw();let t=u?D.delta:this.delta;L(t),this.changes(this.flow.tmp),d?this.post({m:"poststep",flow:this.flow,Ar:V},[V.buffer]):this.post({m:"poststep",flow:this.flow}),this.flowReset()},this.initArray=(t=!1)=>{U={...Ee(this.engine,t)}},this.takeControl=(t=null)=>{this.control(t)},this.control=(t=null)=>{null!==o?null===t?(o.isPlayer&&(o.isPlayer=!1),o=null):t!==o.name&&(o=this.byName(t),o&&(o.isPlayer=!0)):null!==t&&(o=this.byName(t),o&&(o.isPlayer=!0))},this.getAllBody=t=>W.body.list,this.activeContact=()=>{r||(r=!0,this.post({m:"activeContact",o:{}}))},this.addCollision=t=>{this.collision.add(t)},this.removeCollision=t=>{this.collision.remove(t)},this.initItems=()=>{W.body=new xi(e),W.ray=new $e(e),W.joint=new Mi(e),W.solid=new Or(e),W.contact=new Si(e),W.terrain=new vs(e),W.character=new ps(e),"PHYSX"!==this.engine&&"AMMO"!==this.engine||(W.vehicle=new Ei(e)),"PHYSX"===this.engine&&(W.solver=new ws(e))},this.getBodyRef=()=>W.body,this.getCharacterRef=()=>W.character,this.getGeometryRef=(t,e,i)=>{W.body.geometry(t,e,i)},this.clearBody=()=>{W.body.reset()},this.resetItems=()=>{Object.values(W).forEach((t=>t.reset()))},this.stepItems=()=>{Object.values(W).forEach((t=>t.step(V,U[t.type]))),this.upInstance(),this.upButton()},this.getTransform=t=>W.body.getTransform(t),this.upInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.update()))},this.clearInstance=()=>{Object.values(this.instanceMesh).forEach((t=>t.dispose())),this.instanceMesh={}},this.adds=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.add(t[s++],e)},this.add=(t={},e=!1)=>{if(t.isObject3D)return this.addDirect(t);if(t.constructor===Array)return this.adds(t,e);if("container"===t.type)return new Da(t,this);void 0!==t.bounce&&(t.restitution=t.bounce),void 0===t.type&&(t.type="box"),void 0!==t.mode&&(t.type="joint");let i=function(t){switch(t.type){case"plane":case"box":case"sphere":case"highSphere":case"customSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return t.mass||t.density||t.kinematic?"body":"solid";case"fixe":case"generic":case"universal":case"dof":case"d6":case"hinge":case"revolute":case"prismatic":case"cylindrical":case"slider":case"spherical":case"ragdoll":case"distance":return"joint";default:return t.type}}(t);"joint"===i&&void 0===t.mode&&(t.mode=t.type,t.type="joint");let s=W[i].add(t);return this.garbage.push(s.name),s},this.addDirect=t=>(this.scenePlus.add(t),this.tmpMesh.push(t),t),this.removes=(t=[],e)=>{let i=t.length,s=0;for(;i--;)this.remove(t[s++],e)},this.remove=(t,e=!1)=>{if(t.constructor===Array)return this.removes(t,e);let i=this.byName(t);null!==i?(this.removeCollision(t),"autoRagdoll"!==i.type?(i.extraRemove&&i.extraRemove(),W[i.type].clear(i),this.post({m:"remove",o:{name:t,type:i.type}},null,e)):this.utils.remove(i)):this.instanceMesh[t]&&W.body.clearInstance(t)},this.changes=(t=[],e=!1)=>{let i=t.length,s=0;for(;i--;)this.changeOne(t[s++],e)},this.change=(t,e=!1)=>{e?t instanceof Array?this.changes(t,!0):this.changeOne(t,!0):t instanceof Array?this.flow.tmp.push(...t):this.flow.tmp.push(t)},this.changeOne=(t={},e=!1)=>{if(t.heightData)return;let i=this.byName(t.name);if(null===i)return null;let s=i.type;switch(t.drivePosition&&void 0!==t.drivePosition.rot&&(t.drivePosition.quat=fe.quatFromEuler(t.drivePosition.rot),delete t.drivePosition.rot),void 0!==t.rot&&(t.quat=fe.quatFromEuler(t.rot),delete t.rot),void 0!==t.localRot&&(t.quat=fe.toLocalQuatArray(t.localRot,i),delete t.localRot),s){case"terrain":i=W.terrain.set(t,i),e=!1;break;case"ray":i=W.ray.set(t,i),e=!1;break;case"character":i=W.character.set(t,i);break;case"solid":i=W.solid.set(t,i);break;case"joint":i=W.joint.set(t,i);break;case"body":i.isKinematic||(i.actif&&!i.sleep||W.body.set(t,i),t.sleep&&W.body.set(t,i))}e&&this.post({m:"change",o:t},null,e)},this.setControl=t=>{x=t,C=()=>x.getAzimuthalAngle()},this.getControl=()=>x,this.getCurrentCharacterPosition=()=>x.followGroup.position,this.getCamera=(t={})=>x.object,this.setCamera=(t={})=>{x.moveCam(t)},this.follow=(t="",e={})=>{let i=null;"string"==typeof t||t instanceof String?i=""===t?null:this.byName(t):t.isObject3D&&(i=t),null===i?x.resetFollow():x.startFollow(i,e)},this.setTimeout=(t,e=0,i=!1)=>{i?M=setTimeout(t,e):(S=t,A=e,M=setTimeout(S,A))},this.playtimout=()=>{null!==S&&(M=setTimeout(S,A))},this.pausetimout=()=>{null!==M&&clearTimeout(M)},this.cleartimout=(t,e)=>{null!==M&&(S=null,A=0,clearTimeout(M),M=null)},this.texture=(t={})=>Hi.texture(t),this.getTexture=(t,e={})=>Hi.getTexture(t,e),this.setExtendShader=t=>{this.mat.extendShader=t},this.addMaterial=(t,e)=>{this.mat.set(t,e)},this.directIntensity=t=>{},this.setEnvmapIntensity=t=>{},this.getMatRef=()=>this.mat,this.getMat=t=>this.mat.get(t),this.getMaterial=t=>this.mat.get(t),this.getMaterialList=()=>this.mat.getList(),this.material=(t={})=>this.mat.create(t),this.changeRenderMode=t=>this.mat.changeRenderMode(t),this.load=Hi.load,this.get=Hi.get,this.getGroup=Hi.getGroup,this.getScript=Hi.getScript,this.preload=(t,e)=>{hs.add(t,e)},this.applyMorph=(t,e=null,i=!0,s=!0)=>{Hi.applyMorph(t,null,!0,!0)},this.getMesh=(t,e,i)=>{if(e){let e=Hi.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return Hi.getMesh(t,i)},this.getGlb=(t,e,i)=>{if(e){let e=Hi.getMaterials(t);for(let t in e)this.addMaterial(e[t])}return Hi.getGLB(t,i)},this.getGlbMaterial=t=>{let e=Hi.getMaterials(t);return this.mat.addToMat(e),e},this.poolDispose=()=>Hi.dispose(),this.setDracoPath=t=>Hi.dracoPath=t,this.initParticle=()=>{},this.addParticle=()=>{},this.getParticle=()=>{},this.addSoftSolver=t=>{let e=new Os(t,this);return I.push(e),e},this.updateSoftSolver=()=>{let t=I.length;for(;t--;)I[t].update()},this.clearSoftSolver=()=>{I.length,I=[]},this.addButton=t=>{let e=new Rs(t,this);return O.push(e),e},this.upButton=t=>{for(const t in O)O[t].update()},this.addText=t=>{let e=new Es(t);return t.parent?t.parent.add(e):this.scenePlus.add(e),B.push(e),e},this.clearText=()=>{let t=B.length;for(;t--;)B[t].dispose();B=[]},this.screenshot=()=>{var t=window.open("","");t.document.title="Screenshot",t.document.body.style.cssText="margin:0; padding:0; overflow:hidden;";var e=new Image;R.render(T,this.getCamera()),e.src=R.domElement.toDataURL(),t.document.body.appendChild(e)},this.getBreaker=()=>(null!==b||(b=new xa(this)),b),this.setColorChecker=t=>{G=t},this.getColorChecker=()=>G,this.addWiggle=(t={})=>{},this.initParticleEngine=()=>{i||(i=new jr,this.scene.add(i))},this.addParticle=(t={})=>(null===i&&this.initParticleEngine(),i.add(t)),this.getParticle=t=>null===i?null:i.get(t),this.explosion=(t=[0,0,0],e=10,i=1)=>{let s=[],a=new n;t&&(t.isVector3?a.copy(t):a.fromArray(t));let r,o,l=new n,h=W.body.list.length;for(;h--;)r=W.body.list[h],l.copy(r.position).sub(a),o=1-l.length()/e,r.isKinematic||o<0||(l.setLength(o),l.multiplyScalar(i),s.push({name:r.name,impulse:l.toArray(),wake:!0}));this.change(s)}}set onStep(t){this.setStep(t)}}class Or extends xi{constructor(t){super(t),this.type="solid"}step(){}}class Br{constructor(t){this.map=new Map,this.motor=t}byName(t){return this.map.has(t)?this.map.get(t):null}add(t,e){if("contact"!==t.type&&!t.isInstance&&t.isObject3D)if(e)e.add(t);else if(t.isButton)this.motor.scene.add(t);else switch(t.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":this.motor.scenePlus.add(t);break;default:this.motor.scene.add(t)}t.isInstance&&t.refName!==t.name&&this.map.set(t.refName,t),this.map.set(t.name,t)}remove(t){t.dispose&&t.dispose(),t.parent&&t.parent.remove(t),t.isInstance&&(t.refName!==t.name&&this.map.delete(t.refName),t.instance.remove(t.idx)),this.map.delete(t.name)}noRay(t){t.isObject3D&&(t.raycast=()=>{},t.traverse((t=>{t.isObject3D&&(t.raycast=()=>{})})))}morph(t,e,i){t.morphTargetInfluences&&void 0!==t.morphTargetDictionary[e]&&(t.morphTargetInfluences[t.morphTargetDictionary[e]]=i)}toLocal(t,e,i=!1){i||t.sub(e.position);let s=e.quaternion;return t.applyQuaternion({x:-s._x,y:-s._y,z:-s._z,w:s._w}),t}quatLocal(t,e){e.isObject3D&&e.updateWorldMatrix(!0,!1);let i=(new $).fromArray(t),s=e.quaternion.clone().invert();return i.premultiply(s),i.normalize().toArray()}axisLocal(t,e){e.isObject3D&&e.updateWorldMatrix(!0,!1);let i=(new Zt).setFromMatrix4(e.matrixWorld);return(new n).fromArray(t).applyMatrix3(i).toArray()}quatToAngular(t,e){e[0]*=-1,e[1]*=-1,e[2]*=-1;let i,s=e[0]*t[3]+e[3]*t[0]+e[1]*t[2]-e[2]*t[1],a=e[1]*t[3]+e[3]*t[1]+e[2]*t[0]-e[0]*t[2],r=e[2]*t[3]+e[3]*t[2]+e[0]*t[1]-e[1]*t[0],o=e[3]*t[3]-e[0]*t[0]-e[1]*t[1]-e[2]*t[2],l=2*Math.acos(o),h=Math.sqrt(1-o*o);i=h<.001?[0,0,0]:[s/h,a/h,r/h];(new n).fromArray(i).multiplyScalar(l/1)}refAxis(t,e){let i=(new n).fromArray(e),s=new n(1,0,0),a=new n(0,1,0);Math.abs(e[1])>.9999||s.copy(i).cross(a).normalize(),a.copy(s).cross(i).normalize(),t.makeBasis(s,a,i)}}const Ir=new qr,Gr=qr,Nr=fe,Vr=Hi;export{Nr as math,Ir as phy,Gr as phy2,Vr as pool};
